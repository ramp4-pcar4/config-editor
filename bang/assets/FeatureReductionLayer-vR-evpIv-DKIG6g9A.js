import{x as W,X as j,v as n,S as o,n as w,bf as M,bw as B,E as J,es as y,F as R,w as S,et as ee,an as O,q as c,eb as U,a1 as te,ag as ie,eu as re,h as se,a6 as ne}from"./index-1o7Uo5_u.js";import{o as oe}from"./layerContainerType-ChWdCT09-G5sdAsSy.js";import{e as I,s as k}from"./FeatureReductionSelection-DzXAxMK9-ChgtkyYt.js";import{t as X,r as D}from"./OperationalLayer-CbXUnTH0-C_BIXjgc.js";import{u as H,Z as Y}from"./labelingInfo-DuLk-IW_-B8QlLwn5.js";import{read as F}from"./jsonUtils-CzRaZnmS-C7POghz-.js";import{_ as Z}from"./typeUtils-CB2EGBWO-DwPRGqiw.js";import{t as C}from"./SimpleRenderer-C1YRhRzu-Dx6IfE_L.js";import{l as ae,w as _,n as le}from"./commonProperties-CJLeiNuA-B57nEdDs.js";import{k as K}from"./MD5-CXHDUqXT-CMrYdOi6.js";let f=class extends W.ClonableMixin(j){constructor(i){super(i),this.expression=null,this.title=null,this.returnType=null}};n([o({type:String,json:{write:!0}})],f.prototype,"expression",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"title",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"returnType",void 0),f=n([w("esri.layers.support.ExpressionInfo")],f);var z,v;let d=(v=class extends j{constructor(s){super(s),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new z({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:c(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}},z=v,v);n([o({type:Boolean,json:{write:!0}})],d.prototype,"isAutoGenerated",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"name",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"alias",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"onStatisticField",void 0),n([o({type:f,json:{write:!0}})],d.prototype,"onStatisticExpression",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"statisticType",void 0),d=z=n([w("esri.layers.support.AggregateField")],d);var V;let u=V=class extends I{constructor(i){super(i),this.type="binning",this.binType="geohash",this.fixedBinLevel=null,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.size=y("12px"),this.fields=[],this.renderer=null}writeFields(i,s,e){const t=i.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());U(e,t,s)}readRenderer(i,s,e){var r;const t=(r=s.drawingInfo)==null?void 0:r.renderer;return t?F(t,s,e)??void 0:Y(s,e)}clone(){return new V({fields:c(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate),renderer:c(this.renderer),binType:c(this.binType),size:this.size})}};n([M({binning:"binning"})],u.prototype,"type",void 0),n([M({geohash:"geohash",square:"square"}),o({type:["geohash","square"]})],u.prototype,"binType",void 0),n([o({type:Number,json:{write:!0}})],u.prototype,"fixedBinLevel",void 0),n([o({type:[H],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],u.prototype,"labelingInfo",void 0),n([o(X)],u.prototype,"labelsVisible",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],u.prototype,"maxScale",void 0),n([o(D)],u.prototype,"popupEnabled",void 0),n([o({type:B,json:{name:"popupInfo",write:!0}})],u.prototype,"popupTemplate",void 0),n([o({cast:i=>i==="auto"?i:J(y(i))})],u.prototype,"size",void 0),n([o({type:[d],json:{write:!0}})],u.prototype,"fields",void 0),n([R("fields")],u.prototype,"writeFields",null),n([o({types:Z,json:{write:{target:"drawingInfo.renderer"}}})],u.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],u.prototype,"readRenderer",null),u=V=n([w("esri.layers.support.FeatureReductionBinning")],u);var T;function N(i){var s;return i.type==="simple"&&!((s=i.visualVariables)!=null&&s.length)}let l=T=class extends j{constructor(i){super(i),this.type="cluster",this.clusterRadius=y("80px"),this.clusterMinSize=y("12px"),this.clusterMaxSize=y("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=[]}readRenderer(i,s,e){var r,a;const t=(r=s.drawingInfo)==null?void 0:r.renderer;return(a=t==null?void 0:t.authoringInfo)!=null&&a.isAutoGenerated?null:t?N(t)?null:F(t,s,e)??void 0:Y(s,e)}readSymbol(i,s,e){var r,a,p;const t=(r=s.drawingInfo)==null?void 0:r.renderer;return(a=t==null?void 0:t.authoringInfo)!=null&&a.isAutoGenerated?null:t&&N(t)?(p=F(t,s,e))==null?void 0:p.symbol:null}writeSymbol(i,s,e,t){var a,p;const r=(p=(a=this.renderer)==null?void 0:a.authoringInfo)==null?void 0:p.isAutoGenerated;if(!this.renderer||r){const h=new C({symbol:i});s.drawingInfo={renderer:h.write({},t)}}}writeFields(i,s,e){const t=i.filter(r=>r.statisticType!=="avg_angle").map(r=>r.toJSON());U(e,t,s)}readFields(i,s,e){return i.filter(t=>!t.isAutoGenerated).map(t=>d.fromJSON(t))}clone(){return new T({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,fields:c(this.fields),maxScale:this.maxScale,renderer:c(this.renderer),symbol:c(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate)})}};n([o({type:["cluster"],readOnly:!0,json:{write:!0}})],l.prototype,"type",void 0),n([o({cast:i=>i==="auto"?i:J(y(i)),json:{write:!0}})],l.prototype,"clusterRadius",void 0),n([o({type:Number,cast:y,json:{write:!0}})],l.prototype,"clusterMinSize",void 0),n([o({type:Number,cast:y,json:{write:!0}})],l.prototype,"clusterMaxSize",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],l.prototype,"maxScale",void 0),n([o(D)],l.prototype,"popupEnabled",void 0),n([o({type:B,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],l.prototype,"popupTemplate",void 0),n([o({types:Z,json:{write:{target:"drawingInfo.renderer"}}})],l.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],l.prototype,"readRenderer",null),n([o({types:ee})],l.prototype,"symbol",void 0),n([S("symbol",["drawingInfo.renderer"])],l.prototype,"readSymbol",null),n([R("symbol")],l.prototype,"writeSymbol",null),n([o({type:[H],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],l.prototype,"labelingInfo",void 0),n([o(X)],l.prototype,"labelsVisible",void 0),n([o({type:[d],json:{write:!0}})],l.prototype,"fields",void 0),n([R("fields")],l.prototype,"writeFields",null),n([S("fields")],l.prototype,"readFields",null),l=T=n([w("esri.layers.support.FeatureReductionCluster")],l);const L={key:"type",base:I,typeMap:{cluster:l,binning:u}},ue={types:{key:"type",base:I,typeMap:{selection:k,cluster:l,binning:u}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:L},"portal-item":{types:L},"web-scene":{types:{key:"type",base:I,typeMap:{selection:k}},name:"layerDefinition.featureReduction",write:{layerContainerTypes:oe}}}}},pe=()=>ne.getLogger("esri.views.2d.layers.support.clusterUtils");O.add("esri-cluster-arcade-enabled",!0);const de=O("esri-cluster-arcade-enabled"),ce=new Set(["simple-line","simple-fill","picture-fill"]);function q(i,s){let e=s.clone();if(!fe(e))return e;if(s.symbols.some(t=>ce.has(t.type))&&(e=new C({symbol:new re})),e.authoringInfo||(e.authoringInfo=new le),e.authoringInfo.isAutoGenerated=!0,"visualVariables"in e){const t=(e.visualVariables||[]).filter(r=>r.valueExpression!=="$view.scale");t.forEach(r=>{r.type==="rotation"?r.field?r.field=m(i,r.field,"avg_angle","number"):r.valueExpression&&(r.field=g(i,r.valueExpression,"avg_angle","number"),r.valueExpression=null):r.normalizationField?(r.field=m(i,r.field,"avg_norm","number",r.normalizationField),r.normalizationField=null):r.field?r.field=m(i,r.field,"avg","number"):r.valueExpression&&(r.field=g(i,r.valueExpression,"avg","number"),r.valueExpression=null)}),e.visualVariables=t}switch(e.type){case"simple":break;case"pie-chart":for(const t of e.attributes)t.field?t.field=m(i,t.field,"sum","number"):t.valueExpression&&(t.field=g(i,t.valueExpression,"sum","number"),t.valueExpression=null);break;case"unique-value":e.field?e.field=m(i,e.field,"mode","string"):e.valueExpression&&(e.field=g(i,e.valueExpression,"mode","string"),e.valueExpression=null);break;case"class-breaks":e.normalizationField?(e.field=m(i,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=m(i,e.field,"avg","number"):e.valueExpression&&(e.field=g(i,e.valueExpression,"avg","number"),e.valueExpression=null)}return e}const fe=i=>{const s=e=>pe().error(new se("Unsupported-renderer",e,{renderer:i}));if(!i)return!1;switch(i.type){case"unique-value":if(i.field2||i.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(i.normalizationField){const e=i.normalizationType;if(e!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${e}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${i.type}`),!1}if(!de){if("valueExpression"in i&&i.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in i&&i.visualVariables||[]).some(e=>!(!("valueExpression"in e)||!e.valueExpression)))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function ye(i,s,e){switch(i){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const t=e,r="field",a=s.toLowerCase()+",norm:"+r+","+t.toLowerCase();return"cluster_avg_"+K(a)}}}function g(i,s,e,t){const r=K(s),a=e==="mode"?`cluster_type_${r}`:e==="sum"?`cluster_sum_${r}`:`cluster_avg_${r}`;return i.some(p=>p.name===a)||i.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:s,returnType:t}),statisticType:e})),a}function m(i,s,e,t,r){if(s==="cluster_count"||i.some(p=>p.name===s))return s;const a=ye(e,s,r);return i.some(p=>p.name===a)||(e==="avg_norm"?i.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:`$feature.${s} / $feature.${r}`,returnType:t}),statisticType:"avg"})):i.push(new d({name:a,isAutoGenerated:!0,onStatisticField:s,statisticType:e}))),a}const _e=i=>{let s=class extends i{constructor(...e){super(...e),this.addHandles(te(()=>this.renderer,()=>{if(this.featureReduction){const t=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",t)}},ie))}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}set renderer(e){}_withClusterVariable(e,t,r){const a=e.clone();return"visualVariables"in a&&(a.visualVariables||(a.visualVariables=[]),a.visualVariables.some(p=>p.type==="size")||a.visualVariables.push(new ae({field:"cluster_count",stops:[new _({value:1}),new _({useMinValue:!0,size:t}),new _({useMaxValue:!0,size:r})]}))),a}_normalizeFeatureReduction(e){var G;if((e==null?void 0:e.type)!=="cluster")return e;const t=e.clone(),r=[new d({name:"cluster_count",alias:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],a=(t.fields??[]).filter(b=>!b.isAutoGenerated),p=e.renderer&&!((G=e.renderer.authoringInfo)!=null&&G.isAutoGenerated),{clusterMinSize:h,clusterMaxSize:E}=t;if(p){t.fields=[...r,...a];const b=this._withClusterVariable(t.renderer,h,E);return t.effectiveFeatureRenderer=b,t.effectiveClusterRenderer=b,t}if(e.symbol){if(t.fields=[...r,...a],t.renderer=null,!this.renderer)return t.effectiveFeatureRenderer=null,t.effectiveClusterRenderer=null,t;const b=q(r,this.renderer),x=this._withClusterVariable(b,h,E),P="visualVariables"in x&&x.visualVariables?x.visualVariables:[],Q=new C({symbol:e.symbol,visualVariables:P});return t.fields=[...r,...a],t.effectiveFeatureRenderer=x,t.effectiveClusterRenderer=Q,t}if(!this.renderer)return e;const A=q(r,this.renderer);t.fields=[...r,...a],t.renderer=A;const $=this._withClusterVariable(A,h,E);return t.effectiveFeatureRenderer=$,t.effectiveClusterRenderer=$,t}};return n([o(ue)],s.prototype,"featureReduction",null),s=n([w("esri.layers.mixins.FeatureReductionLayer")],s),s};export{ue as P,_e as f,d as p};
