const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-CirJVPqY-B4A9_eiN.js","./index-BeTPrQ6f.js","./index-BlWAJbpo.css","./utils-CRANtbnc-C6zyufvL.js","./DeleteForwardEditsParameters-BBb01M4A-5nHinIbz.js"])))=>i.map(i=>d[i]);
import{m as V,E as T,n as x,q as F,_ as A,v as D,c as P,ak as q}from"./index-BeTPrQ6f.js";import{s as $}from"./uuid-CFz2qBzH-cIdlpVG-.js";const B=$(),H=new Map,S=new Map;async function K(e,n,a){if(!e||!a)return!1;if(!n)return!0;const t=new URL(e).host;let s=H.get(t);if(!s){const o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");s=(await D(o,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return s===n}async function N(e,n,a=!1){var o,r,d;if(!e||!n)return!0;const t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=(o=S.get(t))==null?void 0:o.entries();if(s){for(const[h,l]of s)if(l.name===n){const m=!((r=l.stack)!=null&&r.hasForwardEdits());if(!m&&a){const[{deleteForwardEdits:p},{default:f}]=await Promise.all([A(()=>import("./deleteForwardEdits-CirJVPqY-B4A9_eiN.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),A(()=>import("./DeleteForwardEditsParameters-BBb01M4A-5nHinIbz.js"),__vite__mapDeps([4,1,2]),import.meta.url)]),u=await p(t,h,new f({sessionId:B,moment:l.moment}));return u.success&&((d=l.stack)==null||d.clearForwardEdits()),u.success}return m}}return!0}function O(e,n){var s;if(!e)return!1;const a=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(s=S.get(a))==null?void 0:s.entries();if(t){for(const[o,r]of t)if(r.name===n)return r.lockType==="edit"}return!1}const y=new q;function W(e){return y.on("apply-edits",new WeakRef(e))}function X(e){return y.on("update-moment",new WeakRef(e))}function Y(e,n,a=null,t=!1){const s=P();return t=n==null||t,y.emit("apply-edits",{serviceUrl:e,layerId:n,gdbVersion:a,mayReceiveServiceEdits:t,result:s.promise}),s}const R=Symbol();function G(e){return e!=null&&typeof e=="object"&&R in e}function b(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,n,a){const t=new URL(e).host,s=H.get(t),o=r=>!r||r===s;return o(n)&&o(a)||n===a}const J=e=>{var s;var n;const a=e;let t=(s=class extends a{constructor(...o){super(...o),this[n]=!0,this._applyEditsHandler=r=>{const{serviceUrl:d,layerId:h,gdbVersion:l,mayReceiveServiceEdits:m,result:p}=r,f=d===this.url,u=h!=null&&this.layerId!=null&&h===this.layerId,U=b(this),k=b(this)&&M(d,l,this.gdbVersion);if(!f||U&&!k||!u&&!m)return;const L=p.then(i=>{var _;if(this.lastEditsEventDate=new Date,u&&(i.addedFeatures.length||i.updatedFeatures.length||i.deletedFeatures.length||i.addedAttachments.length||i.updatedAttachments.length||i.deletedAttachments.length))return this.emit("edits",F(i)),i;const v=(_=i.editedFeatures)==null?void 0:_.find(({layerId:g})=>g===this.layerId);if(v){const{adds:g,updates:w,deletes:E}=v.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:g?g.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:E?E.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:w?w.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:F(i.editedFeatures),exceededTransferLimit:!1,historicMoment:F(i.historicMoment)};return this.emit("edits",j),j}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:F(i.editedFeatures),exceededTransferLimit:!1,historicMoment:F(i.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(d,l,I.historicMoment)&&this.emit("edits",I),I}).then(i=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(d,l,i.historicMoment)&&(this.historicMoment=i.historicMoment),i));this.emit("apply-edits",{result:L})},this._updateMomentHandler=r=>{const{serviceUrl:d,gdbVersion:h,moment:l}=r,m=d===this.url,p=b(this),f=b(this)&&M(d,h,this.gdbVersion),u=b(this)&&!M(d,this.gdbVersion,null);m&&p&&f&&u&&"historicMoment"in this&&this.historicMoment!==l&&(this.historicMoment=l)},this.when().then(()=>{this.addHandles(W(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(X(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(o,r,d){return"historicMoment"in this&&this.historicMoment!==d&&O(o,r)}},n=R,s);return V([T()],t.prototype,"lastEditsEventDate",void 0),t=V([x("esri.layers.mixins.EditBusLayer")],t),t};export{N as B,J as C,O as S,B as V,Y,K as q,G as z};
