import{q as d,U as w,O as I,f as k,N as x,iJ as P,iT as h,k$ as g,iM as S,l0 as O,ar as v,bw as E}from"./index-CQ8-0QQp.js";import{fromJSON as F}from"./jsonUtils-CzRaZnmS-FjfqUTHD.js";import{c as M}from"./FeatureSet-BVGGhhH9-50vSm7H-.js";const N={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function R(r){var u;const o=r.folders||[],e=o.slice(),s=new Map,i=new Map,f=new Map,a=new Map,c=new Map,l={esriGeometryPoint:i,esriGeometryPolyline:f,esriGeometryPolygon:a};(((u=r.featureCollection)==null?void 0:u.layers)||[]).forEach(t=>{const p=d(t);p.featureSet.features=[];const y=t.featureSet.geometryType;s.set(y,p);const m=t.layerDefinition.objectIdField;y==="esriGeometryPoint"?G(i,m,t.featureSet.features):y==="esriGeometryPolyline"?G(f,m,t.featureSet.features):y==="esriGeometryPolygon"&&G(a,m,t.featureSet.features)}),r.groundOverlays&&r.groundOverlays.forEach(t=>{c.set(t.id,t)}),o.forEach(t=>{t.networkLinkIds.forEach(p=>{const y=T(p,t.id,r.networkLinks);y&&e.push(y)})}),e.forEach(t=>{var p;if(t.featureInfos){t.points=d(s.get("esriGeometryPoint")),t.polylines=d(s.get("esriGeometryPolyline")),t.polygons=d(s.get("esriGeometryPolygon")),t.mapImages=[];for(const y of t.featureInfos)switch(y.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const m=l[y.type].get(y.id);m&&((p=t[N[y.type]])==null||p.featureSet.features.push(m));break}case"GroundOverlay":{const m=c.get(y.id);m&&t.mapImages.push(m);break}}t.fullExtent=b([t])}});const n=b(e);return{folders:o,sublayers:e,extent:n}}function U(r,o,e,s){var a;const i=(a=w)==null?void 0:a.findCredential(r);r=I(r,{token:i==null?void 0:i.token});const f=k.kmlServiceUrl;return x(f,{query:{url:r,model:"simple",folders:"",refresh:e!==0||void 0,outSR:JSON.stringify(o)},responseType:"json",signal:s})}function q(r,o,e=null,s=[]){const i=[],f={},a=o.sublayers,c=new Set(o.folders.map(l=>l.id));return a.forEach(l=>{var u;const n=new r;if(e?n.read(l,e):n.read(l),s.length&&c.has(n.id)&&(n.visible=s.includes(n.id)),f[l.id]=n,l.parentFolderId!=null&&l.parentFolderId!==-1){const t=f[l.parentFolderId];t.sublayers||(t.sublayers=[]),(u=t.sublayers)==null||u.unshift(n)}else i.unshift(n)}),i}function G(r,o,e){e.forEach(s=>{r.set(s.attributes[o],s)})}function J(r,o){let e;return o.some(s=>s.id===r&&(e=s,!0)),e}function T(r,o,e){const s=J(r,e);return s&&(s.parentFolderId=o,s.networkLink=s),s}async function C(r){const o=M.fromJSON(r.featureSet).features,e=r.layerDefinition,s=F(e.drawingInfo.renderer),i=E.fromJSON(r.popupInfo),f=[];for(const a of o){const c=await s.getSymbolAsync(a);a.symbol=c,a.popupTemplate=i,a.visible=!0,f.push(a)}return f}function b(r){var s,i,f,a,c,l;const o=P(h),e=P(h);for(const n of r){if((i=(s=n.polygons)==null?void 0:s.featureSet)!=null&&i.features)for(const u of n.polygons.featureSet.features)g(o,u.geometry),S(e,o);if((a=(f=n.polylines)==null?void 0:f.featureSet)!=null&&a.features)for(const u of n.polylines.featureSet.features)g(o,u.geometry),S(e,o);if((l=(c=n.points)==null?void 0:c.featureSet)!=null&&l.features)for(const u of n.points.featureSet.features)g(o,u.geometry),S(e,o);if(n.mapImages)for(const u of n.mapImages)g(o,u.extent),S(e,o)}return O(e,h)?void 0:{xmin:e[0],ymin:e[1],zmin:e[2],xmax:e[3],ymax:e[4],zmax:e[5],spatialReference:v.WGS84}}export{b as G,C as L,R as M,q as N,U as j};
