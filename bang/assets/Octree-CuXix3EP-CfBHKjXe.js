import{cx as v,eq as w,i4 as m,f9 as ht}from"./index-BeTPrQ6f.js";import{S as at,p as V,E as y,j as C}from"./vec32-CI1xtKog-DFVYRcgb.js";import{P as F}from"./frustum-D1Y7pP8E-DUyP3Dvr.js";import{S as J,y as Z,M as k,q as lt,s as G,A as B,Z as U,v as ut,a as g}from"./sphere-CIGsF4vz-C3zVQu9y.js";import{p as tt}from"./BufferView-B6RYETl3-CMoUTBv6.js";class et{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(t,e){this.objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new d,this._objectCount=0,e&&(e.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=e.maximumObjectsPerNode),e.maximumDepth!==void 0&&(this._maximumDepth=e.maximumDepth))}destroy(){this._degenerateObjects.clear(),d.clearPool(),W[0]=null,T.prune(),A.prune()}add(t){const e=Array.from(t);this._grow(e);const n=d.acquire();for(const o of e)++this._objectCount,this._isDegenerate(o)?this._degenerateObjects.add(o):(n.init(this._root),this._add(o,n));d.release(n)}remove(t,e=null){this._objectCount-=t.length;const n=d.acquire();for(const o of t){const h=e??J(this.objectToBoundingSphere(o),gt);P(h[3])?(n.init(this._root),dt(o,h,n)):this._degenerateObjects.delete(o)}d.release(n),this._shrink()}update(t,e){if(!P(e[3])&&this._isDegenerate(t))return;const n=St(t);this.remove(n,e),this.add(n)}forEachAlongRay(t,e,n){const o=Z(t,e);N(this._root,h=>{if(!ft(o,h))return!1;const s=h.node;return s.terminals.forAll(a=>{this._intersectsObject(o,a)&&n(a)}),s.residents!==null&&s.residents.forAll(a=>{this._intersectsObject(o,a)&&n(a)}),!0})}forEachAlongRayWithVerticalOffset(t,e,n,o){const h=Z(t,e);N(this._root,s=>{if(!mt(h,s,o))return!1;const a=s.node;return a.terminals.forAll(r=>{this._intersectsObjectWithOffset(h,r,o)&&n(r)}),a.residents!==null&&a.residents.forAll(r=>{this._intersectsObjectWithOffset(h,r,o)&&n(r)}),!0})}forEach(t){N(this._root,e=>{const n=e.node;return n.terminals.forAll(t),n.residents!==null&&n.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,e,n,o=()=>!0,h=1/0){let s=1/0,a=1/0,r=null;const u=I(t,e),f=l=>{if(--h,!o(l))return;const _=this.objectToBoundingSphere(l);if(!F(n,_))return;const x=M(t,e,g(_)),E=x-_[3],c=x+_[3];E<s&&(s=E,a=c,r=l)};return Y(this._root,l=>{if(h<=0||!F(n,l.bounds)||(y(S,u,l.halfSize),C(S,S,g(l.bounds)),M(t,e,S)>a))return!1;const _=l.node;return _.terminals.forAll(x=>f(x)),_.residents!==null&&_.residents.forAll(x=>f(x)),!0},t,e),r}forEachInDepthRange(t,e,n,o,h,s,a){let r=-1/0,u=1/0;const f={setRange:c=>{n===1?(r=Math.max(r,c.near),u=Math.min(u,c.far)):(r=Math.max(r,-c.far),u=Math.min(u,-c.near))}};f.setRange(o);const l=M(e,n,t),_=I(e,n),x=I(e,-n),E=c=>{if(!a(c))return;const O=this.objectToBoundingSphere(c),D=M(e,n,g(O))-l,rt=D-O[3],st=D+O[3];rt>u||st<r||!F(s,O)||h(c,f)};Y(this._root,c=>{if(!F(s,c.bounds)||(y(S,_,c.halfSize),C(S,S,g(c.bounds)),M(e,n,S)-l>u)||(y(S,x,c.halfSize),C(S,S,g(c.bounds)),M(e,n,S)-l<r))return!1;const O=c.node;return O.terminals.forAll(D=>E(D)),O.residents!==null&&O.residents.forAll(D=>E(D)),!0},e,n)}forEachNode(t){N(this._root,e=>t(e.node,e.bounds,e.halfSize,e.depth))}forEachNeighbor(t,e){const n=k(e),o=lt(e,w()),h=r=>{const u=this.objectToBoundingSphere(r),f=k(u),l=n+f;return!(V(g(u),o)-l*l<=0)||t(r)};let s=!0;const a=r=>{s&&(s=h(r))};N(this._root,r=>{const u=k(r.bounds),f=n+u;if(V(g(r.bounds),o)-f*f>0)return!1;const l=r.node;return l.terminals.forAll(a),s&&l.residents!==null&&l.residents.forAll(a),s}),s&&this.forEachDegenerateObject(a)}_intersectsObject(t,e){const n=this.objectToBoundingSphere(e);return!(n[3]>0)||G(n,t)}_intersectsObjectWithOffset(t,e,n){const o=this.objectToBoundingSphere(e);return!(o[3]>0)||G(n.applyToBoundingSphere(o),t)}_add(t,e){e.advanceTo(this.objectToBoundingSphere(t))?e.node.terminals.push(t):(e.node.residents.push(t),e.node.residents.length>this._maximumObjectsPerNode&&e.depth<this._maximumDepth&&this._split(e))}_split(t){const e=t.node.residents;t.node.residents=null;for(let n=0;n<e.length;n++){const o=d.acquire().init(t);this._add(e.at(n),o),d.release(o)}}_grow(t){if(K(t,e=>this.objectToBoundingSphere(e),j),P(j[3])&&!this._fitsInsideTree(j))if(nt(this._root.node))J(j,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const e=this._rootBoundsForRootAsSubNode(j);this._placingRootViolatesMaxDepth(e)?this._rebuildTree(j,e):this._growRootAsSubNode(e),d.release(e)}}_rebuildTree(t,e){U($,e.bounds),$[3]=e.halfSize,K([t,$],o=>o,H);const n=d.acquire().init(this._root);this._root.initFrom(null,H,H[3]),this._root.increaseHalfSize(1.25),N(n,o=>(this.add(o.node.terminals.data),o.node.residents!==null&&this.add(o.node.residents.data),!0)),d.release(n)}_placingRootViolatesMaxDepth(t){const e=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let n=0;return N(this._root,o=>(n=Math.max(n,o.depth),n+e<=this._maximumDepth)),n+e>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const e=t[3],n=t;let o=-1/0;const h=this._root.bounds,s=this._root.halfSize;for(let r=0;r<3;r++){const u=h[r]-s-(n[r]-e),f=n[r]+e-(h[r]+s),l=Math.max(0,Math.ceil(u/(2*s))),_=Math.max(0,Math.ceil(f/(2*s)))+1,x=2**Math.ceil(Math.log(l+_)*Math.LOG2E);o=Math.max(o,x),R[r].min=l,R[r].max=_}for(let r=0;r<3;r++){let u=R[r].min,f=R[r].max;const l=(o-(u+f))/2;u+=Math.ceil(l),f+=Math.floor(l);const _=h[r]-s-u*s*2;L[r]=_+(f+u)*s}const a=o*s;return L[3]=a*it,d.acquire().initFrom(null,L,a,0)}_growRootAsSubNode(t){const e=this._root.node;U(j,this._root.bounds),j[3]=this._root.halfSize,this._root.init(t),t.advanceTo(j,null,!0),t.node.children=e.children,t.node.residents=e.residents,t.node.terminals=e.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const e=this._root.node.children;let n=0,o=0;for(;o<e.length&&t==null;)n=o++,t=e[n];for(;o<e.length;)if(e[o++])return-1;return n}_isDegenerate(t){return!P(this.objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const e=this._root.bounds,n=this._root.halfSize;return t[3]<=n&&t[0]>=e[0]-n&&t[0]<=e[0]+n&&t[1]>=e[1]-n&&t[1]<=e[1]+n&&t[2]>=e[2]-n&&t[2]<=e[2]+n}toJSON(){const{maximumDepth:t,maximumObjectsPerNode:e,_objectCount:n}=this,o=this._nodeToJSON(this._root.node);return{maximumDepth:t,maximumObjectsPerNode:e,objectCount:n,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:o}}}_nodeToJSON(t){var h,s;const e=t.children.map(a=>a?this._nodeToJSON(a):null),n=(h=t.residents)==null?void 0:h.map(a=>this.objectToBoundingSphere(a)),o=(s=t.terminals)==null?void 0:s.map(a=>this.objectToBoundingSphere(a));return{children:e,residents:n,terminals:o}}static fromJSON(t){const e=new et(n=>n,{maximumDepth:t.maximumDepth,maximumObjectsPerNode:t.maximumObjectsPerNode});return e._objectCount=t.objectCount,e._root.initFrom(t.root.node,t.root.bounds,t.root.halfSize,t.root.depth),e}}const z=class z{constructor(){this.bounds=B(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,e,n,o=this.depth){return this.node=t??z.createEmptyNode(),e&&J(e,this.bounds),this.halfSize=n,this.depth=o,this}increaseHalfSize(t){this.halfSize*=t,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*it}advance(t){let e=this.node.children[t];e||(e=z.createEmptyNode(),this.node.children[t]=e),this.node=e,this.halfSize/=2,this.depth++;const n=ot[t];return this.bounds[0]+=n[0]*this.halfSize,this.bounds[1]+=n[1]*this.halfSize,this.bounds[2]+=n[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(t,e,n=!1){for(;;){if(this.isTerminalFor(t))return e==null||e(this,-1),!0;if(this.isLeaf()){if(!n)return e==null||e(this,-1),!1;this.node.residents=null}const o=this._childIndex(t);e==null||e(this,o),this.advance(o)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const e=this.bounds;return(e[0]<t[0]?1:0)+(e[1]<t[1]?2:0)+(e[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new v({shrink:!0}),residents:new v({shrink:!0})}}static acquire(){return z._pool.acquire()}static release(t){z._pool.release(t)}static clearPool(){z._pool.prune()}};z._pool=new ht(()=>new z);let d=z;function N(i,t){let e=d.acquire().init(i);const n=[e];for(;n.length!==0;){if(e=n.pop(),t(e)&&!e.isLeaf())for(let o=0;o<e.node.children.length;o++)e.node.children[o]&&n.push(d.acquire().init(e).advance(o));d.release(e)}}function Y(i,t,e,n=1){let o=d.acquire().init(i);const h=[o];for(bt(e,n,X);h.length!==0;){if(o=h.pop(),t(o)&&!o.isLeaf())for(let s=7;s>=0;--s){const a=X[s];o.node.children[a]&&h.push(d.acquire().init(o).advance(a))}d.release(o)}}function dt(i,t,e){T.clear();const n=e.advanceTo(t,(o,h)=>{T.push(o.node),T.push(h)})?e.node.terminals:e.node.residents;if(n.removeUnordered(i),n.length===0)for(let o=T.length-2;o>=0&&ct(T.data[o],T.data[o+1]);o-=2);}function ct(i,t){return t>=0&&(i.children[t]=null),!!nt(i)&&(i.residents===null&&(i.residents=new v({shrink:!0})),!0)}function ft(i,t){return q(g(t.bounds),2*-t.halfSize,p),q(g(t.bounds),2*t.halfSize,b),tt(i.origin,i.direction,p,b)}function mt(i,t,e){return q(g(t.bounds),2*-t.halfSize,p),q(g(t.bounds),2*t.halfSize,b),e.applyToMinMax(p,b),tt(i.origin,i.direction,p,b)}function nt(i){if(i.terminals.length!==0)return!1;if(i.residents!==null)return i.residents.length===0;for(let t=0;t<i.children.length;t++)if(i.children[t])return!1;return!0}function _t(i,t){i[0]=Math.min(i[0],t[0]-t[3]),i[1]=Math.min(i[1],t[1]-t[3]),i[2]=Math.min(i[2],t[2]-t[3])}function pt(i,t){i[0]=Math.max(i[0],t[0]+t[3]),i[1]=Math.max(i[1],t[1]+t[3]),i[2]=Math.max(i[2],t[2]+t[3])}function q(i,t,e){e[0]=i[0]+t,e[1]=i[1]+t,e[2]=i[2]+t}function K(i,t,e){p[0]=1/0,p[1]=1/0,p[2]=1/0,b[0]=-1/0,b[1]=-1/0,b[2]=-1/0;for(const n of i){const o=t(n);P(o[3])&&(_t(p,o),pt(b,o))}ut(e,at(xt,p,b,.5)),e[3]=Math.max(b[0]-p[0],b[1]-p[1],b[2]-p[2])/2}function bt(i,t,e){if(!A.length)for(let n=0;n<8;++n)A.push({index:0,distance:0});for(let n=0;n<8;++n){const o=ot[n];A.data[n].index=n,A.data[n].distance=M(i,t,o)}A.sort((n,o)=>n.distance-o.distance);for(let n=0;n<8;++n)e[n]=A.data[n].index}function I(i,t){let e,n=1/0;for(let o=0;o<8;++o){const h=M(i,t,Q[o]);h<n&&(n=h,e=Q[o])}return e}function M(i,t,e){return t*(i[0]*e[0]+i[1]*e[1]+i[2]*e[2])}function P(i){return!isNaN(i)&&i!==-1/0&&i!==1/0&&i>0}const ot=[m(-1,-1,-1),m(1,-1,-1),m(-1,1,-1),m(1,1,-1),m(-1,-1,1),m(1,-1,1),m(-1,1,1),m(1,1,1)],Q=[m(-1,-1,-1),m(-1,-1,1),m(-1,1,-1),m(-1,1,1),m(1,-1,-1),m(1,-1,1),m(1,1,-1),m(1,1,1)],it=Math.sqrt(3),W=[null];function St(i){return W[0]=i,W}const L=B(),S=w(),p=w(),b=w(),T=new v,gt=B(),j=B(),$=B(),H=B(),R=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],A=new v,X=[0,0,0,0,0,0,0,0],xt=w();export{et as V};
