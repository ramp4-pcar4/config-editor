import{bp as T,gj as b,l as W,n2 as A,l8 as B}from"./index-BeTPrQ6f.js";import{U as Z}from"./colorUtils-DlmOacVt-BnN0T6wa.js";import{y as Y}from"./fontUtils-bOFLFKCC-gLU2ItK2.js";import{O as _,Q as G}from"./quantizationUtils-Ba9rpy9D-8ijlY328.js";import{$ as D}from"./densifyCurvedGeometry-C7Lb_tRx-Bjv2vU9s.js";import{T as H,p as I,j as J,U as V}from"./utils-DvP1Tc7W-CK5sH9q2.js";import{v as X,x as O}from"./previewUtils-1NSa4tp5-BqMe2dmc.js";import{o as ee}from"./symbolUtils-BWODOwTq-BEtrWlLF.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./jsonUtils-Bl9MVnOR-Be8hf0yA.js";import"./parser-CXoJuqeV-C7irlk5U.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./cimSymbolUtils-BJ01Nooc-BfOR3Irv.js";import"./utils-CIm5uQvO-CtKf129F.js";import"./defaultCIMValues-BWu-APou-XI-Li77m.js";import"./LRUCache-CvGiiws0-B3io5Jp4.js";import"./MemCache-TG-MhOJy-BkjKRNR7.js";import"./jsxFactory-DN-m49_5-CUFCpKPo.js";import"./intl-DRhjUnwt-Dihhq8dq.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./mat2d-Cf4xHr3Z-u09Kv-lR.js";const K="picture-fill",te="picture-marker",ie="simple-fill",oe="simple-line",ne="simple-marker",ae="text",le="Aa",re=22,L=120,se=80,R=50,q=225,he=document.createElement("canvas");function N(t,e,r){const{extent:o}=t;if(!o)return"";const u=o.width||1,h=o.height||1;if(t.type==="polygon"){const s=t.clone();A(s)&&(s.rings=D(s,{minSegmentsPerCurve:128}).rings),_({originPosition:"upperLeft",scale:[u/e,h/r],translate:[o.xmin,o.ymax]},s,s);let a="";for(let l=0;l<s.rings.length;l++){const m=s.rings[l];for(let c=0;c<m.length;c++){const f=m[c][0],n=m[c][1],i=c===0?"M":"l",x=c===m.length-1?" Z":"";a+=`${a!==""?" ":""}${i}${f.toString()} ${n.toString()}${x}`}}return a}if(t.type==="polyline"){const s=t.clone();A(s)&&(s.paths=D(s,{minSegmentsPerCurve:128}).paths),G({originPosition:"upperLeft",scale:[u/e,h/r],translate:[o.xmin,o.ymax]},s,s);let a="";for(let l=0;l<s.paths.length;l++){const m=s.paths[l];for(let c=0;c<m.length;c++){const f=m[c][0],n=m[c][1];a+=`${a!==""?" ":""}${c===0?"M":"l"}${f.toString()} ${n.toString()}`}}return a}return""}function Q(t,e){const r=he.getContext("2d"),o=[];e&&(e.weight&&o.push(e.weight),e.size&&o.push(e.size+"px"),e.family&&o.push(e.family)),r.font=o.join(" ");const{width:u,actualBoundingBoxLeft:h,actualBoundingBoxRight:s,actualBoundingBoxAscent:a,actualBoundingBoxDescent:l}=r.measureText(t);return{width:Math.ceil(Math.max(u,h+s)),height:Math.ceil(a+l),x:Math.floor(h),y:Math.floor((a-l)/2)}}function S(t){const e=t==null?void 0:t.size;return{width:e!=null&&typeof e=="object"&&"width"in e?b(e.width):null,height:e!=null&&typeof e=="object"&&"height"in e?b(e.height):null}}async function ce(t,e){const r=e.fill,o=t.color;if((r==null?void 0:r.type)==="pattern"&&o&&t.type!==K){const u=await V(r.src,o.toCss(!0));r.src=u,e.fill=r}}async function me(t,e,r,o){var s,a,l;if(!("font"in t)||!t.font||e.shape.type!=="text")return;try{await Y(t.font)}catch{}const{width:u,height:h}=S(o);if(!/[\uE600-\uE6FF]/.test(e.shape.text)){const{width:m,height:c,x:f,y:n}=Q(e.shape.text,{weight:(s=e.font)==null?void 0:s.weight,size:(a=e.font)==null?void 0:a.size,family:(l=e.font)==null?void 0:l.family});r[0]=u??m,r[1]=h??c,e.shape.x=f,e.shape.y=n;let i="angle"in t?t.angle:null;if((o==null?void 0:o.rotation)!=null&&(i=(i??0)+o.rotation),i){const x=i*(Math.PI/180),z=Math.abs(Math.sin(x)),C=Math.abs(Math.cos(x));r[1]=r[0]*z+r[1]*C}}}function pe(t,e,r,o,u){var h;if(t.haloColor!=null&&t.haloSize!=null){u.masking??(u.masking=r.map(()=>[]));const s=b(t.haloSize);o[0]+=s,o[1]+=s,r.unshift([{...e,fill:null,stroke:{color:t.haloColor,width:2*s,join:"round",cap:"round"}}]),u.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*B,height:o[1]+2*B},fill:[255,255,255],stroke:null},{...e,fill:[0,0,0,0],stroke:null}])}t.backgroundColor==null&&t.borderLineColor==null||(o[0]+=2*B,o[1]+=2*B,r.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:b(t.borderLineSize)}}]),(h=u.masking)==null||h.unshift([]))}function U(t,e){return t>e?"dark":"light"}function ue(t,e){var z,C,P,j,E;const r=typeof(e==null?void 0:e.size)=="number"?e==null?void 0:e.size:null,o=r!=null?b(r):null,u=(e==null?void 0:e.maxSize)!=null?b(e.maxSize):null;let h="angle"in t?t.angle:null;(e==null?void 0:e.rotation)!=null&&(h=(h??0)+e.rotation);const s=H(t);let a=I(t);de(t,245)!=="dark"||e!=null&&e.ignoreWhiteSymbols||(a={width:.75,...a,color:"#bdc3c7"});let l=null;const m={shape:null,fill:s,stroke:a,offset:[0,0]};a!=null&&a.width&&(a.width=Math.min(a.width,se));const c=(a==null?void 0:a.width)||0;let f=(e==null?void 0:e.size)!=null&&((e==null?void 0:e.scale)==null||(e==null?void 0:e.scale)),n=0,i=0,x=!1;switch(t.type){case ne:{const g=t.style,{width:d,height:p}=S(e);let v=d===p&&d!=null?d:o??Math.min(b(t.size),u||L);if((e==null?void 0:e.useMarkerSymbolSize)===!0&&d!==null&&p!==null){const y=Math.min(b(t.size),u||L);v=y>d&&y>p?Math.min(d,p):y}switch(n=v,i=v,g){case"circle":m.shape={type:"circle",cx:0,cy:0,r:.5*v},f||(n+=c,i+=c);break;case"cross":m.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[n,.5*i]},{command:"M",values:[.5*n,0]},{command:"L",values:[.5*n,i]}]};break;case"diamond":m.shape={type:"path",path:[{command:"M",values:[0,.5*i]},{command:"L",values:[.5*n,0]},{command:"L",values:[n,.5*i]},{command:"L",values:[.5*n,i]},{command:"Z",values:[]}]},f||(n+=c,i+=c);break;case"square":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,0]},{command:"L",values:[n,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(n+=c,i+=c),h&&(x=!0);break;case"triangle":m.shape={type:"path",path:[{command:"M",values:[.5*n,0]},{command:"L",values:[n,i]},{command:"L",values:[0,i]},{command:"Z",values:[]}]},f||(n+=c,i+=c),h&&(x=!0);break;case"x":m.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,i]},{command:"M",values:[n,0]},{command:"L",values:[0,i]}]},h&&(x=!0);break;case"path":m.shape={type:"path",path:t.path||""},f||(n+=c,i+=c),h&&(x=!0),f=!0}break}case oe:{const{width:g,height:d}=S(e),p=J(a).reduce((M,k)=>M+k,0),v=p&&Math.ceil(R/p),y=d??o??c,w=g??(p*v||R);if(f=!0,((z=e==null?void 0:e.geometry)==null?void 0:z.type)==="polyline"&&((C=e==null?void 0:e.geometry)==null?void 0:C.extent)){n=w,i=d??n;const M=1e3,k=.15*M;l=[n,i],i=l[0]>l[1]?M*l[1]/l[0]:M,n=l[0]>l[1]?M:M*l[0]/l[1],a!=null&&a.width&&(a.width=a.width*M/(l[1]>l[0]?l[1]:l[0]),a.width>k&&(a.width=k)),m.shape={type:"path",path:N(e.geometry,n,i)}}else n=(e==null?void 0:e.maxSize)!=null?Math.min(w,e.maxSize):w,i=y,a&&(a.width=y),m.shape={type:"path",path:[{command:"M",values:[y/2,i/2]},{command:"L",values:[n-y/2,i/2]}]};break}case K:case ie:{const g=typeof(e==null?void 0:e.symbolConfig)=="object"&&!!((P=e==null?void 0:e.symbolConfig)!=null&&P.isSquareFill),{width:d,height:p}=S(e);n=!g&&d!==p||d==null?o??re:d,i=!g&&d!==p||p==null?n:p,f||(n+=c,i+=c),f=!0,(j=e==null?void 0:e.geometry)!=null&&j.extent&&((E=e==null?void 0:e.geometry)==null?void 0:E.type)==="polygon"?(l=[n,i],i=l[0]>l[1]?1e3*l[1]/l[0]:1e3,n=l[0]>l[1]?1e3:1e3*l[0]/l[1],m.shape={type:"path",path:N(e.geometry,n,i)}):m.shape=g?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,0]},{command:"L",values:[n,i]},{command:"L",values:[0,i]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:X.fill[0];break}case te:{const g=Math.min(b(t.width),u||L),d=Math.min(b(t.height),u||L),{width:p,height:v}=S(e),y=p===v&&p!=null?p:o??Math.max(g,d),w=t.width/t.height;n=w<=1?Math.ceil(y*w):y,i=w<=1?y:Math.ceil(y/w),m.shape={type:"image",x:-Math.round(n/2),y:-Math.round(i/2),width:n,height:i,src:t.url||""},h&&(x=!0);break}case ae:{const g=t,d=(e==null?void 0:e.overrideText)||g.text||le,p=g.font,{width:v,height:y}=S(e),w=y??o??Math.min(b(p.size),u||L),{width:M,height:k}=Q(d,{weight:p.weight,size:w,family:p.family}),$=/[\uE600-\uE6FF]/.test(d);n=v??($?w:M),i=$?w:k;let F=.5*($?w:k);$&&(F+=5),m.shape={type:"text",text:d,x:g.xoffset||0,y:g.yoffset||F,align:"middle",alignBaseline:g.verticalAlignment,decoration:p&&p.decoration,rotated:g.rotated,kerning:g.kerning},m.font=p&&{size:w,style:p.style,decoration:p.decoration,weight:p.weight,family:p.family};break}}return{shapeDescriptor:m,size:[n,i],outputSize:l,renderOptions:{node:e==null?void 0:e.node,scale:f,opacity:e==null?void 0:e.opacity,rotations:[h],useRotationSize:x,cssEffectFilter:e==null?void 0:e.cssEffectFilter,ariaLabel:e==null?void 0:e.ariaLabel,clipBloomEffect:e==null?void 0:e.clipBloomEffect}}}async function Ue(t,e){var l,m,c,f,n;const{shapeDescriptor:r,size:o,renderOptions:u,outputSize:h}=ue(t,e);if(!r.shape)throw new W("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ce(t,r),await me(t,r,o,e);const s=[[r]];if(typeof(e==null?void 0:e.symbolConfig)=="object"&&((l=e==null?void 0:e.symbolConfig)!=null&&l.applyColorModulation)){const i=.6*o[0];s.unshift([{...r,offset:[-i,0],fill:O(r.fill,-.3)}]),s.push([{...r,offset:[i,0],fill:O(r.fill,.3)}]),o[0]+=2*i,u.scale=!1}t.type==="text"&&pe(t,r,s,o,u);const a=ee(s,o,u);if(h&&a){const i=a.nodeName.toLowerCase()==="img"?a:a.firstChild;i.nodeName.toLowerCase()==="svg"&&i.setAttribute("viewBox",`0 0 ${o[0].toString()} ${o[1].toString()}`),i.setAttribute("width",h[0].toString()),i.setAttribute("height",h[1].toString()),h.length>2&&(i.style.setProperty("padding-left",((m=h[2])==null?void 0:m.toString())+"px"),i.style.setProperty("padding-right",((c=h[2])==null?void 0:c.toString())+"px"),i.style.setProperty("padding-top",((f=h[3])==null?void 0:f.toString())+"px"),i.style.setProperty("padding-bottom",((n=h[3])==null?void 0:n.toString())+"px"),i.style.setProperty("box-sizing","border-box"))}return a}function de(t,e=q){const r=H(t),o=I(t),u=!r||"type"in r?null:new T(r),h=o!=null&&o.color?new T(o==null?void 0:o.color):null,s=u?U(Z(u),e):null,a=h?U(Z(h),e):null;return a?s?s===a?s:e>=q?"light":"dark":a:s}export{de as getContrastingBackgroundTheme,ue as getRenderSymbolParameters,Ue as previewSymbol2D};
