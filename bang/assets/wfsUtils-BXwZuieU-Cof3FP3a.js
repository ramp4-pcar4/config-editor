import{v as b,be as N,bC as S,ln as M,lo as D,a as E,lp as k,l as p,aW as V,cc as O,ck as $,F as W,cu as Y,ke as F}from"./index-BeTPrQ6f.js";import{N as q,W as X}from"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import{m as z}from"./geojson-IFfWNbn5--Ds_bCet.js";import{l as x,t as g}from"./xmlUtils-TLuV3CJ7-Cs2DGP6C.js";import{m as y}from"./Field-Dn1Bgq7n-CJCGLoNR.js";const C="xlink:href",d="2.0.0",R="__esri_wfs_id__",_="wfs-layer:getWFSLayerTypeInfo-error",J="wfs-layer:empty-service",v="wfs-layer:feature-type-not-found",B="wfs-layer:geojson-not-supported",H="wfs-layer:kvp-encoding-not-supported",Q="wfs-layer:malformed-json",G="wfs-layer:unknown-geometry-type",K="wfs-layer:unknown-field-type",Z="wfs-layer:unsupported-spatial-reference",ee="wfs-layer:unsupported-wfs-version";async function Ce(a,t){const e=te((await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:d,...t==null?void 0:t.customParameters},signal:t==null?void 0:t.signal})).data);return ne(a,e),e}function te(a){const t=U(a);we(t),j(t);const e=t.firstElementChild,r=M(se(e));return{operations:ae(e),get featureTypes(){return Array.from(r())},readFeatureTypes:r}}const re=["json","application/json; subtype=geojson; charset=utf-8","application/json; subtype=geojson","application/json","geojson","application/geo+json"];function P(a){for(const t of re){const e=a.findIndex(r=>r.toLowerCase()===t);if(e>=0)return a[e]}return null}function ae(a){let t=!0;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}},r=[],n=[];if(x(a,{OperationsMetadata:{Parameter:s=>{var o;if(((o=s.getAttribute("name"))==null?void 0:o.toLowerCase())==="outputformat")return{AllowedValues:{Value:({textContent:i})=>{i&&r.push(i)}}}},Operation:s=>{switch(s.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:o=>{e.GetCapabilities.url=o.getAttribute(C)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:o=>{e.DescribeFeatureType.url=o.getAttribute(C)}}}};case"GetFeature":return{DCP:{HTTP:{Get:o=>{e.GetFeature.url=o.getAttribute(C)}}},Parameter:o=>{var i;if(((i=o.getAttribute("name"))==null?void 0:i.toLowerCase())==="outputformat")return{AllowedValues:{Value:({textContent:u})=>{u&&n.push(u)}}}}}}},Constraint:s=>{switch(s.getAttribute("name")){case"KVPEncoding":return{DefaultValue:o=>{t=o.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:o=>{e.GetFeature.supportsPagination=o.textContent.toLowerCase()==="true"}}}}}}),e.GetFeature.outputFormat=P(n)??P(r),!t)throw new p(H,"WFS service doesn't support key/value pair (KVP) encoding");if(e.GetFeature.outputFormat==null)throw new p(B,"WFS service doesn't support GeoJSON output format");return e}function ne(a,t){D(a)&&(E(a,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=k(t.operations.DescribeFeatureType.url)),E(a,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=k(t.operations.GetFeature.url)))}function A(a){var e,r,n;const t=parseInt(((n=(r=(e=a.textContent)==null?void 0:e.match(/(?<wkid>\d+$)/i))==null?void 0:r.groups)==null?void 0:n.wkid)??"",10);if(!Number.isNaN(t))return t}function se(a){return g(a,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",defaultSpatialReference:4326,supportedSpatialReferences:[]},r=new Set;return x(t,{Name:n=>{const{name:s,prefix:o}=w(n.textContent);e.typeName=`${o}:${s}`,e.name=s,e.namespacePrefix=o,e.namespaceUri=n.lookupNamespaceURI(o)},Abstract:n=>{e.description=n.textContent},Title:n=>{e.title=n.textContent},WGS84BoundingBox:n=>{e.extent=W.fromJSON(oe(n))},DefaultCRS:n=>{const s=A(n);s&&(e.defaultSpatialReference=s,r.add(s))},OtherCRS:n=>{const s=A(n);s&&r.add(s)}}),e.title||(e.title=e.name),r.add(4326),e.supportedSpatialReferences.push(...r),e}}})}function oe(a){let t,e,r,n;for(const s of a.children)switch(s.localName){case"LowerCorner":[t,e]=s.textContent.split(" ").map(o=>Number.parseFloat(o));break;case"UpperCorner":[r,n]=s.textContent.split(" ").map(o=>Number.parseFloat(o))}return{xmin:t,ymin:e,xmax:r,ymax:n,spatialReference:Y}}function ie(a,t,e){return S(a,r=>e?r.name===t&&r.namespaceUri===e:r.typeName===t||r.name===t)}async function Ee(a,t,e,r={}){const{featureType:n,extent:s}=await ue(a,t,e,r),{spatialReference:o}=be(a.operations.GetFeature.url,n,r.spatialReference),{fields:i,geometryType:u,swapXY:c,objectIdField:l,geometryField:m}=await le(a,n,o,r);return{url:a.operations.GetCapabilities.url,name:n.name,namespaceUri:n.namespaceUri,fields:i,geometryField:m,geometryType:u,objectIdField:l,spatialReference:r.spatialReference??new N({wkid:n.defaultSpatialReference}),extent:s,swapXY:c,wfsCapabilities:a,customParameters:r.customParameters}}async function ue(a,t,e,r={}){const n=a.readFeatureTypes(),s=t?ie(n,t,e):n.next().value,{spatialReference:o=new N({wkid:s==null?void 0:s.defaultSpatialReference})}=r;if(s==null)throw t?new p(v,`The type '${t}' could not be found in the service`):new p(J,"The service is empty");let i=s.extent;if(i&&!V(i.spatialReference,o))try{await q(i.spatialReference,o,void 0,r),i=X(i,o)}catch{throw new p(Z,"Projection not supported")}return{extent:i,spatialReference:o,featureType:s}}async function le(a,t,e,r={}){var f,h,T;const{typeName:n}=t,[s,o]=await Promise.allSettled([me(a.operations.DescribeFeatureType.url,n,r),ce(a,n,e,r)]),i=L=>new p(_,`An error occurred while getting info about the feature type '${n}'`,{error:L});if(s.status==="rejected")throw i(s.reason);if(o.status==="rejected")throw i(o.reason);const{fields:u,errors:c}=s.value??{},l=((f=s.value)==null?void 0:f.geometryType)||((h=o.value)==null?void 0:h.geometryType),m=((T=o.value)==null?void 0:T.swapXY)??!1;if(l==null)throw new p(G,`The geometry type could not be determined for type '${n}`,{typeName:n,geometryType:l,fields:u,errors:c});return{...pe(u??[]),geometryType:l,swapXY:m}}function pe(a){const t=a.find(r=>r.type==="geometry");let e=a.find(r=>r.type==="oid");return a=a.filter(r=>r.type!=="geometry"),e||(e=new y({name:R,type:"oid",alias:R}),a.unshift(e)),{geometryField:(t==null?void 0:t.name)??null,objectIdField:e.name,fields:a}}async function ce(a,t,e,r={}){var c;let n,s=!1;const[o,i]=await Promise.all([ge(a.operations.GetFeature.url,t,e,a.operations.GetFeature.outputFormat,{...r,count:1}),b(a.operations.GetFeature.url,{responseType:"text",query:I(t,e,void 0,{...r,count:1}),signal:r==null?void 0:r.signal})]),u=o.type==="FeatureCollection"&&((c=o.features[0])==null?void 0:c.geometry);if(u){let l;switch(n=$.fromJSON(z(u.type)),u.type){case"Point":l=u.coordinates;break;case"LineString":case"MultiPoint":l=u.coordinates[0];break;case"MultiLineString":case"Polygon":l=u.coordinates[0][0];break;case"MultiPolygon":l=u.coordinates[0][0][0]}const m=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(i.data);if(m){const f=l[0].toFixed(3),h=l[1].toFixed(3),T=parseFloat(m[1]).toFixed(3);f===parseFloat(m[2]).toFixed(3)&&h===T&&(s=!0)}}return{geometryType:n,swapXY:s}}async function me(a,t,e){return fe(t,(await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:d,TYPENAME:t,TYPENAMES:t,...e==null?void 0:e.customParameters},signal:e==null?void 0:e.signal})).data)}function fe(a,t){const{name:e}=w(a),r=U(t);j(r);const n=S(g(r.firstElementChild,{element:s=>s}),s=>s.getAttribute("name")===e);if(n!=null){const s=n.getAttribute("type"),o=s?S(g(r.firstElementChild,{complexType:i=>i}),i=>i.getAttribute("name")===w(s).name):S(g(n,{complexType:i=>i}),()=>!0);if(o)return de(o)}throw new p(v,`Type '${a}' not found in document`,{document:new XMLSerializer().serializeToString(r)})}const ye=new Set(["objectid","fid"]);function de(a){const t=[],e=[];let r;const n=g(a,{complexContent:{extension:{sequence:{element:s=>s}}}});for(const s of n){const o=s.getAttribute("name");if(!o)continue;let i,u;if(s.hasAttribute("type")?i=w(s.getAttribute("type")).name:x(s,{simpleType:{restriction:m=>(i=w(m.getAttribute("base")).name,{maxLength:f=>{u=+f.getAttribute("value")}})}}),!i)continue;const c=s.getAttribute("nillable")==="true";let l=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new y({name:o,alias:o,type:"integer",nullable:c,length:F("integer")}));break;case"float":case"double":case"decimal":e.push(new y({name:o,alias:o,type:"double",nullable:c,length:F("double")}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new y({name:o,alias:o,type:"string",nullable:c,length:u??F("string")}));break;case"datetime":case"date":e.push(new y({name:o,alias:o,type:"date",nullable:c,length:u??F("date")}));break;case"pointpropertytype":r="point",l=!0;break;case"multipointpropertytype":r="multipoint",l=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":r="polyline",l=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":r="polygon",l=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":l=!0,t.push(new p(G,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(a)}));break;default:t.push(new p(K,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(a)}))}l&&e.push(new y({name:o,alias:o,type:"geometry",nullable:c}))}for(const s of e)if(s.type==="integer"&&!s.nullable&&ye.has(s.name.toLowerCase())){s.type="oid";break}return{geometryType:r,fields:e,errors:t}}async function ge(a,t,e,r,n){let{data:s}=await b(a,{responseType:"text",query:I(t,e,r,n),signal:n==null?void 0:n.signal});s=s.replaceAll(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{return JSON.parse(s)}catch(o){throw new p(Q,"Error while parsing theÂ response",{response:s,error:o})}}function I(a,t,e,r){const n=typeof t=="number"?t:t.wkid;return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:d,TYPENAMES:a,OUTPUTFORMAT:e,SRSNAME:"EPSG:"+n,STARTINDEX:r==null?void 0:r.startIndex,COUNT:r==null?void 0:r.count,...r==null?void 0:r.customParameters}}async function ke(a,t,e){const r=await b(a,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:d,TYPENAMES:t,RESULTTYPE:"hits",...e==null?void 0:e.customParameters},signal:e==null?void 0:e.signal}),n=/numberMatched=["'](?<numberMatched>\d+)["']/gi.exec(r.data);if(n!=null&&n.groups)return+n.groups.numberMatched}function U(a){return new DOMParser().parseFromString(a.trim(),"text/xml")}function w(a){const[t,e]=a.split(":");return{prefix:e?t:"",name:e??t}}function we(a){var e;const t=(e=a.firstElementChild)==null?void 0:e.getAttribute("version");if(t&&t!==d)throw new p(ee,`Unsupported WFS version ${t}. Supported version: ${d}`)}function j(a){let t="",e="";if(x(a.firstElementChild,{Exception:r=>(t=r.getAttribute("exceptionCode"),{ExceptionText:n=>{e=n.textContent}})}),t)throw new p(`wfs-layer:${t}`,e)}function be(a,t,e){const r={wkid:t.defaultSpatialReference},n=(e==null?void 0:e.wkid)!=null?{wkid:e.wkid}:r;return{spatialReference:n,getFeatureSpatialReference:O(a)||n.wkid&&t.supportedSpatialReferences.includes(n.wkid)?{wkid:n.wkid}:{wkid:t.defaultSpatialReference}}}export{pe as G,ge as I,be as U,Ce as a,ke as b,Ee as l,ie as v,R as x};
