import{hN as R,ak as V,e6 as E,dT as U,m1 as T,co as c,dR as b,N as y,m2 as B,A as O,V as N,lL as X,l as F,ax as k,_ as W,bX as $}from"./index-BeTPrQ6f.js";import{n as G}from"./videoUtils-ZWM8l9ln-fGQ142sg.js";import{r as K}from"./requestImageUtils-CrIBaPUj-khjAqpU7.js";import{L as h}from"./enums-DDJfd4_p-D3z9tmVA.js";import{$ as z,w as f,g as Z,Z as q}from"./Texture-DLw7oaIg-fTsxdRzn.js";import{aL as J}from"./OutputColorHighlightOID.glsl-fUhBGshN-Ctm9N97M.js";import{d as Q}from"./BufferView-B6RYETl3-CMoUTBv6.js";function j(){return w??(w=(async()=>{const r=await W(()=>import("./basis_transcoder-qOMORVob-Boj_pirv.js"),[],import.meta.url),t=await r.default({locateFile:e=>$(`esri/libs/basisu/${e}`)});return t.initializeBasis(),t})()),w}let w,o=null,g=null;async function A(){return g==null&&(g=j(),o=await g),g}function Y(r,t){if(o==null)return r.byteLength;const e=new o.BasisFile(new Uint8Array(r)),a=C(e)?D(e.getNumLevels(0),e.getHasAlpha(),e.getImageWidth(0,0),e.getImageHeight(0,0),t):0;return e.close(),e.delete(),a}function tt(r,t){if(o==null)return r.byteLength;const e=new o.KTX2File(new Uint8Array(r)),a=I(e)?D(e.getLevels(),e.getHasAlpha(),e.getWidth(),e.getHeight(),t):0;return e.close(),e.delete(),a}function D(r,t,e,a,s){const n=q(t?h.COMPRESSED_RGBA8_ETC2_EAC:h.COMPRESSED_RGB8_ETC2),i=s&&r>1?(4**r-1)/(3*4**(r-1)):1;return Math.ceil(e*a*n*i)}function C(r){return r.getNumImages()>=1&&!r.isUASTC()}function I(r){return r.getFaces()>=1&&r.isETC1S()}async function et(r,t,e){o==null&&(o=await A());const a=new o.BasisFile(new Uint8Array(e));if(!C(a))return null;a.startTranscoding();const s=L(r,t,a.getNumLevels(0),a.getHasAlpha(),a.getImageWidth(0,0),a.getImageHeight(0,0),(n,i)=>a.getImageTranscodedSizeInBytes(0,n,i),(n,i,l)=>a.transcodeImage(l,0,n,i,0,0));return a.close(),a.delete(),s}async function at(r,t,e){o==null&&(o=await A());const a=new o.KTX2File(new Uint8Array(e));if(!I(a))return null;a.startTranscoding();const s=L(r,t,a.getLevels(),a.getHasAlpha(),a.getWidth(),a.getHeight(),(n,i)=>a.getImageTranscodedSizeInBytes(n,0,0,i),(n,i,l)=>a.transcodeImage(l,n,0,0,i,0,-1,-1));return a.close(),a.delete(),s}function L(r,t,e,a,s,n,i,l){const{compressedTextureETC:d,compressedTextureS3TC:x}=r.capabilities,[_,P]=d?a?[1,h.COMPRESSED_RGBA8_ETC2_EAC]:[0,h.COMPRESSED_RGB8_ETC2]:x?a?[3,h.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[2,h.COMPRESSED_RGB_S3TC_DXT1_EXT]:[13,6408],H=t.hasMipmap?e:Math.min(1,e),p=[];for(let u=0;u<H;u++)p.push(new Uint8Array(i(u,_))),l(u,_,p[u]);return t.internalFormat=P,t.hasMipmap=p.length>1,t.samplingMode=t.hasMipmap?9987:9729,t.width=s,t.height=n,new f(r,t,{type:"compressed",levels:p})}const m=16;function M(r,t){return t=Math.floor(t/m)*m,Math.min(Math.round(r/m)*m,t)}function pt(r,t){return t=Math.floor(t/m)*m,Math.min(Math.ceil(r/m)*m,t)}function rt(r,t){const[e,a]=st(r,t);return r.width===e&&r.height===a?r:v(r,e,a)}function st({width:r,height:t},{maxPreferredTexturePixels:e,maxTextureSize:a}){const s=Math.max(r,t),n=r*t;if(s<=a&&n<=e)return[r,t];const i=Math.min(Math.sqrt(e/n),a/s);return[M(Math.round(r*i),a),M(Math.round(t*i),a)]}function v(r,t,e){if(r instanceof ImageData)return v(nt(r),t,e);const a=document.createElement("canvas");return a.width=t,a.height=e,a.getContext("2d").drawImage(r,0,0,a.width,a.height),a}function nt(r){const t=document.createElement("canvas");t.width=r.width,t.height=r.height;const e=t.getContext("2d");if(e==null)throw new F("texture:context-failed","Failed to create 2d context from HTMLCanvasElement");return e.putImageData(r,0,0),t}class gt{constructor(t,e){this._data=t,this.id=R(),this.events=new V,this._parameters={...ot,...e},this._startPreload(t)}dispose(){this.unload(),this._data=this.update=void 0}_startPreload(t){t instanceof HTMLVideoElement?(this.update=e=>this._update(t,e),this._startPreloadVideoElement(t)):t instanceof HTMLImageElement&&this._startPreloadImageElement(t)}_startPreloadVideoElement(t){if(!(E(t.src)||t.preload==="auto"&&t.crossOrigin)&&(t.preload="auto",t.crossOrigin="anonymous",t.src=t.src,t.paused&&t.autoplay)){const e=[];G(t,a=>e.push(a)).then(()=>{t.play()}).finally(()=>e.forEach(a=>a.remove()))}}_startPreloadImageElement(t){U(t.src)||E(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}_createDescriptor(t){const e=new z;return e.wrapMode=this._parameters.wrap??10497,e.flipped=!this._parameters.noUnpackFlip,e.samplingMode=this._parameters.mipmap?9987:9729,e.hasMipmap=!!this._parameters.mipmap,e.preMultiplyAlpha=!!this._parameters.preMultiplyAlpha,e.maxAnisotropy=this._parameters.maxAnisotropy??(this._parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e.dataType=this._parameters.dataType??e.dataType,e.pixelFormat=this._parameters.pixelFormat??e.pixelFormat,e.internalFormat=this._parameters.internalFormat??e.internalFormat,e}get glTexture(){return this._glTexture??this._emptyTexture}get loaded(){return this._glTexture!=null}get usedMemory(){var t;return((t=this._glTexture)==null?void 0:t.usedMemory)||it(this._data,this._parameters)}load(t){if(this._loadingPromise)return this._loadingPromise;if(this._glTexture)return this._glTexture;const e=this._data;return e==null?(this._glTexture=new f(t,this._createDescriptor(t),null),this._glTexture):(this._emptyTexture=t.emptyTexture,this._parameters.reloadable||(this._data=void 0),typeof e=="string"?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):T(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,e):c(e)&&this._parameters.encoding==="image/vnd-ms.dds"?this._loadFromDDSData(t,new Uint8Array(e)):(c(e)||T(e))&&this._parameters.encoding==="image/ktx2"?this._loadFromKTX2(t,e):(c(e)||T(e))&&this._parameters.encoding==="image/x.basis"?this._loadFromBasis(t,e):c(e)?this._loadFromPixelData(t,new Uint8Array(e)):b(e)?this._loadFromPixelData(t,e):null)}_update(t,e){return this._glTexture==null||t.readyState<HTMLMediaElement.HAVE_CURRENT_DATA||e===t.currentTime?e:(this._glTexture.setData(t),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this._parameters.updateCallback&&this._parameters.updateCallback(),t.currentTime)}_loadFromDDSData(t,e){return this._glTexture=J(t,this._createDescriptor(t),e),this._emptyTexture=null,this._glTexture}_loadFromKTX2(t,e){return this._loadAsync(()=>at(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromBasis(t,e){return this._loadAsync(()=>et(t,this._createDescriptor(t),e).then(a=>(this._glTexture=a,a)))}_loadFromPixelData(t,e){Q(this._parameters.width>0&&this._parameters.height>0);const a=this._createDescriptor(t);return a.pixelFormat!==6407&&a.pixelFormat!==6408||(a.compress=this._parameters.compressionOptions),a.width=this._parameters.width??0,a.height=this._parameters.height??0,this._glTexture=new f(t,a,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync(async a=>{const s=await K(e,{signal:a});return y(a),this._loadFromImage(t,s)})}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync(async a=>{const s=await B(e,e.src,!1,a);return y(a),this._loadFromImage(t,s)})}_loadFromVideoElement(t,e){return e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(t,e){return this._loadAsync(a=>new Promise((s,n)=>{const i=()=>{e.removeEventListener("loadeddata",l),e.removeEventListener("error",d),k(x)},l=()=>{e.readyState>=HTMLMediaElement.HAVE_CURRENT_DATA&&(i(),s(this._loadFromImage(t,e)))},d=_=>{i(),n(_||new F("texture:load-error","Failed to load video"))};e.addEventListener("loadeddata",l),e.addEventListener("error",d);const x=O(a,()=>d(N()))}))}_loadFromImage(t,e){let a=e;a instanceof HTMLVideoElement||(a=rt(a,t.parameters));const s=S(a);this._parameters.width=s.width,this._parameters.height=s.height;const n=this._createDescriptor(t);return n.width=s.width,n.height=s.height,n.compress=this._parameters.compressionOptions,this._glTexture=new f(t,n,a),this._emptyTexture=null,this.events.emit("loaded"),this._glTexture}_loadAsync(t){const e=new AbortController;this._loadingController=e;const a=t(e.signal);this._loadingPromise=a;const s=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===a&&(this._loadingPromise=null),this._emptyTexture=null};return a.then(s,s),a}unload(){if(this._glTexture=X(this._glTexture),this._emptyTexture=null,this._loadingController!=null){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}get parameters(){return this._parameters}}function it(r,t){if(r==null)return 0;if(c(r)||T(r))return t.encoding==="image/ktx2"?tt(r,!!t.mipmap):t.encoding==="image/x.basis"?Y(r,!!t.mipmap):r.byteLength;const{width:e,height:a}=r instanceof Image||r instanceof ImageData||r instanceof HTMLCanvasElement||r instanceof HTMLVideoElement?S(r):t,s=t.pixelFormat??6408,n=Z(s);return(t.mipmap?4/3:1)*e*a*n||0}function S(r){return r instanceof HTMLVideoElement?{width:r.videoWidth,height:r.videoHeight}:r}const ot={wrap:{s:10497,t:10497},mipmap:!0,noUnpackFlip:!1,preMultiplyAlpha:!1};export{M as E,pt as a,gt as n};
