import{co as x,aB as C,be as I}from"./index-BeTPrQ6f.js";import{v as O}from"./quat-B6H0knG8-DtO1-hlf.js";import{e as k}from"./quatf64-C16JxGFv-BKWK1F8U.js";import{Z as F}from"./vec32-CI1xtKog-DFVYRcgb.js";import{u as A,o as w}from"./vec3f32-GX_cKsFD-UJPpzdNc.js";import{o as R}from"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import{u as U,p as B,n as J}from"./PointCloudUniqueValueRenderer-CyZdx5g9-B6MH2sy7.js";import{t as N,z as V,W as T,r as q}from"./I3SBinaryReader-DUQR-wji-z8SYHkks.js";import{i as Z}from"./orientedBoundingBox-DAJ-bKlA-DbqXagWB.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./RendererLegendOptions-_ue7FeM0-ROeRce-g.js";import"./ColorStop-CBXZUZ6o-_LZdJKea.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./spatialReferenceEllipsoidUtils-Ty3j4VoE-BUAsRqCF.js";import"./computeTranslationToOriginAndRotation-CsOb5S2S-CE5ZgVBy.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./plane-wUwHaY3K-ZwGBF7HQ.js";import"./vectorStacks-B2ngxq6F-myhPBoPk.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";function z(a,t,l,n){const{rendererJSON:u,isRGBRenderer:m}=a;let o=null,i=null;if(t&&m)o=t;else if(t&&(u==null?void 0:u.type)==="pointCloudUniqueValueRenderer"){i=U.fromJSON(u);const r=i.colorUniqueValueInfos;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let e=0;e<n;e++){const f=(c?c(t[e]):t[e])+"";for(let s=0;s<r.length;s++)if(r[s].values.includes(f)){o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;break}}}else if(t&&(u==null?void 0:u.type)==="pointCloudStretchRenderer"){i=B.fromJSON(u);const r=i.stops;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let e=0;e<n;e++){const f=c?c(t[e]):t[e],s=r.length-1;if(f<r[0].value)o[3*e]=r[0].color.r,o[3*e+1]=r[0].color.g,o[3*e+2]=r[0].color.b;else if(f>=r[s].value)o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;else for(let b=1;b<r.length;b++)if(f<r[b].value){const p=(f-r[b-1].value)/(r[b].value-r[b-1].value);o[3*e]=r[b].color.r*p+r[b-1].color.r*(1-p),o[3*e+1]=r[b].color.g*p+r[b-1].color.g*(1-p),o[3*e+2]=r[b].color.b*p+r[b-1].color.b*(1-p);break}}}else if(t&&(u==null?void 0:u.type)==="pointCloudClassBreaksRenderer"){i=J.fromJSON(u);const r=i.colorClassBreakInfos;o=new Uint8Array(3*n);const c=g(i.fieldTransformType);for(let e=0;e<n;e++){const f=c?c(t[e]):t[e];for(let s=0;s<r.length;s++)if(f>=r[s].minValue&&f<=r[s].maxValue){o[3*e]=r[s].color.r,o[3*e+1]=r[s].color.g,o[3*e+2]=r[s].color.b;break}}}else o=new Uint8Array(3*n).fill(255);if(l&&(i!=null&&i.colorModulation)){const r=i.colorModulation.minValue,c=i.colorModulation.maxValue,e=.3;for(let f=0;f<n;f++){const s=l[f],b=s>=c?1:s<=r?e:e+(1-e)*(s-r)/(c-r);o[3*f]=b*o[3*f],o[3*f+1]=b*o[3*f+1],o[3*f+2]=b*o[3*f+2]}}return o}function E(a,t){if(a.encoding==null||a.encoding===""){const l=N(t,a);if(l.vertexAttributes.position==null)return;const n=V(t,l.vertexAttributes.position),u=l.header.fields,m=[u.offsetX,u.offsetY,u.offsetZ],o=[u.scaleX,u.scaleY,u.scaleZ],i=n.length/3,r=new Float64Array(3*i);for(let c=0;c<i;c++)r[3*c]=n[3*c]*o[0]+m[0],r[3*c+1]=n[3*c+1]*o[1]+m[1],r[3*c+2]=n[3*c+2]*o[2]+m[2];return r}if(a.encoding==="lepcc-xyz")return T(t).result}function h(a,t,l){return a!=null&&a.attributeInfo.useElevation?t?X(t,l):null:a!=null&&a.attributeInfo.storageInfo?q(a.attributeInfo.storageInfo,a.buffer,l,!0):null}function X(a,t){const l=new Float64Array(t);for(let n=0;n<t;n++)l[n]=a[3*n+2];return l}function Y(a,t,l,n,u){const m=a.length/3;let o=0;for(let i=0;i<m;i++){let r=!0;for(let c=0;c<n.length&&r;c++){const{filterJSON:e}=n[c],f=u[c].values[i];switch(e.type){case"pointCloudValueFilter":{const s=e.mode==="exclude";e.values.includes(f)===s&&(r=!1);break}case"pointCloudBitfieldFilter":{const s=M(e.requiredSetBits),b=M(e.requiredClearBits);(f&s)===s&&!(f&b)||(r=!1);break}case"pointCloudReturnFilter":{const s=15&f,b=f>>>4&15,p=b>1,S=s===1,v=s===b;let y=!1;for(const d of e.includedReturns)if(d==="last"&&v||d==="firstOfMany"&&S&&p||d==="lastOfMany"&&v&&p||d==="single"&&!p){y=!0;break}y||(r=!1);break}}}r&&(l[o]=i,a[3*o]=a[3*i],a[3*o+1]=a[3*i+1],a[3*o+2]=a[3*i+2],t[3*o]=t[3*i],t[3*o+1]=t[3*i+1],t[3*o+2]=t[3*i+2],o++)}return o}function g(a){switch(a){default:case null:case"none":return t=>t;case"low-four-bit":return t=>15&t;case"high-four-bit":return t=>(240&t)>>4;case"absolute-value":return t=>Math.abs(t);case"modulo-ten":return t=>t%10}}function M(a){let t=0;for(const l of a||[])t|=1<<l;return t}class _{transform(t){const l=this._transform(t),n=[l.points.buffer,l.rgb.buffer];l.pointIdFilterMap!=null&&n.push(l.pointIdFilterMap.buffer);for(const u of l.attributes)"buffer"in u.values&&x(u.values.buffer)&&u.values.buffer!==l.rgb.buffer&&n.push(u.values.buffer);return Promise.resolve({result:l,transferList:n})}_transform(t){const l=E(t.schema,t.geometryBuffer);let n=l.length/3,u=null;const m=new Array,o=h(t.primaryAttributeData,l,n);t.primaryAttributeData!=null&&o&&m.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:o});const i=h(t.modulationAttributeData,l,n);t.modulationAttributeData!=null&&i&&m.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:i});let r=z(t.rendererInfo,o,i,n);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const e=t.filterAttributesData.filter(C).map(f=>{const s=h(f,l,n),b={attributeInfo:f.attributeInfo,values:s};return m.push(b),b});u=new Uint32Array(n),n=Y(l,r,u,t.filterInfo,e)}for(const e of t.userAttributesData){const f=h(e,l,n);m.push({attributeInfo:e.attributeInfo,values:f})}3*n<r.length&&(r=new Uint8Array(r.buffer.slice(0,3*n))),G(l,n,t.elevationOffset);const c=j(l,n,Z.fromData(t.obbData),I.fromJSON(t.inSR),I.fromJSON(t.outSR));return{obbData:t.obbData,points:c,rgb:r,attributes:m,pointIdFilterMap:u}}}function j(a,t,l,n,u){if(!R(a,n,0,a,u,0,t))throw new Error("Can't reproject");const m=A(l.center),o=w(),i=w(),r=A(l.halfSize);O(D,l.quaternion);const c=new Float32Array(3*t);for(let e=0;e<t;e++){let f=3*e;o[0]=a[f]-m[0],o[1]=a[f+1]-m[1],o[2]=a[f+2]-m[2],F(i,o,D),r[0]=Math.max(r[0],Math.abs(i[0])),r[1]=Math.max(r[1],Math.abs(i[1])),r[2]=Math.max(r[2],Math.abs(i[2])),c[f++]=o[0],c[f++]=o[1],c[f]=o[2]}return l.halfSize=r,c}function G(a,t,l){if(l!==0)for(let n=0;n<t;n++)a[3*n+2]+=l}const D=k();function bt(){return new _}export{bt as default};
