import{cE as _,l as E,bW as V,cF as j,P as U,q as ee,bw as te}from"./index-BeTPrQ6f.js";import{u as G,I as B,i as P}from"./TimeOnly-BFfVS_ja-C4MPGwCM.js";import{e as J}from"./arcadeEnvironment-CGtXgdl9-Db3WjmFu.js";import{n as re}from"./ImmutableArray-CiJxhY8_-Kqx7aWRu.js";import ae from"./FeatureLayer-CCD4d2TK-D-vTdTyl.js";import{c as oe}from"./FeatureSet-BIUKCqNW-D9YRl-VE.js";import"./enum-D3e-PyKo-Bl5V5br5.js";import"./UnknownTimeZone-DzO8gKMe-d6rtFXqm.js";import"./MultiOriginJSONSupport-DNNJhlNT-Bm4fcG4m.js";import"./layerContainerType-CJrPp4UB-BIF7XAYP.js";import"./FormTemplate-VNQ04sPR-DwlQPeuM.js";import"./Field-Dn1Bgq7n-CJCGLoNR.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./GraphicOrigin-BZpgptRb-BMZxic91.js";import"./workers-CixlqDQM-CMoJ1YZN.js";import"./Queue-CK6TduSr-C-T211SM.js";import"./intl-DRhjUnwt-Dihhq8dq.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./editsZScale-DcYeqiDn-O8ivdk-A.js";import"./queryZScale-B66ZWsfS-D7Zc2_Zh.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./APIKeyMixin-DYy2zfLn-D3z7LonQ.js";import"./ArcGISService-CytDmkiZ-emNrPdED.js";import"./BlendLayer-D8oJmNCO-A0sTzbOF.js";import"./jsonUtils-Bl9MVnOR-Be8hf0yA.js";import"./parser-CXoJuqeV-C7irlk5U.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./CustomParametersMixin-CqtpZgix-ZCd9Um94.js";import"./DisplayFilteredLayer-Ce0lf91Z-D_UnOF-a.js";import"./scaleUtils-Ckma21r5-DhwWQymd.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./displayFilterUtils-BCW-UeaE-CnjPWjFU.js";import"./EditBusLayer-B5fJK8S9-BfKLF1l7.js";import"./FeatureEffectLayer-Bw8pqFtl-COIpRlV8.js";import"./FeatureEffect-xxDa5IRG-DfQBGcCi.js";import"./FeatureFilter-D0iZ4sKI-BBZH0Xo9.js";import"./Query-DKLDaFaA-I4zhlfzt.js";import"./FeatureLayerBase-Ca6xrS5x-bGdb6Ysq.js";import"./HeightModelInfo-Cjals-AI-DMpn5Tsh.js";import"./OperationalLayer-Ds0FQSCg-DEUbTcjK.js";import"./ElevationInfo-tlrAM5SV-D86C1F9d.js";import"./lengthUtils-CopeXEyE-DjCEitlq.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./labelingInfo-jIy5P_vY-D8rEl7NY.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./SimpleRenderer-DSyBXxyY-CGNZcXII.js";import"./commonProperties-CYpRbAZr-PcmW9U_y.js";import"./colorRamps-C5pnMn-A-BSSJ2zvJ.js";import"./ColorStop-CBXZUZ6o-_LZdJKea.js";import"./visualVariableUtils-DzY4BXXy-D_1S-x1B.js";import"./UniqueValueRenderer-4zUMozui-C0Y5GPGV.js";import"./diffUtils-D3O4EfgX-CznKxD4n.js";import"./RendererLegendOptions-_ue7FeM0-ROeRce-g.js";import"./styleUtils-DoTsJ8ze-DHY40A2q.js";import"./RelationshipQuery-Cf-_aN1Z-mThKQ0J2.js";import"./NormalizationBinParametersMixin-DuEmpnQx-abBJwXnQ.js";import"./labelUtils-BLNYRrPe-Cv1ZZjAO.js";import"./LayerFloorInfo-krwL5pHA-C-NgvUlX.js";import"./multiLayerServiceUtils-DET2KhOE-Bw336UOx.js";import"./Relationship-YLK2X_M_-G1AF1PCW.js";import"./serviceCapabilitiesUtils-Cm1_ZgDe-BkUSvtE4.js";import"./infoFor3D-BeWnZejW-CnXQECJx.js";import"./portalItemUtils-C12I5owR-Iiaf4oEu.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./FeatureReductionLayer-fRVzjp_G-BAykrsM3.js";import"./FeatureReductionSelection-BYDlwJ5u-CQfZ-i0-.js";import"./jsonUtils-5anAqpiW-BnpEYfRl.js";import"./typeUtils-BTAsL08--B1VjqkPN.js";import"./ClassBreaksRenderer-AH_lBYRG-CIe34emV.js";import"./LRUCache-CvGiiws0-B3io5Jp4.js";import"./MemCache-TG-MhOJy-BkjKRNR7.js";import"./DictionaryScriptEvaluator-DrG0wIBl-D15kCKMK.js";import"./Version-DSJSGSLA-Cg87msWM.js";import"./FieldsIndex-Ds4D9xP7-BiTuE5Z3.js";import"./ArcadeExpression-BGPPS6z--7N6gsB31.js";import"./utils-CIm5uQvO-CtKf129F.js";import"./defaultCIMValues-BWu-APou-XI-Li77m.js";import"./heatmapUtils-Bf2yRyEN-BAQJ1IRB.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./OrderedLayer-BpzV2gVo-B7bag0TS.js";import"./OrderByInfo-D0eImi6z-Dv2CatL0.js";import"./PortalLayer-B52AUJ7S-DLZhjKpz.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./RefreshableLayer-BEBm0YMm-CEdeDwog.js";import"./ScaleRangeLayer-DkZwCH6_-C95kTMqN.js";import"./TemporalLayer-D43PzGI2-BVfMl_Wx.js";import"./TimeInfo-BoebCPJB-ubr6IA4W.js";import"./TrackableLayer-B6TLWZyJ-CFqD-uca.js";import"./FeatureTemplate-DN-lMS1p-caqKKpFl.js";import"./FeatureType-BaXpcfS--CXOAiC-Q.js";import"./fieldProperties-B4tOVJmv-DQSPMAAi.js";import"./TitleCreator-BrV1DW5U-CU3Ke3Vx.js";import"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";import"./versionUtils-DTdDMzVZ-DiRjVmBE.js";import"./styleUtils-BQqoMgIA-U43o5V_5.js";import"./popupUtils-D0h6TFFF-Bch8GtRu.js";let b=null;function ne(e,o,a,i={}){const t=o.elementType,p="value",m=t.type==="array"?[{name:p,type:t.type,elementType:t.elementType}]:t.type==="dictionary"?[{name:p,type:t.type,properties:t.properties}]:[{name:p,type:t.type}];return new re(e.map(n=>{const r={};return R(r,m,{[p]:n},a,i),r[p]}))}function ie(e,o,a={}){const i=e instanceof oe?new ae({source:e.features,geometryType:e.geometryType,fields:e.fields,spatialReference:e.spatialReference}):e;return o.constructFeatureSet(i,a.spatialReference,null,!0,a.lruCache,a.interceptor)}function pe(e,o,a={}){const{spatialReference:i,interceptor:t,lruCache:p}=a;return typeof e=="string"?o.createFeatureSetCollectionFromService(e,i,p,t):o.createFeatureSetCollectionFromMap(e,i,p,t)}function ce(e,o,a,i={}){const t=Object.create(null);return R(t,o.properties,e,a,i),new b.Dictionary(t)}function R(e,o,a,i,t={}){const p={};for(const m of Object.keys(a))p[m.toLowerCase()]=a[m];for(const m of o){const n=m.name.toLowerCase();if(t.variablesPreProcessed)e[n]=p[n];else switch(m.type){case"array":{const r=p[n];e[n]=r==null?null:ne(r,m,i,t);break}case"feature":{const r=p[n];e[n]=r==null?null:b.Feature.createFromGraphic(r,t==null?void 0:t.timeZone);break}case"featureSet":{const r=p[n];e[n]=r==null?null:i?ie(r,i,t):null;break}case"featureSetCollection":{const r=p[n];e[n]=r==null?null:i?pe(r,i,t):null;break}case"dictionary":{const r=p[n];e[n]=r==null?null:ce(r,m,i,t);break}case"date":{const r=p[n];e[n]=r?r instanceof P?r:t!=null&&t.timeZone?P.dateJSAndZoneToArcadeDate(r,t==null?void 0:t.timeZone):P.dateJSToArcadeDate(r):null;break}case"dateOnly":{const r=p[n];e[n]=r?r instanceof B?r:B.fromReader(r):null;break}case"time":{const r=p[n];e[n]=r?r instanceof G?r:G.fromReader(r):null;break}case"knowledgeGraph":case"geometry":case"boolean":case"text":case"number":e[n]=p[n];break;case"voxel":{const r=p[n];e[n]=r==null?null:new b.Voxel(r,t==null?void 0:t.timeZone);break}case"pixel":{const r=p[n];e[n]=r==null?null:b.Pixel.fromImageryGraphic(r,t==null?void 0:t.timeZone);break}}}}function W(e,o){for(const a of e)o.push(a),a.type==="dictionary"&&W(a.properties,o);return o}function O(e,o,a,i,t){const{spatialReference:p,interceptor:m,lruCache:n,console:r,abortSignal:x,timeZone:C,services:v={portal:V.getDefault()},track:s}=a,w={vars:{},spatialReference:p,interceptor:m,timeZone:C,lrucache:n,useAsync:t,services:v,console:r,abortSignal:x,track:s};return o&&R(w.vars,e.variables,o,i,a),w}function $(e,o){switch(o.getArcadeType(e)){case"number":case"text":case"boolean":case"point":case"polygon":case"polyline":case"multipoint":case"extent":return e;case"date":return e.toJSDate();case"time":case"dateOnly":return e.toString();case"feature":{const a=(e.type,e),i="geometry"in a?a.geometry():null,t="readAttributes"in a?a.readAttributes():a.attributes;return new te({geometry:i,attributes:t})}case"dictionary":{const a=e,i=a.attributes,t={};for(const p of Object.keys(i))t[p]=$(a.field(p),o);return t}case"array":return("toArray"in e?e.toArray():e).map(a=>$(a,o))}return e}const L={variables:[{name:"$feature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$userInput",type:"geometry"},{name:"$graph",type:"knowledgeGraph"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"},{name:"timeProperties",type:"dictionary",properties:[{name:"currentStart",type:"date"},{name:"currentEnd",type:"date"},{name:"startIncluded",type:"boolean"},{name:"endIncluded",type:"boolean"}]}]}]},M={variables:[{name:"$feature",type:"feature"},{name:"$aggregatedFeatures",type:"featureSet"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"},{name:"timeProperties",type:"dictionary",properties:[{name:"currentStart",type:"date"},{name:"currentEnd",type:"date"},{name:"startIncluded",type:"boolean"},{name:"endIncluded",type:"boolean"}]}]}]},q={variables:[{name:"$voxel",type:"voxel"}]},z={variables:[{name:"$pixel",type:"pixel"},{name:"$imageCollectionItem",type:"feature"}]},N=new Map([["aggregate-field",{variables:[{name:"$feature",type:"feature"}]}],["form-constraint",{variables:[{name:"$feature",type:"feature"}]}],["feature-z",{variables:[{name:"$feature",type:"feature"}]}],["field-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$datastore",type:"featureSetCollection"}]}],["form-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$originalFeature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$featureSet",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$editContext",type:"dictionary",properties:[{name:"editType",type:"text"}]}]}],["labeling",{variables:[{name:"$feature",type:"feature"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"},{name:"timeProperties",type:"dictionary",properties:[{name:"currentStart",type:"date"},{name:"currentEnd",type:"date"},{name:"startIncluded",type:"boolean"},{name:"endIncluded",type:"boolean"}]}]}]}],["popup",L],["popup-element",L],["popup-feature-reduction",M],["popup-element-feature-reduction",M],["visualization",{variables:[{name:"$feature",type:"feature"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"},{name:"timeProperties",type:"dictionary",properties:[{name:"currentStart",type:"date"},{name:"currentEnd",type:"date"},{name:"startIncluded",type:"boolean"},{name:"endIncluded",type:"boolean"}]}]}]}],["popup-voxel",q],["popup-element-voxel",q],["popup-imagery",z],["popup-element-imagery",z]]);function tr(e){e==="feature-reduction-popup"?(j(U.getLogger("esri.arcade"),'profile name: "feature-reduction-popup"',{replacement:'"popup-feature-reduction"',version:"4.32",warnOnce:!0}),e="popup-feature-reduction"):e==="feature-reduction-popup-element"&&(j(U.getLogger("esri.arcade"),'profile name: "feature-reduction-popup-element"',{replacement:'"popup-element-feature-reduction"',version:"4.32",warnOnce:!0}),e="popup-element-feature-reduction");const o=N.get(e);if(!o){const a=Array.from(N.keys()).map(i=>`'${i}'`).join(", ");throw new E("createArcadeProfile:invalid-profile-name",`Invalid profile name '${e}'. You must specify one of the following values: ${a}`)}return ee(o)}async function rr(e,o,a={}){b||(b=await _());const{arcade:i,arcadeUtils:t,batchExec:{createBatchExecutor:p},aiServices:{BatchTranslationServiceFactory:m,PortalTranslationService:n}}=b,{loadScriptDependencies:r,referencesMember:x,scriptIsAsync:C}=i,v=W(o.variables,[]).filter(c=>c.type==="featureSet"||c.type==="featureSetCollection").map(c=>J(c.name)),s=i.parseScript(e,v);if(!s)throw new E("arcade:invalid-script","Unable to create SyntaxTree");const w=t.extractFieldNames(s),X=i.scriptTouchesGeometry(s),Z=o.variables.map(c=>J(c.name)).filter(c=>x(s,c)),f=C(s,v);await r(s,f,v);const k=i.compileScript(s,{vars:Object.fromEntries(Z.map(c=>[c,!0])),useAsync:f}),{lruCache:A,services:I}=a,T=i.featureSetUtils();return{execute:(c,l={})=>{if(f)throw new E("arcade:invalid-execution-mode","Cannot execute the script in synchronous mode");const u={...I,...l.services},d={lruCache:A,...l,services:u},y=k(O(o,c,d,T,f));return l.rawOutput?y:$(y,t)},executeAsync:async(c,l={})=>{const u={...I,...l.services},d={lruCache:A,...l,services:u},y=await k(O(o,c,d,T,f));return l.rawOutput?y:$(y,t)},executeAsyncBatch:async(c,l,u={})=>{const d=[],y=p(c,async(g,S)=>{const H=l(g);try{const h={...F,translation:Y.create(S)},K={lruCache:A,...u,services:h},D=await k(O(o,H,K,T,f)),Q=u.rawOutput?D:$(D,t);d.push({id:S.id,result:{status:"fulfilled",value:Q}})}catch(h){throw d.push({id:S.id,result:{status:"rejected",reason:h}}),h}},u.maxConcurrency??64,u.abortSignal),F={...I,...u.services},Y=new m(y,F.translation??new n(F.portal??V.getDefault(),u.console));return await y.run(),d.sort(({id:g},{id:S})=>g-S).map(({result:g})=>g)},isAsync:f,variablesUsed:Z,fieldsUsed:w,geometryUsed:X,syntaxTree:s}}export{rr as createArcadeExecutor,tr as createArcadeProfile};
