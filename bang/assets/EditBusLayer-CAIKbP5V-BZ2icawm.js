const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-CowuKkRn-CAAJ4Y0e.js","./index-DRDU_nTl.js","./index-6GCfk1Ih.css","./utils-BO8hgPs3-CHxondnJ.js","./DeleteForwardEditsParameters-B5MnTM13-B0HnYOEv.js"])))=>i.map(i=>d[i]);
import{K as x,v as V,S as T,n as k,N as D,_ as A,H as P,q as f}from"./index-DRDU_nTl.js";import{c as N}from"./uuid-Dj9mdEVg-BaKSCiyT.js";const $=N(),H=new Map,S=new Map;async function z(e,n,d){if(!e||!d)return!1;if(!n)return!0;const r=new URL(e).host;let i=H.get(r);if(!i){const o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");i=(await D(o,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return i===n}async function C(e,n,d=!1){var o,t,u;if(!e||!n)return!0;const r=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=(o=S.get(r))==null?void 0:o.entries();if(i){for(const[a,l]of i)if(l.name===n){const h=!((t=l.stack)!=null&&t.hasForwardEdits());if(!h&&d){const[{deleteForwardEdits:p},{default:m}]=await Promise.all([A(()=>import("./deleteForwardEdits-CowuKkRn-CAAJ4Y0e.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),A(()=>import("./DeleteForwardEditsParameters-B5MnTM13-B0HnYOEv.js"),__vite__mapDeps([4,1,2]),import.meta.url)]),b=await p(r,a,new m({sessionId:$,moment:l.moment}));return b.success&&((u=l.stack)==null||u.clearForwardEdits()),b.success}return h}}return!0}function q(e,n){var i;if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),r=(i=S.get(d))==null?void 0:i.entries();if(r){for(const[o,t]of r)if(t.name===n)return t.lockType==="edit"}return!1}const y=new x.EventEmitter;function O(e){return y.on("apply-edits",new WeakRef(e))}function W(e){return y.on("update-moment",new WeakRef(e))}function G(e,n,d=null,r=!1){const i=P();return r=n==null||r,y.emit("apply-edits",{serviceUrl:e,layerId:n,gdbVersion:d,mayReceiveServiceEdits:r,result:i.promise}),i}const U=Symbol();function J(e){return e!=null&&typeof e=="object"&&U in e}function F(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,n,d){const r=new URL(e).host,i=H.get(r),o=t=>!t||t===i;return o(n)&&o(d)||n===d}const Q=e=>{var r;var n;let d=(r=class extends e{constructor(...i){super(...i),this[n]=!0,this._applyEditsHandler=o=>{const{serviceUrl:t,layerId:u,gdbVersion:a,mayReceiveServiceEdits:l,result:h}=o,p=t===this.url,m=u!=null&&this.layerId!=null&&u===this.layerId,b=F(this),R=F(this)&&M(t,a,this.gdbVersion);if(!p||b&&!R||!m&&!l)return;const L=h.then(s=>{var _;if(this.lastEditsEventDate=new Date,m&&(s.addedFeatures.length||s.updatedFeatures.length||s.deletedFeatures.length||s.addedAttachments.length||s.updatedAttachments.length||s.deletedAttachments.length))return this.emit("edits",f(s)),s;const v=(_=s.editedFeatures)==null?void 0:_.find(({layerId:g})=>g===this.layerId);if(v){const{adds:g,updates:E,deletes:w}=v.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:g?g.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:f(s.editedFeatures),exceededTransferLimit:!1,historicMoment:f(s.historicMoment)};return this.emit("edits",j),j}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:f(s.editedFeatures),exceededTransferLimit:!1,historicMoment:f(s.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,I.historicMoment)&&this.emit("edits",I),I}).then(s=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,s.historicMoment)&&(this.historicMoment=s.historicMoment),s));this.emit("apply-edits",{result:L})},this._updateMomentHandler=o=>{const{serviceUrl:t,gdbVersion:u,moment:a}=o,l=t===this.url,h=F(this),p=F(this)&&M(t,u,this.gdbVersion),m=F(this)&&!M(t,this.gdbVersion,null);l&&h&&p&&m&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then(()=>{this.addHandles(O(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(i,o,t){return"historicMoment"in this&&this.historicMoment!==t&&q(i,o)}},n=U,r);return V([T()],d.prototype,"lastEditsEventDate",void 0),d=V([k("esri.layers.mixins.EditBusLayer")],d),d};export{z as B,Q as C,q as H,C as W,$ as j,G as q,J as z};
