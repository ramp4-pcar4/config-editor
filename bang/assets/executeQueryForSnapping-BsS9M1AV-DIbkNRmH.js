import{c2 as v,q as A,ap as F,$ as R}from"./index-DBm8NF9m.js";import{B as w}from"./normalizeUtils-u00NGW3M-d1A1od3m.js";import{T as I,p as M,h as g}from"./queryUtils-DZy8hWx3-lnI7N8pC.js";import{c as S,A as q,h as O}from"./QueryEngine-B7NH52mH-DgTGJopE.js";import{r as Q}from"./timeSupport-C2LrHIeW-PkU_ucfi.js";async function B(e,i,u){const a=v(u),{point:t,distance:r,returnEdge:p,vertexMode:l}=i;if(!p&&l==="none")return{candidates:[]};let n=A(i.query);n=await e.schedule(()=>I(n,e.definitionExpression,e.spatialReference),a),n=await e.reschedule(()=>S(n,{availableFields:e.availableFields,fieldsIndex:e.fieldsIndex,geometryType:e.geometryType,spatialReference:e.spatialReference}),a);const o=!F(t.spatialReference,e.spatialReference);o&&await M(t.spatialReference,e.spatialReference);const m=typeof r=="number"?r:r.x,f=typeof r=="number"?r:r.y,y={xmin:t.x-m,xmax:t.x+m,ymin:t.y-f,ymax:t.y+f,spatialReference:t.spatialReference},s=o?g(y,e.spatialReference):y;if(!s)return{candidates:[]};const d=(await w(R(t),null,{signal:a}))[0],x=(await w(R(s),null,{signal:a}))[0];if(d==null||x==null)return{candidates:[]};const c=new q(await e.reschedule(()=>e.searchFeatures(O(x.toJSON())),a),n,e);await e.reschedule(()=>e.executeObjectIdsQuery(c),a),await e.reschedule(()=>e.executeTimeQuery(c),a),await e.reschedule(()=>e.executeAttributesQuery(c),a),await e.reschedule(()=>Z(e,c,a),a);const h=d.toJSON(),b=o?g(h,e.spatialReference):h,T=o?Math.max(s.xmax-s.xmin,s.ymax-s.ymin)/2:r;return c.createSnappingResponse({...i,point:b,distance:T},n.returnZ,t.spatialReference)}async function Z(e,i,u){var l;const{query:a}=i,{spatialRel:t}=a;if(!((l=i==null?void 0:i.items)!=null&&l.length)||!a.geometry||!t)return;const r=await Q(t,a.geometry,e.geometryType,e.hasZ,e.hasM),p=await e.runSpatialFilter(i.items,n=>r(n.geometry),u);i.items=p}export{B as M};
