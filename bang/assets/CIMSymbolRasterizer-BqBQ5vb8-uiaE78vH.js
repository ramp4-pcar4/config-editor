import{dz as j,dy as k}from"./index-BeTPrQ6f.js";import{c as B}from"./CIMResourceManager-CcSrCojH-Bt2v7OJu.js";import{B as E,E as F,d as H}from"./CIMSymbolHelper-C-M9oL19-BYnF76mM.js";import{OverrideHelper as L}from"./OverrideHelper-RCCoK8tw-ysetE5jH.js";import{t as I,o as G}from"./rasterizingUtils-Cf1zdzIw-BfJyHaiy.js";import{j as z}from"./utils-CIm5uQvO-CtKf129F.js";import"./fontUtils-bOFLFKCC-gLU2ItK2.js";import"./imageUtils-DITyjHV4-jEv5aA2D.js";import"./BidiEngine-DXDmu_WZ-DxL95DSc.js";import"./labelPoint-DTWBMY-Z-DoXEvKTt.js";import"./OptimizedGeometry-BYxlP_oK-DvAqrgO1.js";import"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./GeometryUtils-C8-DjR3I-DcNL1Jc6.js";import"./defaultCIMValues-BWu-APou-XI-Li77m.js";import"./definitions-DVO21zOC-BwakNu1s.js";import"./mat2d-Cf4xHr3Z-u09Kv-lR.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./vec2f32-hTAvipMV-C0AQcwEv.js";import"./Rect-DD6XS68q-D_hsV3ag.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./colorUtils-DlmOacVt-BnN0T6wa.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./FieldsIndex-Ds4D9xP7-BiTuE5Z3.js";import"./UnknownTimeZone-DzO8gKMe-d6rtFXqm.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./ArcadeExpression-BGPPS6z--7N6gsB31.js";import"./TimeOnly-BFfVS_ja-C4MPGwCM.js";import"./enum-D3e-PyKo-Bl5V5br5.js";import"./callExpressionWithFeature-C8T2jtcK-BKO8mxzd.js";import"./quantizationUtils-Ba9rpy9D-8ijlY328.js";const $=96/72;class ft{constructor(a){this._spatialReference=a,this._imageDataCanvas=null,this._cimResourceManager=new B}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(a,o,m,v,l,n,g,c,f,R){if(!a)return null;const{data:p}=a;if(!p||p.type!=="CIMSymbolReference"||!p.symbol)return null;const{symbol:C}=p;n||(n=z(C));const s=await L.resolveSymbolOverrides(p,o,this._spatialReference,l,n,g,c),w=this._cimResourceManager,b=[];E.fetchResources(s,w,b),E.fetchFonts(s,w,b),b.length>0&&await Promise.all(b);const{width:e,height:r}=m;let y=D(n,e,r,v,R);const t=E.getEnvelope(s,y,w);if(!t)return null;t.x===1/0&&(t.x=e+2),t.y===1/0&&(t.y=-r/2),t.width===-1/0&&(t.width=e),t.height===-1/0&&(t.height=r);let d=1,S=0,_=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let i=1;t.width>e&&(i=e/t.width);let h=1;t.height>r&&(h=r/t.height),v==="preview"&&(t.width<e&&(i=e/t.width),t.height<r&&(h=r/t.height)),d=Math.min(i,h),S=t.x+t.width/2,_=t.y+t.height/2}break;case"CIMLineSymbol":if(R){_=t.y+t.height/2,S=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:I(y.paths,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{(f||t.height>r)&&(d=r/t.height),_=t.y+t.height/2;const i=t.x*d+e/2,h=(t.x+t.width)*d+e/2,M=j(y)?y.paths:k(y)?y.rings:null;if(M===null)throw new Error("Bad geometry, can't rasterise symbol!");M[0][0][0]-=i/d,M[0][2][0]-=(h-e)/d}break;case"CIMPolygonSymbol":if(R){_=t.y+t.height/2,S=t.x+t.width/2;const i=t.width-e,h=t.height-r;y={paths:I(y.rings,{xmin:-1*t.width/2+i,xmax:t.width/2-i,ymin:-1*t.height/2+h,ymax:t.height/2-h,width:t.width-2*i,height:t.height-2*h})}}else{S=t.x+t.width/2,_=t.y+t.height/2;const i=t.x*d+e/2,h=(t.x+t.width)*d+e/2,M=t.y*d+r/2,P=(t.y+t.height)*d+r/2,{rings:u}=y;i<0&&(u[0][0][0]-=i,u[0][3][0]-=i,u[0][4][0]-=i),M<0&&(u[0][0][1]+=M,u[0][1][1]+=M,u[0][4][1]+=M),h>e&&(u[0][1][0]-=h-e,u[0][2][0]-=h-e),P>r&&(u[0][2][1]+=P-r,u[0][3][1]+=P-r)}}const O={type:"cim",data:{type:"CIMSymbolReference",symbol:s}};return this.rasterize(O,e,r,S,_,d,n,1,y)}rasterize(a,o,m,v,l,n,g,c=0,f=null,R=window.devicePixelRatio||1){const{data:p}=a;if(!p||p.type!=="CIMSymbolReference"||!p.symbol)return null;const{symbol:C}=p,s=this._canvas,w=R*$;s.width=o*w,s.height=m*w,g||(g=z(C)),f||(f=D(g,o,m,"legend")),s.width+=2*c,s.height+=2*c;const b=s.getContext("2d",{willReadFrequently:!0}),e=F.createIdentity();return e.translate(-v,-l),e.scale(n*w,-n*w),e.translate(o*w/2+c,m*w/2+c),b.clearRect(0,0,s.width,s.height),new H(b,this._cimResourceManager,e,!0).drawSymbol(C,f),b.getImageData(0,0,s.width,s.height)}}function q(x,a,o,m){return a==="esriGeometryPolygon"?{rings:G(I(x.rings,{xmin:0,ymin:0,width:o,height:m}),-1*o/2,-1*m/2)}:a==="esriGeometryPolyline"?{paths:G(I(x.paths,{xmin:0,ymin:0,width:o,height:m}),-1*o/2,-1*m/2)}:null}function D(x,a,o,m,v){const l=-a/2+1,n=a/2-1,g=o/2-1,c=-o/2+1;if(v&&(x==="esriGeometryPolygon"||x==="esriGeometryPolyline")){const f=q(v,x,a,o);if(f)return f}switch(x){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[l,0],[0,0],[n,0]]]};default:return m==="legend"?{rings:[[[l,g],[n,0],[n,c],[l,c],[l,g]]]}:{rings:[[[l,g],[n,g],[n,c],[l,c],[l,g]]]}}}export{ft as CIMSymbolRasterizer};
