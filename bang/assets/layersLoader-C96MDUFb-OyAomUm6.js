import{l as y,eJ as g,S as H,eK as M,fC as $,bW as P}from"./index-BeTPrQ6f.js";import{c as I,b as G}from"./fetchService-CbI45rct-DlraP8Gs.js";import{g as k,h as x,u as m,p as D,w as R,d as b,m as L,L as C,l as w}from"./loadUtils-DwBPBIZy-BQIH1t1r.js";import{a as v}from"./jsonContext-XeqO0vLP-BykDB3h0.js";import{o as J}from"./portalItemUtils-C12I5owR-Iiaf4oEu.js";import{g as N}from"./styleUtils-BQqoMgIA-U43o5V_5.js";import"./associatedFeatureServiceUtils-CYDBc3zT-CVYBBSKA.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";async function pe(t,n){const a=t.instance.portalItem;if(a!=null&&a.id)return await a.load(n),O(t),t.validateItem&&t.validateItem(a),j(t,n)}function O(t){const n=t.instance.portalItem;if(!(n!=null&&n.type)||!t.supportedTypes.includes(n.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:n==null?void 0:n.type,expectedType:t.supportedTypes.join(", ")})}async function j(t,n){const a=t.instance,e=a.portalItem;if(!e)return;let{url:i}=e;const{title:r}=e,s=v(e,"portal-item");if(a.type==="group")return A(a,s,t);i&&a.type!=="media"&&a.read({url:i},s);const p=new L,{data:c,preferredHost:o}=await S(t,p,n);return i=e.url,"isUrlHostModified"in a&&(o?a.applyPreferredHost({preferredHost:o}):a.applyHostFromPortalItem()),c&&a.read(c,s),a.resourceReferences={portalItem:e,paths:s.readResourcePaths??[]},a.type!=="subtype-group"&&a.read({title:r},s),N(a,s)}async function A(t,n,a){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:i,type:r}=e;if(r==="Group Layer"){if(!J(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return E(t,a)}return t.read({title:i},n),V(t,a)}async function E(t,n){const a=t.portalItem,e=await a.fetchData("json");if(!e)return;if(!n.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const i=v(a,"web-map");t.read(e,i),await n.populateGroupLayer(t,e,{context:i}),t.resourceReferences={portalItem:a,paths:i.readResourcePaths??[]}}async function V(t,n){var u;let a;const{portalItem:e}=t;if(!e)return;const i=e.type,r=n.layerModuleTypeMap;if(!r)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(i){case"Feature Service":case"Feature Collection":a=r.FeatureLayer;break;case"Stream Service":a=r.StreamLayer;break;case"Scene Service":a=r.SceneLayer;break;case"Video Service":a=r.VideoLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${i}' is not supported as a 'GroupLayer'`)}const s=i==="Video Service",p=new L;let[c,{data:o}]=await Promise.all([a(),s?{data:null}:S(n,p)]),l=()=>c;if(s)return q(t,l,r);if(i==="Feature Service"){const f=(u=m(o))==null?void 0:u.customParameters;o=e.url?(await D(o,e.url,p)).data:{},l=await X(o,r)||l;const{provider:T,preferredHost:F}=await Q(e.url,{customParameters:f,loadContext:p});return g(e,F),await d(t,l,l,o,r,T)}return i==="Scene Service"&&e.url&&(o=await R(e,o,p)),b(o)>0?await d(t,l,null,o,r):await K(t,l,r)}async function K(t,n,a){var r,s;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const i=await I(e.url);i&&d(t,n,null,{layers:(r=i.layers)==null?void 0:r.map(w),tables:(s=i.tables)==null?void 0:s.map(w)},a)}async function q(t,n,a){var r;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const i=await I(e.url);i&&d(t,n,null,{layers:(r=i.layers)==null?void 0:r.map(({id:s,name:p})=>({id:s,name:p}))},a)}async function d(t,n,a,e,i,r){var c;let s=e.layers||[];const p=e.tables||[];if(((c=t.portalItem)==null?void 0:c.type)==="Feature Collection"?(s.forEach((o,l)=>{var u;o.id=l,((u=o==null?void 0:o.layerDefinition)==null?void 0:u.type)==="Table"&&p.push(o)}),s=s.filter(o=>{var l;return((l=o==null?void 0:o.layerDefinition)==null?void 0:l.type)!=="Table"})):(s.reverse(),p.reverse()),s.forEach(o=>{const l=r==null?void 0:r(o);if(l||!r){const u=h(t,n(o),e,o,l);t.add(u)}}),p.length){const o=a?null:await i.FeatureLayer();p.forEach(l=>{const u=r==null?void 0:r(l);if(u||!r){const f=h(t,a?a(l):o,e,l,u);t.tables.add(f)}})}}function h(t,n,a,e,i){const r=t.portalItem,s={portalItem:r.clone(),layerId:e.id};e.url!=null&&(s.url=e.url);const p=new n(s);if("sourceJSON"in p&&(p.sourceJSON=i),p.type!=="subtype-group"&&p.type!=="catalog"&&(p.sublayerTitleMode="service-name"),r.type==="Feature Collection"){const c={origin:"portal-item",portal:r.portal||P.getDefault()};p.read(e,c);const o=a.showLegend;o!=null&&p.read({showLegend:o},c)}return p}async function S(t,n,a){if(t.supportsData===!1)return{data:void 0};const e=t.instance,i=e.portalItem;if(!i)return{data:void 0};let r=null;try{r=await i.fetchData("json",a)}catch{}if(z(e)){let s=null;const{count:p,preferredHost:c}=await U(i,r,n);if(g(i,c),((r==null?void 0:r.layers)||(r==null?void 0:r.tables))&&p>0){if(e.layerId==null){const o=k(e.type),l=o!=null&&o.length?x(r,o)[0]:m(r);l&&(e.layerId=l.id)}s=W(r,e),(s==null?void 0:s.layerType)==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),s&&r.showLegend!=null&&(s.showLegend=r.showLegend)}return p>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),{data:s,preferredHost:c}}return{data:r}}async function U(t,n,a){var s,p,c,o,l;if(n!=null&&n.layers&&(n!=null&&n.tables))return{count:b(n)};const e=H(t.url);if(!e)return{count:1};const i=e.url.path,r=await a.fetchServiceMetadata(i,{customParameters:(s=m(n))==null?void 0:s.customParameters}).catch(()=>null);return{count:(((p=n==null?void 0:n.layers)==null?void 0:p.length)??((c=r==null?void 0:r.layers)==null?void 0:c.length)??0)+(((o=n==null?void 0:n.tables)==null?void 0:o.length)??((l=r==null?void 0:r.tables)==null?void 0:l.length)??0),preferredHost:$(t)?M():null}}function W(t,n){var i,r;const{layerId:a}=n,e=((i=t.layers)==null?void 0:i.find(s=>s.id===a))||((r=t.tables)==null?void 0:r.find(s=>s.id===a));return e&&B(e,n)?e:null}function z(t){return t.type!=="stream"&&"layerId"in t}function B(t,n){const a="layerType"in t&&t.layerType,{type:e}=n;return!(e==="feature"&&a&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!a||e==="oriented-imagery"&&!a||e==="subtype-group"&&!a)}async function Q(t,n){const{layersJSON:a,preferredHost:e}=await G(t,n);if(!a)return{provider:null,preferredHost:e};const i=[...a.layers,...a.tables];return{provider:r=>i.find(s=>s.id===r.id),preferredHost:e}}async function X(t,n){const{layers:a,tables:e}=t,i=[...a??[],...e??[]];if(!i.length)return;const r=new Set,s=[];for(const{layerType:o}of i){const l=o??"ArcGISFeatureLayer";if(r.has(l))continue;r.add(l);const u=n[C(l)];s.push(u())}const p=await Promise.all(s),c=new Map;return Array.from(r).forEach((o,l)=>{c.set(o,p[l])}),({layerType:o})=>{const l=o??"ArcGISFeatureLayer";return c.get(l)}}export{pe as load};
