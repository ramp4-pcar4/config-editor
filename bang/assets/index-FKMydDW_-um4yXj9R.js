const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./fabric-qJb76ySv-BCjeV9SH.js","./index-DRDU_nTl.js","./index-6GCfk1Ih.css","./index-xebZcP7d-DO7lSwms.js","./index-CsSDY5Sx-C5DMN-KK.js","./index-rS-M8_8D-BOcgpcdx.js","./index-CF50a9uI-DkLFbt08.js","./index-BgbXdkWP-Cl7F77B5.js","./index-bh29Teha-DSi98mtN.js","./index-B7V4-Kz8-DD850Yd5.js"])))=>i.map(i=>d[i]);
var k=Object.defineProperty;var P=(_,h,e)=>h in _?k(_,h,{enumerable:!0,configurable:!0,writable:!0,value:e}):_[h]=e;var T=(_,h,e)=>P(_,typeof h!="symbol"?h+"":h,e);import{bU as B,_ as v,g6 as j,fx as U,fy as C,h0 as O,bV as H,g2 as I}from"./index-DRDU_nTl.js";import N from"./screen-DGXzQCSk-BO5K-2gu.js";var L={exports:{}},W=L.exports,M;function V(){return M||(M=1,function(_,h){(function(e,i){i()})(W,function(){function e(t,o){return typeof o>"u"?o={autoBom:!1}:typeof o!="object"&&(console.warn("Deprecated: Expected third argument to be a object"),o={autoBom:!o}),o.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(t.type)?new Blob(["\uFEFF",t],{type:t.type}):t}function i(t,o,m){var a=new XMLHttpRequest;a.open("GET",t),a.responseType="blob",a.onload=function(){r(a.response,o,m)},a.onerror=function(){console.error("could not download file")},a.send()}function s(t){var o=new XMLHttpRequest;o.open("HEAD",t,!1);try{o.send()}catch{}return 200<=o.status&&299>=o.status}function u(t){try{t.dispatchEvent(new MouseEvent("click"))}catch{var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),t.dispatchEvent(o)}}var n=typeof window=="object"&&window.window===window?window:typeof self=="object"&&self.self===self?self:typeof H=="object"&&H.global===H?H:void 0,p=n.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),r=n.saveAs||(typeof window!="object"||window!==n?function(){}:"download"in HTMLAnchorElement.prototype&&!p?function(t,o,m){var a=n.URL||n.webkitURL,c=document.createElement("a");o=o||t.name||"download",c.download=o,c.rel="noopener",typeof t=="string"?(c.href=t,c.origin===location.origin?u(c):s(c.href)?i(t,o,m):u(c,c.target="_blank")):(c.href=a.createObjectURL(t),setTimeout(function(){a.revokeObjectURL(c.href)},4e4),setTimeout(function(){u(c)},0))}:"msSaveOrOpenBlob"in navigator?function(t,o,m){if(o=o||t.name||"download",typeof t!="string")navigator.msSaveOrOpenBlob(e(t,m),o);else if(s(t))i(t,o,m);else{var a=document.createElement("a");a.href=t,a.target="_blank",setTimeout(function(){u(a)})}}:function(t,o,m,a){if(a=a||open("","_blank"),a&&(a.document.title=a.document.body.innerText="downloading..."),typeof t=="string")return i(t,o,m);var c=t.type==="application/octet-stream",A=/constructor/i.test(n.HTMLElement)||n.safari,g=/CriOS\/[\d]+/.test(navigator.userAgent);if((g||c&&A||p)&&typeof FileReader<"u"){var l=new FileReader;l.onloadend=function(){var w=l.result;w=g?w:w.replace(/^data:[^;]*;/,"data:attachment/file;"),a?a.location.href=w:location=w,a=null},l.readAsDataURL(t)}else{var b=n.URL||n.webkitURL,x=b.createObjectURL(t);a?a.location=x:location.href=x,a=null,setTimeout(function(){b.revokeObjectURL(x)},4e4)}});n.saveAs=r.saveAs=r,_.exports=r})}(L)),L.exports}var G=V();const z=B(G),$=1200,d={TOP:40,RIGHT:40,BOTTOM:40,LEFT:40};class X extends I{constructor(){super(...arguments);T(this,"fcFabric");T(this,"fcFabricDownload");T(this,"options",{runningHeight:0,scale:1});T(this,"customRendererFunc")}customRenderer(e){this.customRendererFunc=e}get config(){return super.config}_parseConfig(e){var s,u,n,p,r,t;if(!e)return;const i=O(this.$vApp.$pinia);i.componentSelectedState={title:((s=e.title)==null?void 0:s.selected)??!0,map:((u=e.map)==null?void 0:u.selected)??!0,mapElements:((n=e.mapElements)==null?void 0:n.selected)??!0,legend:((p=e.legend)==null?void 0:p.selected)??!0,footnote:((r=e.footnote)==null?void 0:r.selected)??!0,timestamp:((t=e.timestamp)==null?void 0:t.selected)??!0},i.fileName=e.fileName||"",this.handlePanelWidths(["export"]),this.handlePanelTeleports(["export"])}getSubFixture(e){return this.$iApi.fixture.get(e)}async make(e,i){var D;const{fabric:s}=await v(()=>import("./fabric-qJb76ySv-BCjeV9SH.js"),__vite__mapDeps([0,1,2]),import.meta.url).then(E=>E.f);s.Object.prototype.objectCaching=!1;const u=O(this.$vApp.$pinia),n={};this.fcFabric=new s.StaticCanvas(e,{backgroundColor:"#fff"}),this.fcFabricDownload=new s.StaticCanvas(null,{backgroundColor:"#fff"}),this.options.runningHeight=0;const p=u.componentSelectedState,r=this.getSubFixture("export-title"),t=this.getSubFixture("export-map"),o=this.getSubFixture("export-scalebar"),m=this.getSubFixture("export-northarrow"),a=this.getSubFixture("export-legend"),c=this.getSubFixture("export-footnote"),A=this.getSubFixture("export-timestamp");let g,l,b,x,w,f,y;if(p.title&&r&&(g=await r.make({top:this.options.runningHeight,left:0,originX:"left",width:i,textAlign:"center"}),this.options.runningHeight+=g.height+40,n.title=g),p.map&&t&&(l=await t.make({top:this.options.runningHeight}),g&&(g.left=l.width/2,g.originX="center"),this.options.runningHeight+=l.height+40,n.map=l),!l&&g&&(g.width=$),this.options.scale=i/(((l==null?void 0:l.width)??$)+d.LEFT+d.RIGHT),p.mapElements&&o&&(b=await o.make({top:this.options.runningHeight,left:0}),this.options.runningHeight+=b.height+40,n.scaleBar=b,m&&(x=await m.make({top:b.top,left:i/this.options.scale}),x.top+=x.height/2-20,x.left+=-x.width*2,n.northArrow=x)),p.legend&&a&&(w=await a.make({width:((D=a.config)==null?void 0:D.columnWidth)??(l==null?void 0:l.width)??$}),w.top=this.options.runningHeight,this.options.runningHeight+=w.height,n.legend=w),p.timestamp&&A&&(y=await A.make({top:this.options.runningHeight+40,width:i*1.5}),this.options.runningHeight+=!p.footnote||!c?y.height+40:y.height+20,n.timestamp=y),p.footnote&&c&&(f=await c.make({top:this.options.runningHeight-2.5,left:i/this.options.scale+40}),p.timestamp&&A?i-n.timestamp.getMinWidth()<=f.getMinWidth()+30?(f.top+=30,f.left=0,f.originX="left",this.options.runningHeight+=20):f.left+=-f.width*2:(f.top+=20,f.left+=-f.width*2,this.options.runningHeight+=20),this.options.runningHeight+=f.height,n.footnote=f),this.customRendererFunc){this.fcFabric.setWidth(i);const E={panelWidth:i,margin:d,defaultWidth:$,fabric:s};await this.customRendererFunc(this.fcFabric,n,E),this.fcFabric.renderAll(),this.fcFabric.clone(F=>{var R;this.fcFabricDownload=F,this.fcFabricDownload.setDimensions({width:((R=this.fcFabric)==null?void 0:R.getWidth())??i,height:this.fcFabric.getHeight()}),this.fcFabricDownload.renderAll()})}else{const E=new s.Group(Object.values(n),{top:d.TOP*this.options.scale,left:d.LEFT*this.options.scale}),F=await new Promise(R=>{E.clone(S=>{R(S)})});F.top=d.TOP,F.left=d.LEFT,this.fcFabricDownload.add(F),E.scale(this.options.scale),this.fcFabric.add(E),this.fcFabric.setDimensions({width:i,height:(this.options.runningHeight+d.TOP+d.BOTTOM)*this.options.scale}),this.fcFabric.renderAll(),this.fcFabricDownload.setDimensions({width:((l==null?void 0:l.width)??$)+d.LEFT+d.RIGHT,height:this.options.runningHeight+d.TOP+d.BOTTOM}),this.fcFabricDownload.renderAll()}}export(){var s;if(!this.fcFabric)return;const e=new Date,i=((s=this.config)==null?void 0:s.fileName)||`map-carte - ${e.getFullYear()}-${e.getMonth()}-${e.getDay()}, ${e.getHours()}_${e.getMinutes()}`;z.saveAs(this.fcFabricDownload.toDataURL({format:"png",quality:1}),`${i}.png`)}}const q={en:{"export.title":"Export","export.alertName":"Export","export.download":"Download image","export.refresh":"Refresh","export.scaleBar.approx":"{0} approx.","export.menu":"Settings Menu","export.menu.component.title":"Title","export.menu.component.map":"Map","export.menu.component.mapElements":"North arrow and scalebar","export.menu.component.legend":"Legend","export.menu.component.footnote":"Footnote","export.menu.component.timestamp":"Timestamp"},fr:{"export.title":"Exporter","export.alertName":"Exporter","export.download":"Télécharger l'image","export.refresh":"Rafraîchir","export.scaleBar.approx":"Environ {0}","export.menu":"Menu des paramètres","export.menu.component.title":"Titre","export.menu.component.map":"Carte","export.menu.component.mapElements":"Flèche du nord et échelle graphique","export.menu.component.legend":"Légende","export.menu.component.footnote":"Référence","export.menu.component.timestamp":"Horodatage"}};class Q extends X{initialized(){}async needed(){const h=(await v(async()=>{const{default:r}=await import("./index-xebZcP7d-DO7lSwms.js");return{default:r}},__vite__mapDeps([3,0,1,2]),import.meta.url)).default,e=(await v(async()=>{const{default:r}=await import("./index-CsSDY5Sx-C5DMN-KK.js");return{default:r}},__vite__mapDeps([4,0,1,2]),import.meta.url)).default,i=(await v(async()=>{const{default:r}=await import("./index-rS-M8_8D-BOcgpcdx.js");return{default:r}},__vite__mapDeps([5,1,2,0]),import.meta.url)).default,s=(await v(async()=>{const{default:r}=await import("./index-CF50a9uI-DkLFbt08.js");return{default:r}},__vite__mapDeps([6,0,1,2]),import.meta.url)).default,u=(await v(async()=>{const{default:r}=await import("./index-BgbXdkWP-Cl7F77B5.js");return{default:r}},__vite__mapDeps([7,0,1,2]),import.meta.url)).default,n=(await v(async()=>{const{default:r}=await import("./index-bh29Teha-DSi98mtN.js");return{default:r}},__vite__mapDeps([8,0,1,2]),import.meta.url)).default,p=(await v(async()=>{const{default:r}=await import("./index-B7V4-Kz8-DD850Yd5.js");return{default:r}},__vite__mapDeps([9,0,1,2]),import.meta.url)).default;this.$iApi.fixture.add("export-title",h),this.$iApi.fixture.add("export-map",e),this.$iApi.fixture.add("export-legend",i),this.$iApi.fixture.add("export-northarrow",s),this.$iApi.fixture.add("export-scalebar",u),this.$iApi.fixture.add("export-timestamp",n),this.$iApi.fixture.add("export-footnote",p)}added(){this.$iApi.panel.register({id:"export",config:{screens:{"export-screen":j(N)},style:{"flex-grow":"1","max-width":"800px"},button:{tooltip:"export.title",icon:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none" /><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" /></svg>'},alertName:"export.alertName"}},{i18n:{messages:q}});const h=this.$iApi.event.on(U.PANEL_OPENED,async i=>{i.id==="export"&&(this.$iApi.event.off(h),await this.needed(),i.exportMake())});this._parseConfig(this.config);const e=this.$vApp.$watch(()=>this.config,i=>this._parseConfig(i));this.removed=()=>{var i,s,u,n,p,r,t;e(),(i=this.$iApi.fixture.get("export-title"))==null||i.remove(),(s=this.$iApi.fixture.get("export-map"))==null||s.remove(),(u=this.$iApi.fixture.get("export-legend"))==null||u.remove(),(n=this.$iApi.fixture.get("export-northarrow"))==null||n.remove(),(p=this.$iApi.fixture.get("export-scalebar"))==null||p.remove(),(r=this.$iApi.fixture.get("export-timestamp"))==null||r.remove(),(t=this.$iApi.fixture.get("export-footnote"))==null||t.remove(),this.$iApi.fixture.exists("appbar")&&C(this.$vApp.$pinia).removeButton("export"),O(this.$vApp.$pinia).$reset(),this.$iApi.panel.remove("export")}}}export{Q as default};
