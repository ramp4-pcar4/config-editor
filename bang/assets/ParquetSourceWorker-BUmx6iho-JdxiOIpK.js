import{be as T,l as c,a7 as L,P as K,kh as C,kq as b,kg as _,jY as G,m6 as X,jZ as Y,kj as B,ki as W,m7 as ee,ah as te,kf as se}from"./index-BeTPrQ6f.js";import{QueueProcessor as re}from"./QueueProcessor-Bne-Dlbg-BSQ_6P13.js";import{Z as ae,R as x,i as ie}from"./QueryEngine-CHUxUulR-BQNjp4Dj.js";import{d as oe}from"./clientSideDefaults-BTftx6ta-Bkc3-ooB.js";import{m as D}from"./Field-Dn1Bgq7n-CJCGLoNR.js";import{o as ne}from"./FieldsIndex-Ds4D9xP7-BiTuE5Z3.js";import{S as ue,R as le,x as M,l as pe,u as fe}from"./parquetUtils-efARFe0s-tuTN4jBU.js";import{E as j,V as ce}from"./parquet-BKuoy8EM-tvadAp3d.js";import{T as de}from"./FeatureStoreQueryAdapter-Bcw-trC6-Qchy735n.js";import{H as k,i as N,n as me}from"./SourceChunkStore-D5dcR2CA-FyuJhvG5.js";import{t as ye}from"./FeatureMetadata-BbCAi0tA-_ZTatr4-.js";import"./Queue-CK6TduSr-C-T211SM.js";import"./ReactiveMap-cp6PWICM-990o5_5b.js";import"./signal-DHxLvooI-Bin-tnuW.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import"./Cyclical-Bzwh_QaL-CXh-hbnA.js";import"./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js";import"./utils-CRANtbnc-C6zyufvL.js";import"./utils-t279O251-BBk6rV0U.js";import"./featureConversionUtils-CZmIxyv5-DHwRSztU.js";import"./OptimizedFeature-C33SioFK-sn7DeAq-.js";import"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./OptimizedGeometry-BYxlP_oK-DvAqrgO1.js";import"./OptimizedFeatureSet-Dz5hF8Qm-CgsRgxJh.js";import"./WhereClauseCache-DDvjqoWA-BtV0VKFR.js";import"./LRUCache-CvGiiws0-B3io5Jp4.js";import"./MemCache-TG-MhOJy-BkjKRNR7.js";import"./WhereClause-DrmAQ3eI-CwdMrUuP.js";import"./TimeOnly-BFfVS_ja-C4MPGwCM.js";import"./enum-D3e-PyKo-Bl5V5br5.js";import"./UnknownTimeZone-DzO8gKMe-d6rtFXqm.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./timeSupport-BnWHpO95-DqCdiJEC.js";import"./queryUtils-BwthgOFW-CkUF_Za8.js";import"./QueryEngineCapabilities-DPRPXYxY-DJC_YILC.js";import"./quantizationUtils-Ba9rpy9D-8ijlY328.js";import"./utils-DIsJxHAG-BJkEJ610.js";import"./heatmapUtils-Bf2yRyEN-BAQJ1IRB.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./utils-B2aAE6RS-DpuzYE1J.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./utils-DlQW75Bc-7cVT5nQ4.js";import"./ClassBreaksDefinition-rxhnqjju-BkkcQNYY.js";import"./SnappingCandidate-DIiHATRz-CfPvDre4.js";import"./FixedIntervalBinParameters-Bn9Pye3B-_d3f8Yp4.js";import"./NormalizationBinParametersMixin-DuEmpnQx-abBJwXnQ.js";import"./Scheduler-D_tOhFWn-SFGb1GBz.js";import"./debugFlags-vZXEBr68-Bc51Oe-E.js";import"./locationUtils-sOTPEtiz-Bwo0TKFc.js";import"./labelPoint-DTWBMY-Z-DoXEvKTt.js";import"./arcadeUtils-BkvNBhzm-KzAaTYHA.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./definitions-DVO21zOC-BwakNu1s.js";function he(a){switch(a.type){case"wkb":return fe.fromJSON(a);case"location":return pe.fromJSON(a)}}const S=new de,ge=4,F=8e3,z="__OBJECTID";class vt{constructor(){this._fileInfos=new Map,this._queue=new re({concurrency:ge,process:(e,s)=>this._executeQuery(e,s)})}async load(e){var m,d,y,O,v,Q,A,P;const s=e.spatialReference?T.fromJSON(e.spatialReference):void 0;if(s&&!s.isWGS84&&!s.isWebMercator)throw new c("parquet:unsupported-projection","Only WGS84 and Web Mercator are supported");const t=await ue({urls:new L(e.urls),fields:(m=e.fields)==null?void 0:m.map(p=>D.fromJSON(p)),encoding:e.encoding?he(e.encoding):null,geometryType:e.geometryType?le(e.geometryType):null,spatialReference:s},{customParameters:e.customParameters});let r;if(t.geometryType&&t.encoding){if(!t.spatialReference)throw new c("parquet:unsupported","SpatialReference must be defined");if(!t.spatialReference.isGeographic&&!t.spatialReference.isWebMercator)throw new c("parquet:unsupported-projection","Only WGS84 and Web Mercator are supported");t.spatialReference.isGeographic&&!t.spatialReference.isWGS84&&(K.getLogger("parquet:unsupported-projection").warn("Found a geographic projection that is not WGS84. Handling as WGS84.",{spatialReference:t.spatialReference}),t.spatialReference=T.WGS84),r={geometryType:M(t.geometryType),spatialReference:t.spatialReference.toJSON(),encoding:t.encoding.toJSON(),displayOptimization:t.displayOptimization}}this.setCustomParameters(e.customParameters),this._geometryInfo=r;const i=e.urls;for(const p of i){const w=await j(p,{geometryInfo:r,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(p,{index:this._fileInfos.size,file:w})}this._capabilities=V(await this.getFileStatistics());const o=(d=this._fileInfos.values().next().value)==null?void 0:d.file;if(!o)return{layerDefinition:{},capabilities:V(null)};const{fields:n}=t;if(n==null)throw new c("parquet-layer:missing-metadata","Unable to create parquet source: cannot infer fields",n);n.push(new D({name:z,type:"oid",alias:z}));const u={fields:n.map(p=>({...p.toJSON(),column:o.columnForFieldName(p.name)})),timeZoneByFieldName:null},l=ne.fromJSON(u);this._fieldsIndex=l;const f=M(t.geometryType??"point");if(this._metadata=ye.createFeature({fieldsIndex:u,geometryType:f,featureIdInfo:{type:"object-id",fieldName:"rowId"},subtypes:null,subtypeField:null,types:null,typeIdField:null,globalIdField:null,spatialReference:t.spatialReference,outSpatialReference:null,timeInfo:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}),this._queryEngineParams={fieldsIndex:this._metadata.fieldsIndex,geometryType:(r==null?void 0:r.geometryType)??"esriGeometryPoint",featureIdInfo:{type:"object-id",fieldName:"rowId"},hasM:!1,hasZ:!1,spatialReference:(r==null?void 0:r.spatialReference)??{wkid:4326},aggregateAdapter:null,timeInfo:null,definitionExpression:null},t.spatialReference&&(this._fullExtent=we(this._fileInfos.values(),t.spatialReference.toJSON())),this._fullExtent==null&&((y=t.encoding)==null?void 0:y.type)==="location"){const{latitudeFieldName:p,longitudeFieldName:w}=t.encoding,J=(O=this._fieldsIndex.get(p))==null?void 0:O.column,Z=(v=this._fieldsIndex.get(w))==null?void 0:v.column,h=C(_(),b);for(const $ of this._fileInfos.values())for(const R of $.file.rowGroups()){const g={stack:[],error:void 0,hasError:!1};try{const I=G(g,R.columnDescriptorForAttribute(J),!1),E=G(g,R.columnDescriptorForAttribute(Z),!1),H=[E.minValue(),I.minValue(),E.maxValue(),I.maxValue()];X(h,H),R.free()}catch(I){g.error=I,g.hasError=!0}finally{Y(g)}}this._fullExtent={xmin:h[0],ymin:h[1],xmax:h[3],ymax:h[4],spatialReference:(Q=t.spatialReference)==null?void 0:Q.toJSON()}}return{capabilities:this._capabilities,layerDefinition:{fields:(A=t.fields)==null?void 0:A.map(p=>p.toJSON()),drawingInfo:oe(f),extent:this._fullExtent??void 0,geometryType:f,geometryEncoding:(P=t.encoding)==null?void 0:P.toJSON(),displayOptimization:t.displayOptimization}}}destroy(){for(const e of this._fileInfos.values())e.file.free();this._fileInfos.clear(),this._queue.destroy()}setCustomParameters(e){this._customParameters=e}getFileStatistics(){if(!this._fileInfos.size)return null;const e=Array.from(this._fileInfos.values()).reduce((s,t)=>s+t.file.byteLength(),0);return{featureCount:this._getFeatureCount(),byteLength:e}}async updateFiles(e){const s=new Set(e);for(const[t,r]of this._fileInfos.entries())s.has(t)?s.delete(t):(r.file.free(),this._fileInfos.delete(t));for(const t of s){const r=await j(t,{geometryInfo:this._geometryInfo,outSpatialReference:null,getCustomParameters:()=>this._customParameters});this._fileInfos.set(t,{index:this._fileInfos.size,file:r})}}async queryFeatures(e,s){return this._validateQuery(e),Re(e)||(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0),(e.outStatistics||e.returnDistinctValues)&&delete e.returnGeometry,(await this._enqueueQuery(e,s)).createQueryResponse()}async queryFeatureCount(e,s){return this._validateQuery(e),q(e)?(delete e.outFields,delete e.returnGeometry,(await this._enqueueQuery(e,s)).createQueryResponseForCount()):this._getFeatureCount()}async queryObjectIds(e,s){return this._validateQuery(e),q(e)?(e.resultRecordCount=e.resultRecordCount?Math.min(e.resultRecordCount,8e3):8e3,e.resultOffset=e.resultOffset??0,delete e.returnGeometry,delete e.outFields,(await this._enqueueQuery(e,s)).items.map(t=>t.getObjectId())):Array.from({length:this._getFeatureCount()},(t,r)=>r)}async queryExtent(e,s){if(this._validateQuery(e),this._fullExtent&&!q(e))return{count:this._getFeatureCount(),extent:this._fullExtent};const t=B(this._metadata.spatialReference);e.returnGeometry=!0,delete e.outFields;const r=C(_(),b),i=_(),o=await this._enqueueQuery(e,s);let n=0;for(const u of o.items)u.getBounds(i)&&(W(r,i),n+=1);return{count:n,extent:ae(r,t,e.outSR?B(e.outSR):t,t,!1)}}_getFeatureCount(){return Array.from(this._fileInfos.values()).reduce((e,s)=>e+s.file.numRows(),0)}_validateQuery(e){var s;if(!this._capabilities.query.supportsStatistics&&e.outStatistics)throw new c("parquet:unsupported","Statistics queries are not supported",{query:e});if(!this._capabilities.query.supportsOrderBy&&((s=e.orderByFields)!=null&&s.length))throw new c("parquet:unsupported","Queries using orderBy are not supported",{query:e});if(!this._capabilities.query.supportsDistinct&&e.returnDistinctValues)throw new c("parquet:unsupported","Queries using returnDistinctValues are not supported",{query:e})}async*_fetchChunks(e,s){for(const t of this._fileInfos.values()){const r=t.file.numRows(),i=Math.ceil(r/F);for(let o=0;o<i;o++){const n=o*F,u=await t.file.readChunk(n,F,e.fields,e.returnGeometry,s);for(const l of u){const f=new k(this._metadata,this._fieldsIndex,l,0,t.index);yield U([new N(f,null,0,!1)],this._queryEngineParams)}}}}_enqueueQuery(e,s){return this._queue.push(e,s)}async _executeQuery(e,s){var n;const t=await this._getReadParams(e);if((n=e.objectIds)!=null&&n.length)for(const u of this._fileInfos.values()){const l=[],f=U((await u.file.readChunksByRowId(new Uint32Array(e.objectIds),t.fields,t.returnGeometry,s)).map((d,y)=>new k(this._metadata,this._fieldsIndex,d,y,u.index)).map((d,y)=>new N(d,null,y,!1)),this._queryEngineParams),m=await f.executeQueryForOpaqueFeatures(e,s);for(const d of m)l.push(d);return new x(l,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:S})}let r=e.resultRecordCount??this._getFeatureCount(),i=e.resultOffset??0;delete e.resultRecordCount,delete e.resultOffset;const o=[];for await(const u of this._fetchChunks(t,s)){const l=await u.executeQueryForOpaqueFeatures(e,s);if(l.length>i){const f=l.slice(i,Math.min(i+r,l.length));for(const m of f)o.push(m);if(i=0,r-=f.length,r===0)return new x(o,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:S})}else i-=l.length}return new x(o,e,{fieldsIndex:this._fieldsIndex,geometryType:this._metadata.geometryType,spatialReference:this._queryEngineParams.spatialReference,objectIdField:"rowId",hasM:!1,hasZ:!1,featureAdapter:S})}async _getReadParams(e){const s=new Set;if(e.where&&await ee(s,this._fieldsIndex,e.where),e.outStatistics)for(const t of e.outStatistics)t.onStatisticField!=null&&s.add(t.onStatisticField);if(e.outFields)for(const t of e.outFields)s.add(t);return{fields:this._getAttributeIds(Array.from(s)),returnGeometry:!!e.returnGeometry||!!e.geometry}}_getAttributeIds(e){if(e==null)return new Uint32Array;if(e.includes("*"))return new Uint32Array(this._fieldsIndex.fields.map(t=>t.column).filter(t=>t!=null));const s=[];for(const t of e){const r=this._fieldsIndex.get(t);if(r==null)throw new c("unknown-field",`Field ${t} does not exist`);r.column==null||s.push(r.column)}return new Uint32Array(s)}}function q(a){return Object.keys(a).some(e=>_e(e))}function _e(a){switch(a){case"resultOffset":case"resultRecordCount":case"aggregateIds":case"distance":case"gdbVersion":case"geometry":case"having":case"timeExtent":case"where":case"objectIds":case"historicMoment":return!0;default:return!1}}function U(a,e){const s=new me;for(const t of a)s.insert(t);return new ie({...e,featureStore:s})}function Ie(a){switch(a.length){case 4:return se(_(),a);case 6:return a;default:throw new c("parquet:protocol-violation","Invalid Geoparquet file. BoundingBox size must be 4 or 6.",{bbox:a})}}function we(a,e){const s=C(_(),b);for(const t of a){const r=ce(t.file);if(!r)return null;const i=r.columns[r.primary_column];if(!i.bbox)return null;const o=Ie(i.bbox);W(s,o)}return{xmin:s[0],ymin:s[1],xmax:s[3],ymax:s[4],spatialReference:e}}function V(a){const e=a==null?void 0:a.featureCount;let s=!1;return e!=null&&e<te("parquetlayer-full-query-feature-count")&&(s=!0),{analytics:{supportsCacheHint:!1},attachment:null,data:{isVersioned:!1,isBranchVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!0,supportsQueryBins:!1,supportsQueryPivot:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},query:{maxRecordCount:8e3,maxRecordCountFactor:void 0,maxUniqueIDCount:void 0,standardMaxRecordCount:void 0,supportsCacheHint:!1,supportsCentroid:!0,supportsCentroidOnDegeneratedQuantizedGeometry:!1,supportsCurrentUser:!1,supportsDegeneratedQuantizedGeometry:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:s,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:s,supportsPagination:!0,supportsPaginationOnAggregatedQueries:!1,supportsPercentileStatistics:!1,supportsQuantization:!0,supportsQuantizationEditMode:!1,supportsQueryByAnonymous:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsReturnMesh:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsStatistics:s,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsCompactGeometry:!1,supportsSqlExpression:!1,supportsTrueCurve:!1,tileMaxRecordCount:void 0},queryAttributeBins:{supportsDate:!1,supportsFixedInterval:!1,supportsAutoInterval:!1,supportsFixedBoundaries:!1,supportsStackBy:!1,supportsSplitBy:!1,supportsSnapToData:!1,supportsReturnFullIntervalBin:!1,supportsFirstDayOfWeek:!1,supportsNormalization:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUploadWithItemId:!1,supportsUpdateWithoutM:!1,supportsAsyncApplyEdits:!1,zDefault:void 0}}}function Re(a){var e,s;return!!((e=a.objectIds)!=null&&e.length||a.outStatistics||(s=a.orderByFields)!=null&&s.length||a.returnDistinctValues)}export{vt as default};
