import{v as mt}from"./deduplicate-Cqg-F-nU-CWiUqVRS.js";import{h as F,G as J}from"./InterleavedLayout-CuMGnz6O-DkraWivs.js";import{o as T}from"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import{cx as Q,eq as y,ij as wt,gy as vt,aO as ct}from"./index-BeTPrQ6f.js";import{g as At,_ as H,A as tt,z as G,j as xt,l as lt,q as et,Q as ft,W as Nt}from"./vec32-CI1xtKog-DFVYRcgb.js";import{f as K}from"./Normals-BYejxmw4-P-8Se_rY.js";const yt=F().vec3f("position").u16("componentIndex").freeze(),St=F().vec2u8("sideness").freeze(),nt=J(St),ut=F().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),pt=F().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").vec2i16("normal2Compressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),It=J(ut,1),zt=J(pt,1);T([nt,It]),T([nt,zt]);class _t{constructor(){this.position0=y(),this.position1=y(),this.faceNormal0=y(),this.faceNormal1=y(),this.componentIndex=0,this.cosAngle=0}}const j=-1;function Mt(t,n,o){const r=t.vertices.position,a=t.vertices.componentIndex,l=g.position0,d=g.position1,w=g.faceNormal0,A=g.faceNormal1,{edges:i,normals:u}=Ct(t),m=i.length/4,x=n.allocate(m);let $=0;const L=m,S=o==null?void 0:o.allocate(L);let k=0,e=0,s=0;q.length=0;for(let p=0;p<m;++p){const z=4*p;r.getVec(i.data[z],l),r.getVec(i.data[z+1],d);const C=q.pushNew();C.index=4*p,C.length=At(l,d)}q.sort((p,z)=>z.length-p.length);const f=new Array,c=new Array;q.forAll(({length:p,index:z})=>{const C=i.data[z],gt=i.data[z+1],X=i.data[z+2],Y=i.data[z+3],Z=Y===j;if(r.getVec(C,l),r.getVec(gt,d),Z){const N=3*X;H(w,u.data[N],u.data[N+1],u.data[N+2]),tt(A,w),g.componentIndex=a.get(C),g.cosAngle=G(w,A)}else{let N=3*X;if(H(w,u.data[N],u.data[N+1],u.data[N+2]),N=3*Y,H(A,u.data[N],u.data[N+1],u.data[N+2]),g.componentIndex=a.get(C),g.cosAngle=G(w,A),$t(g,Ut))return;g.cosAngle<-.9999&&tt(A,w)}e+=p,s++,Z||Vt(g,Lt)?(n.write(x,$++,g),f.push(p)):Bt(g,dt)&&(S&&o&&o.write(S,k++,g),c.push(p))});const v=new Float32Array(f.reverse()),I=new Float32Array(c.reverse()),_=S&&o?{instancesData:S.slice(0,k),lodInfo:{lengths:I}}:void 0;return{regular:{instancesData:x.slice(0,$),lodInfo:{lengths:v}},silhouette:_,averageEdgeLength:e/s}}function Vt(t,n){return t.cosAngle<n}function $t(t,n){return t.cosAngle>n}function Bt(t,n){const o=wt(t.cosAngle);return Nt(ot,t.position1,t.position0),o*(G(ft(bt,t.faceNormal0,t.faceNormal1),ot)>0?-1:1)>n}function Ct(t){const n=t.faces.length/3,o=t.faces,r=t.neighbors,a=t.vertices.position;h.length=P.length=0;for(let l=0;l<n;l++){const d=3*l,w=r[d],A=r[d+1],i=r[d+2],u=o[d],m=o[d+1],x=o[d+2];a.getVec(u,B),a.getVec(m,E),a.getVec(x,O),et(E,E,B),et(O,O,B),ft(B,E,O),lt(B,B),P.pushArray(B),(w===j||u<m)&&(h.push(u),h.push(m),h.push(l),h.push(w)),(A===j||m<x)&&(h.push(m),h.push(x),h.push(l),h.push(A)),(i===j||x<u)&&(h.push(x),h.push(u),h.push(l),h.push(i))}return{edges:h,normals:P}}class Wt{constructor(){this.index=0,this.length=0}}const q=new Q({allocator:t=>t||new Wt,deallocator:null}),h=new Q({deallocator:null}),P=new Q({deallocator:null}),g=new _t,bt=y(),ot=y(),B=y(),E=y(),O=y(),dt=ct(4),Ut=Math.cos(dt),Ft=ct(35),Lt=Math.cos(Ft);function st(t,n,o){const r=n/3,a=new Uint32Array(o+1),l=new Uint32Array(o+1),d=(e,s)=>{e<s?a[e+1]++:l[s+1]++};for(let e=0;e<r;e++){const s=t[3*e],f=t[3*e+1],c=t[3*e+2];d(s,f),d(f,c),d(c,s)}let w=0,A=0;for(let e=0;e<o;e++){const s=a[e+1],f=l[e+1];a[e+1]=w,l[e+1]=A,w+=s,A+=f}const i=new Uint32Array(6*r),u=a[o],m=(e,s,f)=>{if(e<s){const c=a[e+1]++;i[2*c]=s,i[2*c+1]=f}else{const c=l[s+1]++;i[2*u+2*c]=e,i[2*u+2*c+1]=f}};for(let e=0;e<r;e++){const s=t[3*e],f=t[3*e+1],c=t[3*e+2];m(s,f,e),m(f,c,e),m(c,s,e)}const x=(e,s)=>{const f=2*e,c=s-e;for(let v=1;v<c;v++){const I=i[f+2*v],_=i[f+2*v+1];let p=v-1;for(;p>=0&&i[f+2*p]>I;p--)i[f+2*p+2]=i[f+2*p],i[f+2*p+3]=i[f+2*p+1];i[f+2*p+2]=I,i[f+2*p+3]=_}};for(let e=0;e<o;e++)x(a[e],a[e+1]),x(u+l[e],u+l[e+1]);const $=new Int32Array(3*r),L=(e,s)=>e===t[3*s]?0:e===t[3*s+1]?1:e===t[3*s+2]?2:-1,S=(e,s)=>{const f=L(e,s);$[3*s+f]=-1},k=(e,s,f,c)=>{const v=L(e,s);$[3*s+v]=c;const I=L(f,c);$[3*c+I]=s};for(let e=0;e<o;e++){let s=a[e];const f=a[e+1];let c=l[e];const v=l[e+1];for(;s<f&&c<v;){const I=i[2*s],_=i[2*u+2*c];I===_?(k(e,i[2*s+1],_,i[2*u+2*c+1]),s++,c++):I<_?(S(e,i[2*s+1]),s++):(S(_,i[2*u+2*c+1]),c++)}for(;s<f;)S(e,i[2*s+1]),s++;for(;c<v;)S(i[2*u+2*c],i[2*u+2*c+1]),c++}return $}const R=.7;let ht=class{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?qt:kt}write(t,n,o){D.seed=this._edgeHashFunction(o);const r=D.getIntRange(0,255),a=D.getIntRange(0,this.settings.variants-1),l=D.getFloat(),d=255*(.5*Et(-(1-Math.min(l/R,1))+Math.max(0,l-R)/(1-R),1.2)+.5);t.position0.setVec(n,o.position0),t.position1.setVec(n,o.position1),t.componentIndex.set(n,o.componentIndex),t.variantOffset.set(n,r),t.variantStroke.set(n,a),t.variantExtension.set(n,d)}};const M=new Float32Array(6),V=new Uint32Array(M.buffer),U=new Uint32Array(1);function kt(t){return M[0]=t.position0[0],M[1]=t.position0[1],M[2]=t.position0[2],M[3]=t.position1[0],M[4]=t.position1[1],M[5]=t.position1[2],U[0]=31*(31*(31*(31*(31*(166811+V[0])+V[1])+V[2])+V[3])+V[4])+V[5],U[0]}function qt(t){const n=M;n[0]=W(t.position0[0]),n[1]=W(t.position0[1]),n[2]=W(t.position0[2]),n[3]=W(t.position1[0]),n[4]=W(t.position1[1]),n[5]=W(t.position1[2]),U[0]=5381;for(let o=0;o<V.length;o++)U[0]=31*U[0]+V[o];return U[0]}const rt=1e4;function W(t){return Math.round(t*rt)/rt}function Et(t,n){return Math.abs(t)**n*Math.sign(t)}class Ot{constructor(){this._commonWriter=new ht}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return ut.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r),xt(b,r.faceNormal0,r.faceNormal1),lt(b,b);const{typedBuffer:a,typedBufferStride:l}=n.normalCompressed;K(a,o,b[0],b[1],b[2],l)}}class Dt{constructor(){this._commonWriter=new ht}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return pt.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r);{const{typedBuffer:a,typedBufferStride:l}=n.normalCompressed;K(a,o,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],l)}{const{typedBuffer:a,typedBufferStride:l}=n.normal2Compressed;K(a,o,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],l)}}}const b=y(),D=new vt;function Xt(t){const n=jt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return it.updateSettings(t.writerSettings),at.updateSettings(t.writerSettings),Mt(n,it,at)}function jt(t,n,o,r){if(n){const d=st(o,r,t.count);return new Ht(o,r,d,t)}const a=mt(t.buffer,t.stride/4,{originalIndices:o}),l=st(a.indices,r,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:l,vertices:yt.createView(a.buffer)}}class Ht{constructor(n,o,r,a){this.faces=n,this.facesLength=o,this.neighbors=r,this.vertices=a}}const it=new Ot,at=new Dt,Yt=F().vec3f("position0").vec3f("position1"),Zt=F().vec3f("position0").vec3f("position1").u16("componentIndex");export{Xt as H,Zt as K,yt as i,Yt as j,Mt as l,jt as m};
