import{o as H}from"./signal-DHxLvooI-Bin-tnuW.js";import{e as R,c as E}from"./MapView-CrB-5KSL-IexKdUKM.js";import{o as N,t as D,a as $}from"./config-C6w0VpIP-CfPhyZfw.js";import{K as W}from"./GeometryUtils-C8-DjR3I-DcNL1Jc6.js";import{aZ as j,a_ as Z,a$ as K,lj as X,lL as x}from"./index-BeTPrQ6f.js";import{t as O}from"./constants-t42rMCzy-Dlzs1Z4p.js";import{c as L}from"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./Tile-BNoJIjzH-DZ-xZWMb.js";import{s as Y}from"./TileKey-BZu7Ia24-BiyRHU0x.js";import{y as M}from"./BufferObject-RHe5uojV-C-IINTcZ.js";import{x as I}from"./VertexArrayObject-BAcBN849-N8lUr7x7.js";import{a as S}from"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import{U as G}from"./WGLContainer-CV7lovie-XGZSmlU_.js";import{y as Q,w as ee}from"./definitions-DVO21zOC-BwakNu1s.js";class te{constructor(e,t){this.sourceTile=t,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}}let se=class{constructor(o){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[o],this.id=o.id}};function ie(o,e,t,s){return z(o,e,t.level,t.col,s.key.level,s.key.col)}function oe(o,e,t,s){return z(o,e,t.level,t.row,s.level,s.row)}function z(o,e,t,s,i,r){const n=t-i;if(n>=0)return(e>>n)+(s-(r<<n))*(o>>n);const l=-n;return e-(r-(s<<l))*(o>>l)<<l}let F=class{constructor(o,e,t){this._rows=Math.ceil(e/t),this._columns=Math.ceil(o/t),this._cellSize=t,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let i=0;i<this._columns;i++)this.cells[s][i]=[]}}getCell(o,e){const t=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(o/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][s]||null}getCellSpan(o,e,t,s){return[Math.min(Math.max(Math.floor(o/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function re(o,e,t,s,i,r,n){const l=e[s++];for(let y=0;y<l;y++){const a=new te(r,n);a.xTile=e[s++],a.yTile=e[s++],a.hash=e[s++],a.priority=e[s++],a.featureIndex=e[s++];const c=e[s++],f=a.colliders();for(let d=0;d<c;d++){const _=e[s++],u=e[s++],p=e[s++],g=e[s++],b=!!e[s++],w=e[s++],q=t[s++],P=t[s++],B=e[s++],J=e[s++];f.push({xTile:_,yTile:u,dxPixels:p,dyPixels:g,hard:b,partIndex:w,width:B,height:J,minLod:q,maxLod:P})}const h=o[s++];for(let d=0;d<h;d++)a.textVertexRanges.push([o[s++],o[s++]]);const m=o[s++];for(let d=0;d<m;d++)a.iconVertexRanges.push([o[s++],o[s++]]);i.push(a)}return s}function qe(o,e,t){for(const[s,i]of o.symbols)ne(o,e,t,i,s)}function ne(o,e,t,s,i){const r=o.layerData.get(i);if(r.type===3){for(const n of s){const l=n.uniqueSymbol;let y;if(n.selectedForRendering){const a=l.parts[0],c=a.startOpacity,f=a.targetOpacity;o.allSymbolsFadingOut=o.allSymbolsFadingOut&&f===0;const h=Math.floor(127*c)|f<<7;y=h<<24|h<<16|h<<8|h}else y=0;for(const[a,c]of n.iconVertexRanges)for(let f=a;f<a+c;f+=4)r.iconOpacity[f/4]=y;if(n.selectedForRendering){const a=l.parts[1],c=a.startOpacity,f=a.targetOpacity;o.allSymbolsFadingOut=o.allSymbolsFadingOut&&f===0;const h=Math.floor(127*c)|f<<7;y=h<<24|h<<16|h<<8|h}else y=0;for(const[a,c]of n.textVertexRanges)for(let f=a;f<a+c;f+=4)r.textOpacity[f/4]=y}r.lastOpacityUpdate=e,r.opacityChanged=!0}}function le(o,e,t,s){var a;const i=o.colliders();let r,n,l,y;for(const c of i)if((a=o.uniqueSymbol)!=null&&a.show&&o.uniqueSymbol.parts[c.partIndex].show&&(r=c.xScreen-s[0]+c.dxScreen,n=c.yScreen-s[1]+c.dyScreen,l=r+c.width,y=n+c.height,W(t,e.x,e.y,r,n,l,y)))return!0;return!1}let ae=class{constructor(o,e,t,s,i,r){this._symbols=o,this._styleRepository=s,this._zoom=i,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new F(e,t,$),this._si=Math.sin(Math.PI*r/180),this._co=Math.cos(Math.PI*r/180),s.cachedStyles&&(this._styleProps=s.cachedStyles);for(const n of o)for(const l of n.symbols)this._allNeededMatrices.has(l.tile)||this._allNeededMatrices.set(l.tile,E(l.tile.transforms.tileUnitsToPixels))}work(o){var t,s;const e=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),n=(t=this._styleRepository.layerContexts)==null?void 0:t.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-e>o)return!1;const l=i.symbols[this._currentSymbolCursor];if(!((s=l.uniqueSymbol)!=null&&s.show))continue;const y=this._computeCoordinates(l,r,n),a=l.uniqueSymbol;if(!a.show)continue;const{iconAllowOverlap:c,textAllowOverlap:f}=r;for(const h of y){if(!h.enabled)continue;const m=a.parts[h.partIndex];m.show&&!(h.partIndex?f:c)&&this._doesCollide(h)&&(h.hard?a.show=!1:m.show=!1)}a.show&&this._insertColliders(a.parts,y,r)}}return!0}_insertColliders(o,e,t){const{iconIgnorePlacement:s,textIgnorePlacement:i}=t;for(const r of e){if(!r.enabled||(r.partIndex?i:s)||!o[r.partIndex].show)continue;const n=r.xScreen+r.dxScreen,l=r.yScreen+r.dyScreen,y=n+r.width,a=l+r.height,[c,f,h,m]=this._gridIndex.getCellSpan(n,l,y,a);for(let d=f;d<=m;d++)for(let _=c;_<=h;_++)this._gridIndex.cells[d][_].push(r)}}_computeCoordinates(o,e,t){const{iconRotationAlignment:s,textRotationAlignment:i,iconTranslate:r,iconTranslateAnchor:n,textTranslate:l,textTranslateAnchor:y}=e,a=this._si,c=this._co,f=this._zoom,h=this._allNeededMatrices.get(o.tile),m=o.uniqueSymbol,d=o.colliders(t);let _=0;for(const u of d){const[p,g]=u.partIndex===0?r:l,b=u.partIndex===0?n:y,w=u.minLod<=f&&f<=u.maxLod;_+=w?0:1,u.enabled=w,u.xScreen=u.xTile*h[0]+u.yTile*h[3]+h[6],u.yScreen=u.xTile*h[1]+u.yTile*h[4]+h[7],b===0?(u.xScreen+=c*p-a*g,u.yScreen+=a*p+c*g):(u.xScreen+=p,u.yScreen+=g),(u.partIndex===0?s:i)===1?(u.dxScreen=u.dxPixels,u.dyScreen=u.dyPixels):(u.dxScreen=c*(u.dxPixels+u.width/2)-a*(u.dyPixels+u.height/2)-u.width/2,u.dyScreen=a*(u.dxPixels+u.width/2)+c*(u.dyPixels+u.height/2)-u.height/2)}return d.length>0&&_===d.length&&m&&(m.show=!1),d}_getProperties(o){var s,i;const e=this._styleProps.get(o);if(e)return e;const t=(i=(s=this._styleRepository).getLayerStyleProperties)==null?void 0:i.call(s,o,this._zoom);return this._styleProps.set(o,t),t}_doesCollide(o){const e=o.xScreen+o.dxScreen,t=o.yScreen+o.dyScreen,s=e+o.width,i=t+o.height,[r,n,l,y]=this._gridIndex.getCellSpan(e,t,s,i);for(let a=n;a<=y;a++)for(let c=r;c<=l;c++){const f=this._gridIndex.cells[a][c];for(const h of f){if(h.labelId!=null&&o.labelId!=null&&h.labelId===o.labelId)continue;const m=h.xScreen+h.dxScreen,d=h.yScreen+h.dyScreen,_=m+h.width,u=d+h.height;if(!(s<m||e>_||i<d||t>u))return!0}}return!1}},C=class{constructor(o,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=o;let t=1;const s=new Uint32Array(o);this.layerUIDs=[];const i=s[t++];for(let r=0;r<i;r++)this.layerUIDs[r]=s[t++];this.bufferDataOffset=t,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(o){this._data!=null&&(this.doPrepareForRendering(o,this._data,this.bufferDataOffset),this._data=null)}},he=class extends C{constructor(o,e){super(o,e),this.type=2,this.lineIndexStart=0,this.lineIndexCount=0;const t=new Uint32Array(o);let s=this.bufferDataOffset;this.lineIndexStart=t[s++],this.lineIndexCount=t[s++];const i=t[s++];if(i>0){this.patternMap=new Map;for(let r=0;r<i;r++){const n=t[s++],l=t[s++],y=t[s++];this.patternMap.set(n,[l,y])}}this.bufferDataOffset=s}get usedMemory(){var o,e;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.vao)==null?void 0:e.usedMemory)??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=x(this.vao)}doPrepareForRendering(o,e,t){const s=new Uint32Array(e),i=new Int32Array(s.buffer),r=s[t++],n=this.layer.lineMaterial,l=new S(o,n.geometryLayout,new Int32Array(i.buffer,4*t,r));t+=r;const y=s[t++],a=M.createIndex(o,35044,new Uint32Array(s.buffer,4*t,y));t+=y,this.vao=new I(o,l,a)}},ce=class extends C{constructor(o,e){super(o,e),this.type=1,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const t=new Uint32Array(o);let s=this.bufferDataOffset;this.fillIndexStart=t[s++],this.fillIndexCount=t[s++],this.outlineIndexStart=t[s++],this.outlineIndexCount=t[s++];const i=t[s++];if(i>0){this.patternMap=new Map;for(let r=0;r<i;r++){const n=t[s++],l=t[s++],y=t[s++];this.patternMap.set(n,[l,y])}}this.bufferDataOffset=s}get usedMemory(){var o,e,t;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.fillVAO)==null?void 0:e.usedMemory)??0)+(((t=this.outlineVAO)==null?void 0:t.usedMemory)??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=x(this.fillVAO),this.outlineVAO=x(this.outlineVAO)}doPrepareForRendering(o,e,t){const s=new Uint32Array(e),i=new Int32Array(s.buffer),r=s[t++],n=this.layer,l=n.fillMaterial,y=new S(o,l.geometryLayout,new Int32Array(i.buffer,4*t,r));t+=r;const a=s[t++],c=M.createIndex(o,35044,new Uint32Array(s.buffer,4*t,a));t+=a;const f=s[t++],h=n.outlineMaterial,m=new S(o,h.geometryLayout,new Int32Array(i.buffer,4*t,f));t+=f;const d=s[t++],_=M.createIndex(o,35044,new Uint32Array(s.buffer,4*t,d));t+=d,this.fillVAO=new I(o,y,c),this.outlineVAO=new I(o,m,_)}};class ye extends C{constructor(e,t,s){super(e,t),this.type=3,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(e),r=new Int32Array(e),n=new Float32Array(e);let l=this.bufferDataOffset;this.isIconSDF=!!i[l++];const y=i[l++],a=i[l++],c=i[l++],f=new Y(y,a,c,0),h=i[l++];for(let u=0;u<h;u++){const p=i[l++],g=i[l++],b=i[l++];this.iconPerPageElementsMap.set(p,[g,b])}const m=i[l++];for(let u=0;u<m;u++){const p=i[l++],g=i[l++],b=i[l++];this.glyphPerPageElementsMap.set(p,[g,b])}const d=i[l++],_=i[l++];this.iconOpacity=new Int32Array(d),this.textOpacity=new Int32Array(_),l=re(i,r,n,l,this.symbols,s,f),this.bufferDataOffset=l}get usedMemory(){var e,t,s;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((t=this.iconVAO)==null?void 0:t.usedMemory)??0)+(((s=this.textVAO)==null?void 0:s.usedMemory)??0)+L(this.iconOpacity)+L(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const t of this.iconPerPageElementsMap.values())e+=t[1];for(const t of this.glyphPerPageElementsMap.values())e+=t[1];return e/3}doDestroy(){this.iconVAO=x(this.iconVAO),this.textVAO=x(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,t=this.iconVAO.buffer("opacity");e.length>0&&e.byteLength===t.usedMemory&&t.setSubData(e,0,0,e.length);const s=this.textOpacity,i=this.textVAO.buffer("opacity");s.length>0&&s.byteLength===i.usedMemory&&i.setSubData(s,0,0,s.length)}doPrepareForRendering(e,t,s){const i=new Uint32Array(t),r=new Int32Array(i.buffer),n=i[s++],l=this.layer,y=l.iconMaterial,a=new S(e,y.geometryLayout,new Int32Array(r.buffer,4*s,n));s+=n;const c=i[s++],f=M.createIndex(e,35044,new Uint32Array(i.buffer,4*s,c));s+=c;const h=i[s++],m=l.textMaterial,d=new S(e,m.geometryLayout,new Int32Array(r.buffer,4*s,h));s+=h;const _=i[s++],u=M.createIndex(e,35044,new Uint32Array(i.buffer,4*s,_));s+=_;const p=new S(e,y.opacityLayout,this.iconOpacity.buffer),g=new S(e,m.opacityLayout,this.textOpacity.buffer);this.iconVAO=new I(e,new Map([["geometry",a],["opacity",p]]),f),this.textVAO=new I(e,new Map([["geometry",d],["opacity",g]]),u)}}let ue=class extends C{constructor(o,e){super(o,e),this.type=4,this.circleIndexStart=0,this.circleIndexCount=0;const t=new Uint32Array(o);let s=this.bufferDataOffset;this.circleIndexStart=t[s++],this.circleIndexCount=t[s++],this.bufferDataOffset=s}get usedMemory(){var o,e;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.vao)==null?void 0:e.usedMemory)??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=x(this.vao)}doPrepareForRendering(o,e,t){const s=new Uint32Array(e),i=new Int32Array(s.buffer),r=s[t++],n=this.layer.circleMaterial,l=new S(o,n.geometryLayout,new Int32Array(i.buffer,4*t,r));t+=r;const y=s[t++],a=M.createIndex(o,35044,new Uint32Array(s.buffer,4*t,y));t+=y,this.vao=new I(o,l,a)}},fe=class k extends G{constructor(e,t,s,i,r,n,l,y=null){super(e,t,s,i,r,n,O,O),this.styleRepository=l,this._owner=y,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<D}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<D)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){var s,i;let t=!1;for(const r of e){const n=this.layerData.get(r);n&&(this._usedMemory-=n.usedMemory,n.type===3&&this.symbols.delete(r)&&(t=!0),n.destroy(),this.layerData.delete(r))}(s=this._owner)==null||s.updateTileSize(this),t&&((i=this.featureIndex)==null||i.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const t of e)if(t.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(k._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){var e;--this._referenced===0&&((e=this._owner)==null||e.onDisposeTile(this),this.dispose(),this.stage=null)}retain(){++this._referenced}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){var s,i;(s=this.featureIndex)==null||s.clear();let t=!1;if(e){const{bucketsWithData:r,emptyBuckets:n}=e,l=this._createRenderBuckets(r);if(n&&n.byteLength>0){const y=new Uint32Array(n);for(const a of y)this._deleteLayerData(a)}for(const[y,a]of l)this._deleteLayerData(y),a.type===3&&(this.symbols.set(y,a.symbols),t=!0),this._usedMemory+=a.usedMemory,this.layerData.set(y,a);(i=this._owner)==null||i.updateTileSize(this)}this._hasSymbolBuckets=!1;for(const r of this.layerData.values())r.type===3&&(this._hasSymbolBuckets=!0);t&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(t){t.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const t=this.resolution/(e.resolution*e.pixelRatio),s=this.width/this.rangeX*t,i=this.height/this.rangeY*t,r=[0,0];e.toScreen(r,[this.x,this.y]);const n=this.transforms.tileUnitsToPixels;j(n),Z(n,n,r),K(n,n,Math.PI*e.rotation/180),X(n,n,[s,i,1])}_createTransforms(){return{displayViewScreenMat3:R(),tileMat3:R(),tileUnitsToPixels:R()}}static _destroyRenderBuckets(e){if(!e)return;const t=new Set;for(const s of e.values())t.has(s)||(s.destroy(),t.add(s));e.clear()}_createRenderBuckets(e){const t=new Map,s=new Map;for(const i of e){const r=this._deserializeBucket(i,s);for(const n of r.layerUIDs)t.set(n,r)}return t}_deserializeBucket(e,t){let s=t.get(e);if(s)return s;switch(new Uint32Array(e)[0]){case 1:s=new ce(e,this.styleRepository);break;case 2:s=new he(e,this.styleRepository);break;case 3:s=new ye(e,this.styleRepository,this);break;case 4:s=new ue(e,this.styleRepository)}return t.set(e,s),s}_deleteLayerData(e){if(!this.layerData.has(e))return;const t=this.layerData.get(e);this._usedMemory-=t.usedMemory,t.destroy(),this.layerData.delete(e)}};function v(o){var e,t;return(((e=o.uniqueSymbol)==null?void 0:e.show)&&((t=o.uniqueSymbol)==null?void 0:t.lastShow))??!1}function de(o,e){if(o.priority-e.priority)return o.priority-e.priority;if(v(o)&&!v(e))return-1;if(v(e)&&!v(o))return 1;const t=o.tile.key,s=e.tile.key;return t.world-s.world?t.world-s.world:t.level-s.level?t.level-s.level:t.row-s.row?t.row-s.row:t.col-s.col?t.col-s.col:o.xTile-e.xTile?o.xTile-e.xTile:o.yTile-e.yTile}let me=class{get running(){return this._running}constructor(o,e,t,s,i,r,n,l){this.selectionMode=o,this._visibleTiles=e,this._symbolRepository=t,this._styleRepository=s,this._createCollisionJob=i,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=n,this._isLayerVisible=l,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(o,e){this._screenWidth===o&&this._screenHeight===e||this.restart(),this._screenWidth=o,this._screenHeight=e}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(o){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const e=performance.now();if(!this._selectionJob.work(o)||(this._selectionJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const e=performance.now();if(!this._collisionJob.work(o)||(this._collisionJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const e=performance.now();if(!this._opacityJob.work(o)||(this._opacityJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(o,e,t){const s=e.getFilterFlags(o),i=s&ee,r=t.featureEffect==null||t.featureEffect.excludedLabelsVisible||s&Q;return!(i&&r)}_getFilteredByLayer(){var e,t;let o;if((e=this._styleRepository)!=null&&e.layerContexts)for(const s of this._symbolRepository.uniqueSymbols){const i=(t=this._styleRepository.layerContexts)==null?void 0:t.get(s.styleLayerUID);if(i!=null&&i.attributeView)for(const r of s.uniqueSymbols){o??(o=new Map),o.get(s.styleLayerUID)||o.set(s.styleLayerUID,new Set);const n=o.get(s.styleLayerUID),l=i.attributeView,y=i.layerView;this._isFeatureFiltered(r.id,l,y)&&n.add(r.id)}}return o}_resetSelection(){for(let o=0;o<this._symbolRepository.uniqueSymbols.length;o++){const e=this._symbolRepository.uniqueSymbols[o];for(let t=0;t<e.uniqueSymbols.length;t++){const s=e.uniqueSymbols[t];for(const i of s.tileSymbols)i.selectedForRendering=!1}}}_createSelectionJob(){var c;const o=this.selectionMode==="feature-tile"?pe:be,e=this._symbolRepository.uniqueSymbols;this._resetSelection();const t=[];let s=0,i=0;const r=this._isLayerVisible,n=this._getFilteredByLayer(),l=(c=this._styleRepository)==null?void 0:c.layerContexts;function y(f){let h;const m=performance.now();for(;i<e.length;i++,s=0){const d=e[i],_=d.styleLayerUID,u=n==null?void 0:n.get(_);let p=0;if(l){const b=l.get(_).layerView;p=b.view.allLayerViews.items.indexOf(b)}if(!r(_)){t[i]||(t[i]={styleLayerUID:_,layerOrder:p,symbols:[]});continue}t[i]||(t[i]={styleLayerUID:_,symbols:[],layerOrder:p});const g=t[i];for(;s<d.uniqueSymbols.length;s++){if(h=d.uniqueSymbols[s],s%100==99&&performance.now()-m>f)return!1;if(h.lastShow=h.show,h.id&&(u==null?void 0:u.has(h.id))){h.show=!1,h.parts[0].show=!1,h.parts[1].show=!1;continue}const b=o(h);if(b){b.selectedForRendering=!0,g.symbols.push(b),h.show=!0;for(const w of h.parts)w.show=!0}else h.show=!1}}for(const d of t)d.symbols.sort(de);return t.sort((d,_)=>_.layerOrder-d.layerOrder),!0}const a=this._symbolLayerSorter;return{work:y,get sortedSymbols(){return t.sort(a)}}}_createOpacityJob(){const o=this._assignTileSymbolsOpacity,e=this._visibleTiles;let t=0;function s(i,r){for(const n of i.symbols.values())_e(n,r);o(i,r);for(const n of i.childrenTiles)s(n,r)}return{work(i){const r=performance.now();for(;t<e.length;t++){if(performance.now()-r>i)return!1;const n=e[t];if(n.parentTile!=null)continue;const l=performance.now();n instanceof fe?s(n,l):o(n,l)}return!0}}}};function _e(o,e){for(const t of o){const s=t.uniqueSymbol;for(const i of s.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((e-i.startTime)/D),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=e,i.targetOpacity=s.show&&i.show?1:0}}}function pe(o){let e=null,t=null,s=null;for(const i of o.tileSymbols){const r=i.tile;r.isReady&&r.isCoverage?e=i:r.isReady?t=i:r.rendering&&(s=i)}return e??t??s}function be(o){let e=null,t=!1,s=!1;for(const i of o.tileSymbols)if(!s||!t){const r=i.tile;(!e||r.isCoverage||r.neededForCoverage&&!t)&&(e=i,(r.neededForCoverage||r.isCoverage)&&(s=!0),r.isCoverage&&(t=!0))}return s?e:null}class T{static fromSymbols(e,t){let s=e.length;if(s>=ge){let i=t;do i/=2,s/=4;while(s>Se&&i>we);const r=new F(t,t,i);for(const n of e)r.getCell(n.xTile,n.yTile).push(n);return new T(t,e,r)}return new T(t,e,null)}constructor(e,t,s){this.tileCoordRange=e,this._symbols=t,this._index=s}addSymbols(e){for(const t of e)this._symbols.push(t);if(this._index)for(const t of e)this._index.getCell(t.xTile,t.yTile).push(t)}removeSymbols(e){const t=new Set(e);if(this._symbols=this._symbols.filter(s=>!t.has(s)),this._index)for(const s of this._index.cells)for(let i=0;i<s.length;i++)s[i]=s[i].filter(r=>!t.has(r))}getSymbols(){return this._symbols}getCandidate(e,t,s,i){if(!this._index){for(const c of this._symbols)if(s===c.hash&&Math.abs(e-c.xTile)<=i&&Math.abs(t-c.yTile)<=i)return c;return null}const r=this._index.getCellSpan(e-i,t-i,e+i,t+i),[n,l,y,a]=r;for(let c=l;c<=a;c++)for(let f=n;f<=y;f++){const h=this._index.cells[c][f];for(const m of h)if(s===m.hash&&Math.abs(e-m.xTile)<=i&&Math.abs(t-m.yTile)<=i)return m}return null}}const ge=32,Se=8,we=64,A=20;class xe{constructor(e,t){this.tileCoordRange=e,this._visibleTiles=t,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,t){const s=this._ensureIndexMap(e),i=(t==null?void 0:t.values())??s.keys();for(const r of i){const n=s.get(r);n&&(this._removeSymbols(r,n.getSymbols()),s.delete(r))}this._addSymbols(e.key,s,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,t){const s=this._indexMapByTile.get(e);if(!s)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,s,U(t)),this._invalidate()}removeFeatureTileMetrics(e,t){const s=this._indexMapByTile.get(e);if(!s)return;const i=U(t);for(const[r,n]of s.entries()){const l=i.get(r);l&&(n.removeSymbols(l),this._removeSymbols(r,l))}this._invalidate()}deleteStyleLayers(e){for(const t of this._indexMapByTile.values())for(const s of e){const i=t.get(s);i&&(this._removeSymbols(s,i.getSymbols()),t.delete(s))}this._invalidate()}querySymbols(e,t,s,i){const r=[];for(const[n,l]of this._uniqueSymbolsByStyleLayerId.entries())for(const y of l){const a=y.tileSymbols.find(c=>c.selectedForRendering);a&&le(a,e,t*(window.devicePixelRatio||1),s)&&r.push({vtlSymbol:a,styleLayerUID:n,tileKey:a.tile.key})}return r}_ensureIndexMap(e){let t=this._indexMapByTile.get(e);return t||(t=new Map,this._indexMapByTile.set(e,t)),t}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,t,s){for(const[i,r]of s){let n=t.get(i);n?n.addSymbols(r):(n=T.fromSymbols(r,this.tileCoordRange),t.set(i,n))}this._updateUniqueSymbols(e,s)}_removeTile(e){const t=this._indexMapByTile.get(e);if(t){for(const[s,i]of t.entries())this._removeSymbols(s,i.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,t){for(const s of t){const i=s.uniqueSymbol;if(i){if(i.tileSymbols=i.tileSymbols.filter(r=>r!==s),i.tileSymbols.length===0){const r=this._uniqueSymbolsByStyleLayerId.get(e);r.delete(i),r.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}s.uniqueSymbol=null}}}_updateUniqueSymbols(e,t){if(t.size!==0){for(const s of this._visibleTiles)s.parentTile||s.key.world!==e.world||s.key.level===e.level&&!s.key.equals(e)||this._matchSymbols(s,e,t);for(const[s,i]of t)for(const r of i)if(!r.uniqueSymbol){r.uniqueSymbol=new se(r);let n=this._uniqueSymbolsByStyleLayerId.get(s);n||(n=new Set,this._uniqueSymbolsByStyleLayerId.set(s,n)),n.add(r.uniqueSymbol)}}}_matchSymbols(e,t,s){if(e.key.level>t.level){const r=e.key.level-t.level;if(e.key.row>>r!==t.row||e.key.col>>r!==t.col)return}if(t.level>e.key.level){const r=t.level-e.key.level;if(t.row>>r!==e.key.row||t.col>>r!==e.key.col)return}const i=new Map;for(const[r,n]of s){const l=[],y=e.key.level<t.level?1:1<<Math.abs(e.key.level-t.level),a=this._indexMapByTile.get(e),c=a==null?void 0:a.get(r);if(c)for(const f of n){if(f.uniqueSymbol)continue;const h=ie(this.tileCoordRange,f.xTile,t,e.key),m=oe(this.tileCoordRange,f.yTile,t,e.key),d=-A,_=this.tileCoordRange+A;if(!(h>=d&&h<_&&m>=d&&m<_)){l.push(f);continue}const u=c.getCandidate(h,m,f.hash,y),p=u==null?void 0:u.uniqueSymbol;p?(f.uniqueSymbol=p,p.tileSymbols.push(f)):l.push(f)}l.length>0&&i.set(r,l)}for(const r of e.childrenTiles||[])this._matchSymbols(r,t,i)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,t=new Array(e.size);let s,i=0;for(const[r,n]of e){const l=new Array(n.size);s=0;for(const y of n)l[s++]=y;t[i]={styleLayerUID:r,uniqueSymbols:l},i++}return t}}function U(o){const e=new Map;for(const t of o){const s=t.labelClassId;let i=e.get(s);i||(i=[],e.set(s,i)),i.push(t)}return e}const Me=.5,V=1e-6;class Pe{constructor(e,t,s,i,r,n=N){this.styleRepository=t,this._declutterBudget=n,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=H(!1);const l=(c,f,h)=>this._createCollisionJob(c,f,h),y=c=>{var m,d,_,u;const f=(d=(m=this.styleRepository).getStyleLayerByUID)==null?void 0:d.call(m,c);if(f){if(this._zoom+V<f.minzoom||this._zoom-V>=f.maxzoom)return!1;const p=(_=f.getLayoutProperty)==null?void 0:_.call(f,"visibility");if(p&&p.getValue()===1)return!1}const h=(u=this.styleRepository.layerContexts)==null?void 0:u.get(c);return!(h&&!h.layerView.layer.visible)},a=(c,f)=>{var h,m,d,_,u,p;return(((d=(m=(h=this.styleRepository).getStyleLayerByUID)==null?void 0:m.call(h,c.styleLayerUID))==null?void 0:d.z)??0)-(((p=(u=(_=this.styleRepository).getStyleLayerByUID)==null?void 0:u.call(_,f.styleLayerUID))==null?void 0:p.z)??0)};this._symbolRepository=new xe(r,i),this._symbolDeclutterer=new me(e,i,this._symbolRepository,this.styleRepository,l,s,a,y)}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,t,s){return this.updateDecluttererViewState(),new ae(e,t,s,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}registerFeatureTile(e){this.symbolRepository?(this.symbolRepository.registerFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}unregisterFeatureTile(e){this.symbolRepository?(this._symbolRepository.unregisterFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}insertFeatureTileMetrics(e,t){this.symbolRepository?(this.symbolRepository.insertFeatureTileMetrics(e,t),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}removeFeatureTileMetrics(e,t){this.symbolRepository?(this.symbolRepository.removeFeatureTileMetrics(e,t),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.registerVectorTile(e),this.restartDeclutter()})),this._symbolRepository.registerVectorTile(e),this.restartDeclutter()}removeTile(e){const t=this._tileToHandle.get(e);t&&(this._symbolRepository.unregisterVectorTile(e),this.restartDeclutter(),t.remove(),this._tileToHandle.delete(e))}update(e,t){this._zoom=e,this._viewState={scale:t.scale,rotation:t.rotation,center:[t.center[0],t.center[1]],size:[t.size[0],t.size[1]]};const s=[0,0];t.toScreen(s,t.center);const i=[0,0];return t.toScreen(i,this._declutterViewState.center),this._offsetFromScreenCenter[0]=s[0]-i[0],this._offsetFromScreenCenter[1]=s[1]-i[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(this._declutterBudget),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){this._stableNotificationHandle!=null&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},(1+Me)*D)}_notifyUnstable(){this._stableNotificationHandle!=null&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}export{qe as l,Pe as v,fe as z};
