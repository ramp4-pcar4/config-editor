const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js","./index-BeTPrQ6f.js","./index-BlWAJbpo.css","./colorUtils-DlmOacVt-BnN0T6wa.js","./vec42-DHp-FUwt-Br7hmYJs.js","./vec4f64-DD-nkcCV-CSNWKRqG.js","./vec32-CI1xtKog-DFVYRcgb.js","./elevationInfoUtils-DFX5QvG8-DWLx2t7K.js","./ElevationInfo-tlrAM5SV-D86C1F9d.js","./lengthUtils-CopeXEyE-DjCEitlq.js","./SketchViewModel-BCVIeloG-Cwmt4M0t.js","./UpdatingHandles-XotKWqvb-CyHJIoZx.js","./projectionUtils-CsX1UTBu-DsZaU4xz.js","./projectBuffer-CMNsPBq1-CMpE7Jo3.js","./zscale-PLuFqpaL-BIEnWBsg.js","./GraphicsLayer-DPoztXf7-DWF8RDJT.js","./GraphicsCollection-CT-y6p3H-4XYPvC_j.js","./BlendLayer-D8oJmNCO-A0sTzbOF.js","./layerContainerType-CJrPp4UB-BIF7XAYP.js","./jsonUtils-Bl9MVnOR-Be8hf0yA.js","./parser-CXoJuqeV-C7irlk5U.js","./mat4f32-BdRMyjXW-CWt6U0BP.js","./mat4-R0VY9B_E-DoEP887i.js","./ScaleRangeLayer-DkZwCH6_-C95kTMqN.js","./editableLayers-BTZOOiKD-ByJ-Oydo.js","./utils-DqlCEhl6-DBO0-7VG.js","./Queue-CK6TduSr-C-T211SM.js","./signal-DHxLvooI-Bin-tnuW.js","./Version-DSJSGSLA-Cg87msWM.js","./asyncUtils-Cu__bxqs-ecCTUaGV.js","./projectVectorToVector-OCoJKalB-CQIDHzSm.js","./projectPointToVector-BHS0gJJf-DOVZH8Fn.js","./Query-DKLDaFaA-I4zhlfzt.js","./Field-Dn1Bgq7n-CJCGLoNR.js","./fieldType-DvW5hpfa-DYUbIy_X.js","./vec2f64-CkowXrDb-3zFQ3LNH.js","./geodesicUtils-DHDMXkUY-CP5HeHA5.js","./plane-wUwHaY3K-ZwGBF7HQ.js","./vectorStacks-B2ngxq6F-myhPBoPk.js","./quatf64-C16JxGFv-BKWK1F8U.js","./sphere-CIGsF4vz-C3zVQu9y.js","./quantityUtils-v7kjLywD-Cq6IoGLM.js","./geodeticLengthOperator-CMi-Z1ZN-WUImro4E.js","./geodeticCurveType-D_etKnbP-CirnHLSB.js","./earcut-C6NeZYSh-P2HUZ781.js","./triangle-DA_o7I-u-CHbj6sRJ.js","./lineSegment-D8lwRkdT-CnWWOaLb.js","./spatialReferenceEllipsoidUtils-Ty3j4VoE-BUAsRqCF.js","./intl-DRhjUnwt-Dihhq8dq.js","./messages-DQ10DjvF-6kk0dzjG.js","./SketchTooltipInfo-EowXqHHv-Yp97uw3T.js","./MeshTransform-DfLVYScT-Cq2gdNT7.js","./quat-B6H0knG8-DtO1-hlf.js","./axisAngleDegrees-StGk9lM5-YzC5iFyo.js","./meshVertexSpaceUtils-EbHpWZGf-CmRuaT8m.js","./MeshLocalVertexSpace-CxmyTFZH-DhgfYuby.js","./modeUtils-V6BDu_YT-Dq8o_RJK.js","./jsxFactory-DN-m49_5-CUFCpKPo.js","./uuid-CFz2qBzH-cIdlpVG-.js","./sanitizerUtils-CrdmaILo-DztC6Qnx.js","./a11yUtils-tU3tY6-a-CmHbThdR.js","./unitFormatUtils-BbVpiips-i7yyYN--.js","./Cyclical-Bzwh_QaL-CXh-hbnA.js","./getDefaultUnitForView-CEAuCsu_-B1vEtX96.js","./angularMeasurementUtils-CVK8K4WU-C6RO-Ta3.js","./index-C3e3iuYi-s8xSrC2z.js","./draw-store-DwCnUTPl-Dp2Sl1TU.js","./layerViewUtils-BBTk5dU--BemaIlLi.js","./drapedUtils-D9z307XM-CQXlJXY2.js","./utils-C0LvbFCo-RMQaTNpt.js","./widget-Yo6nzRYu-BBI8jxq5.js","./substitute-Cl1SJAIb-D0XLv0xK.js","./TextOverlayItem-5NFsakI7-CpLCqR0o.js","./frustum-D1Y7pP8E-DUyP3Dvr.js","./RibbonLine.glsl-wB3eQn3n-0F1lPIwt.js","./orientedBoundingBox-DAJ-bKlA-DbqXagWB.js","./computeTranslationToOriginAndRotation-CsOb5S2S-CE5ZgVBy.js","./OutputColorHighlightOID.glsl-fUhBGshN-Ctm9N97M.js","./enums-DDJfd4_p-D3z9tmVA.js","./Texture-DLw7oaIg-fTsxdRzn.js","./Indices-CAn-HCVv-hWNN5onC.js","./BufferView-B6RYETl3-CMoUTBv6.js","./renderState-CsafAKLy-B8R8ns_l.js","./glsl-CfY1Aoj6-DPHSeNd9.js","./normalizeUtils-DK5542Ty-DtqBcgc2.js","./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js","./utils-CRANtbnc-C6zyufvL.js","./utils-t279O251-BBk6rV0U.js","./VertexAttributeLocations-DBgVVQz--D3wovAvC.js","./VertexElementDescriptor-DLvjNrmQ-Cuvx5w94.js","./Octree-CuXix3EP-CfBHKjXe.js","./InterleavedLayout-CuMGnz6O-DkraWivs.js","./types-l27bT09Q-DE0QfIFp.js","./HUDMaterial.glsl-CxXm6elT-D8B376d1.js","./hydratedFeatures-82j52esm-6EbRngQ4.js","./vec3f32-GX_cKsFD-UJPpzdNc.js","./ShaderBuilder-ufvKEDd5-DMnPqr6U.js","./VertexBuffer-7GCTDD7e-CbRHEILO.js","./BufferObject-RHe5uojV-C-IINTcZ.js","./sdfPrimitives-KBv8JuXI-GIoUdHpt.js","./Texture-Daa63Q6u-Bl4xeC_t.js","./videoUtils-ZWM8l9ln-fGQ142sg.js","./requestImageUtils-CrIBaPUj-khjAqpU7.js","./TooltipInfoWithCoordinates-Ddvg_E_1-DHPxpvzo.js","./PointSnappingHint-NgOvzAAk-CFqn5eSp.js","./SelectedVertexTooltipInfo-CJDbmWdK-C9zXxAOj.js","./editPlaneUtils-DVPHOAL2-C25USCi0.js","./drawSurfaces--K8ToToC-FllffqSc.js","./ReactiveSet-DP8oFB7N-DSfeDz8k.js","./diffUtils-D3O4EfgX-CznKxD4n.js","./SnappingContext-pR4ApgxC--JaBRde9.js","./rotate-ClH9iv5s-CoX5oM8l.js","./curveOperationUtils-ClbIvhut-17Ywjz26.js","./Scheduler-D_tOhFWn-SFGb1GBz.js","./debugFlags-vZXEBr68-Bc51Oe-E.js","./createUtils-QoBeynM5-wXx8RLRA.js","./distanceOperator-C3n_j88h-CjjOO0Zj.js","./Point2D-BVUQyGsf-qih0ZuJV.js","./Distance2DCalculator-CXhBP-8I-CW7HDKXX-kSux2duE.js","./ProjectionTransformation-BXUROh_s-kKBZ5FDB.js","./Envelope2D-2iYexKQo-BCKocNS7.js","./Transformation2D-CZCvoz9N-B-IhcWnl.js","./SimpleGeometryCursor-DSF_YyIm-TAMgMsbK.js","./OperatorDefinitions-DJdq_wrt-DP7_WWTp.js","./apiConverter-Djde5pBD-Dr3vspB4.js","./jsonConverter-CiKBkr5U-C590VlCu.js","./simplifyOperator-CK8t6p1S-COLMjdqn.js","./operatorSimplify-BRKLCaj2-DisWK8Yh.js","./mat2d-Cf4xHr3Z-u09Kv-lR.js","./mat2df64-VxtldH1S-CqyKAV7h.js","./boundedPlane-CehKkKe3-4WekUEh5.js","./TranslateTooltipInfo-DAX-YrWE-Bq4gCa04.js","./utils-DvP1Tc7W-CK5sH9q2.js","./cimSymbolUtils-BJ01Nooc-BfOR3Irv.js","./utils-CIm5uQvO-CtKf129F.js","./defaultCIMValues-BWu-APou-XI-Li77m.js","./LRUCache-CvGiiws0-B3io5Jp4.js","./MemCache-TG-MhOJy-BkjKRNR7.js","./ExtentScaleTooltipInfo-HFWOYSN4-B-CajZu0.js","./GraphicManipulator-CkOY4Z_k-BgpI7zKu.js","./triangulationUtils-BIEW4TIq-CnOT_xJp.js","./deduplicate-Cqg-F-nU-CWiUqVRS.js","./VertexArrayObject-BAcBN849-N8lUr7x7.js","./memoryEstimations-C_GUL8g_-JniNFd5l.js","./NestedMap-BCg8I1M1-D2deq-hj.js"])))=>i.map(i=>d[i]);
import{i4 as Qt,a2 as I,is as V,hN as vr,lH as Xt,nB as mt,i1 as xr,ob as yr,_ as G,aj as br,m as u,E as v,n as A,bO as ve,kB as ne,as as se,aH as et,X as me,lL as lt,Y as xe,cx as wr,ak as Cr,bc as Tr,at as vt,lR as Sr,bF as de,k3 as Or,fa as Te,oc as xt,ai as Pr,ah as Rr,am as Yt,eq as ye,b4 as Fr,P as Dr,aM as qe,od as yt,n1 as Mr,ij as Vr,em as Ne,d8 as Ir,a5 as H,a3 as ie,ig as ge,fc as bt,ab as ae,ae as w,ap as qr,ac as wt,aq as zr,ir as Lr}from"./index-BeTPrQ6f.js";import{o as f}from"./vec2f64-CkowXrDb-3zFQ3LNH.js";import{m as Er,I as Ar,o as ut}from"./vec4f64-DD-nkcCV-CSNWKRqG.js";import{o as Wr,g as Hr}from"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import{o as $r,af as jr,ah as Nr,u as Br,q as Gr,al as Ur,am as kr,A as Qr,g as Xr,l as Yr,F as ze,ar as Zt,aA as Ee,R as Kt,bb as Jt,ao as ct,ad as be,an as Zr,aq as Kr,B as er,aN as Be,a_ as Ct,b0 as Jr,a2 as es,U as tr,D as ts,a5 as rs,L as ss,z as is,a3 as as,bc as ns,b1 as os,j as hs,aS as ls,e as rr,K as us,f as U,h as k,a6 as cs,a8 as ds,a9 as gs,aa as ps,ab as _s,a7 as fs,ac as ms,V as vs,P as xs,Z as P,aI as ys,aJ as Ge,bd as Ae,aM as We,aU as bs,be as ws,w as Ue,aK as dt,bf as ke}from"./OutputColorHighlightOID.glsl-fUhBGshN-Ctm9N97M.js";import{s as Cs}from"./Indices-CAn-HCVv-hWNN5onC.js";import{g as M}from"./orientedBoundingBox-DAJ-bKlA-DbqXagWB.js";import{Y as Ts,k as tt,f as Ss,U as Os,N as Tt,Z as Ps,b as Rs,$ as St}from"./mat4-R0VY9B_E-DoEP887i.js";import{K as Fs,A as Ds,t as Ms}from"./sphere-CIGsF4vz-C3zVQu9y.js";import{D as Vs}from"./plane-wUwHaY3K-ZwGBF7HQ.js";import{h as he}from"./InterleavedLayout-CuMGnz6O-DkraWivs.js";import{_ as sr,R as Is,A as E,N as qs,X as zs,v as Ls,b as Es,l as As,E as Ws,q as Hs}from"./vec32-CI1xtKog-DFVYRcgb.js";import{y as Ot,D as $s,p as js}from"./vec42-DHp-FUwt-Br7hmYJs.js";import"./lengthUtils-CopeXEyE-DjCEitlq.js";import{o as q}from"./glsl-CfY1Aoj6-DPHSeNd9.js";import{T as Q}from"./ShaderBuilder-ufvKEDd5-DMnPqr6U.js";import{N,O as B,y as Ns,w as ir}from"./renderState-CsafAKLy-B8R8ns_l.js";import{B as ar}from"./triangulationUtils-BIEW4TIq-CnOT_xJp.js";import{G as Bs,$ as Gs,q as Us}from"./RibbonLine.glsl-wB3eQn3n-0F1lPIwt.js";import{c as gt}from"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import{p as ks}from"./utils-DqlCEhl6-DBO0-7VG.js";import{x as Qs}from"./VertexArrayObject-BAcBN849-N8lUr7x7.js";import{y as Xs}from"./BufferObject-RHe5uojV-C-IINTcZ.js";import{E as Ys,_ as Zs,F as Se}from"./enums-DDJfd4_p-D3z9tmVA.js";import{$ as nr,w as pt}from"./Texture-DLw7oaIg-fTsxdRzn.js";import{a as Ks}from"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import{s as Js}from"./NestedMap-BCg8I1M1-D2deq-hj.js";import{d as oe,i as ei,l as Y,n as Oe}from"./BufferView-B6RYETl3-CMoUTBv6.js";import{o as Qe}from"./signal-DHxLvooI-Bin-tnuW.js";import{o as ti,C as Pt,F as Rt}from"./axisAngleDegrees-StGk9lM5-YzC5iFyo.js";import{E as ri}from"./Texture-Daa63Q6u-Bl4xeC_t.js";import{r as si,_ as ii}from"./Scheduler-D_tOhFWn-SFGb1GBz.js";function en(e,t,r=null){const s=[],i=t.mapPositions,a=ai(t,s),n=a.data,o=a.indices.length,h=Cs(o);return ni(t,s,h),li(t,s,h),oi(t,s,h),hi(t,s,a.indices,h),ui(t,s,a.indices,h),ci(t,s),di(t,s,a.indices,h),gi(t,s,n),new ss(e,s,i,2,r)}function ai(e,t){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,i=pi(r)&&s,a=r.length/3-(i?1:0),n=new Array(2*(a-1)),o=i?r.slice(0,-3):r;let h=0;for(let g=0;g<a-1;g++)n[h++]=g,n[h++]=g+1;const d=new M(o,n,3,i);return t.push(["position",d]),d}function ni(e,t,r){if(e.attributeData.colorFeature!=null)return;const s=e.attributeData.color;t.push(["color",new M(s??Ar,r,4)])}function oi(e,t,r){e.attributeData.normal&&t.push(["normal",new M(e.attributeData.normal,r,3)])}function hi(e,t,r,s){const i=e.attributeData.colorFeature;i!=null&&(typeof i=="number"?t.push(["colorFeatureAttribute",new M([i],s,1,!0)]):t.push(["colorFeatureAttribute",new M(i,r,1,!0)]))}function li(e,t,r){e.attributeData.sizeFeature==null&&t.push(["size",new M([e.attributeData.size??1],r,1,!0)])}function ui(e,t,r,s){const i=e.attributeData.sizeFeature;i!=null&&(typeof i=="number"?t.push(["sizeFeatureAttribute",new M([i],s,1,!0)]):t.push(["sizeFeatureAttribute",new M(i,r,1,!0)]))}function ci(e,t){const{attributeData:{position:r,timeStamps:s}}=e;if(!s)return;const i=r.length/3,a=new Array(2*(i-1));let n=0;for(let o=0;o<i-1;o++)a[n++]=o,a[n++]=o+1;t.push(["timeStamps",new M(s,a,mi,!0)])}function di(e,t,r,s){const i=e.attributeData.opacityFeature;i!=null&&(typeof i=="number"?t.push(["opacityFeatureAttribute",new M([i],s,1,!0)]):t.push(["opacityFeatureAttribute",new M(i,r,1,!0)]))}function gi(e,t,r){if(e.overlayInfo==null||e.overlayInfo.renderCoordsHelper.viewingMode!==1||!e.overlayInfo.spatialReference.isGeographic)return;const s=Xt(r.length),i=xr(e.overlayInfo.spatialReference);for(let _=0;_<s.length;_+=3)Hr(r,_,s,_,i);const a=r.length/3,n=us(a+1);let o=_i,h=fi,d=0,g=0;I(o,s[g++],s[g++]),g++,n[0]=0;for(let _=1;_<a+1;++_)_===a&&(g=0),I(h,s[g++],s[g++]),g++,d+=yr(o,h),n[_]=d,[o,h]=[h,o];t.push(["distanceToStart",new M(n,t[0][1].indices,1,!0)])}function pi(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}const _i=f(),fi=f(),mi=4;let vi=class extends Qs{},Ft=class{constructor(){this._extent=qe(),this.resolution=0,this.renderLocalOrigin=Us(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new xi}get extent(){return this._extent}setExtent(e){js(this._extent,e)}setupGeometryViews(e){if(this._setupGeometryView(),!e)return;const t=.001*e.range;if(this._extent[0]-t<=e.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];yt(this._extent,e.range,0,r)}if(this._extent[2]+t>=e.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];yt(this._extent,-e.range,0,r)}}_setupGeometryView(){this.canvasGeometries.numViews=1,Mr(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const t=this.canvasGeometries.extents[e];if(t[0]!==t[2]&&t[1]!==t[3])return!0}return!1}},xi=class{constructor(){this.extents=[qe(),qe(),qe()],this.numViews=0}},yi=class{constructor(e,t,r){this._fbos=e,this._format=t,this._name=r}get valid(){var e;return((e=this._handle)==null?void 0:e.getTexture())!=null}dispose(){this._handle=me(this._handle)}get texture(){var e;return(e=this._handle)==null?void 0:e.getTexture()}ensureFramebuffer(e,t){var r,s,i;this._handle&&((r=this._handle.fbo)==null?void 0:r.width)===e&&((s=this._handle.fbo)==null?void 0:s.height)===t||((i=this._handle)==null||i.release(),this._handle=this._fbos.acquire(e,t,this._name,this._format))}bind(e){var t;e.bindFramebuffer((t=this._handle)==null?void 0:t.fbo)}generateMipMap(){var e,t,r,s,i;(r=(t=(e=this._handle)==null?void 0:e.getTexture())==null?void 0:t.descriptor)!=null&&r.hasMipmap&&((i=(s=this._handle)==null?void 0:s.getTexture())==null||i.generateMipmap())}},Z=class{constructor(e,t,r,s,i=1,a=6){this.output=r,this.content=s,this.redrawOnRequest=i,this.fbo=new yi(e,a,t)}handleRenderRequest(e){return e===1||e===this.redrawOnRequest}get valid(){return this.fbo.valid}},bi=class{constructor(e){this.targets=[new Z(e,"overlay color",0,0),new Z(e,"overlay IM color",0,1),new Z(e,"overlay highlight",9,2,1,3),new Z(e,"overlay water",3,3,0),new Z(e,"overlay occluded",0,4)],rr()&&this.targets.push(new Z(e,"overlay olid",10,5,1,5))}getTexture(e){var t;return(t=this.targets[e])==null?void 0:t.fbo.texture}dispose(e){if(e!==0)for(const t of this.targets)t.fbo.dispose();else this.targets[3].fbo.dispose()}computeValidity(){return this.targets.reduce((e,t,r)=>t.valid?e|=1<<r:e,0)}},or=class extends be{constructor(){super(...arguments),this.color=Qt(1,1,1)}};function wi(){const e=new Q;return e.include(ct),e.fragment.uniforms.add(new ze("tex",t=>t.texture),new Zr("uColor",t=>t.color)),e.fragment.main.add(q`vec4 texColor = texture(tex, uv);
fragColor = texColor * vec4(uColor, 1.0);`),e}const Ci=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:or,build:wi},Symbol.toStringTag,{value:"Module"})),Ti={required:[]};let hr=class extends br{precompile(e){return!!this.acquireTechniques(e)}consumes(){return Ti}get usedMemory(){return 0}get renderOccludedFlags(){return 1}get isDecoration(){return!1}get readyToRun(){return!1}get numGeometries(){return 0}get hasOccludees(){return!1}get hasEmitters(){return!1}forEachGeometry(e){}},Si=class extends hr{},tn=class extends hr{},Dt=class extends er{constructor(e,t){super(e,"ivec2",1,(r,s,i)=>r.setUniform2iv(e,t(s,i)))}},He=class extends er{constructor(e,t){super(e,"usampler2D",1,(r,s,i)=>r.bindTexture(e,t(s,i)))}},lr=class extends be{};function Oi(){const e=new Q,{outputs:t,fragment:r}=e;return e.include(ct),r.uniforms.add(new He("highlightTexture",s=>s.highlightTexture)),r.constants.add("outlineWidth","int",Math.ceil(Le)),r.constants.add("cellSize","int",j),t.add("fragGrid","uvec2"),r.main.add(q`ivec2 inputTextureSize = textureSize(highlightTexture, 0);
ivec2 cellBottomLeftCornerInput = ivec2(ivec2(floor(gl_FragCoord.xy) * vec2(cellSize)));
ivec2 coordMid =  cellBottomLeftCornerInput + ivec2(cellSize >> 1);
uvec2 centreTexel = texelFetch(highlightTexture, coordMid, 0).rg & uvec2(0x55u);
float marginSquare = float(outlineWidth*outlineWidth);
uvec2 outputValue = centreTexel & uvec2(0x55u);
for(int y = -outlineWidth; y <= cellSize + outlineWidth; y+=2) {
int dy = y < 0 ? -y : y > cellSize ? y-cellSize : 0;
int xMargin = dy > 0 ? int(ceil(sqrt(marginSquare - float(dy*dy)))) : outlineWidth;
for(int x = -xMargin; x <= cellSize + xMargin; x+=2) {
ivec2 coord = cellBottomLeftCornerInput + ivec2(x, y);
uvec2[4] texels = uvec2[4] (
texelFetch(highlightTexture,coord+ivec2(0,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,0),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(0,1),0).rg & uvec2(0x55u),
texelFetch(highlightTexture,coord+ivec2(1,1),0).rg & uvec2(0x55u)
);
if (texels[0] == texels[1] && texels[1] == texels[2] && texels[2] == texels[3] && texels[3] ==  centreTexel) {
continue;
}
for (int i=0; i<4; ++i){
outputValue |= ((texels[i] ^ centreTexel) << 1);
outputValue |= texels[i];
}
}
}
fragGrid = outputValue;`),e}const j=32,Le=9,ur=.4,Pi=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:lr,blurSize:ur,build:Oi,gridCellPixelSize:j,outlineSize:Le},Symbol.toStringTag,{value:"Module"}));function _t(e){const{vertex:t}=e;t.uniforms.add(new He("coverageTexture",r=>r.coverageTexture),new Dt("highlightRenderCellCount",r=>I(Mt,r.horizontalCellCount,r.verticalCellCount)),new Dt("highlightTextureResolution",({highlightTexture:r})=>I(Mt,r.descriptor.width,r.descriptor.height)),new Ee("highlightLevel",r=>r.highlightLevel)).constants.add("cellSize","int",j),e.varyings.add("sUV","vec2"),e.varyings.add("vOutlinePossible","float"),t.code.add(q`const ivec2 cellVertices[4] = ivec2[4](ivec2(0,0), ivec2(1,0), ivec2(0,1), ivec2(1,1));`),t.main.add(q`int cellIndex = gl_InstanceID;
int cellX = cellIndex % highlightRenderCellCount[0];
int cellY = (cellIndex - cellX) / highlightRenderCellCount[0];
ivec2 cellPos = ivec2(cellX, cellY);
uvec2 covTexel = texelFetch(coverageTexture, cellPos, 0).rg;
int channelIndex = (highlightLevel >> 2) & 3;
uint channelValue = covTexel[channelIndex];
int highlightIndex = (highlightLevel & 3) << 1;
bool covered = ((channelValue >> highlightIndex) & 1u) == 1u;
if (!covered) {
gl_Position = vec4(0.0);
return;
}
vOutlinePossible = (((channelValue >> highlightIndex) & 2u) == 2u) ? 1.0 : 0.0;
ivec2 iPosInCell = cellVertices[gl_VertexID];
vec2 sPos = vec2(cellPos * cellSize + iPosInCell * (cellSize));
vec2 vPos = sPos / vec2(highlightTextureResolution);
sUV = vPos;
gl_Position = vec4(2.0 * vPos - vec2(1.0), 0.0, 1.0);`)}const Mt=f();function Ri(){const e=new Q;e.include(_t);const{fragment:t}=e;return t.uniforms.add(new ze("blurInput",r=>r.highlightBlurTexture),new Zt("blurSize",r=>r.blurSize),new He("highlightTexture",r=>r.highlightTexture),new ze("highlightOptionsTexture",r=>r.highlightOptionsTexture),new Ee("highlightLevel",r=>r.highlightLevel),new Kt("occludedIntensityFactor",r=>r.occludedFactor)),t.constants.add("inner","float",1-(Le-ur)/Le),e.include(Jt),t.main.add(q`vec2 highlightTextureSize = vec2(textureSize(highlightTexture,0));
vec2 uv = sUV;
vec2 center = texture(blurInput, uv).rg;
vec2 blurredHighlightValue = (vOutlinePossible == 0.0)
? center
: center * 0.204164
+ texture(blurInput, uv + blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv - blurSize * 1.407333).rg * 0.304005
+ texture(blurInput, uv + blurSize * 3.294215).rg * 0.093913
+ texture(blurInput, uv - blurSize * 3.294215).rg * 0.093913;
float highlightIntensity = blurredHighlightValue.r;
float occlusionWeight = blurredHighlightValue.g;
if (highlightIntensity <= 0.01) {
discard;
}
vec4 fillColor    = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 0), 0);
vec4 outlineColor = texelFetch(highlightOptionsTexture, ivec2(highlightLevel, 1), 0);
uvec2 centerTexel = texelFetch(highlightTexture, ivec2(uv * highlightTextureSize), 0).rg;
uint centerBits = readLevelBits(centerTexel, highlightLevel);
bool centerFilled = (centerBits & 1u) == 1u;
bool centerOccluded = (centerBits & 3u) == 3u;
bool occluded = centerOccluded || (0.5 * highlightIntensity < occlusionWeight);
float occlusionFactor = occluded ? occludedIntensityFactor : 1.0;
float outlineFactor = centerFilled ? 1.0 : smoothstep(0.0, inner, highlightIntensity);
float fillFactor = centerFilled ? 1.0 : 0.0;
vec4 baseColor = mix(outlineColor, fillColor, fillFactor);
float intensity = baseColor.a * occlusionFactor * outlineFactor;
fragColor = vec4(baseColor.rgb, intensity);`),e}const Fi=Object.freeze(Object.defineProperty({__proto__:null,build:Ri},Symbol.toStringTag,{value:"Module"}));let Vt=class extends U{constructor(e,t){super(e,t,new k(Fi,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(r=>r.H)),gt(Ae))}initializePipeline(){return N({blending:ir,colorWrite:B})}},cr=class extends be{constructor(){super(...arguments),this.blurSize=f()}};function Di(){const e=new Q;return e.include(_t),e.outputs.add("fragHighlight","vec2",0),e.fragment.uniforms.add(new Zt("blurSize",t=>t.blurSize),new Kr("blurInput",t=>t.blurInput)).main.add(q`vec2 highlightTextureSize = vec2(textureSize(blurInput,0));
vec2 center = texture(blurInput, sUV).rg;
if (vOutlinePossible == 0.0) {
fragHighlight = center;
} else {
vec2 sum = center * 0.204164;
sum += texture(blurInput, sUV + blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV - blurSize * 1.407333).rg * 0.304005;
sum += texture(blurInput, sUV + blurSize * 3.294215).rg * 0.093913;
sum += texture(blurInput, sUV - blurSize * 3.294215).rg * 0.093913;
fragHighlight = sum;
}`),e}const Mi=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:cr,build:Di},Symbol.toStringTag,{value:"Module"}));let It=class extends U{constructor(e,t){super(e,t,new k(Mi,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(r=>r.a)),gt(Ae))}initializePipeline(){return N({colorWrite:B})}},Xe=class extends U{constructor(e,t){super(e,t,new k(Pi,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(r=>r.b)),dt)}initializePipeline(){return N({colorWrite:B})}};class Vi extends be{constructor(){super(...arguments),this.occludedFactor=ks,this.verticalCellCount=0,this.horizontalCellCount=0,this.highlightLevel=0,this.pixelRatio=1}}function Ii(){const e=new Q;e.include(_t),e.include(Jt);const{fragment:t}=e;return e.outputs.add("fragSingleHighlight","vec2",0),t.uniforms.add(new He("highlightTexture",r=>r.highlightTexture),new Ee("highlightLevel",r=>r.highlightLevel)),t.main.add(q`ivec2 iuv = ivec2(gl_FragCoord.xy);
uvec2 inputTexel = texelFetch(highlightTexture, iuv, 0).rg;
uint bits = readLevelBits(inputTexel, highlightLevel);
bool hasHighlight = (bits & 1u) == 1u;
bool hasOccluded  = (bits & 2u) == 2u;
fragSingleHighlight = vec2(hasHighlight ? 1.0 : 0.0, hasOccluded ? 1.0 : 0.0);`),e}const qi=Object.freeze(Object.defineProperty({__proto__:null,build:Ii},Symbol.toStringTag,{value:"Module"}));let qt=class extends U{constructor(e,t){super(e,t,new k(qi,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(r=>r.c)),gt(Ae))}initializePipeline(){return N({colorWrite:B})}},Pe=class extends ys{constructor(){super(...arguments),this.produces=Ge.HIGHLIGHTS,this.consumes={required:[Ge.HIGHLIGHTS,"highlights"]},this._downsampleDrawParameters=new lr,this._passParameters=new Vi,this._highlightBlurDrawParameters=new cr,this._grid=new zi}initialize(){this.addHandles([se(()=>this._updateOptionsTexture(),()=>{},et)])}destroy(){this._grid.coverage=me(this._grid.coverage),this._grid.vao=lt(this._grid.vao),this._passParameters.highlightOptionsTexture=me(this._passParameters.highlightOptionsTexture)}_updateOptionsTexture(){if(this._passParameters.highlightOptionsTexture==null){const e=new nr(16,2);e.internalFormat=6408,e.samplingMode=9728,this._passParameters.highlightOptionsTexture=new pt(this.renderingContext,e,null)}this._passParameters.highlightOptionsTexture.setData(Li(this.view.state.highlights)),this.requestRender(1)}precompile(){this.techniques.precompile(Xe),this.techniques.precompile(qt),this.techniques.precompile(It),this.techniques.precompile(Vt)}render(e){const t=e.find(({name:a})=>a===Ge.HIGHLIGHTS),{techniques:r,bindParameters:s}=this;if(!s.decorations)return t;if(!r.get(Xe).compiled)return this.requestRender(1),t;const i=e.find(({name:a})=>a==="highlights").getTexture();return this._renderHighlightPostprocess(i,t),t}_prepareAndDownSample(e){var n;this._gridUpdateResources(e);const t=this.techniques.get(Xe),r=this._gridComputeCoverage(t,e),{horizontalCellCount:s,verticalCellCount:i}=r,a=this._passParameters;return a.horizontalCellCount=s,a.verticalCellCount=i,a.coverageTexture=(n=r.coverage)==null?void 0:n.getTexture(),r}_renderGrid(e){const t=e.verticalCellCount*e.horizontalCellCount;this.renderingContext.bindVAO(e.vao),this.renderingContext.drawElementsInstanced(Ys.TRIANGLES,6,Zs.UNSIGNED_BYTE,0,t)}_renderHighlightPostprocess(e,t){var ft;const{fboCache:r,techniques:s,bindParameters:i,_passParameters:a,renderingContext:n}=this,o=s.get(qt),h=s.get(It),d=s.get(Vt);if(!d.compiled||!h.compiled||!o.compiled)return void this.requestRender(1);a.highlightTexture=e;const g=this._prepareAndDownSample(e),{width:_,height:p}=e.descriptor;a.highlightTexture=e;const{camera:y}=i,{fullWidth:F,fullHeight:le,pixelRatio:X,fullViewport:$e}=y,ue=Math.ceil(F/X),ce=Math.ceil(le/X),{_highlightBlurDrawParameters:W}=this,m=this.view.stage.renderView.renderer,{highlights:C}=i;for(let we=0;we<C.length;++we){const{name:mr}=C[we];if(!m.hasHighlight(mr))continue;a.highlightLevel=we,n.setClearColor(0,0,0,0);const je=r.acquire(_,p,"single highlight",2);n.bindFramebuffer(je.fbo),n.setViewport(0,0,_,p),n.clear(16384),n.bindTechnique(o,i,a),this._renderGrid(g),W.blurInput=je.getTexture(),I(W.blurSize,1/ue,0);const Ce=r.acquire(ue,ce,"single highlight blur",2);n.unbindTexture((ft=Ce.fbo)==null?void 0:ft.colorTexture),n.bindFramebuffer(Ce.fbo),n.setViewport(0,0,ue,ce),n.clear(16384),n.bindTechnique(h,i,a,W),this._renderGrid(g),je.release(),I(W.blurSize,0,1/ce),a.highlightBlurTexture=Ce.getTexture(),n.bindFramebuffer(t.fbo),n.setViewport4fv($e),n.bindTechnique(d,i,a,W),this._renderGrid(g),Ce.release()}a.coverageTexture=a.highlightTexture=null}_gridUpdateResources(e){const t=this._grid,{width:r,height:s}=e.descriptor;if(t.horizontalCellCount=Math.ceil(r/j),t.verticalCellCount=Math.ceil(s/j),t.vao)return;const i=this.renderingContext,a=Xs.createIndex(i,35044,Wi);t.vao=new vi(i,new Ks(i,Ae),a)}_gridComputeCoverage(e,t){var d;const r=this.renderingContext,s=this._grid,i=t.descriptor,a=Math.ceil(i.width/j),n=Math.ceil(i.height/j);this._downsampleDrawParameters.input=t;const{highlights:o}=this.bindParameters;(d=s.coverage)==null||d.release();const h=this.fboCache.acquire(a,n,"highlight coverage",o.length>dr?3:1);return s.coverage=h,r.bindFramebuffer(h.fbo),r.bindTechnique(e,this.bindParameters,this._passParameters,this._downsampleDrawParameters),r.setViewport(0,0,a,n),r.screen.draw(),s}get test(){}};u([v()],Pe.prototype,"produces",void 0),u([v()],Pe.prototype,"consumes",void 0),Pe=u([A("esri.views.3d.webgl-engine.effects.highlight.Highlight")],Pe);let zi=class{constructor(){this.coverage=null,this.vao=null,this.verticalCellCount=0,this.horizontalCellCount=0,this.viewportWidth=0,this.viewportHeight=0}};function Li(e){const t=new Uint8Array(128);let r=0;for(const s of e){const i=4*r,a=4*r+64;++r;const{color:n}=s,o=s.haloColor??n;t[i+0]=n.r,t[i+1]=n.g,t[i+2]=n.b,t[i+3]=s.fillOpacity*n.a*255,t[a+0]=o.r,t[a+1]=o.g,t[a+2]=o.b,t[a+3]=s.haloOpacity*o.a*255}return t}let Ei=0;function Ai(e){let t=0;for(const s of e){const{name:i}=s;t+=i.length;const{color:a,fillOpacity:n,haloColor:o,haloOpacity:h}=s;t+=a.r+a.g+a.b+a.a+n,t+=o?o.r+o.g+o.b+o.a+h:0}const r=e.at(0);if(r){const{shadowOpacity:s,shadowDifference:i,shadowColor:a}=r;t+=s+i+a.r+a.g+a.b+a.a}return Ei+++(t>=0?0:1)}const Wi=new Uint8Array([0,1,2,2,1,3]);function Hi(e,t,r,s,i,a=0){const{highlights:n}=s,o=n.length>1?t.acquire(r.width,r.height,"highlight mix",n.length>dr?3:1):null,{gl:h}=e;if(o){const g=e.getBoundFramebufferObject();e.bindFramebuffer(o.fbo),h.clearBufferuiv(h.COLOR,0,[0,0,0,0]),e.bindFramebuffer(g)}const d=o==null?void 0:o.getTexture();s.highlightMixTexture=d,I(s.highlightMixOrigin,a,0),n.forEach((g,_)=>{if(_>0){const p=pt.TEXTURE_UNIT_FOR_UPDATES;e.bindTexture(d,p),e.setActiveTexture(p),h.copyTexSubImage2D(3553,0,0,0,a,0,r.width,r.height),e.bindTexture(null,p)}e.clear(256),s.highlightLevel=_,i()}),s.highlightLevel=null,s.highlightMixTexture=null,o==null||o.release()}const dr=4;let $i=class{constructor(e,t,r,s){this.material=e,this.output=t,this.techniques=r,this.textures=s}},ji=class{constructor(e,t,r,s){this._textures=e,this._techniques=t,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new Js}dispose(){this._textures.destroy()}acquire(e,t,r){var i;if(this._ownMaterial(e),!((i=e.produces.get(t))!=null&&i(r)))return null;let s=this._id2glMaterialRef.get(r,e.id);if(s==null){const a=e.createGLMaterial(new $i(e,r,this._techniques,this._textures));s=new Ni(a),this._id2glMaterialRef.set(r,e.id,s)}return s.ref(),s.glMaterial}release(e,t){const r=this._id2glMaterialRef.get(t,e.id);r!=null&&(r.unref(),r.referenced||(lt(r.glMaterial),this._id2glMaterialRef.delete(t,e.id)))}_ownMaterial(e){e.repository&&e.repository!==this&&Dr.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},Ni=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,oe(this._refCnt>=0)}get referenced(){return this._refCnt>0}};function Bi(e){return e!=null&&!e.readyToRun}var rt;let Re=rt=class extends xe{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new rt({cloudCover:this.cloudCover})}};u([ve({cloudy:"cloudy"}),v({json:{write:{isRequired:!0}}})],Re.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Re.prototype,"cloudCover",void 0),Re=rt=u([A("esri.views.3d.environment.CloudyWeather")],Re);var st;let Fe=st=class extends xe{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new st({fogStrength:this.fogStrength})}};u([ve({foggy:"foggy"}),v({json:{write:{isRequired:!0}}})],Fe.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Fe.prototype,"fogStrength",void 0),Fe=st=u([A("esri.views.3d.environment.FoggyWeather")],Fe);var it;let pe=it=class extends xe{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new it({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ve({rainy:"rainy"}),v({json:{write:{isRequired:!0}}})],pe.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"cloudCover",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],pe.prototype,"precipitation",void 0),pe=it=u([A("esri.views.3d.environment.RainyWeather")],pe);var at;let K=at=class extends xe{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new at({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([ve({snowy:"snowy"}),v({json:{write:{isRequired:!0}}})],K.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],K.prototype,"cloudCover",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],K.prototype,"precipitation",void 0),u([v({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],K.prototype,"snowCover",void 0),K=at=u([A("esri.views.3d.environment.SnowyWeather")],K);var nt;let De=nt=class extends xe{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new nt({cloudCover:this.cloudCover})}};u([ve({sunny:"sunny"}),v({json:{write:{isRequired:!0}}})],De.prototype,"type",void 0),u([v({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],De.prototype,"cloudCover",void 0),De=nt=u([A("esri.views.3d.environment.SunnyWeather")],De);const Me=1e4,rn=1e5;let Gi=class{constructor(){this.startTime=0,this._data=Qe(null),this.coverage=0,this.absorption=0,this._readChannels=0,this.parallax=new zt,this.parallaxNew=new zt,this._anchorPoint=ye(),this._fadeState=Qe(0),this._fadeFactor=Qe(1)}get data(){return this._data.value}set data(e){this._data.value=e}get readChannels(){return this._readChannels}get fadeState(){return this._fadeState.value}get fadeFactor(){return this._fadeFactor.value}get opacity(){switch(this.fadeState){case 0:return 0;case 4:return 1-this.fadeFactor;case 1:return this.fadeFactor;case 2:case 3:return 1}}fade(e,t,r){this.isFading&&this.fadeFactor<1&&(this._fadeFactor.value=r?Yt((t-this.startTime)/(ki*r),0,1):1,this.fadeFactor===1&&this._endFade()),this._evaluateState(e,t),this._updateParallax(e)}_evaluateState(e,t){const r=e.relativeElevation,s=this._updateAnchorPoint(e);(r>1.7*Me||r<-Me||s>Et)&&this.opacity>0?this._startFade(0,t):this.isFading||(r>Me||r<-.35*Me||s>Qi*Et?this.opacity>0&&this._startFade(4,t):Bi(this.data)&&(this.opacity===0?this._startFade(1,t):this.data.state===2&&(this.fadeState===2?this._startFade(3,t):this._startFade(2,t))))}_updateParallax(e){const t=Ls(e.eye);this.parallax.radiusCurvatureCorrection=.84*Math.sqrt(Math.max(t-Ne.radius*Ne.radius,0))/Math.sqrt(t),Pt(Lt,this.parallax.anchorPoint,J),St(this.parallax.transform,ne,J[3],Rt(J)),Pt(Lt,this.parallaxNew.anchorPoint,J),St(this.parallaxNew.transform,ne,J[3],Rt(J))}_updateAnchorPoint(e){var t;return As(this._anchorPoint,e.eye),Ws(this._anchorPoint,this._anchorPoint,Ne.radius),this.fadeState===0&&((t=this.data)==null?void 0:t.state)===2?(E(this.parallax.anchorPoint,this._anchorPoint),0):Es(Hs(Ui,this.parallax.anchorPoint,this._anchorPoint))}requestFade(){this._fadeFactor.value=0}_startFade(e,t){switch(this._fadeState.value=e,this.startTime=t,e){case 3:this.requestFade(),this._switchReadChannels(),E(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 1:this.requestFade(),this._switchReadChannels(),E(this.parallax.anchorPoint,this._anchorPoint),E(this.parallaxNew.anchorPoint,this._anchorPoint);break;case 4:this.requestFade();break;case 2:this._switchReadChannels(),E(this.parallax.anchorPoint,this._anchorPoint),E(this.parallaxNew.anchorPoint,this._anchorPoint),this._endFade();break;case 0:this._endFade()}}_endFade(){switch(this._fadeFactor.value=1,this.data&&this.data.state!==2&&(this.data.state=0),this.fadeState){case 3:E(this.parallax.anchorPoint,this.parallaxNew.anchorPoint),this._fadeState.value=2;break;case 1:this._fadeState.value=2;break;case 4:this._fadeState.value=0;break;case 2:case 0:break;default:Ir(this.fadeState)}}_switchReadChannels(){var e;((e=this.data)==null?void 0:e.state)===2&&(this._readChannels=1-this._readChannels,this.data.state=3)}get isFading(){return this.fadeState===4||this.fadeState===1||this.fadeState===3}},zt=class{constructor(){this.anchorPoint=ye(),this.radiusCurvatureCorrection=0,this.transform=V()}};const Lt=Qt(0,0,1),J=ti(),Ui=ye(),ki=1.25,Qi=.5,Et=2e5;let Xi=class{constructor(e){this.shadowMap=e,this.slot=2,this.slicePlane=null,this.hasOccludees=!1,this.enableFillLights=!0,this.oitPass=0,this.alignPixelEnabled=!1,this.decorations=!0,this.overlayStretch=1,this.viewshedEnabled=!1,this.cutFillEnabled=!1,this._camera=new We,this._inverseViewport=f(),this._oldLighting=new ke,this._newLighting=new ke,this._fadedLighting=new ke,this._lighting=this._newLighting,this.ssr=new Yi,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.highlights=new Array,this.highlightOrderMap=new Map,this.highlightMixOrigin=f(),this.highlightMixTexture=null,this.hudRenderStyle=0,this.hudOccludedFragmentOpacity=1,this.snowCover=0,this.clouds=new Gi,this.shadowHighlightsVisible=!1}destroy(){this._camera=null,this.contentCamera=null,this.depth=null,this.geometryDepth=null,this.mainDepth=null,this.overlay=null,this.ssao=null,this.terrainDepth=null}get camera(){return this._camera}set camera(e){this._camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}fadeLighting(){switch(this.clouds.fadeFactor){case 0:this._lighting=this._oldLighting;break;default:this._fadedLighting.lerpLighting(this._oldLighting,this._newLighting,this.clouds.fadeFactor),this._lighting=this._fadedLighting;break;case 1:this._lighting=this._newLighting,this._oldLighting.copyFrom(this._newLighting)}}updateLighting(e,t,r,s){this._oldLighting.copyFrom(this.lighting),this._newLighting.noonFactor=t,this._newLighting.globalFactor=r,this._newLighting.set(e),this._oldLighting.updateLegacy(),s===1&&this.clouds.requestFade(),this.fadeLighting()}get highlight(){return this.highlightLevel==null?null:this.highlights[this.highlightLevel]}},Yi=class{constructor(){this.fadeFactor=1,this.reprojectionMatrix=V()}},Zi=class{constructor(e,t,r){this.rctx=e,this.techniques=r,this.lastFrameCamera=new We,this.output=0,this.renderOccludedMask=ot,this.time=Pr(0),this.bind=new Xi(t),this.bind.alignPixelEnabled=!0}};const ot=13;let fe=class extends We{constructor(){super(...arguments),this._projectionMatrix=V()}get projectionMatrix(){return this._projectionMatrix}};u([v()],fe.prototype,"_projectionMatrix",void 0),u([v({readOnly:!0})],fe.prototype,"projectionMatrix",null),fe=u([A("esri.views.3d.webgl-engine.lib.CascadeCamera")],fe);class Ve{constructor(){this.camera=new fe,this.lightMat=V()}}class Ki{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}}let Ji=class{constructor(e,t){this._fbos=e,this._viewingMode=t,this._snapshots=new Array,this._textureHeight=0,this._numCascades=1,this.settings=new Ki,this._projectionView=V(),this._projectionViewInverse=V(),this._modelViewLight=V(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=ut(),this._cascades=[new Ve,new Ve,new Ve,new Ve],this._lastOrigin=null,this._enabled=!1,this._maxTextureWidth=Math.min(Rr("esri-mobile")?4096:16384,e.rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}get depthTexture(){var e;return(e=this._handle)==null?void 0:e.getTexture(Se)}get _textureWidth(){return this._textureHeight*this._numCascades}get numCascades(){return this._numCascades}get cascadeDistances(){return Ot(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}disposeMainBuffer(){this._handle=me(this._handle)}disposeOffscreenBuffers(){this.disposeMainBuffer(),this._discardSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=Yt(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}get cascades(){for(let e=0;e<this._numCascades;++e)Ze[e]=this._cascades[e];return Ze.length=this._numCascades,Ze}start(e,t,r,s,i){oe(this.enabled);const{near:a,far:n}=aa(r);this._computeCascadeDistances(a,n,s),this._textureHeight=this._computeTextureHeight(e,i,s),this._setupMatrices(e,t);const{viewMatrix:o,projectionMatrix:h}=e;for(let d=0;d<this._numCascades;++d)this._constructCascade(d,h,o,t);this._lastOrigin=null,this.clear()}finish(){oe(this.enabled)}getShadowMapMatrices(e){if(!this._lastOrigin||!Is(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||ye(),E(this._lastOrigin,e);for(let t=0;t<this._numCascades;++t){Tt(Nt,this._cascades[t].lightMat,e);for(let r=0;r<16;++r)Bt[16*t+r]=Nt[r]}}return Bt}moveSnapshot(e){var t,r;oe(this.enabled),(t=this._snapshots[e])==null||t.release(),this._snapshots[e]=this._handle,(r=this._handle)==null||r.setName(e===0?"shadow map highlight":"shadow map excluding highlight"),this._handle=null}copySnapshot(e){var a,n,o,h;if(!this.enabled||!((n=(a=this._handle)==null?void 0:a.getTexture(Se))!=null&&n.descriptor))return;(o=this._snapshots[e])==null||o.release();const t=e===0?"shadow map highlight":"shadow map excluding highlight",r=this._acquireFBO(t);this._snapshots[e]=r;const s=(h=this._handle)==null?void 0:h.fbo;if(!s||!(r!=null&&r.fbo))return void console.error("No FBO");const{rctx:i}=this._fbos;i.blitFramebuffer(s,r.fbo,256)}getSnapshot(e){var t;return this.enabled?(t=this._snapshots[e])==null?void 0:t.getTexture(Se):null}clear(){this._ensureFbo(),this.bindFbo(),this._fbos.rctx.clear(256)}_computeTextureHeight({pixelRatio:e,fullWidth:t,fullHeight:r},s,i){const a=Math.min(window.devicePixelRatio,s)/e,n=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return ri(Math.max(t,r)*a*n,this._maxTextureWidth/this._numCascades)}_ensureFbo(){var e,t,r,s;((t=(e=this._handle)==null?void 0:e.fbo)==null?void 0:t.width)===this._textureWidth&&((r=this._handle)==null?void 0:r.fbo.height)===this._textureHeight||((s=this._handle)==null||s.release(),this._handle=this._acquireFBO("shadow map"))}_acquireFBO(e){var r;const t=this._fbos.acquire(this._textureWidth,this._textureHeight,e,12);return(r=t.getTexture(Se))==null||r.setShadowFiltering(!0),t}_discardSnapshot(e){this._snapshots[e]=me(this._snapshots[e])}_discardSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}bindFbo(){var e;this._fbos.rctx.bindFramebuffer((e=this._handle)==null?void 0:e.fbo)}_constructCascade(e,t,r,s){const i=this._cascades[e],a=-this._cascadeDistances[e],n=-this._cascadeDistances[e+1],o=(t[10]*a+t[14])/Math.abs(t[11]*a+t[15]),h=(t[10]*n+t[14])/Math.abs(t[11]*n+t[15]);oe(o<h);for(let p=0;p<8;++p){Ot(At,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?o:h,1);const y=D[p];$s(y,At,this._projectionViewInverse),y[0]/=y[3],y[1]/=y[3],y[2]/=y[3]}qs(Ye,D[0]),i.camera.viewMatrix=Tt(ea,this._modelViewLight,Ye);for(let p=0;p<8;++p)zs(D[p],D[p],i.camera.viewMatrix);let d=D[0][2],g=D[0][2];for(let p=1;p<8;++p)d=Math.min(d,D[p][2]),g=Math.max(g,D[p][2]);d-=200,g+=200,i.camera.near=-g,i.camera.far=-d,ia(r,s,d,g,i.camera),tt(i.lightMat,i.camera.projectionMatrix,i.camera.viewMatrix);const _=this._textureHeight;i.camera.viewport=[e*_,0,_,_]}_setupMatrices(e,t){tt(this._projectionView,e.projectionMatrix,e.viewMatrix),Ps(this._projectionViewInverse,this._projectionView);const r=this._viewingMode===1?e.eye:sr(Ye,0,0,1);Rs(this._modelViewLight,[0,0,0],[-t[0],-t[1],-t[2]],r)}_computeCascadeDistances(e,t,r){const s=r?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(ei(t/e,4)),s);const i=(t-e)/this._numCascades,a=(t/e)**(1/this._numCascades);let n=e,o=e;for(let h=0;h<this._numCascades+1;++h)this._cascadeDistances[h]=Fr(n,o,this.settings.splitSchemeLambda),n*=a,o+=i}get test(){}};const ea=V(),At=ut(),D=[];for(let e=0;e<8;++e)D.push(ut());const Wt=f(),Ht=f(),ta=f(),$t=f(),jt=f(),Ye=ye(),Ze=[],Nt=V(),Bt=ne.concat(ne,ne,ne),O=f(),ee=f(),$=[f(),f(),f(),f()],x=f(),Ke=f(),L=f(),_e=f(),te=f(),re=f(),Ie=f();function ra(e,t,r,s,i,a,n,o){I(O,0,0);for(let m=0;m<4;++m)H(O,O,e[m]);ie(O,O,.25),I(ee,0,0);for(let m=4;m<8;++m)H(ee,ee,e[m]);ie(ee,ee,.25),ge($[0],e[4],e[5],.5),ge($[1],e[5],e[6],.5),ge($[2],e[6],e[7],.5),ge($[3],e[7],e[4],.5);let h=0,d=bt($[0],O);for(let m=1;m<4;++m){const C=bt($[m],O);C<d&&(d=C,h=m)}ae(x,$[h],e[h+4]);const g=x[0];let _,p;x[0]=-x[1],x[1]=g,ae(Ke,ee,O),w(Ke,x)<0&&qr(x,x),ge(x,x,Ke,r),wt(x,x),_=p=w(ae(L,e[0],O),x);for(let m=1;m<8;++m){const C=w(ae(L,e[m],O),x);C<_?_=C:C>p&&(p=C)}zr(s,O),ie(L,x,_-t),H(s,s,L);let y=-1,F=1,le=0,X=0;for(let m=0;m<8;++m){ae(_e,e[m],s),wt(_e,_e);const C=x[0]*_e[1]-x[1]*_e[0];C>0?C>y&&(y=C,le=m):C<F&&(F=C,X=m)}Y(y>0,"leftArea"),Y(F<0,"rightArea"),ie(te,x,_),H(te,te,O),ie(re,x,p),H(re,re,O),Ie[0]=-x[1],Ie[1]=x[0];const $e=Oe(s,e[X],re,H(L,re,Ie),1,i),ue=Oe(s,e[le],re,L,1,a),ce=Oe(s,e[le],te,H(L,te,Ie),1,n),W=Oe(s,e[X],te,L,1,o);Y($e,"rayRay"),Y(ue,"rayRay"),Y(ce,"rayRay"),Y(W,"rayRay")}function c(e,t){return 3*t+e}const Gt=f();function S(e,t){return I(Gt,e[t],e[t+3]),Gt}const T=f(),l=Lr();function sa(e,t,r,s,i){ae(T,r,s),ie(T,T,.5),l[0]=T[0],l[1]=T[1],l[2]=0,l[3]=T[1],l[4]=-T[0],l[5]=0,l[6]=T[0]*T[0]+T[1]*T[1],l[7]=T[0]*T[1]-T[1]*T[0],l[8]=1,l[c(0,2)]=-w(S(l,0),e),l[c(1,2)]=-w(S(l,1),e);let a=w(S(l,0),r)+l[c(0,2)],n=w(S(l,1),r)+l[c(1,2)],o=w(S(l,0),s)+l[c(0,2)],h=w(S(l,1),s)+l[c(1,2)];a=-(a+o)/(n+h),l[c(0,0)]+=l[c(1,0)]*a,l[c(0,1)]+=l[c(1,1)]*a,l[c(0,2)]+=l[c(1,2)]*a,a=1/(w(S(l,0),r)+l[c(0,2)]),n=1/(w(S(l,1),r)+l[c(1,2)]),l[c(0,0)]*=a,l[c(0,1)]*=a,l[c(0,2)]*=a,l[c(1,0)]*=n,l[c(1,1)]*=n,l[c(1,2)]*=n,l[c(2,0)]=l[c(1,0)],l[c(2,1)]=l[c(1,1)],l[c(2,2)]=l[c(1,2)],l[c(1,2)]+=1,a=w(S(l,1),t)+l[c(1,2)],n=w(S(l,2),t)+l[c(2,2)],o=w(S(l,1),r)+l[c(1,2)],h=w(S(l,2),r)+l[c(2,2)],a=-.5*(a/n+o/h),l[c(1,0)]+=l[c(2,0)]*a,l[c(1,1)]+=l[c(2,1)]*a,l[c(1,2)]+=l[c(2,2)]*a,a=w(S(l,1),t)+l[c(1,2)],n=w(S(l,2),t)+l[c(2,2)],o=-n/a,l[c(1,0)]*=o,l[c(1,1)]*=o,l[c(1,2)]*=o,i[0]=l[0],i[1]=l[1],i[2]=0,i[3]=l[2],i[4]=l[3],i[5]=l[4],i[6]=0,i[7]=l[5],i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=l[6],i[13]=l[7],i[14]=0,i[15]=l[8]}function ia(e,t,r,s,i){const a=1/D[0][3],n=1/D[4][3];oe(a<n);let o=a+Math.sqrt(a*n);const h=Math.sin(Vr(e[2]*t[0]+e[6]*t[1]+e[10]*t[2]));o/=h,ra(D,o,h,Wt,Ht,ta,$t,jt),sa(Wt,Ht,$t,jt,i.projectionMatrix),i.projectionMatrix[10]=2/(r-s),i.projectionMatrix[14]=-(r+s)/(r-s)}function aa(e){let{near:t,far:r}=e;return t<2&&(t=2),r<2&&(r=2),t>=r&&(t=2,r=4),{near:t,far:r}}class Ut extends U{constructor(t,r){super(t,r,new k(Ci,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(s=>s.T)),dt)}initializePipeline(t){return t.hasAlpha?N({blending:ir,colorWrite:B}):N({colorWrite:B})}}let gr=class extends bs{constructor(){super(...arguments),this.hasAlpha=!1}};u([P()],gr.prototype,"hasAlpha",void 0);let pr=class extends be{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}};function na(){const e=new Q;return e.include(ct),e.fragment.uniforms.add(new ze("tex",t=>t.texture)),e.fragment.uniforms.add(new Ee("overlayIdx",t=>t.overlayIndex)),e.fragment.uniforms.add(new Kt("opacity",t=>t.opacity)),e.fragment.main.add(q`vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;`),e}const oa=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:pr,build:na},Symbol.toStringTag,{value:"Module"}));let kt=class extends U{constructor(e,t){super(e,t,new k(oa,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(r=>r.O)),dt)}},z=class extends Si{constructor(e){super(e),this._overlays=null,this._renderTargets=null,this._overlayParameters=new pr,this.hasHighlights=!1,this.renderOccludedFlags=1,this._hasWater=!1,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new wr,this._passParameters=new or,this._screenToWorldRatio=1,this._localOriginFactory=null,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._camera=new We,this.events=new Cr,this.longitudeCyclical=null,this.produces=new Map([[18,t=>t!==9||this.hasHighlights],[19,()=>this._hasWater]]),this._hasTargetWithoutRasterImage=!1,this._hasDrapedFeatureSource=!1,this._hasDrapedRasterSource=!1,this._hasDrapedFlowSource=!1}initialize(){const e=this._view,t=e.stage,r=t.renderer.fboCache,{waterTextures:s,techniques:i}=t.renderView;this._renderContext=new Zi(this._rctx,new Ji(r,e.state.viewingMode),i),this.addHandles([se(()=>s.updating,()=>this.events.emit("content-changed"),vt),se(()=>this._spatialReference,o=>this._localOriginFactory=new Gs(o),vt),Tr(()=>e.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0),se(()=>Ai(e.state.highlights),()=>this._sortedDrapeSourceRenderersDirty=!0,et),se(()=>e.state.highlights,o=>{this._bindParameters.highlights=o,this._bindParameters.highlightOrderMap=e.state.highlightOrderMap},et),e.resourceController.scheduler.registerTask(si.OVERLAY_RENDERER,this)]);const{_bindParameters:a,_camera:n}=this;n.near=1,n.far=1e4,n.relativeElevation=null,a.slot=18,a.mainDepth=null,a.camera=n,a.oitPass=0,a.updateLighting([new ws(Sr())],0,0,0)}destroy(){this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._passParameters.texture=lt(this._passParameters.texture),this.disposeOverlays(),this._renderContext=null,this._sortedRenderers.prune()}get _bindParameters(){return this._renderContext.bind}get _rctx(){return this._stage.renderView.renderingContext}get _view(){return this.parent.view}get _stage(){return this.parent.view.stage}get _spatialReference(){return this.parent.spatialReference}get _techniques(){return this._stage.renderView.techniques}get rctx(){return this._rctx}get materials(){return this._pluginContext.materials}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}get pluginContext(){return this._pluginContext}initializeRenderContext(e){const t=new ji(this._view.stage.renderView.textures,this._techniques,()=>{this._onMaterialOrContentChanged(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed"));this._pluginContext={...e,materials:t},this._techniques.precompile(kt)}uninitializeRenderContext(){}acquireTechniques(){return[]}render(){}get updating(){return this._sortedDrapeSourceRenderersDirty||de(this._renderers,e=>e.updating||e.canCompact)}get hasOverlays(){return this._overlays!=null&&this._renderTargets!=null}getMaterialRenderer(e){for(const t of this._renderers.values()){const r=t.getMaterialRenderer(e);if(r)return r}return null}get layers(){return this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers(),Or(this._sortedRenderers.map(e=>e.drapeSource.layer).filter(e=>!!e))}registerDrapeSource(e,t){var r;(r=this._renderers.get(e))==null||r.destroy(),this._renderers.set(e,t),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this.addHandles(se(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e)}removeDrapeSourceRenderer(e){if(e==null)return;const t=this._renderers.get(e);t!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this.removeHandles(e),t.destroy())}computeValidity(){var e;return((e=this._renderTargets)==null?void 0:e.computeValidity())??0}releaseRenderTargets(e){var t;(t=this._renderTargets)==null||t.dispose(e)}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._hasTargetWithoutRasterImage=!!this._overlays&&Te(e,t=>t.drapeTargetType===1)}ensureDrapeSources(e){this._overlays?(this._hasDrapedFeatureSource=Te(e,t=>t.drapeSourceType===1),this._hasDrapedRasterSource=Te(e,t=>t.drapeSourceType===0),this._hasDrapedFlowSource=Te(e,t=>t.drapeSourceType===2)):this._hasDrapedFeatureSource=this._hasDrapedRasterSource=this._hasDrapedFlowSource=!1}get _needsColorWithoutRasterImage(){return this._hasDrapedRasterSource&&this._hasDrapedFeatureSource&&this._hasTargetWithoutRasterImage}ensureOverlays(e,t,r=this._bindParameters.overlayStretch){this._overlays==null&&(this._renderTargets=new bi(this._stage.renderer.fboCache),this._overlays=[new Ft,new Ft]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t),this._bindParameters.overlayStretch=r}disposeOverlays(){var e;this._overlays=null,(e=this._renderTargets)==null||e.dispose(1),this._renderTargets=null,this.events.emit("textures-disposed")}_useOverlayColorInsteadOfColorNoRasterImage(e){return e===1&&!this._needsColorWithoutRasterImage&&this._hasDrapedFeatureSource}getTexture(e){var r;const t=this._useOverlayColorInsteadOfColorNoRasterImage(e);return(r=this._renderTargets)==null?void 0:r.getTexture(t?0:e)}get readyToRun(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_onMaterialOrContentChanged(){this.renderOccludedFlags=de(this._renderers,e=>e.hasOccluders)?Je:1}_processDrapeSources(e,t){let r=!1;for(const[s,i]of this._renderers){if(e.done)break;(s.destroyed||t(s))&&i.commitChanges()&&(r=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,r=!0,this._updateSortedDrapeSourceRenderers(),e.madeProgress()),this.compact(e),r&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this._onMaterialOrContentChanged(),this.hasHighlights=de(this._renderers,s=>s.hasHighlights),this.events.emit("content-changed"))}compact(e){let t=!1;for(const r of this._renderers.values()){if(e.done)break;t=r.compact(e)||t}return t&&this.notifyChange("updating"),t}hasHighlight(e){return de(this._renderers,t=>t.hasHighlight(e))}processSyncDrapeSources(){this._processDrapeSources(ii,e=>e.updatePolicy===1)}get isEmpty(){return!Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&xt(this._renderers,e=>e.isEmpty)}get hasWater(){const e=de(this._renderers,({hasWater:t})=>t);return e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water")),this._hasWater}renders(e){var i,a;if(Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&e!==4&&e!==2)return!0;if(!this._overlays)return!1;const t=this._overlays[0];for(const n of this._overlays)n.setupGeometryViews(this.longitudeCyclical);if(!t.hasSomeSizedView())return!1;const r=this._renderContext.output;this._renderContext.output=((a=(i=this._renderTargets)==null?void 0:i.targets.find(n=>n.content===e))==null?void 0:a.output)??0,++this._techniques.precompiling;const s=this._sortedRenderers.some(({renderer:n})=>n.precompile(this._renderContext));return--this._techniques.precompiling,this._renderContext.output=r,s}get mode(){var e;return this.isEmpty?0:this.hasWater&&this.renders(3)?2:(e=this._renderTargets)!=null&&e.getTexture(0)?1:0}updateAnimation(e){let t=!1;return this._renderers.forEach(r=>t=r.updateAnimation(e)||t),t&&this.parent.requestRender(0),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}precompileShaders(e){if(!this._overlays||!this._renderTargets)return!1;const t=this._bindParameters;t.alignPixelEnabled=e.alignPixelEnabled,++this._techniques.precompiling;for(const r of this._renderTargets.targets){if(r.content===1&&!this._needsColorWithoutRasterImage)continue;const{output:s}=r;this._renderContext.output=s,t.slot=s===3?19:18,s===9&&(t.highlightMixTexture=t.highlights.length>1?this._rctx.emptyTexture:null);const i=this._renderContext.renderOccludedMask;r.content===4&&(this._renderContext.renderOccludedMask=Je),this._sortedRenderers.forAll(({drapeSource:a,renderer:n})=>{r.content===1&&a.drapeSourceType===0||r.content===4&&n.hasOnlyOccluders||n.precompile(this._renderContext)}),this._renderContext.renderOccludedMask=i,t.highlightMixTexture=null}return--this._techniques.precompiling,!0}drawOverlays(e,t){if(!this._overlays||!this._renderTargets)return;for(const s of this._overlays)s.setupGeometryViews(this.longitudeCyclical);this._bindParameters.alignPixelEnabled=e.alignPixelEnabled;const r=this.allSourcesOccluders;for(const s of this._renderTargets.targets){if(!(s.content===0&&this._hasDrapedFlowSource)&&!s.handleRenderRequest(t)||s.content===1&&!this._needsColorWithoutRasterImage||s.content===4&&r)continue;const i=this._drawTarget(0,s),a=this._drawTarget(1,s);(i||a)&&s.fbo.generateMipMap()}}_drawTarget(e,t){const r=this._overlays[e],s=r.canvasGeometries;if(s.numViews===0)return!1;const i=this._view.state.contentPixelRatio;this._screenToWorldRatio=i*r.mapUnitsPerPixel/this._bindParameters.overlayStretch;const{output:a}=t;if(this.isEmpty||a===3&&!this.hasWater||!r.hasSomeSizedView())return!1;const{_rctx:n,_camera:o,_renderContext:h,_bindParameters:d}=this;if(o.pixelRatio=r.pixelRatio*i,h.output=a,d.screenToWorldRatio=this._screenToWorldRatio,d.screenToPCSRatio=this._screenToWorldRatio*this.parent.worldToPCSRatio,d.slot=a===3?19:18,t.content===4&&(h.renderOccludedMask=Je),!this.renders(t.content))return h.renderOccludedMask=ot,!1;const{resolution:g}=r,_=e===0,p=_?0:g;if(n.setViewport(p,0,g,g),this._bindTargetFBO(t),_)if(t.output!==9)n.setClearColor(0,0,0,0),n.clear(16384);else{const{gl:y}=n;y.clearBufferuiv(y.COLOR,0,[0,0,0,0])}if(Ue.OVERLAY_DRAW_DEBUG_TEXTURE&&t.content!==4&&t.content!==2){this._techniques.precompile(Ut,ht);const y=this._techniques.get(Ut,ht);for(let F=0;F<s.numViews;F++)this._setViewParameters(s.extents[F],r),this._ensureDebugPatternResources(r.resolution,la[e]),n.bindTechnique(y,d,this._passParameters),n.screen.draw()}if(t.output===9){const{fboCache:y}=this._stage.renderer,F=this._resolution;this._bindTargetFBO(t),Hi(n,y,{width:F,height:F},d,()=>this._renderAllGeometry(e,t),p)}else this._renderAllGeometry(e,t);return n.bindFramebuffer(null),h.renderOccludedMask=ot,!0}get allSourcesOccluders(){return xt(this._renderers,e=>e.hasOnlyOccluders)}_renderAllGeometry(e,t){const r=this._overlays[e],s=r.canvasGeometries;this._sortedRenderers.forAll(({drapeSource:i,renderer:a})=>{if(t.content===1&&i.drapeSourceType===0)return;const{fullOpacity:n}=i,o=n!=null&&n<1&&t.output===0&&this._bindTemporaryFBO();for(let h=0;h<s.numViews;h++)this._setViewParameters(s.extents[h],r),a.render(this._renderContext);if(o){this._bindTargetFBO(t),this._overlayParameters.texture=o.getTexture(),this._overlayParameters.opacity=n,this._overlayParameters.overlayIndex=e;const h=this._techniques.get(kt);this._rctx.bindTechnique(h,this._bindParameters,this._overlayParameters),this._rctx.screen.draw(),o.release()}})}_bindTargetFBO(e){const t=this._resolution,r=2*t;e.fbo.ensureFramebuffer(r,t),e.fbo.bind(this._rctx)}_bindTemporaryFBO(){const e=this._resolution,t=2*e,r=this._stage.renderer.fboCache,s=r.acquire(t,e,"overlay tmp");return r.rctx.bindFramebuffer(s.fbo),r.rctx.clear(16384),s}get _resolution(){var e;return((e=this._overlays)==null?void 0:e[0].resolution)??0}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,r,s){var a;this._sortedDrapeSourceRenderersDirty&&this._updateSortedDrapeSourceRenderers();let i=0;for(const{renderer:n}of this._sortedRenderers)i=((a=n.intersect)==null?void 0:a.call(n,e,t,r,s,i))??i}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this._view.map.allLayers.map(r=>r.uid),t=e.length;this._renderers.forEach((r,s)=>{var d;const i=e.indexOf((d=s.layer)==null?void 0:d.uid),a=i>=0,n=s.renderGroup??(a?0:1),o=s.drapeSourcePriorityOffset??0,h=t*n+(a?i:0)+o;this._sortedRenderers.push(new ha(s,r,h))}),this._sortedRenderers.sort((r,s)=>r.index-s.index)}_setViewParameters(e,t){const r=this._camera;r.viewport=[0,0,t.resolution,t.resolution],Ss(r.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],r.near,r.far),Os(r.viewMatrix,[-e[0],-e[1],0])}_ensureDebugPatternResources(e,t){if(sr(this._passParameters.color,t[0],t[1],t[2]),this._passParameters.texture)return;const r=new Uint8Array(e*e*4);let s=0;for(let a=0;a<e;a++)for(let n=0;n<e;n++){const o=Math.floor(n/10),h=Math.floor(a/10);o<2||h<2||10*o>e-20||10*h>e-20?(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=255):(r[s++]=255,r[s++]=255,r[s++]=255,r[s++]=1&o&&1&h?1&n^1&a?0:255:1&o^1&h?0:128)}const i=new nr(e);i.samplingMode=9728,this._passParameters.texture=new pt(this._rctx,i,r)}get test(){}};u([v()],z.prototype,"hasHighlights",void 0),u([v()],z.prototype,"renderOccludedFlags",void 0),u([v()],z.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([v({constructOnly:!0})],z.prototype,"parent",void 0),u([v({readOnly:!0})],z.prototype,"_techniques",null),u([v({type:Boolean,readOnly:!0})],z.prototype,"updating",null),u([v()],z.prototype,"isEmpty",null),z=u([A("esri.views.3d.terrain.OverlayRenderer")],z);class ha{constructor(t,r,s){this.drapeSource=t,this.renderer=r,this.index=s}}const la=[[1,.5,.5],[.5,.5,1]],ua=-2,Je=4,ht=new gr;ht.hasAlpha=!0;let sn=class{constructor(e,t={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=V(),this._shaderTransformation=null,this._boundingSphere=null,this.id=vr(),this.layerViewUid=t.layerViewUid,this.graphicUid=t.graphicUid,this.castShadow=t.castShadow??!1,t.objectShaderTransformation&&this.objectShaderTransformationChanged(t.objectShaderTransformation)}get transformation(){return this._transformation}set transformation(e){Ts(this._transformation,e),this._boundingSphere=null}get boundingInfo(){return this.geometry.boundingInfo}objectShaderTransformationChanged(e){e==null?this._shaderTransformation=null:(this._shaderTransformation??(this._shaderTransformation=V()),tt(this._shaderTransformation,e,this.geometry.transformation)),this._boundingSphere=null}get boundingSphere(){return this.boundingInfo?(this._boundingSphere==null&&(this._boundingSphere??(this._boundingSphere=Ds()),Ms(this._boundingSphere,this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*Vs(this.shaderTransformation)),this._boundingSphere):Fs}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this._shaderTransformation??this.transformation}get attributes(){return this.geometry.attributes}get positionAttribute(){return this.geometry.positionAttribute}foreachHighlightOptions(e){this.geometry.foreachHighlightOptions(e)}get hasHighlights(){return this.geometry.hasHighlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};class ca extends is{intersect(t,r,s,i,a,n){return as(t,s,i,a,void 0,n)}intersectDraped(t,r,s,i){return ns(s[0],s[1],t,i)}}function da(e){const t=new Q,{vertex:r,fragment:s,attributes:i,varyings:a}=t,{hasVVColor:n,hasVertexColors:o}=e;return $r(r,e),t.include(jr),t.include(Nr,e),t.include(Br,e),t.include(Gr,e),s.include(Ur,e),t.include(kr,e),t.include(Qr,e),i.add("position","vec3"),n&&i.add("colorFeatureAttribute","float"),o||a.add("vColor","vec4"),a.add("vpos","vec3",{invariant:!0}),r.uniforms.add(new Xr("uColor",h=>h.color)),r.main.add(q`
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${o?"vColor *= uColor;":n?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      forwardViewPosDepth((view * vec4(vpos, 1.0)).xyz);
      gl_Position = transformPosition(proj, view, vpos);`),s.include(Yr),s.main.add(q`discardBySlice(vpos);
discardByTerrainDepth();
outputColorHighlightOID(vColor, vpos, vColor.rgb);`),t}const ga=Object.freeze(Object.defineProperty({__proto__:null,build:da},Symbol.toStringTag,{value:"Module"}));class pa extends U{constructor(t,r){super(t,r,new k(ga,()=>G(()=>import("./ImageMaterial.glsl-C9IVRq6S-CsryHqFn.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144]),import.meta.url).then(s=>s.C)),_r(r).locations)}_createPipeline(t,r){const{oitPass:s,output:i,transparent:a,cullFace:n,draped:o,hasOccludees:h,polygonOffset:d}=t,g=s===0;return N({blending:tr(i)&&a?vs(s):null,culling:Ns(n),depthTest:o?null:{func:ms(s)},depthWrite:fs(t),drawBuffers:_s(i,xs(s,i)),colorWrite:B,stencilWrite:h?ps:null,stencilTest:h?r?ds:gs:null,polygonOffset:g?d?_a:null:cs(t)})}initializePipeline(t){return this._occludeePipelineState=this._createPipeline(t,!0),this._createPipeline(t,!1)}getPipeline(t){return t?this._occludeePipelineState:super.getPipeline()}}const _a={factor:1,units:1};function _r(e){const t=he().vec3f("position");return rr()&&t.vec4u8("olidColor"),e.hasVVColor?t.f32("colorFeatureAttribute"):t.vec4u8("color"),t.freeze()}let R=class extends hs{constructor(){super(...arguments),this.cullFace=0,this.hasVertexColors=!1,this.transparent=!1,this.discardInvisibleFragments=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.terrainDepthTest=!1,this.cullAboveTerrain=!1,this.hasVVColor=!1,this.draped=!1,this.textureCoordinateType=0,this.emissionSource=0,this.occlusionPass=!1,this.olidColorInstanced=!1,this.hasVVInstancing=!1,this.hasVVSize=!1,this.hasVVOpacity=!1,this.snowCover=!1}};u([P({count:3})],R.prototype,"cullFace",void 0),u([P()],R.prototype,"hasVertexColors",void 0),u([P()],R.prototype,"transparent",void 0),u([P()],R.prototype,"discardInvisibleFragments",void 0),u([P()],R.prototype,"polygonOffset",void 0),u([P()],R.prototype,"enableOffset",void 0),u([P()],R.prototype,"writeDepth",void 0),u([P()],R.prototype,"hasOccludees",void 0),u([P()],R.prototype,"terrainDepthTest",void 0),u([P()],R.prototype,"cullAboveTerrain",void 0),u([P()],R.prototype,"hasVVColor",void 0),u([P()],R.prototype,"draped",void 0);class an extends ca{constructor(t){super(t,ma),this._configuration=new R,this.supportsEdges=!0,this.produces=new Map([[2,r=>this._isOpaqueMaterialPass(r)],[3,r=>this._isOpaqueNoSSAODepthPass(r)],[4,r=>Be(r)&&this._transparent&&this.parameters.writeDepth],[5,r=>Ct(r)&&this._transparent&&this.parameters.writeDepth],[8,r=>Be(r)&&this._transparent&&!this.parameters.writeDepth],[18,r=>Jr(r)]])}getConfiguration(t,r){return super.getConfiguration(t,r,this._configuration),this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this._transparent,this._configuration.discardInvisibleFragments=this._transparent&&!this._isOpaquePass(t)&&this.parameters.discardInvisibleFragments,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=r.hasOccludees,this._configuration.oitPass=r.oitPass,this._configuration.enableOffset=r.camera.relativeElevation<es,this._configuration.terrainDepthTest=r.terrainDepthTest&&tr(t),this._configuration.cullAboveTerrain=r.cullAboveTerrain,this._configuration.hasVVColor=!!this.parameters.vvColor,this._configuration.draped=this.parameters.draped,this._configuration}get visible(){return this.parameters.color[3]>=ts}get _transparent(){return this.parameters.color[3]<1||this.parameters.forceTransparentMode}_isOpaquePass(t){return this._isOpaqueMaterialPass(t)||this._isOpaqueNoSSAODepthPass(t)}_isOpaqueMaterialPass(t){return t===9||Be(t)&&!this._transparent}_isOpaqueNoSSAODepthPass(t){return Ct(t)&&this.parameters.writeDepth&&!this._transparent}createGLMaterial(t){return new fa(t)}createBufferWriter(){return new rs(_r(this.parameters))}}class fa extends ls{beginSlot(t){return this.getTechnique(pa,t)}}class ma extends os{constructor(){super(...arguments),this.color=Er,this.forceTransparentMode=!1,this.writeDepth=!0,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=0,this.draped=!1,this.discardInvisibleFragments=!1}}const b={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},va={dash:b.dash,"dash-dot":[...b.dash,...b.dot],dot:b.dot,"long-dash":b["long-dash"],"long-dash-dot":[...b["long-dash"],...b.dot],"long-dash-dot-dot":[...b["long-dash"],...b.dot,...b.dot],none:null,"short-dash":b["short-dash"],"short-dash-dot":[...b["short-dash"],...b["short-dot"]],"short-dash-dot-dot":[...b["short-dash"],...b["short-dot"],...b["short-dot"]],"short-dot":b["short-dot"],solid:null},xa=8;function ya(e,t){return e==null?e:{pattern:e.slice(),pixelRatio:t}}function nn(e){return{pattern:[e,e],pixelRatio:2}}function on(e){return(e==null?void 0:e.type)==="style"?ba(e.style):null}function ba(e){return e!=null?ya(va[e],xa):null}function hn(e,t,r,s){const i=e.type==="polygon"?1:0,a=e.type==="polygon"?e.rings:e.paths,{position:n,outlines:o}=ar(a,!!e.hasZ,i,e.spatialReference),h=Xt(n.length),d=Bs(n,e.spatialReference,0,h,0,n,0,n.length/3,t,r,s),g=d!=null;return{lines:g?fr(o,n,h):[],projectionSuccess:g,sampledElevation:d}}function ln(e,t){const r=e.type==="polygon"?1:0,s=e.type==="polygon"?e.rings:e.paths,{position:i,outlines:a}=ar(s,!1,r),n=Wr(i,e.spatialReference,0,i,t,0);for(let o=2;o<i.length;o+=3)i[o]=ua;return{lines:n?fr(a,i):[],projectionSuccess:n}}function fr(e,t,r=null){const s=new Array;for(const{index:i,count:a}of e){if(a<=1)continue;const n=3*i,o=3*a;s.push({position:mt(t,3*i,3*a),mapPositions:r!=null?mt(r,n,o):void 0})}return s}const un=he().vec3f("position").freeze(),cn=he().vec3f("position").vec2f16("uv0").freeze(),dn=he().vec3f("position").vec4u8("color").freeze(),gn=he().vec3f("position").vec2f("uv0").freeze(),pn=he().vec3f("position").vec2f("uv0").vec4u8("olidColor").freeze();export{j as A,cn as D,ln as F,Ri as J,dn as M,hn as P,wi as Q,un as R,nn as S,on as T,vi as U,gn as V,rn as Y,Oi as Z,Le as a,Ii as b,an as c,ca as d,Di as e,tn as f,en as g,ur as i,pr as m,cr as n,sn as p,lr as r,or as s,na as v,da as w,ua as y,pn as z};
