import{s as j,r as B,bW as E,l as Q,P as W,Y as C,v as Y,x as D,m as a,E as i,n as z}from"./index-BeTPrQ6f.js";import"./UnknownTimeZone-DzO8gKMe-d6rtFXqm.js";import{v as G,w as J,a8 as K,A as k}from"./Dictionary-B0UU8VOj-BnHchtFP.js";import{t as H}from"./commonProperties-D1Pjvz5u-DHiB1uzW.js";import{e as X}from"./arcadeEnvironment-CGtXgdl9-Db3WjmFu.js";import{c as T}from"./enum-D3e-PyKo-Bl5V5br5.js";import{q as Z,g as V,d as tt}from"./utils-CRANtbnc-C6zyufvL.js";import"./TimeOnly-BFfVS_ja-C4MPGwCM.js";import"./ImmutableArray-CiJxhY8_-Kqx7aWRu.js";import"./shared-DXZ65waB-BM-XH3jC.js";import"./Field-Dn1Bgq7n-CJCGLoNR.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./number-BsNxu9Ry-D0lLRJTw.js";let g=class extends C{constructor(o){super(o),this.text=null,this.detectedLanguage="en",this.detectedLanguageScore=-1}};a([i({type:String,json:{write:!0}})],g.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],g.prototype,"text",void 0),a([i({type:String,json:{read:{source:"detectedLanguage.language"},write:{target:"detectedLanguage.language"}}})],g.prototype,"detectedLanguage",void 0),a([i({type:Number,json:{read:{source:"detectedLanguage.score"},write:{target:"detectedLanguage.score"}}})],g.prototype,"detectedLanguageScore",void 0),a([i({type:Object,json:{write:!0}})],g.prototype,"translation",void 0),g=a([z("esri.rest.support.TranslateResult")],g);async function et(o,s,r){const t=s.toJSON();t.contents=JSON.stringify(t.contents),t.token=await Z(s.portalUrl,s.apiKey,{signal:r==null?void 0:r.signal,prompt:(r==null?void 0:r.authMode)!=="no-prompt"});const n=V(o),e=tt(n.query,{...r,query:t,method:"post",authMode:"anonymous"});return(await Y(n.path,e)).data.results.map(c=>g.fromJSON(c))}let S=class extends C{constructor(o){super(o)}};a([i({type:String,json:{write:!0}})],S.prototype,"key",void 0),a([i({type:String,json:{write:!0}})],S.prototype,"text",void 0),S=a([z("esri.rest.support.TranslateContent")],S);let p=class extends C{constructor(o){super(o),this.to=null,this.contents=null,this.portalUrl="https://www.arcgis.com",this.translator="esri",this.from=null,this.apiKey=null,this.requestSource=null}};a([i({type:[String],json:{write:!0}})],p.prototype,"to",void 0),a([i({type:[S],json:{write:!0}})],p.prototype,"contents",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"portalUrl",void 0),a([i({type:String,json:{write:!0,default:"esri"}})],p.prototype,"translator",void 0),a([i({type:String,json:{write:!0}})],p.prototype,"from",void 0),a([i(H)],p.prototype,"apiKey",void 0),a([i({type:String,json:{name:"x-esri-request-source"}})],p.prototype,"requestSource",void 0),p=a([z("esri.rest.support.TranslateParameters")],p);class b{constructor(s,r){this.portal=s,this._debugLog=r}async translate(s){var n;this.portal.loaded||await this.portal.load();const r=(n=this.portal.helperServices)==null?void 0:n.aiUtilityServices;if(r==null)return{success:!1};const t=r.url+r.translateUtility;try{return s.requestSource??(s.requestSource="arcade"),{success:!0,results:(await et(t,s,{authMode:"no-prompt"})).map(e=>e.toJSON())}}catch(e){return this._debugLog!=null&&(e instanceof Error||e instanceof Q)&&this._debugLog(`TranslateText error: ${e.message}`),W.getLogger("esri.arcade.functions.aiServices").error(e),{success:!1}}}}class rt{constructor(s,r,t){this._parameters=s,this._maxTotalContentSize=r,this._maxContentsLength=t,this._requests=[],this._normalizedContents=new Map,this._contentsTotalSize=0}tryAdd(s){const r=new Set(s.filter(e=>!this._normalizedContents.has(e.text)).map(e=>e.text));if(this._requests.length+r.size>this._maxContentsLength)return null;let t=0;for(const e of r)t+=e.length;if((t+this._contentsTotalSize)*(this._parameters.to.length??1)>this._maxTotalContentSize)return null;const n=this._requests.length;for(const{key:e,text:c}of s)D(this._normalizedContents,c,()=>[]).push({batchIdx:n,key:e});return this._requests.push(s),this._contentsTotalSize+=t,n}async send(s){const r=[],t=[];let n=0;for(const[y,f]of this._normalizedContents)r.push(new S({key:String(n++),text:y})),t.push(f);const e=new p(this._parameters);e.contents=r;const c=await s.translate(e);if(!c.success)return Array.from(this._requests,()=>c);const v=Array.from(this._requests,()=>({success:!0,results:[]}));for(const y of c.results){const f=Number(y.key);for(const h of t[f])v[h.batchIdx].results.push({...y,key:h.key})}return v}}function L(o){const s=[...new Set(o.to)].sort(),r=o.from??null,t=o.portalUrl,n=o.translator,e=o.apiKey??null;return JSON.stringify([s,r,t,n,e])}async function $(o,s,r){try{return(await o.yieldFor(r))[s]}catch{return{success:!1}}}class F{constructor(s,r,{maxTotalContentSize:t=5e4,maxContentsLength:n=1e3}={}){this._executor=s,this._service=r,this._openBatches=new Map,this._maxTotalContentSize=t,this._maxContentsLength=n}create(s){return{translate:async r=>{const t=L(r),{contents:n,to:e,from:c,translator:v,portalUrl:y,apiKey:f}=r;if(e==null)return{success:!1};if(n==null||n.every(u=>u.text.length===0))return{success:!1};const h=this._openBatches.get(t);if(h!=null){const u=h.data.tryAdd(n);if(u!=null)return await $(s,u,h);h.send()}const d=new rt({to:e,from:c,translator:v,portalUrl:y,apiKey:f},this._maxTotalContentSize,this._maxContentsLength),x=d.tryAdd(n);if(x!=null){const u=this._executor.openBatch(d,{open:w=>{this._openBatches.set(t,w)},execute:w=>w.send(this._service),close:w=>{this._openBatches.get(t)===w&&this._openBatches.delete(t)}});return await $(s,x,u)}return await this._service.translate(r)}}}}function I(o){o.mode==="async"&&(o.functions[X("TranslateText")]=function(s,r){return o.standardFunctionAsync(s,r,async(t,n,e)=>{var q,O,P,A,N,U;if(G(e,2,3,t,n),!j(e[0])&&!B(e[0])&&!J(e[0]))throw new T(t,"InvalidParameter",n);const c=K(e[0]);if(!j(e[1])&&!B(e[1])&&!J(e[1]))throw new T(t,"InvalidParameter",n);const v=K(e[1]);let y=null;if(e.length>=3){if(!j(e[2]))throw new T(t,"InvalidParameter",n);y=e[2]}const f=c.map((m,l)=>new S({key:String(l),text:m})),h=((q=t.services)==null?void 0:q.portal)??E.getDefault(),d=new p({to:v,contents:f,from:y,portalUrl:h.restUrl.replace(/\/sharing\/rest$/,"")}),x=new Map;let u=null;if(t.lrucache!=null){const m=t.lrucache;u??(u=L(d)),d.contents=(O=d.contents)==null?void 0:O.filter(l=>{const _=m.getCachedTranslation(u,l.text);return _==null||(x.set(l.key,{..._,key:l.key,text:l.text}),!1)})}if((P=d.contents)!=null&&P.length){const m=((A=t.services)==null?void 0:A.translation)??new b(h,t.console),l=await m.translate(d);if(!l.success)return new k({__proto__:null,success:!1});for(const _ of l.results){const M=(U=(N=d.contents)==null?void 0:N.find(R=>R.key===_.key))==null?void 0:U.text;if(M==null)throw new T(null,"NeverReach",null);x.set(_.key,_),t.lrucache!=null&&(u??(u=L(d)),t.lrucache.setCachedTranslation(u,M,{detectedLanguage:_.detectedLanguage,translation:_.translation}))}}const w=Array.from(f,m=>{const l=g.fromJSON(x.get(m.key));if(l==null)throw new T(null,"NeverReach",null);return l.text=m.text,k.convertJsonToArcade(l.toJSON(),t.timeZone??"system",!0)});return new k({__proto__:null,success:!0,results:w})})})}const ft=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:F,PortalTranslationService:b,getTranslateParametersKey:L,registerFunctions:I},Symbol.toStringTag,{value:"Module"})),mt=Object.freeze(Object.defineProperty({__proto__:null,BatchTranslationServiceFactory:F,PortalTranslationService:b,getTranslateParametersKey:L,registerFunctions:I},Symbol.toStringTag,{value:"Module"}));export{ft as T,mt as a};
