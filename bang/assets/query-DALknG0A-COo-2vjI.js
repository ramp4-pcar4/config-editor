import{t as g,v as E,cl as b,b$ as S,c1 as j}from"./index-BeTPrQ6f.js";import{Y as F}from"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import{v as I}from"./pbfQueryUtils-DYXcN4x1-BpgjQRlR.js";import{n as R}from"./queryZScale-B66ZWsfS-D7Zc2_Zh.js";function x(r){const t={};for(const i in r){if(i==="declaredClass")continue;const a=r[i];if(a!=null&&typeof a!="function")if(Array.isArray(a)){t[i]=[];for(let u=0;u<a.length;u++)t[i][u]=x(a[u])}else typeof a=="object"?a.toJSON&&(t[i]=JSON.stringify(a)):t[i]=a}return t}function q(r,t){if(t&&r.type==="extent")return`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;if(t&&r.type==="point")return`${r.x},${r.y}`;const i=r.toJSON();return delete i.spatialReference,JSON.stringify(i)}function J(r,t,i){var d,p;const{geometry:a}=r,u=r.compactGeometryEnabled??!1,e=r.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let s,o,l;if(a&&(o=a.spatialReference,l=S(o),n.geometryType=j(a),n.geometry=q(a,u),n.inSR=l),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch((d=i==null?void 0:i.uniqueIdFields)==null?void 0:d.length){case void 0:n.objectIds=e.objectIds.join(",");break;case 1:n.uniqueIds=JSON.stringify(e.objectIds),delete n.objectIds;break;default:n.uniqueIds=JSON.stringify(e.objectIds.map(f=>JSON.parse(f))),delete n.objectIds}if(e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete n.outFields:e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","),e.outSR?(n.outSR=S(e.outSR),s=r.outSpatialReference):a&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,s=o),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(n.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(r.defaultSpatialReferenceEnabled&&o!=null&&((p=r.quantizationParameters)==null?void 0:p.extent)!=null&&o.equals(r.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const f=e.timeExtent,{start:y,end:m}=f;y==null&&m==null||(n.time=y===m?y:`${y??"null"},${m??"null"}`),delete e.timeExtent}return r.defaultSpatialReferenceEnabled&&o!=null&&s!=null&&o.equals(s)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}const O="Layer does not support extent calculation.";function N(r,t,i){return J(r,t,i)}async function B(r,t,i,a,u){var n;const e=(n=t.timeExtent)!=null&&n.isEmpty?{data:{features:[]}}:await c(r,t,"json",a,void 0,u);return R(t,i,e.data),e}async function C(r,t,i,a,u){var s;if((s=t.timeExtent)!=null&&s.isEmpty)return{data:i.createFeatureResult()};const e=await w(r,t,a,u),n=e;return n.data=I(e.data,i),n}function w(r,t,i,a){return c(r,t,"pbf",i,void 0,a)}function D(r,t,i,a){var u;return(u=t.timeExtent)!=null&&u.isEmpty?Promise.resolve({data:{objectIds:[]}}):c(r,t,"json",i,{returnIdsOnly:!0},a)}function G(r,t,i,a){var u;return(u=t.timeExtent)!=null&&u.isEmpty?Promise.resolve({data:{count:0}}):c(r,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0},a)}async function T(r,t,i){var e;if((e=t.timeExtent)!=null&&e.isEmpty)return{data:{count:0,extent:null}};const a=await c(r,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}),u=a.data;if(u.hasOwnProperty("extent"))return a;if(u.features)throw new Error(O);if(u.hasOwnProperty("count"))throw new Error(O);return a}function P(r,t){if(!r.returnIdsOnly||!t.uniqueIdFields)return r;const i={...r,returnUniqueIdsOnly:!0};return delete i.returnIdsOnly,i}async function c(r,t,i,a={},u={},e={}){const n=typeof r=="string"?g(r):r,s=t.geometry?[t.geometry]:[],o=await F(s,null,{signal:a.signal}),l=o==null?void 0:o[0];l!=null&&((t=t.clone()).geometry=l);const d=x({...n.query,f:i,...P(u,e),...N(t,u,e)});return E(b(n.path,z(t,u)?"query3d":"query"),{...a,responseType:i==="pbf"?"array-buffer":"json",query:{...d,...a.query}})}function z(r,t){return r.formatOf3DObjects!=null&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}export{T as $,B as N,D as P,J as S,x as m,C as w,w as x,G as z};
