import{df as b,gK as $,k0 as E,f_ as W}from"./index-DLCK036j.js";import{y as z,i as J}from"./memoryEstimations-iHVpvWPf-BTDcSgIs.js";import{k as R}from"./mat4-BFStKTjU-DBxfiOb6.js";import{n as k,a as N}from"./mat4f64-BaJwL7tQ-k0uMm8LY.js";import{P as V,Z as j,N as B,b as H,_ as T,l as X}from"./vec32-BuqRmYBM-B6LKH8XJ.js";import{D as K}from"./vec42-D8CJyqHG-DnfLTeQH.js";import{o as Q}from"./vec4f64-CjUMzAyX-DPYbdAom.js";import{d as g,$ as Z,a as w}from"./sphere-Cj20syUS-Db4FwWQN.js";import{l as M}from"./ViewingMode-CyR_b1T8-_s7_Gbsk.js";import{R as q,s as S,w as f}from"./HUDVisibility.glsl-Bl7zdrV0-ClckOf3K.js";import"./boundedPlane-B6TkXVHT-BTRqax35.js";import{aO as F,aC as A}from"./VerticalOffset.glsl-BtVaDxLq-gQz94lE0.js";import{T as Y}from"./VertexAttribute-DFC3a3eR-BhmQtMsu.js";import"./glsl-o28TenZV-B0eZUNn3.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f64-CEUyUoff-BBc0aQ6D.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./ShaderBuilder-BkQM64Qp-DlFViasq.js";import{O as tt,a as rt,f as et,P as st,j as it}from"./DefaultMaterial-DGGIMylx-Bl4m030w.js";import"./ShaderOutput-C_OqLoo1-jp3zUBgm.js";import"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import"./mat3-DOnW3DjW-C3hbW9XY.js";import"./NormalAttribute.glsl-C9zbIKka-9UiIJHzD.js";import"./renderState-DlSSrLcZ-Du_EmLq6.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./plane-B_adY3_o-MuWsfH1u.js";import"./quatf64-C16JxGFv-BKWK1F8U.js";import"./doublePrecisionUtils-BJbYwoii-kIP-tL_t.js";import"./vec3f32-BS0cezmI-B_madU1n.js";import"./Indices-DkAzsiH--Bv6wE1L-.js";import"./orientedBoundingBox-CTsjUkMw-DFn2um4v.js";import"./quat-D8L_R4I0-DyTOKKDO.js";import"./spatialReferenceEllipsoidUtils-DlQOpWof-BTUKynN1.js";import"./computeTranslationToOriginAndRotation-DwwrTl3S-BIgW569V.js";import"./projection-m8vi7Cxv-BuVyJKtc.js";import"./InterleavedLayout-DcHoXu73-CPklf7xZ.js";import"./BufferView-BBCzkcZS-DCLgUUyi.js";import"./meshVertexSpaceUtils-BwEbYR8F-Vcrohgo4.js";import"./MeshLocalVertexSpace-DFCiKNRA-Co-l-LUn.js";import"./projectVectorToVector-D0K_S4MR-BrbAo-oG.js";import"./projectPointToVector-CG1hALQu-CmOjuJi0.js";import"./hydratedFeatures-BDT5zTGB-BzvR55kJ.js";import"./lineSegment-BJNfNZM5-DSWDhcUE.js";import"./triangle-BePBrXJ8-DaX5Vh2n.js";import"./lengthUtils-wU9RRIqK-6yOWjVC2.js";import"./requestImageUtils-rT_rMd2F-BeHmJYHI.js";import"./TextureFormat-Cl0ugX3E-DD0Aw8RG.js";import"./enums-DBi1-Mm2-CUS1pvQe.js";import"./Texture-DXSFJsEu-KPku1bq4.js";import"./signal-DxzURL18-CRkfADK_.js";import"./getDataTypeBytes-HSdrWtlL-ClHsCcSN.js";class nt{constructor(t,r,e){this.object=t,this.geometryId=r,this.triangleNr=e}}class ot extends nt{constructor(t,r,e,s){super(t,r,e),this.center=s!=null?W(s):null}}class at{constructor(t){this.layerUid=t}}let lt=class extends at{constructor(i,t){super(i),this.graphicUid=t}};function I(i){return(i==null?void 0:i.dist)!=null}class ht extends lt{constructor(t,r,e,s,n){super(t,r),this.layerUid=t,this.graphicUid=r,this.triangleNr=e,this.baseBoundingSphere=s,this.numLodLevels=n}}const P=1e-5;class mt{constructor(t){this.options=new q,this._results=new ut,this.transform=new F,this.tolerance=P,this.verticalOffset=null,this._ray=g(),this._rayEnd=b(),this._rayBeginTransformed=b(),this._rayEndTransformed=b(),this.viewingMode=t??M.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,r,e){this.resetWithRay(Z(t,r,this._ray),e)}resetWithRay(t,r){this.camera=r,t!==this._ray&&w(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===M.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,V(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,r,e,s,n){var l;this.point=r,this.filterPredicate=s,this.tolerance=e??P;const a=A(this.verticalOffset);if(t&&t.length>0){const h=n?o=>{n(o)&&this.intersectObject(o)}:o=>{this.intersectObject(o)};for(const o of t){const m=(l=o.getSpatialQueryAccelerator)==null?void 0:l.call(o);m!=null?(a!=null?m.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,h,a):m.forEachAlongRay(this._ray.origin,this._ray.direction,h),this.options.selectionMode&&this.options.hud&&m.forEachDegenerateObject(h)):o.objects.forAll(c=>h(c))}}this.sortResults()}intersectObject(t){const r=t.geometries;if(!r)return;const e=t.effectiveTransformation,s=A(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:a,id:l}=n;if(!a.visible)continue;this.transform.setAndInvalidateLazyTransforms(e,n.transformation),j(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),j(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;s!=null&&(s.objectTransform=this.transform),a.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(o,m,c,p,y,L)=>{if(o>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,o))return;const u=p?this._results.hud:this._results,v=p?d=>{const D=new ot(t,l,c,L);d.set(f.HUD,D,o,m,N,y)}:d=>d.set(f.OBJECT,{object:t,geometryId:l,triangleNr:c},o,m,h,y);if((u.min.drapedLayerOrder==null||y>=u.min.drapedLayerOrder)&&(u.min.dist==null||o<u.min.dist)&&v(u.min),this.options.store!==S.MIN&&(u.max.drapedLayerOrder==null||y<u.max.drapedLayerOrder)&&(u.max.dist==null||o>u.max.dist)&&v(u.max),this.options.store===S.ALL)if(p){const d=new G(this._ray);v(d),this._results.hud.all.push(d)}else{const d=new _(this._ray);v(d),this._results.all.push(d)}}})}}sortResults(t=this._results.all){t.sort((r,e)=>r.dist!==e.dist?(r.dist??0)-(e.dist??0):r.drapedLayerOrder!==e.drapedLayerOrder?U(r.drapedLayerOrder,e.drapedLayerOrder):U(r.drapedLayerGraphicOrder,e.drapedLayerGraphicOrder))}}function U(i,t){return(t??-Number.MAX_VALUE)-(i??-Number.MAX_VALUE)}function ur(i){return new mt(i)}class ut{constructor(){this.min=new _(g()),this.max=new _(g()),this.hud={min:new G(g()),max:new G(g()),all:new Array},this.ground=new _(g()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class _{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(B(x,this.ray.direction,this.dist),H(x)):null}withinDistance(t){return!!I(this)&&this.distanceInRenderSpace<=t}getIntersectionPoint(t){return!!I(this)&&(B(x,this.ray.direction,this.dist),V(t,this.ray.origin,x),!0)}getTransformedNormal(t){return T(O,this.normal),O[3]=0,K(O,O,this.transformation),T(t,O),X(t,t)}constructor(t){this.intersector=f.OBJECT,this.normal=b(),this.transformation=k(),this._ray=g(),this.init(t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=f.OBJECT,w(t,this._ray)}set(t,r,e,s,n,a,l){this.intersector=t,this.dist=e,T(this.normal,s??$),R(this.transformation,n??N),this.target=r,this.drapedLayerOrder=a,this.drapedLayerGraphicOrder=l}copy(t){w(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,T(this.normal,t.normal),R(this.transformation,t.transformation)}}class G extends _{constructor(){super(...arguments),this.intersector=f.HUD}}function ct(i){return new _(i)}const x=b(),O=Q();class dt{constructor(t,r,e,s){this.material=t,this.bufferWriter=t.createBufferWriter(),this.vertexBufferLayout=this.bufferWriter.vertexBufferLayout,this.buffer=r,this.elementCount=e,this.boundingInfo=s}get numTriangles(){return this.elementCount/3}get numVertices(){return this.elementCount}computeUsedMemory(){return this.buffer.byteLength+z}getRenderGeometry(){return this}intersect(t,r,e,s,n,a,l,h){const o=this.bufferWriter,m=this.buffer;o.intersect(m,t,e,s,(c,p,y,L,u)=>C(c,p,y,u,t,r,a,l,n,h))}}class cr{constructor(t){this.engineGeometry=t}get material(){return this.engineGeometry.material}get numVertices(){return this.engineGeometry.attributes.get(Y.POSITION).indices.length}get numTriangles(){return this.engineGeometry.indexCount/3}get boundingInfo(){return this.engineGeometry.boundingInfo}computeUsedMemory(){return Array.from(this.engineGeometry.attributes.values()).reduce((t,r)=>t+J(r.data,r.indices),0)}getRenderGeometry(){const t=this.material,r=this.engineGeometry,e=r.attributes,s=r.boundingInfo,n=t.createBufferWriter(),a=n.vertexBufferLayout,l=n.elementCount(e),h=a.createBuffer(l);return n.write(null,null,e,null,h,0),new dt(t,h.buffer,l,s)}intersect(t,r,e,s,n,a,l,h){const o=this.engineGeometry;this.material.intersect(o,t.transform.transform,t,e,s,(m,c,p,y,L)=>C(m,c,p,L,t,r,a,l,n,h))}}function C(i,t,r,e,s,n,a,l,h,o){if(i<0||n&&!n(s.rayBegin,s.rayEnd,i))return;const m=new ht(a.layerUid,a.graphicUid(h),r,l,o);if((s.results.min.drapedLayerOrder==null||e>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||i<s.results.min.dist)&&s.results.min.set(f.LOD,m,i,t,s.transform.transform,e),s.options.store!==S.MIN&&(s.results.max.drapedLayerOrder==null||e>=s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||i>s.results.max.dist)&&s.results.max.set(f.LOD,m,i,t,s.transform.transform,e),s.options.store===S.ALL){const c=ct(s.results.min.ray);c.set(f.LOD,m,i,t,s.transform.transform,e),s.results.all.push(c)}}class dr{constructor(t,r=null){this.geometry=t,this.textures=r}get material(){return this.geometry.material}get numTriangles(){return this.geometry.numTriangles}}class fr{constructor(t,r,e){this.components=t,this.minScreenSpaceRadius=r,this.pivotOffset=e;const s=E(this.components.map(n=>n.geometry));this.numVertices=s.reduce((n,a)=>n+a.numVertices,0)}}class pr{constructor(t){this.levels=t,this.levels.sort((r,e)=>r.minScreenSpaceRadius===e.minScreenSpaceRadius?r.numVertices-e.numVertices:r.minScreenSpaceRadius-e.minScreenSpaceRadius)}getMaterials(){const t=[];return this.levels.forEach(r=>r.components.forEach(e=>t.push(e.geometry.material))),E(t)}getTextures(){const t=new Array;return this.levels.forEach(r=>r.components.forEach(e=>{e.textures!=null&&t.push(...e.textures)})),E(t)}getGeometries(){const t=new Array;return this.levels.forEach(r=>r.components.forEach(e=>{t.push(e.geometry)})),E(t)}getEngineGeometries(){return this.getGeometries().map(t=>t.engineGeometry).filter(t=>t!=null)}computeUsedMemory(){const t=this.getGeometries(),r=this.getTextures(),e=t.reduce((s,n)=>s+n.computeUsedMemory(),0);return r.reduce((s,n)=>s+n.memoryEstimate,0)+e}}const yr=Object.freeze(Object.defineProperty({__proto__:null,build:tt},Symbol.toStringTag,{value:"Module"})),gr=Object.freeze(Object.defineProperty({__proto__:null,build:rt,getRadius:et},Symbol.toStringTag,{value:"Module"})),_r=Object.freeze(Object.defineProperty({__proto__:null,build:st},Symbol.toStringTag,{value:"Module"})),Or=Object.freeze(Object.defineProperty({__proto__:null,build:it},Symbol.toStringTag,{value:"Module"}));export{_r as D,Or as R,yr as S,ur as T,cr as a,gr as b,fr as f,pr as h,dr as l,dt as m};
