import{v as E,S as q,I as Ct,n as Rt,aA as Lt,X as jt,h as Gt,q as Nt,a6 as Y,fg as pt,an as tt,u as Et,fh as bt,at as Ot,o as qt,ay as Wt}from"./index-BfiF9x66.js";import{N as ct}from"./pixelRangeUtils-DcEknavd-CueOHV1N.js";let vt=class{constructor(t=null,e=null,n=null){this.minValue=t,this.maxValue=e,this.noDataValue=n}};var J;let V=J=class extends jt{static createEmptyBand(t,e){return new(J.getPixelArrayConstructor(t))(e)}static combineBandMasks(t){if(t.length<2)return t[0];const e=t[0].length,n=new Uint8Array(e).fill(255);for(let s=0;s<t.length;s++){const r=t[s];for(let i=0;i<e;i++)r[i]||(n[i]=0)}return n}static getPixelArrayConstructor(t){let e;switch(t){case"u1":case"u2":case"u4":case"u8":e=Uint8Array;break;case"u16":e=Uint16Array;break;case"u32":e=Uint32Array;break;case"s8":e=Int8Array;break;case"s16":e=Int16Array;break;case"s32":e=Int32Array;break;case"f32":case"c64":case"c128":case"unknown":e=Float32Array;break;case"f64":e=Float64Array}return e}constructor(t){super(t),this.width=null,this.height=null,this.pixelType="f32",this.validPixelCount=null,this.mask=null,this.maskIsAlpha=!1,this.premultiplyAlpha=!1,this.statistics=null,this.depthCount=1}castPixelType(t){if(!t)return"f32";let e=t.toLowerCase();return["u1","u2","u4"].includes(e)?e="u8":["unknown","u8","s8","u16","s16","u32","s32","f32","f64"].includes(e)||(e="f32"),e}getPlaneCount(){var t;return(t=this.pixels)==null?void 0:t.length}addData(t){if(!t.pixels||t.pixels.length!==this.width*this.height)throw new Gt("pixelblock:invalid-or-missing-pixels","add data requires valid pixels array that has same length defined by pixel block width * height");this.pixels||(this.pixels=[]),this.statistics||(this.statistics=[]),this.pixels.push(t.pixels),this.statistics.push(t.statistics??new vt)}getAsRGBA(){const t=new ArrayBuffer(this.width*this.height*4);switch(this.pixelType){case"s8":case"s16":case"u16":case"s32":case"u32":case"f32":case"f64":this._fillFromNon8Bit(t);break;default:this._fillFrom8Bit(t)}return new Uint8ClampedArray(t)}getAsRGBAFloat(){const t=new Float32Array(this.width*this.height*4);return this._fillFrom32Bit(t),t}updateStatistics(){if(!this.pixels)return;this.statistics=this.pixels.map(n=>$t(n,this.mask));const t=this.mask;let e=0;if(t!=null)for(let n=0;n<t.length;n++)t[n]&&e++;else e=this.width*this.height;this.validPixelCount=e}clamp(t){if(!t||t==="f64"||t==="f32"||!this.pixels)return;const[e,n]=ct(t),s=this.pixels,r=this.width*this.height,i=s.length;let l,c,a;const o=[];for(let f=0;f<i;f++){a=J.createEmptyBand(t,r),l=s[f];for(let h=0;h<r;h++)c=l[h],a[h]=c>n?n:c<e?e:c;o.push(a)}this.pixels=o,this.pixelType=t}extractBands(t){var h;const{pixels:e,statistics:n}=this;if(t==null||t.length===0||!e||e.length===0)return this;const s=e.length,r=t.some(p=>p>=e.length),i=s===t.length&&!t.some((p,u)=>p!==u);if(r||i)return this;const l=((h=this.bandMasks)==null?void 0:h.length)===s?t.map(p=>this.bandMasks[p]):void 0;let{mask:c,validPixelCount:a}=this;const{width:o,height:f}=this;return l!=null&&l.length&&(c=J.combineBandMasks(l),a=c.filter(p=>!!p).length),new J({pixelType:this.pixelType,width:o,height:f,mask:c,bandMasks:l,validPixelCount:a,maskIsAlpha:this.maskIsAlpha,pixels:t.map(p=>e[p]),statistics:n&&t.map(p=>n[p])})}clone(){const t=new J({width:this.width,height:this.height,pixelType:this.pixelType,maskIsAlpha:this.maskIsAlpha,validPixelCount:this.validPixelCount});let e;this.mask!=null&&(t.mask=new Uint8Array(this.mask)),this.bandMasks&&(t.bandMasks=this.bandMasks.map(s=>new Uint8Array(s)));const n=J.getPixelArrayConstructor(this.pixelType);if(this.pixels&&this.pixels.length>0){t.pixels=[];const s=!!this.pixels[0].slice;for(e=0;e<this.pixels.length;e++)t.pixels[e]=s?this.pixels[e].slice():new n(this.pixels[e])}if(this.statistics)for(t.statistics=[],e=0;e<this.statistics.length;e++)t.statistics[e]=Nt(this.statistics[e]);return t.premultiplyAlpha=this.premultiplyAlpha,t}_fillFrom8Bit(t){const{mask:e,maskIsAlpha:n,premultiplyAlpha:s,pixels:r}=this;if(!t||!(r!=null&&r.length))return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");let i,l,c,a;i=l=c=r[0],r.length>=3?(l=r[1],c=r[2]):r.length===2&&(l=r[1]);const o=new Uint32Array(t),f=this.width*this.height;if(i.length===f)if(e!=null&&e.length===f)if(n)for(a=0;a<f;a++){const h=e[a];if(h){const p=h/255;o[a]=s?h<<24|c[a]*p<<16|l[a]*p<<8|i[a]*p:h<<24|c[a]<<16|l[a]<<8|i[a]}}else for(a=0;a<f;a++)e[a]&&(o[a]=255<<24|c[a]<<16|l[a]<<8|i[a]);else for(a=0;a<f;a++)o[a]=255<<24|c[a]<<16|l[a]<<8|i[a];else Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.")}_fillFromNon8Bit(t){const{pixels:e,mask:n,statistics:s}=this;if(!t||!(e!=null&&e.length))return void Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The input pixel block is empty.");const r=this.pixelType;let i=1,l=0,c=1;if(s&&s.length>0){for(const m of s)if(m.minValue!=null&&(l=Math.min(l,m.minValue)),m.maxValue!=null&&m.minValue!=null){const w=m.maxValue-m.minValue;c=Math.max(c,w)}i=255/c}else{let m=255;r==="s8"?(l=-128,m=127):r==="u16"?m=65535:r==="s16"?(l=-32768,m=32767):r==="u32"?m=4294967295:r==="s32"?(l=-2147483648,m=2147483647):r==="f32"?(l=-34e38,m=34e38):r==="f64"&&(l=-Number.MAX_VALUE,m=Number.MAX_VALUE),i=255/(m-l)}const a=new Uint32Array(t),o=this.width*this.height;let f,h,p,u,d;if(f=h=p=e[0],f.length!==o)return Y.getLogger(this).error("getAsRGBA()","Unable to convert to RGBA. The pixelblock is invalid.");if(e.length>=2)if(h=e[1],e.length>=3&&(p=e[2]),n!=null&&n.length===o)for(u=0;u<o;u++)n[u]&&(a[u]=255<<24|(p[u]-l)*i<<16|(h[u]-l)*i<<8|(f[u]-l)*i);else for(u=0;u<o;u++)a[u]=255<<24|(p[u]-l)*i<<16|(h[u]-l)*i<<8|(f[u]-l)*i;else if(n!=null&&n.length===o)for(u=0;u<o;u++)d=(f[u]-l)*i,n[u]&&(a[u]=255<<24|d<<16|d<<8|d);else for(u=0;u<o;u++)d=(f[u]-l)*i,a[u]=255<<24|d<<16|d<<8|d}_fillFrom32Bit(t){const{pixels:e,mask:n}=this;if(!t||!(e!=null&&e.length))return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The input pixel block is empty.");let s,r,i,l;s=r=i=e[0],e.length>=3?(r=e[1],i=e[2]):e.length===2&&(r=e[1]);const c=this.width*this.height;if(s.length!==c)return Y.getLogger(this).error("getAsRGBAFloat()","Unable to convert to RGBA. The pixelblock is invalid.");let a=0;if(n!=null&&n.length===c)for(l=0;l<c;l++)t[a++]=s[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1&n[l];else for(l=0;l<c;l++)t[a++]=s[l],t[a++]=r[l],t[a++]=i[l],t[a++]=1}};function $t(t,e){let n=1/0,s=-1/0;const r=t.length;let i,l=0;if(e!=null)for(i=0;i<r;i++)e[i]&&(l=t[i],n=l<n?l:n,s=l>s?l:s);else for(i=0;i<r;i++)l=t[i],n=l<n?l:n,s=l>s?l:s;return new vt(n,s)}E([q({json:{write:!0}})],V.prototype,"width",void 0),E([q({json:{write:!0}})],V.prototype,"height",void 0),E([q({json:{write:!0}})],V.prototype,"pixelType",void 0),E([Ct("pixelType")],V.prototype,"castPixelType",null),E([q({json:{write:!0}})],V.prototype,"validPixelCount",void 0),E([q({json:{write:!0}})],V.prototype,"mask",void 0),E([q({json:{write:!0}})],V.prototype,"maskIsAlpha",void 0),E([q({json:{write:!0}})],V.prototype,"pixels",void 0),E([q()],V.prototype,"premultiplyAlpha",void 0),E([q({json:{write:!0}})],V.prototype,"statistics",void 0),E([q({json:{write:!0}})],V.prototype,"depthCount",void 0),E([q({json:{write:!0}})],V.prototype,"noDataValues",void 0),E([q({json:{write:!0}})],V.prototype,"bandMasks",void 0),V=J=E([Rt("esri.layers.support.PixelBlock")],V);var dt,mt;(function(t){t[t.matchAny=0]="matchAny",t[t.matchAll=1]="matchAll"})(dt||(dt={})),function(t){t[t.bestMatch=0]="bestMatch",t[t.fail=1]="fail"}(mt||(mt={}));const gt=9;function L(t){var e;return t!=null&&((e=t.pixels)==null?void 0:e.length)>0}function me(t){var f;if(!(t!=null&&t.length)||t.some(h=>!L(h)))return null;if(t.length===1)return((f=t[0])==null?void 0:f.clone())??null;const e=t,{width:n,height:s,pixelType:r}=e[0];if(e.some(h=>h.width!==n||h.height!==s))return null;const i=e.map(({mask:h})=>h).filter(h=>h!=null);let l=null;i.length&&(l=new Uint8Array(n*s),l.set(i[0]),i.length>1&&Tt(i.slice(1),l));const c=[];e.forEach(({pixels:h})=>c.push(...h));const a=e.map(({statistics:h})=>h).filter(h=>h==null?void 0:h.length),o=[];return a.forEach(h=>o.push(...h)),new V({pixelType:r,width:n,height:s,mask:l,pixels:c,statistics:o.length?o:null})}function ge(t){if(!t)return;const e=t.colormap;if(!e||e.length===0)return;const n=e.sort((a,o)=>a[0]-o[0]),s=n[0][0]<0?n[0][0]:0,r=Math.max(256,n[n.length-1][0]-s+1),i=new Uint8Array(4*r),l=[],c=n[0].length===5;if(r>65536)return n.forEach(a=>{l[a[0]-s]=c?a.slice(1):a.slice(1).concat([255])}),{indexed2DColormap:l,offset:s,alphaSpecified:c};if(t.fillUnspecified){let a=n[0];for(let o=a[0]-s,f=0;o<r;o++)i[4*o]=a[1],i[4*o+1]=a[2],i[4*o+2]=a[3],i[4*o+3]=c?a[4]:255,o===a[0]-s&&(a=f===n.length-1?a:n[++f])}else for(let a=0;a<n.length;a++){const o=n[a],f=4*(o[0]-s);i[f]=o[1],i[f+1]=o[2],i[f+2]=o[3],i[f+3]=c?o[4]:255}return{indexedColormap:i,offset:s,alphaSpecified:c}}function xe(t,e){if(!L(t)||!e||!e.indexedColormap&&!e.indexed2DColormap)return t;const n=t.clone(),s=n.pixels;let r=n.mask;const i=n.width*n.height;if(s.length!==1)return t;const{indexedColormap:l,indexed2DColormap:c,offset:a,alphaSpecified:o}=e,f=s[0],h=new Uint8Array(f.length),p=new Uint8Array(f.length),u=new Uint8Array(f.length);let d,m=0;if(l){const w=l.length-1;if(r!=null)for(let x=0;x<i;x++)r[x]&&(m=4*(f[x]-a),m<a||m>w?r[x]=0:(h[x]=l[m],p[x]=l[m+1],u[x]=l[m+2],r[x]=l[m+3]));else{r=new Uint8Array(i);for(let x=0;x<i;x++)m=4*(f[x]-a),m<a||m>w?r[x]=0:(h[x]=l[m],p[x]=l[m+1],u[x]=l[m+2],r[x]=l[m+3]);n.mask=r}}else if(c)if(r!=null)for(let w=0;w<i;w++)r[w]&&(d=c[f[w]],h[w]=d[0],p[w]=d[1],u[w]=d[2],r[w]=d[3]);else{r=new Uint8Array(i);for(let w=0;w<i;w++)d=c[f[w]],h[w]=d[0],p[w]=d[1],u[w]=d[2],r[w]=d[3];n.mask=r}return n.pixels=[h,p,u],n.statistics=null,n.pixelType="u8",n.maskIsAlpha=o,n}function we(t,e){if(!L(t))return null;const{pixels:n,mask:s}=t,r=n.length;let i=e.lut;const{offset:l}=e;i&&i[0].length===1&&(i=n.map(()=>i));const c=[],a=e.outputPixelType||"u8";for(let f=0;f<r;f++){const h=Ut(n[f],s,i[f],l||0,a);c.push(h)}const o=new V({width:t.width,height:t.height,pixels:c,mask:s,pixelType:a});return o.updateStatistics(),o}function Ut(t,e,n,s,r){const i=t.length,l=V.createEmptyBand(r,i);if(e)for(let c=0;c<i;c++)e[c]&&(l[c]=n[t[c]-s]);else for(let c=0;c<i;c++)l[c]=n[t[c]-s];return l}function ye(t,e){if(!L(t))return null;const n=t.clone(),{pixels:s}=n,r=n.width*n.height,i=e.length,l=Math.floor(i/2),c=e[Math.floor(l)],a=s[0],o=new Uint8Array(r),f=new Uint8Array(r),h=new Uint8Array(r);let p=n.mask;const u=e[0].mappedColor.length===4;p||(p=new Uint8Array(r),p.fill(u?255:1),n.mask=p);for(let d=0;d<r;d++)if(p[d]){const m=a[d];let w=!1,x=l,k=c,M=0,y=i-1;for(;y-M>1;){if(m===k.value){w=!0;break}m>k.value?M=x:y=x,x=Math.floor((M+y)/2),k=e[Math.floor(x)]}w||(m===e[M].value?(k=e[M],w=!0):m===e[y].value?(k=e[y],w=!0):m<e[M].value?w=!1:m>e[M].value&&(m<e[y].value?(k=e[M],w=!0):y===i-1?w=!1:(k=e[y],w=!0))),w?(o[d]=k.mappedColor[0],f[d]=k.mappedColor[1],h[d]=k.mappedColor[2],p[d]=k.mappedColor[3]):o[d]=f[d]=h[d]=p[d]=0}return n.pixels=[o,f,h],n.mask=p,n.pixelType="u8",n.maskIsAlpha=u,n}function ke(t,e,n=!1){const s=new Float32Array(3*gt),r=e.length;for(let i=0;i<gt;i++)s[3*i]=t[2*i]??pt-1,s[3*i+1]=t[2*i+1]??pt,s[3*i+2]=e[i]??0,i<r&&(i>0&&(s[3*i]-=1e-5),t[2*i+1]!==t[2*i]&&(i<r-1||!n)&&(s[3*i+1]-=1e-5));return s}function Me(t,e){if(!L(t))return null;const{width:n,height:s}=t,{inputRanges:r,outputValues:i,outputPixelType:l,noDataRanges:c,allowUnmatched:a,replacementValue:o,isLastInputRangeInclusive:f}=e,h=t.pixels[0],p=V.createEmptyBand(l,h.length),u=t.mask,d=new Uint8Array(n*s);u?d.set(u):d.fill(255);const m=t.pixelType.startsWith("f")?1e-6:0,w=r.map(g=>g-m);w[0]=r[0],w[w.length-1]=r[r.length-1]+(f?1e-6:0);const x=r.length/2,[k,M]=ct(l);for(let g=0;g<s;g++)for(let A=0;A<n;A++){const T=g*n+A;if(d[T]){const v=h[T];let I=!1;for(let U=x-1;U>=0;U--)if(v===r[2*U]||v>w[2*U]&&v<w[2*U+1]){p[T]=i[U],I=!0;break}I||(a?p[T]=v>M?M:v<k?k:o??v:d[T]=0)}}const y=c==null?void 0:c.length;if(y)for(let g=0;g<s;g++)for(let A=0;A<n;A++){const T=g*n+A;if(!u||u[T]){const v=h[T];for(let I=0;I<y;I+=2)if(v>=c[I]&&v<=c[I+1]){p[T]=0,d[T]=0;break}}}return new V({width:n,height:s,pixelType:l,pixels:[p],mask:d})}function xt(t,e,n,s){const r=n!=null&&n.length>=2?new Set(n):null,i=(n==null?void 0:n.length)===1?n[0]:null,l=!!(e!=null&&e.length);for(let c=0;c<t.length;c++)if(s[c]){const a=t[c];if(l){let o=!1;for(let f=0;f<e.length;f+=2)if(a>=e[f]&&a<=e[f+1]){o=!0;break}o||(s[c]=0)}s[c]&&(a===i||r!=null&&r.has(a))&&(s[c]=0)}}function wt(t,e){const n=t[0].length;for(let s=0;s<n;s++)if(e[s]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][s]){r=!0;break}r||(e[s]=0)}}function Tt(t,e){const n=t[0].length;for(let s=0;s<n;s++)if(e[s]){let r=!1;for(let i=0;i<t.length;i++)if(t[i][s]===0){r=!0;break}r&&(e[s]=0)}}function Ae(t,e){if(!L(t))return null;const{width:n,height:s,pixels:r}=t,i=n*s,l=new Uint8Array(i);t.mask?l.set(t.mask):l.fill(255);const c=r.length,{includedRanges:a,noDataValues:o,outputPixelType:f,matchAll:h,lookups:p}=e;if(p){const u=[];for(let d=0;d<c;d++){const m=p[d],w=Ut(r[d],l,m.lut,m.offset||0,"u8");u.push(w)}u.length===1?l.set(u[0]):h?wt(u,l):Tt(u,l)}else if(h){const u=[];for(let d=0;d<c;d++){const m=new Uint8Array(i);m.set(l),xt(r[d],a==null?void 0:a.slice(2*d,2*d+2),o==null?void 0:o[d],m),u.push(m)}u.length===1?l.set(u[0]):wt(u,l)}else for(let u=0;u<c;u++)xt(r[u],a==null?void 0:a.slice(2*u,2*u+2),o==null?void 0:o[u],l);return new V({width:n,height:s,pixelType:f,pixels:r,mask:l})}function be(t){const{srcPixelType:e,inputRanges:n,outputValues:s,allowUnmatched:r,noDataRanges:i,isLastInputRangeInclusive:l,outputPixelType:c}=t;if(e!=="u8"&&e!=="s8"&&e!=="u16"&&e!=="s16")return null;const a=e.includes("16")?65536:256,o=e.includes("s")?-a/2:0,f=V.createEmptyBand(c,a),h=new Uint8Array(a);r&&h.fill(255);const[p,u]=ct(c);if(n!=null&&n.length&&(s!=null&&s.length)){const d=n.map(m=>m-1e-6);d[0]=n[0],l&&(d[d.length-1]=n[n.length-1]);for(let m=0;m<d.length;m++){const w=s[m]>u?u:s[m]<p?p:s[m],x=Math.ceil(d[2*m]-o),k=n[2*m+1]===n[2*m]?x:Math.floor(d[2*m+1]-o);for(let M=x;M<=k;M++)f[M]=w,h[M]=255}}if(i!=null&&i.length)for(let d=0;d<i.length;d++){const m=Math.ceil(i[2*d]-o),w=Math.floor(i[2*d+1]-o);for(let x=m;x<=w;x++)h[x]=0}return{lut:f,offset:o,mask:h}}function ve(t,e,n){if(t!=="u8"&&t!=="s8"&&t!=="u16"&&t!=="s16")return null;const s=t.includes("16")?65536:256,r=t.includes("s")?-s/2:0,i=new Uint8Array(s);if(e)for(let l=0;l<e.length;l++){const c=Math.ceil(e[2*l]-r),a=Math.floor(e[2*l+1]-r);for(let o=c;o<=a;o++)i[o]=255}else i.fill(255);if(n)for(let l=0;l<n.length;l++)i[n[l]-r]=0;return{lut:i,offset:r}}function Xt(t,e,n,s,r,i,l,c){return{xmin:r<=n*t?0:r<n*t+t?r-n*t:t,ymin:i<=s*e?0:i<s*e+e?i-s*e:e,xmax:r+l<=n*t?0:r+l<n*t+t?r+l-n*t:t,ymax:i+c<=s*e?0:i+c<s*e+e?i+c-s*e:e}}function Ue(t,e){if(!t||t.length===0)return null;const n=t.find(d=>d.pixelBlock);if((n==null?void 0:n.pixelBlock)==null)return null;const s=(n.extent.xmax-n.extent.xmin)/n.pixelBlock.width,r=(n.extent.ymax-n.extent.ymin)/n.pixelBlock.height,i=.01*Math.min(s,r),l=t.sort((d,m)=>Math.abs(d.extent.ymax-m.extent.ymax)>i?m.extent.ymax-d.extent.ymax:Math.abs(d.extent.xmin-m.extent.xmin)>i?d.extent.xmin-m.extent.xmin:0),c=Math.min.apply(null,l.map(d=>d.extent.xmin)),a=Math.min.apply(null,l.map(d=>d.extent.ymin)),o=Math.max.apply(null,l.map(d=>d.extent.xmax)),f=Math.max.apply(null,l.map(d=>d.extent.ymax)),h={x:Math.round((e.xmin-c)/s),y:Math.round((f-e.ymax)/r)},p={width:Math.round((o-c)/s),height:Math.round((f-a)/r)},u={width:Math.round((e.xmax-e.xmin)/s),height:Math.round((e.ymax-e.ymin)/r)};return Math.round(p.width/n.pixelBlock.width)*Math.round(p.height/n.pixelBlock.height)!==l.length||h.x<0||h.y<0||p.width<u.width||p.height<u.height?null:{extent:e,pixelBlock:zt(l.map(d=>d.pixelBlock),p,{clipOffset:h,clipSize:u})}}function ot(t,e,n,s,r,i){const{width:l,height:c}=n.block,{x:a,y:o}=n.offset,{width:f,height:h}=n.mosaic,p=Xt(l,c,s,r,a,o,f,h);let u=0,d=0;if(i){const m=i.hasGCSSShiftTransform?360:i.halfWorldWidth??0,w=l*i.resolutionX,x=i.startX+s*w;x<m&&x+w>m?d=i.rightPadding:x>=m&&(u=i.leftMargin-i.rightPadding,d=0)}if(p.xmax-=d,typeof e!="number")for(let m=p.ymin;m<p.ymax;m++){const w=(r*c+m-o)*f+(s*l-a)+u,x=m*l;for(let k=p.xmin;k<p.xmax;k++)t[w+k]=e[x+k]}else for(let m=p.ymin;m<p.ymax;m++){const w=(r*c+m-o)*f+(s*l-a)+u;for(let x=p.xmin;x<p.xmax;x++)t[w+x]=e}}function zt(t,e,n={}){var U;const{clipOffset:s,clipSize:r,alignmentInfo:i,blockWidths:l}=n;if(l)return Jt(t,e,{blockWidths:l});const c=t.find(P=>L(P));if(c==null)return null;const a=r?r.width:e.width,o=r?r.height:e.height,f=c.width,h=c.height,p=e.width/f,u=e.height/h,d={offset:s||{x:0,y:0},mosaic:r||e,block:{width:f,height:h}},m=c.pixelType,w=V.getPixelArrayConstructor(m),x=c.pixels.length,k=[];let M,y;for(let P=0;P<x;P++){y=new w(a*o);for(let b=0;b<u;b++)for(let B=0;B<p;B++){const F=t[b*p+B];L(F)&&(M=F.pixels[P],ot(y,M,d,B,b,i))}k.push(y)}const g=t.some(P=>P==null||P.mask!=null&&P.mask.length>0),A=t.some(P=>(P==null?void 0:P.bandMasks)&&P.bandMasks.length>1),T=g?new Uint8Array(a*o):void 0,v=A?[]:void 0;if(T){for(let P=0;P<u;P++)for(let b=0;b<p;b++){const B=t[P*p+b],F=B!=null?B.mask:null;ot(T,F??(B?255:0),d,b,P,i)}if(v)for(let P=0;P<x;P++){const b=new Uint8Array(a*o);for(let B=0;B<u;B++)for(let F=0;F<p;F++){const S=t[B*p+F],_=((U=S==null?void 0:S.bandMasks)==null?void 0:U[P])??(S==null?void 0:S.mask);ot(b,_??(S?255:0),d,F,B,i)}v.push(b)}}const I=new V({width:a,height:o,pixels:k,pixelType:m,bandMasks:v,mask:T});return I.updateStatistics(),I}function Jt(t,e,n){var w;const s=t.find(x=>x!=null);if(s==null)return null;const r=t.some(x=>x==null||!!x.mask),{width:i,height:l}=e,c=r?new Uint8Array(i*l):null,{blockWidths:a}=n,o=[],f=s.getPlaneCount(),h=V.getPixelArrayConstructor(s.pixelType);if(r)for(let x=0,k=0;x<t.length;k+=a[x],x++){const M=t[x];if(!L(M))continue;const y=M.mask;for(let g=0;g<l;g++)for(let A=0;A<a[x];A++)c[g*i+A+k]=y==null?255:y[g*M.width+A]}const p=t.some(x=>(x==null?void 0:x.bandMasks)&&x.bandMasks.length>1),u=p?[]:void 0,d=i*l;for(let x=0;x<f;x++){const k=new h(d),M=p?new Uint8Array(d):void 0;for(let y=0,g=0;y<t.length;g+=a[y],y++){const A=t[y];if(!L(A))continue;const T=A.pixels[x];if(T!=null){for(let v=0;v<l;v++)for(let I=0;I<a[y];I++)k[v*i+I+g]=T[v*A.width+I];if(M){const v=((w=A.bandMasks)==null?void 0:w[x])??A.mask;for(let I=0;I<l;I++)for(let U=0;U<a[y];U++)M[I*i+U+g]=v?v[I*A.width+U]:255}}}o.push(k),u&&M&&u.push(M)}const m=new V({width:i,height:l,mask:c,bandMasks:u,pixels:o,pixelType:s.pixelType});return m.updateStatistics(),m}function Te(t,e,n){if(!L(t))return null;const{width:s,height:r}=t,i=e.x,l=e.y,c=n.width+i,a=n.height+l;if(i<0||l<0||c>s||a>r||i===0&&l===0&&c===s&&a===r)return t;t.mask||(t.mask=new Uint8Array(s*r));const o=t.mask;for(let f=0;f<r;f++){const h=f*s;for(let p=0;p<s;p++)o[h+p]=f<l||f>=a||p<i||p>=c?0:1}return t.updateStatistics(),t}function Kt(t){if(!L(t))return null;const e=t.clone(),{width:n,height:s,pixels:r}=t,i=r[0],l=e.pixels[0],c=t.mask;for(let a=2;a<s-1;a++){const o=new Map;for(let h=a-2;h<a+2;h++)for(let p=0;p<4;p++){const u=h*n+p;it(o,i[u],c?c[u]:1)}l[a*n]=yt(o),l[a*n+1]=l[a*n+2]=l[a*n];let f=3;for(;f<n-1;f++){let h=(a-2)*n+f+1;it(o,i[h],c?c[h]:1),h=(a-1)*n+f+1,it(o,i[h],c?c[h]:1),h=a*n+f+1,it(o,i[h],c?c[h]:1),h=(a+1)*n+f+1,it(o,i[h],c?c[h]:1),h=(a-2)*n+f-3,lt(o,i[h],c?c[h]:1),h=(a-1)*n+f-3,lt(o,i[h],c?c[h]:1),h=a*n+f-3,lt(o,i[h],c?c[h]:1),h=(a+1)*n+f-3,lt(o,i[h],c?c[h]:1),l[a*n+f]=yt(o)}l[a*n+f+1]=l[a*n+f]}for(let a=0;a<n;a++)l[a]=l[n+a]=l[2*n+a],l[(s-1)*n+a]=l[(s-2)*n+a];return e.updateStatistics(),e}function yt(t){if(t.size===0)return 0;let e=0,n=-1,s=0;const r=t.keys();let i=r.next();for(;!i.done;)s=t.get(i.value),s>e&&(n=i.value,e=s),i=r.next();return n}function lt(t,e,n){if(n===0)return;const s=t.get(e);s===1?t.delete(e):t.set(e,s-1)}function it(t,e,n){n!==0&&t.set(e,t.has(e)?t.get(e)+1:1)}function Pt(t,e,n){let{x:s,y:r}=e;const{width:i,height:l}=n;if(s===0&&r===0&&l===t.height&&i===t.width)return t;const{width:c,height:a}=t,o=Math.max(0,r),f=Math.max(0,s),h=Math.min(s+i,c),p=Math.min(r+l,a);if(h<0||p<0||!L(t))return null;s=Math.max(0,-s),r=Math.max(0,-r);const{pixels:u}=t,d=i*l,m=u.length,w=[];for(let y=0;y<m;y++){const g=u[y],A=V.createEmptyBand(t.pixelType,d);for(let T=o;T<p;T++){const v=T*c;let I=(T+r-o)*i+s;for(let U=f;U<h;U++)A[I++]=g[v+U]}w.push(A)}const x=new Uint8Array(d),k=t.mask;for(let y=o;y<p;y++){const g=y*c;let A=(y+r-o)*i+s;for(let T=f;T<h;T++)x[A++]=k?k[g+T]:1}const M=new V({width:n.width,height:n.height,pixelType:t.pixelType,pixels:w,mask:x});return M.updateStatistics(),M}function Bt(t,e=!0){if(!L(t))return null;const{pixels:n,width:s,height:r,mask:i,pixelType:l}=t,c=[],a=Math.round(s/2),o=Math.round(r/2),f=r-1,h=s-1;for(let u=0;u<n.length;u++){const d=n[u],m=V.createEmptyBand(l,a*o);let w=0;for(let x=0;x<r;x+=2)for(let k=0;k<s;k+=2){const M=d[x*s+k];if(e){const y=k===h?M:d[x*s+k+1],g=x===f?M:d[x*s+k+s],A=k===h?g:x===f?y:d[x*s+k+s+1];m[w++]=(M+y+g+A)/4}else m[w++]=M}c.push(m)}let p=null;if(i!=null){p=new Uint8Array(a*o);let u=0;for(let d=0;d<r;d+=2)for(let m=0;m<s;m+=2){const w=i[d*s+m];if(e){const x=m===h?w:i[d*s+m+1],k=d===f?w:i[d*s+m+s],M=m===h?k:d===f?x:i[d*s+m+s+1];p[u++]=w*x*k*M?1:0}else p[u++]=w}}return new V({width:a,height:o,pixelType:l,pixels:c,mask:p})}function Pe(t,e,n=0,s=!0){if(!L(t))return null;const{width:r,height:i}=e;let{width:l,height:c}=t;const a=new Map,o={x:0,y:0},f=1+n;let h=t;for(let p=0;p<f;p++){const u=Math.ceil(l/r),d=Math.ceil(c/i);for(let m=0;m<d;m++){o.y=m*i;for(let w=0;w<u;w++){o.x=w*r;const x=Pt(h,o,e);a.set(`${p}/${m}/${w}`,x)}}p<f-1&&(h=Bt(h,s)),l=Math.round(l/2),c=Math.round(c/2)}return a}function Be(t){const{pixelBlock:e,tileSize:n,level:s,row:r,col:i,useBilinear:l}=t;if(!L(e))return null;const{width:c,height:a}=n,o=2**s,f=o*c,h=o*a;let p=Pt(e,{y:r*h,x:i*f},{width:f,height:h});if(!p)return null;for(let u=s;u>0;u--)p=Bt(p,l);return p}function It(t,e,n,s,r=0){const{width:i,height:l}=t,{width:c,height:a}=e,o=s.cols,f=s.rows,h=Math.ceil(c/o-.1/o),p=Math.ceil(a/f-.1/f);let u,d,m,w,x,k,M;const y=h*o,g=y*p*f,A=new Float32Array(g),T=new Float32Array(g),v=new Uint32Array(g),I=new Uint32Array(g);let U,P,b=0;for(let B=0;B<p;B++)for(let F=0;F<h;F++){u=12*(B*h+F),d=n[u],m=n[u+1],w=n[u+2],x=n[u+3],k=n[u+4],M=n[u+5];for(let S=0;S<f;S++){b=(B*f+S)*y+F*o,P=(S+.5)/f;for(let _=0;_<S;_++)U=(_+.5)/o,A[b+_]=(d*U+m*P+w)*i+r,T[b+_]=(x*U+k*P+M)*l+r,v[b+_]=Math.floor(A[b+_]),I[b+_]=Math.floor(T[b+_])}u+=6,d=n[u],m=n[u+1],w=n[u+2],x=n[u+3],k=n[u+4],M=n[u+5];for(let S=0;S<f;S++){b=(B*f+S)*y+F*o,P=(S+.5)/f;for(let _=S;_<o;_++)U=(_+.5)/o,A[b+_]=(d*U+m*P+w)*i+r,T[b+_]=(x*U+k*P+M)*l+r,v[b+_]=Math.floor(A[b+_]),I[b+_]=Math.floor(T[b+_])}}return{offsets_x:A,offsets_y:T,offsets_xi:v,offsets_yi:I,gridWidth:y}}function Ie(t,e){const{coefficients:n,spacing:s}=e,{offsets_x:r,offsets_y:i,gridWidth:l}=It(t,t,n,{rows:s[0],cols:s[1]}),{width:c,height:a}=t,o=new Float32Array(c*a),f=180/Math.PI;for(let h=0;h<a;h++)for(let p=0;p<c;p++){const u=h*l+p,d=h===0?u:u-l,m=h===a-1?u:u+l,w=r[d]-r[m],x=i[m]-i[d];if(isNaN(w)||isNaN(x))o[h*c+p]=90;else{let k=Math.atan2(x,w)*f;k=(360+k)%360,o[h*c+p]=k}}return o}function Se(t,e,n,s,r="nearest"){if(!L(t))return null;r==="majority"&&(t=Kt(t));const{pixels:i,mask:l,bandMasks:c,pixelType:a}=t,o=t.width,f=t.height,h=V.getPixelArrayConstructor(a),p=i.length,{width:u,height:d}=e;let m=!1;for(let b=0;b<n.length;b+=3)n[b]===-1&&n[b+1]===-1&&n[b+2]===-1&&(m=!0);const{offsets_x:w,offsets_y:x,offsets_xi:k,offsets_yi:M,gridWidth:y}=It({width:o,height:f},e,n,s,r==="majority"?.5:0);let g;const A=(b,B,F,S)=>{const _=b instanceof Float32Array||b instanceof Float64Array?0:.5;for(let j=0;j<d;j++){g=j*y;for(let D=0;D<u;D++){if(w[g]<0||x[g]<0)b[j*u+D]=0;else if(S)b[j*u+D]=B[k[g]+M[g]*o];else{const N=Math.floor(w[g]),O=Math.floor(x[g]),W=Math.ceil(w[g]),z=Math.ceil(x[g]),X=w[g]-N,K=x[g]-O;if(!F||F[N+O*o]&&F[W+O*o]&&F[N+z*o]&&F[W+z*o]){const Q=(1-X)*B[N+O*o]+X*B[W+O*o],C=(1-X)*B[N+z*o]+X*B[W+z*o];b[j*u+D]=(1-K)*Q+K*C+_}else b[j*u+D]=B[k[g]+M[g]*o]}g++}}},T=[];let v;const I=(c==null?void 0:c.length)===p,U=[];for(let b=0;b<p;b++){if(I){const B=new Uint8Array(u*d);A(B,c[b],c[b],!0),U.push(B)}v=new h(u*d),A(v,i[b],I?c[b]:l,r==="nearest"||r==="majority"),T.push(v)}const P=new V({width:u,height:d,pixelType:a,pixels:T,bandMasks:I?U:void 0});if(l!=null)P.mask=new Uint8Array(u*d),A(P.mask,l,l,!0);else if(m){P.mask=new Uint8Array(u*d);for(let b=0;b<u*d;b++)P.mask[b]=w[b]<0||x[b]<0?0:1}return P.updateStatistics(),P}const Z=new Map;Z.set("meter-per-second",1),Z.set("kilometer-per-hour",.277778),Z.set("knots",.514444),Z.set("feet-per-second",.3048),Z.set("mile-per-hour",.44704);const ht=180/Math.PI,ft=5,rt=new Lt({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function ut(t,e){return Z.get(t)/Z.get(e)||1}function St(t){return(450-t)%360}function Ft(t,e="geographic"){const[n,s]=t,r=Math.sqrt(n*n+s*s);let i=Math.atan2(s,n)*ht;return i=(360+i)%360,e==="geographic"&&(i=St(i)),[r,i]}function Ht(t,e="geographic"){let n=t[1];e==="geographic"&&(n=St(n)),n%=360;const s=t[0];return[s*Math.cos(n/ht),s*Math.sin(n/ht)]}function Fe(t,e,n,s="geographic"){if(!L(t)||n==null)return t;const r=e==="vector-magdir"?t.clone():kt(t,e),i=r.pixels[1];for(let l=0;l<i.length;l++)i[l]=s==="geographic"?(i[l]+n[l]+270)%360:(i[l]+360-n[l])%360;return e==="vector-magdir"?r:kt(r,"vector-magdir")}function kt(t,e,n="geographic",s=1){if(!L(t))return t;const{pixels:r,width:i,height:l}=t,c=i*l,a=r[0],o=r[1],f=t.pixelType.startsWith("f")?t.pixelType:"f32",h=V.createEmptyBand(f,c),p=V.createEmptyBand(f,c);let u=0;for(let m=0;m<l;m++)for(let w=0;w<i;w++)e==="vector-uv"?([h[u],p[u]]=Ft([a[u],o[u]],n),h[u]*=s):([h[u],p[u]]=Ht([a[u],o[u]],n),h[u]*=s,p[u]*=s),u++;const d=new V({pixelType:f,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[h,p]});return d.updateStatistics(),d}function _e(t,e,n=1){if(n===1||!L(t))return t;const s=t.clone(),{pixels:r,width:i,height:l}=s,c=r[0];r[1];let a=0;for(let o=0;o<l;o++)for(let f=0;f<i;f++)c[a]*=n,a++;return s.updateStatistics(),s}function Ve(t,e,n,s,r){if(r==null||!r.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(e/s),height:Math.round(n/s),resolution:t.width/e};const i=r.xmin,l=r.ymax,c=(t.xmax-t.xmin)/e*s,a=(t.ymax-t.ymin)/n*s,o=(c+a)/2;return t.xmin=i+Math.floor((t.xmin-i)/c)*c,t.xmax=i+Math.ceil((t.xmax-i)/c)*c,t.ymin=l+Math.floor((t.ymin-l)/a)*a,t.ymax=l+Math.ceil((t.ymax-l)/a)*a,{extent:t,width:Math.round(t.width/c),height:Math.round(t.height/a),resolution:o}}const Yt=_t(0,0,0);function _t(t=0,e=0,n=Math.PI,s=!0){s&&(n=(2*Math.PI-n)%(2*Math.PI));const r=s?-1:1,i=13*r,l=-7*r,c=-2*r,a=-16*r,o=21.75,[f,h]=G(0,e+i,n,o),[p,u]=G(t-5.5,e+l,n,o),[d,m]=G(t+5.5,e+l,n,o),[w,x]=G(t-1.5,e+c,n,o),[k,M]=G(t+1.5,e+c,n,o),[y,g]=G(t-1.5,e+a,n,o),[A,T]=G(t+1.5,e+a,n,o);return[f,h,p,u,w,x,k,M,d,m,y,g,A,T]}function Zt(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const s=10,r=n?-1:1,i=5*r,l=20*r,c=25*r,a=45,o=0,f=0,h=2,p=0,u=h*r,d=n?1:-1,m=s/2*d;let[w,x]=[o+m,f-l],[k,M]=[w+h*d,x],[y,g]=[k-p*d,M+u],[A,T]=[o-m,f-c],[v,I]=[A+p*d,T-u],U=Math.ceil(t/ft),P=Math.floor(U/10);U-=8*P;const b=[],B=[];for(let X=0;X<U/2;X++,P--){P<=0&&U%2==1&&X===(U-1)/2&&(A=o,v=A+p*d,T=(T+x)/2,I=T-u);const[K,Q]=G(A,T,e,a);if(P>0){const[C,R]=G(k,T,e,a),[et,nt]=G(w,x,e,a);b.push(C),b.push(R),b.push(K),b.push(Q),b.push(et),b.push(nt)}else{const[C,R]=G(k,M,e,a),[et,nt]=G(y,g,e,a),[Vt,Dt]=G(v,I,e,a);B.push(K),B.push(Q),B.push(Vt),B.push(Dt),B.push(et),B.push(nt),B.push(C),B.push(R)}T+=i,x+=i,M+=i,g+=i,I+=i}const[F,S]=G(o+m,f+l,e,a),_=(s/2+h)*d,[j,D]=G(o+_,f+l,e,a),[N,O]=G(o+m,f-c,e,a),[W,z]=G(o+_,f-c,e,a);return{pennants:b,barbs:B,shaft:[F,S,j,D,N,O,W,z]}}function G(t,e,n,s=1){const r=Math.sqrt(t*t+e*e)/s,i=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[r,(2*Math.PI+i-n)%(2*Math.PI)]}const st=[0,1,3,6,10,16,21,27,33,40,47,55,63],Qt=[0,.5,1,1.5,2],te=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function H(t,e,n,s){const r=ut(s||"knots",n);let i;for(i=1;i<e.length;i++)if(i===e.length-1){if(t<e[i]*r)break}else if(t<=e[i]*r)break;return Math.min(i-1,e.length-2)}function ee(t,e,n,s,r){let i=0;switch(e){case"beaufort_kn":i=H(t,st,"knots",n);break;case"beaufort_km":i=H(t,st,"kilometer-per-hour",n);break;case"beaufort_ft":i=H(t,st,"feet-per-second",n);break;case"beaufort_m":i=H(t,st,"meter-per-second",n);break;case"classified_arrow":i=H(t,r??[],s,n);break;case"ocean_current_m":i=H(t,Qt,"meter-per-second",n);break;case"ocean_current_kn":i=H(t,te,"knots",n)}return i}function ne(t,e){const{style:n,inputUnit:s,outputUnit:r,breakValues:i}=e,l=rt.fromJSON(s),c=rt.fromJSON(r),a=42,o=15;let f=0,h=0;const{width:p,height:u,mask:d}=t,m=t.pixels[0],w=t.pixels[1],x=d!=null?d.filter(g=>g>0).length:p*u,k=new Float32Array(x*a),M=new Uint32Array(o*x),y=e.invertDirection?_t(0,0,0,!1):Yt;for(let g=0;g<u;g++)for(let A=0;A<p;A++){const T=g*p+A;if(!d||d[g*p+A]){const v=(w[T]+360)%360/180*Math.PI,I=ee(m[T],n,l,c,i);for(let P=0;P<y.length;P+=2)k[f++]=(A+.5)/p,k[f++]=(g+.5)/u,k[f++]=y[P],k[f++]=y[P+1]+v,k[f++]=I,k[f++]=m[T];const U=7*(f/a-1);M[h++]=U,M[h++]=U+1,M[h++]=U+2,M[h++]=U+0,M[h++]=U+4,M[h++]=U+3,M[h++]=U+0,M[h++]=U+2,M[h++]=U+3,M[h++]=U+2,M[h++]=U+5,M[h++]=U+3,M[h++]=U+5,M[h++]=U+6,M[h++]=U+3}}return{vertexData:k,indexData:M}}const at=[];function ie(t,e){if(at.length===0)for(let u=0;u<30;u++)at.push(Zt(5*u,0,!e.invertDirection));const n=ut(rt.fromJSON(e.inputUnit),"knots"),{width:s,height:r,mask:i}=t,l=t.pixels[0],c=t.pixels[1],a=6,o=[],f=[];let h=0,p=0;for(let u=0;u<r;u++)for(let d=0;d<s;d++){const m=u*s+d,w=l[m]*n;if((!i||i[u*s+d])&&w>=ft){const x=(c[m]+360)%360/180*Math.PI,{pennants:k,barbs:M,shaft:y}=at[Math.min(Math.floor(w/5),29)];if(k.length+M.length===0)continue;let g=o.length/a;const A=(d+.5)/s,T=(u+.5)/r;for(let v=0;v<k.length;v+=2)o[h++]=A,o[h++]=T,o[h++]=k[v],o[h++]=k[v+1]+x,o[h++]=0,o[h++]=w;for(let v=0;v<M.length;v+=2)o[h++]=A,o[h++]=T,o[h++]=M[v],o[h++]=M[v+1]+x,o[h++]=0,o[h++]=w;for(let v=0;v<y.length;v+=2)o[h++]=A,o[h++]=T,o[h++]=y[v],o[h++]=y[v+1]+x,o[h++]=0,o[h++]=w;for(let v=0;v<k.length/6;v++)f[p++]=g,f[p++]=g+1,f[p++]=g+2,g+=3;for(let v=0;v<M.length/8;v++)f[p++]=g,f[p++]=g+1,f[p++]=g+2,f[p++]=g+1,f[p++]=g+2,f[p++]=g+3,g+=4;f[p++]=g+0,f[p++]=g+1,f[p++]=g+2,f[p++]=g+1,f[p++]=g+3,f[p++]=g+2,g+=4}}return{vertexData:new Float32Array(o),indexData:new Uint32Array(f)}}function le(t,e){let n=0,s=0;const{width:r,height:i,mask:l}=t,c=t.pixels[0],a=[],o=[],f=ut(rt.fromJSON(e.inputUnit),"knots"),h=e.style==="wind_speed"?ft:Number.MAX_VALUE;for(let p=0;p<i;p++)for(let u=0;u<r;u++){const d=c[p*r+u]*f;if((!l||l[p*r+u])&&d<h){for(let w=0;w<4;w++)a[n++]=(u+.5)/r,a[n++]=(p+.5)/i,a[n++]=w<2?-.5:.5,a[n++]=w%2==0?-.5:.5,a[n++]=0,a[n++]=d;const m=4*(n/24-1);o[s++]=m,o[s++]=m+1,o[s++]=m+2,o[s++]=m+1,o[s++]=m+2,o[s++]=m+3}}return{vertexData:new Float32Array(a),indexData:new Uint32Array(o)}}function De(t,e){return e.style==="simple_scalar"?le(t,e):e.style==="wind_speed"?ie(t,e):ne(t,e)}function Ce(t,e,n,s=[0,0],r=.5){const{width:i,height:l,mask:c}=t,[a,o]=t.pixels,[f,h]=s,p=Math.round((i-f)/n),u=Math.round((l-h)/n),d=p*u,m=new Float32Array(d),w=new Float32Array(d),x=new Uint8Array(d);for(let M=0;M<u;M++)for(let y=0;y<p;y++){let g=0;const A=M*p+y,T=Math.max(0,M*n+h),v=Math.max(0,y*n+f),I=Math.min(l,T+n),U=Math.min(i,v+n);for(let P=T;P<I;P++)for(let b=v;b<U;b++){const B=P*i+b;if(!c||c[B]){g++;const F=[a[B],o[B]],[S,_]=F;m[A]+=S,w[A]+=_}}if(g>=(I-T)*(U-v)*(1-r)){x[A]=1;const[P,b]=Ft([m[A]/g,w[A]/g]);m[A]=P,w[A]=b}else x[A]=0,m[A]=0,w[A]=0}const k=new V({width:p,height:u,pixels:[m,w],mask:x});return k.updateStatistics(),k}const $=()=>Y.getLogger("esri.views.2d.engine.flow.dataUtils"),se=10;async function Re(t,e,n,s){const r=performance.now(),i=re(e,n),l=performance.now(),c=ae(e,i,n.width,n.height),a=performance.now(),o=ce(c),f=performance.now(),h=t==="Streamlines"?fe(o,se):ue(o),p=performance.now();return tt("esri-2d-profiler")&&($().info("I.1","_createFlowFieldFromData (ms)",Math.round(l-r)),$().info("I.2","_getStreamlines (ms)",Math.round(a-l)),$().info("I.3","createAnimatedLinesData (ms)",Math.round(f-a)),$().info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(p-f)),$().info("I.5","createFlowMesh (ms)",Math.round(p-r)),$().info("I.6","Mesh size (bytes)",h.vertexData.buffer.byteLength+h.indexData.buffer.byteLength)),await Promise.resolve(),Et(s),h}function re(t,e){const n=he(e.data,e.width,e.height,t.smoothing);return t.interpolate?(s,r)=>{const i=Math.floor(s),l=Math.floor(r);if(i<0||i>=e.width)return[0,0];if(l<0||l>=e.height)return[0,0];const c=s-i,a=r-l,o=i,f=l,h=i<e.width-1?i+1:i,p=l<e.height-1?l+1:l,u=n[2*(f*e.width+o)],d=n[2*(f*e.width+h)],m=n[2*(p*e.width+o)],w=n[2*(p*e.width+h)],x=n[2*(f*e.width+o)+1],k=n[2*(f*e.width+h)+1];return[(u*(1-a)+m*a)*(1-c)+(d*(1-a)+w*a)*c,(x*(1-a)+n[2*(p*e.width+o)+1]*a)*(1-c)+(k*(1-a)+n[2*(p*e.width+h)+1]*a)*c]}:(s,r)=>{const i=Math.round(s),l=Math.round(r);return i<0||i>=e.width||l<0||l>=e.height?[0,0]:[n[2*(l*e.width+i)],n[2*(l*e.width+i)+1]]}}function oe(t,e,n,s,r,i,l,c,a){const o=[];let f=n,h=s,p=0,[u,d]=e(f,h);u*=t.velocityScale,d*=t.velocityScale;const m=Math.sqrt(u*u+d*d);let w,x;o.push({x:f,y:h,t:p,speed:m});for(let k=0;k<t.verticesPerLine;k++){let[M,y]=e(f,h);M*=t.velocityScale,y*=t.velocityScale;const g=Math.sqrt(M*M+y*y);if(g<t.minSpeedThreshold)return o;const A=M/g,T=y/g;if(f+=A*t.segmentLength,h+=T*t.segmentLength,p+=t.segmentLength/g,Math.acos(A*w+T*x)>t.maxTurnAngle)return o;if(t.collisions){const v=Math.round(f*a),I=Math.round(h*a);if(v<0||v>l-1||I<0||I>c-1)return o;const U=i[I*l+v];if(U!==-1&&U!==r)return o;i[I*l+v]=r}o.push({x:f,y:h,t:p,speed:g}),w=A,x=T}return o}function ae(t,e,n,s){const r=[],i=new bt,l=1/Math.max(t.lineCollisionWidth,1),c=Math.round(n*l),a=Math.round(s*l),o=new Int32Array(c*a);for(let h=0;h<o.length;h++)o[h]=-1;const f=[];for(let h=0;h<s;h+=t.lineSpacing)for(let p=0;p<n;p+=t.lineSpacing)f.push({x:p,y:h,sort:i.getFloat()});f.sort((h,p)=>h.sort-p.sort);for(const{x:h,y:p}of f)if(i.getFloat()<t.density){const u=oe(t,e,h,p,r.length,o,c,a,l);if(u.length<2)continue;r.push(u)}return r}function he(t,e,n,s){if(s===0)return t;const r=Math.round(3*s),i=new Array(2*r+1);let l=0;for(let o=-r;o<=r;o++){const f=Math.exp(-o*o/(s*s));i[o+r]=f,l+=f}for(let o=-r;o<=r;o++)i[o+r]/=l;const c=new Float32Array(t.length);for(let o=0;o<n;o++)for(let f=0;f<e;f++){let h=0,p=0;for(let u=-r;u<=r;u++){if(f+u<0||f+u>=e)continue;const d=i[u+r];h+=d*t[2*(o*e+(f+u))],p+=d*t[2*(o*e+(f+u))+1]}c[2*(o*e+f)]=h,c[2*(o*e+f)+1]=p}const a=new Float32Array(t.length);for(let o=0;o<e;o++)for(let f=0;f<n;f++){let h=0,p=0;for(let u=-r;u<=r;u++){if(f+u<0||f+u>=n)continue;const d=i[u+r];h+=d*c[2*((f+u)*e+o)],p+=d*c[2*((f+u)*e+o)+1]}a[2*(f*e+o)]=h,a[2*(f*e+o)+1]=p}return a}function ce(t,e){const n=new bt,s=t.reduce((a,o)=>a+o.length,0),r=new Float32Array(4*s),i=new Array(t.length);let l=0,c=0;for(const a of t){const o=l;for(const f of a)r[4*l]=f.x,r[4*l+1]=f.y,r[4*l+2]=f.t,r[4*l+3]=f.speed,l++;i[c++]={startVertex:o,numberOfVertices:a.length,totalTime:a[a.length-1].t,timeSeed:n.getFloat()}}return{lineVertices:r,lineDescriptors:i}}function fe(t,e){const{lineVertices:n,lineDescriptors:s}=t;let r=0,i=0;for(const p of s)r+=2*p.numberOfVertices,i+=6*(p.numberOfVertices-1);const l=new Float32Array(r*9),c=new Uint32Array(i);let a=0,o=0;function f(){c[o++]=a-2,c[o++]=a,c[o++]=a-1,c[o++]=a,c[o++]=a+1,c[o++]=a-1}function h(p,u,d,m,w,x,k,M){const y=a*9;let g=0;l[y+g++]=p,l[y+g++]=u,l[y+g++]=1,l[y+g++]=d,l[y+g++]=x,l[y+g++]=k,l[y+g++]=m/2,l[y+g++]=w/2,l[y+g++]=M,a++,l[y+g++]=p,l[y+g++]=u,l[y+g++]=-1,l[y+g++]=d,l[y+g++]=x,l[y+g++]=k,l[y+g++]=-m/2,l[y+g++]=-w/2,l[y+g++]=M,a++}for(const p of s){const{totalTime:u,timeSeed:d}=p;let m=null,w=null,x=null,k=null,M=null,y=null;for(let g=0;g<p.numberOfVertices;g++){const A=n[4*(p.startVertex+g)],T=n[4*(p.startVertex+g)+1],v=n[4*(p.startVertex+g)+2],I=n[4*(p.startVertex+g)+3];let U=null,P=null,b=null,B=null;if(g>0){U=A-m,P=T-w;const F=Math.sqrt(U*U+P*P);if(U/=F,P/=F,g>1){let S=U+M,_=P+y;const j=Math.sqrt(S*S+_*_);S/=j,_/=j;const D=Math.min(1/(S*U+_*P),e);S*=D,_*=D,b=-_,B=S}else b=-P,B=U;b!==null&&B!==null&&(h(m,w,x,b,B,u,d,I),f())}m=A,w=T,x=v,M=U,y=P,k=I}h(m,w,x,-y,M,u,d,k)}return{vertexData:l,indexData:c}}function ue(t){const{lineVertices:e,lineDescriptors:n}=t;let s=0,r=0;for(const b of n){const B=b.numberOfVertices-1;s+=4*B*2,r+=6*B*2}const i=new Float32Array(s*16),l=new Uint32Array(r);let c,a,o,f,h,p,u,d,m,w,x,k,M,y,g=0,A=0;function T(){l[A++]=g-8,l[A++]=g-7,l[A++]=g-6,l[A++]=g-7,l[A++]=g-5,l[A++]=g-6,l[A++]=g-4,l[A++]=g-3,l[A++]=g-2,l[A++]=g-3,l[A++]=g-1,l[A++]=g-2}function v(b,B,F,S,_,j,D,N,O,W,z,X,K,Q){const C=g*16;let R=0;for(const et of[1,2])for(const nt of[1,2,3,4])i[C+R++]=b,i[C+R++]=B,i[C+R++]=F,i[C+R++]=S,i[C+R++]=D,i[C+R++]=N,i[C+R++]=O,i[C+R++]=W,i[C+R++]=et,i[C+R++]=nt,i[C+R++]=K,i[C+R++]=Q,i[C+R++]=_/2,i[C+R++]=j/2,i[C+R++]=z/2,i[C+R++]=X/2,g++}function I(b,B){let F=m+x,S=w+k;const _=Math.sqrt(F*F+S*S);F/=_,S/=_;const j=m*F+w*S;F/=j,S/=j;let D=x+M,N=k+y;const O=Math.sqrt(D*D+N*N);D/=O,N/=O;const W=x*D+k*N;D/=W,N/=W,v(c,a,o,f,-S,F,h,p,u,d,-N,D,b,B),T()}function U(b,B,F,S,_,j){if(m=x,w=k,x=M,k=y,m==null&&w==null&&(m=x,w=k),h!=null&&p!=null){M=b-h,y=B-p;const D=Math.sqrt(M*M+y*y);M/=D,y/=D}m!=null&&w!=null&&I(_,j),c=h,a=p,o=u,f=d,h=b,p=B,u=F,d=S}function P(b,B){m=x,w=k,x=M,k=y,m==null&&w==null&&(m=x,w=k),m!=null&&w!=null&&I(b,B)}for(const b of n){c=null,a=null,o=null,f=null,h=null,p=null,u=null,d=null,m=null,w=null,x=null,k=null,M=null,y=null;const{totalTime:B,timeSeed:F}=b;for(let S=0;S<b.numberOfVertices;S++)U(e[4*(b.startVertex+S)],e[4*(b.startVertex+S)+1],e[4*(b.startVertex+S)+2],e[4*(b.startVertex+S)+3],B,F);P(B,F)}return{vertexData:i,indexData:l}}function Mt(t,e){const n=e.pixels,{width:s,height:r}=e,i=new Float32Array(s*r*2),l=e.mask||new Uint8Array(s*r*2);if(e.mask||l.fill(255),t==="vector-uv")for(let c=0;c<s*r;c++)i[2*c]=n[0][c],i[2*c+1]=-n[1][c];else if(t==="vector-magdir")for(let c=0;c<s*r;c++){const a=n[0][c],o=Wt(n[1][c]),f=Math.cos(o-Math.PI/2),h=Math.sin(o-Math.PI/2);i[2*c]=f*a,i[2*c+1]=h*a}return{data:i,mask:l,width:s,height:r}}async function Le(t,e,n,s,r,i){const l=performance.now(),c=Ot(e.spatialReference);if(!c){const y=await At(t,e,n,s,r,i);return tt("esri-2d-profiler")&&$().info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),tt("esri-2d-profiler")&&$().info("I.9","Number of parts",1),y}const[a,o]=c.valid,f=o-a,h=Math.ceil(e.width/f),p=e.width/h,u=Math.round(n/h);let d=e.xmin;const m=[],w=performance.now();for(let y=0;y<h;y++){const g=new qt({xmin:d,xmax:d+p,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference});m.push(At(t,g,u,s,r,i)),d+=p}const x=await Promise.all(m);tt("esri-2d-profiler")&&$().info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-w)),tt("esri-2d-profiler")&&$().info("I.9","Number of parts",x.length);const k={data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s};let M=0;for(const y of x){for(let g=0;g<y.height;g++)for(let A=0;A<y.width;A++)M+A>=n||(k.data[2*(g*n+M+A)]=y.data[2*(g*y.width+A)],k.data[2*(g*n+M+A)+1]=y.data[2*(g*y.width+A)+1],k.mask[g*n+M+A]=y.mask[g*y.width+A]);M+=y.width}return tt("esri-2d-profiler")&&$().info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l)),k}async function At(t,e,n,s,r,i){var a;const l={requestProjectedLocalDirections:!0,signal:i};if(r!=null&&(l.timeExtent=r),t.type==="imagery"){await t.load({signal:i});const o=await t.internalFetchImage(e,n,s,l);return((a=o==null?void 0:o.pixelData)==null?void 0:a.pixelBlock)==null?{data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s}:Mt(t.rasterInfo.dataType,o.pixelData.pixelBlock)}await t.load({signal:i});const c=await t.fetchPixels(e,n,s,l);return(c==null?void 0:c.pixelBlock)==null?{data:new Float32Array(n*s*2),mask:new Uint8Array(n*s),width:n,height:s}:Mt(t.serviceRasterInfo.dataType,c.pixelBlock)}export{Le as D,xe as H,Re as I,me as J,ge as K,we as Q,L as R,zt as T,Ce as U,V,ye as Y,ke as Z,Pe as a,mt as b,Be as c,Fe as d,dt as e,Ie as f,gt as g,vt as h,ve as i,Ae as j,Ve as k,rt as l,_e as m,be as n,le as o,Ut as p,Te as q,ut as r,Ue as s,Me as t,Se as u,De as v,Ft as w,Pt as x,kt as y};
