import{be as T,v as k,l as j,f as N,P as X,J as ee,dK as te,bk as L,cu as ne,t as J}from"./index-BeTPrQ6f.js";import{Y as ie,u as ae,U as re}from"./featureConversionUtils-CZmIxyv5-DHwRSztU.js";import{s as se}from"./OptimizedFeatureSet-Dz5hF8Qm-CgsRgxJh.js";import{Y as oe,_ as le,U as ce}from"./geojson-IFfWNbn5--Ds_bCet.js";import{d as ue}from"./clientSideDefaults-BTftx6ta-Bkc3-ooB.js";import{b as de}from"./sourceUtils-CVk32wTy-BZMHds0J.js";import{o as U}from"./FieldsIndex-Ds4D9xP7-BiTuE5Z3.js";import{i as fe}from"./fieldType-DvW5hpfa-DYUbIy_X.js";const W=()=>X.getLogger("esri.layers.ogc.ogcFeatureUtils"),_="startindex",pe=new Set([_,"offset"]),Y="http://www.opengis.net/def/crs/",Pe=`${Y}OGC/1.3/CRS84`;async function Ne(e,t,n={},i=5){const{links:a}=e,o=m(a,"items","application/geo+json")||m(a,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(o==null)throw new j("ogc-feature-layer:missing-items-page","Missing items url");const{apiKey:d,customParameters:l,signal:p}=n,u=N(o.href,e.landingPage.url),h={limit:i,...l,token:d},x=ee(u,h),C={accept:"application/geo+json"},{data:v}=await k(x,{signal:p,headers:C}),S=Fe(x,i,v.links)??_;oe(v);const f=le(v,{geometryType:t.geometryType}),b=t.fields||f.fields||[],G=t.hasZ!=null?t.hasZ:f.hasZ,g=f.geometryType,y=t.objectIdField||f.objectIdFieldName||"OBJECTID";let s=t.timeInfo;const $=b.find(({name:r})=>r===y);if($)$.editable=!1,$.nullable=!1;else{if(!f.objectIdFieldType)throw new j("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");b.unshift({name:y,alias:y,type:f.objectIdFieldType==="number"?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(y!==f.objectIdFieldName){const r=b.find(({name:c})=>c===f.objectIdFieldName);r&&(r.type="esriFieldTypeInteger")}b===f.fields&&f.unknownFields.length>0&&W().warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:f.unknownFields}});for(const r of b){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"&&(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable),!r.name)throw new j("ogc-feature-layer:invalid-field-name","field name is missing",{field:r});if(!fe.jsonValues.includes(r.type))throw new j("ogc-feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r})}if(s){const r=new U(b);if(s.startTimeField){const c=r.get(s.startTimeField);c?(s.startTimeField=c.name,c.type="esriFieldTypeDate"):s.startTimeField=null}if(s.endTimeField){const c=r.get(s.endTimeField);c?(s.endTimeField=c.name,c.type="esriFieldTypeDate"):s.endTimeField=null}if(s.trackIdField){const c=r.get(s.trackIdField);c?s.trackIdField=c.name:(s.trackIdField=null,W().warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:s}}))}s.timeReference||(s.timeReference={timeZoneIANA:te}),s.startTimeField||s.endTimeField||(W().warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:s}}),s=void 0)}return{drawingInfo:g?ue(g):null,extent:he(e),geometryType:g,fields:b,hasZ:!!G,objectIdField:y,paginationParameter:S,timeInfo:s}}async function qe(e,t={}){const{links:n,url:i}=e,a=m(n,"data","application/json")||m(n,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(a==null)throw new j("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:d,signal:l}=t,p=N(a.href,i),{data:u}=await k(p,{signal:l,headers:{accept:"application/json"},query:{...d,token:o}});for(const h of u.collections)h.landingPage=e;return u}async function Oe(e,t={}){const{links:n,url:i}=e,a=m(n,"conformance","application/json")||m(n,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(a==null)throw new j("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:d,signal:l}=t,p=N(a.href,i),{data:u}=await k(p,{signal:l,headers:{accept:"application/json"},query:{...d,token:o}});return u}async function We(e,t={}){const{apiKey:n,customParameters:i,signal:a}=t,{data:o}=await k(e,{signal:a,headers:{accept:"application/json"},query:{...i,token:n}});return o.url=e,o}async function Ce(e,t={}){const{links:n,url:i}=e,a=m(n,"service-desc","application/vnd.oai.openapi+json;version=3.0");if(a==null)return W().warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:o,customParameters:d,signal:l}=t,p=N(a.href,i),{data:u}=await k(p,{signal:l,headers:{accept:"application/vnd.oai.openapi+json;version=3.0"},query:{...d,token:o}});return u}function Ge(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e),n=t==null?void 0:t.groups;if(!n)return null;const{authority:i,code:a}=n;switch(i.toLowerCase()){case"ogc":switch(a.toLowerCase()){case"crs27":return T.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return T.WGS84.wkid;default:return null}case"esri":case"epsg":{const o=Number.parseInt(a,10);return Number.isNaN(o)?null:o}default:return null}}async function Re(e,t,n){const i=await me(e,t,n);return ie(i)}async function me(e,t,n){const{collection:{links:i,landingPage:{url:a}},layerDefinition:o,maxRecordCount:d,queryParameters:{apiKey:l,customParameters:p},spatialReference:u,supportedCrs:h}=e,x=m(i,"items","application/geo+json")||m(i,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(!x)throw new j("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:C,num:v,start:S,timeExtent:f,where:b}=t;if(t.objectIds)throw new j("ogc-feature-layer:query-by-objectids-not-supported","Queries with object ids are not supported");const G=T.fromJSON(u),g=t.outSpatialReference??G,y=g.isWGS84?null:z(g,h),s=be(C,h),$=ye(f),r=we(b),c=v??(S==null?d:10),B=S===0?void 0:S,{fields:M,geometryType:q,hasZ:R,objectIdField:O,paginationParameter:E}=o,Q=N(x.href,a),{data:K}=await k(Q,{...n,query:{...p,...s,crs:y,datetime:$,query:r,limit:c,[E]:B,token:l},headers:{accept:"application/geo+json"}}),P=ce(K,{geometryType:q,hasZ:R,objectIdField:O}),V=P.length===c&&!!m(K.links??[],"next","application/geo+json"),A=new U(M);for(const w of P){const F={};de(A,F,w.attributes,!0);for(const Z of A.fields)Z.nullable&&!(Z.name in F)&&(F[Z.name]=null);F[O]=w.attributes[O],w.attributes=F}if(!y&&g.isWebMercator){for(const w of P)if(w.geometry!=null&&q!=null){const F=ae(w.geometry,q,R,!1);F.spatialReference=T.WGS84,w.geometry=re(L(F,g))}}for(const w of P)w.objectId=w.attributes[O];const H=y||!y&&g.isWebMercator?g.toJSON():ne,I=new se;return I.exceededTransferLimit=V,I.features=P,I.fields=M,I.geometryType=q,I.hasZ=R,I.spatialReference=H,I}function ge(e){return e!=null&&e.type==="extent"}function z(e,t){const{isWebMercator:n,wkid:i,latestWkid:a}=e;if(!i&&!a)return null;const o=n?t[3857]??t[102100]??t[102113]??t[900913]:i&&t[i]||a&&t[a];return o?`${Y}${o}`:null}function D(e){if(!e)return"";const{xmin:t,ymin:n,xmax:i,ymax:a}=e;return`${t},${n},${i},${a}`}function ye(e){if(!e)return null;const{start:t,end:n}=e;return`${t!=null?t.toISOString():".."}/${n!=null?n.toISOString():".."}`}function we(e){return e&&e!=="1=1"?e:null}function be(e,t){if(!ge(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:D(e)};const i=z(n,t);return i!=null?{bbox:D(e),"bbox-crs":i}:n.isWebMercator?{bbox:D(L(e,T.WGS84))}:null}function he(e){var l;const t=(l=e.extent)==null?void 0:l.spatial;if(!t)return null;const n=t.bbox[0],i=n.length===4,[a,o]=n,d=i?void 0:n[2];return{xmin:a,ymin:o,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:d,zmax:i?void 0:n[5],spatialReference:T.WGS84.toJSON()}}function m(e,t,n){return e.find(({rel:i,type:a})=>i===t&&a===n)??e.find(({rel:i,type:a})=>i===t&&!a)}function Fe(e,t,n){var l,p;if(!n)return;const i=m(n,"next","application/geo+json"),a=(l=J(i==null?void 0:i.href))==null?void 0:l.query;if(!a)return;const o=J(e).query,d=Object.keys(o??{});return(p=Object.entries(a).filter(([u])=>!d.includes(u)).find(([u,h])=>pe.has(u.toLowerCase())&&Number.parseInt(h,10)===t))==null?void 0:p[0]}export{me as B,Ge as F,Ce as I,Y as Z,Oe as b,Pe as g,We as h,Re as j,qe as w,Ne as y};
