import{j as yt,c as qt,as as M,ee as Ut,at as U,bh as Y,ar as N,q as lt,aP as tt,a7 as Nt,aW as _t,aj as xt,bY as bt,ay as j,ax as Pt,ak as Wt,g4 as I,aB as Bt,i5 as Xt,B as Yt,be as wt,m as c,E as u,n as A,am as ct,ib as jt,gu as Kt}from"./index-BeTPrQ6f.js";import{d as ut,h as Jt,E as Qt,q as St,j as R,c as te}from"./elevationInfoUtils-DFX5QvG8-DWLx2t7K.js";import{h as ee}from"./ReactiveSet-DP8oFB7N-DSfeDz8k.js";import{C as ne}from"./diffUtils-D3O4EfgX-CznKxD4n.js";import{i as ie}from"./UpdatingHandles-XotKWqvb-CyHJIoZx.js";import{d as se,J as K,O as re,S as oe,a as J}from"./SnappingContext-pR4ApgxC--JaBRde9.js";import{W as z}from"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import{p as ae}from"./meshVertexSpaceUtils-EbHpWZGf-CmRuaT8m.js";import{P as G,Q as le}from"./hydratedFeatures-82j52esm-6EbRngQ4.js";import{a as Mt,q as ce,t as ue,I as C,x as et,W as pe,c as Tt,o as de,y as Ct,d as he,r as me,w as ge,e as fe}from"./SketchViewModel-BCVIeloG-Cwmt4M0t.js";import{o as nt,t as ve,i as ye}from"./quantityUtils-v7kjLywD-Cq6IoGLM.js";import{q as _e,A as xe,j as be}from"./vec32-CI1xtKog-DFVYRcgb.js";import{f as k,n as it}from"./projectVectorToVector-OCoJKalB-CQIDHzSm.js";import{u as Pe}from"./geodesicUtils-DHDMXkUY-CP5HeHA5.js";import{l as T,M as Et,V as we}from"./angularMeasurementUtils-CVK8K4WU-C6RO-Ta3.js";import{l as Ot,r as Vt}from"./Scheduler-D_tOhFWn-SFGb1GBz.js";function Z(e,t){return e===t||e!=null&&t!=null&&_t(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function W(e,t,n){return e===t||e!=null&&t!=null&&_t(e.spatialReference,t.spatialReference)&&I(e.x,t.x,n)&&I(e.y,t.y,n)&&I(e.z??0,t.z??0,n)&&I(e.m??0,t.m??0,n)}function dn(e,t,n,i,s,r){let l="geodesic",o=Pe(n);const a=C();return et(e,t,i,a),a[2]=0,o&&k(a,n,a,o)||(l="euclidean",o=n),{mode:l,view:t,elevationInfo:i,hasZ:s,directionMode:r,spatialReference:e.spatialReference,measurementSR:o,origin:a}}function Se(e,t,n){if(t==null||e==null)return;const i=jt(n.measurementSR);if(i==null)return;const s=F(e,n);if(s==null)return;const r=nt(t,i);return new de(s,r)}function Me(e,t,n,i){if(n==null||e==null)return;const s=F(e,i);if(s==null)return;const r=T(n),l=10,o=p=>{if(p==null)return;const h=C(),v=ve(p,"degrees","geographic");return we(h,s,i.measurementSR,l,v,i.mode)?new me(s,h):void 0},a=()=>{if(t!=null&&e!=null)return T(Et(t,e))};switch(i.directionMode){case"absolute":return o(r);case"relative":{const p=a();return p==null?void 0:o(p+r)}case"relative-bilateral":{const p=a();return p==null?void 0:Ct([o(p+r),o(p-r)])}}}function It(e,t){const n=L(e,t);return n!=null?new he(n):void 0}function Dt(e,t,n){const{context:i,longitude:s,latitude:r,direction:l,distance:o,elevation:a}=n;if(s!=null||r!=null||o!=null||a!=null||l!=null){if(s!=null||r!=null){const p=T(s),h=T(r),v=L(a,i);return new Tt(p,h,v)}return Te(e,t,n)}}function Te(e,t,{context:n,direction:i,distance:s,elevation:r}){if(t==null)return It(r,n);const{view:l,elevationInfo:o,measurementSR:a}=n,p=et(t,l,o);if(!a||!k(p,t.spatialReference,pt,a))return;const[h,v]=pt,_=s!=null?nt(s,"meters"):void 0,m=T(i),P=L(r,n),g=f=>{const S=new ge([h,v],a,_,P,f);return _==null||f==null||P==null&&n.hasZ?S:new fe(S.closestTo(p))};if(m==null)return g(void 0);const b=()=>{if(e!=null&&t!=null)return T(Et(e,t))};switch(n.directionMode){case"absolute":return g(m);case"relative":{const f=b();return f==null?void 0:g(f+m)}case"relative-bilateral":{const f=b();return f==null?void 0:Ct([g(f+m),g(f-m)])}}}function Ce(e){return e.context.mode==="geodesic"?Dt(null,null,e):Zt(e)}function Ee(e,t,n){const{context:i,x:s,y:r,distance:l,direction:o,elevation:a}=n;return i.mode==="geodesic"?Dt(t,e,n):s!=null||r!=null?Zt(n):Oe([Se(e,l,i),Me(e,t,o,i),It(a,i)])}function Zt({x:e,y:t,elevation:n,context:i}){D.x=(e==null?void 0:e.value)??0,D.y=(t==null?void 0:t.value)??0,D.spatialReference=i.spatialReference;const s=F(D,i,De);return new Tt(e!=null&&s!=null?s[0]:void 0,t!=null&&s!=null?s[1]:void 0,L(n,i))}function Oe(e){let t;for(const n of e)n&&(t=(t==null?void 0:t.intersect(n))??n);return t}function F(e,t,n=C()){const{view:i,elevationInfo:s,measurementSR:r,origin:l,mode:o}=t;if(et(e,i,s,n),k(n,e.spatialReference,n,r))return o!=="geodesic"&&_e(n,n,l),n}function Ve(e,t,n,i){const{view:s,measurementSR:r,spatialReference:l,origin:o,mode:a}=n;if(a==="geodesic"?xe(O,e):be(O,e,o),k(O,r,O,l))return pe(O,s,t,n,i)}function L(e,t){var n;return((n=Ie(e,t))==null?void 0:n.value)??void 0}function Ie(e,{view:t,origin:n,elevationInfo:i,hasZ:s,measurementSR:r}){if(e==null||!s)return;const l=Kt(r);if(l==null)return;const[o,a]=n,p=nt(e,l),h=(t==null?void 0:t.type)==="3d"?te(t,o,a,p,r,i):p;return h!=null?ye(h,l):void 0}const pt=C(),De=C(),O=C(),D=it(0,0,0,wt.WGS84);class Ze{constructor(){this._isToolEditable=!0,this._manipulators=new Nt,this._resourceContexts={manipulator3D:{}},this._attached=!1}set isToolEditable(t){this._isToolEditable=t}get length(){return this._manipulators.length}add(t,n=0){this.addMany([t],n)}addMany(t,n=0){for(const i of t){const s={manipulator:i,visibilityPredicate:n,attached:!1};this._manipulators.add(s),this._attached&&this._updateManipulatorAttachment(s)}}remove(t){for(let n=0;n<this._manipulators.length;n++)if(this._manipulators.at(n).manipulator===t){const i=this._manipulators.splice(n,1)[0];this._detachManipulator(i);break}}removeAll(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._manipulators.removeAll()}attach(){this._manipulators.forEach(t=>{this._updateManipulatorAttachment(t)}),this._attached=!0}detach(){this._manipulators.forEach(t=>{this._detachManipulator(t)}),this._attached=!1}destroy(){this.detach(),this._manipulators.forEach(({manipulator:t})=>t.destroy()),this._manipulators.destroy(),this._resourceContexts=null}on(t,n){return this._manipulators.on(t,i=>{n(i)})}forEach(t){for(const n of this._manipulators.items)t(n)}some(t){return this._manipulators.items.some(t)}toArray(){const t=[];return this.forEach(n=>t.push(n.manipulator)),t}intersect(t,n){let i=null,s=Number.MAX_VALUE;return this._manipulators.forEach(({manipulator:r,attached:l})=>{if(!l||!r.interactive)return;const o=r.intersectionDistance(t,n);o!=null&&o<s&&(s=o,i=r)}),i}_updateManipulatorAttachment(t){this._isManipulatorItemVisible(t)?this._attachManipulator(t):this._detachManipulator(t)}_attachManipulator(t){t.attached||(t.manipulator.attach&&t.manipulator.attach(this._resourceContexts),t.attached=!0)}_detachManipulator(t){if(!t.attached)return;const n=t.manipulator;n.grabbing=!1,n.dragging=!1,n.hovering=!1,n.selected=!1,n.detach&&n.detach(this._resourceContexts),t.attached=!1}_isManipulatorItemVisible(t){return t.visibilityPredicate===2||(this._isToolEditable?t.visibilityPredicate===0:t.visibilityPredicate===1)}}let y=class extends yt{constructor(t){super(t),this.manipulators=new Ze,this.automaticManipulatorSelection=!0,this.hasGrabbedManipulators=!1,this.hasHoveredManipulators=!1,this.firstGrabbedManipulator=null,this.created=!1,this.removeIncompleteOnCancel=!0,this._editableFlags=new Map([[1,!0],[0,!0]]),this._creationFinishedResolver=qt()}get active(){return this.view!=null&&this.view.activeTool===this}set visible(t){this._get("visible")!==t&&(this._set("visible",t),this._syncVisible())}get editable(){return this.getEditableFlag(0)}set editable(t){this.setEditableFlag(0,t)}get updating(){return!1}get cursor(){return null}get hasFocusedManipulators(){return this.hasGrabbedManipulators||this.hasHoveredManipulators}destroy(){this.manipulators.destroy(),this._set("view",null)}onAdd(){this._syncVisible()}activate(){this.view!=null&&(this.view.focus(),this.onActivate())}deactivate(){this.onDeactivate()}cancel(){this.emit("cancel")}handleInputEvent(t){this.onInputEvent(t)}handleInputEventAfter(t){this.onInputEventAfter(t)}setEditableFlag(t,n){this._editableFlags.set(t,n),this.manipulators.isToolEditable=this.internallyEditable,this._updateManipulatorAttachment(),t===0&&this.notifyChange("editable"),this.onEditableChange(),this.onManipulatorSelectionChanged()}getEditableFlag(t){return this._editableFlags.get(t)??!1}endDrag(){var i;const t=(i=this.view.inputManager.latestPointerInfo)==null?void 0:i.location;if(!t)return;let n=!1;this.manipulators.forEach(({manipulator:s})=>{s.dragging&&(n=!0,s.events.emit("drag",{action:"end",start:t,screenPoint:t}))}),n&&(this.view.toolViewManager.activeTool=null)}whenCreated(){return this._creationFinishedResolver.promise}onManipulatorSelectionChanged(){}onActivate(){}onDeactivate(){}onShow(){}onHide(){}onEditableChange(){}onInputEvent(t){}onInputEventAfter(t){}get internallyEditable(){return this.getEditableFlag(0)&&this.getEditableFlag(1)}finishToolCreation(){this.created||this._creationFinishedResolver.resolve(this),this._set("created",!0)}_syncVisible(){if(this.initialized){if(this.visible)this._show();else if(this._hide(),this.active)return void(this.view.activeTool=null)}}_show(){this._updateManipulatorAttachment(),this.onShow()}_hide(){this._updateManipulatorAttachment(),this.onHide()}_updateManipulatorAttachment(){this.visible?this.manipulators.attach():this.manipulators.detach()}};c([u({constructOnly:!0})],y.prototype,"view",void 0),c([u({readOnly:!0})],y.prototype,"active",null),c([u({value:!0})],y.prototype,"visible",null),c([u({value:!0})],y.prototype,"editable",null),c([u({readOnly:!0})],y.prototype,"manipulators",void 0),c([u({readOnly:!0})],y.prototype,"updating",null),c([u()],y.prototype,"cursor",null),c([u({readOnly:!0})],y.prototype,"automaticManipulatorSelection",void 0),c([u()],y.prototype,"hasFocusedManipulators",null),c([u()],y.prototype,"hasGrabbedManipulators",void 0),c([u()],y.prototype,"hasHoveredManipulators",void 0),c([u()],y.prototype,"firstGrabbedManipulator",void 0),c([u({readOnly:!0})],y.prototype,"created",void 0),c([u({readOnly:!0})],y.prototype,"removeIncompleteOnCancel",void 0),y=c([A("esri.views.interactive.InteractiveToolBase")],y);const Rt="click";let x=class extends xt{constructor(e){super(e),this.events=new Wt,this.interactive=!0,this.selectable=!1,this.cursor=null,this.grabbable=!0}intersectionDistance(e,t){return 0}attach(){}detach(){}onElevationChange(){}onViewChange(){}};c([u()],x.prototype,"interactive",void 0),c([u()],x.prototype,"selectable",void 0),c([u()],x.prototype,"cursor",void 0),c([u()],x.prototype,"grabbing",void 0),c([u()],x.prototype,"grabbable",void 0),c([u()],x.prototype,"consumesClicks",void 0),c([u()],x.prototype,"grabbableForEvent",void 0),c([u()],x.prototype,"dragging",void 0),c([u()],x.prototype,"hovering",void 0),c([u()],x.prototype,"selected",void 0),x=c([A("esri.views.draw.LegacyDrawManipulator")],x);function Re(e,t){let n=null,i=null;return s=>{if(s.action==="cancel")return void(i!=null&&(i.execute({action:"cancel"}),n=null,i=null));const r={action:s.action,screenStart:s.start,screenEnd:s.screenPoint};s.action==="start"&&n==null&&(n=new V,i=new V,t(e,n,i,s.pointerType,r)),n==null||n.execute(r),s.action==="end"&&n!=null&&(n=null,i=null)}}function B(e,t){return e.events.on("drag",Re(e,t))}function mn(e,t){const n=[e.x,e.y,e.z??0],i=t,s=[Math.cos(i),Math.sin(i)],r=Math.sqrt(s[0]*s[0]+s[1]*s[1]);if(r===0)return null;s[0]/=r,s[1]/=r;const l=o=>{const a=(o.x-n[0])*s[0]+(o.y-n[1])*s[1];o.x=n[0]+a*s[0],o.y=n[1]+a*s[1]};return o=>(l(o.mapStart),l(o.mapEnd),{...o,axis:s})}function ze(e){let t=null;const n=zt();return i=>{if(i.action==="start"&&(t=He(e,i.mapStart.spatialReference)),t==null)return null;const s=n(i);if(!s)return null;const{translationX:r,translationY:l,translationZ:o}=s;return t.move(r,l,o,i.action),s}}function dt(e,t){return e==null?null:e.spatialReference.equals(t)?e.clone():z(e,t)}function He(e,t){const n=e.operations;if(!n)return null;const i=n.data.geometry,s=le(t);if(i.spatialReference.equals(s))return X(e,n,()=>{});if(i.type!=="mesh"){const r=dt(i,s);if(r==null)return null;const l=i.spatialReference,o=K.fromGeometry(r,n.viewingMode);return X(e,o,()=>{const a=o.data.geometry,p=z(a,l);n.trySetGeometry(p)})}if(ae(i)){const r=dt(i.origin,s);if(!r)return null;const l=i.spatialReference,o=K.fromGeometry(r,n.viewingMode);return X(e,n,()=>{const a=z(o.data.geometry,l),p=a.x-i.origin.x,h=a.y-i.origin.y,v=(a.z??0)-(i.origin.z??0);n.move(p,h,v)})}return null}function X(e,t,n){let i=0,s=0,r=0;return{move:(l,o,a,p)=>{var m;p==="start"&&(i=0,s=0,r=0);const h=l-i,v=o-s,_=a-r;t.move(h,v,_),i+=h,s+=v,r+=_,n(),p==="end"&&((m=e.endInteraction)==null||m.call(e))}}}function gn(e,t=null,n){var l;let i=null;const s=t==null||(l=e.spatialReference)!=null&&l.equals(t)?o=>o:o=>o!=null?z(o,t):o,r={exclude:[],...n};return o=>{if(o.action==="start"&&(i=s(e.toMap(o.screenStart,r))),i==null)return null;const a=s(e.toMap(o.screenEnd,r));return a!=null?{...o,mapStart:i,mapEnd:a}:null}}function fn(e){const t=e.map(i=>ze(i)).filter(Bt),n=zt();return i=>{const s=n(i);return t.forEach(r=>r(i)),s}}function Ae(e){var n;const t=(n=e.operations)==null?void 0:n.createResetState();return i=>(t==null||t.remove(),i)}function vn(e){const t=e.map(n=>Ae(n)).filter(n=>n!=null);return n=>(t.forEach(i=>i(n)),n)}function yn(){let e=0,t=0,n=0;return i=>{i.action==="start"&&(e=i.mapStart.x,t=i.mapStart.y,n=i.mapStart.z??0);const s=i.mapEnd.x-e,r=i.mapEnd.y-t,l=(i.mapEnd.z??0)-n;return e=i.mapEnd.x,t=i.mapEnd.y,n=i.mapEnd.z,{...i,mapDeltaX:s,mapDeltaY:r,mapDeltaZ:l,mapDeltaSpatialReference:i.mapStart.spatialReference}}}function zt(){let e=0,t=0,n=0;return i=>{i.action==="start"&&(e=i.mapStart.x,t=i.mapStart.y,n=i.mapStart.z??0);const s=i.mapEnd.x-e,r=i.mapEnd.y-t,l=(i.mapEnd.z??0)-n;return{...i,translationX:s,translationY:r,translationZ:l}}}function _n(){let e=0,t=0;return n=>{n.action==="start"&&(e=n.screenStart.x,t=n.screenStart.y);const i=n.screenEnd.x-e,s=n.screenEnd.y-t;return e=n.screenEnd.x,t=n.screenEnd.y,{...n,screenDeltaX:i,screenDeltaY:s}}}function xn(e,t){let n=null,i=0,s=0;return r=>{var p;if(r.action==="start"&&(n=(p=e.toScreen)==null?void 0:p.call(e,t),n!=null&&(n.x<0||n.x>e.width||n.y<0||n.y>e.height?n=null:(i=r.screenStart.x-n.x,s=r.screenStart.y-n.y))),n==null)return null;const l=ct(r.screenEnd.x-i,0,e.width),o=ct(r.screenEnd.y-s,0,e.height),a=tt(l,o);return r.screenStart=n,r.screenEnd=a,r}}const Ge=()=>{};class V{constructor(){this.execute=Ge}next(t,n=new V){return t!=null&&(this.execute=i=>{const s=t(i);s!=null&&n.execute(s)}),n}}function ke(e,t,n=[]){if(e.type==="2d")return s=>s;let i=null;return s=>{s.action==="start"&&(i=e.toMap(s.screenStart,{exclude:n}),i!=null&&(i.z=R(i,e,t)));const r=e.toMap(s.screenEnd,{exclude:n});r!=null&&(r.z=R(r,e,t));const l=i!=null&&r!=null?{sceneStart:i,sceneEnd:r}:null;return{...s,scenePoints:l}}}function ht(e,t,n){const i=t.elevationProvider.getElevation(e.x,e.y,e.z??0,e.spatialReference,"scene")??0,s=G(e);return s.z=i,s.hasZ=!0,s.z=R(s,t,n),s}function bn(e,t){if(e.type==="2d")return i=>i;let n=null;return i=>{i.action==="start"&&(n=ht(i.mapStart,e,t));const s=ht(i.mapEnd,e,t),r=n!=null&&s!=null?{sceneStart:n,sceneEnd:s}:null;return{...i,scenePoints:r}}}function Fe({predicate:e=()=>!0,snappingManager:t,snappingContext:n,updatingHandles:i,useZ:s=!0}){const r=new V;if(t==null)return{snappingStep:[mt,r],cancelSnapping:mt};let l,o=null,a=null,p=null;const h=()=>{o=j(o),t.doneSnapping(),a==null||a.frameTask.remove(),a=null,l=Pt(l),p=null},v=Le(t,s,r);let _=null,m=null,P=null;return{snappingStep:[g=>{if(!e(g))return g;const{action:b}=g;if(b==="start"){const{info:f}=g,S=$e(t.view);if(a=qe(n,g,S),a.context.selfSnappingZ=null,!s&&f!=null){const E=Ne(n.coordinateHelper,f.handle.part);E!=null&&(a.context.selfSnappingZ={value:E,elevationInfo:n.elevationInfo??Qt})}}if(a!=null){const{context:f,originalScenePos:S,originalPos:E}=a,{mapEnd:st,mapStart:rt,scenePoints:Gt}=g,$=Ht(E,Q(st,rt)),ot=Q(rt,E),kt={...g,action:"update"},Ft=a.context,q=Ue(S,Gt),at=t.update({point:$,scenePoint:q,context:f});if(P=at,At(st,at,ot,s),_=$,m=q,b!=="end"){const{frameTask:Lt}=a;o==null&&(o=new AbortController),p=$t=>{i.addPromise(Y(v({frameTask:Lt,event:kt,context:Ft,point:$,scenePoint:q,delta:ot,getLastState:()=>({point:_,scenePoint:m,updatePoint:$t.forceUpdate?null:P})},o.signal)))},p({forceUpdate:!1}),l==null&&(l=M(()=>t.options.effectiveEnabled,()=>p==null?void 0:p({forceUpdate:!0})))}}return b==="end"&&h(),g},r],cancelSnapping:g=>(h(),g)}}function Le(e,t,n){return bt(async({frameTask:i,point:s,scenePoint:r,context:l,event:o,delta:a,getLastState:p},h)=>{const v=await i.schedule(()=>e.snap({point:s,scenePoint:r,context:l,signal:h}),h);if(v.valid){let _=await i.schedule(()=>v.apply(),h);const m=p();m.point!=null&&s!==m.point&&(_=e.update({point:m.point,scenePoint:m.scenePoint,context:l})),m.updatePoint!=null&&Z(_,m.updatePoint)||(At(o.mapEnd,_,a,t),n.execute(o))}})}function $e(e){return e.type==="3d"?e.resourceController.scheduler.registerTask(Vt.SNAPPING):Ot}function qe(e,t,n){return{context:new J({editGeometryOperations:e.editGeometryOperations,elevationInfo:e.elevationInfo,pointer:e.pointer,vertexHandle:t.info!=null?t.info.handle:null,excludeFeature:e.excludeFeature,feature:e.feature,visualizer:e.visualizer}),originalPos:t.snapOrigin!=null?e.coordinateHelper.vectorToDehydratedPoint(t.snapOrigin):t.mapStart,originalScenePos:t.scenePoints!=null?t.scenePoints.sceneStart:null,frameTask:n}}function Ht(e,[t,n,i]){const s=G(e);return s.x+=t,s.y+=n,s.hasZ&&(s.z+=i),s}function Ue(e,t){return e==null||t==null?null:Ht(e,Q(t.sceneEnd,t.sceneStart))}function Q(e,t){const n=e.hasZ&&t.hasZ?e.z-t.z:0;return[e.x-t.x,e.y-t.y,n]}function At(e,t,[n,i,s],r){e.x=t.x+n,e.y=t.y+i,r&&e.hasZ&&t.hasZ&&(e.z=t.z+s)}function Ne(e,t){if(!e.hasZ())return null;const n=t.vertices;let i=null;for(const s of n){const r=e.getZ(s.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function mt(e){return e}let w=class extends xt{constructor(e){super(e),this.constrainResult=t=>t,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=bt(async(t,n,i,s)=>{const r=this._frameTask;if(r==null)return;const l=await r.schedule(()=>n.snap({...t,context:i,signal:s}),s);l.valid&&await r.schedule(()=>{this.stagedPoint=l.apply(),t!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=n.update({...this._snapPoints,context:i}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(e){this._stagedPoint=this.constrainResult(e)}initialize(){var t,n;const e=this.view.type==="3d"?(n=(t=this.view)==null?void 0:t.resourceController)==null?void 0:n.scheduler:null;this._frameTask=e!=null?e.registerTask(Vt.SNAPPING):Ot}destroy(){this._abortController=j(this._abortController),this._frameTask=Pt(this._frameTask)}update(e,t,n){this._snapPoints=e;const{point:i,scenePoint:s}=e,r=t.update({point:i,scenePoint:s,context:n});return this.stagedPoint=r,r}async snap(e,t,n){const{point:i,scenePoint:s}=e;return this.stagedPoint=t.update({point:i,scenePoint:s,context:n}),this._snapPoints=e,this._abortController==null&&(this._abortController=new AbortController),this._snap(e,t,n,this._abortController.signal)}async snapAgainNearPreviousMapPoint(e,t){this._snapPoints!=null&&await this.snap(this._snapPoints,e,t)}abort(){this._abortController=j(this._abortController),this._snapPoints=null}};c([u({constructOnly:!0})],w.prototype,"view",void 0),c([u()],w.prototype,"stagedPoint",null),c([u()],w.prototype,"constrainResult",void 0),c([u()],w.prototype,"_stagedPoint",void 0),w=c([A("esri.views.interactive.snapping.SnappingOperation")],w);const We="crosshair",Be="progress",gt=Symbol(),ft=Symbol();let d=class extends yt{constructor(e){super(e),this._createOperationCompleted=!1,this._hideDefaultCursor=!1,this._pointerDownStates=new ee,this._stagedScreenPoint=null,this._stagedPointerType=null,this._updatingHandles=new ie,this._stagedPointerId=null,this.constraintsEnabled=!1,this.constraints=void 0,this._getPointConstraint=ut(Ce),this._getPolylineOrPolygonConstraint=ut(Ee),this.constraintZ=null,this.defaultZ=null,this.isDraped=!0,this.labelOptions=new Mt,this.cursor=null,this.loading=!1,this.snapToSceneEnabled=null,this.firstVertex=null,this.lastVertex=null,this.secondToLastVertex=null,e.elevationInfo==null&&(this.elevationInfo=Jt(!!e.hasZ))}initializePointer(){var t;const e=(t=this.view.inputManager)==null?void 0:t.latestPointerInfo;e!=null&&this._updatePointer(e.location,e.id,e.type)}initialize(){const{geometryType:e,view:t}=this,n=t.spatialReference,i="viewingMode"in t.state?t.state.viewingMode:2,s=e==="segment"||e==="multipoint"?"polyline":e;this.coordinateHelper=se(this.hasZ,this.hasM,n),this._editGeometryOperations=new K(new re(s,this.coordinateHelper),i),this._snappingOperation=new w({view:t}),this.addHandles([M(()=>({stagedPoint:this._snappingOperation.stagedPoint,constraint:this._constraint}),({stagedPoint:o,constraint:a},p)=>{const{snappingOptions:h}=this;if(h&&(h.forceDisabled=a!=null&&ce(a)),p!=null&&o===p.stagedPoint&&a!==p.constraint)return this._onKeyboardBasedChange();this._processCursor(o??this._screenToMap(this._stagedScreenPoint))},{equals:(o,a)=>o.stagedPoint===a.stagedPoint&&Ut(o.constraint,a.constraint)}),M(()=>this.view.viewpoint,(o,a)=>{o&&a&&ne(o,a)&&this._onKeyboardBasedChange()})]),this._activePart=new oe(n,i),this._editGeometryOperations.data.parts.push(this._activePart);const r=this.segmentLabels;r!=null&&(r.context={view:t,editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,labelOptions:this.labelOptions,automaticLengthMeasurementUtils:this.automaticLengthMeasurementUtils},this.addHandles(M(()=>this.labelOptions.enabled,o=>{r.visible=o},U))),this.addHandles(this._editGeometryOperations.on(["vertex-add","vertex-update","vertex-remove"],o=>{var m,P,g,b;const a=o.vertices.map(f=>({componentIndex:0,vertexIndex:f.index,coordinates:this.coordinateHelper.vectorToArray(f.pos)})),p=a.map(f=>f.coordinates),h=this.coordinateHelper.vectorToDehydratedPoint((m=this._activePart.getFirstVertex())==null?void 0:m.pos)??null;Z(h,this.firstVertex)||(this.firstVertex=h);const v=this.coordinateHelper.vectorToDehydratedPoint((P=this._activePart.getLastVertex())==null?void 0:P.pos)??null;Z(v,this.lastVertex)||(this.lastVertex=v);const _=this.coordinateHelper.vectorToDehydratedPoint((b=(g=this._activePart.segments.at(-1))==null?void 0:g.leftVertex)==null?void 0:b.pos)??null;switch(Z(_,this.secondToLastVertex)||(this.secondToLastVertex=_),this._processCursor(this.cursorVertex),o.type){case"vertex-add":this.emit(o.type,{...o,added:p,vertices:a});break;case"vertex-update":this.emit(o.type,{...o,updated:p,vertices:a});break;case"vertex-remove":this.emit(o.type,{...o,removed:p,vertices:a})}}));const l=this._manipulator=new x({consumesClicks:!1,grabbableForEvent:o=>this.drawingMode!=="click"||o.pointerType==="touch"&&this._snappingEnabled&&this._pointerDownStates.size===1});this.manipulators.add(l),l.grabbable=e!=="point"&&e!=="multipoint",this.addHandles([l.events.on("immediate-click",o=>this._onImmediateClick(o)),l.events.on("immediate-double-click",o=>this._onImmediateDoubleClick(o)),M(()=>this.drawingMode,()=>{this.removeHandles(gt),this.addHandles(this._createManipulatorDragPipeline(l),gt)},U),M(()=>({effectiveCursor:this.effectiveCursor}),({effectiveCursor:o})=>{l.cursor=o},U)]),ue(this,()=>{var p;const o=((p=this.view.inputManager.latestPointerInfo)==null?void 0:p.type)??"mouse",a=this._getSnappingContext(o);if(this.snappingManager!=null){const h=this._snappingOperation.snapAgainNearPreviousMapPoint(this.snappingManager,a);this._updatingHandles.addPromise(Y(h))}})}destroy(){N(this.segmentLabels),N(this._snappingOperation),this._editGeometryOperations=N(this._editGeometryOperations),this._updatingHandles.destroy()}get _isDragging(){const{_stagedPointerId:e,_manipulator:t}=this;return e!=null&&this._pointerDownStates.has(e)||t.grabbing||!t.interactive}get _snappingEnabled(){return this.snappingManager!=null&&this.snappingManager.options.effectiveEnabled}get _requiresScenePoint(){const e=this._updateAndGetEffectiveDrawSurface();return this.view.type==="3d"&&this.drawSurface!==e}get canRedo(){return this._editGeometryOperations.canRedo}get canUndo(){return this._editGeometryOperations.canUndo}get committedVertices(){return this._activePart.vertices.map(e=>this.coordinateHelper.vectorToArray(e.pos))}get _constraint(){const{constraints:e,constraintsEnabled:t}=this;if(e&&t)switch(this.geometryType){case"point":case"multipoint":return this._getPointConstraint(e);case"polygon":case"polyline":return this._getPolylineOrPolygonConstraint(this.lastVertex,this.secondToLastVertex,e)}}set drawingMode(e){this._set("drawingMode",e??Rt)}get effectiveCursor(){return this.loading?Be:this._hideDefaultCursor?null:this.cursor||We}get interactive(){return this._manipulator.interactive}set interactive(e){this._manipulator.interactive=e}get isCompleted(){return this._createOperationCompleted}get numCommittedVertices(){return this._activePart.vertices.length}get snappingOptions(){return this.snappingManager!=null?this.snappingManager.options:null}get cursorVertex(){return this._get("cursorVertex")}get visualizationCursorVertex(){return this._stagedPointerType==="mouse"?this.cursorVertex:null}get committableVertex(){const{cursorVertex:e,lastVertex:t,firstVertex:n,geometryType:i}=this;return i==="polygon"&&W(e,n)||W(e,t)?null:e}get updating(){return this._updatingHandles.updating}get geometryIncludingUncommittedVertices(){const{committedVertices:e,committableVertex:t,coordinateHelper:n}=this,i=e.slice();return t!=null&&i.push(n.pointToArray(t)),i}cancel(){this.complete({aborted:!0})}commitStagedVertex(){this._snappingOperation.abort();const{committableVertex:e}=this;e!=null&&this._editGeometryOperations.appendVertex(this.coordinateHelper.pointToVector(e),this._activePart)}complete(e){var r;const t=(e==null?void 0:e.aborted)||!1;this._snappingOperation.abort(),(r=this.snappingManager)==null||r.doneSnapping();const{geometryType:n,numCommittedVertices:i}=this,s=n==="multipoint"&&i===0||n==="polyline"&&i<2||n==="polygon"&&i<3;n!=="segment"&&n!=="point"||this.commitStagedVertex(),this._createOperationCompleted=!s,(this.isCompleted||t)&&(this._stagedScreenPoint=null,this._stagedPointerId=null,this._stagedPointerType=null,this._processCursor(null),this.emit("complete",{vertices:this.committedVertices.map((l,o)=>({componentIndex:0,vertexIndex:o,coordinates:l})),aborted:t,type:"complete"}))}onInputEvent(e){switch(e.type){case"pointer-down":this._pointerDownStates.add(e.pointerId);break;case"pointer-up":this._pointerDownStates.delete(e.pointerId)}switch(e.type){case"pointer-move":return this._onPointerMove(e);case"hold":return this._onHold(e)}}redo(){this._editGeometryOperations.redo()}undo(){this.snappingManager!=null&&this.snappingManager.doneSnapping(),this._editGeometryOperations.undo()}_processCursor(e){var l,o;const t=lt(this.cursorVertex),n=lt(e),i=n&&(((l=this._updateAndGetEffectiveDrawSurface())==null?void 0:l.constrainZ(n))??n),s=this._snapToClosingVertex(i),r=this._applyConstraints(s);W(t,r)||(this._set("cursorVertex",r),(o=this.segmentLabels)==null||o.set("stagedVertex",r!=null?this.coordinateHelper.pointToVector(r):null),r==null||this._stagedPointerType!=="mouse"?this.emit("cursor-remove"):this.emit("cursor-update",{updated:null,vertices:[{componentIndex:0,vertexIndex:this._activePart.vertices.length,coordinates:this.coordinateHelper.pointToArray(r)}],operation:"apply",type:"vertex-update"}))}_snapToClosingVertex(e){if(e==null||this._isDragging||this.geometryType!=="polygon"||this.numCommittedVertices<=2)return e;const t=this._mapToScreen(e);if(!t)return e;const n=this._activePart;return this._vertexWithinPointerDistance(n.vertices[0].pos,t)?this.firstVertex:this._vertexWithinPointerDistance(n.vertices.at(-1).pos,t)?this.lastVertex:e}_createManipulatorDragPipeline(e){switch(this.drawingMode){case"click":return this._createManipulatorDragPipelineClick(e);case"freehand":return this._createManipulatorDragPipelineFreehand(e);case"hybrid":return this._createManipulatorDragPipelineHybrid(e)}}_createManipulatorDragPipelineClick(e){return B(e,(t,n,i,s)=>{const r=s==="touch"&&this._snappingEnabled;if(this.isCompleted||!r)return;const{snappingStep:l,cancelSnapping:o}=Fe({predicate:()=>r,snappingManager:this.snappingManager,snappingContext:new J({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,feature:this.graphic,pointer:s,visualizer:this.snappingVisualizer,drawConstraints:this.constraints}),updatingHandles:this._updatingHandles,useZ:!this._requiresScenePoint});i=i.next(a=>(r&&this.snappingManager!=null&&this.snappingManager.doneSnapping(),a)).next(o),n.next(this._screenToMapDragEventStep()).next(a=>(a.action==="start"&&(this._processCursor(a.mapStart),(this.geometryType==="segment"||r&&!this.numCommittedVertices)&&this.commitStagedVertex()),a)).next(ke(this.view,this.elevationInfo)).next(...l).next(a=>(r&&(this._processCursor(a.mapEnd),a.action==="end"&&this.commitStagedVertex()),a)).next(a=>(a.action==="end"&&(this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()),a))})}_createManipulatorDragPipelineFreehand(e){return B(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.committableVertex==null&&this._processCursor(i.mapStart),this.geometryType==="segment"&&this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this.complete()}return i})})}_createManipulatorDragPipelineHybrid(e){return B(e,(t,n)=>{this.isCompleted||n.next(this._screenToMapDragEventStep()).next(i=>(i.action==="start"&&(this._snappingOperation.abort(),this.addHandles(this._editGeometryOperations.createUndoGroup(),ft),this._processCursor(i.mapStart),this.commitStagedVertex()),i)).next(i=>{switch(i.action){case"start":case"update":this._processCursor(i.mapEnd),this.geometryType!=="polygon"&&this.geometryType!=="polyline"||this.commitStagedVertex();break;case"end":this._stagedPointerType!=="mouse"&&this._snappingOperation.abort(),this.removeHandles(ft),this.geometryType!=="segment"&&this.geometryType!=="point"||this.complete()}return i})})}get _drawAtFixedElevation(){const{constraintsEnabled:e,constraintZ:t,geometryType:n,numCommittedVertices:i}=this;return e?t!=null||n==="segment"&&i>0:(n==="segment"||n==="polygon")&&i>0}_updateAndGetEffectiveDrawSurface(){var a;const{constraintsEnabled:e,coordinateHelper:t,drawSurface:n,elevationDrawSurface:i,snapToSceneEnabled:s}=this;if(i==null)return n;if(!this.hasZ)return i.defaultZ=null,i;const r=(a=this.elevationInfo)==null?void 0:a.mode;let l=this.defaultZ,o=e||r==="absolute-height";return s!=null&&(o=s),r==="on-the-ground"&&(o=!1),this._drawAtFixedElevation&&(l=(e?this.constraintZ:null)??t.getZ(this._activePart.vertices[0].pos),o=!1),o?n:(i.defaultZ=l,i)}_mapToScreen(e){var t;return(t=this._updateAndGetEffectiveDrawSurface())==null?void 0:t.mapToScreen(e)}_onHold(e){this._snappingOperation.abort(),this.drawingMode==="click"&&e.pointerType==="touch"&&this._snappingEnabled&&this._processCursor(e.mapPoint),e.stopPropagation()}_onImmediateClick(e){if(!(e.pointerType==="mouse"&&e.button===2||this._manipulator.dragging))try{const{drawingMode:t,geometryType:n}=this;this._stagedPointerType=e.pointerType,this._stagedScreenPoint=e.screenPoint;const i=this._screenToMap(e.screenPoint);if(i==null||i==null||t==="freehand"&&n!=="point"&&n!=="multipoint")return;if(this._snappingEnabled&&this.cursorVertex!=null||this._processCursor(i),this.committableVertex==null)return void this.complete();this.commitStagedVertex(),e.pointerType!=="mouse"&&this._processCursor(null),(t==="freehand"&&this.geometryType!=="multipoint"||n==="point"||n==="segment"&&this.numCommittedVertices===2||n==="segment"&&t==="hybrid"&&this.numCommittedVertices===1)&&this.complete()}finally{e.stopPropagation()}}_onImmediateDoubleClick(e){this._manipulator.dragging||this.geometryType==="point"||(this.complete(),e.stopPropagation())}_onPointerMove(e){const t=tt(e.x,e.y);this._updatePointer(t,e.pointerId,e.pointerType)&&e.stopPropagation()}_updatePointer(e,t,n){return this._stagedScreenPoint=e,this._stagedPointerType=n,this._stagedPointerId=t,this._isDragging?(this._snappingOperation.abort(),!1):(this._processCursorMovementRelativeToSurface(e,n),!0)}_onKeyboardBasedChange(){this._stagedPointerType==="mouse"&&this._stagedScreenPoint&&this._stagedPointerId!=null&&!this._isDragging?this._processCursorMovementRelativeToSurface(this._stagedScreenPoint,this._stagedPointerType):this._snappingOperation.abort()}_processCursorMovementRelativeToSurface(e,t){var o;const n=this._snappingOperation,i=this._screenToMap(e),s=this._requiresScenePoint?(o=this.drawSurface)==null?void 0:o.screenToMap(e):null;if(i==null)return this._hideDefaultCursor=!0,this._processCursor(null),void n.abort();this._hideDefaultCursor=!1;const r=this.snappingManager;if(r==null)return this._processCursor(i),void n.abort();const l=this._getSnappingContext(t);this._updatingHandles.addPromise(Y(n.snap({point:i,scenePoint:s},r,l)))}_applyConstraints(e){const{_constraint:t,constraints:n}=this;if(!e||!n||!t)return e;const{context:i}=n,s=F(e,i),r=s?t.closestTo(s):void 0;if(!r)return e;const l=Ve(r,e,i),o=this.view.type==="2d"||i.elevationInfo.mode!=="absolute-height";return l!=null&&o&&this.constraintZ!=null&&this.hasZ&&(l.z=this.constraintZ),l}_screenToMap(e){var t;return e?(t=this._updateAndGetEffectiveDrawSurface())==null?void 0:t.screenToMap(e):null}_screenToMapDragEventStep(){let e=null;return t=>{if(t.action==="start"&&(e=this._screenToMap(t.screenStart)),e==null)return null;const n=this._screenToMap(t.screenEnd);return n!=null?{...t,mapStart:e,mapEnd:n}:null}}_vertexWithinPointerDistance(e,t){const n=this._mapToScreen(this.coordinateHelper.vectorToDehydratedPoint(e));return n!=null&&Xe(n,t,25)}_getSnappingContext(e){var n;const t=this._drawAtFixedElevation?(n=this.elevationDrawSurface)==null?void 0:n.defaultZ:null;return new J({editGeometryOperations:this._editGeometryOperations,elevationInfo:this.elevationInfo,pointer:e,feature:this.graphic,visualizer:this.snappingVisualizer,selfSnappingZ:t!=null?{value:t,elevationInfo:this.elevationInfo}:null,drawConstraints:this.constraints})}};function Xe(e,t,n){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s<=n}c([u()],d.prototype,"_hideDefaultCursor",void 0),c([u()],d.prototype,"_stagedPointerId",void 0),c([u()],d.prototype,"_isDragging",null),c([u()],d.prototype,"_snappingOperation",void 0),c([u()],d.prototype,"_snappingEnabled",null),c([u({constructOnly:!0})],d.prototype,"graphic",void 0),c([u()],d.prototype,"constraintsEnabled",void 0),c([u()],d.prototype,"constraints",void 0),c([u()],d.prototype,"_constraint",null),c([u()],d.prototype,"constraintZ",void 0),c([u()],d.prototype,"defaultZ",void 0),c([u()],d.prototype,"isDraped",void 0),c([u({constructOnly:!0})],d.prototype,"automaticLengthMeasurementUtils",void 0),c([u({value:Rt})],d.prototype,"drawingMode",null),c([u({constructOnly:!0})],d.prototype,"elevationDrawSurface",void 0),c([u({constructOnly:!0})],d.prototype,"elevationInfo",void 0),c([u({constructOnly:!0,type:Mt})],d.prototype,"labelOptions",void 0),c([u({constructOnly:!0})],d.prototype,"geometryType",void 0),c([u({constructOnly:!0})],d.prototype,"hasM",void 0),c([u({constructOnly:!0})],d.prototype,"hasZ",void 0),c([u()],d.prototype,"cursor",void 0),c([u()],d.prototype,"effectiveCursor",null),c([u()],d.prototype,"loading",void 0),c([u({constructOnly:!0})],d.prototype,"manipulators",void 0),c([u({constructOnly:!0})],d.prototype,"drawSurface",void 0),c([u({constructOnly:!0})],d.prototype,"segmentLabels",void 0),c([u({constructOnly:!0})],d.prototype,"snappingManager",void 0),c([u({constructOnly:!0})],d.prototype,"snappingVisualizer",void 0),c([u()],d.prototype,"snapToSceneEnabled",void 0),c([u({readOnly:!0})],d.prototype,"cursorVertex",null),c([u({readOnly:!0})],d.prototype,"visualizationCursorVertex",null),c([u()],d.prototype,"committableVertex",null),c([u()],d.prototype,"firstVertex",void 0),c([u()],d.prototype,"lastVertex",void 0),c([u()],d.prototype,"secondToLastVertex",void 0),c([u()],d.prototype,"updating",null),c([u({constructOnly:!0})],d.prototype,"view",void 0),d=c([A("esri.views.draw.DrawOperation")],d);class Pn{constructor(t,n,i,s=null){this._elevationInfo=t,this.defaultZ=n,this._view=i,this._excludeGraphics=s}screenToMap(t){const{defaultZ:n,_view:i}=this,s=i.sceneIntersectionHelper.intersectElevationFromScreen(Xt(t.x,t.y),this._elevationInfo,n??0,this._excludeGraphics);return n==null&&s!=null&&(s.z=void 0),s}mapToScreen(t){const n=it(t.x,t.y,St(this._view,t,this._elevationInfo),t.spatialReference);return this._view.toScreen(n)}constrainZ(t){const{defaultZ:n}=this;return n!=null&&t.z!==n&&((t=G(t)).z=n),t}}class wn{constructor(t,n,i=[]){this.view=t,this.elevationInfo=n,this.exclude=i}screenToMap(t){const n=this.view.toMap(t,{exclude:this.exclude,excludeLabels:!0});return n!=null&&(n.z=R(n,this.view,this.elevationInfo)),n}mapToScreen(t){let n=t;return this.elevationInfo!=null&&(n=it(t.x,t.y,St(this.view,t,this.elevationInfo),t.spatialReference)),this.view.toScreen(n)}constrainZ(t){return t}}class Sn{constructor(t,n=!1,i=0){this.view=t,this.hasZ=n,this.defaultZ=i,this.mapToScreen=s=>t.toScreen(s),this.screenToMap=n?s=>{const r=t.toMap(s);return r.z=i,r}:s=>t.toMap(s)}constrainZ(t){const{defaultZ:n}=this;return this.hasZ&&t.z!==n&&((t=G(t)).z=n),t}}const H=class H{screenToMap(t){const{x:n,y:i}=t;return new Yt({x:n,y:i,spatialReference:H.spatialReference})}mapToScreen(t){return tt(t.x,t.y)}constrainZ(t){return t}};H.spatialReference=new wt;let vt=H;export{bn as B,V as E,Ae as I,B as L,yn as N,ze as O,Fe as R,fn as U,Z as V,xn as W,_n as X,ke as Z,Sn as a,gn as b,dn as c,d as h,vt as i,mn as k,vn as q,wn as r,Pn as s,y as v};
