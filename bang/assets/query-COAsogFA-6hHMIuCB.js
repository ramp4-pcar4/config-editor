import{M as x,N as g,bL as b,by as p,bu as E}from"./index-DRDU_nTl.js";import{B as I}from"./normalizeUtils-u00NGW3M-BaTNjyav.js";import{v as j}from"./pbfQueryUtils-aBcHX3TJ-CSKrVzL4.js";import{n as q}from"./queryZScale-CwrUzBjP-CdG8ZeiC.js";function O(r){const t={};for(const a in r){if(a==="declaredClass")continue;const i=r[a];if(i!=null&&typeof i!="function")if(Array.isArray(i)){t[a]=[];for(let e=0;e<i.length;e++)t[a][e]=O(i[e])}else typeof i=="object"?i.toJSON&&(t[a]=JSON.stringify(i)):t[a]=i}return t}const S="Layer does not support extent calculation.";function F(r,t){if(t&&r.type==="extent")return`${r.xmin},${r.ymin},${r.xmax},${r.ymax}`;if(t&&r.type==="point")return`${r.x},${r.y}`;const a=r.toJSON();return delete a.spatialReference,JSON.stringify(a)}function R(r,t,a){var l,c;const i=r.geometry,e=r.toJSON();delete e.compactGeometryEnabled,delete e.defaultSpatialReferenceEnabled;const n=e;let o,u,s;if(i&&(u=i.spatialReference,s=p(u),n.geometryType=E(i),n.geometry=F(i,r.compactGeometryEnabled),n.inSR=s),e.groupByFieldsForStatistics&&(n.groupByFieldsForStatistics=e.groupByFieldsForStatistics.join(",")),e.objectIds)switch((l=a==null?void 0:a.uniqueIdFields)==null?void 0:l.length){case void 0:n.objectIds=e.objectIds.join(",");break;case 1:n.uniqueIds=JSON.stringify(e.objectIds),delete n.objectIds;break;default:n.uniqueIds=JSON.stringify(e.objectIds.map(f=>JSON.parse(f))),delete n.objectIds}if(e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),!e.outFields||!e.returnDistinctValues&&(t!=null&&t.returnCountOnly||t!=null&&t.returnExtentOnly||t!=null&&t.returnIdsOnly)?delete n.outFields:e.outFields.includes("*")?n.outFields="*":n.outFields=e.outFields.join(","),e.outSR?(n.outSR=p(e.outSR),o=r.outSpatialReference):i&&(e.returnGeometry||e.returnCentroid)&&(n.outSR=n.inSR,o=u),e.returnGeometry&&delete e.returnGeometry,e.outStatistics&&(n.outStatistics=JSON.stringify(e.outStatistics)),e.fullText&&(n.fullText=JSON.stringify(e.fullText)),e.pixelSize&&(n.pixelSize=JSON.stringify(e.pixelSize)),e.quantizationParameters&&(r.defaultSpatialReferenceEnabled&&u!=null&&((c=r.quantizationParameters)==null?void 0:c.extent)!=null&&u.equals(r.quantizationParameters.extent.spatialReference)&&delete e.quantizationParameters.extent.spatialReference,n.quantizationParameters=JSON.stringify(e.quantizationParameters)),e.parameterValues&&(n.parameterValues=JSON.stringify(e.parameterValues)),e.rangeValues&&(n.rangeValues=JSON.stringify(e.rangeValues)),e.dynamicDataSource&&(n.layer=JSON.stringify({source:e.dynamicDataSource}),delete e.dynamicDataSource),e.timeExtent){const f=e.timeExtent,{start:y,end:m}=f;y==null&&m==null||(n.time=y===m?y:`${y??"null"},${m??"null"}`),delete e.timeExtent}return r.defaultSpatialReferenceEnabled&&u!=null&&o!=null&&u.equals(o)&&(n.defaultSR=n.inSR,delete n.inSR,delete n.outSR),n}async function V(r,t,a,i,e){var o;const n=(o=t.timeExtent)!=null&&o.isEmpty?{data:{features:[]}}:await d(r,t,"json",i,void 0,e);return q(t,a,n.data),n}async function v(r,t,a,i,e){var u;if((u=t.timeExtent)!=null&&u.isEmpty)return{data:a.createFeatureResult()};const n=await N(r,t,i,e),o=n;return o.data=j(n.data,a),o}function N(r,t,a,i){return d(r,t,"pbf",a,void 0,i)}function C(r,t,a,i){var e;return(e=t.timeExtent)!=null&&e.isEmpty?Promise.resolve({data:{objectIds:[]}}):d(r,t,"json",a,{returnIdsOnly:!0},i)}function T(r,t,a,i){var e;return(e=t.timeExtent)!=null&&e.isEmpty?Promise.resolve({data:{count:0}}):d(r,t,"json",a,{returnIdsOnly:!0,returnCountOnly:!0},i)}async function $(r,t,a){var n;if((n=t.timeExtent)!=null&&n.isEmpty)return{data:{count:0,extent:null}};const i=await d(r,t,"json",a,{returnExtentOnly:!0,returnCountOnly:!0}),e=i.data;if(e.hasOwnProperty("extent"))return i;if(e.features)throw new Error(S);if(e.hasOwnProperty("count"))throw new Error(S);return i}function J(r,t){if(!r.returnIdsOnly||!t.uniqueIdFields)return r;const a={...r,returnUniqueIdsOnly:!0};return delete a.returnIdsOnly,a}async function d(r,t,a,i={},e={},n={}){const o=typeof r=="string"?x(r):r,u=t.geometry?[t.geometry]:[],s=await I(u,null,{signal:i.signal}),l=s==null?void 0:s[0];l!=null&&((t=t.clone()).geometry=l);const c=O({...o.query,f:a,...J(e,n),...R(t,e,n)});return g(b(o.path,w(t,e)?"query3d":"query"),{...i,responseType:a==="pbf"?"array-buffer":"json",query:{...c,...i.query}})}function w(r,t){return r.formatOf3DObjects!=null&&!(t.returnCountOnly||t.returnExtentOnly||t.returnIdsOnly)}export{V as F,v as J,C as N,N as S,O as f,T as w,$ as z};
