import{v as g,aa as Q,ai as X,dP as Z,bd as C,s as U,T as A,bK as tt,h as q,e as et,z as D,k as it,A as rt,b as W,ae as ot,iv as N,iG as R,kK as k,iz as M,kL as st,Y as at,I as w,t as J,E as F,l as nt}from"./index-C8m3jhgc.js";import{K as lt,O}from"./projection-m8vi7Cxv-5dN8ECj8.js";import{fromJSON as pt}from"./jsonUtils-DQiDyVGY-CMyM6NOn.js";import{O as mt}from"./FeatureSet-Dxf4LeOj-CoInEZpJ.js";import{y as ht}from"./utils-DuaeuwP5-CYr0443q.js";import{o as T}from"./GraphicsCollection-rAFZo1AJ-Dmo8O3V2.js";import{p as ct,z as ut,H as dt}from"./BitmapTechnique-BX6dC711-eUa8kc_-.js";import{n as ft}from"./BitmapContainer-DI2lgxqV-DizM9PfT.js";import{D as yt}from"./LayerView2D-CCfp06E--CEWlGH47.js";import{d as E}from"./GraphicContainer-CEP0E1kz-D_ADMCra.js";import{F as G}from"./GraphicsView2D-yiocyXG3-hpWJok7g.js";import{v as gt}from"./LayerView-D3XoMhlx-CNRRgoxx.js";import{j as _t,D as wt}from"./rasterProjectionHelper-BV-HUScL-B3SBewqu.js";import{_ as xt}from"./VertexStream-BTTQGT6f-Dc8Pqon2.js";import{v as bt,N as vt}from"./MaterialPrograms-B05fGOwm-B_ozSpy5.js";import{G as z,U as St,F as Vt,X as $}from"./enums-DBi1-Mm2-CUS1pvQe.js";import{f as It}from"./FramebufferObject-DQw0QX3p-BfLFFTaU.js";import{L as Pt}from"./rasterUtils-eBoM3Jzs-MM0dJC18.js";import{H as B,O as Ct}from"./Texture-DXSFJsEu-BYX1rrMX.js";import"./typeUtils-I5iG5ZKA-Bj-ytWfY.js";import"./ClassBreaksRenderer-D97YzbWp-BNKlZRw7.js";import"./commonProperties-BLIn8DYU-te3BK1cG.js";import"./colorRamps-KMmVdCPJ-IldyGzzl.js";import"./ColorStop-DoHCvOqO-DH82WTuy.js";import"./visualVariableUtils-BO-_wo28-CKo3AW1i.js";import"./lengthUtils-wU9RRIqK-Cfmv-SV3.js";import"./RendererLegendOptions-f5mIImtQ-DjUg407A.js";import"./LRUCache-BLmkvs7b-C7sAHc2V.js";import"./MemCache-BCippCv6-B4i-p-yc.js";import"./Version-BTMwSXf1-BhPPVtmW.js";import"./FieldsIndex-Y7EBAYp0-w6K0n6zu.js";import"./timeZoneUtils-z3WjfjXQ-NGm-Oxyv.js";import"./utils-BYqzY6_X-x0QsB8bB.js";import"./defaultCIMValues-gWpu7WSC-cjxb95kj.js";import"./enums-f9UUstHQ-hLTu4V1l.js";import"./heatmapUtils--OU2Fakh-BfIIxpey.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./SimpleRenderer-ADQlYl8U-BozHxNBQ.js";import"./UniqueValueRenderer-BmoLL_Ee-WAX_-d_L.js";import"./diffUtils-BSe9IE26-BODWUFPE.js";import"./styleUtils-DxAOZq5S-BN2g5w8P.js";import"./Field-Cj6Pz3TI-ByZDJlm_.js";import"./fieldType-VTpxE-EM-BwVu7TAV.js";import"./mat3-DOnW3DjW-C3hbW9XY.js";import"./MapView-BcnxJC0k-Binfb5ne.js";import"./globalCss-CFN4F315-D4Tn2bn1.js";import"./Queue-B8H6jIv7-CGxuMpyH.js";import"./signal-DxzURL18-wfRwoo2f.js";import"./CollectionFlattener-9hYRBLDX-B6V8u68f.js";import"./workers-0oosFQiO-6pFxJkg9.js";import"./intl-DLmy-Li5-CBPkUqcW.js";import"./TileInfo-owTCOSRx-CXTeyaWR.js";import"./TileKey-B_6qmYK--BtZdR-Xy.js";import"./jsxFactory-C5LxVioS-HM4dZcpE.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./UpdatingHandles-DBzjq66S-B3uXjtAE.js";import"./Map-DbZVFU-I-6p9ehY1b.js";import"./Basemap-DxWxjcEH-DRa3XbtM.js";import"./loadAll-BIhJ1RSe-BHOysWtK.js";import"./PortalItem-CJetnHeq-Bdd4RBXy.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-eFKmoA7r.js";import"./Layer-B8q-l4yV-DeVeCMqx.js";import"./TimeExtent-gZaEUVeW-BJxSd7M2.js";import"./HeightModelInfo-BkDck4B0-C-QAQXbW.js";import"./ReactiveMap-BaMcQuG3-Dtirejx3.js";import"./Query-CxQYWcUQ-DQFSvrsp.js";import"./IViewEvents-BE10MM98-CvMfjolG.js";import"./HighlightDefaults-Cg50f_1y-ogMZT3FA.js";import"./a11yUtils-C2ydunC--DRB_ioan.js";import"./heightModelInfoUtils-CI93rfC7-peNkkO2J.js";import"./ViewingMode-CyR_b1T8-_s7_Gbsk.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./vec2f64-CEUyUoff-BBc0aQ6D.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./normalizeUtils-b-vZURob-L-0hCDcI.js";import"./utils-Jw-4AGsF-BiDTtnWE.js";import"./mat2df32-BCnkwMW8-BLRY8i4P.js";import"./vec2f32-CVhmN3Me-DxoqVD7C.js";import"./Scheduler-Br-2v2ys-BSgwEpHb.js";import"./vec32-BuqRmYBM-CIiFy01h.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./Tile-DvzRai0K-Dl6bpGbN.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./definitions-CBIQmVpq-o3EUznKY.js";import"./imageUtils-DEFspgr5-DKHjpBv_.js";import"./themeUtils-RB4IoNvm-uO-dsvgO.js";import"./ColorBackground-Dcc9SnXm-D14_Khgj.js";import"./getDataTypeBytes-HSdrWtlL-ClHsCcSN.js";import"./Container-BdpN3llD-CRqV4-Ev.js";import"./EffectView-Bw7SZPlx-g8BfIcCC.js";import"./parser-hXQyB-Qx-vNllFoQp.js";import"./GraphShaderModule-C7Apfssb-nTb4bOzL.js";import"./ProgramTemplate-CBS0ERm4-Bf92bq8c.js";import"./ShaderBuilder-BkQM64Qp-D_TZAMe8.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./TechniqueType-GommNIdJ-ByYTgVOB.js";import"./WGLContainer-CF3AeUnM-DFAujpfw.js";import"./dataViewUtils-xig9T3UA-CNvBNX4T.js";import"./VertexElementDescriptor-BAy1DPb3-BOhpDZGx.js";import"./BoundingBox-D9JxeQeA-SaxmeIkg.js";import"./VertexArrayObject-DTkLCIKs-CSFN9_jv.js";import"./memoryEstimations-iHVpvWPf-Dr8cx1B2.js";import"./vec3f32-BS0cezmI-B_madU1n.js";import"./config-DB0LnTDt-CYa9nhWp.js";import"./earcut-XDcq3zAf-BcwyrT7l.js";import"./featureConversionUtils-DRaHTjrY-CknlBso8.js";import"./OptimizedFeatureSet-D6mgsKNr-C1gFQiME.js";import"./OptimizedGeometry-1qDYm3YK-DdtVS-GX.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./layerViewUtils-Bk5QNiAa-BCUON9xC.js";import"./AGraphicContainer-BSUvBxvy-B-gPBEbi.js";import"./TechniqueInstance-oJ4weLzg-lpAdUVvQ.js";import"./UpdateTracking2D-CaPtqow6-CuOWwQah.js";import"./TileContainer-Dc8VVA_r-7_kJiTrb.js";import"./FeatureCommandQueue-CqM9cs0l-DSayA2kD.js";import"./CIMSymbolHelper-Bcp4nGf3-HENi8Dec.js";import"./BidiEngine-Bdqv5H5j-Dyqh9XG-.js";import"./fontUtils-Ce-zEYaT-BJIub1Xl.js";import"./Rect-KI3be8Nv-C6RQcQNG.js";import"./rasterizingUtils-B8CPqgVl-Al1dk4fR.js";import"./floatRGBA-YJlz5IlR-Dw-6FvLC.js";import"./QueueProcessor-BtXHzeIT-BPdt5JmN.js";import"./OverrideHelper-GkMo7t6B-BjdtnZIa.js";import"./colorUtils-DxUhbS7D-B-Muh5Ny.js";import"./callExpressionWithFeature-uWLbeAgq-CIZV_qJT.js";import"./quantizationUtils-Cndke4AR-g6lLwree.js";import"./FeatureMetadata-X_4q5T4e-2Ccd045D.js";import"./queryUtils-OXllLZed-BTyeIbJ4.js";import"./json-BI97KiBB-Ce5cWfI2.js";import"./timeSupport-_0FhDj9z-Gf1PqJiS.js";import"./TimeOnly-C3SOkmg2-BYz1kEdW.js";import"./labelUtils-Dd5sr1UJ-I494zoGq.js";import"./mat3f64-Dh9_zhFu-BIT-k8Dm.js";import"./normalizeUtilsSync-C40q69cc-PVL5nuub.js";import"./dehydratedFeatures-CekTKTy7-CIJufK0l.js";import"./utils-BddLNd1v-DHHKcR63.js";import"./webglDeps-BKBjGpbm-4dDITF1f.js";import"./NestedMap-Ddo7BfvO-C19CMXI3.js";import"./renderState-DlSSrLcZ-Du_EmLq6.js";import"./glsl-o28TenZV-B0eZUNn3.js";import"./testSVGPremultipliedAlpha-CdWnvpEj-Cic4ea_f.js";import"./doublePrecisionUtils-BJbYwoii-kIP-tL_t.js";const Dt={esriGeometryPoint:"points",esriGeometryPolyline:"polylines",esriGeometryPolygon:"polygons"};function kt(e){var n;const t=e.folders||[],i=t.slice(),s=new Map,o=new Map,r=new Map,a=new Map,h=new Map,p={esriGeometryPoint:o,esriGeometryPolyline:r,esriGeometryPolygon:a};(((n=e.featureCollection)==null?void 0:n.layers)||[]).forEach(l=>{const d=D(l);d.featureSet.features=[];const c=l.featureSet.geometryType;s.set(c,d);const u=l.layerDefinition.objectIdField;c==="esriGeometryPoint"?L(o,u,l.featureSet.features):c==="esriGeometryPolyline"?L(r,u,l.featureSet.features):c==="esriGeometryPolygon"&&L(a,u,l.featureSet.features)}),e.groundOverlays&&e.groundOverlays.forEach(l=>{h.set(l.id,l)}),t.forEach(l=>{l.networkLinkIds.forEach(d=>{const c=Tt(d,l.id,e.networkLinks);c&&i.push(c)})}),i.forEach(l=>{var d;if(l.featureInfos){l.points=D(s.get("esriGeometryPoint")),l.polylines=D(s.get("esriGeometryPolyline")),l.polygons=D(s.get("esriGeometryPolygon")),l.mapImages=[];for(const c of l.featureInfos)switch(c.type){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":{const u=p[c.type].get(c.id);u&&((d=l[Dt[c.type]])==null||d.featureSet.features.push(u));break}case"GroundOverlay":{const u=h.get(c.id);u&&l.mapImages.push(u);break}}l.fullExtent=K([l])}});const m=K(i);return{folders:t,sublayers:i,extent:m}}function Mt(e,t,i,s){var a;const o=(a=nt)==null?void 0:a.findCredential(e);e=it(e,{token:o==null?void 0:o.token});const r=rt.kmlServiceUrl;return W(r,{query:{url:e,model:"simple",folders:"",refresh:i!==0||void 0,outSR:JSON.stringify(t)},responseType:"json",signal:s})}function gr(e,t,i=null,s=[]){const o=[],r={},a=t.sublayers,h=new Set(t.folders.map(p=>p.id));return a.forEach(p=>{var n;const m=new e;if(i?m.read(p,i):m.read(p),s.length&&h.has(m.id)&&(m.visible=s.includes(m.id)),r[p.id]=m,p.parentFolderId!=null&&p.parentFolderId!==-1){const l=r[p.parentFolderId];l.sublayers||(l.sublayers=[]),(n=l.sublayers)==null||n.unshift(m)}else o.unshift(m)}),o}function L(e,t,i){i.forEach(s=>{e.set(s.attributes[t],s)})}function Rt(e,t){let i;return t.some(s=>s.id===e&&(i=s,!0)),i}function Tt(e,t,i){const s=Rt(e,i);return s&&(s.parentFolderId=t,s.networkLink=s),s}async function j(e){const t=mt.fromJSON(e.featureSet).features,i=e.layerDefinition,s=pt(i.drawingInfo.renderer),o=ot.fromJSON(e.popupInfo),r=[];for(const a of t){const h=await s.getSymbolAsync(a);a.symbol=h,a.popupTemplate=o,a.visible=!0,r.push(a)}return r}function K(e){var s,o,r,a,h,p;const t=N(R),i=N(R);for(const m of e){if((o=(s=m.polygons)==null?void 0:s.featureSet)!=null&&o.features)for(const n of m.polygons.featureSet.features)k(t,n.geometry),M(i,t);if((a=(r=m.polylines)==null?void 0:r.featureSet)!=null&&a.features)for(const n of m.polylines.featureSet.features)k(t,n.geometry),M(i,t);if((p=(h=m.points)==null?void 0:h.featureSet)!=null&&p.features)for(const n of m.points.featureSet.features)k(t,n.geometry),M(i,t);if(m.mapImages)for(const n of m.mapImages)k(t,n.extent),M(i,t)}return st(i,R)?void 0:{xmin:i[0],ymin:i[1],zmin:i[2],xmax:i[3],ymax:i[4],zmax:i[5],spatialReference:A.WGS84}}let x=class extends at{constructor(){super(...arguments),this.id=0,this.rotation=0,this.href="",this.extent=new U}};g([w({nonNullable:!0,json:{write:!0}})],x.prototype,"id",void 0),g([w({nonNullable:!0,json:{write:!0}})],x.prototype,"rotation",void 0),g([w({nonNullable:!0,json:{write:!0}})],x.prototype,"href",void 0),g([w({type:U,nonNullable:!0,json:{write:!0}})],x.prototype,"extent",void 0),x=g([J("esri.layers.support.KMLMapImage")],x);class f{constructor(t){if(this._ownsRctx=!1,t)this._ownsRctx=!1,this._rctx=t;else{if(f._instance)return f._instanceRefCount++,f._instance;f._instanceRefCount=1,f._instance=this,this._ownsRctx=!0;const o=document.createElement("canvas").getContext("webgl2");o.getExtension("OES_texture_float"),this._rctx=new bt(o,{})}const i={applyProjection:!0,bilinear:!1,bicubic:!1},s=vt("raster/reproject","raster/reproject",new Map([["a_position",0]]),i);this._program=this._rctx.programCache.acquire(s.shaders.vertexShader,s.shaders.fragmentShader,s.attributes),this._rctx.useProgram(this._program),this._program.setUniform1f("u_opacity",1),this._program.setUniform1i("u_image",0),this._program.setUniform1i("u_flipY",0),this._program.setUniform1i("u_transformGrid",1),this._quad=new xt(this._rctx,[0,0,1,0,0,1,1,1])}reprojectTexture(t,i,s=!1){const o=O(t.extent,i),r=new F({x:(t.extent.xmax-t.extent.xmin)/t.texture.descriptor.width,y:(t.extent.ymax-t.extent.ymin)/t.texture.descriptor.height,spatialReference:t.extent.spatialReference}),{x:a,y:h}=_t(r,i,t.extent);let p=(a+h)/2;const m=Math.round((o.xmax-o.xmin)/p),n=Math.round((o.ymax-o.ymin)/p);p=(o.width/m+o.height/n)/2;const l=new F({x:p,y:p,spatialReference:o.spatialReference}),d=wt({projectedExtent:o,srcBufferExtent:t.extent,pixelSize:l,hasWrapAround:!0,spacing:[16,16]}),c=Pt(this._rctx,d),u=new B(m,n);u.wrapMode=z.CLAMP_TO_EDGE;const y=new It(this._rctx,u);this._rctx.bindFramebuffer(y),this._rctx.setViewport(0,0,m,n),this._rctx.useProgram(this._program),this._rctx.bindTexture(t.texture,0),this._rctx.bindTexture(c,1),this._quad.bind();const{width:S=0,height:V=0}=t.texture.descriptor;if(this._program.setUniform2f("u_srcImageSize",S,V),this._program.setUniform2fv("u_transformSpacing",d.spacing),this._program.setUniform2fv("u_transformGridSize",d.size),this._program.setUniform2f("u_targetImageSize",m,n),this._quad.draw(),this._quad.unbind(),this._rctx.useProgram(null),this._rctx.bindFramebuffer(null),c.dispose(),s){const{width:_,height:P}=y,v=new ImageData(_??0,P??0);y.readPixels(0,0,_??0,P??0,St.RGBA,Vt.UNSIGNED_BYTE,v.data);const Y=y.detachColorTexture($.COLOR_ATTACHMENT0);return y.dispose(),{texture:Y,extent:o,imageData:v}}const I=y.detachColorTexture($.COLOR_ATTACHMENT0);return y.dispose(),{texture:I,extent:o}}reprojectBitmapData(t,i){const s=ut(t.bitmapData)?dt(t.bitmapData):t.bitmapData,o=new B;o.wrapMode=z.CLAMP_TO_EDGE,o.width=t.bitmapData.width,o.height=t.bitmapData.height;const r=new Ct(this._rctx,o,s),a=this.reprojectTexture({texture:r,extent:t.extent},i,!0);a.texture.dispose();const h=document.createElement("canvas"),p=a.imageData;return h.width=p.width,h.height=p.height,h.getContext("2d").putImageData(p,0,0),{bitmapData:h,extent:a.extent}}async loadAndReprojectBitmapData(t,i,s){const o=(await W(t,{responseType:"image"})).data,r=document.createElement("canvas");r.width=o.width,r.height=o.height;const a=r.getContext("2d");a.drawImage(o,0,0);const h=a.getImageData(0,0,r.width,r.height);if(i.spatialReference.equals(s))return{bitmapData:h,extent:i};const p=this.reprojectBitmapData({bitmapData:h,extent:i},s);return{bitmapData:p.bitmapData,extent:p.extent}}destroy(){this._ownsRctx?(f._instanceRefCount--,f._instanceRefCount===0&&(this._quad.dispose(),this._program.dispose(),this._rctx.dispose(),f._instance=null)):(this._quad.dispose(),this._program.dispose())}}f._instanceRefCount=0;class H{constructor(){this.allSublayers=new Map,this.allPoints=[],this.allPolylines=[],this.allPolygons=[],this.allMapImages=[]}}let b=class extends yt(gt){constructor(){super(...arguments),this._bitmapIndex=new Map,this._mapImageContainer=new ft,this._kmlVisualData=new H,this._fetchController=null,this.allVisiblePoints=new T,this.allVisiblePolylines=new T,this.allVisiblePolygons=new T,this.allVisibleMapImages=new Q}async hitTest(e,t){var s,o,r;const i=this.layer;return[(s=this._pointsView)==null?void 0:s.hitTest(e),(o=this._polylinesView)==null?void 0:o.hitTest(e),(r=this._polygonsView)==null?void 0:r.hitTest(e)].flat().filter(Boolean).map(a=>(a.layer=i,a.sourceLayer=i,{type:"graphic",graphic:a,layer:i,mapPoint:e}))}update(e){this._polygonsView&&this._polygonsView.processUpdate(e),this._polylinesView&&this._polylinesView.processUpdate(e),this._pointsView&&this._pointsView.processUpdate(e)}attach(){this._fetchController=new AbortController,this.container.addChild(this._mapImageContainer),this._polygonsView=new G({view:this.view,graphics:this.allVisiblePolygons,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._polygonsView.container),this._polylinesView=new G({view:this.view,graphics:this.allVisiblePolylines,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._polylinesView.container),this._pointsView=new G({view:this.view,graphics:this.allVisiblePoints,requestUpdateCallback:()=>this.requestUpdate(),container:new E(this.view.featuresTilingScheme)}),this.container.addChild(this._pointsView.container),this.addAttachHandles([this.allVisibleMapImages.on("change",e=>{e.added.forEach(t=>this._addMapImage(t)),e.removed.forEach(t=>this._removeMapImage(t))}),X(()=>this.layer.visibleSublayers,e=>{for(const t of this._kmlVisualData.allSublayers.values())t.visibility=0;for(const t of e){const i=this._kmlVisualData.allSublayers.get(t.id);i&&(i.visibility=1)}this._refreshCollections()})]),this._updatingHandles.addPromise(this._fetchService(this._fetchController.signal)),this._imageReprojector=new f}detach(){this._fetchController=Z(this._fetchController),this._mapImageContainer.removeAllChildren(),this.container.removeAllChildren(),this._bitmapIndex.clear(),this._polygonsView=C(this._polygonsView),this._polylinesView=C(this._polylinesView),this._pointsView=C(this._pointsView),this._imageReprojector=C(this._imageReprojector)}viewChange(){this._polygonsView.viewChange(),this._polylinesView.viewChange(),this._pointsView.viewChange()}moveEnd(){}isUpdating(){return this._pointsView.updating||this._polygonsView.updating||this._polylinesView.updating}_addMapImage(e){var t,i;((t=this.view.spatialReference)!=null&&t.isWGS84||(i=this.view.spatialReference)!=null&&i.isWebMercator)&&this._imageReprojector.loadAndReprojectBitmapData(e.href,e.extent,this.view.spatialReference).then(s=>{const o=new ct(s.bitmapData);o.x=s.extent.xmin,o.y=s.extent.ymax,o.resolution=s.extent.width/s.bitmapData.width,o.rotation=e.rotation,this._mapImageContainer.addChild(o),this._bitmapIndex.set(e,o)})}async _getViewDependentUrl(e,t){const{viewFormat:i,viewBoundScale:s,httpQuery:o}=e;if(i!=null){if(t==null)throw new Error("Loading this network link requires a view state.");let r;if(await lt(),s!=null&&s!==1){const _=new U(t.extent);_.expand(s),r=_}else r=t.extent;r=O(r,A.WGS84);const a=O(r,A.WebMercator),h=r.xmin,p=r.xmax,m=r.ymin,n=r.ymax,l=t.size[0]*t.pixelRatio,d=t.size[1]*t.pixelRatio,c=Math.max(a.width,a.height),u={"[bboxWest]":h.toString(),"[bboxEast]":p.toString(),"[bboxSouth]":m.toString(),"[bboxNorth]":n.toString(),"[lookatLon]":r.center.x.toString(),"[lookatLat]":r.center.y.toString(),"[lookatRange]":c.toString(),"[lookatTilt]":"0","[lookatHeading]":t.rotation.toString(),"[lookatTerrainLon]":r.center.x.toString(),"[lookatTerrainLat]":r.center.y.toString(),"[lookatTerrainAlt]":"0","[cameraLon]":r.center.x.toString(),"[cameraLat]":r.center.y.toString(),"[cameraAlt]":c.toString(),"[horizFov]":"60","[vertFov]":"60","[horizPixels]":l.toString(),"[vertPixels]":d.toString(),"[terrainEnabled]":"0","[clientVersion]":tt,"[kmlVersion]":"2.2","[clientName]":"ArcGIS API for JavaScript","[language]":"en-US"},y=_=>{for(const P in _){let v;for(v in u)_[P]=_[P].replace(v,u[v])}},S=q(i);y(S);let V={};o!=null&&(V=q(o),y(V));const I=ht(e.href);return I.query={...I.query,...S,...V},`${I.path}?${et(S)}`}return e.href}async _fetchService(e){const t=new H;await this._loadVisualData(this.layer.url,t,e),this._kmlVisualData=t,this._refreshCollections()}_refreshCollections(){this.allVisiblePoints.removeAll(),this.allVisiblePolylines.removeAll(),this.allVisiblePolygons.removeAll(),this.allVisibleMapImages.removeAll(),this.allVisiblePoints.addMany(this._kmlVisualData.allPoints.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisiblePolylines.addMany(this._kmlVisualData.allPolylines.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisiblePolygons.addMany(this._kmlVisualData.allPolygons.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e)),this.allVisibleMapImages.addMany(this._kmlVisualData.allMapImages.filter(e=>this._isSublayerVisible(e.sublayerId)).map(({item:e})=>e))}_isSublayerVisible(e){const t=this._kmlVisualData.allSublayers.get(e);return!!(t!=null&&t.visibility)&&(t.parentFolderId===-1||this._isSublayerVisible(t.parentFolderId))}_loadVisualData(e,t,i){return this._fetchParsedKML(e,i).then(async s=>{var o;for(const r of s.sublayers){t.allSublayers.set(r.id,r);const a=r.points?await j(r.points):[],h=r.polylines?await j(r.polylines):[],p=r.polygons?await j(r.polygons):[],m=((o=r.mapImages)==null?void 0:o.map(n=>x.fromJSON(n)))??[];if(t.allPoints.push(...a.map(n=>({item:n,sublayerId:r.id}))),t.allPolylines.push(...h.map(n=>({item:n,sublayerId:r.id}))),t.allPolygons.push(...p.map(n=>({item:n,sublayerId:r.id}))),t.allMapImages.push(...m.map(n=>({item:n,sublayerId:r.id}))),r.networkLink){const n=await this._getViewDependentUrl(r.networkLink,this.view.state);await this._loadVisualData(n,t,i)}}})}_fetchParsedKML(e,t){return Mt(e,this.layer.spatialReference,this.layer.refreshInterval,t).then(i=>kt(i.data))}_removeMapImage(e){const t=this._bitmapIndex.get(e);t&&(this._mapImageContainer.removeChild(t),this._bitmapIndex.delete(e))}};g([w()],b.prototype,"_pointsView",void 0),g([w()],b.prototype,"_polylinesView",void 0),g([w()],b.prototype,"_polygonsView",void 0),g([w()],b.prototype,"updating",void 0),b=g([J("esri.views.2d.layers.KMLLayerView2D")],b);const Et=b,_r=Object.freeze(Object.defineProperty({__proto__:null,default:Et},Symbol.toStringTag,{value:"Module"}));export{_r as K,gr as S,kt as d,Mt as g,K as j};
