import{ek as re,v as C,I as X,t as ce,cX as J,el as ue,cT as le,bM as fe,bd as de,ah as me,em as pe,en as ge,bg as _e,bn as U,D as we,bo as ye,y as ve,bp as G,bq as xe,br as Ie}from"./index-DT_2vTqg.js";import{f as Me,M as H}from"./vec2-BnynUbeJ-CKtGJQAy.js";import{r as Se}from"./Queue-B8H6jIv7-Di67S5Qa.js";import{o as j}from"./ReactiveMap-BaMcQuG3-CF68SCX9.js";import{o as Be}from"./signal-DxzURL18-CNLg-02N.js";import{b as Te}from"./quickselect-DHTstthl-Ds_Aj0x5.js";import{a as be}from"./Query-CxQYWcUQ-8fAvXq-1.js";let Y=class k{static getId(e,i,s,o){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${i}/${s}/${o}`}constructor(e,i,s,o){this.set(e,i,s,o)}get key(){return this}get id(){return this.toString()}get normalizedId(){return`${this.level}/${this.row}/${this.col}`}set id(e){this.set(e)}get hash(){const e=4095&this.row,i=4095&this.col,s=63&this.level;return(3&this.world)<<30|i<<22|e<<8|s}acquire(e,i,s,o){this.set(e,i,s,o)}contains(e){const i=e.level-this.level;return i>=0&&this.row===e.row>>i&&this.col===e.col>>i&&this.world===e.world}containsChild(e){const i=e.level-this.level;return i>0&&this.row===e.row>>i&&this.col===e.col>>i&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new k(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,i,s,o){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[r,l,n,h]=e.split("/");this.level=parseFloat(r),this.row=parseFloat(l),this.col=parseFloat(n),this.world=parseFloat(h)}else this.level=+e,this.row=+i,this.col=+s,this.world=+o||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new k(this.level-1,this.row>>1,this.col>>1,this.world)}getNormalizedNeighbor(e,i,s){const o=this.clone();return o.col+=e,o.row+=i,s.normalizeKey(o),o}getChildKeys(){const e=this.level+1,i=this.row<<1,s=this.col<<1,o=this.world;return[new k(e,i,s,o),new k(e,i,s+1,o),new k(e,i+1,s,o),new k(e,i+1,s+1,o)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};Y.pool=new re(Y,null,null,25,50);function P(t,e){return[t,e]}function F(t,e,i){return t[0]=e,t[1]=i,t}function Ce(t,e,i,s,o){return t[0]=e,t[1]=i,t[2]=s,t[3]=o,t}const x=new Y("0/0/0/0");let Fe=class ne{static create(e,i,s=null){const o=le(e.spatialReference),r=i.origin||P(e.origin.x,e.origin.y),l=P(e.size[0]*i.resolution,e.size[1]*i.resolution),n=P(-1/0,-1/0),h=P(1/0,1/0),a=P(1/0,1/0);s!=null&&(F(n,Math.max(0,Math.floor((s.xmin-r[0])/l[0])),Math.max(0,Math.floor((r[1]-s.ymax)/l[1]))),F(h,Math.max(0,Math.floor((s.xmax-r[0])/l[0])),Math.max(0,Math.floor((r[1]-s.ymin)/l[1]))),F(a,h[0]-n[0]+1,h[1]-n[1]+1));const{cols:c,rows:u}=i;let d,w,p,y;return!s&&c&&u&&(F(n,c[0],u[0]),F(h,c[1],u[1]),F(a,c[1]-c[0]+1,u[1]-u[0]+1)),e.isWrappable?(d=P(Math.ceil(Math.round((o.valid[1]-o.valid[0])/i.resolution)/e.size[0]),a[1]),w=!0,p=o.origin,y=o.valid):(d=a,w=!1),new ne(i.level,i.resolution,i.scale,r,n,h,a,l,d,w,p,y)}constructor(e,i,s,o,r,l,n,h,a,c,u,d){this.level=e,this.resolution=i,this.scale=s,this.origin=o,this.first=r,this.last=l,this.size=n,this.norm=h,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=u,this._spatialReferenceValid=d}normalizeCol(e){if(!this.wrap)return e;const i=this.worldSize[0];return e<0?i-1-Math.abs((e+1)%i):e%i}normalizeKey(e){if(!this.wrap)return;const i=this.worldSize[0],s=e.col;s<0?(e.col=s+i,e.world-=1):s>=i&&(e.col=s-i,e.world+=1)}denormalizeCol(e,i){return this.wrap?this.worldSize[0]*i+e:e}getWorldForColumn(e){return this.wrap?Math.floor(e/this.worldSize[0]):0}getFirstColumnForWorld(e){return e*this.worldSize[0]+this.first[0]}getLastColumnForWorld(e){return e*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(e){return(e-this.origin[0])/this.norm[0]}getXForColumn(e){const i=this.origin[0]+e*this.norm[0],s=this._spatialReferenceOrigin,o=this._spatialReferenceValid;return this.wrap&&s&&o?i===s[0]?o[0]:this.origin[0]===s[0]&&e===this.worldSize[0]?o[1]:i:i}getRowForY(e){return(this.origin[1]-e)/this.norm[1]}getYForRow(e){return this.origin[1]-e*this.norm[1]}getTileBounds(e,i,s=!1){x.set(i);const o=s?x.col:this.denormalizeCol(x.col,x.world),r=x.row;return Ce(e,this.getXForColumn(o),this.getYForRow(r+1),this.getXForColumn(o+1),this.getYForRow(r)),e}getTileCoords(e,i,s=!1){x.set(i);const o=s?x.col:this.denormalizeCol(x.col,x.world);return Array.isArray(e)?F(e,this.getXForColumn(o),this.getYForRow(x.row)):(e.x=this.getXForColumn(o),e.y=this.getYForRow(x.row)),e}},$=class{constructor(){this.spans=[]}acquire(t){this.lodInfo=t}release(){this.lodInfo=null,this.spans.length=0}*keys(){const t=this.lodInfo;for(const{row:e,colFrom:i,colTo:s}of this.spans)for(let o=i;o<=s;o++){const r=t.getWorldForColumn(o);yield new Y(t.level,e,t.normalizeCol(o),r)}}forEach(t,e){const{spans:i,lodInfo:s}=this,{level:o}=s;if(i.length!==0)for(const{row:r,colFrom:l,colTo:n}of i)for(let h=l;h<=n;h++)t.call(e,o,r,s.normalizeCol(h),s.getWorldForColumn(h))}};$.pool=new re($);let K=class{constructor(t,e,i){this.row=t,this.colFrom=e,this.colTo=i}};const m=new Y("0/0/0/0");let ze=class he{static create(e,i){e[1]>i[1]&&([e,i]=[i,e]);const[s,o]=e,[r,l]=i,n=r-s,h=l-o,a=h!==0?n/h:0,c=(Math.ceil(o)-o)*a,u=(Math.floor(o)-o)*a;return new he(s,Math.floor(o),Math.ceil(l),a,n<0?c:u,n<0?u:c,n<0?r:s,n<0?s:r)}constructor(e,i,s,o,r,l,n,h){this.x=e,this.ymin=i,this.ymax=s,this.invM=o,this.leftAdjust=r,this.rightAdjust=l,this.leftBound=n,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const v=[[0,0],[0,0],[0,0],[0,0]],ke=1e-6;let De=class{constructor(t,e=null,i=t.lods[0].level,s=t.lods[t.lods.length-1].level){this.tileInfo=t,this.fullExtent=e,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=t.lods.filter(l=>l.level>=i&&l.level<=s);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const r=this._lodInfos=o.map(l=>Fe.create(t,l,e));o.forEach((l,n)=>{this._infoByLevel[l.level]=r[n],this._infoByScale[l.scale]=r[n],this.scales[n]=l.scale},this),this._wrap=t.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(t){return this._infoByLevel[typeof t=="number"?t:t.level]}getTileBounds(t,e,i=!1){m.set(e);const s=this._infoByLevel[m.level];return s?s.getTileBounds(t,m,i):t}getTileCoords(t,e,i=!1){m.set(e);const s=this._infoByLevel[m.level];return s?s.getTileCoords(t,m,i):t}getTileCoverage(t,e=192,i=!0,s="closest"){if(!i&&(t.scale>this.minScale||t.scale<this.maxScale))return null;const o=s==="closest"?this.getClosestInfoForScale(t.scale):this.getSmallestInfoForScale(t.scale),r=$.pool.acquire(o),l=this._wrap;let n,h,a,c=1/0,u=-1/0;const d=r.spans;v[0][0]=v[0][1]=v[1][1]=v[3][0]=-e,v[1][0]=v[2][0]=t.size[0]+e,v[2][1]=v[3][1]=t.size[1]+e;for(const f of v)t.toMap(f,f),f[0]=o.getColumnForX(f[0]),f[1]=o.getRowForY(f[1]);const w=[];let p=3;for(let f=0;f<4;f++){if(v[f][1]===v[p][1]){p=f;continue}const g=ze.create(v[f],v[p]);c=Math.min(g.ymin,c),u=Math.max(g.ymax,u),w[g.ymin]===void 0&&(w[g.ymin]=[]),w[g.ymin].push(g),p=f}if(c==null||u==null||u-c>100)return null;let y=[];for(n=c;n<u;){w[n]!=null&&(y=y.concat(w[n])),h=1/0,a=-1/0;for(let f=y.length-1;f>=0;f--){const g=y[f];h=Math.min(h,g.getLeftCol()),a=Math.max(a,g.getRightCol())}if(h=Math.floor(h),a=Math.floor(a),n>=o.first[1]&&n<=o.last[1])if(l)if(o.size[0]<o.worldSize[0]){const f=Math.floor(a/o.worldSize[0]);for(let g=Math.floor(h/o.worldSize[0]);g<=f;g++)d.push(new K(n,Math.max(o.getFirstColumnForWorld(g),h),Math.min(o.getLastColumnForWorld(g),a)))}else d.push(new K(n,h,a));else h>o.last[0]||a<o.first[0]||(h=Math.max(h,o.first[0]),a=Math.min(a,o.last[0]),d.push(new K(n,h,a)));n+=1;for(let f=y.length-1;f>=0;f--){const g=y[f];g.ymax>=n?g.incrRow():y.splice(f,1)}}return r}getTileParentId(t){m.set(t);const e=this._infoByLevel[m.level],i=this._lodInfos.indexOf(e)-1;return i<0?null:(this._getTileIdAtLOD(m,this._lodInfos[i],m),m.id)}getTileResolution(t){const e=this._infoByLevel[typeof t=="object"?t.level:t];return e?e.resolution:-1}getTileScale(t){const e=this._infoByLevel[t.level];return e?e.scale:-1}intersects(t,e){m.set(e);const i=this._infoByLevel[m.level],s=t.lodInfo;if(s.resolution>i.resolution){this._getTileIdAtLOD(m,s,m);const r=s.denormalizeCol(m.col,m.world);for(const l of t.spans)if(l.row===m.row&&l.colFrom<=r&&l.colTo>=r)return!0}if(s.resolution<i.resolution){const[r,l,n,h]=t.spans.reduce((p,y)=>(p[0]=Math.min(p[0],y.row),p[1]=Math.max(p[1],y.row),p[2]=Math.min(p[2],y.colFrom),p[3]=Math.max(p[3],y.colTo),p),[1/0,-1/0,1/0,-1/0]),a=i.denormalizeCol(m.col,m.world),c=s.getColumnForX(i.getXForColumn(a)),u=s.getRowForY(i.getYForRow(m.row)),d=s.getColumnForX(i.getXForColumn(a+1))-1,w=s.getRowForY(i.getYForRow(m.row+1))-1;return!(c>h||d<n||u>l||w<r)}const o=s.denormalizeCol(m.col,m.world);return t.spans.some(r=>r.row===m.row&&r.colFrom<=o&&r.colTo>=o)}normalizeBounds(t,e,i){if(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],this._wrap){const s=le(this.tileInfo.spatialReference),o=-i*(s.valid[1]-s.valid[0]);t[0]+=o,t[2]+=o}return t}getSmallestInfoForScale(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t];if(t>e[0])return this._infoByScale[e[0]];for(let i=1;i<e.length-1;i++)if(t>e[i]+ke)return this._infoByScale[e[i-1]];return this._infoByScale[e[e.length-1]]}getClosestInfoForScale(t){const e=this.scales;return this._infoByScale[t]||(t=e.reduce((i,s)=>Math.abs(s-t)<Math.abs(i-t)?s:i,e[0])),this._infoByScale[t]}scaleToLevel(t){const e=this.scales;if(this._infoByScale[t])return this._infoByScale[t].level;for(let i=e.length-1;i>=0;i--)if(t<e[i])return i===e.length-1?this._infoByScale[e[e.length-1]].level:this._infoByScale[e[i]].level+(e[i]-t)/(e[i]-e[i+1]);return this._infoByScale[e[0]].level}scaleToZoom(t){return this.tileInfo.scaleToZoom(t)}zoomToScale(t){return this.tileInfo.zoomToScale(t)}_getTileIdAtLOD(t,e,i){const s=this._infoByLevel[i.level];return t.set(i),e.resolution<s.resolution?null:(e.resolution===s.resolution||(t.level=e.level,t.col=Math.floor(i.col*s.resolution/e.resolution+.01),t.row=Math.floor(i.row*s.resolution/e.resolution+.01)),t)}},Ye=class{constructor(t,e){this.item=t,this.controller=e,this.promise=null}};class Xe{constructor(e){this._schedule=null,this._task=null,this._deferreds=new j,this._controllers=new j,this._processingItems=new j,this._pausedSignal=Be(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new Se(e.peeker),this.process=e.process;const i=e.scheduler;e.priority&&i&&(this._task=i.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=U(this._schedule),this._task=U(this._task)}get updating(){var e;return!!((e=this._task)!=null&&e.updating)||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const i=this._controllers.get(e);i&&i.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(i=>e.push(i)),this._controllers.clear(),e.forEach(i=>i.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((i,s)=>e(s))}get(e){const i=this._deferreds.get(e);return i?i.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,i){const s=this.get(e);if(s)return s;const o=new AbortController;let r=null;i&&(r=we(i,()=>o.abort()));const l=()=>{const c=this._processingItems.get(e);c&&c.controller.abort(),n(),a.reject(G())},n=()=>{h.remove(),r==null||r.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},h=ye(o.signal,l),a=ve();return this._deferreds.set(e,a),this._controllers.set(e,o),a.promise.then(n,n),this._queue.push(e),this._scheduleNext(),a.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){var i;const e=this._queue.popLast();return e&&((i=this._deferreds.get(e))==null||i.reject(G()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const i of e)this._queue.push(i.item),i.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=xe(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,i){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(i))}_processError(e,i){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(i))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let i;const s=new AbortController,o=new Ye(e,s);this._processingItems.set(e,o);try{i=this.process(e,s.signal)}catch(r){this._processError(o,r)}Ie(i)?(o.promise=i,i.then(r=>this._processResult(o,r),r=>this._processError(o,r))):this._processResult(o,i)}get test(){}}const ee=[0,0];let B=class extends fe{constructor(t){super(t),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:t,process:e,scheduler:i,priority:s}=this;this._queue=new Xe({concurrency:t,scheduler:i,priority:s,process:(o,r)=>{const l=this._keyToItem.get(o);return e(l,{signal:r})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=de(this._queue)}get length(){return this._queue?this._queue.length:0}abort(t){const e=typeof t=="string"?t:t.id;this._queue.abort(e)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(t){return typeof t=="string"?this._keyToItem.has(t):this._keyToItem.has(t.id)}pause(){this._queue.pause()}push(t){const e=t.key.id;if(this._queue.has(e))return this._queue.get(e);const i=this._queue.push(e),s=this.tileInfoView.getTileScale(t.key),o=me(this._tilesByScale,s,()=>new Set),r=()=>{o.delete(t.key),o.size===0&&this._tilesByScale.delete(s),this._keyToItem.delete(e)};return o.add(t.key),this._keyToItem.set(e,t),i.then(r,r),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(t){if(!this.state)return t.values().next().value;const e=new Set;for(const r of t)e.add(this._keyToItem.get(r).key);const i=this.state.scale;let s,o=Number.POSITIVE_INFINITY;for(const[r,l]of this._tilesByScale)if(pe(l,n=>e.has(n))){const n=Math.abs(r-i);n<o&&(s=l,o=n)}return this._getClosestTileKey(s,t).id}_getClosestTileKey(t,e){const i=this.tileInfoView,s=this.state.center;let o,r=Number.POSITIVE_INFINITY;for(const l of t)if(e.has(l.id)){i.getTileCoords(ee,l);const n=Me(ee,s);n<r&&(r=n,o=l)}return o}};C([X({constructOnly:!0})],B.prototype,"concurrency",void 0),C([X({constructOnly:!0})],B.prototype,"priority",void 0),C([X({constructOnly:!0})],B.prototype,"process",void 0),C([X({constructOnly:!0})],B.prototype,"scheduler",void 0),C([X()],B.prototype,"state",void 0),C([X({constructOnly:!0})],B.prototype,"tileInfoView",void 0),B=C([ce("esri.views.2d.tiling.TileQueue")],B);const We=B;class Pe{constructor(e,i,s){this.maxSize=e,this._tileInfoView=i,this._removedFunc=s,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(e){return this._tilePerId.has(e)}get(e){return this._tilePerId.get(e)}pop(e){const i=this._tilePerId.get(e);if(!i)return;const s=i.key.level,o=this._tileKeysPerLevel[s];te(this._tilePerId,e);for(let r=0;r<o.length;r++)if(o[r].id===e){o.splice(r,1);break}return i.visible=!0,i}add(e){e.visible=!1;const i=e.key,s=i.id;if(this._tilePerId.has(s))return;this._tilePerId.set(s,e);const o=i.level;this._tileKeysPerLevel[o]||(this._tileKeysPerLevel[o]=[]),this._tileKeysPerLevel[o].push(i)}prune(e,i,s){let o=this._tilePerId.size;if(o<=this.maxSize)return;let r=this._tileKeysPerLevel.length-1;for(;o>this.maxSize&&r>=0;)r!==e&&(o=this._pruneAroundCenterTile(o,i,s,r)),r--;o>this.maxSize&&(o=this._pruneAroundCenterTile(o,i,s,e))}_pruneAroundCenterTile(e,i,s,o){const r=this._tileKeysPerLevel[o];if(!r||r.length===0)return e;const{size:l,origin:n}=this._tileInfoView.tileInfo,h=s*l[0],a=s*l[1],c=[0,0],u=[0,0];for(r.sort((d,w)=>(c[0]=n.x+h*(d.col+.5),c[1]=n.y-a*(d.row+.5),u[0]=n.x+h*(w.col+.5),u[1]=n.y-a*(w.row+.5),H(c,i)-H(u,i)));r.length>0;){const d=r.pop();if(this._removeTile(d.id),--e===this.maxSize)break}return e}_removeTile(e){const i=this._tilePerId.get(e);this._removedFunc&&i&&this._removedFunc(i),te(this._tilePerId,e)}}function te(t,e){t.delete(e)}const z=new Y(0,0,0,0),S=new Map,L=[],D=[];let Ze=class{constructor(t){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,t.resampling!=null&&(this.resampling=t.resampling),t.cachePolicy&&(this.cachePolicy=t.cachePolicy),t.coveragePolicy&&(this.coveragePolicy=t.coveragePolicy),t.buffer!=null&&(this.buffer=t.buffer),t.cacheSize&&(this._tileCache=new Pe(t.cacheSize,this.tileInfoView,e=>{this.releaseTile(e)}))}destroy(){this.tileIndex.clear()}update(t){var f,g;const{resampling:e,tileIndex:i}=this,{scale:s,center:o,resolution:r}=t.state,{minScale:l,maxScale:n}=this.tileInfoView,h=!t.stationary&&s>this._previousScale;if(this._previousScale=s,!e&&(s>l||s<n))return this.tiles.length=0,void this.clear();const a=this.tileInfoView.getTileCoverage(t.state,this.buffer,this.resampling,this.coveragePolicy);if(!a)return this.tiles.length=0,void this.clear();const{spans:c,lodInfo:u}=a,{level:d}=u;this.tiles.length=0,i.forEach(_=>_.visible=!0);let w=0,p=0;if(c.length>0)for(const{row:_,colFrom:b,colTo:E}of c)for(let T=b;T<=E;T++){w++;const I=z.set(d,_,u.normalizeCol(T),u.getWorldForColumn(T)).id;let M=i.get(I);if(M)M.isReady?(S.set(I,M),p++):h||this._addParentTile(I,S);else{if((f=this._tileCache)!=null&&f.has(I)){if(M=this._tileCache.pop(I),this.tileIndex.set(I,M),M.isReady){S.set(I,M),p++;continue}}else M=this.acquireTile(z),this.tileIndex.set(I,M);h||this._addParentTile(I,S)}}const y=p===w;for(const[_,b]of i){if(S.has(_))continue;z.set(_);const E=this.tileInfoView.intersects(a,z),T=this.cachePolicy==="purge"?z.level!==d:z.level>d;!E||!h&&y?!T&&E||L.push(b):b.isReady?T&&this.cachePolicy==="purge"&&this._hasReadyAncestor(z,d)?L.push(b):D.push(b):T&&L.push(b)}for(const _ of D)_.isReady&&S.set(_.key.id,_);for(const _ of L)this._tileCache?this._tileCache.add(_):this.releaseTile(_),i.delete(_.key.id);for(const _ of S.values())this.tiles.push(_);for(const _ of i.values())S.has(_.key.id)||(_.visible=!1);(g=this._tileCache)==null||g.prune(d,o,r),$.pool.release(a),D.length=0,L.length=0,S.clear()}clear(){const{tileIndex:t}=this;for(const e of t.values())this.releaseTile(e);t.clear()}refresh(t){var e;for(const i of this.tileIndex.values())t(i);(e=this._tileCache)==null||e.clear()}updateCacheSize(t){this._tileCache&&(this._tileCache.maxSize=t)}_addParentTile(t,e){var o;let i=t,s=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(s=this.tileIndex.get(i),s==null?void 0:s.isReady){e.has(s.key.id)||e.set(s.key.id,s);break}}else if((o=this._tileCache)!=null&&o.has(i)&&(s=this._tileCache.pop(i),this.tileIndex.set(i,s),s==null?void 0:s.isReady)){e.has(s.key.id)||e.set(s.key.id,s);break}}_hasReadyAncestor(t,e){const i=J();this.tileInfoView.getTileBounds(i,t,!0);for(const s of this.tileIndex.values())if(s.isReady&&s.key.level>=e&&s.key.level<t.level){const o=J();if(this.tileInfoView.getTileBounds(o,s.key,!0),ue(o,i))return!0}return!1}};function Q(t,e){if(!(this instanceof Q))return new Q(t,e);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),e&&(typeof e=="function"?this.toBBox=e:this._initFormat(e)),this.clear()}function Re(t,e,i){if(!i)return e.indexOf(t);for(var s=0;s<e.length;s++)if(i(t,e[s]))return s;return-1}function R(t,e){A(t,0,t.children.length,e,t)}function A(t,e,i,s,o){o||(o=q(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,l=e;l<i;l++)r=t.children[l],V(o,t.leaf?s(r):r);return o}function V(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function ie(t,e){return t.minX-e.minX}function se(t,e){return t.minY-e.minY}function W(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function N(t){return t.maxX-t.minX+(t.maxY-t.minY)}function qe(t,e){return(Math.max(e.maxX,t.maxX)-Math.min(e.minX,t.minX))*(Math.max(e.maxY,t.maxY)-Math.min(e.minY,t.minY))}function Le(t,e){var i=Math.max(t.minX,e.minX),s=Math.max(t.minY,e.minY),o=Math.min(t.maxX,e.maxX),r=Math.min(t.maxY,e.maxY);return Math.max(0,o-i)*Math.max(0,r-s)}function Z(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function O(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function q(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function oe(t,e,i,s,o){for(var r,l=[e,i];l.length;)(i=l.pop())-(e=l.pop())<=s||(r=e+Math.ceil((i-e)/s/2)*s,Te(t,r,e,i,o),l.push(e,r,r,i))}Q.prototype={all:function(){return this._all(this.data,[])},search:function(t){var e=this.data,i=[],s=this.toBBox;if(!O(t,e))return i;for(var o,r,l,n,h=[];e;){for(o=0,r=e.children.length;o<r;o++)l=e.children[o],O(t,n=e.leaf?s(l):l)&&(e.leaf?i.push(l):Z(t,n)?this._all(l,i):h.push(l));e=h.pop()}return i},collides:function(t){var e=this.data,i=this.toBBox;if(!O(t,e))return!1;for(var s,o,r,l,n=[];e;){for(s=0,o=e.children.length;s<o;s++)if(r=e.children[s],O(t,l=e.leaf?i(r):r)){if(e.leaf||Z(t,l))return!0;n.push(r)}e=n.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0,i=t.length;e<i;e++)this.insert(t[e]);return this}var s=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var o=this.data;this.data=s,s=o}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(t){return t!=null&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=q([]),this},remove:function(t,e){if(t==null)return this;for(var i,s,o,r,l=this.data,n=this.toBBox(t),h=[],a=[];l||h.length;){if(l||(l=h.pop(),s=h[h.length-1],i=a.pop(),r=!0),l.leaf&&(o=Re(t,l.children,e))!==-1)return l.children.splice(o,1),h.push(l),this._condense(h),this;r||l.leaf||!Z(l,n)?s?(i++,l=s.children[i],r=!1):l=null:(h.push(l),a.push(i),i=0,s=l,l=l.children[0])}return this},toBBox:function(t){return t},compareMinX:ie,compareMinY:se,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,e){for(var i=[];t;)t.leaf?e.push.apply(e,t.children):i.push.apply(i,t.children),t=i.pop();return e},_build:function(t,e,i,s){var o,r=i-e+1,l=this._maxEntries;if(r<=l)return R(o=q(t.slice(e,i+1)),this.toBBox),o;s||(s=Math.ceil(Math.log(r)/Math.log(l)),l=Math.ceil(r/Math.pow(l,s-1))),(o=q([])).leaf=!1,o.height=s;var n,h,a,c,u=Math.ceil(r/l),d=u*Math.ceil(Math.sqrt(l));for(oe(t,e,i,d,this.compareMinX),n=e;n<=i;n+=d)for(oe(t,n,a=Math.min(n+d-1,i),u,this.compareMinY),h=n;h<=a;h+=u)c=Math.min(h+u-1,a),o.children.push(this._build(t,h,c,s-1));return R(o,this.toBBox),o},_chooseSubtree:function(t,e,i,s){for(var o,r,l,n,h,a,c,u;s.push(e),!e.leaf&&s.length-1!==i;){for(c=u=1/0,o=0,r=e.children.length;o<r;o++)h=W(l=e.children[o]),(a=qe(t,l)-h)<u?(u=a,c=h<c?h:c,n=l):a===u&&h<c&&(c=h,n=l);e=n||e.children[0]}return e},_insert:function(t,e,i){var s=this.toBBox,o=i?t:s(t),r=[],l=this._chooseSubtree(o,this.data,e,r);for(l.children.push(t),V(l,o);e>=0&&r[e].children.length>this._maxEntries;)this._split(r,e),e--;this._adjustParentBBoxes(o,r,e)},_split:function(t,e){var i=t[e],s=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,s);var r=this._chooseSplitIndex(i,o,s),l=q(i.children.splice(r,i.children.length-r));l.height=i.height,l.leaf=i.leaf,R(i,this.toBBox),R(l,this.toBBox),e?t[e-1].children.push(l):this._splitRoot(i,l)},_splitRoot:function(t,e){this.data=q([t,e]),this.data.height=t.height+1,this.data.leaf=!1,R(this.data,this.toBBox)},_chooseSplitIndex:function(t,e,i){var s,o,r,l,n,h,a,c;for(h=a=1/0,s=e;s<=i-e;s++)l=Le(o=A(t,0,s,this.toBBox),r=A(t,s,i,this.toBBox)),n=W(o)+W(r),l<h?(h=l,c=s,a=n<a?n:a):l===h&&n<a&&(a=n,c=s);return c},_chooseSplitAxis:function(t,e,i){var s=t.leaf?this.compareMinX:ie,o=t.leaf?this.compareMinY:se;this._allDistMargin(t,e,i,s)<this._allDistMargin(t,e,i,o)&&t.children.sort(s)},_allDistMargin:function(t,e,i,s){t.children.sort(s);var o,r,l=this.toBBox,n=A(t,0,e,l),h=A(t,i-e,i,l),a=N(n)+N(h);for(o=e;o<i-e;o++)r=t.children[o],V(n,t.leaf?l(r):r),a+=N(n);for(o=i-e-1;o>=e;o--)r=t.children[o],V(h,t.leaf?l(r):r),a+=N(h);return a},_adjustParentBBoxes:function(t,e,i){for(var s=i;s>=0;s--)V(e[s],t)},_condense:function(t){for(var e,i=t.length-1;i>=0;i--)t[i].children.length===0?i>0?(e=t[i-1].children).splice(e.indexOf(t[i]),1):this.clear():R(t[i],this.toBBox)},_initFormat:function(t){var e=["return a"," - b",";"];this.compareMinX=new Function("a","b",e.join(t[0])),this.compareMinY=new Function("a","b",e.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};function Ae(t,{timeZone:e,timeExtent:i}){return{$view:{scale:t,timeZone:e,timeProperties:{currentStart:i==null?void 0:i.start,currentEnd:i==null?void 0:i.end}}}}class ae{constructor(e,i){this.key=new Y(0,0,0,0),this.bounds=J(),this.objectIds=new Set,this.key.set(i);const s=e.getLODInfoAt(this.key);this.tileInfoView=e,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=s.resolution,this.level=s.level,this.scale=s.scale,this.minScale=e.zoomToScale(s.level-1),this.maxScale=e.zoomToScale(s.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return ge(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(e){return Ae(this.scale,e)}createChildTiles(){const e=this.key.getChildKeys(),i=_e.acquire();for(let s=0;s<e.length;s++)i[s]=new ae(this.tileInfoView,e[s]);return i}getQuantizationParameters(){return be.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}export{Q as E,$ as R,Y as T,We as X,ae as Z,De as k,Ze as q,Ae as r};
