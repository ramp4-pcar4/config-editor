import{a8 as T,c as _}from"./index-uAe2c5m-.js";import{n as c}from"./BindType-CKbZk6AG-Bqvzo9NX.js";const l=()=>T.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class f{constructor(){this._includedModules=new Map}include(e,r){this._includedModules.has(e)?this._includedModules.get(e):(this._includedModules.set(e,r),e(this.builder,r))}}class M extends f{constructor(){super(...arguments),this.vertex=new g,this.fragment=new g,this.attributes=new E,this.varyings=new A,this.extensions=new h,this.outputs=new m}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e,r=!1){const t=this.extensions.generateSource(e),n=this.attributes.generateSource(e),i=this.varyings.generateSource(e),s=e==="vertex"?this.vertex:this.fragment,u=s.uniforms.generateSource(),d=s.code.generateSource(),$=s.main.generateSource(r),p=e==="vertex"?I:F,S=s.constants.generateSource(),b=this.outputs.generateSource(e);return`#version 300 es
${t.join(`
`)}
${p}
${S.join(`
`)}
${u.join(`
`)}
${n.join(`
`)}
${i.join(`
`)}
${b.join(`
`)}
${d.join(`
`)}
${$.join(`
`)}`}generateBind(e){const r=new Map;this.vertex.uniforms.entries.forEach(i=>{const s=i.bind[c.Bind];s&&r.set(i.name,s)}),this.fragment.uniforms.entries.forEach(i=>{const s=i.bind[c.Bind];s&&r.set(i.name,s)});const t=Array.from(r.values()),n=t.length;return i=>{for(let s=0;s<n;++s)t[s](e,i)}}generateBindPass(e){const r=new Map;this.vertex.uniforms.entries.forEach(i=>{const s=i.bind[c.Pass];s&&r.set(i.name,s)}),this.fragment.uniforms.entries.forEach(i=>{const s=i.bind[c.Pass];s&&r.set(i.name,s)});const t=Array.from(r.values()),n=t.length;return(i,s)=>{for(let u=0;u<n;++u)t[u](e,i,s)}}generateBindDraw(e){const r=new Map;this.vertex.uniforms.entries.forEach(i=>{const s=i.bind[c.Draw];s&&r.set(i.name,s)}),this.fragment.uniforms.entries.forEach(i=>{const s=i.bind[c.Draw];s&&r.set(i.name,s)});const t=Array.from(r.values()),n=t.length;return(i,s,u)=>{for(let d=0;d<n;++d)t[d](e,u,i,s)}}}class w{constructor(e){this._stage=e,this._entries=new Map}add(...e){for(const r of e)this._add(r);return this._stage}get(e){return this._entries.get(e)}_add(e){if(e!=null){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new _(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else l().error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(e=>e.arraySize!=null?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`)}get entries(){return Array.from(this._entries.values())}}class v{constructor(e){this._stage=e,this._bodies=new Array}add(e){return this._bodies.push(e),this._stage}generateSource(e){if(this._bodies.length>0)return[`void main() {
 ${this._bodies.join(`
`)||""} 
}`];if(e)throw new _("Shader does not contain main function body.");return[]}}class y{constructor(e){this._stage=e,this._entries=new Array}add(e){return this._entries.push(e),this._stage}generateSource(){return this._entries}}class g extends f{constructor(){super(...arguments),this.uniforms=new w(this),this.main=new v(this),this.code=new y(this),this.constants=new a(this)}get builder(){return this}}class E{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return e==="fragment"?[]:this._entries.map(r=>`in ${r[1]} ${r[0]};`)}}class A{constructor(){this._entries=new Map}add(e,r){this._entries.has(e)?l().warn(`Ignoring duplicate varying ${r} ${e}`):this._entries.set(e,r)}generateSource(e){const r=new Array;return this._entries.forEach((t,n)=>r.push(e==="vertex"?`out ${t} ${n};`:`in ${t} ${n};`)),r}}class h{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const r=e==="vertex"?h.ALLOWLIST_VERTEX:h.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(t=>r.includes(t)).map(t=>`#extension ${t} : enable`)}}h.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],h.ALLOWLIST_VERTEX=[];class m{constructor(){this._entries=new Map}add(e,r,t=0){const n=this._entries.get(t);(n==null?void 0:n.name)!==e||(n==null?void 0:n.type)!==r?this._entries.set(t,{name:e,type:r}):l().warn(`Fragment shader output location ${t} occupied`)}generateSource(e){if(e==="vertex")return[];this._entries.size===0&&this._entries.set(0,{name:m.DEFAULT_NAME,type:m.DEFAULT_TYPE});const r=new Array;return this._entries.forEach((t,n)=>r.push(`layout(location = ${n}) out ${t.type} ${t.name};`)),r}}m.DEFAULT_TYPE="vec4",m.DEFAULT_NAME="fragColor";class a{constructor(e){this._stage=e,this._entries=new Set}add(e,r,t){let n="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":n=a._numberToFloatStr(t);break;case"int":n=a._numberToIntStr(t);break;case"bool":n=t.toString();break;case"vec2":n=`vec2(${a._numberToFloatStr(t[0])},                            ${a._numberToFloatStr(t[1])})`;break;case"vec3":n=`vec3(${a._numberToFloatStr(t[0])},                            ${a._numberToFloatStr(t[1])},                            ${a._numberToFloatStr(t[2])})`;break;case"vec4":n=`vec4(${a._numberToFloatStr(t[0])},                            ${a._numberToFloatStr(t[1])},                            ${a._numberToFloatStr(t[2])},                            ${a._numberToFloatStr(t[3])})`;break;case"ivec2":n=`ivec2(${a._numberToIntStr(t[0])},                             ${a._numberToIntStr(t[1])})`;break;case"ivec3":n=`ivec3(${a._numberToIntStr(t[0])},                             ${a._numberToIntStr(t[1])},                             ${a._numberToIntStr(t[2])})`;break;case"ivec4":n=`ivec4(${a._numberToIntStr(t[0])},                             ${a._numberToIntStr(t[1])},                             ${a._numberToIntStr(t[2])},                             ${a._numberToIntStr(t[3])})`;break;case"mat2":case"mat3":case"mat4":n=`${r}(${Array.prototype.map.call(t,i=>a._numberToFloatStr(i)).join(", ")})`}return this._entries.add(`const ${r} ${e} = ${n};`),this._stage}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}}const F=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp int;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump int;
  precision mediump sampler2D;
#endif`,I=`precision highp float;
precision highp sampler2D;`;export{M as w};
