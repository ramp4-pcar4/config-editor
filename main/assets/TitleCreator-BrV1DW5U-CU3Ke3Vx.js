const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./featureUtils-BGz-Vwcn-CAqgwffc.js","./index-BeTPrQ6f.js","./index-BlWAJbpo.css","./messages-DQ10DjvF-6kk0dzjG.js","./utils-B2aAE6RS-DpuzYE1J.js","./mat4f32-BdRMyjXW-CWt6U0BP.js","./mat4-R0VY9B_E-DoEP887i.js","./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js"])))=>i.map(i=>d[i]);
import{aj as g,cE as y,_ as x,a7 as I,aB as _,fW as b,fx as T,m as l,E as n,n as v}from"./index-BeTPrQ6f.js";import{g as F}from"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import{o as k}from"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";const U="relationships/",w="expression/",A=/<br\s*\/*>/gi;let a=class extends g{constructor(e){super(e),this._featureUtils=null,this.effectivePopupTemplate=null}get _arcadeTask(){return this.expressionsUsedInTitle.length>0?this._get("_arcadeTask")||F(()=>y()):null}get featureUtilsPromise(){return this._get("featureUtilsPromise")??x(()=>import("./featureUtils-BGz-Vwcn-CAqgwffc.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url).then(e=>this._featureUtils=e)}get calculatedExpressions(){var s;const e=new I;if(!this.expressionsUsedInTitle.length)return e;if(!((s=this._arcadeTask)!=null&&s.value)){for(const t of this.expressionsUsedInTitle??[])e.push({name:t.name,invalid:!0});return e}for(const t of this.expressionsUsedInTitle)try{const i=this._arcadeTask.value.arcade.parseScript(t.expression,["$layer","$map","$datastore"]);if(i.isAsync){e.push({name:t.name,invalid:!0});break}e.push({name:t.name,syntax:i,invalid:!1,func:this._arcadeTask.value.arcade.compileScript(i,{vars:{$feature:"any"}})})}catch{e.push({name:t.name,invalid:!0});break}return e}get expressionsUsedInTitle(){var s,t,i;let e=((s=this.effectivePopupTemplate)==null?void 0:s.title)??"";return typeof e!="string"?[]:(e=e.toLowerCase(),((i=(t=this.effectivePopupTemplate)==null?void 0:t.expressionInfos)==null?void 0:i.filter(r=>e.includes(`{expression/${r.name.toLowerCase()}}`)))??[])}get fieldInfoMap(){return this._featureUtils?this._createFieldInfoMap(this._featureUtils.getAllFieldInfos(this.effectivePopupTemplate)):null}get hasBadExpressions(){return this.calculatedExpressions.some(e=>e.invalid===!0)}get requiredFields(){var t,i;const e=new Set;if((t=this._arcadeTask)!=null&&t.value&&!this.hasBadExpressions)for(const r of((i=this.calculatedExpressions)==null?void 0:i.toArray())??[])try{const o=this._arcadeTask.value.arcade.extractFieldLiterals(r.syntax);for(const u of o){const d=u.split("."),c=this.fieldsIndex.get(d.at(-1)??"");c&&e.add(c.name)}}catch{}const s=this._extractFieldNames(this.workingTitle);for(const r of s){const o=this.fieldsIndex.get(r);o&&e.add(o.name)}return this.objectIdField!=null&&e.add(this.objectIdField),e}get titleFromDisplayField(){var s,t;let e="";return this.displayField&&(e=((s=this.fieldsIndex.get(this.displayField))==null?void 0:s.name)??""),e||(e=((t=this.fieldsIndex.get(this.objectIdField))==null?void 0:t.name)??""),e?`{${e}}`:""}get workingTitle(){const e=this.effectivePopupTemplate?this.effectivePopupTemplate.title:"";return e===""||e==null||this.hasBadExpressions||typeof e!="string"?this.titleFromDisplayField:e}async getTitle(e,s,t){const i=s.getObjectId()??s.attributes[e.objectIdField];return(await this.getTitles(e,[s],t)).get(i)??""}async getTitles(e,s,t){var o;const i=new Map,r=(t==null?void 0:t.timeZone)??"system";try{const[{substituteFieldsInLinksAndAttributes:u}]=await Promise.all([this.featureUtilsPromise,(o=this._arcadeTask)==null?void 0:o.promise]);t!=null&&t.fetchMissingFields&&(s=await this._checkAndReQueryGraphics(e,s));const{fieldInfoMap:d,workingTitle:c}=this,p=c&&d;s.forEach(f=>{const m=f.getObjectId()??f.attributes[e.objectIdField];let h=p?u({attributes:f.attributes,expressionAttributes:null,fieldInfoMap:d,globalAttributes:this._createFormattedAttributes(e,f,r).global,layer:e,text:c}):"";t!=null&&t.removeHTML&&(h=k.sanitize(h).replaceAll(A," ")),i.set(m,h)})}catch{}return i}async _checkAndReQueryGraphics(e,s){const t=s.map(i=>i.getObjectId()??i.attributes[e.objectIdField]).filter(_);if(t.length!==s.length)return s;if(s.some(i=>!b(i,this.requiredFields))){const i=e.createQuery();i.where="1=1",i.outFields=[...this.requiredFields],i.objectIds=t;const r=await e.queryFeatures(i);if((r==null?void 0:r.features.length)===s.length)return r.features}return s}_createFieldInfoMap(e){const s=new Map;if(!e)return s;for(const t of e){if(!t.fieldName)continue;const i=this.fieldsIndex.get(t.fieldName),r=(i==null?void 0:i.name)??t.fieldName;t.fieldName=r,s.set(r.toLowerCase(),t)}return s}_createFormattedAttributes(e,s,t="system"){var u,d;const i=((u=this.effectivePopupTemplate)==null?void 0:u.fieldInfos)??[],r={};if(!this._featureUtils)return{};if(!this.hasBadExpressions&&this.calculatedExpressions.length>0&&((d=this._arcadeTask)!=null&&d.value)){const c=this._arcadeTask.value.Feature.createFromGraphicLikeObject(s.geometry,s.attributes,e,null);for(const p of this.calculatedExpressions)try{r[`expression/${p.name}`]=p.func({vars:{$feature:c}})}catch{}}const o={...s.attributes,...r};return{global:this._featureUtils.formatAttributes({fieldInfos:i,attributes:o,graphic:s,timeZone:t,layer:e,fieldInfoMap:this.fieldInfoMap}),content:[]}}_extractFieldNames(e){return T(e).filter(s=>!(s.startsWith(U)||s.startsWith(w)))}};l([n({readOnly:!0})],a.prototype,"_arcadeTask",null),l([n()],a.prototype,"_featureUtils",void 0),l([n({readOnly:!0})],a.prototype,"featureUtilsPromise",null),l([n({readOnly:!0})],a.prototype,"calculatedExpressions",null),l([n()],a.prototype,"displayField",void 0),l([n()],a.prototype,"effectivePopupTemplate",void 0),l([n()],a.prototype,"expressionsUsedInTitle",null),l([n()],a.prototype,"fieldsIndex",void 0),l([n()],a.prototype,"fieldInfoMap",null),l([n()],a.prototype,"fields",void 0),l([n()],a.prototype,"objectIdField",void 0),l([n()],a.prototype,"requiredFields",null),a=l([v("esri.layers.support.TitleCreator")],a);export{a};
