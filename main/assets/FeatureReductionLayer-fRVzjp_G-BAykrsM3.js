import{m as n,E as o,n as w,as as ee,aG as te,fF as y,fg as B,q as c,Y as $,fk as re,fG as ie,P as se,l as ne,ah as P,bo as oe,bO as k,c5 as Y,c0 as U,bP as F,R as S,fH as ae}from"./index-BeTPrQ6f.js";import{a as le}from"./GraphicOrigin-BZpgptRb-BMZxic91.js";import{e as ue}from"./layerContainerType-CJrPp4UB-BIF7XAYP.js";import{s as N,e as R}from"./FeatureReductionSelection-BYDlwJ5u-CQfZ-i0-.js";import{i as X,t as H}from"./OperationalLayer-Ds0FQSCg-DEUbTcjK.js";import{X as J,u as D}from"./labelingInfo-jIy5P_vY-D8rEl7NY.js";import{read as V}from"./jsonUtils-5anAqpiW-BnpEYfRl.js";import{_ as K}from"./typeUtils-BTAsL08--B1VjqkPN.js";import{t as G}from"./SimpleRenderer-DSyBXxyY-CGNZcXII.js";import{a as pe,g as _,o as de}from"./commonProperties-CYpRbAZr-PcmW9U_y.js";import{k as Q}from"./MD5-CXHDUqXT-CMrYdOi6.js";class ce extends le{constructor(s){super(),this.type="aggregate",this.featureReductionProvider=s}get id(){return this.featureReductionProvider.id}get[re](){const s=this.featureReductionProvider.featureReduction;return s&&"popupTemplate"in s?s:null}}let f=class extends oe($){constructor(r){super(r),this.expression=null,this.title=null,this.returnType=null}};n([o({type:String,json:{write:!0}})],f.prototype,"expression",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"title",void 0),n([o({type:String,json:{write:!0}})],f.prototype,"returnType",void 0),f=n([w("esri.layers.support.ExpressionInfo")],f);var z,h;let d=(h=class extends ${constructor(s){super(s),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new z({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:c(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}},z=h,h);n([o({type:Boolean,json:{write:!0}})],d.prototype,"isAutoGenerated",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"name",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"alias",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"onStatisticField",void 0),n([o({type:f,json:{write:!0}})],d.prototype,"onStatisticExpression",void 0),n([o({type:String,json:{write:!0}})],d.prototype,"statisticType",void 0),d=z=n([w("esri.layers.support.AggregateField")],d);var T;let p=T=class extends R{constructor(r){super(r),this.type="binning",this.binType="geohash",this.fixedBinLevel=null,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.size=y("12px"),this.fields=[],this.renderer=null}writeFields(r,s,t){const i=r.filter(e=>e.statisticType!=="avg_angle").map(e=>e.toJSON());B(t,i,s)}readRenderer(r,s,t){var e;const i=(e=s.drawingInfo)==null?void 0:e.renderer;return i?V(i,s,t)??void 0:J(s,t)}clone(){return new T({fields:c(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate),renderer:c(this.renderer),binType:c(this.binType),size:this.size})}};n([k({binning:"binning"})],p.prototype,"type",void 0),n([k({geohash:"geohash",square:"square"}),o({type:["geohash","square"]})],p.prototype,"binType",void 0),n([o({type:Number,json:{write:!0}})],p.prototype,"fixedBinLevel",void 0),n([o({type:[D],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],p.prototype,"labelingInfo",void 0),n([o(X)],p.prototype,"labelsVisible",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],p.prototype,"maxScale",void 0),n([o(H)],p.prototype,"popupEnabled",void 0),n([o({type:Y,json:{name:"popupInfo",write:!0}})],p.prototype,"popupTemplate",void 0),n([o({cast:r=>r==="auto"?r:U(y(r))})],p.prototype,"size",void 0),n([o({type:[d],json:{write:!0}})],p.prototype,"fields",void 0),n([F("fields")],p.prototype,"writeFields",null),n([o({types:K,json:{write:{target:"drawingInfo.renderer"}}})],p.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],p.prototype,"readRenderer",null),p=T=n([w("esri.layers.support.FeatureReductionBinning")],p);var j;function q(r){var s;return r.type==="simple"&&!((s=r.visualVariables)!=null&&s.length)}let u=j=class extends ${constructor(r){super(r),this.type="cluster",this.clusterRadius=y("80px"),this.clusterMinSize=y("12px"),this.clusterMaxSize=y("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=[]}readRenderer(r,s,t){var e,a;const i=(e=s.drawingInfo)==null?void 0:e.renderer;return(a=i==null?void 0:i.authoringInfo)!=null&&a.isAutoGenerated?null:i?q(i)?null:V(i,s,t)??void 0:J(s,t)}readSymbol(r,s,t){var e,a,l;const i=(e=s.drawingInfo)==null?void 0:e.renderer;return(a=i==null?void 0:i.authoringInfo)!=null&&a.isAutoGenerated?null:i&&q(i)?(l=V(i,s,t))==null?void 0:l.symbol:null}writeSymbol(r,s,t,i){var a,l;const e=(l=(a=this.renderer)==null?void 0:a.authoringInfo)==null?void 0:l.isAutoGenerated;if(!this.renderer||e){const v=new G({symbol:r});s.drawingInfo={renderer:v.write({},i)}}}writeFields(r,s,t){const i=r.filter(e=>e.statisticType!=="avg_angle").map(e=>e.toJSON());B(t,i,s)}readFields(r,s,t){return r.filter(i=>!i.isAutoGenerated).map(i=>d.fromJSON(i))}clone(){return new j({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:c(this.labelingInfo),labelsVisible:this.labelsVisible,fields:c(this.fields),maxScale:this.maxScale,renderer:c(this.renderer),symbol:c(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:c(this.popupTemplate)})}};n([o({type:["cluster"],readOnly:!0,json:{write:!0}})],u.prototype,"type",void 0),n([o({cast:r=>r==="auto"?r:U(y(r)),json:{write:!0}})],u.prototype,"clusterRadius",void 0),n([o({type:Number,cast:y,json:{write:!0}})],u.prototype,"clusterMinSize",void 0),n([o({type:Number,cast:y,json:{write:!0}})],u.prototype,"clusterMaxSize",void 0),n([o({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],u.prototype,"maxScale",void 0),n([o(H)],u.prototype,"popupEnabled",void 0),n([o({type:Y,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],u.prototype,"popupTemplate",void 0),n([o({types:K,json:{write:{target:"drawingInfo.renderer"}}})],u.prototype,"renderer",void 0),n([S("renderer",["drawingInfo.renderer"])],u.prototype,"readRenderer",null),n([o({types:ae})],u.prototype,"symbol",void 0),n([S("symbol",["drawingInfo.renderer"])],u.prototype,"readSymbol",null),n([F("symbol")],u.prototype,"writeSymbol",null),n([o({type:[D],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],u.prototype,"labelingInfo",void 0),n([o(X)],u.prototype,"labelsVisible",void 0),n([o({type:[d],json:{write:!0}})],u.prototype,"fields",void 0),n([F("fields")],u.prototype,"writeFields",null),n([S("fields")],u.prototype,"readFields",null),u=j=n([w("esri.layers.support.FeatureReductionCluster")],u);const L={key:"type",base:R,typeMap:{cluster:u,binning:p}},fe={types:{key:"type",base:R,typeMap:{selection:N,cluster:u,binning:p}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:L},"portal-item":{types:L},"web-scene":{types:{key:"type",base:R,typeMap:{selection:N}},name:"layerDefinition.featureReduction",write:{allowNull:!0,layerContainerTypes:ue}}}}},ye=()=>se.getLogger("esri.views.2d.layers.support.clusterUtils");P.add("esri-cluster-arcade-enabled",!0);const me=P("esri-cluster-arcade-enabled"),be=new Set(["simple-line","simple-fill","picture-fill"]);function O(r,s){let t=s.clone();if(!he(t))return t;if(s.symbols.some(i=>be.has(i.type))&&(t=new G({symbol:new ie})),t.authoringInfo||(t.authoringInfo=new de),t.authoringInfo.isAutoGenerated=!0,"visualVariables"in t){const i=(t.visualVariables||[]).filter(e=>e.valueExpression!=="$view.scale");i.forEach(e=>{e.type==="rotation"?e.field?e.field=m(r,e.field,"avg_angle","number"):e.valueExpression&&(e.field=g(r,e.valueExpression,"avg_angle","number"),e.valueExpression=null):e.normalizationField?(e.field=m(r,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=null):e.field?e.field=m(r,e.field,"avg","number"):e.valueExpression&&(e.field=g(r,e.valueExpression,"avg","number"),e.valueExpression=null)}),t.visualVariables=i}switch(t.type){case"simple":break;case"pie-chart":for(const i of t.attributes)i.field?i.field=m(r,i.field,"sum","number"):i.valueExpression&&(i.field=g(r,i.valueExpression,"sum","number"),i.valueExpression=null);break;case"unique-value":t.field?t.field=m(r,t.field,"mode","string"):t.valueExpression&&(t.field=g(r,t.valueExpression,"mode","string"),t.valueExpression=null);break;case"class-breaks":t.normalizationField?(t.field=m(r,t.field,"avg_norm","number",t.normalizationField),t.normalizationField=null):t.field?t.field=m(r,t.field,"avg","number"):t.valueExpression&&(t.field=g(r,t.valueExpression,"avg","number"),t.valueExpression=null)}return t}const he=r=>{const s=t=>ye().error(new ne("Unsupported-renderer",t,{renderer:r}));if(!r)return!1;switch(r.type){case"unique-value":if(r.field2||r.field3)return s("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(r.normalizationField){const t=r.normalizationType;if(t!=="field")return s(`FeatureReductionCluster does not support a normalizationType of ${t}`),!1}break;case"simple":case"pie-chart":break;default:return s(`FeatureReductionCluster does not support renderers of type ${r.type}`),!1}if(!me){if("valueExpression"in r&&r.valueExpression)return s("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in r&&r.visualVariables||[]).some(t=>!(!("valueExpression"in t)||!t.valueExpression)))return s("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function ve(r,s,t){switch(r){case"sum":return`cluster_sum_${s}`;case"avg":case"avg_angle":return`cluster_avg_${s}`;case"mode":return`cluster_type_${s}`;case"avg_norm":{const i=t,e="field",a=s.toLowerCase()+",norm:"+e+","+i.toLowerCase();return"cluster_avg_"+Q(a)}}}function g(r,s,t,i){const e=Q(s),a=t==="mode"?`cluster_type_${e}`:t==="sum"?`cluster_sum_${e}`:`cluster_avg_${e}`;return r.some(l=>l.name===a)||r.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:s,returnType:i}),statisticType:t})),a}function m(r,s,t,i,e){if(s==="cluster_count"||r.some(l=>l.name===s))return s;const a=ve(t,s,e);return r.some(l=>l.name===a)||(t==="avg_norm"?r.push(new d({name:a,isAutoGenerated:!0,onStatisticExpression:new f({expression:`$feature.${s} / $feature.${e}`,returnType:i}),statisticType:"avg"})):r.push(new d({name:a,isAutoGenerated:!0,onStatisticField:s,statisticType:t}))),a}const Te=r=>{const s=r;let t=class extends s{constructor(...i){super(...i),this.aggregateGraphicOrigin=new ce(this),this.addHandles(ee(()=>this.renderer,()=>{if(this.featureReduction){const e=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",e)}},te))}set featureReduction(i){const e=this._normalizeFeatureReduction(i);this._set("featureReduction",e)}set renderer(i){}_withClusterVariable(i,e,a){const l=i.clone();return"visualVariables"in l&&(l.visualVariables||(l.visualVariables=[]),l.visualVariables.some(v=>v.type==="size")||l.visualVariables.push(new pe({field:"cluster_count",stops:[new _({value:1}),new _({useMinValue:!0,size:e}),new _({useMaxValue:!0,size:a})]}))),l}_normalizeFeatureReduction(i){var M;if((i==null?void 0:i.type)!=="cluster")return i;const e=i.clone(),a=[new d({name:"cluster_count",alias:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],l=(e.fields??[]).filter(b=>!b.isAutoGenerated),v=i.renderer&&!((M=i.renderer.authoringInfo)!=null&&M.isAutoGenerated),{clusterMinSize:E,clusterMaxSize:I}=e;if(v){e.fields=[...a,...l];const b=this._withClusterVariable(e.renderer,E,I);return e.effectiveFeatureRenderer=b,e.effectiveClusterRenderer=b,e}if(i.symbol){if(e.fields=[...a,...l],e.renderer=null,!this.renderer)return e.effectiveFeatureRenderer=null,e.effectiveClusterRenderer=null,e;const b=O(a,this.renderer),x=this._withClusterVariable(b,E,I),Z="visualVariables"in x&&x.visualVariables?x.visualVariables:[],W=new G({symbol:i.symbol,visualVariables:Z});return e.fields=[...a,...l],e.effectiveFeatureRenderer=x,e.effectiveClusterRenderer=W,e}if(!this.renderer)return i;const C=O(a,this.renderer);e.fields=[...a,...l],e.renderer=C;const A=this._withClusterVariable(C,E,I);return e.effectiveFeatureRenderer=A,e.effectiveClusterRenderer=A,e}};return n([o({readOnly:!0,clonable:!1})],t.prototype,"aggregateGraphicOrigin",void 0),n([o(fe)],t.prototype,"featureReduction",null),t=n([w("esri.layers.mixins.FeatureReductionLayer")],t),t};export{fe as X,d,Te as h};
