const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-DSz2HLee-eGsTJNXZ.js","./index-JysQxb7m.js","./index-BQSptJp9.css","./mat4f64-xsZDPPj0-Dq35B4BL.js","./enums-wEDHPbCF-Cf76M5_x.js","./Version-CnwD6MZa-BFgcISMZ.js","./mat4-OOmHNWi7-d4wDSfI3.js","./common-CYWrYyJl-E8-sukrT.js","./quat-DQgq9Ar5-l74UySta.js","./mat3f64-BnNZDR5l-Bz3OL2oI.js","./quatf64-C16JxGFv-BKWK1F8U.js","./vec32-Cj8pVsU0-Cq-HgVHC.js","./vec42-D8CJyqHG-DnfLTeQH.js","./BufferView-wDxx79o3-D6bX1Vjh.js","./vec2-BnynUbeJ-CKtGJQAy.js","./vec2f64-CkowXrDb-3zFQ3LNH.js","./vec4f64-DD-nkcCV-CSNWKRqG.js","./resourceUtils-Tz7BBTTs-DVRKopYi.js","./basicInterfaces-Dsf65ICa-DkQ9Rsnx.js"])))=>i.map(i=>d[i]);
import{_ as we,jh as ae,lS as D,j3 as Y,N as ve,t as ie,h as Me,k3 as Q,j5 as le,du as H,a6 as Re}from"./index-JysQxb7m.js";import{m as Ae}from"./devEnvironmentUtils-CxrVv3RG-ktR0Kqgv.js";import{E as J,X as Be,P as Se}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{r as K,n as ue}from"./mat3f64-BnNZDR5l-Bz3OL2oI.js";import{z as Oe}from"./mat4-OOmHNWi7-d4wDSfI3.js";import{n as Pe}from"./mat4f64-xsZDPPj0-Dq35B4BL.js";import{_ as $e}from"./vec2f64-CkowXrDb-3zFQ3LNH.js";import{Y as Z,r as Ie,x as ee,b as Ee,l as ke,X as _e}from"./vec32-Cj8pVsU0-Cq-HgVHC.js";import{j,M as ce,v as me}from"./OutputColorHighlightOID.glsl-BdXTjs7_-b7pB-v53.js";import{L as fe,U as Ue,k as Ce,T as pe,S as Fe,_ as Le}from"./BufferView-wDxx79o3-D6bX1Vjh.js";import{b as Ne,z as je,T as te,R as re}from"./vec3-lTcIGC_C-CRKJlLQ9.js";import{P as qe,R as oe}from"./vec4-FWCYsiir-B4oh35ih.js";import{T as De,N as Ve,l as Ge}from"./indexUtils-l8XrgMvJ-BeDe9oE5.js";import{g as q}from"./resourceUtils-Tz7BBTTs-DVRKopYi.js";import{f as ze,l as Xe}from"./vec2f32-hTAvipMV-C0AQcwEv.js";import{k as de}from"./asyncUtils-BPUlNCrX-BS2LVKAY.js";import{i as He}from"./memoryEstimations-DeWfxwaV-BnbU1TaS.js";import{u as Ke}from"./NestedMap-DL9KstBd-DzPVXgde.js";import{m as he}from"./Version-CnwD6MZa-BFgcISMZ.js";import{w as We}from"./Indices-BuIC5D20-c3vAII3R.js";import{r as Ye}from"./requestImageUtils-B2YN5Eb9-LXcNbcw6.js";import{M as U}from"./orientedBoundingBox-CSC169JG-D2AdqLxV.js";import{N as B,s as Qe,e as W}from"./basicInterfaces-Dsf65ICa-DkQ9Rsnx.js";import{T as k}from"./VertexAttribute-hUz6pozM-Bx3V-z96.js";import{s as Je,v as Ze,B as V,i as et,n as tt}from"./DefaultMaterial-7UvmJfZD-h_XrENHl.js";import{U as se}from"./enums-wEDHPbCF-Cf76M5_x.js";import{a as ne}from"./NormalAttribute.glsl-BnbqDItl-CFtRyIV6.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./videoUtils-Scb4DgCQ-Di-w4w4a.js";import"./TextureFormat-Cl0ugX3E-DD0Aw8RG.js";import"./Texture-D5XWO2GQ-Ci0c00Q9.js";import"./getDataTypeBytes-DYbftOSj-BNZIboqJ.js";import"./triangle-BM89wdHY-C4RiBl_1.js";import"./sphere-zPMQWhGG-DHiNq8Z2.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./vectorStacks-5ZZtmT9E-Yd4fhXgC.js";import"./quatf64-C16JxGFv-BKWK1F8U.js";import"./lineSegment-BAWQVP9P-BrsFXHnG.js";import"./glsl-Z5uYj8ka-BRgh2Cgo.js";import"./BindType-CKbZk6AG-Bqvzo9NX.js";import"./ShaderOutput-CUn9tpiG-CW1Nc608.js";import"./renderState-BM-MCKUz-CkGIEsl7.js";import"./ViewingMode-CdRKcXnc-Dab70bGf.js";import"./lengthUtils-C61nRlXw-CbFzxkTc.js";import"./boundedPlane-QDtjx5eO-9qnLVMa0.js";import"./plane-Cf3Koz3c-DCCEvwZa.js";import"./projectionUtils-B-CplN3q-DYZZu_-u.js";import"./vec2-BnynUbeJ-CKtGJQAy.js";import"./quat-DQgq9Ar5-l74UySta.js";import"./spatialReferenceEllipsoidUtils-BK0OQJn2-ErlLtZyA.js";import"./computeTranslationToOriginAndRotation-e-ft1lOz-DlYgTKZ8.js";import"./InterleavedLayout-C2YUDwKf-aJK3Ayvw.js";import"./types-l27bT09Q-DE0QfIFp.js";import"./ShaderBuilder-CU5v4tk1-Czjcr6AQ.js";function C(r){if(r==null)return null;const e=r.offset!=null?r.offset:ze,s=r.rotation!=null?r.rotation:0,o=r.scale!=null?r.scale:Xe,u=K(1,0,0,0,1,0,e[0],e[1],1),i=K(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=K(o[0],0,0,0,o[1],0,0,0,1),a=ue();return J(a,i,n),J(a,u,a),a}class rt{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class ot{constructor(e,s,o){this.name=e,this.lodThreshold=s,this.pivotOffset=o,this.stageResources=new rt,this.numberOfVertices=0}}const P=()=>Re.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class st{constructor(e,s,o){this.resource=e,this.textures=s,this.cachedMemory=o}}async function nt(r,e){const s=await at(r,e),o=await mt(s.textureDefinitions??{},e);let u=0;for(const i in o)if(o.hasOwnProperty(i)){const n=o[i];u+=n!=null&&n.image?n.image.width*n.image.height*4:0}return new st(s,o,u+He(s))}async function at(r,e){const s=e==null?void 0:e.streamDataRequester;if(s)return it(r,s,e);const o=await de(ve(r,e));if(o.ok===!0)return o.value.data;ie(o.error),xe(o.error)}async function it(r,e,s){const o=await de(e.request(r,"json",s));if(o.ok===!0)return o.value;ie(o.error),xe(o.error.details.url)}function xe(r){throw new Me("",`Request for object resource failed: ${r}`)}function lt(r){const e=r.params,s=e.topology;let o=!0;switch(e.vertexAttributes||(P().warn("Geometry must specify vertex attributes"),o=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const n in e.vertexAttributes){const a=i[n];a!=null&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(P().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),o=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(P().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),o=!1)):(P().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),o=!1)}}else P().warn("Indexed geometries must specify faces"),o=!1;break}default:P().warn(`Unsupported topology '${s}'`),o=!1}r.params.material||(P().warn("Geometry requires material"),o=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(P().warn("Geometries with externally defined attributes are not yet supported"),o=!1);return o}function ut(r,e){var x,p;const s=new Array,o=new Array,u=new Array,i=new Ke,n=r.resource,a=he.parse(n.version||"1.0","wosr");pt.validate(a);const m=n.model.name,t=n.model.geometries,l=n.materialDefinitions??{},c=r.textures;let d=0;const h=new Map;for(let b=0;b<t.length;b++){const g=t[b];if(!lt(g))continue;const v=ft(g),w=g.params.vertexAttributes,R=[],y=f=>{if(g.params.topology==="PerAttributeArray")return null;const M=g.params.faces;for(const T in M)if(T===f)return M[T].values;return null},$=w[k.POSITION],F=$.values.length/$.valuesPerElement;for(const f in w){const M=w[f],T=M.values,z=y(f)??We(F);R.push([f,new U(T,z,M.valuesPerElement,!0)])}const S=v.texture,O=c&&c[S];if(O&&!h.has(S)){const{image:f,parameters:M}=O,T=new me(f,M);o.push(T),h.set(S,T)}const L=h.get(S),G=L?L.id:void 0,A=v.material;let I=i.get(A,S);if(I==null){const f=l[A.slice(A.lastIndexOf("/")+1)].params;f.transparency===1&&(f.transparency=0);const M=O?ge(O.alphaChannelUsage):void 0,T={ambient:Q(f.diffuse),diffuse:Q(f.diffuse),opacity:1-(f.transparency||0),textureAlphaMode:M,textureAlphaCutoff:.33,textureId:G,doubleSided:!0,cullFace:W.None,colorMixMode:f.externalColorMixMode||"tint",textureAlphaPremultiplied:(O==null?void 0:O.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(T,e.materialParameters),I=new V(T,e),i.set(A,S,I)}u.push(I);const N=new ce(I,R);d+=((p=(x=R.find(f=>f[0]===k.POSITION))==null?void 0:x[1])==null?void 0:p.indices.length)??0,s.push(N)}return{engineResources:[{name:m,stageResources:{textures:o,materials:u,geometries:s},pivotOffset:n.model.pivotOffset,numberOfVertices:d,lodThreshold:null}],referenceBoundingBox:ct(s)}}function ct(r){const e=ae();return r.forEach(s=>{const o=s.boundingInfo;o!=null&&(D(e,o.bbMin),D(e,o.bbMax))}),e}async function mt(r,e){const s=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){P().warn("Externally referenced texture data is not yet supported");continue}const m=n.encoding+";base64,"+a,t="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:se.REPEAT,t:se.REPEAT},preMultiplyAlpha:ge(l)!==B.Opaque},d=e!=null&&e.disableTextures?Promise.resolve(null):Ye(m,e);s.push(d.then(h=>({refId:t,image:h,parameters:c,alphaChannelUsage:l})))}const o=await Promise.all(s),u={};for(const i of o)u[i.refId]=i;return u}function ge(r){switch(r){case"mask":return B.Mask;case"maskAndTransparency":return B.MaskBlend;case"none":return B.Opaque;default:return B.Blend}}function ft(r){const e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const pt=new he(1,2,"wosr");async function dt(r,e){var c;const s=Te(Ae(r));if(s.fileType==="wosr"){const d=await(e.cache?e.cache.loadWOSR(s.url,e):nt(s.url,e)),{engineResources:h,referenceBoundingBox:x}=ut(d,e);return{lods:h,referenceBoundingBox:x,isEsriSymbolResource:!1,isWosr:!0}}let o;if(e.cache)o=await e.cache.loadGLTF(s.url,e,!!e.usePBR);else{const{loadGLTF:d}=await we(()=>import("./loader-DSz2HLee-eGsTJNXZ.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]),import.meta.url);o=await d(new De(e.streamDataRequester),s.url,e,e.usePBR)}const u=(c=o.model.meta)==null?void 0:c.ESRI_proxyEllipsoid,i=o.meta.isEsriSymbolResource&&u!=null&&o.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!o.customMeta.esriTreeRendering&&(o.customMeta.esriTreeRendering=!0,yt(o,u));const n=!!e.usePBR,a=o.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:Je}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Ze},m={...e.materialParameters,treeRendering:i},{engineResources:t,referenceBoundingBox:l}=ht(o,a,m,e,s.specifiedLodIndex,i);return{lods:t,referenceBoundingBox:l,isEsriSymbolResource:o.meta.isEsriSymbolResource,isWosr:!1}}function Te(r){const e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function ht(r,e,s,o,u,i){const n=r.model,a=new Array,m=new Map,t=new Map,l=n.lods.length,c=ae();return n.lods.forEach((d,h)=>{const x=o.skipHighLods===!0&&(l>1&&h===0||l>3&&h===1)||o.skipHighLods===!1&&u!=null&&h!==u;if(x&&h!==0)return;const p=new ot(d.name,d.lodThreshold,[0,0,0]);d.parts.forEach(b=>{const g=x?new V({},o):xt(n,b,p,e,s,m,t,o,i),{geometry:v,vertexCount:w}=gt(b,g??new V({},o)),R=v.boundingInfo;R!=null&&h===0&&(D(c,R.bbMin),D(c,R.bbMax)),g!=null&&(p.stageResources.geometries.push(v),p.numberOfVertices+=w)}),x||a.push(p)}),{engineResources:a,referenceBoundingBox:c}}function xt(r,e,s,o,u,i,n,a,m){var w,R;const t=r.materials.get(e.material);if(t==null)return null;const{normal:l,color:c,texCoord0:d,tangent:h}=e.attributes,x=e.material+(l?"_normal":"")+(c?"_color":"")+(d?"_texCoord0":"")+(h?"_tangent":""),p=e.attributes.texCoord0!=null,b=e.attributes.normal!=null,g=Tt(t.alphaMode);if(!i.has(x)){if(p){const f=(T,z=!1,ye=!1)=>{if(T!=null&&!n.has(T)){const X=r.textures.get(T);if(X){const E=X.data,be=z&&!q(E)?a.compressionOptions:void 0;n.set(T,new me(q(E)?E.data:E,{...X.parameters,preMultiplyAlpha:!q(E)&&ye,encoding:q(E)?E.encoding:void 0,compressionOptions:be}))}}},M=g!==B.Opaque&&!m;f(t.colorTexture,M,g!==B.Opaque),f(t.normalTexture),f(t.occlusionTexture,!0),f(t.emissiveTexture),f(t.metallicRoughnessTexture,!0)}const y=1/le,$=t.color[0]**y,F=t.color[1]**y,S=t.color[2]**y,O=t.emissiveFactor[0]**y,L=t.emissiveFactor[1]**y,G=t.emissiveFactor[2]**y,A=t.colorTexture!=null&&p?n.get(t.colorTexture):null,I=et(t),N=((w=t.normalTextureTransform)==null?void 0:w.scale)!=null?(R=t.normalTextureTransform)==null?void 0:R.scale:$e;i.set(x,new V({...o,customDepthTest:Qe.Lequal,textureAlphaMode:g,textureAlphaCutoff:t.alphaCutoff,diffuse:[$,F,S],ambient:[$,F,S],opacity:t.alphaMode==="OPAQUE"?1:t.opacity,doubleSided:t.doubleSided,doubleSidedType:"winding-order",cullFace:t.doubleSided?W.None:W.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:b?ne.Attribute:ne.ScreenDerivative,castShadows:!0,receiveShadows:t.receiveShadows,receiveAmbientOcclusion:t.receiveAmbientOcclusion,textureId:A==null?void 0:A.id,colorMixMode:t.colorMixMode,normalTextureId:t.normalTexture!=null&&p?n.get(t.normalTexture).id:void 0,textureAlphaPremultiplied:A!=null&&!!A.parameters.preMultiplyAlpha,occlusionTextureId:t.occlusionTexture!=null&&p?n.get(t.occlusionTexture).id:void 0,emissiveTextureId:t.emissiveTexture!=null&&p?n.get(t.emissiveTexture).id:void 0,metallicRoughnessTextureId:t.metallicRoughnessTexture!=null&&p?n.get(t.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[O,L,G],mrrFactors:I?tt:[t.metallicFactor,t.roughnessFactor,o.mrrFactors[2]],isSchematic:I,colorTextureTransformMatrix:C(t.colorTextureTransform),normalTextureTransformMatrix:C(t.normalTextureTransform),scale:[N[0],N[1]],occlusionTextureTransformMatrix:C(t.occlusionTextureTransform),emissiveTextureTransformMatrix:C(t.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:C(t.metallicRoughnessTextureTransform),...u},a))}const v=i.get(x);if(s.stageResources.materials.push(v),p){const y=$=>{$!=null&&s.stageResources.textures.push(n.get($))};y(t.colorTexture),y(t.normalTexture),y(t.occlusionTexture),y(t.emissiveTexture),y(t.metallicRoughnessTexture)}return v}function gt(r,e){const s=r.attributes.position.count,o=Ve(r.indices||s,r.primitiveType),u=j(3*s),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;Ne(u,i,r.transform,3,n);const a=[[k.POSITION,new U(u,o,3,!0)]];if(r.attributes.normal!=null){const t=j(3*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;Be(_,r.transform),je(t,l,_,3,c),Y(_)&&te(t,t),a.push([k.NORMAL,new U(t,o,3,!0)])}if(r.attributes.tangent!=null){const t=j(4*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;Se(_,r.transform),qe(t,l,_,4,c),Y(_)&&te(t,t,4),a.push([k.TANGENT,new U(t,o,4,!0)])}if(r.attributes.texCoord0!=null){const t=j(2*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;Ge(t,l,2,c),a.push([k.UV0,new U(t,o,2,!0)])}const m=r.attributes.color;if(m!=null){const t=new Uint8Array(4*s);m.elementCount===4?m instanceof fe?oe(t,m,1,255):(m instanceof Ue||m instanceof Ce)&&oe(t,m,1/255,255):(t.fill(255),m instanceof pe?re(t,m.typedBuffer,1,255,4,m.typedBufferStride):(r.attributes.color instanceof Fe||r.attributes.color instanceof Le)&&re(t,m.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push([k.COLOR,new U(t,o,4,!0)])}return{geometry:new ce(e,a),vertexCount:s}}const _=ue();function Tt(r){switch(r){case"BLEND":return B.Blend;case"MASK":return B.Mask;case"OPAQUE":case null:case void 0:return B.Opaque}}function yt(r,e){for(let s=0;s<r.model.lods.length;++s){const o=r.model.lods[s];for(const u of o.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,m=H(),t=H(),l=H(),c=new Float32Array(4*a),d=new Float32Array(3*a),h=Oe(Pe(),u.transform);let x=0,p=0;for(let b=0;b<a;b++){n.getVec(b,t),i.getVec(b,m),Z(t,t,u.transform),Ie(l,t,e.center),ee(l,l,e.radius);const g=l[2],v=Ee(l),w=Math.min(.45+.55*v*v,1)**le;ee(l,l,e.radius),h!==null&&Z(l,l,h),ke(l,l),s+1!==r.model.lods.length&&r.model.lods.length>1&&_e(l,l,m,g>-1?.2:Math.min(-4*g-3.8,1)),d[x]=l[0],d[x+1]=l[1],d[x+2]=l[2],x+=3,c[p]=w,c[p+1]=w,c[p+2]=w,c[p+3]=1,p+=4}u.attributes.normal=new pe(d),u.attributes.color=new fe(c)}}}const wr=Object.freeze(Object.defineProperty({__proto__:null,fetch:dt,parseUrl:Te},Symbol.toStringTag,{value:"Module"}));export{dt as Y,wr as o,C as s};
