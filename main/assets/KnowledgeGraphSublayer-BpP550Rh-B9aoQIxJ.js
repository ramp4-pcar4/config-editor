const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./lclayout-uHKPd4rG-CAnOmEKh.js","./_commonjsHelpers-BITg13Vk-KnjfkSck.js"])))=>i.map(i=>d[i]);
import{cS as qe,v as m,S as f,n as Ae,bK as ye,bG as _t,ar as mt,o as Ie,ee as Nt,fu as re,Z as ft,B as Lt,l as Mt,q as Q,bw as St,F as vt,h as ee,N as gt,D as X,_ as Dt,bn as Rt,ac as Ct,a6 as bt,s as kt,ex as je,ad as Ge,eL as xt,lV as me,bB as At,$ as $t}from"./index-JysQxb7m.js";import{c as Ot}from"./OptimizedGeometry-pzfNw1AT--wT_d_bU.js";import{a as $e,b as le,l as Ft,i as Oe,r as qt}from"./knowledgeGraphService-bSKUKu5m-xNZGOZMT.js";import{Q as De,O as we}from"./projectionUtils-B-CplN3q-DYZZu_-u.js";import{_ as W,o as Re,E as fe,S as Fe,I as Ee,t as _e}from"./constants-5AlnYBiV-SxxbBSOD.js";import{U as jt}from"./featureConversionUtils-Bjjlcfdo-BG5IulME.js";import{F as Pe}from"./OptimizedFeature-mIz_HhJg-lEv_dFEg.js";import"./GraphicsLayer-BiEC2-gS-X1BXWd5O.js";import{s as ae}from"./Relationship-CQMFhJpR-DRDxXUXf.js";import{R as pe}from"./Query-n1aoaaFC-BH8Wj8dd.js";import{w as Gt}from"./MultiOriginJSONSupport-BqiFJbbt-8VO_HRla.js";import{g as Pt}from"./workers-CeRXsnNJ-tegidKGZ.js";import{e as Ut}from"./Layer-DvVVmz9x-CQh7OSfC.js";import{I as Bt}from"./FeatureStore-DfjNNhD_-57tmd1ao.js";import{K as Ht}from"./QueryEngine-B7NH52mH-7qQAVWT4.js";import{$ as zt,d as Ue}from"./clientSideDefaults-BoAP7ZAL-io0vXmiB.js";import{f as Qt}from"./fieldProperties-Cgp0UdcB-DVy_nvpS.js";import{u as ce,m as ge,i as Vt}from"./labelingInfo-DuLk-IW_-LIVRcaYS.js";import{u as Jt,i as Wt,n as Yt}from"./BlendLayer-DjW_5k0v-HONeExWo.js";import{I as Zt,v as Kt,b as Xt}from"./DisplayFilteredLayer-DTxK0R7U-D6Nc-y6C.js";import{f as ei,s as ti}from"./FeatureEffectLayer-BVJTjFhg-C-tN-w1G.js";import{f as ii,P as ni}from"./FeatureReductionLayer-vR-evpIv-DLR3ZVy6.js";import{p as ri,l as oi}from"./OrderedLayer-BD-wnvgD-BsS6j8Wx.js";import{T as ai}from"./RefreshableLayer-Qpvyi8qY-D5mInTca.js";import{S as si}from"./ScaleRangeLayer-x42fwED3-DuReLbie.js";import{x as li,a as pi}from"./TemporalLayer-lQRje9wB-jxHnXbN9.js";import{a as di,d as ci,p as ui,T as yi,r as hi}from"./OperationalLayer-CbXUnTH0-Bn7-Pvcl.js";import{m as Te}from"./Field-BIQ-quF4-CELMLVTM.js";import{i as mi}from"./TimeInfo-COHxjenm-B3WMG2CW.js";import{t as fi}from"./SimpleRenderer-C1YRhRzu-DCnnCgPv.js";import{fromJSON as Be}from"./jsonUtils-CzRaZnmS-CVaPBm6q.js";import{_ as gi}from"./typeUtils-CB2EGBWO-DQBesG4R.js";import{c as bi}from"./FeatureSet-BVGGhhH9-CR-T7cae.js";import{y as Ti}from"./popupUtils-B99PyAFi-Dj4s0FxX.js";import{_ as He}from"./utils-Cb2uXNfG-CNhH8kmH.js";let wi=class{constructor(){this.version="",this.queryResult=new Ii}},Ii=class{constructor(){this.featureResult=new Ei}},Ei=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new _i,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new Ni,this.geometryType=null,this.spatialReference=new mt,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new Tt,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},_i=class{constructor(){this.name="",this.isSystemMaintained=!1}},Ni=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},Tt=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new Li,this.translate=new Mi}};class Li{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}let Mi=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Si=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},vi=class{constructor(){this.attributes=[],this.compressedGeometry=new Ce,this.centroid=new Ce,this.aggregateGeometries=[]}},Ce=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var ue;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(ue||(ue={}));const Di=[ue.ELEMENTUID,ue.TYPENAME];var ze,Qe;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(ze||(ze={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Qe||(Qe={}));var Ve,ke,xe,de;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Ve||(Ve={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ke||(ke={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(xe||(xe={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(de||(de={}));function Ri(e){const t=new wi;t.version=e.version;const n=e.get_query_result();if(n.results_type.value!==0)throw new Error("Got a non-feature collection type");const i=n.get_feature_result(),r=t.queryResult.featureResult;r.objectIdFieldName=i.objectid_field_name,r.exceededTransferLimit=i.exceeded_transfer_limit,r.hasM=i.has_m,r.hasZ=i.has_z,r.geometryType=Oe[i.geometry_type.value],r.globalIdFieldName=i.globalid_field_name,r.geohashFieldName=i.geohash_field_name;const o=r.uniqueIdField,a=i.unique_id_field;o.name=a.name,o.isSystemMaintained=a.isSystemMaintained;const s=r.geometryProperties,l=i.geometry_properties;s.shapeAreaFieldName=l.shapeAreaFieldName,s.shapeLengthFieldName=l.shapeLengthFieldName,s.units=l.units;const d=r.spatialReference,u=i.spatial_reference;d.wkid=u.wkid,d.latestWkid=u.latestWkid,d.vcsWkid=u.vcsWkid,d.latestVcsWkid=u.latestVcsWkid,d.wkt=u.wkt,r.transform=ki(i.transform);const p=r.fields,c=r.fieldNameToAttributeIndexMap,y=i.fields,w=y.size();for(let E=0;E<w;E++){const v=y.get(E),M=wt(v);p.push(M),c[M.name]=E,v.delete()}y.delete();const S=r.values,$=i.values_count();for(let E=0;E<$;E++)S.push(i.get_value_at(E));const h=r.features,_=i.features,x=_.size();if(x>0){for(const E of Di)if(c[E]===void 0)throw new Error(`Feature collection missing required attribute: ${E}`)}for(let E=0;E<x;E++){const v=new vi,M=_.get(E),O=v.attributes,P=M.attributes_count();for(let N=0;N<P;N++)O.push(M.get_attribute_at(N));const U=M.get_compressed_geometry();U&&(v.compressedGeometry=Me(U),v.centroid=Me(M.get_centroid()));const B=v.aggregateGeometries,j=M.aggregate_geometries,K=j.size();for(let N=0;N<K;N++){const T=j.get(N),R=Me(T);B.push(R),T.delete()}j.delete(),h.push(v),M.delete()}_.delete();const G=r.geometryFields,q=i.geometry_fields,D=q.size();for(let E=0;E<D;E++){const v=q.get(E),M=Ci(v);G.push(M),v.delete()}return q.delete(),t}function Me(e){const t=new Ce;t.geometryType=Oe[e.geometry_type.value];const n=[],i=[];for(let r=0;r<e.lengths.length;r++)n.push(e.lengths[r]);for(let r=0;r<e.coords.length;r++)i.push(e.coords[r]);return t.lengths=n,t.coords=i,t}function wt(e){const t=new Si;return t.name=e.name,t.alias=e.alias,t.fieldType=qt[e.field_type.value],t.sqlType=xe[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function Ci(e){const t=wt(e);return t.geometryType=Oe[e.geometry_type.value],t}function ki(e){const t=new Tt;t.quantizeOriginPosition=ke[e.quantizeOriginPosition.value];const n=t.scale,i=e.scale;n.xScale=i.xScale,n.yScale=i.yScale,n.mScale=i.mScale,n.zScale=i.zScale;const r=t.translate,o=e.translate;return r.xTranslate=o.xTranslate,r.yTranslate=o.yTranslate,r.mTranslate=o.mTranslate,r.zTranslate=o.zTranslate,t}async function xi(e){const t=[],n={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Je(e.entitiesUrl).then(i=>{We(i,n)})),e.relationshipsUrl&&t.push(Je(e.relationshipsUrl).then(i=>{We(i,n)})),await Promise.all(t),n}async function On(e,t){t??(t=!1);const n={generateAllSublayers:t,namedTypeDefinitions:new Map};return await Oi(e).then(i=>{qi(i,n)}),n}async function Fn(e){const t=await $e(),n=new t.MapOfObjectIdentifierSets;Ai(n,t,e);const i=new t.MapOfObjectIdentifierSetsEncoder;try{i.set_map_of_identifier_sets(n),i.encode();const r=i.get_encoding_result();if(r.error.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",r.error.error_message);const o=structuredClone(r.get_byte_buffer());return i.delete(),o}finally{n.delete()}}function Ai(e,t,n){for(const[i,r]of n.namedTypeDefinitions){if(!r.members||r.useAllData)continue;const o=r.members.keys();let a=!1,s=!0;const l=new t.ObjectIdArray,d=new t.StringArray,u=new t.GlobalIdArray,p=new t.IdentifierArray,c=new t.ObjectIdentifierSet;for(const y of o)s&&(a=!isNaN(Number(y)),s=!1),a?l.add_objectid(Number(y)):(d.add_string(y),u.add_globalid(y)),p.add_identifier(y);c.set_oid_array(l),c.set_string_array(d),c.set_globalid_array(u),c.set_identifier_array(p),l.delete(),d.delete(),u.delete(),p.delete(),e.put_identifier_set(i,c),c.delete()}return e}async function Je(e){const t=await gt(e,{responseType:"array-buffer"});return $i(await t.data)}async function $i(e){const t=new(await $e()).FeatureCollectionDecoder,n=t.decode(new Uint8Array(e));if(n.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",n.error_message);const i=t.get_feature_collection(),r=Ri(i);return t.delete(),r}async function Oi(e){const t=await gt(e,{responseType:"array-buffer"}),n=await t.data;return Fi(new Uint8Array(n))}async function Fi(e){const t=new(await $e()).MapOfObjectIdentifierSetsDecoder,n=t.decode(new Uint8Array(e)),i=new Map;if(n.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",n.error_message);const r=t.get_map_of_identifier_sets(),o=r.keys,a=o.size();for(let s=0;s<a;s++){const l=o.get(s),d=r.query_identifier_set(l),u=[];if(d.id_array_type.value===de.GLOBALID_ARRAY){const p=d.get_globalid_array(),c=p.count();for(let y=0;y<c;y++)u.push(p.get_globalid_at(y))}else if(d.id_array_type.value===de.IDENTIFIER_ARRAY){const p=d.get_identifier_array(),c=p.count();for(let y=0;y<c;y++)u.push(p.get_identifier_at(y).toString())}else if(d.id_array_type.value===de.STRING_ARRAY){const p=d.get_string_array(),c=p.count();for(let y=0;y<c;y++)u.push(p.get_string_at(y))}else{if(d.id_array_type.value!==de.OID_ARRAY)throw new ee("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const p=d.get_oid_array(),c=p.count();for(let y=0;y<c;y++)u.push(p.get_objectid_at(y).toString())}}i.set(l,u)}return t.delete(),i}function We(e,t){var i,r,o;if(!((i=e==null?void 0:e.queryResult)!=null&&i.featureResult))return t;const n=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const a of e.queryResult.featureResult.features){const s=a.attributes[n[ue.TYPENAME]],l=X(t.namedTypeDefinitions,s,()=>({useAllData:!1,members:new Map})),d=a.attributes[n[ue.ELEMENTUID]];if(((o=(r=a.compressedGeometry)==null?void 0:r.coords)==null?void 0:o.length)>0){let u=a.compressedGeometry.lengths;a.compressedGeometry.geometryType==="esriGeometryPoint"&&(u=[]),l.members.set(d,{id:d,linkChartLocation:new Ot(u,a.compressedGeometry.coords)})}else l.members.set(d,{id:d})}return t}function qi(e,t){for(const[n,i]of e){const r=X(t.namedTypeDefinitions,n,()=>({useAllData:!1,members:new Map}));for(const o of i)r.members.has(o)||r.members.set(o,{id:o})}return t}const qn={fetchAndConvertSerializedLinkChart:e=>xi(e)};let Se=class se{constructor(){this._featureLookup=new Map}static getInstance(){return se.instance||(se.instance=new se),se.instance}static resetInstance(){se.instance&&(se.instance=null)}deleteFromStore(t){t.forEach(n=>{this._featureLookup.delete(n)})}readFromStoreByList(t){const n=[];return t.forEach(i=>{const r=this.readFromStoreById(i);r&&n.push(r)}),n}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,n,i){const r=[];return t.forEach(o=>{if(!(o!=null&&o.id))return;o.properties||(o.properties=[]);let a,s=null;if(i&&o.properties[i]&&(s=jt(o.properties[i])),"originId"in o&&"destinationId"in o&&(o.properties[Ee]=o.originId,o.properties[_e]=o.destinationId),o.properties[n]=o.id,o.id&&this._featureLookup.has(o.id)&&this._featureLookup.get(o.id).attributes){const l=this._featureLookup.get(o.id),d=JSON.parse(JSON.stringify(Object.assign(l.attributes,o.properties)));i&&o.properties[i]&&(d[i]=$t(o.properties[i])),a=new Pe(s?JSON.parse(JSON.stringify(s)):l!=null&&l.geometry?JSON.parse(JSON.stringify(l.geometry)):null,d,null,o.properties[n])}else a=new Pe(s?JSON.parse(JSON.stringify(s)):null,o.properties,null,o.properties[n]);this._featureLookup.set(`${o.typeName?`${o.typeName}__${o.id}`:o.id}`,a),r.push(a)}),r}},ve,I=null;function jn(){return ve||(ve=Dt(()=>import("./lclayout-uHKPd4rG-CAnOmEKh.js"),__vite__mapDeps([0,1]),import.meta.url).then(e=>e.l).then(({default:e})=>e({locateFile:t=>Rt(`esri/libs/linkchartlayout/${t}`)})).then(e=>{ji(e)}),ve)}function ji(e){I=e}var Ye,te,Ze,Ne;(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(Ye||(Ye={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(te||(te={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(Ze||(Ze={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}(Ne||(Ne={}));const Ke={none:0,"start-only":1,"start-and-end":2};function Gi(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...(e==null?void 0:e.toJSON())??{},eventsTicksVisualization:(e==null?void 0:e.eventsTicksVisualization)??"start-and-end"};return{...t,timeDirection:{value:Ne[t.timeDirection]??Ne.right},eventsTicksVisualization:{value:Ke[t.eventsTicksVisualization]??Ke["start-and-end"]}}}function oe(e,t,n,i,r,o){const a=n.length,s=r.length,l=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,u=Uint8Array.BYTES_PER_ELEMENT,p=16,c=p+a*(u+2*l)+s*(2*d),y=I._malloc(c);try{const w=y+p-y%p,S=w+a*l,$=S+a*l,h=$+s*d,_=h+s*d,x=()=>[I.HEAPF64.subarray(w>>3,(w>>3)+a),I.HEAPF64.subarray(S>>3,(S>>3)+a),I.HEAPU32.subarray($>>2,($>>2)+s),I.HEAPU32.subarray(h>>2,(h>>2)+s),I.HEAPU8.subarray(_,_+a)],[G,q,D,E,v]=x();G.set(n),q.set(i),D.set(r),E.set(o),v.set(t);const M=e(a,_,w,S,s,$,h);let O=null,P=null;if(M.value===te.Success){const T=I.getLayoutLinksTypes(),R=I.getLayoutLinksVerticesEndIndices(),A=I.getLayoutLinksVertices(),C=I.countLayoutLinksVertices();!s||T&&R?C&&!A?M.value=te.Error:(O={types:new Uint8Array(I.HEAPU8.subarray(T,T+s)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(R>>2,(R>>2)+s)),vertices:new Float64Array(I.HEAPF64.subarray(A>>3,(A>>3)+2*C))},P=I.getAuxiliaryGraphicElements()):M.value=te.Error}const[U,B,j,K,N]=x();return n.set(U),i.set(B),r.set(j),o.set(K),t.set(N),{status:M.value,links:O,graphics:P}}finally{I._free(y),I.cleanupLayout()}}const Xe=2,et=1,tt=-1;var it,nt,rt,ot,at,st,lt,pt,dt;(function(e){function t(){return I.getMinIdealEdgeLength()}function n(i,r,o,a,s,l,d=Xe,u=et,p=tt){return oe((c,y,w,S,$,h,_)=>I.applyForceDirectedLayout(i,c,y,w,S,$,h,_,d,u,p),r,o,a,s,l)}e.getMinIdealEdgeLength=t,e.apply=n})(it||(it={})),function(e){function t(n,i,r,o,a,s,l=Xe,d=et,u=tt){return oe((p,c,y,w,S,$,h)=>I.applyCommunityLayout(n,p,c,y,w,S,$,h,l,d,u),i,r,o,a,s)}e.apply=t}(nt||(nt={})),function(e){function t(n,i,r,o,a,s){return oe((l,d,u,p,c,y,w)=>I.applySimpleLayout(n,l,d,u,p,c,y,w),i,r,o,a,s)}e.apply=t}(rt||(rt={})),function(e){function t(n,i,r,o,a,s){return oe((l,d,u,p,c,y,w)=>I.applyHierarchicalLayout(n,l,d,u,p,c,y,w),i,r,o,a,s)}e.apply=t}(ot||(ot={})),function(e){function t(n,i,r,o,a,s){return oe((l,d,u,p,c,y,w)=>I.applyRadialTreeLayout(n,l,d,u,p,c,y,w),i,r,o,a,s)}e.apply=t}(at||(at={})),function(e){function t(n,i,r,o,a,s){return oe((l,d,u,p,c,y,w)=>I.applySmartTreeLayout(n,l,d,u,p,c,y,w),i,r,o,a,s)}e.apply=t}(st||(st={})),function(e){function t(n,i,r,o,a,s,l,d,u,p,c,y){return oe((w,S,$,h,_,x,G)=>{if(a.length!==w)return{value:te.Error};if(s.length!==w)return{value:te.Error};if(u.length!==_)return{value:te.Error};if(p.length!==_)return{value:te.Error};const q=Float64Array.BYTES_PER_ELEMENT,D=16,E=I._malloc(D+w*q),v=I._malloc(D+w*q),M=I._malloc(D+_*q),O=I._malloc(D+_*q),P=E+D-E%D,U=v+D-v%D,B=M+D-M%D,j=O+D-O%D;try{return I.HEAPF64.subarray(P>>3,(P>>3)+w).set(a),I.HEAPF64.subarray(U>>3,(U>>3)+w).set(s),I.HEAPF64.subarray(B>>3,(B>>3)+_).set(u),I.HEAPF64.subarray(j>>3,(j>>3)+_).set(p),I.applyChronologicalLayout(n,w,S,$,h,P,U,_,x,G,B,j,c,Gi(y))}finally{I._free(E),I._free(v),I._free(M),I._free(O)}},i,r,o,l,d)}e.apply=t}(lt||(lt={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(pt||(pt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(dt||(dt={})),qe()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"}),qe()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Pi=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function Ui(e,t){var i,r;const n=new Map;if((i=t.dataModel)!=null&&i.relationshipTypes)for(const o of t.dataModel.relationshipTypes)o.name&&n.set(o.name,[]);for(const o of e)n.has(o.typeName)&&((r=n.get(o.typeName))==null||r.push(o.id));return n}async function Gn(e,t,n){const i=[],r=Ui(e,t),o={},a=[];for(const[u,p]of r){if(p.length<1)continue;const c=`${u}_ids`;o[c]=p,a.push(`MATCH (n)-[r:${u}]->(m) WHERE id(r) in $${c} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(a.length===0)return[];const s=a.join(" UNION "),l=new ae({openCypherQuery:s,bindParameters:o}),d=(await le(t,l,n==null?void 0:n.requestOptions)).resultRowsStream.getReader();for(;;){const{done:u,value:p}=await d.read();if(u)break;for(const c of p)i.push({id:c[0],typeName:c[1]}),i.push({id:c[2],typeName:c[3]})}return i}const Pn=e=>Pi.get(e)??"radial-root-centric";function Bi(e){if(!e.spatialReference.isWGS84)throw new ee("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let J=class extends Ct{constructor(e){var n,i,r;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(n=e.knowledgeGraph.dataModel.entityTypes)==null||n.forEach(o=>{var a,s;o.name&&(t.set(o.name,"entity"),this._processingCacheUpdatesLookup.set(o.name,[]),e.inclusionModeDefinition&&!((a=e.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.entityTypeNames.add(o.name),(s=o.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:l.name??"",geometryType:l.geometryType})}))}),(i=e.knowledgeGraph.dataModel.relationshipTypes)==null||i.forEach(o=>{var a,s;o.name&&(t.set(o.name,"relationship"),this._processingCacheUpdatesLookup.set(o.name,[]),e.inclusionModeDefinition&&!((a=e.inclusionModeDefinition)!=null&&a.generateAllSublayers)||this.relationshipTypeNames.add(o.name),(s=o.properties)==null||s.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(o.name,{name:l.name??"",geometryType:l.geometryType})}))}),(r=e.inclusionModeDefinition)==null||r.namedTypeDefinitions.forEach((o,a)=>{var l,d;if(t.get(a)==="entity")this.entityTypeNames.add(a);else{if(t.get(a)!=="relationship")return bt.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void((l=e.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.delete(a));this.relationshipTypeNames.add(a)}const s=new Map;(d=o.members)==null||d.forEach(u=>{X(this.memberIdTypeLookup,u.id,()=>new Set).add(a);const p=this.getById(u.id);p&&s.set(u.id,p)}),this.sublayerCaches.set(a,s)})}addToLayer(e){e.forEach(({typeName:t,id:n})=>{if(!this.inclusionModeDefinition)throw new ee("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const i=this.inclusionModeDefinition.namedTypeDefinitions.get(t);i.members||(i.members=new Map),i.members.set(n,{id:n}),X(this.memberIdTypeLookup,n,()=>new Set).add(t)}}else{const i=new Map;i.set(n,{id:n}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:i}),X(this.memberIdTypeLookup,n,()=>new Set).add(t)}})}getById(e){return Se.getInstance().readFromStoreById(e)}async getData(e,t,n){var r,o;if(t.objectType.name&&((r=this.inclusionModeDefinition)!=null&&r.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let i;if(i=e||new pe({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const a=t.parentCompositeLayer,s=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=i.outFields;l&&l.length===1&&l[0]===W&&i.where==="1=1"||await Promise.all(s??[]);const d=this.sublayerCaches.has(t.objectType.name??"")?Array.from((o=this.sublayerCaches.get(t.objectType.name))==null?void 0:o.values()):[],u=[];return d.forEach(p=>{if(this.relationshipTypeNames.has(t.objectType.name)){p.geometry=a.relationshipLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const c=this.memberIdTypeLookup.get(p.attributes[Ee]),y=this.memberIdTypeLookup.get(p.attributes[_e]),w=this._isEndEntitySpatial(c,p,Ee),S=this._isEndEntitySpatial(y,p,_e);p.attributes[fe]=Number(w&&S)}else{p.geometry=a.entityLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const c=this.geographicLookup.get(t.objectType.name);c&&p.attributes[c.name]?p.attributes[fe]=1:p.attributes[fe]=0}p.attributes[Fe]=p.geometry,u.push(p)}),u}return this.retrieveDataFromService(i,t,n)}async getConnectedRecordIds(e,t,n){const i=[];let r="";const o=this._getNamedTypeIdMapFromNodeIds(e);if(t&&(t==null?void 0:t.length)!==0){for(const u of t)r=r+u+"|";r=r.slice(0,-1)}const a={},s=[];for(const[u,p]of o){const c=`${u}_ids`;a[c]=p,t&&(t==null?void 0:t.length)!==0?s.push(`MATCH (n:${u}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r:${r}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):s.push(`MATCH (n:${u}) WHERE id(n) IN $${c} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!s.length)return i;const l=s.join(" UNION "),d=(await le(this.knowledgeGraph,new ae({openCypherQuery:l,bindParameters:a}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:u,value:p}=await d.read();if(u)break;for(let c=0;c<p.length;c++){const y=p[c];i.push({id:y[0],typeName:y[1]}),i.push({id:y[2],typeName:y[3]})}}return i}async getRelationshipsBetweenNodes(e,t,n){const i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0)return[];const r={relationshipExclusionIds:t,possibleConnectionEntityIds:e},o=[];for(const[d,u]of i.entries()){const p=`${d}_ids`;r[p]=u,o.push(`MATCH (n:${d}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const a=o.join(" UNION "),s=[],l=(await le(this.knowledgeGraph,new ae({openCypherQuery:a,bindParameters:r}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:d,value:u}=await l.read();if(d)break;for(let p=0;p<u.length;p++){const c=u[p];s.push({id:c[0],typeName:c[1]})}}return s}async getRelationshipsFromNodes(e,t,n,i){const r=this._getNamedTypeIdMapFromNodeIds(e);if(r.size===0||t.length===0)return[];const o={relationshipExclusionIds:n,possibleConnectionEntityIds:t},a=[];for(const[p,c]of r.entries()){const y=`${p}_ids`;o[y]=c,a.push(`MATCH (n:${p}) WHERE id(n) IN $${y} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=a.join(" UNION "),l=new Map,d=(await le(this.knowledgeGraph,new ae({openCypherQuery:s,bindParameters:o}),{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:c}=await d.read();if(p)break;for(let y=0;y<c.length;y++){const w=c[y];let S=l.get(w[1]);S||(S=new Set,l.set(w[1],S)),S.add(w[0])}}const u=[];for(const[p,c]of l)for(const y of c)u.push({id:y,typeName:p});return u}async refreshCacheContent(e,t,n,i=!0,r){var d,u,p,c,y,w,S,$;const o=Se.getInstance(),a=[],s=new Map,l=new Map;(d=this.knowledgeGraph.dataModel.entityTypes)==null||d.forEach(h=>{h.name&&l.set(h.name,h)}),(u=this.knowledgeGraph.dataModel.relationshipTypes)==null||u.forEach(h=>{h.name&&l.set(h.name,h)}),e||this.inclusionModeDefinition?e?e.forEach(h=>{var _;if(this.memberIdTypeLookup.has(h))for(const x of this.memberIdTypeLookup.get(h))s.has(x)?(_=s.get(x))==null||_.push(h):s.set(x,[h])}):(c=(p=this.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions)==null||c.forEach((h,_)=>{h.useAllData?s.set(_,null):h.members&&h.members.forEach(x=>{var G;s.has(_)&&s.get(_)!==null?(G=s.get(_))==null||G.push(x.id):s.set(_,[x.id])})}):((y=this.knowledgeGraph.dataModel.entityTypes)==null||y.forEach(h=>{h.name&&s.set(h.name,null)}),(w=this.knowledgeGraph.dataModel.entityTypes)==null||w.forEach(h=>{h.name&&s.set(h.name,null)}));for(const[h,_]of s){const x=new Set(_),G=new Promise((q,D)=>{(async()=>{var j,K,N,T,R,A,C,k,F;const E=new Set,v=[];let M,O="",P=!1;if(t||((K=(j=l.get(h))==null?void 0:j.properties)==null||K.forEach(b=>{b.name&&E.add(b.name)})),n&&this.geographicLookup.has(h)){const b=(N=this.geographicLookup.get(h))==null?void 0:N.name;b&&E.add(b)}if(this.entityTypeNames.has(h))O=`MATCH (n:${h}) ${_?"WHERE id(n) IN $ids ":""}return ID(n)`,E.forEach(b=>{O+=`, n.${b}`,v.push(b)});else{if(!this.relationshipTypeNames.has(h))throw new ee("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);P=!0,O=`MATCH ()-[n:${h}]->() ${_?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,E.forEach(b=>{O+=`, n.${b}`,v.push(b)})}M=new ae(_?{openCypherQuery:O,bindParameters:{ids:_}}:{openCypherQuery:O});const U=(await le(this.knowledgeGraph,M,{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:b,value:L}=await U.read();if(b)break;const ie=[];for(let Z=0;Z<L.length;Z++){const ne=L[Z];let H=0,be=0;const z={properties:{}};for(z.id=ne[H],H++,be++,P&&(z.originId=ne[H],H++,be++,z.destinationId=ne[H],H++,be++,X(this.nodeConnectionsLookup,z.originId,()=>new Set).add(z.id),X(this.nodeConnectionsLookup,z.destinationId,()=>new Set).add(z.id),X(this.relationshipConnectionsLookup,z.id,()=>[z.originId,z.destinationId]));H<ne.length;H++)z.properties[v[H-be]]=ne[H];x.delete(z.id),ie.push(z)}const Y=o.writeToStore(ie,W,(T=this.geographicLookup.get(h))==null?void 0:T.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),i&&!((R=this.inclusionModeDefinition)!=null&&R.namedTypeDefinitions.has(h))&&((A=this.inclusionModeDefinition)==null||A.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),i&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const Le=this.sublayerCaches.get(h);Y.forEach(Z=>{var ne,H;Le==null||Le.set(Z.attributes[W],Z),i&&!((ne=this.inclusionModeDefinition)!=null&&ne.namedTypeDefinitions.get(h).members.has(Z.attributes[W]))&&((H=this.inclusionModeDefinition)==null||H.namedTypeDefinitions.get(h).members.set(Z.attributes[W],{id:Z.attributes[W]}),X(this.memberIdTypeLookup,Z.attributes[W],()=>new Set).add(h))})}const B=(k=this.inclusionModeDefinition)==null?void 0:k.namedTypeDefinitions.get(h);if(B)for(const b of x)(F=B.members)==null||F.delete(b)})().then(()=>{q(null)}).catch(E=>{E.name==="AbortError"?q(null):D(E)})});a.push(G),(S=this._processingCacheUpdatesLookup.get(h))==null||S.push(G)}if(await Promise.all(a),($=r==null?void 0:r.signal)==null?void 0:$.aborted)throw kt()}removeFromLayer(e){var i,r,o;const t=new Set,n=new Set(e.map(a=>a.id));for(const a of e)t.add(a.typeName),((i=this.memberIdTypeLookup.get(a.id))==null?void 0:i.size)===1?this.memberIdTypeLookup.delete(a.id):(r=this.memberIdTypeLookup.get(a.id))==null||r.delete(a.typeName),(o=this.inclusionModeDefinition)==null||o.namedTypeDefinitions.forEach((s,l)=>{var d;l===a.typeName&&((d=s.members)!=null&&d.has(a.id))&&s.members.delete(a.id)});t.forEach(a=>{var s;(s=this.sublayerCaches.get(a))==null||s.forEach((l,d)=>{var u;n.has(d)&&((u=this.sublayerCaches.get(a))==null||u.delete(d))})})}async retrieveDataFromService(e,t,n){var w,S,$,h,_,x,G,q,D,E,v,M,O,P,U,B,j,K;const i=Se.getInstance(),r=new Set,o=[];let a,s="",l=[];const d=t.graphType==="relationship",u=($=(S=(w=this.inclusionModeDefinition)==null?void 0:w.namedTypeDefinitions)==null?void 0:S.get(t.objectType.name))==null?void 0:$.useAllData,p=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let c=!u&&p?Array.from(p).sort():null;if((x=(_=(h=this.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions)==null?void 0:_.get(t.objectType.name))!=null&&x.useAllData)(D=(q=(G=this.inclusionModeDefinition)==null?void 0:G.namedTypeDefinitions)==null?void 0:q.get(t.objectType.name))!=null&&D.useAllData&&e.objectIds!=null&&(c=e.objectIds);else if(e.objectIds!=null&&c&&c.length>0){const N=e.objectIds;e.objectIds=c.filter(T=>N.includes(T))}else if(e.objectIds!=null)c=e.objectIds;else{if((E=this.inclusionModeDefinition)!=null&&E.namedTypeDefinitions.has(t.objectType.name)&&(!((v=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&v.members)||((O=(M=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:M.members)==null?void 0:O.size)<1))return e.objectIds=[],[];e.objectIds=c}if(e.outFields!=null){const N=e.outFields;N.includes("*")?t.fields.forEach(T=>{r.add(T.name)}):N.forEach(T=>{T!==W&&T!==t.geometryFieldName&&r.add(T)})}if(e.geometry!=null){const N=e.geometry;let T;const R=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,A=R==null?void 0:R.spatialReference,C=(P=R==null?void 0:R.serviceCapabilities)==null?void 0:P.geometryCapabilities;let k=C==null?void 0:C.geometryMaxBoundingRectangleSizeX,F=C==null?void 0:C.geometryMaxBoundingRectangleSizeY;if(N.type==="point"){let b=N;(U=b.spatialReference)!=null&&U.isWGS84||(await De(b.spatialReference,re),b=we(b,re)),T=new Ie({spatialReference:re,xmin:b.x-1e-4,ymin:b.y-1e-4,xmax:b.x+1e-4,ymax:b.y+1e-4})}else(B=N==null?void 0:N.extent)!=null&&B.spatialReference&&!((j=N.spatialReference)!=null&&j.isWGS84)?(await De(N.extent.spatialReference,re),T=we(N.extent,re)):T=N.extent;if(k&&F&&A){if(A.wkid!==4326){const b=new Ie({spatialReference:A,xmax:k,ymax:F}),L=we(b,re);k=L.xmax,F=L.ymax}if(T.xmax-T.xmin>k)throw new ee("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${k}° latitude, limit exceeded`);if(T.ymax-T.ymin>F)throw new ee("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${F}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const b=await je(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(L=>{b.fieldNames.includes(L.name)&&r.add(L.name)})}s=d?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(b=>{s+=`, n.${b}`,o.push(b)}),a=new ae({openCypherQuery:s,bindParameters:{param_filter_geom:new ft({rings:Bi(T)})}})}else{let N="";if(e.where!=null&&e.where!=="1=1"){const A=await je(e.where,t.fieldsIndex);t.fields.forEach(L=>{A.fieldNames.includes(L.name)&&r.add(L.name)});const C=new Set(["column-reference","string","number","binary-expression"]),k=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let F=!1;const b=L=>{if(L.type==="column-reference")return`n.${L.column}`;if(L.type==="string")return`'${L.value}'`;if(L.type==="number")return`${L.value}`;if(L.type==="binary-expression"&&C.has(L.left.type)&&C.has(L.right.type)&&k.has(L.operator))return`${b(L.left)} ${L.operator} ${b(L.right)}`;if(L.type==="binary-expression"&&L.operator==="LIKE"){let ie="";if(L.left.type==="function"&&L.left.args.value[0].type==="column-reference")ie+=`lower(n.${L.left.args.value[0].column})`;else{if(L.left.type!=="column-reference")return F=!0,"";ie+=`lower(n.${L.left.column})`}if(ie+=" CONTAINS (",L.right.type!=="string")return F=!0,"";{let Y=L.right.value;Y.charAt(0)==="%"&&(Y=Y.slice(1)),Y.charAt(Y.length-1)==="%"&&(Y=Y.slice(0,-1)),ie+=`'${Y.toLowerCase()}')`}return ie}return F=!0,""};N=b(A.parseTree),F&&(N="")}let T="";T=d?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let R=!1;c&&(R=!0,T+=" WHERE ID(n) IN $ids"),N&&(T+=R?" AND":" WHERE",T+=` ${N}`),T+=" return ID(n)",d&&(T+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&r.add(t.geometryFieldName),r.forEach(A=>{T+=`, n.${A}`,o.push(A)}),a=new ae(c?{openCypherQuery:T,bindParameters:{ids:c}}:{openCypherQuery:T})}const y=(await le(t.parentCompositeLayer.dataManager.knowledgeGraph,a,n)).resultRowsStream.getReader();for(;;){const{done:N,value:T}=await y.read();if(N)break;const R=[];for(let A=0;A<T.length;A++){const C=T[A];let k=0,F=0;const b={properties:{}};for(b.id=C[k],k++,F++,d&&(b.originId=C[k],k++,F++,b.destinationId=C[k],k++,F++);k<C.length;k++)b.properties[o[k-F]]=C[k];R.push(b)}l=l.concat(i.writeToStore(R,W,(K=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:K.name))}return l}_isEndEntitySpatial(e,t,n){var i;for(const r of e??[])if(this.entityTypeNames.has(r)){const o=this.geographicLookup.get(r),a=o&&((i=this.sublayerCaches.get(r))==null?void 0:i.get(t.attributes[n]));if(o&&(a!=null&&a.attributes[o.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(n=>{var i;if(this.memberIdTypeLookup.has(n))for(const r of this.memberIdTypeLookup.get(n)){if(!this.entityTypeNames.has(r))return;t.has(r)?(i=t.get(r))==null||i.push(n):t.set(r,[n])}}),t}};m([f()],J.prototype,"knowledgeGraph",void 0),m([f()],J.prototype,"inclusionModeDefinition",void 0),m([f()],J.prototype,"entityTypeNames",void 0),m([f()],J.prototype,"relationshipTypeNames",void 0),m([f()],J.prototype,"geographicLookup",void 0),m([f()],J.prototype,"sublayerCaches",void 0),m([f()],J.prototype,"nodeConnectionsLookup",void 0),m([f()],J.prototype,"relationshipConnectionsLookup",void 0),m([f()],J.prototype,"memberIdTypeLookup",void 0),J=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],J);const ct=Qt(),Hi=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return m([f(ct.fields)],t.prototype,"fields",void 0),m([f(ct.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t},zi={initializeLayersFromClientData:async(e,t,n)=>{if(t||(t=[...e.layers,...e.tables].map(o=>o.graphTypeName)),(t==null?void 0:t.length)===0)return;const i=new Map;for(const o of t)i.set(o,ut(e,o));const r=await Ft(e.dataManager.knowledgeGraph,Array.from(i.values()),{requestOptions:{signal:n==null?void 0:n.signal}});for(const o of[...e.layers,...e.tables]){const a=o.objectType.name;if(a==null)continue;const s=r.get(ut(e,a));if(s){const l=JSON.parse(s);l===null||typeof l!="object"||l.hasOwnProperty("showLabels")||(l.showLabels=!1),o.read(l,{origin:"service"})}}}},ut=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function Un(e,t,n){return zi.initializeLayersFromClientData(e,t,n)}const yt=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Qi="#8f8f82";function Vi(e){return e<0||e>=yt.length?new Ge(Qi):new Ge(yt[e])}function Ji(e){const t=e.toArray();return new xt({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:t},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:t}]}}]}]}}})}function Wi(e){let t="ESRI__ID",n=4;for(const i of e)if(i.name){if(i.name.toLowerCase()==="name"){t=i.name;break}i.name.toLowerCase().includes("name")?(t=i.name,n=2):i.fieldType==="esriFieldTypeString"&&n>3&&(t=i.name,n=3)}return t}function Yi(e,t,n){const i={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},r=new ce({labelExpressionInfo:new ge({expression:n==="ESRI__ID"?`${t}`:`$feature.${n}`}),labelPlacement:"above-center",symbol:new me(i)}),o=new ce({labelExpressionInfo:new ge({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new me({...i,yoffset:"12px"})});return e==="entity"?[r]:[o]}function Zi(e,t,n){const i={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},r=n==="ESRI__ID"?`${e}`:`$feature.${n}`;return t==="point"?[new ce({labelExpressionInfo:new ge({expression:r}),labelPlacement:"above-center",symbol:new me(i)})]:t==="polyline"?[new ce({labelExpressionInfo:new ge({expression:r}),labelPlacement:"center-along",repeatLabel:!0,symbol:new me(i)})]:t==="polygon"?[new ce({labelExpressionInfo:new ge({expression:r}),labelPlacement:"always-horizontal",symbol:new me(i)})]:null}function V(e){if(!e.json)return e;e.json.write=ht(e.json.write);const t=e.json.origins;if(!t)return e;let n;for(n in t){const i=t[n];i&&(i.write=ht(i.write))}return e}function ht(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=Ki(e)),e):e===!0?he():e}function Ki(e){const{target:t,writer:n,overridePolicy:i,...r}=e;return function(o,a){const s=It.call(this,o,a);return s.enabled?{...r,...s}:s}}function he(){return{overridePolicy:It}}function It(e,t){const n=!!this.geometryType;let i={enabled:n};return n&&(i={...i,...Et.call(this,e,t)}),i}function Et(e,t){return{ignoreOrigin:this.originIdOf(t)>At.DEFAULTS}}let g=class extends Hi(Zt(ii(ei(Jt(ri(li(si(ai(Gt(Ut)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=zt(!1,!0),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=W,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new Pt(t.port1,{channel:t,client:{queryFeatures:(n,i={})=>{const r=pe.fromJSON(n);return this.queryFeaturesJSON(r,i)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get userHasUpdateItemPrivileges(){var e;return!!((e=this.parent)!=null&&e.userHasUpdateItemPrivileges)}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var t,n;const e=[];return(n=(t=this.objectType)==null?void 0:t.properties)==null||n.forEach(i=>{const r=i.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":i.fieldType;e.push(Te.fromJSON({name:i.name,type:r,alias:i.alias,defaultValue:i.defaultValue,editable:i.editable,nullable:i.nullable}))}),e.push(Te.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),Te.fromJSON({name:Re,type:"esriFieldTypeInteger",alias:Re,editable:!1}),Te.fromJSON({name:fe,type:"esriFieldTypeInteger",alias:fe,editable:!1})),e}get geometryType(){var n,i,r;if(((n=this.parentCompositeLayer)==null?void 0:n.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=(r=this.parentCompositeLayer)==null?void 0:r.dataManager.geographicLookup.get((i=this.objectType)==null?void 0:i.name),t=e==null?void 0:e.geometryType;return t&&t!=="esriGeometryNull"?ye.fromJSON(t):null}get geometryFieldName(){var e,t,n,i;return((e=this.parentCompositeLayer)==null?void 0:e.type)==="link-chart"?Fe:((i=(n=this.parentCompositeLayer)==null?void 0:n.dataManager.geographicLookup.get((t=this.objectType)==null?void 0:t.name))==null?void 0:i.name)??null}get graphTypeName(){var e;return(e=this.objectType)==null?void 0:e.name}get hasM(){var n,i,r,o,a;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name;return((a=t?(o=(r=this.objectType)==null?void 0:r.properties)==null?void 0:o[t]:null)==null?void 0:a.hasM)??!1}get hasZ(){var n,i,r,o,a;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name;return((a=t?(o=(r=this.objectType)==null?void 0:r.properties)==null?void 0:o[t]:null)==null?void 0:a.hasZ)??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const e=this.objectType.properties?Wi(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Yi(this.graphType,this.graphTypeName,e):Zi(this.graphTypeName,this.geometryType,e)}set renderer(e){_t(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var r,o,a,s;if(this._isOverridden("renderer"))return this._get("renderer");const e=(a=(o=(r=this.parentCompositeLayer)==null?void 0:r.dataManager)==null?void 0:o.knowledgeGraph)==null?void 0:a.dataModel,t=[...(e==null?void 0:e.entityTypes)??[],...(e==null?void 0:e.relationshipTypes)??[]].map(l=>l.name).indexOf(this.graphTypeName),n=Vi(t);if(((s=this.parentCompositeLayer)==null?void 0:s.type)==="link-chart"){if(this.graphType==="relationship")return new fi({type:"simple",symbol:Ji(n)});const l=Be(Ue(ye.toJSON("point")).renderer);return He(l.symbol,n),l}const i=Be(Ue(ye.toJSON(this.geometryType)).renderer);return He(i.symbol,n),i}get spatialReference(){var e,t,n,i;return((i=(n=(t=(e=this.parentCompositeLayer)==null?void 0:e.dataManager)==null?void 0:t.knowledgeGraph)==null?void 0:n.dataModel)==null?void 0:i.spatialReference)??mt.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return Ti(this,e)}createQuery(){return new pe({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e),r=bi.fromJSON(await i.executeQuery(n.toJSON(),t==null?void 0:t.signal));return r.features.forEach(o=>{o.sourceLayer=this}),r}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return await i.executeQuery(n.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(e);return i.executeQueryForCount(n.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var s,l,d,u;await this.load();const n={...e,returnGeometry:!0},{resolvedQuery:i,queryEngine:r}=await this._setupQueryObjects(n),o=await r.executeQueryForExtent(i.toJSON(),t==null?void 0:t.signal);let a;return a=((s=o.extent)==null?void 0:s.xmin)!=null&&((l=o.extent)==null?void 0:l.xmax)!=null&&((d=o.extent)==null?void 0:d.ymin)!=null&&((u=o.extent)==null?void 0:u.ymax)!=null?new Ie(o.extent):new Ie,{count:o.count,extent:a}}async queryObjectIds(e,t){await this.load();const n=pe.from(e);let i;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)i=this._cachedQueryEngine;else{const r=await this.parentCompositeLayer.dataManager.getData(n,this,t);i=this.loadQueryEngine(r)}return await i.executeQueryForIds(n.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){var i;const t=new Bt({geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),n=new Ht({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:(i=this.timeInfo)==null?void 0:i.toJSON(),featureStore:t});return n.featureStore.addMany(e),n}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new pe({where:"1=1",outFields:[W]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>Nt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){var o;const n=pe.from(e),i=n.geometry;if(i&&!((o=i.spatialReference)!=null&&o.isWGS84)&&(await De(i.spatialReference,re),n.geometry=we(i instanceof ft||i instanceof Lt||i instanceof Mt?i:i.extent,re)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:n,queryEngine:this._cachedQueryEngine};const r=await this.parentCompositeLayer.dataManager.getData(n,this,t);return{resolvedQuery:n,queryEngine:this.loadQueryEngine(r)}}};function Xi(e,t,n){var r,o;const i=[["ESRI__AGGREGATION_COUNT",Re],["ESRI__ORIGIN_ID",Ee],["ESRI__DESTINATION_ID",_e],["ESRI__LAYOUT_GEOMETRY",Fe]];try{for(const a of e)for(const[s,l]of i)a.labelExpression=(r=a.labelExpression)==null?void 0:r.replaceAll(s,l),(o=a.labelExpressionInfo)!=null&&o.expression&&(a.labelExpressionInfo.expression=a.labelExpressionInfo.expression.replaceAll(s,l))}catch(a){bt.getLogger(this).warn("Error updating labelingInfo",a)}return Vt(e,t,n)}m([f(V(Q(Wt)))],g.prototype,"blendMode",void 0),m([f()],g.prototype,"capabilities",void 0),m([f({readOnly:!0})],g.prototype,"userHasUpdateItemPrivileges",null),m([f({json:{origins:{"web-scene":{write:!1}},write:he()}})],g.prototype,"charts",void 0),m([f({readOnly:!0})],g.prototype,"defaultPopupTemplate",null),m([f({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],g.prototype,"definitionExpression",void 0),m([f()],g.prototype,"displayField",void 0),m([f(V(Q(Kt)))],g.prototype,"displayFilterEnabled",void 0),m([f(V(Q(Xt)))],g.prototype,"displayFilterInfo",void 0),m([f(V(Q(Yt)))],g.prototype,"effect",void 0),m([f()],g.prototype,"elevationInfo",void 0),m([f(V(Q(ti)))],g.prototype,"featureEffect",void 0),m([f(V(Q(ni)))],g.prototype,"featureReduction",null),m([f()],g.prototype,"fields",null),m([f()],g.prototype,"geometryType",null),m([f()],g.prototype,"geometryFieldName",null),m([f({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],g.prototype,"graphType",void 0),m([f({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],g.prototype,"graphTypeName",null),m([f()],g.prototype,"hasM",null),m([f()],g.prototype,"hasZ",null),m([f({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],g.prototype,"id",void 0),m([f({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],g.prototype,"labelsVisible",void 0),m([f({type:[ce],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:Xi,write:he()}})],g.prototype,"labelingInfo",null),m([f({readOnly:!0,json:{read:!1,write:{writer(e,t){var n;switch((n=this.parentCompositeLayer)==null?void 0:n.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],g.prototype,"layerType",void 0),m([f(V(Q(di)))],g.prototype,"legendEnabled",void 0),m([f(V(Q(ci)))],g.prototype,"maxScale",void 0),m([f(V(Q(ui)))],g.prototype,"minScale",void 0),m([f()],g.prototype,"objectIdField",void 0),m([f()],g.prototype,"objectType",void 0),m([f(V(Q(yi)))],g.prototype,"opacity",void 0),m([f(V(Q(oi)))],g.prototype,"orderBy",void 0),m([f({clonable:!1})],g.prototype,"parent",void 0),m([f()],g.prototype,"parentCompositeLayer",void 0),m([f(V(Q(hi)))],g.prototype,"popupEnabled",void 0),m([f({type:St,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],g.prototype,"popupTemplate",void 0),m([f({type:Number,json:{write:{overridePolicy:Et}}})],g.prototype,"refreshInterval",void 0),m([f({types:gi,json:{name:"layerDefinition.drawingInfo.renderer",write:he()}})],g.prototype,"renderer",null),m([f()],g.prototype,"source",void 0),m([f()],g.prototype,"spatialReference",null),m([f({type:mi,json:{name:"layerDefinition.timeInfo",write:!0,origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:!0},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:!0}}}})],g.prototype,"timeInfo",null),m([f({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],g.prototype,"title",null),m([vt("title")],g.prototype,"writeTitle",null),m([f({json:{read:!1}})],g.prototype,"type",void 0),m([f(V(Q(pi)))],g.prototype,"useViewTime",void 0),m([f({type:Boolean,json:{name:"visibility",write:he()}})],g.prototype,"visible",void 0),g=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],g);export{Un as $,Gn as A,at as C,rt as D,Fn as E,te as G,On as I,Ye as L,Ze as M,Pn as O,ot as R,it as S,g as T,nt as a,jn as b,Se as c,J as j,st as k,qn as v,lt as x};
