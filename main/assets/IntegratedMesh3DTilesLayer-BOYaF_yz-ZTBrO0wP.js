import{bT as w,bc as b,aG as P,be as _,F as T,l as d,bW as k,v as f,M as y,P as h,Q as I,m as o,E as a,R as L,n as x}from"./index-BeTPrQ6f.js";import{M as R}from"./MultiOriginJSONSupport-DNNJhlNT-Bm4fcG4m.js";import{C as D}from"./persistable-vgejqKb5-CBqfEqX1.js";import{l as E}from"./APIKeyMixin-DYy2zfLn-D3z7LonQ.js";import{h as M}from"./ArcGISService-CytDmkiZ-emNrPdED.js";import{n as G}from"./CustomParametersMixin-CqtpZgix-ZCd9Um94.js";import{b as O,s as q,a as N}from"./OperationalLayer-Ds0FQSCg-DEUbTcjK.js";import{x as U}from"./PortalLayer-B52AUJ7S-DLZhjKpz.js";import{r as A}from"./ScaleRangeLayer-DkZwCH6_-C95kTMqN.js";import{p as v}from"./SceneModifications-pnP_t3oc-Zqwunv--.js";import{X as J}from"./tiles3DUtils-D1ZZJnSG-C1bG4bJM.js";import{H as g,D as j,G as $}from"./elevationInfoUtils-DFX5QvG8-DWLx2t7K.js";import{n as H}from"./isBasemap-CJN7v_Jq-Dgi2bMj-.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./resourceExtension-Boq2U56c-rXLaGMsr.js";import"./layerContainerType-CJrPp4UB-BIF7XAYP.js";import"./ElevationInfo-tlrAM5SV-D86C1F9d.js";import"./lengthUtils-CopeXEyE-DjCEitlq.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./portalItemUtils-C12I5owR-Iiaf4oEu.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./vec32-CI1xtKog-DFVYRcgb.js";import"./HeightModelInfo-Cjals-AI-DMpn5Tsh.js";let i=class extends M(O(U(A(R(G(E(I))))))){readModifications(e,t,r){this._modificationsSource={url:w(e,r),context:r}}initialize(){this.addHandles(b(()=>this.modifications,"after-changes",()=>this.modifications=this.modifications,P))}constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new _({wkid:4326,vcsWkid:115700}),this.fullExtent=new T(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(e){e!=null&&e.mode!=="absolute-height"||this._set("elevationInfo",e),this._validateElevationInfo(e)}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(e){const t=[e];for(;(t==null?void 0:t.length)>0;){const r=t.pop();if(!r)return;for(const[n,s]of Object.entries(r)){if(n==="uri")try{const l=new URL("https://tmp"+s).searchParams.get("session");if(l)return l}catch{}typeof s=="object"&&s!==null&&t.push(s)}}return null}async requestRootAndSession(e){const t=(r,n)=>new d("3dtiles-init:"+r,n);return this._rootRequestPromise||(this._rootRequestPromise=new Promise((r,n)=>{this.url||n(t("url-missing","Layer url missing")),this._key=this.customParameters?this.customParameters.key:null,new Promise((s,l)=>{var u,m,c;if(this.replacesTerrain&&!this._key){const p=((u=this.portalItem)==null?void 0:u.portal)||((c=(m=this.parent)==null?void 0:m.portalItem)==null?void 0:c.portal)||k.getDefault();p.signIn().then(()=>{p.g3dTilesEnabled?f(p.restUrl+"/portals/self/modules/g3dtiles",{responseType:"json",query:{f:"json"}}).then(S=>{this._key=S.data.keyString,s()},()=>l(t("g3dtiles-key-error","Error fetching Google 3D Tiles key from portal"))):l(t("g3dTilesEnabled-false","Google 3D Tiles are not enabled on Portal "+p.url))},()=>l(t("sign-in-failed","Error signing in to Portal")))}else s()}).then(()=>{f(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:"array-buffer",signal:e}).then(s=>{try{this._rootTilesetJSON=JSON.parse(new TextDecoder().decode(s.data))}catch(l){return void n(t("root-parse-failed","Error parsing root tile, details: "+l))}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=s.data,this.fullExtent=J(this._rootTilesetJSON),r(),this._rootRequestPromise=null):n(t("root-is-null","Root tile is null."))},s=>{y(s),n(t("root-load-failed","Error loading root tile")),this._rootRequestPromise=null,h.getLogger("IntegratedMesh3DTilesLayer").error("Layer loading failed",s)})},s=>n(s))})),this._rootRequestPromise}async _doLoad(e){const t=e!=null?e.signal:null;if(this._isUsedAsGroundLayer)throw new d("3dtiles-init:not-supported-in-groundlayers","Layer is not supported in basemap.");try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:r=>{var n;if((n=r.typeKeywords)!=null&&n.includes("IntegratedMesh"))return!0;throw new d("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(r){y(r)}if(this._modificationsSource!=null){const r=await v.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin("modifications",r,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(t)}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}async fetchAttributionData(){return{}}_validateElevationInfo(e){const t="Integrated mesh 3d tiles layers";g(h.getLogger(this),j(t,"absolute-height",e)),g(h.getLogger(this),$(t,e))}get replacesTerrain(){return!1}get _isUsedAsGroundLayer(){return H(this.parent)}get hasGoogleUrl(){var e;return!!((e=this.url)!=null&&e.match(/.+\.googleapis.com/))}};o([a({type:["IntegratedMesh3DTilesLayer"]})],i.prototype,"operationalLayerType",void 0),o([a({type:v,clonable:e=>e.clone()}),D({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],i.prototype,"modifications",void 0),o([L(["web-scene","portal-item"],"modifications")],i.prototype,"readModifications",null),o([a({type:_})],i.prototype,"spatialReference",void 0),o([a({type:T})],i.prototype,"fullExtent",void 0),o([a(q)],i.prototype,"elevationInfo",null),o([a({type:["show","hide"]})],i.prototype,"listMode",void 0),o([a(N)],i.prototype,"url",void 0),o([a({readOnly:!0})],i.prototype,"type",void 0),o([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],i.prototype,"path",void 0),o([a({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],i.prototype,"minScale",void 0),o([a({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],i.prototype,"maxScale",void 0),o([a()],i.prototype,"replacesTerrain",null),o([a()],i.prototype,"_isUsedAsGroundLayer",null),o([a()],i.prototype,"hasGoogleUrl",null),i=o([x("esri.layers.IntegratedMesh3DTilesLayer")],i);const ge=i;export{ge as default};
