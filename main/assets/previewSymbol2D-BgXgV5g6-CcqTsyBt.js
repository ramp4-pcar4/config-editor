import{f8 as x,h as W,ad as F,jA as B}from"./index-DBm8NF9m.js";import{R}from"./colorUtils-Eg6lOlXm-qiUIorun.js";import{y as X}from"./fontUtils-C37p4Hgq-D6gBn9v8.js";import{O as Y,Q as _}from"./quantizationUtils-D907S7Bm-DVlaiOwC.js";import{H as V,b as H,j as G,I as J}from"./utils-Cb2uXNfG-DckR7ty1.js";import{S as P,O as K,c as Z,P as U}from"./symbolUtils-D5Wjfwrf-CYSrygZ4.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./asyncUtils-BPUlNCrX-CS8iZqLi.js";import"./jsonUtils-BwLwuQj7-mgynxKsR.js";import"./parser-CWccHtwJ-Bkkvc0mw.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-OOmHNWi7-rAOvaUXo.js";import"./cimSymbolUtils-DCedSSCN-BUCYracA.js";import"./utils-BfXZnjCE-DTSumla2.js";import"./defaultCIMValues-BcSaJjm--58G-soMN.js";import"./enums-a_LDTPYU-CBIcy3mM.js";import"./LRUCache-DPWdPNTF-BhV6gJVw.js";import"./MemCache-qDGoejB7-Bz_y0gIH.js";import"./jsxFactory-Cua8zWVZ-oTGJ1wsI.js";import"./intl-BAA1onnp-C7UNU0re.js";import"./uuid-Dj9mdEVg-BaKSCiyT.js";import"./sanitizerUtils-B1yRmbO2-B7KG_jBT.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./mat2d-BQA-1WB--Pnyy0dhf.js";import"./webStyleSymbolUtils-r0H5toyk-D_xQUure.js";import"./devEnvironmentUtils-CxrVv3RG-ktR0Kqgv.js";import"./styleUtils-DBPDLVBX-CaKmjy4K.js";const I="picture-fill",ee="picture-marker",te="simple-fill",oe="simple-line",ie="simple-marker",ne="text",ae="Aa",le=P.size,z=P.maxSize,re=P.maxOutlineSize,D=P.lineWidth,T=225,se=document.createElement("canvas");function q(t,e,r){if(t.type==="polygon"){const i=t.extent,c=i.width===0?1:i.width,m=i.height===0?1:i.height;t=Y({originPosition:"upperLeft",scale:[c/e,m/r],translate:[i.xmin,i.ymax]},{},t);let s="";for(let a=0;a<t.rings.length;a++){const l=t.rings[a];for(let h=0;h<l.length;h++){const u=l[h][0],d=l[h][1];let o="";h===0?(o=`M${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o):h===l.length-1?(o=`l${u.toString()} ${d.toString()} Z`,s!==""&&(o=` ${o}`),s+=o):(o=`l${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o)}}return s}if(t.type==="polyline"){const i=t.extent,c=i.width===0?1:i.width,m=i.height===0?1:i.height;t=_({originPosition:"upperLeft",scale:[c/e,m/r],translate:[i.xmin,i.ymax]},{},t);let s="";for(let a=0;a<t.paths.length;a++){const l=t.paths[a];for(let h=0;h<l.length;h++){const u=l[h][0],d=l[h][1];let o="";h===0?(o=`M${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o):(o=`l${u.toString()} ${d.toString()}`,s!==""&&(o=` ${o}`),s+=o)}}return s}return""}function Q(t,e){const r=se.getContext("2d"),i=[];e&&(e.weight&&i.push(e.weight),e.size&&i.push(e.size+"px"),e.family&&i.push(e.family)),r.font=i.join(" ");const{width:c,actualBoundingBoxLeft:m,actualBoundingBoxRight:s,actualBoundingBoxAscent:a,actualBoundingBoxDescent:l}=r.measureText(t);return{width:Math.ceil(Math.max(c,m+s)),height:Math.ceil(a+l),x:Math.floor(m),y:Math.floor((a-l)/2)}}function k(t){const e=t==null?void 0:t.size;return{width:e!=null&&typeof e=="object"&&"width"in e?x(e.width):null,height:e!=null&&typeof e=="object"&&"height"in e?x(e.height):null}}async function he(t,e){const r=e.fill,i=t.color;if((r==null?void 0:r.type)==="pattern"&&i&&t.type!==I){const c=await J(r.src,i.toCss(!0));r.src=c,e.fill=r}}async function me(t,e,r,i){var s,a,l;if(!("font"in t)||!t.font||e.shape.type!=="text")return;try{await X(t.font)}catch{}const{width:c,height:m}=k(i);if(!/[\uE600-\uE6FF]/.test(e.shape.text)){const{width:h,height:u,x:d,y:o}=Q(e.shape.text,{weight:(s=e.font)==null?void 0:s.weight,size:(a=e.font)==null?void 0:a.size,family:(l=e.font)==null?void 0:l.family});r[0]=c??h,r[1]=m??u,e.shape.x=d,e.shape.y=o;let n="angle"in t?t.angle:null;if((i==null?void 0:i.rotation)!=null&&(n=(n??0)+i.rotation),n){const M=n*(Math.PI/180),L=Math.abs(Math.sin(M)),$=Math.abs(Math.cos(M));r[1]=r[0]*L+r[1]*$}}}function ce(t,e,r,i,c){var m;if(t.haloColor!=null&&t.haloSize!=null){c.masking??(c.masking=r.map(()=>[]));const s=x(t.haloSize);i[0]+=s,i[1]+=s,r.unshift([{...e,fill:null,stroke:{color:t.haloColor,width:2*s,join:"round",cap:"round"}}]),c.masking.unshift([{shape:{type:"rect",x:0,y:0,width:i[0]+2*B,height:i[1]+2*B},fill:[255,255,255],stroke:null},{...e,fill:[0,0,0,0],stroke:null}])}t.backgroundColor==null&&t.borderLineColor==null||(i[0]+=2*B,i[1]+=2*B,r.unshift([{shape:{type:"rect",x:0,y:0,width:i[0],height:i[1]},fill:t.backgroundColor,stroke:{color:t.borderLineColor,width:x(t.borderLineSize)}}]),(m=c.masking)==null||m.unshift([]))}function N(t,e){return t>e?"dark":"light"}function pe(t,e){var L,$,j,O,A;const r=typeof(e==null?void 0:e.size)=="number"?e==null?void 0:e.size:null,i=r!=null?x(r):null,c=(e==null?void 0:e.maxSize)!=null?x(e.maxSize):null;let m="angle"in t?t.angle:null;(e==null?void 0:e.rotation)!=null&&(m=(m??0)+e.rotation);const s=V(t);let a=H(t);ue(t,245)!=="dark"||e!=null&&e.ignoreWhiteSymbols||(a={width:.75,...a,color:"#bdc3c7"});let l=null;const h={shape:null,fill:s,stroke:a,offset:[0,0]};a!=null&&a.width&&(a.width=Math.min(a.width,re));const u=(a==null?void 0:a.width)||0;let d=(e==null?void 0:e.size)!=null&&((e==null?void 0:e.scale)==null||(e==null?void 0:e.scale)),o=0,n=0,M=!1;switch(t.type){case ie:{const f=t.style,{width:g,height:p}=k(e);let b=g===p&&g!=null?g:i??Math.min(x(t.size),c||z);if((e==null?void 0:e.useMarkerSymbolSize)===!0&&g!==null&&p!==null){const y=Math.min(x(t.size),c||z);b=y>g&&y>p?Math.min(g,p):y}switch(o=b,n=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},d||(o+=u,n+=u);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*n]},{command:"L",values:[o,.5*n]},{command:"M",values:[.5*o,0]},{command:"L",values:[.5*o,n]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*n]},{command:"L",values:[.5*o,0]},{command:"L",values:[o,.5*n]},{command:"L",values:[.5*o,n]},{command:"Z",values:[]}]},d||(o+=u,n+=u);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,n]},{command:"L",values:[0,n]},{command:"Z",values:[]}]},d||(o+=u,n+=u),m&&(M=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*o,0]},{command:"L",values:[o,n]},{command:"L",values:[0,n]},{command:"Z",values:[]}]},d||(o+=u,n+=u),m&&(M=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,n]},{command:"M",values:[o,0]},{command:"L",values:[0,n]}]},m&&(M=!0);break;case"path":h.shape={type:"path",path:t.path||""},d||(o+=u,n+=u),m&&(M=!0),d=!0}break}case oe:{const{width:f,height:g}=k(e),p=G(a).reduce((v,S)=>v+S,0),b=p&&Math.ceil(D/p),y=g??i??u,w=f??(p*b||D);if(d=!0,((L=e==null?void 0:e.geometry)==null?void 0:L.type)==="polyline"&&(($=e==null?void 0:e.geometry)==null?void 0:$.extent)){o=w,n=g??o;const v=1e3,S=.15*v;l=[o,n],n=l[0]>l[1]?v*l[1]/l[0]:v,o=l[0]>l[1]?v:v*l[0]/l[1],a!=null&&a.width&&(a.width=a.width*v/(l[1]>l[0]?l[1]:l[0]),a.width>S&&(a.width=S)),h.shape={type:"path",path:q(e.geometry,o,n)}}else o=(e==null?void 0:e.maxSize)!=null?Math.min(w,e.maxSize):w,n=y,a&&(a.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,n/2]},{command:"L",values:[o-y/2,n/2]}]};break}case I:case te:{const f=typeof(e==null?void 0:e.symbolConfig)=="object"&&!!((j=e==null?void 0:e.symbolConfig)!=null&&j.isSquareFill),{width:g,height:p}=k(e);o=!f&&g!==p||g==null?i??le:g,n=!f&&g!==p||p==null?o:p,d||(o+=u,n+=u),d=!0,(O=e==null?void 0:e.geometry)!=null&&O.extent&&((A=e==null?void 0:e.geometry)==null?void 0:A.type)==="polygon"?(l=[o,n],n=l[0]>l[1]?1e3*l[1]/l[0]:1e3,o=l[0]>l[1]?1e3:1e3*l[0]/l[1],h.shape={type:"path",path:q(e.geometry,o,n)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,n]},{command:"L",values:[0,n]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:K.fill[0];break}case ee:{const f=Math.min(x(t.width),c||z),g=Math.min(x(t.height),c||z),{width:p,height:b}=k(e),y=p===b&&p!=null?p:i??Math.max(f,g),w=t.width/t.height;o=w<=1?Math.ceil(y*w):y,n=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(o/2),y:-Math.round(n/2),width:o,height:n,src:t.url||""},m&&(M=!0);break}case ne:{const f=t,g=(e==null?void 0:e.overrideText)||f.text||ae,p=f.font,{width:b,height:y}=k(e),w=y??i??Math.min(x(p.size),c||z),{width:v,height:S}=Q(g,{weight:p.weight,size:w,family:p.family}),C=/[\uE600-\uE6FF]/.test(g);o=b??(C?w:v),n=C?w:S;let E=.5*(C?w:S);C&&(E+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||E,align:"middle",alignBaseline:f.verticalAlignment,decoration:p&&p.decoration,rotated:f.rotated,kerning:f.kerning},h.font=p&&{size:w,style:p.style,decoration:p.decoration,weight:p.weight,family:p.family};break}}return{shapeDescriptor:h,size:[o,n],outputSize:l,renderOptions:{node:e==null?void 0:e.node,scale:d,opacity:e==null?void 0:e.opacity,rotations:[m],useRotationSize:M,effectView:e==null?void 0:e.effectView,ariaLabel:e==null?void 0:e.ariaLabel,clipBloomEffect:e==null?void 0:e.clipBloomEffect}}}async function He(t,e){var l,h,u,d,o;const{shapeDescriptor:r,size:i,renderOptions:c,outputSize:m}=pe(t,e);if(!r.shape)throw new W("symbolPreview: renderPreviewHTML2D","symbol not supported.");await he(t,r),await me(t,r,i,e);const s=[[r]];if(typeof(e==null?void 0:e.symbolConfig)=="object"&&((l=e==null?void 0:e.symbolConfig)!=null&&l.applyColorModulation)){const n=.6*i[0];s.unshift([{...r,offset:[-n,0],fill:Z(r.fill,-.3)}]),s.push([{...r,offset:[n,0],fill:Z(r.fill,.3)}]),i[0]+=2*n,c.scale=!1}t.type==="text"&&ce(t,r,s,i,c);const a=U(s,i,c);if(m&&a){const n=a.nodeName.toLowerCase()==="img"?a:a.firstChild;n.nodeName.toLowerCase()==="svg"&&n.setAttribute("viewBox",`0 0 ${i[0].toString()} ${i[1].toString()}`),n.setAttribute("width",m[0].toString()),n.setAttribute("height",m[1].toString()),m.length>2&&(n.style.setProperty("padding-left",((h=m[2])==null?void 0:h.toString())+"px"),n.style.setProperty("padding-right",((u=m[2])==null?void 0:u.toString())+"px"),n.style.setProperty("padding-top",((d=m[3])==null?void 0:d.toString())+"px"),n.style.setProperty("padding-bottom",((o=m[3])==null?void 0:o.toString())+"px"),n.style.setProperty("box-sizing","border-box"))}return a}function ue(t,e=T){const r=V(t),i=H(t),c=!r||"type"in r?null:new F(r),m=i!=null&&i.color?new F(i==null?void 0:i.color):null,s=c?N(R(c),e):null,a=m?N(R(m),e):null;return a?s?s===a?s:e>=T?"light":"dark":a:s}export{ue as getContrastingBackgroundTheme,pe as getRenderSymbolParameters,He as previewSymbol2D};
