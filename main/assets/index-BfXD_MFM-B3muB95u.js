var O=Object.defineProperty;var P=(h,a,e)=>a in h?O(h,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[a]=e;var u=(h,a,e)=>P(h,typeof a!="symbol"?a+"":a,e);import{ar as R,as as T,hg as f,a_ as k,av as z,aw as F,h0 as _,aG as b,ax as y,gl as $,aI as D,at as g,hc as H,aJ as N,aK as j,az as M,aL as x,aC as l,aD as J,aM as Q,aE as G,gV as A,hh as W,gw as X,fT as S,hi as q,ai as K,he as U,hj as Y,hk as Z}from"./index-Bq7Udiuc.js";class ee extends W{constructor(e){super(e,"overview");u(this,"overviewGraphicLayer");u(this,"overviewmapStore");u(this,"startExtent",null);this.overviewGraphicLayer=this.$iApi.geo.layer.createLayer({id:"RampOverviewGraphic",layerType:X.GRAPHIC,url:"",cosmetic:!0,system:!0}),this.overviewmapStore=f(this.$vApp.$pinia)}async createMapView(e){if(!e)throw new Error("Attempted to create overview map view without a basemap");const t=typeof e=="string"?await this.findBasemap(e):e;await this.applyBasemap(t),this._rampExtentSet=this.$iApi.geo.map.getExtentSet().clone(),this._rampSR=this._rampExtentSet.sr.clone();const r=this.overviewmapStore.expandFactor;this.esriView=S(await q.MapView({map:this.esriMap,container:this._targetDiv,constraints:{rotationEnabled:!1},spatialReference:this._rampSR.toESRI(),extent:this.$iApi.geo.map.getExtent().toESRI().expand(r)})),this.esriView.ui.components=[],this.handlers.push({type:"mouse-wheel",handler:this.esriView.on("mouse-wheel",i=>{i.stopPropagation()})}),this.handlers.push({type:"double-click",handler:this.esriView.on("double-click",i=>{i.stopPropagation()})}),this.handlers.push({type:"key-down",handler:this.esriView.on("key-down",i=>{i.stopPropagation()})}),this.handlers.push({type:"key-up",handler:this.esriView.on("key-up",i=>{i.stopPropagation()})}),this.handlers.push({type:"drag",handler:this.esriView.on("drag",i=>{i.stopPropagation(),this.mapDrag(i)})}),this.esriView.container.addEventListener("touchmove",i=>{i.preventDefault()}),K(()=>this.esriView.fatalError,()=>{const i=new IntersectionObserver(o=>{o.forEach(d=>{var c;d.isIntersecting&&((c=this.esriView)==null||c.tryFatalErrorRecovery(),i.disconnect())})});i.observe(this.esriView.container)}),this.esriView.when(()=>{this._viewPromise.resolveMe(),this.created=!0})}async addMapGraphicLayer(){var c;if(!this.esriMap){this.noMapErr();return}const e=new U(this.$iApi.geo.map.getExtent(),"overview-graphic"),t=this.overviewmapStore.borderColour??"#FF0000",r=this.overviewmapStore.borderWidth??1,i=this.overviewmapStore.areaColour??"#000000",o=this.overviewmapStore.areaOpacity??.25,d=`${i}${Math.round(o*255).toString(16)}`;e.style=new Y({fill:{colour:d},outline:{colour:t,width:r}}),await this.overviewGraphicLayer.initiate(),await this.overviewGraphicLayer.addGraphic(e),(c=this.esriMap)==null||c.add(this.overviewGraphicLayer.esriLayer)}async removeMapGraphicLayer(){if(!this.esriMap){this.noMapErr();return}if(!this.overviewGraphicLayer.esriLayer)throw new Error("Attempted to remove layer from the map without an esri layer. Likely layer.initiate() was not called or had not finished.");this.overviewGraphicLayer.removeGraphic(),this.esriMap.remove(this.overviewGraphicLayer.esriLayer),await this.overviewGraphicLayer.terminate()}destroyMapView(){var e;(e=this.esriView)==null||e.container.removeEventListener("touchmove",t=>{t.preventDefault()}),super.destroyMapView()}async findBasemap(e){const t=this._basemapStore.find(r=>r.id===e);if(t)return t;{const r=_(this.$vApp.$pinia).config.map;if(r){const i=r.basemaps.find(o=>o.id===e);if(i)return Z.create(i)}}throw new Error(`Invalid basemap id requested: ${e}`)}async setBasemap(e){var i;if(!this.esriView||!this.esriMap)return this.noMapErr(),!1;const t=await this.findBasemap(e),r=((i=this.getCurrentBasemapId()?await this.findBasemap(this.getCurrentBasemapId()):void 0)==null?void 0:i.tileSchemaId)!==t.tileSchemaId;return r?(this.destroyMapView(),await this.createMapView(t)):await this.applyBasemap(t),r}async mapDrag(e){if(e.native.pointerType==="mouse"){if(e.action==="start")await this.cursorHitTest(e)&&(this.startExtent=S(this.overviewGraphicLayer.getEsriGraphic("overview-graphic").geometry));else if(this.startExtent){const t=this.esriView.toMap(e.origin),r=this.esriView.toMap({x:e.x,y:e.y}),i=this.startExtent.clone().offset(r.x-t.x,r.y-t.y,0);this.overviewGraphicLayer.getEsriGraphic("overview-graphic").geometry=i,e.action==="end"&&(this.$iApi.geo.map.zoomMapTo(this.$iApi.geo.geom.geomEsriToRamp(i),void 0,!1),this.startExtent=null)}}}updateOverview(e){const t=this.overviewmapStore.expandFactor,r=this.zoomMapTo(e.expand(t),void 0,!1),i=this.overviewGraphicLayer.getLocalGraphic("overview-graphic");return this.overviewGraphicLayer.removeGraphic(i),i.geometry=e,this.overviewGraphicLayer.addGraphic(i),r}async cursorHitTest(e){return(await this.esriView.hitTest(e)).results.length>0}}class ae extends k{_parseConfig(a){const e=f(this.$vApp.$pinia);e.basemaps=(a==null?void 0:a.basemaps)||{},e.mapConfig.basemaps=Object.values(e.basemaps),e.startMinimized=(a==null?void 0:a.startMinimized)??!0,e.expandFactor=(a==null?void 0:a.expandFactor)??1.5,e.borderColour=(a==null?void 0:a.borderColour)??"#FF0000",e.borderWidth=(a==null?void 0:a.borderWidth)??1,e.areaColour=(a==null?void 0:a.areaColour)??"#000000",e.areaOpacity=(a==null?void 0:a.areaOpacity)??.25}get config(){return super.config}}const ie={class:"relative h-full w-full overflow-hidden"},te={class:"absolute h-30 w-30 top-0 right-0"},re=["content","aria-label"],se=R({__name:"overviewmap",setup(h){const a=f(),{t:e}=z(),t=F("iApi"),r=_(),i=b(),o=y(()=>r.activeBasemapConfig),d=y(()=>a.mapConfig),c=y(()=>a.basemaps),C=y(()=>a.startMinimized),s=$(new ee(t)),p=b(!0),L=b(!1),m=$([]);D(async()=>{await t.geo.map.viewPromise,E(),await s.createMap(d.value,i.value.querySelector(".overviewmap")),await s.viewPromise,await s.addMapGraphicLayer(),p.value=C.value;const v=s.updateOverview(t.geo.map.getExtent());m.push(t.event.on(g.MAP_EXTENTCHANGE,H(100,n=>{v.then(()=>{s.updateOverview(n)})}))),m.push(t.event.on(g.MAP_CREATED,()=>{E()})),m.push(t.event.on(g.MAP_REFRESH_END,()=>{E()})),m.push(t.event.on(g.MAP_BASEMAPCHANGE,async n=>{!n.schemaChanged&&s.created&&o.value&&c.value[o.value.tileSchemaId]===void 0&&(await s.removeMapGraphicLayer(),await s.setBasemap(n.basemapId),await s.addMapGraphicLayer())}))}),N(()=>{m.forEach(v=>t.event.off(v)),s.destroyMap()});const V=async v=>{L.value=!p.value&&await s.cursorHitTest(v)},B=()=>({height:`${p.value?48:200}px`,width:`${p.value?48:200}px`}),I=()=>({top:`${p.value?-6:-3}px`,right:`${p.value?-6:-3}px`,transform:`rotate(${p.value?225:45}deg)`}),E=()=>{var v;if(!o.value){console.error("Overview Map could not obtain the basemap config used by the main map");return}try{const n=(v=o.value)==null?void 0:v.tileSchemaId;if(!n)throw new Error("Overview Map could not obtain the tile schema of the main map");const w=c.value[n];if(!w)throw new Error("Overview Map could not find a suitable basemap that matches the tile schema of the main map");s.created?s.viewPromise.then(()=>s.setBasemap(w.id)):a.updateInitialBasemap(w.id)}catch{s.created||a.updateInitialBasemap(o.value.id),s.viewPromise.then(()=>s.setBasemap(o.value.id))}};return(v,n)=>{const w=j("tippy");return M(),x("div",{class:"relative",ref_key:"el",ref:i},[l("div",{style:A(B()),class:"pointer-events-auto absolute top-0 right-0 mt-12 mr-12 shadow-tm border-4 border-solid border-white bg-white transition-all duration-300 ease-out"},[l("div",ie,[l("div",{class:J(["overviewmap absolute top-0 right-0 h-192 w-192",{"cursor-move":L.value}]),onMousemove:V},null,34)]),l("div",te,[Q((M(),x("button",{type:"button",tabindex:"0",class:"cursor-pointer absolute h-full w-full",onClick:n[0]||(n[0]=pe=>p.value=!p.value),content:G(e)(p.value?"overviewmap.expand":"overviewmap.minimize"),"aria-label":G(e)(p.value?"overviewmap.expand":"overviewmap.minimize")},[(M(),x("svg",{class:"absolute fill-current text-gray-500 transition-all duration-300 ease-out",style:A(I()),xmlns:"http://www.w3.org/2000/svg",fit:"",height:"100%",width:"100%",preserveAspectRatio:"xMidYMid meet",viewBox:"0 0 24 24",focusable:"false"},n[1]||(n[1]=[l("g",{id:"apple-keyboard-control"},[l("path",{d:"M 19.7782,11.7782L 18.364,13.1924L 12,6.82843L 5.63604,13.1924L 4.22183,11.7782L 12,4L 19.7782,11.7782 Z "})],-1)]),4))],8,re)),[[w,{placement:"left",hideOnClick:!1}]])])],4)],512)}}}),oe=T(se,[["__scopeId","data-v-9f9aebec"]]),ne={en:{"overviewmap.expand":"Expand Overview","overviewmap.minimize":"Minimize Overview"},fr:{"overviewmap.expand":"Développer l'aperçu","overviewmap.minimize":"Réduire l'aperçu"}};class ce extends ae{added(){Object.entries(ne).forEach(r=>this.$iApi.$i18n.mergeLocaleMessage(...r)),this._parseConfig(this.config);const a=this.$vApp.$watch(()=>this.config,r=>this._parseConfig(r)),{destroy:e,el:t}=this.mount(oe,{app:this.$element});this.$vApp.$el.getElementsByClassName("inner-shell")[0].appendChild(t.childNodes[0]),this.removed=()=>{a(),e(),f(this.$vApp.$pinia).$reset()}}}export{ce as default};
