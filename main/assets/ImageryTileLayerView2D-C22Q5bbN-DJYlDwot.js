import{as as He,bD as Ke,P as et,aG as li,aH as is,av as rs,m as u,E as P,n as it,ah as gs,gt as os,bp as ui,l as ci,bw as hi,aj as pi,bY as di,F as mi,ao as fi,B as gi,aM as ys,aY as yi,b0 as xs,lL as I,aZ as xi,a_ as Bt,a$ as bi,mU as wi,nl as ht,l3 as _i,mX as J}from"./index-BeTPrQ6f.js";import{T as as,E as bs}from"./datasetUtils-CoevgV-1-DBvxeW7j.js";import{_ as Ti,Y as vi,X as Ci}from"./RasterVFDisplayObject-C7pJeq00-Dp7OM3wS.js";import{F as Ri}from"./LayerView2D-D_-BpxcP-BHff6Xwh.js";import{V as Si}from"./pixelRangeUtils-DcEknavd-BIL6Doop.js";import{j as Pi}from"./clipUtils-BtWPrYe--B7EVDZv3.js";import{s as Fi,n as se}from"./vectorFieldUtils-BL5wnf_H-VvdatiJz.js";import{A as ws,m as Ii,e as tt}from"./MapView-CrB-5KSL-IexKdUKM.js";import{r as pt}from"./vec2f32-hTAvipMV-C0AQcwEv.js";import{u as zi}from"./Container-CO1X8bpa-BR9OVw9m.js";import{T as Mi,M as ki,A as Di,h as Lt}from"./rasterUtils-X7Yuu3FH-BuJN3jOe.js";import{U as _s}from"./WGLContainer-CV7lovie-XGZSmlU_.js";import{c as Ts}from"./TileContainer-BIM43zRp-7nWripvu.js";import{p as rt,O as x,e as ie,y as d,Q as w,af as E,l as W,M as z,g as Oe,q as Q,W as Be,z as _,s as te,_ as le,i as Z,$ as O,B as jt,a as st,H as j,m as Kt,ag as k,k as S,ah as v,d as ot,N as Oi,r as ue,L as ke,t as vs,ab as Ft,C as Bi,f as ge,j as ze,ai as Vi,v as $,aj as me,D as Cs,a5 as Ai,ak as Gi,R as Ui,F as qi,al as Li,am as ji,E as Ei,an as $i,ao as Hi,K as Ni,ap as Wi,aq as Zi,ar as Qi,X as Xi,as as Yi,Y as Ji,at as Ki,au as er,av as tr,aw as sr,ax as ir,o as ce,a2 as rr,ac as or,ay as Vt,az as ar,u as nr,a1 as ns,V as C,Z as he,T as Ve,S as m,U as D,a6 as K,b as we,aA as lr,a3 as Ae,a0 as M,a7 as Ge}from"./GraphShaderModule-2-Wwh4Ie-CB1gcQ9C.js";import{e as ls}from"./utils-CS2SzBG--DDjZAYSk.js";import{D as at,E as Et,_ as De}from"./utils-CVxMaYM5-vm0ifvbR.js";import{C as dt}from"./constants-CWFGCPkc-B_3x8_48.js";import{s as Rs}from"./capabilities-BaKzUyhi-B84We26i.js";import{U as fe,P as Te,D as L,C as ve,R as Y,N as ee}from"./enums-DDJfd4_p-D3z9tmVA.js";import{I as zt}from"./FramebufferObject-CjoCv_5U-BOVEwWIe.js";import{w as Mt,$ as kt}from"./Texture-DLw7oaIg-fTsxdRzn.js";import{g as ur}from"./bitmapUtils-C-2yIopZ-CIvksmSr.js";import{a as N}from"./definitions-DVO21zOC-BwakNu1s.js";import{i as cr}from"./UpdatingHandles-XotKWqvb-CyHJIoZx.js";import{f as hr}from"./PixelBlock-DwvqalBN-B5no8ogH.js";import{p as us}from"./TileInfo-BmHJ3kZT-BCenfvrA.js";import{t as cs,X as hs,P as pr,V as dr}from"./RawBlockCache-BpKctfOs-CqPAG2bh.js";import{p as mr,l as ps,O as fr,N as gr,U as yr}from"./rasterProjectionHelper-DNfZ9Hwc-CptrPCWf.js";import{I as ds,m as xr,v as br}from"./Tile-BNoJIjzH-DZ-xZWMb.js";import"./TileKey-BZu7Ia24-BiyRHU0x.js";import{r as wr}from"./Scheduler-D_tOhFWn-SFGb1GBz.js";import{r as _r}from"./utils-DqlCEhl6-DBO0-7VG.js";import{t as At}from"./highlightOptionsUtils-D6RCaXjG-zpB2TL72.js";import{N as Tr,l as je,w as vr}from"./rasterFieldUtils-D8TPlBIr-DReIywIW.js";import{c as Cr}from"./timeSupport-CH70S3w_-DdC7tV9M.js";import{s as Rr}from"./popupUtils-0qrvMVFA-DW3AaJvU.js";import{t as Sr}from"./LayerView-DBq501tj-9r8g88Ff.js";import{n as Pr}from"./RefreshableLayerView-BoQ2vcWz-CCPPBuQI.js";import"./VertexArrayObject-BAcBN849-N8lUr7x7.js";import"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import"./BufferObject-RHe5uojV-C-IINTcZ.js";import"./VertexElementDescriptor-DLvjNrmQ-Cuvx5w94.js";import"./dataUtils-Dmw3coU_-BChqYnqi.js";import"./Utils-CYY0kXyb-BZKnUtTY.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./ReactiveMap-cp6PWICM-990o5_5b.js";import"./layerViewUtils-BBTk5dU--BemaIlLi.js";import"./CollectionFlattener-DfZaIx8a-ADmwanro.js";import"./workers-CixlqDQM-CMoJ1YZN.js";import"./Queue-CK6TduSr-C-T211SM.js";import"./intl-DRhjUnwt-Dihhq8dq.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./GraphicsCollection-CT-y6p3H-4XYPvC_j.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./jsxFactory-DN-m49_5-CUFCpKPo.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./Map-BgzFtTfu-BMsKSgj7.js";import"./Basemap-Dv-hYkd3-V8XC6wCN.js";import"./loadAll-B16dgL0--5EDWWWLE.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./isBasemap-CJN7v_Jq-Dgi2bMj-.js";import"./writeUtils-DKeM2R6Z-BUUAIn2U.js";import"./persistable-vgejqKb5-CBqfEqX1.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import"./resourceExtension-Boq2U56c-rXLaGMsr.js";import"./PolygonCollection-BEPfGuUm-Bu1vpYsn.js";import"./editableLayers-BTZOOiKD-ByJ-Oydo.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./TablesMixin-Cv7gcoNw-OtczYJk-.js";import"./HeightModelInfo-Cjals-AI-DMpn5Tsh.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./Query-DKLDaFaA-I4zhlfzt.js";import"./Field-Dn1Bgq7n-CJCGLoNR.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./projectionUtils-BXtVkW1R-Dp6FsH61.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./mat2d-Cf4xHr3Z-u09Kv-lR.js";import"./mat2df64-VxtldH1S-CqyKAV7h.js";import"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import"./Cyclical-Bzwh_QaL-CXh-hbnA.js";import"./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js";import"./utils-CRANtbnc-C6zyufvL.js";import"./utils-t279O251-BBk6rV0U.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./a11yUtils-tU3tY6-a-CmHbThdR.js";import"./vec32-CI1xtKog-DFVYRcgb.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./arcadeUtils-BkvNBhzm-KzAaTYHA.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./imageUtils-DITyjHV4-jEv5aA2D.js";import"./modeUtils-V6BDu_YT-Dq8o_RJK.js";import"./ColorBackground-C0DZs7p1-CENExjrO.js";import"./TileKey-1TQKLvpf-ByD6Ad6n.js";import"./signal-DHxLvooI-Bin-tnuW.js";import"./Version-DSJSGSLA-Cg87msWM.js";import"./debugFlags-vZXEBr68-Bc51Oe-E.js";import"./EffectView-kLXORhA_-D7bXwfxF.js";import"./parser-CXoJuqeV-C7irlk5U.js";import"./ProgramTemplate-BqCbl7jA-D5ymqDWS.js";import"./vec3f32-GX_cKsFD-UJPpzdNc.js";import"./config-C6w0VpIP-CfPhyZfw.js";import"./earcut-C6NeZYSh-P2HUZ781.js";import"./featureConversionUtils-CZmIxyv5-DHwRSztU.js";import"./OptimizedFeature-C33SioFK-sn7DeAq-.js";import"./OptimizedGeometry-BYxlP_oK-DvAqrgO1.js";import"./OptimizedFeatureSet-Dz5hF8Qm-CgsRgxJh.js";import"./ShaderBuilder-ufvKEDd5-DMnPqr6U.js";const Fr={bandCount:3,minOutput:0,maxOutput:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let Ir=class extends zi{constructor(t=null,e=null,s=null){super(),this._textureInvalidated=!0,this._colormapTextureInvalidated=!0,this._rasterTexture=null,this._maskTexture=null,this._rasterTextureBandIds=null,this._transformGridTexture=null,this._colormapTexture=null,this._colormap=null,this._supportsBilinearTexture=!0,this._processedTexture=null,this._highlightTexture=null,this.functionTextures=[],this.projected=!1,this.stencilRef=0,this.coordScale=[1,1],this._processed=!1,this._highlighted=!1,this._symbolizerParameters=null,this.height=null,this.isRendereredSource=!1,this.pixelRatio=1,this.resolution=0,this.rotation=0,this._source=null,this._mask=null,this.rawPixelData=null,this._suspended=!1,this._bandIds=null,this._interpolation=null,this._transformGrid=null,this.width=null,this.x=0,this.y=0,this.source=t,this.transformGrid=e,this.interpolation=s}destroy(){super.destroy(),this._disposeTextures()}get processedTexture(){return this._processedTexture}set processedTexture(t){this._processedTexture!==t&&(this._disposeTextures(!0),this._processedTexture=t)}get highlightTexture(){return this._highlightTexture}set highlightTexture(t){var e;this._highlightTexture!==t&&((e=this._highlightTexture)==null||e.dispose(),this._highlightTexture=t),t==null&&(this._highlighted=!1)}get rasterTexture(){return this._rasterTexture}set rasterTexture(t){var e;this._rasterTexture!==t&&((e=this._rasterTexture)==null||e.dispose(),this._rasterTexture=t),t==null&&(this.projected=!1)}get processed(){return this._processed}set processed(t){this._processed=t,t||(this.processedTexture=I(this.processedTexture),this.invalidateTexture())}get highlighted(){return this._highlighted}get symbolizerParameters(){return this._symbolizerParameters||Fr}set symbolizerParameters(t){this._symbolizerParameters!==t&&(this._symbolizerParameters=t,this._colormapTextureInvalidated=!0)}get source(){return this._source}set source(t){this._source!==t&&(this._source=t,this._rasterTexture&&(this._rasterTexture=I(this._rasterTexture),this._rasterTextureBandIds=null),this.projected=!1,this.invalidateTexture())}get mask(){return this._mask}set mask(t){this._mask!==t&&(this._mask=t,this._maskTexture=I(this._maskTexture))}get suspended(){return this._suspended}set suspended(t){this._suspended&&!t&&this.stage&&(this.ready(),this.requestRender()),this._suspended=t}get bandIds(){return this._bandIds}set bandIds(t){this._bandIds=t,this._isBandIdsChanged(t)&&(this.projected=!1,this.invalidateTexture())}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){this._interpolation=t,this._rasterTexture&&this._rasterTexture.setSamplingMode(this._getTextureSamplingMethod(t||"nearest")==="bilinear"?9729:9728)}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid!==t&&(this._transformGrid=t,this._transformGridTexture=I(this._transformGridTexture))}invalidateTexture(){this._textureInvalidated||(this._textureInvalidated=!0,this.requestRender())}getRasterTextureSize(t=!1){var s,i;const e=t||this.projected;return[e?this.width:((s=this.source)==null?void 0:s.width)||this.width,e?this.height:((i=this.source)==null?void 0:i.height)||this.height]}getRasterCellSize(){var i;const t=(i=this.rawPixelData)==null?void 0:i.srcPixelSize,{projected:e,resolution:s}=this;return t&&!e?[t.x,t.y]:[s,s]}_createTransforms(){return{displayViewScreenMat3:tt()}}setTransform(t){const e=xi(this.transforms.displayViewScreenMat3),[s,i]=t.toScreenNoRotation([0,0],[this.x,this.y]),o=this.resolution/this.pixelRatio/t.resolution,r=o*this.width,a=o*this.height,n=Math.PI*this.rotation/180;Bt(e,e,pt(s,i)),Bt(e,e,pt(r/2,a/2)),bi(e,e,-n),Bt(e,e,pt(-r/2,-a/2)),wi(e,e,pt(r,a)),xs(this.transforms.displayViewScreenMat3,t.displayViewMat3,e)}getTextures({forProcessing:t=!1,useProcessedTexture:e=!1}={}){const s=e?this._processedTexture??this._rasterTexture:this._rasterTexture,i=[],o=[];return s?(this._transformGridTexture&&!this.projected&&(o.push(this._transformGridTexture),i.push("u_transformGrid")),o.push(s),i.push("u_image"),!this._colormapTexture||!e&&t||(o.push(this._colormapTexture),i.push("u_colormap")),this._maskTexture&&(o.push(this._maskTexture),i.push("u_mask")),{names:i,textures:o}):{names:i,textures:o}}onAttach(){this.invalidateTexture()}onDetach(){this.invalidateTexture()}updateTexture({context:t}){if(!this.stage)return void this._disposeTextures();const e=this._isValidSource(this.source);e&&this._colormapTextureInvalidated&&(this._colormapTextureInvalidated=!1,this._updateColormapTexture(t)),this._textureInvalidated&&(this._textureInvalidated=!1,this._createOrDestroyRasterTexture(t),this._rasterTexture&&(e?(this.transformGrid&&!this._transformGridTexture&&(this._transformGridTexture=Mi(t,this.transformGrid)),this._mask&&!this._maskTexture&&(this._maskTexture=ki(t,this._mask,[this.width,this.height]))):this._rasterTexture.setData(null)),this.suspended||(this.ready(),this.requestRender()))}updateProcessedTexture(t=!0){t&&(this._highlighted=this.highlightTexture!=null);const{functionTextures:e}=this;e.length!==0&&(this.processedTexture=e.shift(),e.forEach(s=>s==null?void 0:s.dispose()),e.length=0,this.processed=!!this.processedTexture)}_createOrDestroyRasterTexture(t){var r;const e=(r=this.source)==null?void 0:r.extractBands(this.bandIds);if(!this._isValidSource(e))return void(this._rasterTexture&&(this._rasterTexture=I(this._rasterTexture),this._rasterTextureBandIds=null));const s=!this._isBandIdsChanged(this.bandIds);if(this._rasterTexture){if(s)return;this._rasterTexture=I(this._rasterTexture),this._rasterTextureBandIds=null}this._supportsBilinearTexture=!!t.capabilities.textureFloatLinear;const i=this._getTextureSamplingMethod(this.interpolation),o=this.isRendereredSource;this._rasterTexture=Di(t,e,i,o),this.projected=!1,this._processed=!1,this._rasterTextureBandIds=this.bandIds?[...this.bandIds]:null}_isBandIdsChanged(t){const e=this._rasterTextureBandIds;return!(e==null&&t==null||e&&t&&e.join("")===t.join(""))}_isValidSource(t){var e;return t!=null&&((e=t.pixels)==null?void 0:e.length)>0}_getTextureSamplingMethod(t){const{type:e}=this.symbolizerParameters,s=e==="lut"&&!this.symbolizerParameters.isClassBreaks||e==="hillshade"||e==="stretch"&&this.symbolizerParameters.bandCount===1;return!this._supportsBilinearTexture||s||t!=="bilinear"&&t!=="cubic"?"nearest":"bilinear"}_updateColormapTexture(t){const e=this._colormap,s=this.symbolizerParameters.colormap;return s?e?s.length!==e.length||s.some((i,o)=>i!==e[o])?(this._colormapTexture&&(this._colormapTexture=I(this._colormapTexture)),this._colormapTexture=Lt(t,s),void(this._colormap=s)):void 0:(this._colormapTexture=Lt(t,s),void(this._colormap=s)):(this._colormapTexture&&(this._colormapTexture=I(this._colormapTexture)),void(this._colormap=null))}_disposeTextures(t=!1){t?this.projected&&(this._transformGridTexture=I(this._transformGridTexture)):(this._rasterTexture=I(this._rasterTexture),this._colormapTexture=I(this._colormapTexture),this._transformGridTexture=I(this._transformGridTexture),this._maskTexture=I(this._maskTexture),this._rasterTextureBandIds=null,this._colormap=null,this._colormapTextureInvalidated=!0),this._processedTexture=I(this._processedTexture),this._highlightTexture=I(this._highlightTexture)}},zr=class extends _s{constructor(t,e,s,i,o,r,a=null){super(t,e,s,i,o,r),this.bitmap=null,this.bitmap=new Ir(a,null,null),this.bitmap.coordScale=[o,r],this.bitmap.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.bitmap.destroy(),this.bitmap=null,this.stage=null}set stencilRef(t){this.bitmap.stencilRef=t}get stencilRef(){return this.bitmap.stencilRef}setTransform(t){super.setTransform(t),this.bitmap.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}_createTransforms(){return{displayViewScreenMat3:tt(),tileMat3:tt()}}onAttach(){this.bitmap.stage=this.stage}onDetach(){this.bitmap.stage=null}},Ss=class extends Ae{};u([Ve(0,_)],Ss.prototype,"position",void 0);let Mr=class extends Ge{},Ne=class extends M{};u([m(D)],Ne.prototype,"inputTexture",void 0),u([m(D)],Ne.prototype,"sumTexture",void 0),u([m(D)],Ne.prototype,"numOfNoDataTexture",void 0),u([m(d)],Ne.prototype,"numTexels",void 0);let gt=class extends Oe{constructor(){super(...arguments),this.type="TextureStatisticsDiffShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new x(at(e),0,1)}}fragment(t){const{inputTexture:e,numOfNoDataTexture:s,sumTexture:i}=this.config,o=new Be,r=z(e,t.uv),a=v(i,new k(0,0),new S(0)),n=v(s,new k(0,0),new S(0)).r,l=this.config.numTexels.subtract(n),c=a.divide(l),h=O(r.a,new d(0)),p=new d(1).subtract(h).multiply(r.subtract(c));return o.fragColor=p.multiply(p),o}};u([m(Ne)],gt.prototype,"config",void 0),u([J(0,K(Ss))],gt.prototype,"vertex",null),u([J(0,K(Mr))],gt.prototype,"fragment",null);let Ps=class extends Ae{};u([Ve(0,_)],Ps.prototype,"position",void 0);let kr=class extends Ge{},pe=class extends M{};u([m(D)],pe.prototype,"minTexture",void 0),u([m(D)],pe.prototype,"maxTexture",void 0),u([m(D)],pe.prototype,"sumTexture",void 0),u([m(D)],pe.prototype,"numOfNoDataTexture",void 0),u([m(S)],pe.prototype,"width",void 0),u([m(S)],pe.prototype,"height",void 0),u([m(S)],pe.prototype,"isFirstPass",void 0);let yt=class extends Oe{constructor(){super(...arguments),this.type="TextureStatisticsMinMaxSumShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new x(at(e),0,1)}}fragment(t){const e=new Be,{minTexture:s,maxTexture:i,sumTexture:o,numOfNoDataTexture:r}=this.config,a=t.glFragCoord.xy,n=new k(a.multiply(2)),l=new S(0),c=v(s,n,l),h=v(s,n.add(new k(-1,0)),l),p=v(s,n.add(new k(0,-1)),l),f=v(s,n.add(new k(-1,-1)),l),g=Ee(Ee(c,Ee(h,new x(dt))),Ee(p,Ee(f,new x(dt)))),y=v(i,n,l),b=v(i,n.add(new k(-1,0)),l),T=v(i,n.add(new k(0,-1)),l),F=v(i,n.add(new k(-1,-1)),l),R=$e($e(y,$e(b,new x(-dt))),$e(T,$e(F,new x(-dt)))),q=v(o,n,l),X=v(o,n.add(new k(-1,0)),l),qe=v(o,n.add(new k(0,-1)),l),Le=v(o,n.add(new k(-1,-1)),l),Dt=Et(mt(q),mt(X),mt(qe),mt(Le)),ut=v(r,n,l),Ot=v(r,n.add(new k(-1,0)),l),_e=v(r,n.add(new k(0,-1)),l),re=v(r,n.add(new k(-1,-1)),l),ct=new d(this.config.isFirstPass),ni=Et(ft(ut,ct),ft(Ot,ct),ft(_e,ct),ft(re,ct));return e.fragData0=g,e.fragData1=R,e.fragData2=Dt,e.fragData3=ni,e}};function Ee(t,e){const s=O(t.a,new d(0));return st(t,e).multiply(new d(1).subtract(s)).add(e.multiply(s))}function $e(t,e){const s=O(t.a,new d(0));return ot(t,e).multiply(new d(1).subtract(s)).add(e.multiply(s))}function mt(t){const e=O(t.a,new d(0)),s=new d(1).subtract(e);return t.multiply(s)}function ft(t,e){const s=O(t.a,new d(0)),i=new d(1).subtract(e);return e.multiply(s).multiply(new x(1)).add(i.multiply(t))}u([m(pe)],yt.prototype,"config",void 0),u([J(0,K(Ps))],yt.prototype,"vertex",null),u([J(0,K(kr))],yt.prototype,"fragment",null);let Fs=class extends Ae{};u([Ve(0,_)],Fs.prototype,"position",void 0);let Dr=class extends Ge{},ye=class extends M{};u([m(D)],ye.prototype,"minTexture",void 0),u([m(D)],ye.prototype,"maxTexture",void 0),u([m(D)],ye.prototype,"sumTexture",void 0),u([m(D)],ye.prototype,"numOfNoDataTexture",void 0),u([m(D)],ye.prototype,"diffSqTexture",void 0),u([m(d)],ye.prototype,"numTexels",void 0);let xt=class extends Oe{constructor(){super(...arguments),this.type="TextureStatisticsStdDevShader"}vertex(t){const e=t.position;return{uv:e,glPosition:new x(at(e),0,1)}}fragment(t){const e=new Be,{minTexture:s,maxTexture:i,numOfNoDataTexture:o,sumTexture:r,diffSqTexture:a}=this.config,n=t.glFragCoord.xy,l=new k(n),c=new S(0),h=v(s,l,c),p=v(i,l,c),f=v(r,l,c),g=v(o,l,c).r,y=v(a,l,c),b=this.config.numTexels.subtract(g),T=f.divide(b),F=y.divide(b),R=le(F);return e.fragData0=h,e.fragData1=p,e.fragData2=T,e.fragData3=R,e}};u([m(ye)],xt.prototype,"config",void 0),u([J(0,K(Fs))],xt.prototype,"vertex",null),u([J(0,K(Dr))],xt.prototype,"fragment",null);let Is=class extends Ae{};u([Ve(0,_)],Is.prototype,"position",void 0);let Or=class extends Ge{},bt=class extends M{};u([m(D)],bt.prototype,"sumTexture",void 0),u([m(S)],bt.prototype,"width",void 0),u([m(S)],bt.prototype,"height",void 0);class wt extends Oe{constructor(){super(...arguments),this.type="TextureStatisticsSumOfSquaredDiffShader"}vertex(e){const s=e.position;return{uv:s,glPosition:new x(at(s),0,1)}}fragment(e){const s=new Be,{sumTexture:i}=this.config,o=e.glFragCoord.xy,r=new k(o.multiply(2)),a=new S(0),n=v(i,r,a),l=v(i,r.add(new k(-1,0)),a),c=v(i,r.add(new k(0,-1)),a),h=v(i,r.add(new k(-1,-1)),a),p=Et(n,l,c,h);return s.fragData0=p,s.fragData1=new x(0),s.fragData2=new x(0),s.fragData3=new x(0),s}}u([m(bt)],wt.prototype,"config",void 0),u([J(0,K(Is))],wt.prototype,"vertex",null),u([J(0,K(Or))],wt.prototype,"fragment",null);const Gt=1048576;class Br extends rt{constructor(){super(...arguments),this.type=32,this._width=0,this._height=0,this._framebuffers=null,this._minTexture=null,this._maxTexture=null,this._sumTexture=null,this._numOfNoDataTexture=null,this._resultsFramebuffer=null,this._startFramebuffer=null,this._diffFramebuffer=null,this._scaleFbo=null,this.shaders={textureStatisticsMinMaxSum:new yt,textureStatisticsSum:new wt,textureStatisticsDiff:new gt,textureStatisticsStdDev:new xt}}dispose(){this.shaders.textureStatisticsMinMaxSum=null,this._framebuffers&&(this._framebuffers.forEach(e=>I(e)),this._framebuffers=null),I(this._resultsFramebuffer),I(this._startFramebuffer),I(this._diffFramebuffer),I(this._scaleFbo),I(this._minTexture),I(this._maxTexture),I(this._sumTexture),I(this._numOfNoDataTexture)}get minValuesTexture(){return this._minTexture||null}get maxValuesTexture(){return this._maxTexture||null}get meanValuesTexture(){var e;return((e=this._resultsFramebuffer)==null?void 0:e.getColorTexture(fe))||null}get stdDevValuesTexture(){var e;return((e=this._resultsFramebuffer)==null?void 0:e.getColorTexture(Te))||null}get statsFbo(){return this._resultsFramebuffer}render(e,s){const{context:i,painter:o}=e;let r=s.fbo.width,a=s.fbo.height,n=s.fbo;const l=i.gl,c=i.getBoundFramebufferObject();if(r*a>Gt||!ht(r)||!ht(a)){const g=r/a;if(r*a>Gt){const y=Math.max(Math.floor(Math.sqrt(Gt/g)),1);r=Math.max(Math.floor(g*y),1),a=y}if(ht(r)||(r=ms(r)),ht(a)||(a=ms(a)),this._scaleFbo)this._scaleFbo.resize(r,a);else{const{dataType:y,internalFormat:b}=s.fbo.getColorTexture(L).descriptor,T=b??Y.RGBA8;this._scaleFbo=We(i,r,a,y,T)}i.bindFramebuffer(this._scaleFbo),i.setViewport(0,0,r,a),o.blitTexture(i,n.getColorTexture(L),9728),n=this._scaleFbo}this._updateResources(e,n),o.setPipelineState({...ls,color:{write:[!0,!0,!0,!0],blendMode:"none"}});const h=this._applyReductionPass(e);l.readBuffer(l.COLOR_ATTACHMENT3),h.copyToTexture(0,0,1,1,0,0,this._numOfNoDataTexture),l.readBuffer(l.COLOR_ATTACHMENT2),h.copyToTexture(0,0,1,1,0,0,this._sumTexture),l.readBuffer(l.COLOR_ATTACHMENT1),h.copyToTexture(0,0,1,1,0,0,this._maxTexture),l.readBuffer(l.COLOR_ATTACHMENT0),h.copyToTexture(0,0,1,1,0,0,this._minTexture);const p=s.fbo.getColorTexture(L);if(!p)throw new Error("Start buffer color texture is not available, cannot compute diff.");this._computeDiff(e,p,this._sumTexture,this._numOfNoDataTexture,r,a);const f=this._applySecondReductionPass(e,r,a).getColorTexture(L);this._computeSdtDev(e,this._minTexture,this._maxTexture,this._sumTexture,this._numOfNoDataTexture,f,r,a),i.bindFramebuffer(c),i.setViewport(0,0,s.fbo.width,s.fbo.height),i.setDrawBuffers([L]),o.setPipelineState(ls)}_applyReductionPass(e){const{context:s,painter:i}=e,o=this.shaders.textureStatisticsMinMaxSum,r=this._framebuffers;if(r===null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");s.setDrawBuffers([L,ve,fe]);const a=this._startFramebuffer;let n=a.getColorTexture(L),l=a.getColorTexture(ve),c=a.getColorTexture(fe),h=a.getColorTexture(Te);const p=r;let f=0;for(const g of p){s.setViewport(0,0,g.width,g.height),s.bindFramebuffer(g),s.setClearColor(0,0,0,0),s.clear(16384);const y={shader:o,uniforms:{config:{minTexture:{texture:n,unit:1},maxTexture:{texture:l,unit:2},sumTexture:{texture:c,unit:3},numOfNoDataTexture:{texture:h,unit:4},width:g.width,height:g.height,isFirstPass:f===0?1:0}},defines:null,optionalAttributes:null,useComputeBuffer:!1};i.submitDrawMesh(s,y,i.quadMesh),n=g.getColorTexture(L),l=g.getColorTexture(ve),c=g.getColorTexture(fe),h=g.getColorTexture(Te),f++}return r.at(-1)}_applySecondReductionPass(e,s,i){const{context:o,painter:r}=e,a=this.shaders.textureStatisticsSum,n=this._framebuffers;if(n===null||this._diffFramebuffer==null)throw new Error("Framebuffers are not initialized, cannot apply reduction pass.");o.setDrawBuffers([L]);let l=this._diffFramebuffer.getColorTexture(L);const c=n;for(const h of c){o.setViewport(0,0,h.width,h.height),o.bindFramebuffer(h),o.setClearColor(0,0,0,0),o.clear(16384);const p={shader:a,uniforms:{config:{sumTexture:{texture:l,unit:2},width:h.width,height:h.height}},defines:null,optionalAttributes:null,useComputeBuffer:!1};r.submitDrawMesh(o,p,r.quadMesh),l=h.getColorTexture(L)}return n.at(-1)}_updateResources(e,s){const{context:i}=e,o=s.width,r=s.height;if(this._startFramebuffer===null){if(!Rs().supportsColorBufferFloat)throw new Error("WebGL does not support color buffer float, cannot compute texture statistics.");const n=s.getColorTexture(L);if(!n)throw new Error("Input FBO does not have a color attachment 0, cannot compute texture statistics.");const l=n.descriptor,{dataType:c,internalFormat:h}=l,p=We(i,o,r,c,h??Y.RGBA8,4),f=p.getColorTexture(L),g=p.getColorTexture(ve),y=p.getColorTexture(fe),b=p.getColorTexture(Te);s.copyToTexture(0,0,o,r,0,0,f),s.copyToTexture(0,0,o,r,0,0,g),s.copyToTexture(0,0,o,r,0,0,y),s.copyToTexture(0,0,o,r,0,0,b),this._startFramebuffer=p,this._diffFramebuffer=We(i,o,r,ee.FLOAT,Y.RGBA32F),this._resultsFramebuffer=We(i,1,1,ee.FLOAT,Y.RGBA32F,4),this._minTexture=Me(i,1,1,ee.FLOAT,Y.RGBA32F),this._maxTexture=Me(i,1,1,ee.FLOAT,Y.RGBA32F),this._sumTexture=Me(i,1,1,ee.FLOAT,Y.RGBA32F),this._numOfNoDataTexture=Me(i,1,1,ee.FLOAT,Y.R32F)}else{const n=this._startFramebuffer;n.resize(o,r);const l=n.getColorTexture(L),c=n.getColorTexture(ve),h=n.getColorTexture(fe),p=n.getColorTexture(Te);s.copyToTexture(0,0,o,r,0,0,l),s.copyToTexture(0,0,o,r,0,0,c),s.copyToTexture(0,0,o,r,0,0,h),s.copyToTexture(0,0,o,r,0,0,p),this._diffFramebuffer.resize(o,r)}if(this._width===o&&this._height===r&&this._framebuffers!==null)return;const a=(this._framebuffers||[]).reverse();this._framebuffers=null,this._width=o,this._height=r,this._framebuffers=this._updateFramebuffers(i,o,r,a,4)}_updateFramebuffers(e,s,i,o,r=1){const a=[];let n=s,l=i;for(;n>1||l>1;){const c=Math.max(1,Math.floor(n/2)),h=Math.max(1,Math.floor(l/2)),p=Vr(e,c,h,o,r);a.push(p),n=c,l=h}return a.at(-1),o.forEach(c=>I(c)),o.length=0,a}_computeDiff(e,s,i,o,r,a){const{context:n,painter:l}=e;n.bindFramebuffer(this._diffFramebuffer),n.setDrawBuffers([L]),n.setViewport(0,0,r,a),n.setClearColor(0,0,0,0),n.clear(16384);const c={shader:this.shaders.textureStatisticsDiff,uniforms:{config:{inputTexture:{texture:s,unit:1},sumTexture:{texture:i,unit:2},numOfNoDataTexture:{texture:o,unit:3},numTexels:r*a}},defines:null,optionalAttributes:null,useComputeBuffer:!1};l.submitDrawMesh(n,c,l.quadMesh)}_computeSdtDev(e,s,i,o,r,a,n,l){const{context:c,painter:h}=e;c.bindFramebuffer(this._resultsFramebuffer),c.setDrawBuffers([L,ve,fe,Te]),c.setViewport(0,0,1,1),c.setClearColor(0,0,0,0),c.clear(16384);const p={shader:this.shaders.textureStatisticsStdDev,uniforms:{config:{minTexture:{texture:s,unit:1},maxTexture:{texture:i,unit:2},sumTexture:{texture:o,unit:3},numOfNoDataTexture:{texture:r,unit:4},diffSqTexture:{texture:a,unit:5},numTexels:n*l}},defines:null,optionalAttributes:null,useComputeBuffer:!1};h.submitDrawMesh(c,p,h.quadMesh)}}function Vr(t,e,s,i,o=1){let r=i.pop();return r!==void 0?r.resize(e,s):r=We(t,e,s,ee.FLOAT,Y.RGBA32F,o),r}function We(t,e,s,i,o,r=1){if(r<1||r>4)throw new Error("Number of color attachments must be between 1 and 4.");const a=new zt(t,Me(t,e,s,i,o));for(let n=1;n<r;n++){const l=Me(t,e,s,i,o);a.attachColorTexture(l,L+n)}return a}function Me(t,e,s,i,o){const r=new kt(e,s);return r.samplingMode=9728,r.wrapMode=33071,r.pixelFormat=6408,r.dataType=i,r.internalFormat=o,new Mt(t,r)}function ms(t){const e=_i(t),s=e/2;return Math.abs(e-t)<Math.abs(s-t)?e:s}function zs(t,e){const s=new kt(t,e);return s.internalFormat=Y.RGBA32F,s.samplingMode=9728,s.dataType=ee.FLOAT,s.isImmutable=!0,s.wrapMode=33071,s}function Ar(t,e,s){const i=zs(e,s);return new Mt(t,i)}function Ms(t,e,s){const i=zs(e,s);return new zt(t,i)}function _t(t){const{symbolizerParameters:e}=t,{type:s}=e,i=s==="lut"?"nearest":t.interpolation,o=i==="bilinear"&&s!=="lut"&&(s!=="stretch"||e.bandCount===1);return{bilinear:o,bicubic:i==="cubic",nearestOnEdge:o}}function Gr(t,e,s,i){const o=ce(e.multiply(s)),r=new k(new S(o.x),new S(o.y)),a=new k(r.x.add(1),r.y),n=new k(r.x,r.y.add(1)),l=new k(r.x.add(1),r.y.add(1)),c=v(t,r,new S(0)),h=v(t,a,new S(0)),p=v(t,n,new S(0)),f=v(t,l,new S(0)),g=Kt(e.multiply(s)),y=W(c,h,g.x),b=W(p,f,g.x),T=W(y,b,g.y);if(!i)return T;const F=new x(c.a,h.a,p.a,f.a),R=F.xy.multiply(F.zw),q=ce(R.x.multiply(R.y).add(.5)),X=T.multiply(q),qe=De(q).multiply(z(t,e));return X.add(qe)}let Ze=class extends M{};function Ur(t,e){const s=z(e.transformTexture,t);return new _(s.r,s.g)}function qr(t,e){const{transformTexture:s,targetImageSize:i,transformSpacing:o}=e,r=ce(t.multiply(i)),a=new _(4,1),n=ce(r.divide(o)).multiply(a),l=Kt(r.add(new _(.5,.5)).divide(o)),c=new k(ns(n.x),ns(n.y)),h=new w(l,1);return Q(Cs(l.x,l.y),Lr(s,c,h),jr(s,c,h))}function Lr(t,e,s){const i=v(t,e,new S(0)),o=new k(e.x.add(1),e.y),r=v(t,o,new S(0));return new _(Z(i.rgb,s),Z(r.rgb,s))}function jr(t,e,s){const i=new k(e.x.add(2),e.y),o=v(t,i,new S(0)),r=new k(e.x.add(3),e.y),a=v(t,r,new S(0));return new _(Z(o.rgb,s),Z(a.rgb,s))}function Er(t){const e=O(new _(-1e-5,-1e-5),t).multiply(O(t,new _(1.00001,1.00001))),s=De(e.x.multiply(e.y));return new Oi(s)}function ks(t,e,s=!1){return e?s?Ur(t,e):qr(t,e):t}function Ds(t,e,s){const{bicubic:i=!1,bilinear:o=!1,nearestOnEdge:r=!1}=s??{};return i||o?i?ur(e.texture,t,e.srcImageSize):Gr(e.texture,t,e.srcImageSize,r):z(e.texture,t)}u([m(D)],Ze.prototype,"transformTexture",void 0),u([m(_)],Ze.prototype,"targetImageSize",void 0),u([m(_)],Ze.prototype,"transformSpacing",void 0),u([m(_)],Ze.prototype,"transformGridSize",void 0);let Os=class extends Ae{};u([Ve(0,_)],Os.prototype,"position",void 0);let $r=class extends Ge{};class Ce extends M{}u([m(D)],Ce.prototype,"texture",void 0),u([m(we)],Ce.prototype,"dvsMat3",void 0),u([m(_)],Ce.prototype,"coordScale",void 0),u([m(_)],Ce.prototype,"srcImageSize",void 0),u([m(d)],Ce.prototype,"opacity",void 0);let Bs=class extends M{};u([m(D)],Bs.prototype,"maskTexture",void 0);let Vs=class extends M{};u([m(D)],Vs.prototype,"highlightTexture",void 0);let U=class extends Oe{constructor(){super(...arguments),this.applyProjection=!0,this.lookupProjection=!1,this.bilinear=!1,this.bicubic=!1,this.nearestOnEdge=!1,this.applyPixelMask=!1,this.applyPixelHighlights=!1}vertex(t){const e=t.position,{dvsMat3:s,coordScale:i}=this.config,o=s.multiply(new w(e.multiply(i),1));return{uv:e,glPosition:new x(o,1)}}fragment(t){const e=new Be,s=ks(t.uv,this.applyProjection?this.projectionConfig:void 0,this.lookupProjection);let i=this._colorize(s,t.uv);this.applyPixelHighlights&&(i=this._highlightPixels(t.uv,i));const o=Q(Er(s),new x(0),i);let r=o.a.multiply(this.config.opacity);if(this.applyPixelMask){const a=this._getPixelMask(t.uv);r=r.multiply(a)}return e.fragColor=new x(o.rgb,1).multiply(r),e}_getPixel(t){const{config:e,bicubic:s,bilinear:i,nearestOnEdge:o}=this;return Ds(t,e,{bicubic:s,bilinear:i,nearestOnEdge:o})}_getPixelMask(t){const{maskTexture:e}=this.pixelMaskConfig,s=z(e,t);return E(s.a)}_highlightPixels(t,e){const{highlightTexture:s}=this.highlightConfig,i=z(s,t),o=E(i.a);return W(e,i,o)}};u([C],U.prototype,"applyProjection",void 0),u([C],U.prototype,"lookupProjection",void 0),u([C],U.prototype,"bilinear",void 0),u([C],U.prototype,"bicubic",void 0),u([C],U.prototype,"nearestOnEdge",void 0),u([C],U.prototype,"applyPixelMask",void 0),u([C],U.prototype,"applyPixelHighlights",void 0),u([m(Ce)],U.prototype,"config",void 0),u([he(Ze)],U.prototype,"projectionConfig",void 0),u([he(Bs)],U.prototype,"pixelMaskConfig",void 0),u([he(Vs)],U.prototype,"highlightConfig",void 0),u([J(0,K(Os))],U.prototype,"vertex",null),u([J(0,K($r))],U.prototype,"fragment",null);let de=class extends M{};function nt(t,e,s,i=!0){const{colormapTexture:o,colormapOffset:r,colormapMaxIndex:a}=s,n=t.r.multiply(e).subtract(r),l=ie(n,new d(0),a),c=new _(l.add(.5).divide(a.add(1)),0),h=z(o,c),p=new x(h.rgb,h.a.multiply(t.a));if(i)return p;const f=O(new d(0),n).multiply(O(n,s.colormapMaxIndex));return p.multiply(f)}u([m(D)],de.prototype,"colormapTexture",void 0),u([m(d)],de.prototype,"colormapOffset",void 0),u([m(d)],de.prototype,"colormapMaxIndex",void 0);let As=class extends U{constructor(){super(...arguments),this.type="RasterColorizerLUTShader"}_colorize(t){const e=this._getPixel(t);return nt(e,new d(1),this.colormapConfig,!1)}};u([m(de)],As.prototype,"colormapConfig",void 0);function Gs(t){const e=new x(0,-.3333333333333333,.6666666666666666,-1),s=Q(jt(t.y,t.z),new x(t.zy,e.wz),new x(t.yz,e.xy)),i=Q(jt(t.x,s.x),new x(s.xyw,t.x),new x(t.x,s.yzx)),o=i.x.subtract(st(i.w,i.y)),r=new d(1e-10),a=i.w.subtract(i.y),n=o.multiply(6).add(r),l=j(a.divide(n).add(i.z)),c=i.x.add(r),h=st(o.divide(c),new d(1));return new w(l,h,i.x)}function Us(t){const e=new x(1,.6666666666666666,.3333333333333333,3),s=j(Kt(t.xxx.add(e.xyz)).multiply(6).subtract(e.www)),i=ie(s.subtract(e.xxx),new w(0,0,0),new w(1));return t.z.multiply(W(e.xxx,i,t.y))}let ae=class extends M{};function H(t){const e=j(t),s=O(e,new _(1,1)).multiply(e),i=new d(2).subtract(e),o=O(new d(1),e).multiply(i);return s.add(o)}function lt(t,e,s){const i=new d(1).divide(s),o=z(t,H(i.multiply(new _(-1,-1)).add(e))),r=z(t,H(i.multiply(new _(0,-1)).add(e))),a=z(t,H(i.multiply(new _(1,-1)).add(e))),n=z(t,H(i.multiply(new _(-1,0)).add(e))),l=z(t,H(e)),c=z(t,H(i.multiply(new _(1,0)).add(e))),h=z(t,H(i.multiply(new _(-1,1)).add(e))),p=z(t,H(i.multiply(new _(0,1)).add(e))),f=z(t,H(i.multiply(new _(1,1)).add(e))),g=new x(o.a,r.a,a.a,n.a),y=new x(c.a,h.a,p.a,f.a),b=g.multiply(y),T=b.xy.multiply(b.zw),F=T.x.multiply(T.y).multiply(l.a),R=new te(new d(0),10);return R[0]=o.r,R[1]=r.r,R[2]=a.r,R[3]=n.r,R[4]=l.r,R[5]=c.r,R[6]=h.r,R[7]=p.r,R[8]=f.r,R[9]=F,R}function es(t,e){const s=new x(t[5],t[3],t[7],t[1]).multiply(2),i=new w(t[2],s[0],t[8]),o=new w(t[0],s[1],t[6]),r=Z(i.subtract(o),new w(1)),a=new w(t[6],s[2],t[8]),n=new w(t[0],s[3],t[2]),l=Z(a.subtract(n),new w(1));return new _(r,l).multiply(e)}function qs(t,e,s){const{factor:i}=e,o=es(t,i),r=le(Z(o,o).add(1)),a=t[9],{sinZsinAs:n,sinZcosAs:l,cosZs:c,weights:h}=e;if(!s){const y=Ut({sinZsinA:n[0],sinZcosA:l[0],cosZ:c[0],weights:new d(1),dzxy:o,dzd:r});return new x(y,y,y,a)}const p=Ut({sinZsinA:new w(n[0],n[1],n[2]),sinZcosA:new w(l[0],l[1],l[2]),cosZ:new w(c[0],c[1],c[2]),weights:new w(h[0],h[1],h[2]),dzxy:o,dzd:r}),f=Ut({sinZsinA:new w(n[3],n[4],n[5]),sinZcosA:new w(l[3],l[5],l[5]),cosZ:new w(c[3],c[4],c[5]),weights:new w(h[3],h[4],h[5]),dzxy:o,dzd:r}),g=Z(p.add(f),new w(1));return new x(g,g,g,a)}function Ut(t){const e=t.sinZsinA.multiply(t.dzxy.y),s=t.sinZcosA.multiply(t.dzxy.x),i=e.subtract(s),o=t.cosZ.add(i).divide(t.dzd);return o.multiply(O(new d(0),o)).multiply(t.weights)}function Ls(t,e){const{pixelSizeFactor:s}=t,i=[t.factor[0]/e[0],t.factor[1]/e[1]];if(s>0){const{zFactor:o,pixelSizePower:r,gcsFactor:a}=t,n=e[0]*a,l=e[1]*a;i[0]=(o+n**r*s)/(8*n),i[1]=(o+l**r*s)/(8*l)}return i}u([m(te.ofType(d,6))],ae.prototype,"sinZcosAs",void 0),u([m(te.ofType(d,6))],ae.prototype,"sinZsinAs",void 0),u([m(te.ofType(d,6))],ae.prototype,"cosZs",void 0),u([m(te.ofType(d,6))],ae.prototype,"weights",void 0),u([m(d)],ae.prototype,"minValue",void 0),u([m(d)],ae.prototype,"maxValue",void 0),u([m(_)],ae.prototype,"factor",void 0);let Qe=class extends U{constructor(){super(...arguments),this.type="RasterColorizerShadedReliefShader",this.applyColormap=!1,this.isMultidirectional=!1}_colorize(t){const{texture:e}=this.config,s=lt(e,t,this.config.srcImageSize),i=qs(s,this.hillshadeConfig,this.isMultidirectional);if(!this.applyColormap)return new x(i.x,i.x,i.x,i.a);const{minValue:o,maxValue:r}=this.hillshadeConfig,a=this._getPixel(t),n=r.subtract(o),l=a.r.subtract(o),c=ie(l.divide(n),new d(0),new d(1)),h=nt(new x(c,c,c,1),new d(255),this.colormapConfig),p=Gs(h.xyz),f=Us(new w(p.xy,i.x));return new x(f,h.a.multiply(i.a))}};u([C],Qe.prototype,"applyColormap",void 0),u([C],Qe.prototype,"isMultidirectional",void 0),u([m(ae)],Qe.prototype,"hillshadeConfig",void 0),u([he(de)],Qe.prototype,"colormapConfig",void 0);function B(t){const e=E(t),s=t.add(j(e).subtract(1));return e.multiply(e).divide(s)}function Ue(t){return new x(ce(t.rgb.add(.5)),t.a)}function js(t,e){return O(e.x,t).multiply(O(t,e.y))}function Hr(t,e){let s=new w(0,0,0);const i=new w(t);for(let o=0;o<se/3;o++){const r=6*o,a=new w(e[r],e[r+2],e[r+4]),n=new w(e[r+1],e[r+3],e[r+5]);s=s.add(O(a,i).multiply(O(i,n)))}return E(Z(s,new w(1,1,1)))}function Nr(t,e,s){const i=new w(t);let o=new w(0,0,0),r=new d(0);for(let a=0;a<s/3;a++){const n=9*a,l=new w(e[n],e[n+3],e[n+6]),c=new w(e[n+1],e[n+4],e[n+7]),h=O(l,i).multiply(O(i,c)),p=new w(e[n+2],e[n+5],e[n+8]);r=W(r,p.x,h.x),r=W(r,p.y,h.y),r=W(r,p.z,h.z),o=o.add(h)}return{mapValue:r,includeMask:E(Z(o,new w(1,1,1)))}}let ne=class extends M{};u([m(d)],ne.prototype,"minOutput",void 0),u([m(d)],ne.prototype,"maxOutput",void 0),u([m(w)],ne.prototype,"minCutOff",void 0),u([m(w)],ne.prototype,"maxCutOff",void 0),u([m(w)],ne.prototype,"factor",void 0),u([m(w)],ne.prototype,"gamma",void 0),u([m(w)],ne.prototype,"gammaCorrection",void 0);class Re extends M{}function Es(t,e){const{minCutOff:s,maxCutOff:i,factor:o,minOutput:r}=e;return ie(t,s,i).subtract(s).multiply(o).add(r)}function $s(t,e){const{minCutOff:s,maxCutOff:i,minOutput:o,maxOutput:r,gamma:a,gammaCorrection:n}=e,l=ie(t,s,i).subtract(s),c=i.subtract(s),h=l.divide(c),p=O(new d(1),a),f=E(a.subtract(1)),g=r.subtract(o),y=new w(1),b=ue(y.divide(g),h.multiply(n)),T=De(p.multiply(f).multiply(b)),F=ue(h,y.divide(a)),R=T.multiply(g).multiply(F).add(o);return ie(R,o,r)}function Hs(t,e,s,i=255){const o=s?$s(t.rgb,e).divide(i):Es(t.rgb,e);return new x(o,t.a)}function Wr(t,e,s,i,o){const r=new k(0,0),a=new S(0);let n=v(s.minTexture,r,a).rgb,l=v(s.maxTexture,r,a).rgb;if(o){const y=v(s.meanTexture,r,a).rgb,b=v(s.stddevTexture,r,a).rgb.multiply(s.numberOfStandardDeviations);n=ot(n,y.subtract(b)),l=st(l,y.add(b))}const c=l.subtract(n),h=new w(B(c.x),B(c.y),B(c.z)),p=e.maxOutput.subtract(e.minOutput).multiply(h),f={...e,minCutOff:n,maxCutOff:l,factor:p},g=i?$s(t.rgb,f).divide(255):Es(t.rgb,f);return new x(g,t.a)}u([m(D)],Re.prototype,"minTexture",void 0),u([m(D)],Re.prototype,"maxTexture",void 0),u([m(D)],Re.prototype,"meanTexture",void 0),u([m(D)],Re.prototype,"stddevTexture",void 0),u([m(d)],Re.prototype,"numberOfStandardDeviations",void 0);let oe=class extends U{constructor(){super(...arguments),this.type="RasterColorizerStretchShader",this.isMultiband=!0,this.applyColormap=!1,this.useGamma=!1,this.noOp=!1,this.draStretchType=0}_colorize(t){const e=this._getPixel(t);if(this.noOp)return e;const{draStretchType:s,stretchConfig:i,useGamma:o,statisticsConfig:r}=this;let a=s===0?Hs(e,i,o):Wr(e,i,r,o,s===2);if(this.isMultiband)return a;if(a=new x(a.rrr,a.a),this.applyColormap){const n=this.useGamma?255:1;a=nt(a,new d(n),this.colormapConfig)}return a}};u([C],oe.prototype,"isMultiband",void 0),u([C],oe.prototype,"applyColormap",void 0),u([C],oe.prototype,"useGamma",void 0),u([C],oe.prototype,"noOp",void 0),u([C],oe.prototype,"draStretchType",void 0),u([m(ne)],oe.prototype,"stretchConfig",void 0),u([he(de)],oe.prototype,"colormapConfig",void 0),u([he(Re)],oe.prototype,"statisticsConfig",void 0);const Zr=160,Qr=new Set(["f32","f64","u16","s16","u32","s32"]);let Xr=class extends rt{constructor(){super(...arguments),this.name="BrushRasterColorizer",this.type=0,this.shaders={lut:new As,stretch:new oe,shadedRelief:new Qe},this._mosaicFbo=null,this._statisticsTechnique=null,this._draTimer=0}shutdown(t){super.shutdown(t),this._mosaicFbo=I(this._mosaicFbo),this._statisticsTechnique=I(this._statisticsTechnique)}render(t,e){const s=e.bitmaps.some(qt);s||(this._mosaicFbo=I(this._mosaicFbo),this._statisticsTechnique=I(this._statisticsTechnique));const i=s?this._computeStatisticsTextures(t,e):void 0;for(const o of e.bitmaps){if(!o.source||o.suspended)continue;t.timeline.begin(this.name);const{painter:r}=t;r.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}}),o.updateTexture(t),o.updateProcessedTexture();const{type:a}=o.symbolizerParameters,n=a==="stretch"?this._getStretchOptions(o,i):a==="lut"?this._getLutOptions(o):this._getShadedReliefOptions(o);o.interpolation!=="bilinear"||t.context.capabilities.textureFloatLinear||(n.defines.bilinear=!0),r.submitDrawMesh(t.context,n,r.quadMesh,o),t.timeline.end(this.name)}}_computeStatisticsTextures(t,e){this._statisticsTechnique??(this._statisticsTechnique=new Br);const s=this._statisticsTechnique;let i=gs("esri-2d-dra-delay");if(i==null){const o=e.bitmaps.find(qt),{stretchType:r,bandCount:a}=o.symbolizerParameters,{pixelType:n}=o.source;r==="minMax"&&a>=3&&Qr.has(n)&&(i=Zr)}if(i){const o=performance.now();(o-this._draTimer>=i||t.stationary||!s.minValuesTexture)&&(this._mosaic(t,e),s.render(t,{fbo:this._mosaicFbo}),this._draTimer=o)}else this._mosaic(t,e),s.render(t,{fbo:this._mosaicFbo});return{minTexture:s.minValuesTexture,maxTexture:s.maxValuesTexture,meanTexture:s.meanValuesTexture,stddevTexture:s.stdDevValuesTexture}}_mosaic(t,e){const{context:s,painter:i}=t,o=s.getBoundFramebufferObject();if(this._mosaicFbo)this._mosaicFbo.resize(o.width,o.height);else{const a=Yr(s,o.width,o.height);this._mosaicFbo=new zt(s,a)}s.bindFramebuffer(this._mosaicFbo);const r="RasterColorizerMosaic";for(const a of e.bitmaps){if(!qt(a))continue;t.timeline.begin(r),i.setPipelineState({depth:!1,stencil:{test:{mask:255,compare:514,op:{fail:7680,zFail:7680,zPass:7680}},write:!1},color:{write:[!0,!0,!0,!0],blendMode:"composite"}});const n=a.interpolation;a.interpolation="nearest",a.updateTexture(t),a.updateProcessedTexture();const l=this._getStretchOptions(a);l.defines.noOp=!0,i.submitDrawMesh(t.context,l,i.quadMesh,a),a.interpolation=n,t.timeline.end(r)}s.bindFramebuffer(o)}_getLutOptions(t){const{config:e,projectionConfig:s,colormapConfig:i,pixelMaskConfig:o,highlightConfig:r,projectionDefines:a}=this._getCommonConfig(t),n=_t(t);return{shader:this.shaders.lut,uniforms:{projectionConfig:s,config:e,colormapConfig:i,pixelMaskConfig:o,highlightConfig:r},defines:{...a,...n,applyPixelMask:!!o,applyPixelHighlights:!!r},optionalAttributes:null,useComputeBuffer:!1}}_getStretchOptions(t,e){const s=t.symbolizerParameters,{config:i,projectionConfig:o,colormapConfig:r,pixelMaskConfig:a,highlightConfig:n,projectionDefines:l,textureUnit:c}=this._getCommonConfig(t),h=_t(t),p=e?{minTexture:{texture:e.minTexture,unit:c},maxTexture:{texture:e.maxTexture,unit:c+1},meanTexture:{texture:e.meanTexture,unit:c+2},stddevTexture:{texture:e.stddevTexture,unit:c+3},numberOfStandardDeviations:s.numberOfStandardDeviations||2}:void 0,f=e?s.stretchType==="standardDeviation"?2:1:0;return{shader:this.shaders.stretch,uniforms:{projectionConfig:o,config:i,stretchConfig:s,colormapConfig:r,pixelMaskConfig:a,highlightConfig:n,statisticsConfig:p},defines:{...l,...h,isMultiband:s.bandCount>1,applyColormap:!!r,useGamma:s.useGamma,noOp:t.isRendereredSource&&!t.processed,applyPixelMask:!!a,applyPixelHighlights:!!n,draStretchType:f},optionalAttributes:null,useComputeBuffer:!1}}_getShadedReliefOptions(t){const e=t.symbolizerParameters,{config:s,projectionConfig:i,colormapConfig:o,pixelMaskConfig:r,highlightConfig:a,projectionDefines:n}=this._getCommonConfig(t),l=_t(t);return{shader:this.shaders.shadedRelief,uniforms:{projectionConfig:i,config:s,hillshadeConfig:e,colormapConfig:o,pixelMaskConfig:r,highlightConfig:a},defines:{...n,...l,isMultidirectional:e.hillshadeType>0,applyColormap:!!o,applyPixelMask:!!r,applyPixelHighlights:!!a},optionalAttributes:null,useComputeBuffer:!1}}_getCommonConfig(t){const{coordScale:e,computedOpacity:s,transforms:i}=t,{names:o,textures:r}=t.getTextures({useProcessedTexture:t.processed}),a=r[o.indexOf("u_image")],n=t.getRasterTextureSize();let l=0;const c={texture:{texture:a,unit:l++},dvsMat3:i.displayViewScreenMat3,coordScale:e,srcImageSize:n,opacity:s},h=r[o.indexOf("u_transformGrid")],{transformGrid:p}=t,f=!(!h||!p),g=f?{transformTexture:{texture:h,unit:l++},targetImageSize:[t.width,t.height],transformSpacing:p.spacing,transformGridSize:p.size}:void 0,y=r[o.indexOf("u_colormap")],{colormap:b,colormapOffset:T}=t.symbolizerParameters,F=y&&b?{colormapTexture:{texture:y,unit:l++},colormapOffset:T??0,colormapMaxIndex:b.length/4-1}:void 0,R=r[o.indexOf("u_mask")],q=R?{maskTexture:{texture:R,unit:l++}}:void 0,{highlightTexture:X}=t;return{config:c,projectionConfig:g,colormapConfig:F,pixelMaskConfig:q,highlightConfig:X?{highlightTexture:{texture:X,unit:l++}}:void 0,projectionDefines:{applyProjection:f,lookupProjection:f&&p.spacing[0]===1},textureUnit:l}}};function Yr(t,e,s){const i=new kt(e,s);return i.internalFormat=Y.RGBA32F,i.samplingMode=9728,i.dataType=ee.FLOAT,i.wrapMode=33071,new Mt(t,i)}function qt(t){return!t.suspended&&t.source!=null&&!t.isRendereredSource&&t.symbolizerParameters.type==="stretch"&&!!t.symbolizerParameters.dynamicRangeAdjustment}let Tt=class extends M{};u([m(te.ofType(d,2*se))],Tt.prototype,"ranges",void 0),u([m(we)],Tt.prototype,"bandSwap",void 0),u([m(x)],Tt.prototype,"color",void 0);let $t=class extends U{constructor(){super(...arguments),this.type="RasterRangeHighlightShader",this.hasExistingHighlights=!1}_colorize(t,e){const s=this._getPixel(t),{ranges:i,color:o,bandSwap:r}=this.rangeHighlightConfig,a=r.multiply(s.rgb).x,n=Hr(a,i).multiply(E(s.a)),l=W(new x(0),o,n);if(this.hasExistingHighlights){const{highlightTexture:c}=this.highlightConfig,h=z(c,e);return W(h,l,n)}return l}};u([C],$t.prototype,"hasExistingHighlights",void 0),u([m(Tt)],$t.prototype,"rangeHighlightConfig",void 0);let Jr=class extends rt{constructor(){super(...arguments),this.name="BrushRasterHighlight",this.type=2,this.shaders={range:new $t}}shutdown(t){var e;super.shutdown(t),(e=this._fbo)==null||e.dispose(),this._fbo=void 0}render(t,e){var a;const{context:s}=t;if(!this._fbo){const n=fs(t.context,N,N);this._fbo=new zt(s,n)}const i=s.getBoundFramebufferObject(),o=s.getViewport(),{pixelHighlightOptions:r}=t;for(const n of e.bitmaps){if(!r||!n.source||n.highlighted||n.suspended||n.isRendereredSource)continue;const l=(a=n.bandIds)!=null&&a.length?n.bandIds.indexOf(r.bandId):0;if(l<0||l>2)continue;t.timeline.begin(this.name);const{painter:c}=t;c.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),n.updateTexture(t),n.updateProcessedTexture(!1);const{config:h,projectionConfig:p,highlightConfig:f,projectionDefines:g}=this._getCommonConfig(n),y=_t(n);n.interpolation!=="bilinear"||t.context.capabilities.textureFloatLinear||(y.bilinear=!0);const b=new Float32Array(9);b[3*l]=1;const T={...r,bandSwap:b},F={shader:this.shaders.range,uniforms:{projectionConfig:p,config:h,rangeHighlightConfig:T,highlightConfig:f},defines:{...g,...y,applyPixelMask:!1,applyPixelHighlights:!1,hasExistingHighlights:!!f},optionalAttributes:null,useComputeBuffer:!1};s.bindFramebuffer(this._fbo),s.setViewport(0,0,N,N),c.submitDrawMesh(t.context,F,c.quadMesh);const R=fs(t.context,N,N);this._fbo.copyToTexture(0,0,N,N,0,0,R),n.highlightTexture=R,t.timeline.end(this.name)}s.bindFramebuffer(i),s.setViewport(o.x,o.y,o.width,o.height)}_getCommonConfig(t){const{names:e,textures:s}=t.getTextures({forProcessing:!0,useProcessedTexture:t.processed}),i=s[e.indexOf("u_image")],o=t.getRasterTextureSize(),r={texture:{texture:i,unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:o,opacity:1},a=s[e.indexOf("u_transformGrid")],{transformGrid:n}=t,l=!(!a||!n),c=l?{transformTexture:{texture:a,unit:1},targetImageSize:[t.width,t.height],transformSpacing:n.spacing,transformGridSize:n.size}:void 0,{highlightTexture:h}=t;return{config:r,projectionConfig:c,highlightConfig:h?{highlightTexture:{texture:h,unit:2}}:void 0,projectionDefines:{applyProjection:l,lookupProjection:l&&n.spacing[0]===1}}}};function fs(t,e,s){const i=new kt(e,s);return i.internalFormat=Y.RGBA8,i.samplingMode=9728,i.dataType=ee.UNSIGNED_BYTE,i.isImmutable=!0,i.wrapMode=33071,new Mt(t,i)}let A=class extends rt{shutdown(t){var e;super.shutdown(t),(e=this._fbo)==null||e.dispose(),this._fbo=void 0}render(t,e){var l;const{rasterFunction:s}=t;if(!s)return;const{context:i}=t,o="indexedColormap"in s.parameters?Lt(i,s.parameters.indexedColormap):void 0,r=s.name==="Reproject",a=i.getBoundFramebufferObject(),n=i.getViewport();for(const c of e.bitmaps){const h=r?!(c.rasterTexture&&c.projected):!c.processed;if(!c.source||!h||c.suspended)continue;t.timeline.begin(this.name);const{painter:p}=t;p.setPipelineState({depth:!1,stencil:{test:!1,write:!1},color:{write:[!0,!0,!0,!0],blendMode:"custom",blendParameters:{srcRGB:1,dstRGB:0,srcAlpha:1,dstAlpha:0}}}),r||(c.processedTexture=I(c.processedTexture)),c.updateTexture(t);const[f,g]=c.getRasterTextureSize(r),y=f===N&&g===N,b=y?e.processorFbo:Ms(i,f,g);i.bindFramebuffer(b),i.setViewport(0,0,b.width,b.height),this._process(t,c,o);const T=Ar(t.context,f,g);if(b.copyToTexture(0,0,f,g,0,0,T),r)c.rasterTexture=T;else{const F=t.hasBranches?s.id:0;(l=c.functionTextures[F])==null||l.dispose(),c.functionTextures[F]=T}y||b.dispose(),t.timeline.end(this.name)}o==null||o.dispose(),i.bindFramebuffer(a),i.setViewport(n.x,n.y,n.width,n.height)}_getCommonConfig(t,e){var c;const{rasterFunction:s,hasBranches:i}=t,{raster:o,rasters:r}=s.parameters,a=i?(o==null?void 0:o.id)??((c=r==null?void 0:r.find(h=>h.name!=="Constant"))==null?void 0:c.id)??-1:0,n=e.functionTextures[a]??e.rasterTexture,l=s.name==="Reproject";return{texture:{texture:n,unit:0},srcImageSize:e.getRasterTextureSize(l)}}_getMultipleInputConfig(t,e){return e!=null&&e.length?e.length===2?{twoRasterConfig:this._getTwoInputConfig(e,t)}:e.length===3?{threeRasterConfig:this._getThreeInputConfig(e,t)}:{}:{}}_getConstantCount(t){return(t==null?void 0:t.filter(e=>e.name==="Constant").length)??0}_getTextures(t,e){return t.filter(s=>s.name!=="Constant").map(s=>s.id!=null&&s.name!=="Identity"?e.functionTextures[s.id]:e.rasterTexture)}_getTwoInputConfig(t,e){const s=this._getTextures(t,e),i=s[1]?{texture:s[1],unit:1}:void 0,o=t.findIndex(a=>a.name==="Constant"),r=o===0?new Float32Array([0,1,0,1,0,0,0,0,0]):new Float32Array([1,0,0,0,1,0,0,0,0]);return{image1:i,image1Const:o>-1?t[o].parameters.value:0,imageSwap:r}}_getThreeInputConfig(t,e){const s=this._getTextures(t,e);let i=0,o=0,r=new Float32Array([1,0,0,0,1,0,0,0,1]);const a=s[1]?{texture:s[1],unit:1}:void 0,n=s[2]?{texture:s[2],unit:2}:void 0,l=[];if(t.forEach((c,h)=>c.name==="Constant"&&l.push(h)),l.length===1)i=t[l[0]].parameters.value,r=l[0]===0?new Float32Array([0,1,0,0,0,1,1,0,0]):l[0]===1?new Float32Array([1,0,0,0,0,1,0,1,0]):new Float32Array([1,0,0,0,1,0,0,0,1]);else if(l.length===2){i=t[l[0]].parameters.value,o=t[l[1]].parameters.value;const c=t.findIndex(h=>h.name!=="Constant");r=c===0?new Float32Array([1,0,0,0,1,0,0,0,1]):c===1?new Float32Array([0,1,0,1,0,0,0,0,1]):new Float32Array([0,0,1,1,0,0,0,1,0])}return{image1:a,image2:n,image1Const:i,image2Const:o,imageSwap:r}}},Ns=class extends Ae{};u([Ve(0,_)],Ns.prototype,"position",void 0);class Kr extends Ge{}let Ht=class extends M{};u([m(D)],Ht.prototype,"texture",void 0),u([m(_)],Ht.prototype,"srcImageSize",void 0);let V=class extends Oe{vertex(t){return{uv:t.position,glPosition:new x(at(t.position),0,1)}}fragment(t){const e=new Be,s=ks(t.uv),i=this._process(s);return e.fragColor=new x(i.rgb,1).multiply(i.a),e}_getPixel(t){return Ds(t,this.config)}};u([m(Ht)],V.prototype,"config",void 0),u([J(0,K(Ns))],V.prototype,"vertex",null),u([J(0,K(Kr))],V.prototype,"fragment",null);let Ws=class extends M{};u([m(_)],Ws.prototype,"cellSize",void 0);let Zs=class extends V{constructor(){super(...arguments),this.type="AspectShader"}_process(t){const{texture:e}=this.config,s=lt(e,t,this.config.srcImageSize),i=new _(1).divide(this.aspectConfig.cellSize.multiply(8)),{x:o,y:r}=es(s,i),a=ke(r),n=s[9].multiply(E(j(o).add(j(a)))),l=j(E(o)),c=new d(3.14159265359),h=new d(0),p=O(h,a).multiply(.5).multiply(c).add(O(a,h).multiply(1.5).multiply(c)),f=vs(new d(2.5).multiply(c).add(Ft(a,ke(o))),new d(2).multiply(c)),g=W(p,f,l).multiply(180).divide(c);return new x(g,g,g,n)}};u([m(Ws)],Zs.prototype,"aspectConfig",void 0);let eo=class extends A{constructor(){super(...arguments),this.name="RasterAspectProcessor",this.type=3,this.shaders={aspect:new Zs}}_process(t,e){const s={cellSize:e.getRasterCellSize()},i=this._getCommonConfig(t,e),o={shader:this.shaders.aspect,uniforms:{config:i,aspectConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},Qs=class extends M{};u([m(we)],Qs.prototype,"bandIndexMat3",void 0);let Xs=class extends M{};u([m(w)],Xs.prototype,"adjustments",void 0);let Xe=class extends V{constructor(){super(...arguments),this.type="BandArithmeticShader",this.isOutputRounded=!1}_process(t){const e=this._getPixel(t),s=this.bandArithmeticConfig.bandIndexMat3.multiply(e.rgb),i=this._processIndex(s),o=new x(i,i,i,e.a);return this.isOutputRounded?Ue(o):o}_processIndex(t){var o;const{r:e,g:s}=t,i=(o=this.adjustmentConfig)==null?void 0:o.adjustments;switch(this.indexType){case"ndxi":{const r=e.subtract(s),a=e.add(s);return r.multiply(B(a))}case"sr":return e.multiply(B(s));case"ci":return e.multiply(B(s)).subtract(1);case"savi":{const{x:r}=i,a=e.subtract(s),n=e.add(s).add(r);return a.multiply(B(n)).multiply(r.add(1))}case"tsavi":{const{x:r,y:a,z:n}=i,l=n.multiply(r.multiply(r).add(1)).subtract(a.multiply(r)),c=r.multiply(e.subtract(r.multiply(s)).subtract(a)),h=a.multiply(e).add(s).add(l);return c.multiply(B(h))}case"msavi":{const r=e.multiply(2).add(1),a=r.multiply(r).subtract(e.subtract(s).multiply(8));return r.subtract(le(a)).multiply(.5)}case"gemi":{const r=e.multiply(e).subtract(s.multiply(s)).multiply(2).add(e.multiply(1.5)).add(s.multiply(.5)),a=e.add(s).add(.5),n=r.multiply(B(a)),l=n.multiply(De(n.multiply(.25))),c=s.subtract(.125).multiply(B(De(s)));return l.subtract(c)}case"pvi":{const{x:r,y:a}=i,n=le(r.multiply(r).add(1));return e.subtract(s.multiply(r)).subtract(a).multiply(B(n))}case"vari":{const r=t.g.subtract(t.r),a=t.g.add(t.r).subtract(t.b);return r.multiply(B(a))}case"rtvicore":return e.subtract(s).multiply(100).subtract(e.subtract(t.b).multiply(10));case"bai":{const r=ue(new d(.1).subtract(s),new d(2)),a=ue(new d(.06).subtract(e),new d(2));return B(r.add(a))}case"evi":{const r=t.b,a=e.add(s.multiply(6)).subtract(r.multiply(7.5)).add(1);return e.subtract(s).multiply(2.5).multiply(B(a))}case"wndwi":{const{r,g:a,b:n}=t,l=i.x,c=l.multiply(a),h=l.multiply(n),p=r.add(c).add(n).subtract(h);return r.subtract(c).subtract(n).add(h).multiply(B(p))}case"mtvi":{const r=t.b,a=ue(e.multiply(2).add(1),new d(2)),n=e.multiply(6).subtract(le(s).multiply(5)),l=le(a.subtract(n).subtract(.5)),c=e.subtract(r).multiply(1.2),h=s.subtract(r).multiply(2.5);return c.subtract(h).multiply(1.5).multiply(B(l))}default:return e}}};u([C],Xe.prototype,"indexType",void 0),u([C],Xe.prototype,"isOutputRounded",void 0),u([m(Qs)],Xe.prototype,"bandArithmeticConfig",void 0),u([he(Xs)],Xe.prototype,"adjustmentConfig",void 0);let to=class extends A{constructor(){super(...arguments),this.name="RasterBandArithmeticProcessor",this.type=4,this.shaders={bandArithmetic:new Xe}}_process(t,e){const s=t.rasterFunction.parameters,i={indexType:s.indexType,isOutputRounded:s.isOutputRounded},o={bandIndexMat3:s.bandIndexMat3},r=s.adjustments?{adjustments:[...s.adjustments]}:void 0,a=this._getCommonConfig(t,e),n={shader:this.shaders.bandArithmetic,uniforms:{config:a,bandArithmeticConfig:o,adjustmentConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=t;l.submitDrawMesh(c,n,l.quadMesh)}},Ys=class extends V{constructor(){super(...arguments),this.type="ColormapToRGBShader"}_process(t){const e=this._getPixel(t),s=nt(e,new d(1),this.colormapConfig,!1);return new x(s.xyz.multiply(255),s.a)}};u([m(de)],Ys.prototype,"colormapConfig",void 0);let so=class extends A{constructor(){super(...arguments),this.name="RasterColormapToRGBProcessor",this.type=5,this.shaders={colormapToRGB:new Ys}}_process(t,e,s){const i=t.rasterFunction.parameters,o={colormapTexture:{texture:s,unit:1},colormapOffset:i.offset,colormapMaxIndex:i.indexedColormap.length/4-1},r=this._getCommonConfig(t,e),a={shader:this.shaders.colormapToRGB,uniforms:{config:r,colormapConfig:o},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}},vt=class extends M{};u([m(D)],vt.prototype,"image1",void 0),u([m(d)],vt.prototype,"image1Const",void 0),u([m(we)],vt.prototype,"imageSwap",void 0);let Se=class extends M{};u([m(D)],Se.prototype,"image1",void 0),u([m(D)],Se.prototype,"image2",void 0),u([m(d)],Se.prototype,"image1Const",void 0),u([m(d)],Se.prototype,"image2Const",void 0),u([m(we)],Se.prototype,"imageSwap",void 0);const ts=t=>{const e=t;class s extends e{constructor(){super(...arguments),this.constantCount=0,this.imageCount=1}_getRasterValues(o){const{imageCount:r}=this;if(r===1){const a=z(this.config.texture,o);return{a:a.r,b:a.g,c:a.b,alpha:a.a}}if(r===2){const a=this._getTwoValues(o);return{a:a.a,b:a.b,c:a.b,alpha:a.alpha}}return this._getThreeValues(o)}_getTwoValues(o){const r=z(this.config.texture,o);if(this.constantCount===1){const{imageSwap:l,image1Const:c}=this.twoRasterConfig,h=l.multiply(new w(r.r,c,0));return{a:h.x,b:h.y,alpha:r.a}}const{image1:a}=this.twoRasterConfig,n=z(a,o);return{a:r.r,b:n.r,alpha:r.a.multiply(n.a)}}_getThreeValues(o){const r=z(this.config.texture,o),{imageSwap:a,image1:n,image2:l,image1Const:c,image2Const:h}=this.threeRasterConfig;if(this.constantCount===2){const g=a.multiply(new w(r.r,c,h));return{a:g.x,b:g.y,c:g.z,alpha:r.a}}if(this.constantCount===1){const g=z(n,o),y=a.multiply(new w(r.r,g.r,c));return{a:y.x,b:y.y,c:y.z,alpha:r.a.multiply(g.a)}}const p=z(n,o),f=z(l,o);return{a:r.r,b:p.r,c:f.r,alpha:r.a.multiply(p.a).multiply(f.a)}}}return u([C],s.prototype,"constantCount",void 0),u([C],s.prototype,"imageCount",void 0),u([he(vt)],s.prototype,"twoRasterConfig",void 0),u([he(Se)],s.prototype,"threeRasterConfig",void 0),s};let io=class extends ts(V){constructor(){super(...arguments),this.type="CompositeBandShader"}_process(t){const{a:e,b:s,c:i,alpha:o}=this._getRasterValues(t);return new x(e,s,i,o)}},ro=class extends A{constructor(){super(...arguments),this.name="RasterCompositeBandProcessor",this.type=6,this.shaders={compositeBand:new io}}_process(t,e){const{rasters:s}=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s),imageCount:(s==null?void 0:s.length)??1},o=this._getMultipleInputConfig(e,s),r=this._getCommonConfig(t,e),a={shader:this.shaders.compositeBand,uniforms:{config:r,...o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class ss extends M{}u([m(_)],ss.prototype,"domainRange",void 0);class Ct extends ts(V){constructor(){super(...arguments),this.type="LocalShader",this.isOutputRounded=!1}_process(e){if(this.operationName==="conditional")return this._conditional(e);const{a:s,b:i,alpha:o}=this._getRasterValues(e),{value:r,alpha:a}=this._compute(s,i,o);return this._processResult(r,a)}_processResult(e,s){const i=js(e,this.domainRangeConfig.domainRange),o=new x(e,e,e,s).multiply(i);return this.isOutputRounded?Ue(o):o}_compute(e,s,i){const{operationName:o}=this;let r;switch(o){case"plus":r=e.add(s);break;case"minus":r=e.subtract(s);break;case"times":r=e.multiply(s);break;case"divide":case"floatdivide":r=e.multiply(B(s)),i=i.multiply($(j(E(s))));break;case"floordivide":r=ce(e.multiply(B(s))),i=i.multiply($(j(E(s))));break;case"square":r=e.multiply(e);break;case"sqrt":r=le(e);break;case"power":r=ue(e,s);break;case"ln":r=Q(ge(e,new d(0)),ar(e),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"log10":r=Q(ge(e,new d(0)),Vt(e).multiply(B(Vt(new d(10)))),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"log2":r=Q(ge(e,new d(0)),Vt(e),new d(0)),i=i.multiply(this._isAboveZero(e));break;case"exp":r=or(e);break;case"exp10":r=ue(new d(10),e);break;case"exp2":r=ue(new d(2),e);break;case"rounddown":r=ce(e);break;case"roundup":r=rr(e);break;case"int":r=E(e).multiply(ce(j(e)));break;case"mod":r=vs(e,s);break;case"negate":r=ke(e);break;case"abs":r=j(e);break;case"acos":{const a=this._isAbsBiggerThanOne(e);r=Q(a,new d(0),ir(e)),i=Q(a,new d(0),i);break}case"acosh":r=sr(e);break;case"asin":{const a=this._isAbsBiggerThanOne(e);r=Q(a,new d(0),tr(e)),i=Q(a,new d(0),i);break}case"asinh":r=er(e);break;case"atan":r=Ft(e);break;case"atanh":{const a=this._isAbsBiggerThanOne(e);r=Q(a,new d(0),Ki(e)),i=Q(a,new d(0),i);break}case"atan2":r=Ft(e,s);break;case"cos":r=Ji(e);break;case"cosh":r=Yi(e);break;case"sin":r=Xi(e);break;case"sinh":r=Qi(e);break;case"tan":r=Zi(e);break;case"tanh":r=Wi(e);break;case"bitwiseand":r=new d(Ni(new S(e),new S(s)));break;case"bitwiseor":r=new d(Hi(new S(e),new S(s)));break;case"bitwiseleftshift":r=new d($i(new S(e),new S(s)));break;case"bitwiserightshift":r=new d(Ei(new S(e),new S(s)));break;case"bitwisenot":r=new d(ji(new S(e)));break;case"bitwisexor":r=new d(Li(new S(e),new S(s)));break;case"booleanand":r=$(qi(me(e,new d(0)),me(s,new d(0))));break;case"booleanor":r=$(Ui(me(e,new d(0)),me(s,new d(0))));break;case"booleannot":r=$(ze(e,new d(0)));break;case"booleanxor":r=$(Gi(me(e,new d(0)),me(s,new d(0))));break;case"greaterthan":r=$(ge(e,s));break;case"greaterthanequal":r=$(Ai(e,s));break;case"lessthan":r=$(jt(e,s));break;case"lessthanequal":r=$(Cs(e,s));break;case"equalto":r=$(ze(e,s));break;case"notequal":r=$(me(e,s));break;case"isnull":r=$(ze(i,new d(0))),i=new d(1);break;case"setnull":{const a=$(ze(e,new d(0)));r=a.multiply(s),i=i.multiply(a);break}default:r=e}return{value:r,alpha:i}}_conditional(e){const{a:s,b:i,c:o,alpha:r}=this._getRasterValues(e),a=new d(j(E(s))),n=W(o,i,a);return this._processResult(n,r)}_isAboveZero(e){return $(ge(e,new d(0)))}_isAbsBiggerThanOne(e){return ge(j(e),new d(1))}}u([C],Ct.prototype,"operationName",void 0),u([C],Ct.prototype,"isOutputRounded",void 0),u([m(ss)],Ct.prototype,"domainRangeConfig",void 0);let Rt=class extends ts(V){constructor(){super(...arguments),this.type="ComputeChangeShader",this.isOutputRounded=!1}_process(t){const{a:e,b:s,alpha:i}=this._getRasterValues(t);let o=e.subtract(s);this.method==="relative-difference"&&(o=o.multiply(B(ot(j(e),j(s)))));const r=js(o,this.domainRangeConfig.domainRange),a=new x(o,o,o,i).multiply(r);return this.isOutputRounded?Ue(a):a}};u([C],Rt.prototype,"method",void 0),u([C],Rt.prototype,"isOutputRounded",void 0),u([m(ss)],Rt.prototype,"domainRangeConfig",void 0);let oo=class extends A{constructor(){super(...arguments),this.name="RasterComputeChangeProcessor",this.type=7,this.shaders={computeChange:new Rt}}_process(t,e){const s=t.rasterFunction.parameters,{rasters:i}=s,o={constantCount:this._getConstantCount(i),imageCount:i.length,method:s.method,isOutputRounded:s.isOutputRounded},r={domainRange:s.domainRange},{twoRasterConfig:a}=this._getMultipleInputConfig(e,i),n=this._getCommonConfig(t,e),l={shader:this.shaders.computeChange,uniforms:{config:n,domainRangeConfig:r,twoRasterConfig:a},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}},Nt=class extends M{};u([m(d)],Nt.prototype,"contrastOffset",void 0),u([m(d)],Nt.prototype,"brightnessOffset",void 0);let Js=class extends V{constructor(){super(...arguments),this.type="ContrastBrightnessShader"}_process(t){const{rgb:e,a:s}=this._getPixel(t),{contrastOffset:i,brightnessOffset:o}=this.contrastBrightnessConfig,r=new d(255),a=new d(128),n=e.multiply(200),l=r.multiply(100),c=r.multiply(2).multiply(o),h=n.subtract(l).add(c),p=Bi([ze(i,new d(-100)),new w(a)],[ze(i,new d(100)),E(h).add(1).divide(2).multiply(r)],[ge(i,new d(0)),h.divide(new d(100).subtract(i).multiply(2)).add(a)],[!0,h.multiply(i.add(100)).divide(2e4).add(a)]);return Ue(new x(p,s))}};u([m(Nt)],Js.prototype,"contrastBrightnessConfig",void 0);let ao=class extends A{constructor(){super(...arguments),this.name="RasterContrastBrightnessProcessor",this.type=8,this.shaders={contrastBrightness:new Js}}_process(t,e){const s=this._getCommonConfig(t,e),i=t.rasterFunction.parameters,o={shader:this.shaders.contrastBrightness,uniforms:{config:s,contrastBrightnessConfig:i},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}};class Wt extends M{}u([m(lr.ofType(d,5,5,!0))],Wt.prototype,"kernel",void 0),u([m(_)],Wt.prototype,"clampRange",void 0);let St=class extends V{constructor(){super(...arguments),this.type="ConvolutionShader",this.rows=3,this.cols=3}_process(t){const{rows:e,cols:s}=this,i=new _(Math.floor(e/2),Math.floor(s/2)),{texture:o,srcImageSize:r}=this.config,a=new d(1).divide(r),{kernel:n}=this.convolutionConfig,l=Vi(n,{initialValue:new x(0,0,0,1),xRange:[0,e],yRange:[0,s],callback:(h,p,f,g)=>{const y=new _(new d(f),new d(g)).subtract(i).multiply(a),b=z(o,H(t.add(y))),T=b.rgb.multiply(p).add(h.rgb),F=b.a.multiply(h.a);return new x(T,F)}}),{clampRange:c}=this.convolutionConfig;return new x(ie(l.rgb,c.x,c.y),1).multiply(l.a)}};u([C],St.prototype,"rows",void 0),u([C],St.prototype,"cols",void 0),u([m(Wt)],St.prototype,"convolutionConfig",void 0);let no=class extends A{constructor(){super(...arguments),this.name="RasterConvolutionProcessor",this.type=9,this.shaders={convolution:new St}}_process(t,e){const s=t.rasterFunction.parameters,i={rows:s.kernelRows,cols:s.kernelCols},o={kernel:[...s.kernel],clampRange:s.clampRange},r=this._getCommonConfig(t,e),a={shader:this.shaders.convolution,uniforms:{config:r,convolutionConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}},Ks=class extends M{};u([m(d)],Ks.prototype,"zlFactor",void 0);let Zt=class extends V{constructor(){super(...arguments),this.type="CurvatureShader"}_process(t){const{texture:e}=this.config,s=lt(e,t,this.config.srcImageSize),i=s[3].add(s[5]).multiply(.5).subtract(s[4]),o=s[1].add(s[7]).multiply(.5).subtract(s[4]),{zlFactor:r}=this.curvatureConfig,{curvatureType:a}=this;let n;if(a==="standard")n=ke(r).multiply(i.add(o));else{const l=s[2].subtract(s[0]).add(s[6]).subtract(s[8]).divide(4),c=s[5].subtract(s[3]).divide(2),h=s[1].subtract(s[7]).divide(2),p=c.multiply(c),f=h.multiply(h),g=c.multiply(h),y=r.divide(p.add(f));n=a==="profile"?Z(new w(i,o,l),new w(p,f,g)).multiply(y):Z(new w(i,o,ke(l)),new w(f,p,g)).multiply(ke(y))}return new x(n,n,n,s[9])}};u([C],Zt.prototype,"curvatureType",void 0),u([m(Ks)],Zt.prototype,"curvatureConfig",void 0);let lo=class extends A{constructor(){super(...arguments),this.name="RasterCurvatureProcessor",this.type=10,this.shaders={curvature:new Zt}}_process(t,e){const s=t.rasterFunction.parameters,i={curvatureType:s.curvatureType},o=e.getRasterCellSize(),r={zlFactor:200*s.zFactor/o[0]/o[1]},a=this._getCommonConfig(t,e),n={shader:this.shaders.curvature,uniforms:{config:a,curvatureConfig:r},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=t;l.submitDrawMesh(c,n,l.quadMesh)}},ei=class extends M{};u([m(we)],ei.prototype,"bandIndexMat3",void 0);let ti=class extends V{constructor(){super(...arguments),this.type="ExtractBandShader"}_process(t){const e=this._getPixel(t),s=this.extractBandConfig.bandIndexMat3.multiply(e.rgb);return new x(s,e.a)}};u([m(ei)],ti.prototype,"extractBandConfig",void 0);let uo=class extends A{constructor(){super(...arguments),this.name="RasterExtractBandProcessor",this.type=11,this.shaders={extractBand:new ti}}_process(t,e){const s={bandIndexMat3:t.rasterFunction.parameters.bandIndexMat3},i=this._getCommonConfig(t,e),o={shader:this.shaders.extractBand,uniforms:{config:i,extractBandConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},si=class extends M{};u([m(_)],si.prototype,"clampRange",void 0);class Pe extends V{constructor(){super(...arguments),this.type="FocalStatisticsShader",this.rows=3,this.cols=3,this.fill=!1}_process(e){const s=this._process1(e),i=O(new d(1),s.a);if(!this.fill)return this._clamp(s.rgb,i);const o=this._getPixel(e),r=W(s.rgb,o.rgb,o.a);return this._clamp(r,i)}_clamp(e,s){const{clampRange:i}=this.focalStatisticsConfig;return new x(ie(e,i.x,i.y),1).multiply(s)}_process1(e){const{texture:s,srcImageSize:i}=this.config,{rows:o,cols:r}=this,a=new _(Math.floor(o/2),Math.floor(r/2)),n=new d(1).divide(i),l=this._getPixel(e),{statisticsType:c}=this,h=c==="min"||c==="max"?new x(l.rgb,0):new x(0,0,0,0);switch(c){case"min":return this._stat(o,r,h,(p,f,g)=>{const y=new _(new d(f),new d(g)).subtract(a).multiply(n),b=z(s,H(e.add(y))),T=st(p.rgb,b.rgb);return new x(T,p.a.add(b.a))});case"max":return this._stat(o,r,h,(p,f,g)=>{const y=new _(new d(f),new d(g)).subtract(a).multiply(n),b=z(s,H(e.add(y))),T=ot(p.rgb,b.rgb);return new x(T,p.a.add(b.a))});case"mean":{const p=this._stat(o,r,h,(g,y,b)=>{const T=new _(new d(y),new d(b)).subtract(a).multiply(n),F=z(s,H(e.add(T))),R=g.rgb.add(F.rgb.multiply(F.a));return new x(R,g.a.add(F.a))}),f=p.rgb.multiply(B(p.a));return new x(f,p.a)}case"stddev":{const p=this._stat(o,r,h,(b,T,F)=>{const R=new _(new d(T),new d(F)).subtract(a).multiply(n),q=z(s,H(e.add(R))),X=b.rgb.add(q.rgb.multiply(q.a));return new x(X,b.a.add(q.a))}),f=this._stat(o,r,h,(b,T,F)=>{const R=new _(new d(T),new d(F)).subtract(a).multiply(n),q=z(s,H(e.add(R))),X=b.rgb.add(q.a.multiply(q.rgb).multiply(q.rgb));return new x(X,b.a.add(q.a))}),g=B(f.a),y=le(f.subtract(p.multiply(p).multiply(g)).multiply(g));return new x(y.rgb,p.a)}default:return l}}_stat(e=3,s=3,i,o){const r=new S(0).setMutable().setDebugName("StatColIterator"),a=new S(0).setMutable().setDebugName("StatRowIterator"),n=i.setMutable().setDebugName("StatAccumulator"),l=o(n,r,a).setDebugName("StatPredicate");return nr({iterX:r,iterY:a,accumulator:n},x,l,({out:c,iterX:h,iterY:p,accumulator:f,subgraph:g})=>`
  for (${p} = 0; ${p} < ${e}; ${p}++) {
    for (${h} = 0; ${h} < ${s}; ${h}++) {
  
    ${g.body}
  
    ${f} = ${g.varName};
    }
  }
  ${c} = ${f};
  `).setDebugName("statBody")}}u([C],Pe.prototype,"rows",void 0),u([C],Pe.prototype,"cols",void 0),u([C],Pe.prototype,"statisticsType",void 0),u([C],Pe.prototype,"fill",void 0),u([m(si)],Pe.prototype,"focalStatisticsConfig",void 0);class co extends A{constructor(){super(...arguments),this.name="RasterFocalStatisticsProcessor",this.type=21,this.shaders={focalStatistics:new Pe}}_process(e,s){const i=e.rasterFunction.parameters,o={rows:i.kernelRows,cols:i.kernelCols,statisticsType:i.statisticsType,fill:i.fillNoDataOnly},r={clampRange:i.clampRange},a=this._getCommonConfig(e,s),n={shader:this.shaders.focalStatistics,uniforms:{config:a,focalStatisticsConfig:r},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}class ii extends M{}u([m(w)],ii.prototype,"weights",void 0);let ri=class extends V{constructor(){super(...arguments),this.type="GrayscaleShader"}_process(t){const e=this._getPixel(t),{weights:s}=this.grayscaleConfig,i=Z(s,e.rgb);return new x(i,i,i,e.a)}};u([m(ii)],ri.prototype,"grayscaleConfig",void 0);let ho=class extends A{constructor(){super(...arguments),this.name="RasterGrayscaleProcessor",this.type=12,this.shaders={grayscale:new ri}}_process(t,e){const s={weights:t.rasterFunction.parameters.weights},i=this._getCommonConfig(t,e),o={shader:this.shaders.grayscale,uniforms:{config:i,grayscaleConfig:s},defines:{},optionalAttributes:null,useComputeBuffer:!1},{painter:r,context:a}=t;r.submitDrawMesh(a,o,r.quadMesh)}},It=class extends V{constructor(){super(...arguments),this.type="HillshadeShader",this.isMultidirectional=!1}_process(t){const{texture:e}=this.config,s=lt(e,t,this.config.srcImageSize),i=qs(s,this.hillshadeConfig,this.isMultidirectional);return new x(i.rgb.multiply(255),i.a)}};u([C],It.prototype,"isMultidirectional",void 0),u([m(ae)],It.prototype,"hillshadeConfig",void 0);let po=class extends A{constructor(){super(...arguments),this.name="RasterHillshadeProcessor",this.type=13,this.shaders={hillshade:new It}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultidirectional:s.hillshadeType>0},o=e.getRasterCellSize(),r=Ls(s,o),a={...s,factor:r,minValue:0,maxValue:8e3},n=this._getCommonConfig(t,e),l={shader:this.shaders.hillshade,uniforms:{config:n,hillshadeConfig:a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}},mo=class extends A{constructor(){super(...arguments),this.name="RasterLocalProcessor",this.type=14,this.shaders={local:new Ct}}_process(t,e){var p;const s=t.rasterFunction.parameters,i={constantCount:this._getConstantCount(s.rasters),imageCount:s.imageCount,operationName:s.operationName,isOutputRounded:s.isOutputRounded},o={domainRange:s.domainRange},r=s.operationName==="conditional"?s.rasters:(p=s.rasters)==null?void 0:p.slice(0,2),a=this._getMultipleInputConfig(e,r),n=this._getCommonConfig(t,e),l={shader:this.shaders.local,uniforms:{config:n,domainRangeConfig:o,...a},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:c,context:h}=t;c.submitDrawMesh(h,l,c.quadMesh)}};class Qt extends M{}u([m(te.ofType(d,6))],Qt.prototype,"includedRanges",void 0),u([m(te.ofType(d,se))],Qt.prototype,"noDataValues",void 0);let Xt=class extends V{constructor(){super(...arguments),this.type="MaskShader",this.isMultiband=!0}_process(t){const e=this._getPixel(t),s=this._computeNoDataFactor(e.r),i=this._computeRangeFactor(e.rgb);let o;if(this.isMultiband){const r=this._computeNoDataFactor(e.g),a=this._computeNoDataFactor(e.b),n=new w(s,r,a).multiply(i);o=n.x.multiply(n.y).multiply(n.z)}else o=s.multiply(i.x);return e.multiply(o)}_computeNoDataFactor(t){const{noDataValues:e}=this.maskConfig;let s=new w(1);for(let i=0;i<se/3;i++){const o=3*i,r=new w(e[o+0],e[o+1],e[o+2]),a=j(E(r.subtract(t)));s=s.multiply(a)}return s.x.multiply(s.y).multiply(s.z)}_computeRangeFactor(t){const{includedRanges:e}=this.maskConfig,s=new w(e[0],e[2],e[4]),i=new w(e[1],e[3],e[5]);return O(s,t).multiply(O(t,i))}};u([C],Xt.prototype,"isMultiband",void 0),u([m(Qt)],Xt.prototype,"maskConfig",void 0);let fo=class extends A{constructor(){super(...arguments),this.name="RasterMaskProcessor",this.type=15,this.shaders={mask:new Xt}}_process(t,e){const s=t.rasterFunction.parameters,i={isMultiband:s.bandCount>1},o={includedRanges:[...s.includedRanges],noDataValues:[...s.noDataValues]},r=this._getCommonConfig(t,e),a={shader:this.shaders.mask,uniforms:{config:r,maskConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class oi extends M{}u([m(we)],oi.prototype,"bandIndexMat3",void 0);class Yt extends V{constructor(){super(...arguments),this.type="NDVIShader",this.scaled=!0}_process(e){const s=this._getPixel(e),{r:i,g:o}=this.ndviConfig.bandIndexMat3.multiply(s.rgb),r=i.subtract(o),a=i.add(o),n=r.multiply(B(a));if(!this.scaled)return new x(n,n,n,s.a);const l=ce(n.multiply(100).add(100.5));return new x(l,l,l,s.a)}}u([C],Yt.prototype,"scaled",void 0),u([m(oi)],Yt.prototype,"ndviConfig",void 0);let go=class extends A{constructor(){super(...arguments),this.name="RasterNDVIProcessor",this.type=16,this.shaders={ndvi:new Yt}}_process(t,e){const s=t.rasterFunction.parameters,i={scaled:s.scaled},o={bandIndexMat3:s.bandIndexMat3},r=this._getCommonConfig(t,e),a={shader:this.shaders.ndvi,uniforms:{config:r,ndviConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class Fe extends M{}u([m(te.ofType(d,3*se))],Fe.prototype,"rangeMaps",void 0),u([m(te.ofType(d,2*se))],Fe.prototype,"noDataRanges",void 0),u([m(d)],Fe.prototype,"unmatchMask",void 0),u([m(d)],Fe.prototype,"replacementValue",void 0),u([m(_)],Fe.prototype,"clampRange",void 0);class Jt extends V{constructor(){super(...arguments),this.type="RemapShader"}_process(e){const s=this._getPixel(e),{rangeMaps:i,unmatchMask:o,clampRange:r,replacementValue:a}=this.remapConfig,{mapValue:n,includeMask:l}=Nr(s.r,i,se),c=this.replaceUnmatched?a:o.multiply(s.r),h=W(c,n,l),p=ie(h,r.x,r.y),f=this._computeNoDataFactor(s.rrr).multiply(ot(o,l));return new x(p,p,p,s.a).multiply(f)}_computeNoDataFactor(e){const{noDataRanges:s}=this.remapConfig;let i=new w(0,0,0);for(let o=0;o<se/3;o++){const r=6*o,a=new w(s[r],s[r+2],s[r+4]),n=new w(s[r+1],s[r+3],s[r+5]);i=i.add(O(a,e).multiply(O(e,n)))}return De(E(Z(i,new w(1,1,1))))}}u([m(Fe)],Jt.prototype,"remapConfig",void 0),u([C],Jt.prototype,"replaceUnmatched",void 0);class yo extends A{constructor(){super(...arguments),this.name="RasterRemapProcessor",this.type=17,this.shaders={remap:new Jt}}_process(e,s){const i=e.rasterFunction.parameters,o={replaceUnmatched:i.allowUnmatched&&i.replacementValue!=null},r={rangeMaps:[...i.rangeMaps],noDataRanges:[...i.noDataRanges],unmatchMask:i.allowUnmatched?1:0,replacementValue:i.replacementValue??0,clampRange:i.clampRange},a=this._getCommonConfig(e,s),n={shader:this.shaders.remap,uniforms:{config:a,remapConfig:r},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:l,context:c}=e;l.submitDrawMesh(c,n,l.quadMesh)}}let xo=class extends U{constructor(){super(...arguments),this.type="ReprojectShader"}_colorize(t){return this._getPixel(t)}},bo=class extends A{constructor(){super(...arguments),this.name="RasterReprojectProcessor",this.type=18,this.shaders={reproject:new xo}}_process(t,e){const s=t.rasterFunction.parameters,i=this._getInterpolationDefines(e.interpolation,!!s.requireNNEdge),{config:o,projectionConfig:r,projectionDefines:a}=this._getReprojectConfig(e),n={shader:this.shaders.reproject,uniforms:{config:o,projectionConfig:r},defines:{...a,...i,applyPixelMask:!1,applyPixelHighlights:!1},optionalAttributes:null,useComputeBuffer:!1},{interpolation:l}=e;e.interpolation="nearest";const{painter:c,context:h}=t;c.submitDrawMesh(h,n,c.quadMesh),e.interpolation=l,e.projected=!0}_getReprojectConfig(t){const{source:e}=t,{names:s,textures:i}=t.getTextures({forProcessing:!0}),o={texture:{texture:i[s.indexOf("u_image")],unit:0},dvsMat3:new Float32Array([2,0,0,0,2,0,-1,-1,0]),coordScale:[1,1],srcImageSize:[e.width,e.height],opacity:1},r=i[s.indexOf("u_transformGrid")],{transformGrid:a}=t,n=!(!r||!a);return{config:o,projectionConfig:n?{transformTexture:{texture:r,unit:1},targetImageSize:[t.width,t.height],transformSpacing:a.spacing,transformGridSize:a.size}:void 0,projectionDefines:{applyProjection:n,lookupProjection:n&&a.spacing[0]===1}}}_getInterpolationDefines(t,e){const s=t==="bilinear"&&e;return{bilinear:s,bicubic:t==="cubic",nearestOnEdge:s}}};class ai extends It{constructor(){super(...arguments),this.type="ShadedReliefShader"}_process(e){const s=super._process(e),{minValue:i,maxValue:o}=this.hillshadeConfig,r=this._getPixel(e),a=o.subtract(i),n=r.r.subtract(i),l=ie(n.divide(a),new d(0),new d(1)),c=nt(new x(l,l,l,1),new d(255),this.colormapConfig),h=Gs(c.xyz),p=Us(new w(h.xy,s.x.divide(255))).multiply(255);return new x(p,c.a.multiply(s.a))}}u([m(de)],ai.prototype,"colormapConfig",void 0);let wo=class extends A{constructor(){super(...arguments),this.name="RasterShadedReliefProcessor",this.type=19,this.shaders={shadedRelief:new ai}}_process(t,e,s){const i=t.rasterFunction.parameters,o={isMultidirectional:i.hillshadeType>0},r=e.getRasterCellSize(),a=Ls(i,r),n={...i,factor:a},l={colormapTexture:{texture:s,unit:1},colormapOffset:i.offset,colormapMaxIndex:i.indexedColormap.length/4-1},c=this._getCommonConfig(t,e),h={shader:this.shaders.shadedRelief,uniforms:{config:c,hillshadeConfig:n,colormapConfig:l},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:p,context:f}=t;p.submitDrawMesh(f,h,p.quadMesh)}},Ye=class extends M{};u([m(d)],Ye.prototype,"pixelSizePower",void 0),u([m(d)],Ye.prototype,"pixelSizeFactor",void 0),u([m(d)],Ye.prototype,"zFactor",void 0),u([m(_)],Ye.prototype,"cellSize",void 0);let Pt=class extends V{constructor(){super(...arguments),this.type="SlopeShader",this.isOutputRounded=!1,this.percentRise=!1}_process(t){const{cellSize:e,pixelSizePower:s,pixelSizeFactor:i,zFactor:o}=this.slopeConfig,r=ue(e,new _(s)).multiply(i).add(o).divide(e.multiply(8)),{texture:a}=this.config,n=lt(a,t,this.config.srcImageSize),{x:l,y:c}=es(n,r),h=le(l.multiply(l).add(c.multiply(c))),p=this.percentRise?h.multiply(100):Ft(h).multiply(57.2957795),f=new x(p,p,p,n[9]);return this.isOutputRounded?Ue(f):f}};u([C],Pt.prototype,"isOutputRounded",void 0),u([C],Pt.prototype,"percentRise",void 0),u([m(Ye)],Pt.prototype,"slopeConfig",void 0);let _o=class extends A{constructor(){super(...arguments),this.name="RasterSlopeProcessor",this.type=20,this.shaders={slope:new Pt}}_process(t,e){const s=t.rasterFunction.parameters,i={isOutputRounded:s.isOutputRounded,percentRise:s.slopeType==="percent-rise"},o={cellSize:e.getRasterCellSize(),pixelSizePower:s.slopeType==="adjusted"?s.pixelSizePower:0,pixelSizeFactor:s.slopeType==="adjusted"?s.pixelSizeFactor:0,zFactor:s.zFactor},r=this._getCommonConfig(t,e),a={shader:this.shaders.slope,uniforms:{config:r,slopeConfig:o},defines:i,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=t;n.submitDrawMesh(l,a,n.quadMesh)}};class Je extends V{constructor(){super(...arguments),this.type="StretchShader",this.isMultiband=!0,this.isOutputRounded=!1,this.useGamma=!1}_process(e){const s=this._getPixel(e);let i=Hs(s,this.stretchConfig,this.useGamma,1);return this.isMultiband||(i=new x(i.rrr,i.a)),this.isOutputRounded?Ue(i):i}}u([C],Je.prototype,"isMultiband",void 0),u([C],Je.prototype,"isOutputRounded",void 0),u([C],Je.prototype,"useGamma",void 0),u([m(ne)],Je.prototype,"stretchConfig",void 0);class To extends A{constructor(){super(...arguments),this.name="RasterStretchProcessor",this.type=22,this.shaders={stretch:new Je}}_process(e,s){const i=e.rasterFunction.parameters,o={isMultiband:i.bandCount>1,isOutputRounded:i.isOutputRounded,useGamma:i.useGamma},r=this._getCommonConfig(e,s),a={shader:this.shaders.stretch,uniforms:{config:r,stretchConfig:i},defines:o,optionalAttributes:null,useComputeBuffer:!1},{painter:n,context:l}=e;n.submitDrawMesh(l,a,n.quadMesh)}}const vo=new Map([["Aspect",eo],["BandArithmetic",to],["ColormapToRGB",so],["CompositeBand",ro],["ComputeChange",oo],["ContrastBrightness",ao],["Convolution",no],["Curvature",lo],["ExtractBand",uo],["Grayscale",ho],["Hillshade",po],["Local",mo],["Mask",fo],["NDVI",go],["Remap",yo],["Reproject",bo],["ShadedRelief",wo],["Slope",_o],["Statistics",co],["Stretch",To]]);class Co extends rt{constructor(){super(...arguments),this.type=1,this.shaders={},this._techniques=new Map}shutdown(e){var s;super.shutdown(e),(s=this._fbo)==null||s.dispose(),this._fbo=void 0;for(const i of this._techniques.values())i.shutdown();this._techniques.clear()}render(e,s){this._fbo??(this._fbo=Ms(e.context,N,N));let{name:i}=e.rasterFunction;if(i==="Arithmetic"&&(i="Local"),!this._techniques.has(i)){const o=vo.get(i);if(!o)return;this._techniques.set(i,new o)}this._techniques.get(i).render(e,{...s,processorFbo:this._fbo})}}class Ro extends Ts{constructor(){super(...arguments),this.isCustomTilingScheme=!1}get pixelHighlights(){return this._pixelHighlights}set pixelHighlights(e){this._pixelHighlights=e,this.children.forEach(({bitmap:s})=>s.highlightTexture=null),this.requestRender()}createTile(e){const s=this._getTileBounds(e),[i,o]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new zr(e,r,s[0],s[3],i,o)}onAttach(){super.onAttach(),this._colorizerTechnique=new Xr,this._processorTechnique=new Co,this._highlightTechnique=new Jr}onDetach(){var e,s,i;super.onDetach(),(e=this._colorizerTechnique)==null||e.shutdown(),this._colorizerTechnique=void 0,(s=this._processorTechnique)==null||s.shutdown(),this._processorTechnique=void 0,(i=this._highlightTechnique)==null||i.shutdown(),this._highlightTechnique=void 0}doRender(e){var o,r;if(!this.visible||e.drawPhase!==1||!this._colorizerTechnique)return;const{rasterFunctionChain:s}=this;if((o=s==null?void 0:s.functions)!=null&&o.length){if(!this._processorTechnique)return;const{functions:a,hasBranches:n}=s;for(const l of a){if(l.name==="Constant"||l.name==="Identity")continue;e.rasterFunction=l,e.hasBranches=n,super.doRender(e);const c=this.children.map(h=>h.bitmap);this._processorTechnique.render(e,{bitmaps:c})}}if((r=this._pixelHighlights)!=null&&r.length&&this._highlightTechnique)for(const a of this._pixelHighlights){e.pixelHighlightOptions=a,super.doRender(e);const n=this.children.map(l=>l.bitmap);this._highlightTechnique.render(e,{bitmaps:n})}e.rasterFunction=null,e.pixelHighlightOptions=void 0,super.doRender(e);const i=this.children.map(a=>a.bitmap);this._colorizerTechnique.render(e,{bitmaps:i})}_getTileBounds(e){const s=this.tileInfoView.getTileBounds(ys(),e);if(this.isCustomTilingScheme&&e.world){const{tileInfo:i}=this.tileInfoView,o=Ii(i.spatialReference);if(o){const r=i.lodAt(e.level);if(!r)return s;const{resolution:a}=r,n=a*i.size[0];s[0]=o*e.world+i.origin.x+e.col*n,s[2]=s[0]+n}}return s}}const So=[0,0];let G=class extends pi{constructor(){super(...arguments),this._updatingHandles=new cr,this._emptyTilePixelBlock=null,this._tileStrategy=null,this._tileInfoView=null,this._fetchQueue=null,this._blockCacheRegistryUrl=null,this._blockCacheRegistryId=null,this._srcResolutions=[],this.previousLOD=null,this._needBlockCacheUpdate=!1,this._globalSymbolizerParams=null,this._symbolizerParams=null,this._abortController=null,this._isCustomTilingScheme=!1,this._maxIndexedColormapSize=0,this._rasterFunctionState="na",this._globalUpdateRequested=!1,this.attached=!1,this.timeExtent=null,this.redrawOrRefetch=di(async(t={})=>{const e=this._rasterFunctionState,s=t.reprocess||e==="gpu"&&!this.canUseWebGLForProcessing||e==="cpu"&&this.canUseWebGLForProcessing;if(s&&(await this._updatingHandles.addPromise(this.layer.updateRasterFunction()),this.updateRasterFunctionParameters()),!this.previousLOD||this.layerView.suspended)return;const i=this._rasterFunctionState,{type:o}=this;return t.refetch||o!=="raster"&&s||i==="cpu"||e==="cpu"?this._updatingHandles.addPromise(this.doRefresh()):this._updatingHandles.addPromise(this._redrawImage(t.signal))})}destroy(){this._updatingHandles.destroy()}get canUseWebGLForProcessing(){return!1}get canUseLocalSymbolizerParams(){return(this.canUseWebGLForProcessing||this.type==="rasterVF")&&!this.layerView.hasTilingEffects}get isCPUBasedDRA(){const{renderer:t}=this.layer;return(t==null?void 0:t.type)==="raster-stretch"&&t.dynamicRangeAdjustment&&(!this.canUseWebGLForProcessing||!(t.stretchType==="min-max"||t.stretchType==="standard-deviation"))}get useWebGLForProcessing(){return this._get("useWebGLForProcessing")??!0}set useWebGLForProcessing(t){this._set("useWebGLForProcessing",t)}get useProgressiveUpdate(){return this._get("useProgressiveUpdate")??!0}set useProgressiveUpdate(t){if(this._tileStrategy&&this.useProgressiveUpdate!==t){this._tileStrategy.destroy(),this.container.removeAllChildren();const e=this._getCacheSize(t);this._tileStrategy=new ds({cachePolicy:"purge",acquireTile:s=>this.acquireTile(s),releaseTile:s=>this.releaseTile(s),cacheSize:e,tileInfoView:this._tileInfoView}),this._set("useProgressiveUpdate",t),this.layerView.requestUpdate()}}update(t){var r;this._fetchQueue.pause(),this._fetchQueue.state=t.state,this._tileStrategy.update(t),this._fetchQueue.resume();const{extent:e,resolution:s,scale:i}=t.state,o=this._tileInfoView.getClosestInfoForScale(i);if(this.layer.raster){if(!this.useProgressiveUpdate||this._needBlockCacheUpdate){const a=this._srcResolutions[o.level],n="toJSON"in e?e:mi.fromJSON(e);cs(this._blockCacheRegistryUrl,this._blockCacheRegistryId,n,s,a,this.layer.raster.ioConfig.sampling)}this._needBlockCacheUpdate=!1,((r=this.previousLOD)==null?void 0:r.level)!==o.level&&(this.previousLOD=o,this._symbolizerParams!=null&&this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._tileStrategy.updateCacheSize(0))}}moveEnd(){!this.isCPUBasedDRA&&this.useProgressiveUpdate||(this._abortController&&this._abortController.abort(),this._abortController=new AbortController,this._fetchQueue.length===0&&this._redrawImage(this._abortController.signal).then(()=>{this._globalUpdateRequested=!1,this.layerView.requestUpdate()}));const t=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy.updateCacheSize(t),this.layerView.requestUpdate()}get updating(){var t;return this._globalUpdateRequested||((t=this._updatingHandles)==null?void 0:t.updating)}attach(){const t=Rs();this._maxIndexedColormapSize=4*(t.maxTextureSize||4096),this._initializeTileInfo(),this._tileInfoView=new xr(this.layerView.tileInfo,this.layerView.fullExtent);const e=this._computeFetchConcurrency();this._fetchQueue=new br({tileInfoView:this._tileInfoView,concurrency:e,process:(i,o)=>this._fetchTile(i,o),priority:wr.MAPVIEW_FETCH_QUEUE,scheduler:this.scheduler});const s=this._getCacheSize(this.useProgressiveUpdate);this._tileStrategy=new ds({cachePolicy:"purge",acquireTile:i=>this.acquireTile(i),releaseTile:i=>this.releaseTile(i),cacheSize:s,tileInfoView:this._tileInfoView}),this._updateBlockCacheRegistry()}detach(){this._tileStrategy.destroy(),this._fetchQueue.clear(),this.container.removeAllChildren(),this._fetchQueue=this._tileStrategy=this._tileInfoView=null,hs(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryUrl=this._blockCacheRegistryId=null}acquireTile(t){const e=this.container.createTile(t);return this._updatingHandles.addPromise(this._enqueueTileFetch(e)),this.layerView.requestUpdate(),this._needBlockCacheUpdate=!0,this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,e}releaseTile(t){this._fetchQueue.abort(t.key.id),this.container.removeChild(t),t.once("detach",()=>{t.destroy(),this.layerView.requestUpdate()}),this.layerView.requestUpdate()}createEmptyTilePixelBlock(t=null){const e=t==null||t.join(",")===this._tileInfoView.tileInfo.size.join(",");if(e&&this._emptyTilePixelBlock!=null)return this._emptyTilePixelBlock;t=t||this._tileInfoView.tileInfo.size;const[s,i]=t,o=new hr({width:s,height:i,pixels:[new Uint8Array(s*i)],mask:new Uint8Array(s*i),pixelType:"u8"});return e&&(this._emptyTilePixelBlock=o),o}_getBandIds(){if(this.container&&(!("rasterFunctionChain"in this.container)||!this.container.rasterFunctionChain))return this.layer.bandIds;const{bandIds:t,raster:e}=this.layer,s="rasterFunction"in e?e.rasterFunction.rawInputBandIds:null;return t!=null&&t.length&&(s!=null&&s.length)&&e.rasterInfo.bandCount!==1?t.map(i=>s[Math.min(i,s.length-1)]):"rasterFunction"in e?s:t}updateRasterFunctionParameters(){}_fetchTile(t,e){const s=this._getFetchOptions(t.level,e.signal);return this.fetchTile(t,s)}_getFetchOptions(t,e){var c;const{canUseWebGLForProcessing:s}=this,{layerView:i}=this,{tileInfo:o}=i,r=!o.isWrappable&&gr(i.view.spatialReference)!=null,a=s&&this.layer.raster.hasUniqueSourceStorageInfo,{layer:n}=this.layerView,l=(c=n.serviceRasterInfo)!=null&&c.storageInfo.isBsqTile?n.getRawDisplayBandIds():void 0;return{allowPartialFill:!0,datumTransformation:i.datumTransformation,interpolation:s?"nearest":this.layer.interpolation,registryId:this._blockCacheRegistryId,requestRawData:a,skipRasterFunction:this.type==="raster"&&this.container.rasterFunctionChain!=null,signal:e,srcResolution:this._srcResolutions[t],timeExtent:i.timeExtent,tileInfo:o,bandIds:l,disableWrapAround:r}}_getCacheSize(t){return t?40:0}_initializeTileInfo(){const{layerView:t}=this,e=t.view.spatialReference;if(this._canUseLayerLODs()){const{origin:c,lods:h}=this.layer.tileInfo,p=h.map(({scale:g})=>g),f=us.create({spatialReference:e,size:N,scales:p,origin:c});return t.set("tileInfo",f),void(this._srcResolutions=h.map(({resolution:g})=>({x:g,y:g})))}const{scales:s,srcResolutions:i,isCustomTilingScheme:o}=yr(this.layer.serviceRasterInfo,e,{tileSize:N,alignGlobalDatasetWithAGOL:!0}),r=us.create({spatialReference:e,size:N,scales:s}),a=r.origin.x===0;fi(t.fullExtent);const{xmin:n,ymax:l}=t.fullExtent;(a||o&&r.origin.x>n)&&(r.origin=new gi({x:n,y:l,spatialReference:e})),this._isCustomTilingScheme=o,t.set("tileInfo",r),this._srcResolutions=i??[]}_canUseLayerLODs(){var o;const{layer:t,layerView:e}=this;if(t.raster.tileType!=="Map")return!1;const{lods:s}=t.tileInfo,i=(o=e.view.constraints)==null?void 0:o.effectiveLODs;return(i==null?void 0:i.length)===s.length&&i.every(({scale:r},a)=>Math.abs(r-s[a].scale)<.001)}_computeFetchConcurrency(){const{blockBoundary:t}=this.layer.serviceRasterInfo.storageInfo,e=t[t.length-1];return(e.maxCol-e.minCol+1)*(e.maxRow-e.minRow+1)>64?2:10}async _enqueueTileFetch(t,e){var s;if(!this._fetchQueue.has(t.key.id)){try{let i=t.once("detach",()=>i=void 0);const o=await this._fetchQueue.push(t.key),r=this._getBandIds();let a=!this.useProgressiveUpdate||this.isCPUBasedDRA&&!this._globalSymbolizerParams;if(this._globalUpdateRequested&&!this.layerView.moving&&this._fetchQueue.length===0){a=!1;try{await this._redrawImage((s=this._abortController)==null?void 0:s.signal)}catch(c){Ke(c)&&et.getLogger(this).error(c)}this._globalUpdateRequested=!1}if(!i)return;this.canUseLocalSymbolizerParams&&this._symbolizerParams==null&&this._updateSymbolizerParams();const n=this._tileInfoView.getTileCoords(So,t.key),l=this._tileInfoView.getTileResolution(t.key);await this.updateTileSource(t,{source:o,symbolizerParams:this._symbolizerParams,globalSymbolizerParams:this._globalSymbolizerParams,suspended:a,bandIds:r,coords:n,resolution:l}),i&&(t.once("attach",()=>this.layerView.requestUpdate()),this.container.addChild(t),i.remove())}catch(i){Ke(i)||et.getLogger(this).error(i)}this.layerView.requestUpdate()}}async _redrawImage(t){if(!this.attached||this.container.children.length===0||(await this.layer.updateRenderer(),this.isCPUBasedDRA?await this._updateGlobalSymbolizerParams(t):(this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._globalSymbolizerParams=null),!this.attached||(t==null?void 0:t.aborted)))return;const e=this.container.children.map(async s=>this.updateTileSymbolizerParameters(s,{local:this._symbolizerParams,global:this._globalSymbolizerParams},t));await Promise.allSettled(e),this.attached&&!(t!=null&&t.aborted)&&this.container.requestRender()}async _updateGlobalSymbolizerParams(t){const e=this._getFetchOptions(this.previousLOD.level,t),s=await this.layer.fetchPixels(this.layerView.view.extent,this.layerView.view.width,this.layerView.view.height,{...e,interpolation:"nearest",requestRawData:!1,skipRasterFunction:!1});if(!(s!=null&&s.pixelBlock))return;const{resolution:i}=this.previousLOD,{isBsqTile:o}=this.layer.raster.rasterInfo.storageInfo,r=o?null:this._getBandIds(),a=this.layer.symbolizer.generateWebGLParameters({pixelBlock:s.pixelBlock.extractBands(r),isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:i,y:i},bandIds:r});!this.canUseWebGLForProcessing&&a&&a.type==="stretch"&&this.layer.renderer&&this.layer.renderer.type==="raster-stretch"&&(a.factor=a.factor.map(n=>255*n),a.minOutput=Math.round(255*a.minOutput),a.maxOutput=Math.round(255*a.maxOutput)),this._globalSymbolizerParams=a}_updateSymbolizerParams(){const{resolution:t}=this.previousLOD,e=this._getBandIds();this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null,isGCS:this.layerView.view.spatialReference.isGeographic,resolution:{x:t,y:t},bandIds:e})}_updateBlockCacheRegistry(t=!1){const{layer:e,layerView:s}=this,{raster:i}=e,{multidimensionalDefinition:o}=e.normalizeRasterFetchOptions({multidimensionalDefinition:e.multidimensionalDefinition,timeExtent:s.timeExtent}),r=i.rasterInfo.multidimensionalInfo?i.getSliceIndex(o):null,a=i.rasterInfo.storageInfo.isBsqTile?e.getRawDisplayBandIds():null,n=pr(i.rasterId,r,a);if(n!==this._blockCacheRegistryUrl){if(this._blockCacheRegistryUrl!=null&&hs(this._blockCacheRegistryUrl,this._blockCacheRegistryId),this._blockCacheRegistryId=dr(n,i.rasterInfo),t){const{view:l}=s,c=this._tileInfoView.getClosestInfoForScale(l.scale),h=this._srcResolutions[c.level];cs(n,this._blockCacheRegistryId,l.extent,l.resolution,h,i.ioConfig.sampling)}this._blockCacheRegistryUrl=n}}async doRefresh(){if(!this.attached||!this.previousLOD||this.layerView.suspended)return;await this.layer.updateRenderer(),this.canUseLocalSymbolizerParams&&this._updateSymbolizerParams(),this._updateBlockCacheRegistry(!0),this._fetchQueue.reset();const t=[];this._globalUpdateRequested=this.isCPUBasedDRA||!this.useProgressiveUpdate,this._tileStrategy.refresh(e=>t.push(this._enqueueTileFetch(e))),await this._updatingHandles.addPromise(Promise.allSettled(t))}};u([P()],G.prototype,"_globalUpdateRequested",void 0),u([P()],G.prototype,"attached",void 0),u([P()],G.prototype,"canUseWebGLForProcessing",null),u([P()],G.prototype,"canUseLocalSymbolizerParams",null),u([P()],G.prototype,"isCPUBasedDRA",null),u([P()],G.prototype,"container",void 0),u([P()],G.prototype,"layer",void 0),u([P()],G.prototype,"layerView",void 0),u([P()],G.prototype,"scheduler",void 0),u([P()],G.prototype,"type",void 0),u([P()],G.prototype,"useWebGLForProcessing",null),u([P()],G.prototype,"useProgressiveUpdate",null),u([P()],G.prototype,"timeExtent",void 0),u([P()],G.prototype,"updating",null),G=u([it("esri.views.2d.layers.imagery.BaseImageryTileSubView2D")],G);let xe=class extends G{constructor(){super(...arguments),this.type="raster"}get canUseWebGLForProcessing(){var r;const{loaded:t,symbolizer:e}=this.layer;if(!t||!e)return!1;const s=(r=e.lookup.colormapLut)==null?void 0:r.indexedColormap,i=s&&s.length>this._maxIndexedColormapSize,o=Si(this.layer.serviceRasterInfo);return!(gs("ios")&&o>4)&&this.useWebGLForProcessing&&e.canRenderInWebGL&&!i&&!(this.layer.interpolation==="majority"&&ws(this.layer))}attach(){super.attach(),this.container=new Ro(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this.updateRasterFunctionParameters()}detach(){super.detach(),this.container.removeAllChildren(),this.container=null}fetchTile(t,e){return this.layer.fetchTile(t.level,t.row,t.col,e)}updateRasterFunctionParameters(){var f;const{raster:t,type:e}=this.layer,{container:s}=this;if(t.datasetFormat!=="Function"||e==="wcs")return s.rasterFunctionChain=null,s.children.forEach(g=>{const{bitmap:y}=g;y&&(y.suspended=!0,y.processed=!1,y.projected&&(y.invalidateTexture(),y.rasterTexture=null))}),void(this._rasterFunctionState="na");const i=this._rasterFunctionState,{rasterFunction:o,primaryRasters:r}=t,a=o.supportsGPU&&(!r||r.rasters.length<=1),n=a?o.flatWebGLFunctionChain:null,{renderer:l}=this.layer,c=!a||!(n!=null&&n.functions.length)||(l==null?void 0:l.type)==="raster-stretch"&&l.dynamicRangeAdjustment||!this.canUseWebGLForProcessing;s.rasterFunctionChain=c?null:this._addProjection(n);const h=o==null?"na":s.rasterFunctionChain?"gpu":"cpu",p=i===h||i==="na"&&h==="cpu"&&((f=n==null?void 0:n.functions)==null?void 0:f.length)===0;s.children.forEach(g=>{const{bitmap:y}=g;y&&(y.suspended=!p,y.processed=!1,y.processedTexture=null)}),this._rasterFunctionState=h}async updateTileSource(t,e){const s=this._getBandIds(),i=this._getLayerInterpolation(),{canUseWebGLForProcessing:o}=this,{source:r,globalSymbolizerParams:a,suspended:n,coords:l,resolution:c}=e,h=this.isCPUBasedDRA?a:e.symbolizerParams,{bitmap:p}=t;if([p.x,p.y]=l,p.resolution=c,(r==null?void 0:r.pixelBlock)!=null){const y={extent:r.extent,pixelBlock:r.pixelBlock,srcPixelSize:r.srcTilePixelSize};if(p.rawPixelData=y,o)p.source=r.pixelBlock,p.isRendereredSource=!1;else{const b=await this.layer.applyRenderer(y,(a==null?void 0:a.type)==="stretch"?a:void 0);p.source=b,p.isRendereredSource=!0}p.symbolizerParameters=o?h:null,p.transformGrid=o?r.transformGrid:null}else{const y=this.createEmptyTilePixelBlock();p.source=y,p.symbolizerParameters=o?h:null,p.transformGrid=null}const{isBsqTile:f}=this.layer.raster.rasterInfo.storageInfo;p.bandIds=o&&!f?s:null,p.width=this._tileInfoView.tileInfo.size[0],p.height=this._tileInfoView.tileInfo.size[1],p.interpolation=i,p.suspended=n;const{raster:g}=this.layer;if(bs(g)){const y=g.getClippingGeometry(this.layerView.view.spatialReference);if(y){const b=g.getTileExtentFromTileInfo(t.key.level,t.key.row,t.key.col,this._tileInfoView.tileInfo);b&&(p.mask=Pi({srcExtent:b,geometry:y,size:[p.width,p.height]}))}}p.invalidateTexture()}async updateTileSymbolizerParameters(t,e,s){const{local:i,global:o}=e,r=this._getBandIds(),a=this._getLayerInterpolation(),{canUseWebGLForProcessing:n}=this,{bitmap:l}=t,{rawPixelData:c}=l;n||c==null?(l.isRendereredSource&&c!=null&&(l.source=c.pixelBlock),l.isRendereredSource=!1):(l.source=await this.layer.applyRenderer(c,(o==null?void 0:o.type)==="stretch"?o:void 0,{signal:s}),l.isRendereredSource=!0),l.symbolizerParameters=n?this.layerView.hasTilingEffects?o:i:null;const{isBsqTile:h}=this.layer.raster.rasterInfo.storageInfo;l.bandIds=n&&!h?r:null,l.interpolation=a,l.suspended=!1}updateHighlightOptions(t){var i;if(!t.length)return void(this.container.pixelHighlights=void 0);const e=[],{highlights:s}=this.layerView.view;t.sort((o,r)=>s.findIndex(({name:a})=>a===At(r.options))-s.findIndex(({name:a})=>a===At(o.options)));for(const{target:o,options:r}of t){const{pixelRanges:a}=o,n=Array.from({length:2*se},()=>0);for(let f=0;f<a.length;f++)n[2*f]=a[f][0],n[2*f+1]=a[f][1];for(let f=a.length;f<se;f++)n[2*f]=os,n[2*f+1]=-os;const l=o.bandId??0,c=At(r),h=((i=s.find(f=>f.name===c))==null?void 0:i.color)??_r,p=ui.toUnitRGBA(h);e.push({ranges:n,bandId:l,color:p})}this.container.pixelHighlights=e}_getLayerInterpolation(){const{interpolation:t,renderer:e}=this.layer;if(!e)return t;const s=e.type;return s==="raster-colormap"||s==="unique-value"?"nearest":e.type==="raster-stretch"&&e.colorRamp!=null?t==="bilinear"||t==="cubic"?"bilinear":"nearest":t}_addProjection(t){var e;return(e=t==null?void 0:t.functions)!=null&&e.length&&!t.hasFocalFunction&&t.functions.unshift({name:"Reproject",parameters:{targetImageSize:this._tileInfoView.tileInfo.size,requireNNEdge:t.isSourceSingleBand},pixelType:"f32",id:0,isNoopProcess:!1}),t}};u([P()],xe.prototype,"canUseWebGLForProcessing",null),u([P()],xe.prototype,"container",void 0),u([P()],xe.prototype,"layer",void 0),u([P()],xe.prototype,"type",void 0),xe=u([it("esri.views.2d.layers.imagery.ImageryTileView2D")],xe);class Po extends _s{constructor(e,s,i,o,r,a,n=null){super(e,s,i,o,r,a),this.tileData=new Ci(n),this.tileData.coordScale=[r,a],this.tileData.once("isReady",()=>this.ready())}destroy(){super.destroy(),this.tileData.destroy(),this.tileData=null,this.stage=null}set stencilRef(e){this.tileData.stencilRef=e}get stencilRef(){return this.tileData.stencilRef}_createTransforms(){return{displayViewScreenMat3:tt(),tileMat3:tt()}}setTransform(e){super.setTransform(e);const s=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[o,r]=this.tileData.offset,a=[this.x+o*this.resolution,this.y-r*this.resolution],[n,l]=e.toScreenNoRotation([0,0],a),{symbolTileSize:c}=this.tileData.symbolizerParameters,h=Math.round((this.width-this.tileData.offset[0])/c)*c,p=Math.round((this.height-this.tileData.offset[1])/c)*c,f=h/this.rangeX*s,g=p/this.rangeY*s;yi(i,f,0,0,0,g,0,n,l,1),xs(this.transforms.displayViewScreenMat3,e.displayViewMat3,i),this.tileData.transforms.displayViewScreenMat3=this.transforms.displayViewScreenMat3}onAttach(){this.tileData.stage=this.stage}onDetach(){this.tileData.stage=null}}class Fo extends Ts{constructor(){super(...arguments),this.isCustomTilingScheme=!1,this.symbolTypes=["triangle"]}createTile(e){const s=this.tileInfoView.getTileBounds(ys(),e),[i,o]=this.tileInfoView.tileInfo.size,r=this.tileInfoView.getTileResolution(e.level);return new Po(e,r,s[0],s[3],i,o)}prepareRenderPasses(e){const s=e.registerRenderPass({name:"imagery (vf tile)",brushes:[vi],target:()=>this.children.map(i=>i.tileData),drawPhase:1});return[...super.prepareRenderPasses(e),s]}doRender(e){this.visible&&e.drawPhase===1&&this.symbolTypes.forEach(s=>{e.renderPass=s,super.doRender(e)})}}let Ie=class extends G{constructor(){super(...arguments),this._handle=null,this.type="rasterVF"}async fetchTile(t,e){var i;e={...e,interpolation:"nearest",requestProjectedLocalDirections:!0};const s=await this.layer.fetchTile(t.level,t.row,t.col,e);return((i=this.layer.serviceRasterInfo)==null?void 0:i.dataType)==="vector-magdir"&&(s!=null&&s.pixelBlock)&&(s.pixelBlock=await this.layer.convertVectorFieldData(s.pixelBlock,"vector-magdir",e)),s}updateTileSource(t,e){const s=e.symbolizerParams,{tileData:i}=t;i.key=t.key,i.width=this._tileInfoView.tileInfo.size[0],i.height=this._tileInfoView.tileInfo.size[1];const{symbolTileSize:o}=s,{source:r}=e;if(i.offset=this._getTileSymbolOffset(i.key,o),(r==null?void 0:r.pixelBlock)!=null){const a={extent:r.extent,pixelBlock:r.pixelBlock};i.rawPixelData=a,i.symbolizerParameters=s,i.source=this._sampleVectorFieldData(r.pixelBlock,s,i.offset)}else{const a=[Math.round((this._tileInfoView.tileInfo.size[0]-i.offset[0])/o),Math.round((this._tileInfoView.tileInfo.size[1]-i.offset[1])/o)],n=this.createEmptyTilePixelBlock(a);i.source=n,i.symbolizerParameters=s}return i.invalidateVAO(),Promise.resolve()}updateTileSymbolizerParameters(t,e){var n;const s=e.local,{symbolTileSize:i}=s,{tileData:o}=t;o.offset=this._getTileSymbolOffset(o.key,i);const r=o.symbolizerParameters.symbolTileSize;o.symbolizerParameters=s;const a=(n=o.rawPixelData)==null?void 0:n.pixelBlock;return a!=null&&r!==i&&(o.source=this._sampleVectorFieldData(a,o.symbolizerParameters,o.offset)),Promise.resolve()}attach(){super.attach(),this.container=new Fo(this._tileInfoView),this.container.isCustomTilingScheme=this._isCustomTilingScheme,this._updateSymbolType(this.layer.renderer),this._handle=He(()=>this.layer.renderer,t=>this._updateSymbolType(t))}detach(){var t;super.detach(),this.container.removeAllChildren(),(t=this._handle)==null||t.remove(),this._handle=null,this.container=null}_getTileSymbolOffset(t,e){const s=t.col*this._tileInfoView.tileInfo.size[0]%e,i=t.row*this._tileInfoView.tileInfo.size[1]%e;return[s>e/2?e-s:-s,i>e/2?e-i:-i]}_sampleVectorFieldData(t,e,s){const{symbolTileSize:i}=e;return Fi(t,"vector-uv",i,s)}_updateSymbolType(t){(t==null?void 0:t.type)==="vector-field"&&(this.container.symbolTypes=t.style==="wind-barb"?["scalar","triangle"]:t.style==="simple-scalar"?["scalar"]:["triangle"])}};u([P()],Ie.prototype,"container",void 0),u([P()],Ie.prototype,"layer",void 0),u([P()],Ie.prototype,"type",void 0),Ie=u([it("esri.views.2d.layers.imagery.VectorFieldTileView2D")],Ie);const Io=t=>{const e=t;let s=class extends e{constructor(...i){super(...i),this.layer=null,this.tileInfo=null}get fullExtent(){try{return this.layer.loaded?this._getFullExtent():null}catch{return null}}get timeExtent(){var i;return Cr(this.layer,(i=this.view)==null?void 0:i.timeExtent,this._get("timeExtent"))}get hasTilingEffects(){const{renderer:i}=this.layer;return!!((i==null?void 0:i.type)==="raster-stretch"&&i.dynamicRangeAdjustment&&!(i.stretchType==="min-max"||i.stretchType==="standard-deviation"))}get datumTransformation(){try{return this.layer.loaded?mr(this.layer.fullExtent,this.view.spatialReference,!0):null}catch{return null}}supportsSpatialReference(i){try{return!this.layer.loaded||!!ps(this.layer.serviceRasterInfo,i)}catch{return!1}}async fetchPopupFeaturesAtLocation(i,o){var g,y;const{layer:r}=this;if(!i)throw new ci("imageryTileLayerView:fetchPopupFeatures","Nothing to fetch without area",{layer:r});const{popupEnabled:a}=r,n=Rr(r,o);if(!a||n==null)return[];const l=[],{value:c,magdirValue:h,processedValue:p}=await r.identify(i,{timeExtent:this.timeExtent,signal:o==null?void 0:o.signal});let f="";if(c!=null&&c.length){f=r.type==="imagery-tile"&&r.hasStandardTime()&&c[0]!=null?c.map(Le=>r.getStandardTimeValue(Le)).join(", "):c.join(", ");const b={ObjectId:0};b[je.servicePixelValue]=r.type==="imagery-tile"&&bs(r.raster)?p==null?void 0:p.join(", "):f,b[je.rawServicePixelValue]=f;const T=((g=r.raster)==null?void 0:g.rasterInfo)??r.serviceRasterInfo,F=T==null?void 0:T.attributeTable;if(F!=null){const{fields:Le,features:Dt}=F,ut=Le.find(({name:re})=>re.toLowerCase()==="value"),Ot=b[je.servicePixelValue],_e=ut?Dt.find(re=>String(re.attributes[ut.name])===Ot):null;if(_e)for(const re in _e.attributes)_e.attributes.hasOwnProperty(re)&&(b[vr+re]=_e.attributes[re])}const R=T==null?void 0:T.dataType;R!=="vector-magdir"&&R!=="vector-uv"||(b[je.magnitude]=h==null?void 0:h[0],b[je.direction]=h==null?void 0:h[1]);const{multidimensionalDefinition:q}=this.layer.normalizeRasterFetchOptions({timeExtent:this.timeExtent});Tr(r.rasterFields,b,q);const{graphicOrigin:X}=r,qe=new hi({geometry:(y=this.fullExtent)==null?void 0:y.clone(),attributes:b,layer:r,origin:X,sourceLayer:r});l.push(qe)}return l}async getSourceScale(){return await this.layer.load(),fr(this.layer.serviceRasterInfo,this.view.spatialReference)}_getFullExtent(){return ps(this.layer.serviceRasterInfo,this.view.spatialReference)}};return u([P()],s.prototype,"fullExtent",null),u([P()],s.prototype,"layer",void 0),u([P({readOnly:!0})],s.prototype,"timeExtent",null),u([P()],s.prototype,"tileInfo",void 0),u([P({readOnly:!0})],s.prototype,"hasTilingEffects",null),u([P()],s.prototype,"datumTransformation",null),s=u([it("esri.views.layers.ImageryTileLayerView")],s),s};let be=class extends Io(Pr(Ri(Sr))){constructor(){super(...arguments),this._useWebGLForProcessing=!0,this._useProgressiveUpdate=!0,this._pixelHighlights=[],this.subview=null}get useWebGLForProcessing(){return this._useWebGLForProcessing}set useWebGLForProcessing(t){this._useWebGLForProcessing=t,this.subview&&"useWebGLForProcessing"in this.subview&&(this.subview.useWebGLForProcessing=t)}get useProgressiveUpdate(){return this._useWebGLForProcessing}set useProgressiveUpdate(t){this._useProgressiveUpdate=t,this.subview&&"useProgressiveUpdate"in this.subview&&(this.subview.useProgressiveUpdate=t)}get displayParameters(){const{layer:t}=this,e=this._get("displayParameters");return t.renderer&&t.visible?{bandIds:t.bandIds,renderer:t.renderer,interpolation:t.interpolation,multidimensionalDefinition:t.multidimensionalDefinition,rasterFunction:t.type==="imagery-tile"?t.rasterFunction:null}:e}update(t){var e;(e=this.subview)==null||e.update(t),this.notifyChange("updating")}isUpdating(){return!this.subview||this.subview.updating}attach(){this.layer.increaseRasterJobHandlerUsage(),this._updateSubview(),this.addAttachHandles([He(()=>this.displayParameters,(t,e)=>{var c,h,p,f;const s=t.interpolation!==(e==null?void 0:e.interpolation)&&(t.interpolation==="majority"||(e==null?void 0:e.interpolation)==="majority")&&ws(this.layer),i=!!((h=(c=this.layer.serviceRasterInfo)==null?void 0:c.storageInfo)!=null&&h.isBsqTile)&&((p=t.bandIds)==null?void 0:p.join())!==((f=e==null?void 0:e.bandIds)==null?void 0:f.join()),o=t.renderer!==(e==null?void 0:e.renderer)&&this._getSubviewType(e==null?void 0:e.renderer)!==this._getSubviewType(t.renderer);o&&this._updateSubview();const r=t.multidimensionalDefinition!==(e==null?void 0:e.multidimensionalDefinition),a=t.rasterFunction!==(e==null?void 0:e.rasterFunction),n=a&&!this._useWebGLForProcessing,l=r||s||o||n||i;this.subview.redrawOrRefetch({refetch:l,reprocess:a}).catch(g=>{Ke(g)||et.getLogger(this).error(g)}),this.notifyChange("updating")}),He(()=>this.layer.multidimensionalSubset??null,(t,e)=>{const{multidimensionalDefinition:s}=this.layer;s!=null&&as(s,t)!==as(s,e)&&(this.subview.redrawOrRefetch({refetch:!0}).catch(i=>{Ke(i)||et.getLogger(this).error(i)}),this.notifyChange("updating"))},li),He(()=>this.timeExtent,()=>{this.subview.timeExtent=this.timeExtent,this.subview.redrawOrRefetch({refetch:!0}).catch(t=>{Ke(t)||et.getLogger(this).error(t)})},is),He(()=>this.view.highlights.items.map(({name:t,color:e})=>({name:t,color:e})),()=>this._updateHighlightOptions(this.subview),is)])}detach(){var t;this.layer.decreaseRasterJobHandlerUsage(),this._detachSubview(this.subview),(t=this.subview)==null||t.destroy(),this.subview=null}viewChange(){this.requestUpdate()}moveEnd(){this.subview.moveEnd()}highlight(t,e){var i;if(!((i=t.pixelRanges)!=null&&i.length))return rs();const s={target:{...t},options:{...e}};return this._pixelHighlights.push(s),this._updateHighlightOptions(this.subview),rs(()=>{const o=this._pixelHighlights.indexOf(s);o!==-1&&(this._pixelHighlights.splice(o,1),this._updateHighlightOptions(this.subview))})}doRefresh(){return this.subview?this.subview.doRefresh():Promise.resolve()}_updateSubview(){var o;const{renderer:t}=this.layer;if(!t)return;const e=this._getSubviewType(t);if(this.subview){if(this.subview.type===e)return void this._attachSubview(this.subview);this._detachSubview(this.subview),(o=this.subview)==null||o.destroy(),this.subview=null}const{layer:s}=this;let i;if(i=e==="rasterVF"?new Ie({layer:s,layerView:this,scheduler:this.scheduler}):e==="flow"?new Ti({layer:s,layerView:this,scheduler:this.scheduler}):new xe({layer:s,layerView:this,scheduler:this.scheduler}),"useWebGLForProcessing"in i&&(i.useWebGLForProcessing=this._useWebGLForProcessing),"useProgressiveUpdate"in i&&(i.useProgressiveUpdate=this._useProgressiveUpdate),"previousLOD"in i){const{subview:r}=this;i.previousLOD=r&&"previousLOD"in r?r.previousLOD:null}this._attachSubview(i),this._updateHighlightOptions(i),this.subview=i,this.requestUpdate()}_attachSubview(t){t&&!t.attached&&(t.attach(),t.attached=!0,this.container.addChildAt(t.container,0))}_detachSubview(t){t!=null&&t.attached&&(this.container.removeChild(t.container),t.detach(),t.attached=!1)}_getSubviewType(t){const e=t==null?void 0:t.type;return e==="vector-field"?"rasterVF":e==="flow"?"flow":"raster"}_updateHighlightOptions(t){(t==null?void 0:t.type)==="raster"&&t.updateHighlightOptions(this._pixelHighlights)}};u([P()],be.prototype,"subview",void 0),u([P()],be.prototype,"useWebGLForProcessing",null),u([P()],be.prototype,"useProgressiveUpdate",null),u([P({readOnly:!0})],be.prototype,"displayParameters",null),be=u([it("esri.views.2d.layers.ImageryTileLayerView2D")],be);const Un=be;export{Un as default};
