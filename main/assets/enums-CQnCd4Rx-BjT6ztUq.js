import{e3 as Ie,v as B,S as P,n as ye,at as de,ac as Te,ak as ve,D as xe,e4 as Se,b9 as j,e5 as we,b4 as Me,c5 as Ee,a4 as Z,p as Le,c6 as Be,H as Re,s as J,aN as Ce,aT as Ae,e6 as Pe}from"./index-1o7Uo5_u.js";import{s as z}from"./TileKey-_zikB14n-Clq_QAqL.js";import{f as Fe,M as $}from"./vec2-BnynUbeJ-CKtGJQAy.js";import{r as be}from"./Queue-DV3gpSdl-CaOyhJy3.js";import{o as V}from"./ReactiveMap-iPeM8evD-TeLsiYH2.js";import{b as Ye}from"./quickselect-DHTstthl-Ds_Aj0x5.js";import{b as Xe}from"./Query-n1aoaaFC-DhJp6MZC.js";function F(e,t){return[e,t]}function R(e,t,i){return e[0]=t,e[1]=i,e}function Ne(e,t,i,s,o){return e[0]=t,e[1]=i,e[2]=s,e[3]=o,e}const v=new z("0/0/0/0");let ke=class me{static create(t,i,s=null){const o=de(t.spatialReference),r=i.origin||F(t.origin.x,t.origin.y),n=F(t.size[0]*i.resolution,t.size[1]*i.resolution),l=F(-1/0,-1/0),h=F(1/0,1/0),a=F(1/0,1/0);s!=null&&(R(l,Math.max(0,Math.floor((s.xmin-r[0])/n[0])),Math.max(0,Math.floor((r[1]-s.ymax)/n[1]))),R(h,Math.max(0,Math.floor((s.xmax-r[0])/n[0])),Math.max(0,Math.floor((r[1]-s.ymin)/n[1]))),R(a,h[0]-l[0]+1,h[1]-l[1]+1));const{cols:c,rows:u}=i;let d,I,_,y;return!s&&c&&u&&(R(l,c[0],u[0]),R(h,c[1],u[1]),R(a,c[1]-c[0]+1,u[1]-u[0]+1)),t.isWrappable?(d=F(Math.ceil(Math.round((o.valid[1]-o.valid[0])/i.resolution)/t.size[0]),a[1]),I=!0,_=o.origin,y=o.valid):(d=a,I=!1),new me(i.level,i.resolution,i.scale,r,l,h,a,n,d,I,_,y)}constructor(t,i,s,o,r,n,l,h,a,c,u,d){this.level=t,this.resolution=i,this.scale=s,this.origin=o,this.first=r,this.last=n,this.size=l,this.norm=h,this.worldSize=a,this.wrap=c,this._spatialReferenceOrigin=u,this._spatialReferenceValid=d}normalizeCol(t){if(!this.wrap)return t;const i=this.worldSize[0];return t<0?i-1-Math.abs((t+1)%i):t%i}normalizeKey(t){if(!this.wrap)return;const i=this.worldSize[0],s=t.col;s<0?(t.col=s+i,t.world-=1):s>=i&&(t.col=s-i,t.world+=1)}denormalizeCol(t,i){return this.wrap?this.worldSize[0]*i+t:t}getWorldForColumn(t){return this.wrap?Math.floor(t/this.worldSize[0]):0}getFirstColumnForWorld(t){return t*this.worldSize[0]+this.first[0]}getLastColumnForWorld(t){return t*this.worldSize[0]+this.first[0]+this.size[0]-1}getColumnForX(t){return(t-this.origin[0])/this.norm[0]}getXForColumn(t){const i=this.origin[0]+t*this.norm[0],s=this._spatialReferenceOrigin,o=this._spatialReferenceValid;return this.wrap&&s&&o?i===s[0]?o[0]:this.origin[0]===s[0]&&t===this.worldSize[0]?o[1]:i:i}getRowForY(t){return(this.origin[1]-t)/this.norm[1]}getYForRow(t){return this.origin[1]-t*this.norm[1]}getTileBounds(t,i,s=!1){v.set(i);const o=s?v.col:this.denormalizeCol(v.col,v.world),r=v.row;return Ne(t,this.getXForColumn(o),this.getYForRow(r+1),this.getXForColumn(o+1),this.getYForRow(r)),t}getTileCoords(t,i,s=!1){v.set(i);const o=s?v.col:this.denormalizeCol(v.col,v.world);return Array.isArray(t)?R(t,this.getXForColumn(o),this.getYForRow(v.row)):(t.x=this.getXForColumn(o),t.y=this.getYForRow(v.row)),t}};var A;let _e=(A=class{constructor(){this.spans=[]}acquire(t){this.lodInfo=t}release(){this.lodInfo=null,this.spans.length=0}*keys(){const t=this.lodInfo;for(const{row:i,colFrom:s,colTo:o}of this.spans)for(let r=s;r<=o;r++){const n=t.getWorldForColumn(r);yield new z(t.level,i,t.normalizeCol(r),n)}}forEach(t,i){const{spans:s,lodInfo:o}=this,{level:r}=o;if(s.length!==0)for(const{row:n,colFrom:l,colTo:h}of s)for(let a=l;a<=h;a++)t.call(i,r,n,o.normalizeCol(a),o.getWorldForColumn(a))}},A.pool=new Ie(A),A),H=class{constructor(e,t,i){this.row=e,this.colFrom=t,this.colTo=i}};const m=new z("0/0/0/0");let ze=class pe{static create(t,i){t[1]>i[1]&&([t,i]=[i,t]);const[s,o]=t,[r,n]=i,l=r-s,h=n-o,a=h!==0?l/h:0,c=(Math.ceil(o)-o)*a,u=(Math.floor(o)-o)*a;return new pe(s,Math.floor(o),Math.ceil(n),a,l<0?c:u,l<0?u:c,l<0?r:s,l<0?s:r)}constructor(t,i,s,o,r,n,l,h){this.x=t,this.ymin=i,this.ymax=s,this.invM=o,this.leftAdjust=r,this.rightAdjust=n,this.leftBound=l,this.rightBound=h}incrRow(){this.x+=this.invM}getLeftCol(){return Math.max(this.x+this.leftAdjust,this.leftBound)}getRightCol(){return Math.min(this.x+this.rightAdjust,this.rightBound)}};const T=[[0,0],[0,0],[0,0],[0,0]],Oe=1e-6;let tt=class{constructor(e,t=null,i=e.lods[0].level,s=e.lods[e.lods.length-1].level){this.tileInfo=e,this.fullExtent=t,this.scales=[],this._infoByScale={},this._infoByLevel={};const o=e.lods.filter(n=>n.level>=i&&n.level<=s);this.minScale=o[0].scale,this.maxScale=o[o.length-1].scale;const r=this._lodInfos=o.map(n=>ke.create(e,n,t));o.forEach((n,l)=>{this._infoByLevel[n.level]=r[l],this._infoByScale[n.scale]=r[l],this.scales[l]=n.scale},this),this._wrap=e.isWrappable}get spatialReference(){return this.tileInfo.spatialReference}getLODInfoAt(e){return this._infoByLevel[typeof e=="number"?e:e.level]}getTileBounds(e,t,i=!1){m.set(t);const s=this._infoByLevel[m.level];return s?s.getTileBounds(e,m,i):e}getTileCoords(e,t,i=!1){m.set(t);const s=this._infoByLevel[m.level];return s?s.getTileCoords(e,m,i):e}getTileCoverage(e,t=192,i=!0,s="closest"){if(!i&&(e.scale>this.minScale||e.scale<this.maxScale))return null;const o=s==="closest"?this.getClosestInfoForScale(e.scale):this.getSmallestInfoForScale(e.scale),r=_e.pool.acquire(o),n=this._wrap;let l,h,a,c=1/0,u=-1/0;const d=r.spans;T[0][0]=T[0][1]=T[1][1]=T[3][0]=-t,T[1][0]=T[2][0]=e.size[0]+t,T[2][1]=T[3][1]=e.size[1]+t;for(const f of T)e.toMap(f,f),f[0]=o.getColumnForX(f[0]),f[1]=o.getRowForY(f[1]);const I=[];let _=3;for(let f=0;f<4;f++){if(T[f][1]===T[_][1]){_=f;continue}const p=ze.create(T[f],T[_]);c=Math.min(p.ymin,c),u=Math.max(p.ymax,u),I[p.ymin]===void 0&&(I[p.ymin]=[]),I[p.ymin].push(p),_=f}if(c==null||u==null||u-c>100)return null;let y=[];for(l=c;l<u;){I[l]!=null&&(y=y.concat(I[l])),h=1/0,a=-1/0;for(let f=y.length-1;f>=0;f--){const p=y[f];h=Math.min(h,p.getLeftCol()),a=Math.max(a,p.getRightCol())}if(h=Math.floor(h),a=Math.floor(a),l>=o.first[1]&&l<=o.last[1])if(n)if(o.size[0]<o.worldSize[0]){const f=Math.floor(a/o.worldSize[0]);for(let p=Math.floor(h/o.worldSize[0]);p<=f;p++)d.push(new H(l,Math.max(o.getFirstColumnForWorld(p),h),Math.min(o.getLastColumnForWorld(p),a)))}else d.push(new H(l,h,a));else h>o.last[0]||a<o.first[0]||(h=Math.max(h,o.first[0]),a=Math.min(a,o.last[0]),d.push(new H(l,h,a)));l+=1;for(let f=y.length-1;f>=0;f--){const p=y[f];p.ymax>=l?p.incrRow():y.splice(f,1)}}return r}getTileParentId(e){m.set(e);const t=this._infoByLevel[m.level],i=this._lodInfos.indexOf(t)-1;return i<0?null:(this._getTileIdAtLOD(m,this._lodInfos[i],m),m.id)}getTileResolution(e){const t=this._infoByLevel[typeof e=="object"?e.level:e];return t?t.resolution:-1}getTileScale(e){const t=this._infoByLevel[e.level];return t?t.scale:-1}intersects(e,t){m.set(t);const i=this._infoByLevel[m.level],s=e.lodInfo;if(s.resolution>i.resolution){this._getTileIdAtLOD(m,s,m);const r=s.denormalizeCol(m.col,m.world);for(const n of e.spans)if(n.row===m.row&&n.colFrom<=r&&n.colTo>=r)return!0}if(s.resolution<i.resolution){const[r,n,l,h]=e.spans.reduce((_,y)=>(_[0]=Math.min(_[0],y.row),_[1]=Math.max(_[1],y.row),_[2]=Math.min(_[2],y.colFrom),_[3]=Math.max(_[3],y.colTo),_),[1/0,-1/0,1/0,-1/0]),a=i.denormalizeCol(m.col,m.world),c=s.getColumnForX(i.getXForColumn(a)),u=s.getRowForY(i.getYForRow(m.row)),d=s.getColumnForX(i.getXForColumn(a+1))-1,I=s.getRowForY(i.getYForRow(m.row+1))-1;return!(c>h||d<l||u>n||I<r)}const o=s.denormalizeCol(m.col,m.world);return e.spans.some(r=>r.row===m.row&&r.colFrom<=o&&r.colTo>=o)}normalizeBounds(e,t,i){if(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],this._wrap){const s=de(this.tileInfo.spatialReference),o=-i*(s.valid[1]-s.valid[0]);e[0]+=o,e[2]+=o}return e}getSmallestInfoForScale(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e];if(e>t[0])return this._infoByScale[t[0]];for(let i=1;i<t.length-1;i++)if(e>t[i]+Oe)return this._infoByScale[t[i-1]];return this._infoByScale[t[t.length-1]]}getClosestInfoForScale(e){const t=this.scales;return this._infoByScale[e]||(e=t.reduce((i,s)=>Math.abs(s-e)<Math.abs(i-e)?s:i,t[0])),this._infoByScale[e]}scaleToLevel(e){const t=this.scales;if(this._infoByScale[e])return this._infoByScale[e].level;for(let i=t.length-1;i>=0;i--)if(e<t[i])return i===t.length-1?this._infoByScale[t[t.length-1]].level:this._infoByScale[t[i]].level+(t[i]-e)/(t[i]-t[i+1]);return this._infoByScale[t[0]].level}scaleToZoom(e){return this.tileInfo.scaleToZoom(e)}zoomToScale(e){return this.tileInfo.zoomToScale(e)}_getTileIdAtLOD(e,t,i){const s=this._infoByLevel[i.level];return e.set(i),t.resolution<s.resolution?null:(t.resolution===s.resolution||(e.level=t.level,e.col=Math.floor(i.col*s.resolution/t.resolution+.01),e.row=Math.floor(i.row*s.resolution/t.resolution+.01)),e)}},qe=class{constructor(e,t){this.item=e,this.controller=t,this.promise=null}},De=class{constructor(e){this._schedule=null,this._task=null,this._deferreds=new V,this._controllers=new V,this._processingItems=new V,this._pausedSignal=Ee(!1),this.concurrency=1,e.concurrency&&(this.concurrency=e.concurrency),this._queue=new be(e.peeker),this.process=e.process;const t=e.scheduler;e.priority&&t&&(this._task=t.registerTask(e.priority,this))}destroy(){this.clear(),this._schedule=Z(this._schedule),this._task=Z(this._task)}get updating(){var e;return!!((e=this._task)!=null&&e.updating)||this.running}get length(){return this._processingItems.size+this._queue.length}abort(e){const t=this._controllers.get(e);t&&t.abort()}clear(){this._queue.clear();const e=[];this._controllers.forEach(t=>e.push(t)),this._controllers.clear(),e.forEach(t=>t.abort()),this._processingItems.clear(),this._cancelNext()}forEach(e){this._deferreds.forEach((t,i)=>e(i))}get(e){const t=this._deferreds.get(e);return t?t.promise:void 0}isOngoing(e){return this._processingItems.has(e)}has(e){return this._deferreds.has(e)}pause(){this._pausedSignal.value||(this._pausedSignal.value=!0,this._cancelNext())}push(e,t){const i=this.get(e);if(i)return i;const s=new AbortController;let o=null;t&&(o=Le(t,()=>s.abort()));const r=()=>{const a=this._processingItems.get(e);a&&a.controller.abort(),n(),h.reject(J())},n=()=>{l.remove(),o==null||o.remove(),this._removeItem(e),this._queue.remove(e),this._scheduleNext()},l=Be(s.signal,r),h=Re();return this._deferreds.set(e,h),this._controllers.set(e,s),h.promise.then(n,n),this._queue.push(e),this._scheduleNext(),h.promise}last(){return this._queue.last()}lastPromise(){const e=this.last();return e?this.get(e):null}peek(){return this._queue.peek()}popLast(){var t;const e=this._queue.popLast();return e&&((t=this._deferreds.get(e))==null||t.reject(J()),this._removeItem(e)),e}reset(){const e=Array.from(this._processingItems.values());this._processingItems.clear();for(const t of e)this._queue.push(t.item),t.controller.abort();this._scheduleNext()}resume(){this._pausedSignal.value&&(this._pausedSignal.value=!1,this._scheduleNext())}takeAll(){const e=[];for(;this._queue.length;)e.push(this._queue.pop());return this.clear(),e}get running(){return!this._pausedSignal.value&&this._queue.length>0&&this._processingItems.size<this.concurrency}runTask(e){for(;!e.done&&this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop()),e.madeProgress()}_removeItem(e){this._deferreds.delete(e),this._controllers.delete(e),this._processingItems.delete(e)}_scheduleNext(){this._task||this._pausedSignal.value||this._schedule||(this._schedule=Ce(()=>{this._schedule=null,this._next()}))}_next(){for(;this._queue.length>0&&this._processingItems.size<this.concurrency;)this._process(this._queue.pop())}_cancelNext(){this._schedule&&(this._schedule.remove(),this._schedule=null)}_processResult(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).resolve(t))}_processError(e,t){this._canProcessFulfillment(e)&&(this._scheduleNext(),this._deferreds.get(e.item).reject(t))}_canProcessFulfillment(e){return!!this._deferreds.get(e.item)&&this._processingItems.get(e.item)===e}_process(e){if(e==null)return;let t;const i=new AbortController,s=new qe(e,i);this._processingItems.set(e,s);try{t=this.process(e,i.signal)}catch(o){this._processError(s,o)}Ae(t)?(s.promise=t,t.then(o=>this._processResult(s,o),o=>this._processError(s,o))):this._processResult(s,t)}get test(){}};const Q=[0,0];let M=class extends Te{constructor(e){super(e),this._keyToItem=new Map,this._tilesByScale=new Map,this.concurrency=6}initialize(){const{concurrency:e,process:t,scheduler:i,priority:s}=this;this._queue=new De({concurrency:e,scheduler:i,priority:s,process:(o,r)=>{const n=this._keyToItem.get(o);return t(n,{signal:r})},peeker:o=>this._peek(o)})}destroy(){this.clear(),this._queue=ve(this._queue)}get length(){return this._queue?this._queue.length:0}abort(e){const t=typeof e=="string"?e:e.id;this._queue.abort(t)}clear(){this._queue.clear(),this._keyToItem.clear(),this._tilesByScale.clear()}has(e){return typeof e=="string"?this._keyToItem.has(e):this._keyToItem.has(e.id)}pause(){this._queue.pause()}push(e){const t=e.key.id;if(this._queue.has(t))return this._queue.get(t);const i=this._queue.push(t),s=this.tileInfoView.getTileScale(e.key),o=xe(this._tilesByScale,s,()=>new Set),r=()=>{o.delete(e.key),o.size===0&&this._tilesByScale.delete(s),this._keyToItem.delete(t)};return o.add(e.key),this._keyToItem.set(t,e),i.then(r,r),i}reset(){this._queue.reset()}resume(){this._queue.resume()}_peek(e){if(!this.state)return e.values().next().value;const t=new Set;for(const r of e)t.add(this._keyToItem.get(r).key);const i=this.state.scale;let s,o=Number.POSITIVE_INFINITY;for(const[r,n]of this._tilesByScale)if(Se(n,l=>t.has(l))){const l=Math.abs(r-i);l<o&&(s=n,o=l)}return this._getClosestTileKey(s,e).id}_getClosestTileKey(e,t){const i=this.tileInfoView,s=this.state.center;let o,r=Number.POSITIVE_INFINITY;for(const n of e)if(t.has(n.id)){i.getTileCoords(Q,n);const l=Fe(Q,s);l<r&&(r=l,o=n)}return o}};B([P({constructOnly:!0})],M.prototype,"concurrency",void 0),B([P({constructOnly:!0})],M.prototype,"priority",void 0),B([P({constructOnly:!0})],M.prototype,"process",void 0),B([P({constructOnly:!0})],M.prototype,"scheduler",void 0),B([P()],M.prototype,"state",void 0),B([P({constructOnly:!0})],M.prototype,"tileInfoView",void 0),M=B([ye("esri.views.2d.tiling.TileQueue")],M);const it=M;class Ve{constructor(t,i,s){this.maxSize=t,this._tileInfoView=i,this._removedFunc=s,this._tilePerId=new Map,this._tileKeysPerLevel=[]}clear(){this._tilePerId.clear(),this._tileKeysPerLevel=[]}has(t){return this._tilePerId.has(t)}get(t){return this._tilePerId.get(t)}pop(t){const i=this._tilePerId.get(t);if(!i)return;const s=i.key.level,o=this._tileKeysPerLevel[s];ee(this._tilePerId,t);for(let r=0;r<o.length;r++)if(o[r].id===t){o.splice(r,1);break}return i.visible=!0,i}add(t){t.visible=!1;const i=t.key,s=i.id;if(this._tilePerId.has(s))return;this._tilePerId.set(s,t);const o=i.level;this._tileKeysPerLevel[o]||(this._tileKeysPerLevel[o]=[]),this._tileKeysPerLevel[o].push(i)}prune(t,i,s){let o=this._tilePerId.size;if(o<=this.maxSize)return;let r=this._tileKeysPerLevel.length-1;for(;o>this.maxSize&&r>=0;)r!==t&&(o=this._pruneAroundCenterTile(o,i,s,r)),r--;o>this.maxSize&&(o=this._pruneAroundCenterTile(o,i,s,t))}_pruneAroundCenterTile(t,i,s,o){const r=this._tileKeysPerLevel[o];if(!r||r.length===0)return t;const{size:n,origin:l}=this._tileInfoView.tileInfo,h=s*n[0],a=s*n[1],c=[0,0],u=[0,0];for(r.sort((d,I)=>(c[0]=l.x+h*(d.col+.5),c[1]=l.y-a*(d.row+.5),u[0]=l.x+h*(I.col+.5),u[1]=l.y-a*(I.row+.5),$(c,i)-$(u,i)));r.length>0;){const d=r.pop();if(this._removeTile(d.id),--t===this.maxSize)break}return t}_removeTile(t){const i=this._tilePerId.get(t);this._removedFunc&&i&&this._removedFunc(i),ee(this._tilePerId,t)}}function ee(e,t){e.delete(t)}const C=new z(0,0,0,0),w=new Map,X=[],U=[];let st=class{constructor(e){this._previousScale=Number.POSITIVE_INFINITY,this.cachePolicy="keep",this.coveragePolicy="closest",this.resampling=!0,this.tileIndex=new Map,this.tiles=[],this.buffer=192,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,e.resampling!=null&&(this.resampling=e.resampling),e.cachePolicy&&(this.cachePolicy=e.cachePolicy),e.coveragePolicy&&(this.coveragePolicy=e.coveragePolicy),e.buffer!=null&&(this.buffer=e.buffer),e.cacheSize&&(this._tileCache=new Ve(e.cacheSize,this.tileInfoView,t=>{this.releaseTile(t)}))}destroy(){this.tileIndex.clear()}update(e){var f,p;const{resampling:t,tileIndex:i}=this,{scale:s,center:o,resolution:r}=e.state,{minScale:n,maxScale:l}=this.tileInfoView,h=!e.stationary&&s>this._previousScale;if(this._previousScale=s,!t&&(s>n||s<l))return this.tiles.length=0,void this.clear();const a=this.tileInfoView.getTileCoverage(e.state,this.buffer,this.resampling,this.coveragePolicy);if(!a)return this.tiles.length=0,void this.clear();const{spans:c,lodInfo:u}=a,{level:d}=u;this.tiles.length=0,i.forEach(g=>g.visible=!0);let I=0,_=0;if(c.length>0)for(const{row:g,colFrom:L,colTo:O}of c)for(let E=L;E<=O;E++){I++;const x=C.set(d,g,u.normalizeCol(E),u.getWorldForColumn(E)).id;let S=i.get(x);if(S)S.isReady?(w.set(x,S),_++):h||this._addParentTile(x,w);else{if((f=this._tileCache)!=null&&f.has(x)){if(S=this._tileCache.pop(x),this.tileIndex.set(x,S),S.isReady){w.set(x,S),_++;continue}}else S=this.acquireTile(C),this.tileIndex.set(x,S);h||this._addParentTile(x,w)}}const y=_===I;for(const[g,L]of i){if(w.has(g))continue;C.set(g);const O=this.tileInfoView.intersects(a,C),E=this.cachePolicy==="purge"?C.level!==d:C.level>d;!O||!h&&y?!E&&O||X.push(L):L.isReady?E&&this.cachePolicy==="purge"&&this._hasReadyAncestor(C,d)?X.push(L):U.push(L):E&&X.push(L)}for(const g of U)g.isReady&&w.set(g.key.id,g);for(const g of X)this._tileCache?this._tileCache.add(g):this.releaseTile(g),i.delete(g.key.id);for(const g of w.values())this.tiles.push(g);for(const g of i.values())w.has(g.key.id)||(g.visible=!1);(p=this._tileCache)==null||p.prune(d,o,r),_e.pool.release(a),U.length=0,X.length=0,w.clear()}clear(){const{tileIndex:e}=this;for(const t of e.values())this.releaseTile(t);e.clear()}refresh(e){var t;for(const i of this.tileIndex.values())e(i);(t=this._tileCache)==null||t.clear()}updateCacheSize(e){this._tileCache&&(this._tileCache.maxSize=e)}_addParentTile(e,t){var o;let i=e,s=null;for(;i=this.tileInfoView.getTileParentId(i),i;)if(this.tileIndex.has(i)){if(s=this.tileIndex.get(i),s==null?void 0:s.isReady){t.has(s.key.id)||t.set(s.key.id,s);break}}else if((o=this._tileCache)!=null&&o.has(i)&&(s=this._tileCache.pop(i),this.tileIndex.set(i,s),s==null?void 0:s.isReady)){t.has(s.key.id)||t.set(s.key.id,s);break}}_hasReadyAncestor(e,t){const i=j();this.tileInfoView.getTileBounds(i,e,!0);for(const s of this.tileIndex.values())if(s.isReady&&s.key.level>=t&&s.key.level<e.level){const o=j();if(this.tileInfoView.getTileBounds(o,s.key,!0),Pe(o,i))return!0}return!1}};function W(e,t){if(!(this instanceof W))return new W(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&(typeof t=="function"?this.toBBox=t:this._initFormat(t)),this.clear()}function He(e,t,i){if(!i)return t.indexOf(e);for(var s=0;s<t.length;s++)if(i(e,t[s]))return s;return-1}function b(e,t){N(e,0,e.children.length,t,e)}function N(e,t,i,s,o){o||(o=Y(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var r,n=t;n<i;n++)r=e.children[n],k(o,e.leaf?s(r):r);return o}function k(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function te(e,t){return e.minX-t.minX}function ie(e,t){return e.minY-t.minY}function G(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function q(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Ue(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Ge(e,t){var i=Math.max(e.minX,t.minX),s=Math.max(e.minY,t.minY),o=Math.min(e.maxX,t.maxX),r=Math.min(e.maxY,t.maxY);return Math.max(0,o-i)*Math.max(0,r-s)}function K(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function D(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function Y(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function se(e,t,i,s,o){for(var r,n=[t,i];n.length;)(i=n.pop())-(t=n.pop())<=s||(r=t+Math.ceil((i-t)/s/2)*s,Ye(e,r,t,i,o),n.push(t,r,r,i))}W.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,i=[],s=this.toBBox;if(!D(e,t))return i;for(var o,r,n,l,h=[];t;){for(o=0,r=t.children.length;o<r;o++)n=t.children[o],D(e,l=t.leaf?s(n):n)&&(t.leaf?i.push(n):K(e,l)?this._all(n,i):h.push(n));t=h.pop()}return i},collides:function(e){var t=this.data,i=this.toBBox;if(!D(e,t))return!1;for(var s,o,r,n,l=[];t;){for(s=0,o=t.children.length;s<o;s++)if(r=t.children[s],D(e,n=t.leaf?i(r):r)){if(t.leaf||K(e,n))return!0;l.push(r)}t=l.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,i=e.length;t<i;t++)this.insert(e[t]);return this}var s=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===s.height)this._splitRoot(this.data,s);else{if(this.data.height<s.height){var o=this.data;this.data=s,s=o}this._insert(s,this.data.height-s.height-1,!0)}else this.data=s;return this},insert:function(e){return e!=null&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=Y([]),this},remove:function(e,t){if(e==null)return this;for(var i,s,o,r,n=this.data,l=this.toBBox(e),h=[],a=[];n||h.length;){if(n||(n=h.pop(),s=h[h.length-1],i=a.pop(),r=!0),n.leaf&&(o=He(e,n.children,t))!==-1)return n.children.splice(o,1),h.push(n),this._condense(h),this;r||n.leaf||!K(n,l)?s?(i++,n=s.children[i],r=!1):n=null:(h.push(n),a.push(i),i=0,s=n,n=n.children[0])}return this},toBBox:function(e){return e},compareMinX:te,compareMinY:ie,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var i=[];e;)e.leaf?t.push.apply(t,e.children):i.push.apply(i,e.children),e=i.pop();return t},_build:function(e,t,i,s){var o,r=i-t+1,n=this._maxEntries;if(r<=n)return b(o=Y(e.slice(t,i+1)),this.toBBox),o;s||(s=Math.ceil(Math.log(r)/Math.log(n)),n=Math.ceil(r/Math.pow(n,s-1))),(o=Y([])).leaf=!1,o.height=s;var l,h,a,c,u=Math.ceil(r/n),d=u*Math.ceil(Math.sqrt(n));for(se(e,t,i,d,this.compareMinX),l=t;l<=i;l+=d)for(se(e,l,a=Math.min(l+d-1,i),u,this.compareMinY),h=l;h<=a;h+=u)c=Math.min(h+u-1,a),o.children.push(this._build(e,h,c,s-1));return b(o,this.toBBox),o},_chooseSubtree:function(e,t,i,s){for(var o,r,n,l,h,a,c,u;s.push(t),!t.leaf&&s.length-1!==i;){for(c=u=1/0,o=0,r=t.children.length;o<r;o++)h=G(n=t.children[o]),(a=Ue(e,n)-h)<u?(u=a,c=h<c?h:c,l=n):a===u&&h<c&&(c=h,l=n);t=l||t.children[0]}return t},_insert:function(e,t,i){var s=this.toBBox,o=i?e:s(e),r=[],n=this._chooseSubtree(o,this.data,t,r);for(n.children.push(e),k(n,o);t>=0&&r[t].children.length>this._maxEntries;)this._split(r,t),t--;this._adjustParentBBoxes(o,r,t)},_split:function(e,t){var i=e[t],s=i.children.length,o=this._minEntries;this._chooseSplitAxis(i,o,s);var r=this._chooseSplitIndex(i,o,s),n=Y(i.children.splice(r,i.children.length-r));n.height=i.height,n.leaf=i.leaf,b(i,this.toBBox),b(n,this.toBBox),t?e[t-1].children.push(n):this._splitRoot(i,n)},_splitRoot:function(e,t){this.data=Y([e,t]),this.data.height=e.height+1,this.data.leaf=!1,b(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,i){var s,o,r,n,l,h,a,c;for(h=a=1/0,s=t;s<=i-t;s++)n=Ge(o=N(e,0,s,this.toBBox),r=N(e,s,i,this.toBBox)),l=G(o)+G(r),n<h?(h=n,c=s,a=l<a?l:a):n===h&&l<a&&(a=l,c=s);return c},_chooseSplitAxis:function(e,t,i){var s=e.leaf?this.compareMinX:te,o=e.leaf?this.compareMinY:ie;this._allDistMargin(e,t,i,s)<this._allDistMargin(e,t,i,o)&&e.children.sort(s)},_allDistMargin:function(e,t,i,s){e.children.sort(s);var o,r,n=this.toBBox,l=N(e,0,t,n),h=N(e,i-t,i,n),a=q(l)+q(h);for(o=t;o<i-t;o++)r=e.children[o],k(l,e.leaf?n(r):r),a+=q(l);for(o=i-t-1;o>=t;o--)r=e.children[o],k(h,e.leaf?n(r):r),a+=q(h);return a},_adjustParentBBoxes:function(e,t,i){for(var s=i;s>=0;s--)k(t[s],e)},_condense:function(e){for(var t,i=e.length-1;i>=0;i--)e[i].children.length===0?i>0?(t=e[i-1].children).splice(t.indexOf(e[i]),1):this.clear():b(e[i],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}};function Ke(e,{timeZone:t,timeExtent:i}){return{$view:{scale:e,timeZone:t,timeProperties:{currentStart:i==null?void 0:i.start,currentEnd:i==null?void 0:i.end}}}}class ge{constructor(t,i){this.key=new z(0,0,0,0),this.bounds=j(),this.objectIds=new Set,this.key.set(i);const s=t.getLODInfoAt(this.key);this.tileInfoView=t,this.tileInfoView.getTileBounds(this.bounds,this.key,!0),this.resolution=s.resolution,this.level=s.level,this.scale=s.scale,this.minScale=t.zoomToScale(s.level-1),this.maxScale=t.zoomToScale(s.level+1)}get lod(){return this.tileInfoView.getLODInfoAt(this.key)}get id(){return this.key.id}get extent(){return we(this.bounds,this.tileInfoView.tileInfo.spatialReference)}get transform(){return{originPosition:"upperLeft",scale:[this.resolution,this.resolution],translate:[this.bounds[0],this.bounds[3]]}}createArcadeEvaluationOptions(t){return Ke(this.scale,t)}createChildTiles(){const t=this.key.getChildKeys(),i=Me.acquire();for(let s=0;s<t.length;s++)i[s]=new ge(this.tileInfoView,t[s]);return i}getQuantizationParameters(){return Xe.fromJSON({mode:"view",originPosition:"upperLeft",tolerance:this.resolution,extent:{xmin:this.bounds[0],ymin:this.bounds[1],xmax:this.bounds[2],ymax:this.bounds[3],spatialReference:this.tileInfoView.tileInfo.spatialReference}})}}var oe,re,ne,le,he,ae,ce,ue,fe;(function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT",e[e.LABEL=4]="LABEL"})(oe||(oe={})),function(e){e[e.NONE=0]="NONE",e[e.MAP=1]="MAP",e[e.LABEL=2]="LABEL",e[e.LABEL_ALPHA=4]="LABEL_ALPHA",e[e.HITTEST=8]="HITTEST",e[e.HIGHLIGHT=16]="HIGHLIGHT",e[e.CLIP=32]="CLIP",e[e.DEBUG=64]="DEBUG",e[e.NUM_DRAW_PHASES=9]="NUM_DRAW_PHASES"}(re||(re={})),function(e){e[e.SIZE=0]="SIZE",e[e.COLOR=1]="COLOR",e[e.OPACITY=2]="OPACITY",e[e.ROTATION=3]="ROTATION"}(ne||(ne={})),function(e){e[e.MINMAX_TARGETS_OUTLINE=128]="MINMAX_TARGETS_OUTLINE",e[e.SCALE_TARGETS_OUTLINE=256]="SCALE_TARGETS_OUTLINE",e[e.FIELD_TARGETS_OUTLINE=512]="FIELD_TARGETS_OUTLINE",e[e.UNIT_TARGETS_OUTLINE=1024]="UNIT_TARGETS_OUTLINE"}(le||(le={})),function(e){e[e.SPRITE=0]="SPRITE",e[e.GLYPH=1]="GLYPH"}(he||(he={})),function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SIMPLE=1]="SIMPLE",e[e.DOT_DENSITY=2]="DOT_DENSITY",e[e.OUTLINE_FILL=3]="OUTLINE_FILL",e[e.OUTLINE_FILL_SIMPLE=4]="OUTLINE_FILL_SIMPLE",e[e.HEATMAP=5]="HEATMAP",e[e.PIE_CHART=6]="PIE_CHART"}(ae||(ae={})),function(e){e[e.All=0]="All",e[e.Highlight=1]="Highlight",e[e.InsideEffect=2]="InsideEffect",e[e.OutsideEffect=3]="OutsideEffect"}(ce||(ce={})),function(e){e[e.BATCHING=0]="BATCHING",e[e.STRICT_ORDER=1]="STRICT_ORDER",e[e.STRICT_MARKERS_AND_TEXT=2]="STRICT_MARKERS_AND_TEXT"}(ue||(ue={})),function(e){e[e.FILL=0]="FILL",e[e.LINE=1]="LINE",e[e.MARKER=2]="MARKER",e[e.TEXT=3]="TEXT"}(fe||(fe={}));export{fe as $,ce as J,ue as Q,st as U,_e as V,ne as W,he as Z,it as a,Ke as c,re as j,tt as k,ge as t,W as z};
