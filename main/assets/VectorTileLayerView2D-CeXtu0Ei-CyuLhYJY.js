import{ar as R,aW as me,bD as O,P as q,q as we,aM as k,B as be,ay as ve,J as N,cL as Te,M as Se,c6 as j,dD as Ie,kJ as xe,bw as G,x as Ce,v as Pe,m as X,E as De,n as Re}from"./index-BeTPrQ6f.js";import{C as Me,S as Le}from"./diffUtils-D3O4EfgX-CznKxD4n.js";import{T as ke}from"./workers-CixlqDQM-CMoJ1YZN.js";import{a as I}from"./Rect-DD6XS68q-D_hsV3ag.js";import{$ as pe,w as _e}from"./Texture-DLw7oaIg-fTsxdRzn.js";import{h as Q}from"./pbf-42TrGguk-Dw0lh_Mv.js";import{X as He}from"./rasterizingUtils-Cf1zdzIw-BfJyHaiy.js";import{s as x}from"./TileKey-BZu7Ia24-BiyRHU0x.js";import{i as Ue}from"./LRUCache-CvGiiws0-B3io5Jp4.js";import{t as M,o as D,s as Fe}from"./constants-t42rMCzy-Dlzs1Z4p.js";import{v as Y,m as Ae,B as ye}from"./Tile-BNoJIjzH-DZ-xZWMb.js";import{z as ze,v as qe,l as Be}from"./SymbolFader-Bp4Rc0g4-CvpmxMcz.js";import{p as ge}from"./TileInfo-BmHJ3kZT-BCenfvrA.js";import{e as J}from"./MapView-CrB-5KSL-IexKdUKM.js";import{U as Ve}from"./WGLContainer-CV7lovie-XGZSmlU_.js";import{c as Oe}from"./TileContainer-BIM43zRp-7nWripvu.js";import{O as Qe}from"./PooledRBush-CJtyGgW1-FNinHJNO.js";import{a as Ee,s as $e}from"./GraphicOrigin-BZpgptRb-BMZxic91.js";import{h as Z,p as ee}from"./SourceLayerData-Bj7ibB9F-B3LOrUgP.js";import{B as Ke}from"./GeometryUtils-C8-DjR3I-DcNL1Jc6.js";import{q as te,G as We}from"./StyleRepository-BkGEVTu--C5HgoPSx.js";import{F as Ne}from"./LayerView2D-D_-BpxcP-BHff6Xwh.js";import{t as je}from"./LayerView-DBq501tj-9r8g88Ff.js";import{n as Ge}from"./RefreshableLayerView-BoQ2vcWz-CCPPBuQI.js";import{r as se}from"./Scheduler-D_tOhFWn-SFGb1GBz.js";import"./Queue-CK6TduSr-C-T211SM.js";import"./intl-DRhjUnwt-Dihhq8dq.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./Cyclical-Bzwh_QaL-CXh-hbnA.js";import"./enums-DDJfd4_p-D3z9tmVA.js";import"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./defaultCIMValues-BWu-APou-XI-Li77m.js";import"./definitions-DVO21zOC-BwakNu1s.js";import"./MemCache-TG-MhOJy-BkjKRNR7.js";import"./ReactiveMap-cp6PWICM-990o5_5b.js";import"./signal-DHxLvooI-Bin-tnuW.js";import"./Query-DKLDaFaA-I4zhlfzt.js";import"./Field-Dn1Bgq7n-CJCGLoNR.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./arcadeUtils-BkvNBhzm-KzAaTYHA.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./config-C6w0VpIP-CfPhyZfw.js";import"./BufferObject-RHe5uojV-C-IINTcZ.js";import"./VertexArrayObject-BAcBN849-N8lUr7x7.js";import"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import"./TileKey-1TQKLvpf-ByD6Ad6n.js";import"./CollectionFlattener-DfZaIx8a-ADmwanro.js";import"./GraphicsCollection-CT-y6p3H-4XYPvC_j.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./jsxFactory-DN-m49_5-CUFCpKPo.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";import"./UpdatingHandles-XotKWqvb-CyHJIoZx.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./utils-DqlCEhl6-DBO0-7VG.js";import"./Version-DSJSGSLA-Cg87msWM.js";import"./Map-BgzFtTfu-BMsKSgj7.js";import"./Basemap-Dv-hYkd3-V8XC6wCN.js";import"./loadAll-B16dgL0--5EDWWWLE.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./isBasemap-CJN7v_Jq-Dgi2bMj-.js";import"./writeUtils-DKeM2R6Z-BUUAIn2U.js";import"./persistable-vgejqKb5-CBqfEqX1.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import"./resourceExtension-Boq2U56c-rXLaGMsr.js";import"./PolygonCollection-BEPfGuUm-Bu1vpYsn.js";import"./editableLayers-BTZOOiKD-ByJ-Oydo.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./TablesMixin-Cv7gcoNw-OtczYJk-.js";import"./HeightModelInfo-Cjals-AI-DMpn5Tsh.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./projectionUtils-BXtVkW1R-Dp6FsH61.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./mat2d-Cf4xHr3Z-u09Kv-lR.js";import"./mat2df64-VxtldH1S-CqyKAV7h.js";import"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import"./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js";import"./utils-CRANtbnc-C6zyufvL.js";import"./utils-t279O251-BBk6rV0U.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./vec2f32-hTAvipMV-C0AQcwEv.js";import"./a11yUtils-tU3tY6-a-CmHbThdR.js";import"./vec32-CI1xtKog-DFVYRcgb.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./imageUtils-DITyjHV4-jEv5aA2D.js";import"./capabilities-BaKzUyhi-B84We26i.js";import"./modeUtils-V6BDu_YT-Dq8o_RJK.js";import"./ColorBackground-C0DZs7p1-CENExjrO.js";import"./debugFlags-vZXEBr68-Bc51Oe-E.js";import"./Utils-CYY0kXyb-BZKnUtTY.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./VertexElementDescriptor-DLvjNrmQ-Cuvx5w94.js";import"./ProgramTemplate-BqCbl7jA-D5ymqDWS.js";import"./vec3f32-GX_cKsFD-UJPpzdNc.js";import"./Container-CO1X8bpa-BR9OVw9m.js";import"./EffectView-kLXORhA_-D7bXwfxF.js";import"./parser-CXoJuqeV-C7irlk5U.js";import"./earcut-C6NeZYSh-P2HUZ781.js";import"./featureConversionUtils-CZmIxyv5-DHwRSztU.js";import"./OptimizedFeature-C33SioFK-sn7DeAq-.js";import"./OptimizedGeometry-BYxlP_oK-DvAqrgO1.js";import"./OptimizedFeatureSet-Dz5hF8Qm-CgsRgxJh.js";import"./colorUtils-DlmOacVt-BnN0T6wa.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./layerViewUtils-BBTk5dU--BemaIlLi.js";const fe=Symbol("isVectorTileGraphicOrigin");function ie(i){return!!i&&fe in i}class L{constructor(e,t){this._width=0,this._height=0,this._free=[],this._width=e,this._height=t,this._free.push(new I(0,0,e,t))}get width(){return this._width}get height(){return this._height}allocate(e,t){if(e>this._width||t>this._height)return new I;let s=null,a=-1;for(let r=0;r<this._free.length;++r){const l=this._free[r];e<=l.width&&t<=l.height&&(s===null||l.y<=s.y&&l.x<=s.x)&&(s=l,a=r)}return s===null?new I:(this._free.splice(a,1),s.width<s.height?(s.width>e&&this._free.push(new I(s.x+e,s.y,s.width-e,t)),s.height>t&&this._free.push(new I(s.x,s.y+t,s.width,s.height-t))):(s.width>e&&this._free.push(new I(s.x+e,s.y,s.width-e,s.height)),s.height>t&&this._free.push(new I(s.x,s.y+t,e,s.height-t))),new I(s.x,s.y,e,t))}release(e){for(let t=0;t<this._free.length;++t){const s=this._free[t];if(s.y===e.y&&s.height===e.height&&s.x+s.width===e.x)s.width+=e.width;else if(s.x===e.x&&s.width===e.width&&s.y+s.height===e.y)s.height+=e.height;else if(e.y===s.y&&e.height===s.height&&e.x+e.width===s.x)s.x=e.x,s.width+=e.width;else{if(e.x!==s.x||e.width!==s.width||e.y+e.height!==s.y)continue;s.y=e.y,s.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}let re=class{constructor(i,e,t){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=i,this.height=e,this._glyphSource=t,this._binPack=new L(i-4,e-4),this._glyphData.push(new Uint8Array(i*e)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(i,e){const t=[],s=this._glyphSource,a=new Set,r=1/256;for(const n of e){const o=Math.floor(n*r);a.add(o)}const l=[];return a.forEach(n=>{const o=i+n;if(this._rangePromises.has(o))l.push(this._rangePromises.get(o));else{const h=s.getRange(i,n).then(()=>{this._rangePromises.delete(o)},()=>{this._rangePromises.delete(o)});this._rangePromises.set(o,h),l.push(h)}}),Promise.all(l).then(()=>{let n=this._glyphIndex[i];n||(n={},this._glyphIndex[i]=n);for(const o of e){const h=n[o];if(h){t[o]={sdf:!0,rect:h.rect,metrics:h.metrics,page:h.page,code:o};continue}const c=s.getGlyph(i,o);if(!(c!=null&&c.metrics))continue;const u=c.metrics;let d;if(u.width===0)d=new I(0,0,0,0);else{const p=u.width+6,_=u.height+6;let y=p%4?4-p%4:4,g=_%4?4-_%4:4;y===1&&(y=5),g===1&&(g=5),d=this._binPack.allocate(p+y,_+g),d.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new L(this.width-4,this.height-4),d=this._binPack.allocate(p+y,_+g));const w=this._glyphData[this._currentPage],T=c.bitmap;let m,b;if(T)for(let S=0;S<_;S++){m=p*S,b=this.width*(d.y+S+1)+d.x;for(let f=0;f<p;f++)w[b+f+1]=T.at(m+f)}}n[o]={rect:d,metrics:u,tileIDs:null,page:this._currentPage},t[o]={sdf:!0,rect:d,metrics:u,page:this._currentPage,code:o},this._dirties[this._currentPage]=!0}return t})}removeGlyphs(i){for(const e in this._glyphIndex){const t=this._glyphIndex[e];if(!t)continue;let s;for(const a in t)if(s=t[a],s.tileIDs.delete(i),s.tileIDs.size===0){const r=this._glyphData[s.page],l=s.rect;let n,o;for(let h=0;h<l.height;h++)for(n=this.width*(l.y+h)+l.x,o=0;o<l.width;o++)r[n+o]=0;delete t[a],this._dirties[s.page]=!0}}}bind(i,e,t,s=0){if(!this._textures[t]){const r=new pe(this.width,this.height);r.pixelFormat=6406,r.wrapMode=33071,this._textures[t]=new _e(i,r,new Uint8Array(this.width*this.height))}const a=this._textures[t];a.setSamplingMode(e),this._dirties[t]&&a.setData(this._glyphData[t]),i.bindTexture(a,s),this._dirties[t]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const i of this._textures)i&&i.dispose();this._textures.length=0}},B=class{constructor(i){if(this._metrics=[],!i)return void(this._allBitmaps=null);const e=new Map;let t=0;for(;i.next();)switch(i.tag()){case 1:{const r=i.getMessage();for(;r.next();)switch(r.tag()){case 3:{const l=r.getMessage();let n,o,h,c,u,d,p;for(;l.next();)switch(l.tag()){case 1:n=l.getUInt32();break;case 2:o=l.getBytes();break;case 3:h=l.getUInt32();break;case 4:c=l.getUInt32();break;case 5:u=l.getSInt32();break;case 6:d=l.getSInt32();break;case 7:p=l.getUInt32();break;default:l.skip()}if(l.release(),n){const _=(o==null?void 0:o.length)??0;this._metrics[n]={width:h,height:c,left:u,top:d,advance:p,startOffset:t,length:_},e.set(n,o),t+=_}break}default:r.skip()}r.release();break}default:i.skip()}const s=new Uint8Array(t),a=this._metrics;for(const[r,l]of e){const{startOffset:n,length:o}=a[r];if(l)for(let h=0;h<o;++h)s[n+h]=l[h]}this._allBitmaps=s}getMetrics(i){return this._metrics[i]}getBitmap(i){if(!this._allBitmaps)return;const e=this._metrics[i];if(e===void 0)return;const{startOffset:t,length:s}=e;return s!==0?new Ye(this._allBitmaps,t,s):void 0}},Xe=class{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(i){return this._ranges[i]}addRange(i,e){this._ranges[i]=e}},ae=class{constructor(i){this._glyphInfo={},this._baseURL=i}getRange(i,e){const t=this._getFontStack(i);if(t.getRange(e))return Promise.resolve();const s=256*e,a=s+255;if(this._baseURL){const r=this._baseURL.replace("{fontstack}",i).replace("{range}",s+"-"+a);return Pe(r,{responseType:"array-buffer"}).then(l=>{t.addRange(e,new B(new Q(new Uint8Array(l.data),new DataView(l.data))))}).catch(()=>{t.addRange(e,new B)})}return t.addRange(e,new B),Promise.resolve()}getGlyph(i,e){const t=this._getFontStack(i);if(!t)return;const s=Math.floor(e/256),a=t.getRange(s);return a?{metrics:a.getMetrics(e),bitmap:a.getBitmap(e)}:void 0}_getFontStack(i){let e=this._glyphInfo[i];return e||(e=this._glyphInfo[i]=new Xe),e}},Ye=class{constructor(i,e,t){this._array=i,this._start=e,this.length=t}at(i){return 0<=i&&i<this.length?this._array[this._start+i]:void 0}};const Je="dasharray-";class A{constructor(e,t,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,t<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=e,this._pageHeight=t,s>0&&(this._maxItemSize=s),this._binPack=new L(e-4,t-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const e of this._textures)e&&e.dispose();this._textures.length=0}getWidth(e){return e>=this._size.length?-1:this._size[e][0]}getHeight(e){return e>=this._size.length?-1:this._size[e][1]}getPageSize(e){return e>=this._size.length?null:this._size[e]}setSpriteSource(e){if(this.dispose(),this.pixelRatio=e.devicePixelRatio,this._mosaicsData.length===0){this._binPack=new L(this._pageWidth-4,this._pageHeight-4);const t=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight),a=new Uint32Array(t*s);this._mosaicsData[0]=a,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=e}getSpriteItem(e,t=!1){let s,a,r=this._mosaicRects[e];if(r)return r;if(!this._sprites||this._sprites.loadStatus!=="loaded"||(e&&e.startsWith(Je)?([s,a]=this._rasterizeDash(e),t=!0):s=this._sprites.getSpriteInfo(e),!(s!=null&&s.width)||!s.height||s.width<0||s.height<0))return null;const l=s.width,n=s.height,[o,h,c]=this._allocateImage(l,n);return o.width<=0?null:(this._copy(o,s,h,c,t,a),r={type:"sprite",rect:o,width:l,height:n,sdf:s.sdf,simplePattern:!1,rasterizationScale:s.pixelRatio??1,samplingMode:"Linear",page:h},this._mosaicRects[e]=r,r)}getSpriteItems(e){const t={};for(const s of e)t[s.name]=this.getSpriteItem(s.name,s.repeat);return t}getMosaicItemPosition(e,t){const s=this.getSpriteItem(e,t),a=s==null?void 0:s.rect;if(!a)return null;a.width=s.width,a.height=s.height;const r=s.width,l=s.height,n=2;return{tl:[a.x+n,a.y+n],br:[a.x+n+r,a.y+n+l],page:s.page}}bind(e,t,s=0,a=0){if(s>=this._size.length||s>=this._mosaicsData.length)return;if(!this._textures[s]){const l=new pe(this._size[s][0],this._size[s][1]);l.wrapMode=33071,this._textures[s]=new _e(e,l,new Uint8Array(this._mosaicsData[s].buffer))}const r=this._textures[s];r.setSamplingMode(t),this._dirties[s]&&r.setData(new Uint8Array(this._mosaicsData[s].buffer)),e.bindTexture(r,a),this._dirties[s]=!1}static _copyBits(e,t,s,a,r,l,n,o,h,c,u){let d=a*t+s,p=o*l+n;if(u){p-=l;for(let _=-1;_<=c;_++,d=((_+c)%c+a)*t+s,p+=l)for(let y=-1;y<=h;y++)r[p+y]=e[d+(y+h)%h]}else for(let _=0;_<c;_++){for(let y=0;y<h;y++)r[p+y]=e[d+y];d+=t,p+=l}}_copy(e,t,s,a,r,l){if(!this._sprites||this._sprites.loadStatus!=="loaded"||s>=this._mosaicsData.length)return;const n=new Uint32Array(l?l.buffer:this._sprites.image.buffer),o=this._mosaicsData[s],h=2,c=l?t.width:this._sprites.width;A._copyBits(n,c,t.x,t.y,o,a[0],e.x+h,e.y+h,t.width,t.height,r),this._dirties[s]=!0}_allocateImage(e,t){e+=2,t+=2;const s=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<s){const n=new I(0,0,e,t);return this._mosaicsData.push(new Uint32Array(e*t)),this._dirties.push(!0),this._size.push([e,t]),this._textures.push(void 0),[n,this._mosaicsData.length-1,[e,t]]}let a=e%4?4-e%4:4,r=t%4?4-t%4:4;a===1&&(a=5),r===1&&(r=5);const l=this._binPack.allocate(e+a,t+r);return l.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new L(this._pageWidth-4,this._pageHeight-4),this._allocateImage(e,t)):[l,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(e){const t=/\[(.*?)\]/,s=e.match(t);if(!s)return null;const a=s[1].split(",").map(Number),r=e.slice(e.lastIndexOf("-")+1),[l,n,o]=He(a,r);return[{x:0,y:0,width:n,height:o,sdf:!0,pixelRatio:1},new Uint8Array(l.buffer)]}}let Ze=class{constructor(i,e,t,s){this._layer=i,this._styleRepository=e,this.devicePixelRatio=t,this._sourceDataMaxLOD=s,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){var i,e,t;(i=this._connection)==null||i.close(),this._connection=null,this._styleRepository=null,this._layer=null,(e=this._spriteMosaic)==null||e.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=ve(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&((t=this._startOptionsInputSignal)==null||t.removeEventListener("abort",this._inputSignalEventListener)),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}async start(i){this._requestSprite(i);const e=this._layer.currentStyleInfo.glyphsUrl,t=new ae(e?N(e,{...this._layer.customParameters,token:this._layer.apiKey}):null);this._glyphMosaic=new re(1024,1024,t),this._broadcastPromise=ke("WorkerTileHandler",{client:this,schedule:i.schedule,signal:i.signal}).then(s=>{var a;if(this._layer&&((a=this._connection)==null||a.close(),this._connection=s,this._layer&&!this._connection.closed)){const r=s.broadcast("setStyle",{style:this._layer.currentStyleInfo.style,sourceDataMaxLOD:this._sourceDataMaxLOD},i);Promise.all(r).catch(l=>Te(l))}})}_requestSprite(i){var r,l;(r=this._spriteSourceAbortController)==null||r.abort();const e=new AbortController;this._spriteSourceAbortController=e;const t=i==null?void 0:i.signal;this._inputSignalEventListener&&((l=this._startOptionsInputSignal)==null||l.removeEventListener("abort",this._inputSignalEventListener)),this._startOptionsInputSignal=null,t&&(this._inputSignalEventListener=et(e),t.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:s}=e,a={...i,signal:s};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,a),this._spriteSourcePromise.then(n=>{Se(s),this._spriteMosaic=new A(1024,1024,250),this._spriteMosaic.setSpriteSource(n)})}async updateStyle(i){const e=[];for(const t of i)t.type===4?e.push({type:4,data:{spriteSource:null}}):e.push(t);return await this._broadcastPromise,this._broadcastPromise=Promise.all(this._connection.broadcast("updateStyle",e)),this._broadcastPromise}setSpriteSource(i){const e=new A(1024,1024,250);return e.setSpriteSource(i),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(i),this._spriteSourceAbortController=null,e}async setStyle(i,e,t){await this._broadcastPromise,this._styleRepository=i,this._sourceDataMaxLOD=t,this._requestSprite();const s=new ae(this._layer.currentStyleInfo.glyphsUrl?N(this._layer.currentStyleInfo.glyphsUrl,{...this._layer.customParameters,token:this._layer.apiKey}):null);return this._glyphMosaic=new re(1024,1024,s),this._broadcastPromise=Promise.all(this._connection.broadcast("setStyle",{style:e,sourceDataMaxLOD:this._sourceDataMaxLOD})),this._broadcastPromise}async fetchTileData(i,e){const t=await this._getRefKeys(i,e);return this._getSourcesData(Object.keys(this._layer.sourceNameToSource),t,e)}async fetchTilePBFs(i){const e=Object.keys(this._layer.sourceNameToSource),t={},s=await this._getRefKeys(i,t),a=[],r=[];for(let l=0;l<s.length;l++)if(s[l].value==null||e[l]==null)r.push(null);else{const n=s[l].value,o=this._getTilePayload(n,e[l],t);o.then(h=>{a.push({...h,key:n})}),r.push(o)}return Promise.all(r).then(()=>a)}async parseTileData(i,e){const t=i&&i.data;if(!t)return null;const{sourceName2DataAndRefKey:s,transferList:a}=t;return Object.keys(s).length===0?null:this._broadcastPromise.then(()=>this._connection.invoke("createTileAndParse",{key:i.key.id,sourceName2DataAndRefKey:s,styleLayerUIDs:i.styleLayerUIDs},{...e,transferList:a}))}async getSprites(i){return await this._spriteSourcePromise,this._spriteMosaic.getSpriteItems(i)}getGlyphs(i){return this._glyphMosaic.getGlyphItems(i.font,i.codePoints)}async _getTilePayload(i,e,t){const s=x.pool.acquire(i.id),a=this._layer.sourceNameToSource[e],{level:r,row:l,col:n}=s;x.pool.release(s);try{return{protobuff:await a.requestTile(r,l,n,t),sourceName:e}}catch(o){if(O(o))throw o;return{protobuff:null,sourceName:e}}}async _getRefKeys(i,e){const t=this._layer.sourceNameToSource,s=new Array;for(const a in t){const r=t[a].getRefKey(i,e);s.push(r)}return j(s)}_getSourcesData(i,e,t){const s=[];for(let a=0;a<e.length;a++)if(e[a].value==null||i[a]==null)s.push(null);else{const r=e[a].value,l=this._getTilePayload(r,i[a],t);s.push(l)}return j(s).then(a=>{const r={},l=[];for(let n=0;n<a.length;n++){const o=a[n].value;if(o&&o.protobuff&&o.protobuff.byteLength>0){const h=e[n].value.id;r[o.sourceName]={refKey:h,protobuff:o.protobuff},l.push(o.protobuff)}}return{sourceName2DataAndRefKey:r,transferList:l}})}};function et(i){return()=>i.abort()}const tt=1e-6,st=(i,e)=>i+1/(1<<2*e);let le=class{constructor(i,e){this._tiles=new Map,this._tileCache=new Ue(40,t=>t.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=i.acquireTile,this.releaseTile=i.releaseTile,this.tileInfoView=i.tileInfoView,this._container=e}destroy(){for(const i of this._tiles.values())i.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(i){this._updateCacheSize(i);const e=this.tileInfoView,t=e.getTileCoverage(i.state,0,!0,"smallest");if(!t)return!0;const{spans:s,lodInfo:a}=t,{level:r}=a,l=this._tiles,n=new Set,o=new Set;for(const{row:c,colFrom:u,colTo:d}of s)for(let p=u;p<=d;p++){const _=x.getId(r,c,a.normalizeCol(p),a.getWorldForColumn(p)),y=this._getOrAcquireTile(_);n.add(_),y.processed()?this._addToContainer(y):o.add(new x(_))}for(const[c,u]of l)u.isCoverage=n.has(c);for(const c of o)this._findPlaceholdersForMissingTiles(c,n);let h=!1;for(const[c,u]of l)u.neededForCoverage=n.has(c),u.neededForCoverage||u.isHoldingForFade&&e.intersects(t,u.key)&&n.add(c),u.isFading&&(h=!0);for(const c of this._tiles.keys())n.has(c)||this._releaseTile(c);return ye.pool.release(t),!h}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(i,e,t,s,a){const r=[0,0],l=[0,0];s.toMap(r,i-t,e+t),s.toMap(l,i+t,e-t);const n=Math.min(r[0],l[0]),o=Math.min(r[1],l[1]),h=Math.max(r[0],l[0]),c=Math.max(r[1],l[1]),u=Ie(n,o,h,c),d=k(),p=[];for(const _ of this._visibleTiles.values())this.tileInfoView.getTileBounds(d,_.key),xe(u,d)&&p.push(_);if(a!=null&&a.length>0){const _=new Set(p.map(g=>g.id)),y=a.filter(g=>!_.has(g.tileKey.id)).map(g=>this._visibleTiles.get(g.tileKey.id)).filter(g=>g!==void 0);p.push(...y)}return p}_findPlaceholdersForMissingTiles(i,e){const t=[];for(const a of this._tiles.values())this._addPlaceholderChild(t,a,i,e);const s=t.reduce(st,0);Math.abs(1-s)<tt||this._addPlaceholderParent(i.id,e)}_addPlaceholderChild(i,e,t,s){e.key.level<=t.level||!e.hasData()||rt(t,e.key)&&(this._addToContainer(e),s.add(e.id),i.push(e.key.level-t.level))}_addPlaceholderParent(i,e){const t=this._tiles;let s=i;for(;;){if(s=it(s),!s||e.has(s))return;const a=t.get(s);if(a!=null&&a.hasData())return this._addToContainer(a),void e.add(a.id)}}_getOrAcquireTile(i){let e=this._tiles.get(i);return e||(e=this._tileCache.pop(i),e||(e=this.acquireTile(new x(i))),this._tiles.set(i,e),e)}_releaseTile(i){const e=this._tiles.get(i);this.releaseTile(e),this._removeFromContainer(e),this._tiles.delete(i),e.hasData()?this._tileCache.put(i,e,1):e.dispose()}_addToContainer(i){let e;const t=[],s=this._container;if(s.contains(i))return;const a=this._visibleTiles;for(const r of a.values())this._canConnectDirectly(i,r)&&t.push(r),e==null&&this._canConnectDirectly(r,i)&&(e=r);if(e!=null){for(const r of t)e.childrenTiles.delete(r),i.childrenTiles.add(r),r.parentTile=i;e.childrenTiles.add(i),i.parentTile=e}else for(const r of t)i.childrenTiles.add(r),r.parentTile=i;a.set(i.id,i),s.addChild(i)}_removeFromContainer(i){if(this._visibleTiles.delete(i.id),this._container.removeChild(i),i.parentTile!=null){i.parentTile.childrenTiles.delete(i);for(const e of i.childrenTiles)i.parentTile!=null&&i.parentTile.childrenTiles.add(e)}for(const e of i.childrenTiles)e.parentTile=i.parentTile;i.parentTile=null,i.childrenTiles.clear()}_canConnectDirectly(i,e){const t=i.key;let{level:s,row:a,col:r,world:l}=e.key;const n=this._visibleTiles;for(;s>0;){if(s--,a>>=1,r>>=1,t.level===s&&t.row===a&&t.col===r&&t.world===l)return!0;if(n.has(`${s}/${a}/${r}/${l}`))return!1}return!1}_updateCacheSize(i){const e=i.state.size;if(e[0]===this._viewSize[0]&&e[1]===this._viewSize[1])return;const t=Math.ceil(e[0]/D)+1,s=Math.ceil(e[1]/D)+1;this._viewSize[0]=e[0],this._viewSize[1]=e[1],this._tileCache.maxSize=5*t*s}};function it(i){const[e,t,s,a]=i.split("/"),r=parseInt(e,10);return r===0?null:`${r-1}/${parseInt(t,10)>>1}/${parseInt(s,10)>>1}/${parseInt(a,10)}`}function rt(i,e){const t=e.level-i.level;return i.row===e.row>>t&&i.col===e.col>>t&&i.world===e.world}let at=class extends Ve{_createTransforms(){return{displayViewScreenMat3:J(),tileMat3:J()}}};const z=1e-6;function ne(i,e){if(i){const t=i.getLayoutProperty("visibility");if(!t||t.getValue()!==1&&(i.minzoom===void 0||i.minzoom<e+z)&&(i.maxzoom===void 0||i.maxzoom>=e-z))return!0}return!1}class lt extends Oe{constructor(e){super(e),this._backgroundTiles=[],this._computeDisplayInfoView(e)}destroy(){var e,t;super.destroy(),this.removeAllChildren(),(e=this._spriteMosaic)==null||e.dispose(),this._spriteMosaic=null,(t=this._glyphMosaic)==null||t.dispose(),this._glyphMosaic=null,this._symbolFader!=null&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){var e;return((e=this._symbolFader)==null?void 0:e.fading)??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){var e;return(e=this._symbolFader)==null?void 0:e.symbolRepository}setStyleResources(e,t,s,a){if(this._spriteMosaic=e,this._glyphMosaic=t,this._styleRepository=s,this.tileInfoView=a,this._computeDisplayInfoView(a),this._symbolFader==null){const r=(l,n)=>{l.allSymbolsFadingOut=!0,l.lastOpacityUpdate=n,Be(l,n,!0),l.decluttered=!0,l.requestRender()};this._symbolFader=new qe("vector-tile",this._styleRepository,r,this.children,M)}this._symbolFader.styleRepository=s}setSpriteMosaic(e){var t;(t=this._spriteMosaic)==null||t.dispose(),this._spriteMosaic=e}deleteStyleLayers(e){this._symbolFader!=null&&this._symbolFader.deleteStyleLayers(e)}createRenderParams(e){return{...super.createRenderParams(e),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(e){!this.visible||e.drawPhase!==1&&e.drawPhase!==64||this._spriteMosaic===void 0||super.doRender(e)}addChild(e){return super.addChild(e),this._symbolFader!=null?this._symbolFader.addTile(e):e.decluttered=!0,this.requestRender(),e}removeChild(e){return this._symbolFader!=null&&this._symbolFader.removeTile(e),this.requestRender(),super.removeChild(e)}renderChildren(e){const{drawPhase:t}=e;t!==64?this._doRender(e):super.renderChildren(e)}removeAllChildren(){for(let e=0;e<this.children.length;e++){const t=this.children[e];this._symbolFader!=null&&this._symbolFader.removeTile(t),t.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(e=>e.neededForCoverage&&e.hasData())}restartDeclutter(){this._symbolFader!=null&&this._symbolFader.restartDeclutter()}_doRender(e){const{context:t,state:s}=e,a=this._styleRepository;if(!a)return;const r=a.layers,l=this._displayInfo.scaleToZoom(s.scale);a.backgroundBucketIds.length>0&&(e.renderPass="background",this._renderBackgroundLayers(e,a.backgroundBucketIds,l)),super.renderChildren(e),e.drawPhase===1&&this._fade(l,s);const n=this.children.filter(o=>o.visible&&o.hasData());if(!n||n.length===0)return t.bindVAO(null),t.setStencilTestEnabled(!0),void t.setBlendingEnabled(!0);for(const o of n)o.triangleCount=0;t.setStencilWriteMask(0),t.setColorMask(!0,!0,!0,!0),t.setStencilOp(7680,7680,7681),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!1),t.setDepthTestEnabled(!0),t.setDepthWriteEnabled(!0),t.setDepthFunction(515),t.setClearDepth(1),t.clear(256),e.renderPass="opaque";for(let o=r.length-1;o>=0;o--)this._renderStyleLayer(r[o],e,n);t.setDepthWriteEnabled(!1),t.setBlendingEnabled(!0),t.setBlendFunctionSeparate(1,771,1,771),e.renderPass="translucent";for(let o=0;o<r.length;o++)this._renderStyleLayer(r[o],e,n);t.bindVAO(null),t.setStencilTestEnabled(!0),t.setBlendingEnabled(!0);for(const o of n)o.debugInfo.display.triangleCount=o.triangleCount}_fade(e,t){this._symbolFader!=null&&(this._symbolFader.update(e,t)||this.requestRender())}_renderStyleLayer(e,t,s){const{displayLevel:a,painter:r,renderPass:l}=t;if(e===void 0)return;const n=e.getLayoutProperty("visibility");if(n&&n.getValue()===1)return;let o;switch(e.type){case 0:return;case 1:if(l!=="opaque"&&t.renderPass!=="translucent")return;o="vtlFill";break;case 2:if(l!=="translucent")return;o="vtlLine";break;case 4:if(l!=="translucent")return;o="vtlCircle";break;case 3:if(l!=="translucent")return;o="vtlSymbol"}if(s=e.type===3?s.filter(c=>c.decluttered):s.filter(c=>c.neededForCoverage),o!=="vtlSymbol"&&(s.length===0||e.minzoom!==void 0&&e.minzoom>=a+z||e.maxzoom!==void 0&&e.maxzoom<a-z))return;const h=e.uid;t.styleLayerUID=h,t.styleLayer=e;for(const c of s)if(c.layerData.has(h)){r.renderObjects(t,s,o);break}}_renderBackgroundLayers(e,t,s){const{context:a,painter:r,state:l}=e,n=this._styleRepository;let o=!1;for(const m of t)if(n.getLayerById(m).type===0&&ne(n.getLayerById(m),s)){o=!0;break}if(!o)return;const h=this.tileInfoView,c=h.getTileCoverage(e.state,0,!0,"smallest"),{spans:u,lodInfo:d}=c,{level:p}=d,_=k(),y=[];if(this._renderPasses){const m=this._renderPasses[0];this._clippingInfos!=null&&(m.brushes[0].prepareState(e),m.brushes[0].drawMany(e,this._clippingInfos))}const g=this._backgroundTiles;let w,T=0;for(const{row:m,colFrom:b,colTo:S}of u)for(let f=b;f<=S;f++){if(T<g.length)w=g[T],w.key.set(p,m,d.normalizeCol(f),d.getWorldForColumn(f)),h.getTileBounds(_,w.key,!1),w.x=_[0],w.y=_[3],w.resolution=h.getTileResolution(p);else{const C=new x(p,m,d.normalizeCol(f),d.getWorldForColumn(f)),P=h.getTileBounds(k(),C),H=h.getTileResolution(p);w=new at(C,H,P[0],P[3],D,D,M,M),g.push(w)}w.setTransform(l),y.push(w),T++}a.setStencilWriteMask(0),a.setColorMask(!0,!0,!0,!0),a.setStencilOp(7680,7680,7681),a.setStencilFunction(514,0,255),a.setStencilTestEnabled(!0);for(const m of t){const b=n.getLayerById(m);b.type===0&&ne(b,s)&&(e.styleLayerUID=b.uid,e.styleLayer=b,r.renderObjects(e,y,"vtlBackground"))}ye.pool.release(c)}_computeDisplayInfoView(e){let t=e.tileInfo.lods[0].scale;const s=Math.max(25,e.tileInfo.lods.length),a=[];for(let r=0;r<=s;r++)a.push(t),t/=2;this._displayInfo=ge.create({scales:a,size:D,spatialReference:e.spatialReference,numLODs:s})}}var oe;class he extends Ee{get[(oe=fe,$e)](){return this.layer}constructor(e,t,s){super(),this[oe]=!0,this.type="vector-tile",this.layer=e,this.layerId=t,this.layerIndex=s}get id(){return`${this.layer.id}:__${this.layerId}__:__${this.layerIndex}__`}}const nt=(i,e)=>{const t=i.vtlSymbol.sourceTile,s=e.vtlSymbol.sourceTile;return t.level!==s.level?t.level-s.level:t.row!==s.row?t.row-s.row:t.col!==s.col?t.col-s.col:i.styleLayerUID-e.styleLayerUID};class E{constructor(e,t,s,a,r){this.tileKey=e,this._tileLayerData=t,this._styleRepository=s,this._tileHandler=a,this._parentLayer=r,this._index=null,this._tileKeyToPBF=new Map}static create(e,t,s,a,r){return new E(e,t,s,a,r)}clear(){var e;(e=this._index)==null||e.clear(),this._tileKeyToPBF.clear()}async queryAttributes(e,t,s,a,r){if(this._tileLayerData.size===0||!this._styleRepository||!this._tileHandler)return[];this._index===null&&(this._index=new Qe(100,ot),await this._indexLayers());const l=[];return this._queryIndex(l,e,t,s,this.tileKey.level,a),r&&(r==null?void 0:r.length)>0&&await this._getSymbolsAttributes(l,r),l}async _indexLayers(){const e=this.tileKey,t=this._styleRepository.layers,s=await this._getTilePayload(e);for(const[a,r]of this._tileLayerData){const l=t[a],n=s.find(c=>c.sourceName===l.source);if(!n)continue;const{protobuff:o,key:h}=n;if(r.type!==3){const c=1<<e.level-h.level,u=e.row-h.row*c,d=e.col-h.col*c;this._indexLayer(l,o,e.level,c,u,d)}}}_indexLayer(e,t,s,a,r,l){const n=e.sourceLayer,o=e.getFeatureFilter(),h=s,c=s+1,u=Ke(h),d=new Q(new Uint8Array(t),new DataView(t));for(;d.next();)switch(d.tag()){case 3:{const p=d.getMessage(),_=new Z(p);if(p.release(),_.name!==n)continue;const y=_.getData(),g=_.extent/a,w=g*l-u,T=g*r-u,m=w+g+2*u,b=T+g+2*u,S=g/D,f=M/g,C=g*l,P=g*r;for(;y.nextTag(2);){const H=y.getMessage(),U=new ee(H,_);if(H.release(),o&&!o.filter(U,s))continue;const $=U.values||{},K=$._minzoom,W=$._maxzoom;if(K&&K>=10*c||W&&W<=10*h)continue;const v=e.getFeatureInflatedBounds(U,h,_.extent,S);v==null||v[0]>m||v[1]>b||v[2]<w||v[3]<T||(v[0]=(v[0]-C)*f,v[1]=(v[1]-P)*f,v[2]=(v[2]-C)*f,v[3]=(v[3]-P)*f,this._index.insert(new We(e,U,v,f,C,P)))}break}default:d.skip()}d.release()}async _getSymbolsAttributes(e,t){if(!t||t.length===0)return e;const s=[];if(t.sort(nt),t.length>0){let r=0,{styleLayerUID:l}=t[0];for(let o=1;o<t.length;o++){const{styleLayerUID:h}=t[o];h!==l&&(s.push({from:r,to:o,styleLayerUID:l,sourceTileKey:t[o-1].vtlSymbol.sourceTile}),r=o,l=h)}const n=t.length-1;s.push({from:r,to:t.length,styleLayerUID:l,sourceTileKey:t[n].vtlSymbol.sourceTile})}const a=this._styleRepository.layers;for(const r of s){const l=await this._getTilePayload(r.sourceTileKey),n=a[r.styleLayerUID],o=!!n&&l.find(h=>h.sourceName===n.source);o&&this._addSymbolsAttributes(e,t.slice(r.from,r.to).map(h=>h.vtlSymbol.featureIndex),r.styleLayerUID,o)}return e}_addSymbolsAttributes(e,t,s,a){const r=this._styleRepository.layers,l=a.key,n=this.tileKey,o=1<<n.level-l.level,h=n.row-l.row*o,c=n.col-l.col*o;this._getSymbolAttributes(a.protobuff,t,s,o,h,c).forEach(u=>{const{attributes:d,tilePoint:p}=u;e.push({layerId:r[s].id,layerIndex:s,graphic:new G({attributes:d,origin:new he(this._parentLayer,r[s].id,s)}),tilePoint:p})})}_getSymbolAttributes(e,t,s,a,r,l){const n=[],o=this._styleRepository.layers;let h=0;t.sort((u,d)=>u-d);const c=new Q(new Uint8Array(e),new DataView(e));for(;c.next();)switch(c.tag()){case 3:{const u=c.getMessage(),d=new Z(u);if(u.release(),d.name!==o[s].sourceLayer)continue;const p=d.getData(),_=d.extent/a,y=M/_,g=_*l,w=_*r;let T=0;for(;p.nextTag(2);){const m=p.getMessage();if(T++===t[h]){const b=new ee(m,d),S=b.values,f=b.getGeometry(),C=f!=null?[y*(f[0][0].x-g),y*(f[0][0].y-w)]:null;n.push({attributes:S,tilePoint:C}),h++}if(m.release(),h===t.length)return n}break}default:c.skip()}return c.release(),n}_queryIndex(e,t,s,a,r,l){var o;const n=Fe*a*(window.devicePixelRatio||1);return(o=this._index)==null||o.search({minX:t-n,minY:s-n,maxX:t+n,maxY:s+n},h=>{const{layer:c,feature:u}=h;c.isIntersectingFeature(t,s,a,u,r,l,h)&&e.push({layerId:c.id,layerIndex:c.uid,tilePoint:null,graphic:new G({attributes:u.values,origin:new he(this._parentLayer,h.layer.id,h.layer.uid)})})}),e}async _getTilePayload(e){return Ce(this._tileKeyToPBF,e.id,()=>this._tileHandler.fetchTilePBFs(e)).then(t=>t)}}const ot=i=>({minX:i.bounds[0],minY:i.bounds[1],maxX:i.bounds[2],maxY:i.bounds[3]});class ce extends Ae{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(e){const t=x.pool.acquire(e),s=t.level===0?null:x.getId(t.level-1,t.row>>1,t.col>>1,t.world);return x.pool.release(t),s}getTileCoverage(e,t,s=!0,a){const r=super.getTileCoverage(e,t,s,a);if(!r)return r;const l=1<<r.lodInfo.level;return r.spans=r.spans.filter(n=>n.row>=0&&n.row<l),r}scaleToLevel(e){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[e])return this._levelByScale[e];{const t=this._fullCacheLodInfos;if(e>t[0].scale)return t[0].level;let s,a;for(let r=0;r<t.length-1;r++)if(a=t[r+1],e>a.scale)return s=t[r],s.level+(s.scale-e)/(s.scale-a.scale);return t[t.length-1].level}}_initializeFullCacheLODs(e){let t;if(e[0].level===0)t=e.map(s=>({level:s.level,resolution:s.resolution,scale:s.scale}));else{const s=this.tileInfo.size[0],a=this.tileInfo.spatialReference;t=ge.create({size:s,spatialReference:a}).lods.map(r=>({level:r.level,resolution:r.resolution,scale:r.scale}))}for(let s=0;s<t.length;s++)this._levelByScale[t[s].scale]=t[s].level;this._fullCacheLodInfos=t}}const V=2,ue=8,de=512;let F=class extends Ge(Ne(je)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._styeChanged=!1,this._spriteSourceChanged=!1}get fading(){var i;return((i=this._vectorTileContainer)==null?void 0:i.fading)??!1}get hasVisibleFeatures(){const i=this._vectorTileContainer.children;for(const e of i)if(e.hasFeatures())return!0;return!1}get spriteSourceChanged(){return this._spriteSourceChanged}get styleChanged(){return this._styeChanged}async hitTest(i,e){var c,u;const t=this._tileHandlerPromise,s=(c=this._vectorTileContainer)==null?void 0:c.symbolFader;if(!t||!this._isTileHandlerReady||!s)return;await t;let a=null;const r=(u=this._vectorTileContainer)==null?void 0:u.symbolRepository;r&&(a=r.querySymbols(e,V,s.decluttererOffset,{}));const l=this.view.state,n=this._tileManager.getIntersectingTiles(e.x,e.y,V,l,a);if((!n||n.length===0)&&(a==null?void 0:a.length)===0)return null;i=i.clone().normalize();const o=[],h=[];for(const d of n)o.push(this._queryTile(h,i,V,this.view.state.rotation,d,a==null?void 0:a.filter(p=>p.tileKey.id===d.id)));return await Promise.all(o),h}update(i){if(this._tileHandlerPromise&&this._isTileHandlerReady)return i.pixelRatio!==this._tileHandler.devicePixelRatio?(this._tileHandler.devicePixelRatio=i.pixelRatio,void this._loadStyle()):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._pauseQueues(),this._fetchQueue.state=i.state,this._parseQueue.state=i.state,this._tileManager.update(i)||this.requestUpdate(),this._resumeQueues()))}attach(){const{style:i}=this.layer.currentStyleInfo;this._styleRepository=new te(i),this._tileInfoView=new ce(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new lt(this._tileInfoView),this._tileHandler=new Ze(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",e=>{var t,s;if(this._styeChanged=!0,e.isDataDriven)this._styleChanges.push({type:0,data:e}),this.requestUpdate();else{const a=this._styleRepository,r=a.getLayerById(e.layer);if(!r)return;const l=r.type===3;a.setPaintProperties(e.layer,e.paint),l&&((t=this._vectorTileContainer)==null||t.restartDeclutter()),(s=this._vectorTileContainer)==null||s.requestRender()}}),this.layer.on("layout-change",e=>{var r,l;const t=this._styleRepository,s=t.getLayerById(e.layer);if(!s)return;this._styeChanged=!0;const a=Me(s.layout,e.layout);if(a!=null){if(Le(a,"visibility")&&ht(a)===1)return t.setLayoutProperties(e.layer,e.layout),s.type===3&&((r=this._vectorTileContainer)==null||r.restartDeclutter()),void((l=this._vectorTileContainer)==null?void 0:l.requestRender());this._styleChanges.push({type:1,data:e}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",e=>{var a,r;const t=this._styleRepository,s=t.getLayerById(e.layer);s&&(this._styeChanged=!0,t.setStyleLayerVisibility(e.layer,e.visibility),s.type===3&&((a=this._vectorTileContainer)==null||a.restartDeclutter()),(r=this._vectorTileContainer)==null||r.requestRender())}),this.layer.on("style-layer-change",e=>{this._styleChanges.push({type:2,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("delete-style-layer",e=>{this._styleChanges.push({type:3,data:e}),this._styeChanged=!0,this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",e=>{this._spriteSourceChanged=!0,this._styleChanges.push({type:4,data:e});const t=this._styleRepository.layers;for(const s of t)switch(s.type){case 3:s.getLayoutProperty("icon-image")&&this._styleChanges.push({type:1,data:{layer:s.id,layout:s.layout}});break;case 2:s.getPaintProperty("line-pattern")&&this._styleChanges.push({type:0,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}});break;case 1:s.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:0,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=R(this._vectorTileContainer),this._tileHandler=R(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(i){var e;return me((e=this.layer.tileInfo)==null?void 0:e.spatialReference,i)}canResume(){let i=super.canResume();const{currentStyleInfo:e}=this.layer;if(i&&(e!=null&&e.layerDefinition)){const t=this.view.scale,{minScale:s,maxScale:a}=e.layerDefinition;e!=null&&e.layerDefinition&&(s&&s<t&&(i=!1),a&&a>t&&(i=!1))}return i}isUpdating(){return this.fading}acquireTile(i){const e=this._createVectorTile(i);return this._updatingHandles.addPromise(this._fetchQueue.push(e.key).then(t=>this._parseQueue.push({key:e.key,data:t})).then(t=>{e.once("attach",()=>this.requestUpdate()),e.setData(t),this.requestUpdate()}).catch(t=>{O(t)||q.getLogger(this).error(t)})),e}releaseTile(i){const e=i.key.id;this._fetchQueue.abort(e),this._parseQueue.abort(e),this.requestUpdate()}async doRefresh(){if(!this.attached)return;if(this.suspended)return this._tileManager.clear(),void this.requestUpdate();this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache(),this._resumeQueues();const i=this._vectorTileContainer.children,e=[];try{for(const t of i){const s=this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(a=>this._parseQueue.push({key:t.key,data:a})).then(a=>t.setData(a)).finally(()=>t.featureIndex=null));e.push(s)}await Promise.all(e)}catch(t){q.getLogger(this).error("error refreshing vector-tiles layer-view",t),this._resumeQueues(),this._isTileHandlerReady=!0}this._isTileHandlerReady=!0,this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new le({acquireTile:t=>this.acquireTile(t),releaseTile:t=>this.releaseTile(t),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const i=new AbortController,e=this._tileHandler.start({signal:i.signal}).then(()=>{this._fetchQueue=new Y({tileInfoView:this._tileInfoView,process:(t,s)=>this._getTileData(t,s),concurrency:15,scheduler:this.scheduler,priority:se.MAPVIEW_FETCH_QUEUE}),this._parseQueue=new Y({tileInfoView:this._tileInfoView,process:(t,s)=>this._parseTileData(t,s),concurrency:8,scheduler:this.scheduler,priority:se.MAPVIEW_VECTOR_TILE_PARSING_QUEUE}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(t=>{this._vectorTileContainer.setStyleResources(t,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=i,this._tileHandlerPromise=e}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const i=this._tileHandlerAbortController;i&&i.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=R(this._fetchQueue),this._parseQueue=R(this._parseQueue),this._tileManager=R(this._tileManager),this._vectorTileContainer.removeAllChildren()}async _getTileData(i,e){return this._tileHandler.fetchTileData(i,e)}async _parseTileData(i,e){return this._tileHandler.parseTileData(i,e)}async _applyStyleChanges(){this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._tileManager.clearCache();const i=this._styleChanges;try{await this._tileHandler.updateStyle(i)}catch(r){q.getLogger(this).error("error applying vector-tiles style update",r.message),this._resumeQueues(),this._isTileHandlerReady=!0}const e=this._styleRepository,t=new Set;i.forEach(r=>{if(r.type!==3)return;const l=r.data,n=e.getLayerById(l.layer);n&&t.add(n.uid)});const s=new Set;i.forEach(r=>{let l;switch(r.type){case 0:e.setPaintProperties(r.data.layer,r.data.paint),l=r.data.layer;break;case 1:e.setLayoutProperties(r.data.layer,r.data.layout),l=r.data.layer;break;case 3:return void e.deleteStyleLayer(r.data.layer);case 2:e.setStyleLayer(r.data.layer,r.data.index),l=r.data.layer.id;break;case 4:this._vectorTileContainer.setSpriteMosaic(this._tileHandler.setSpriteSource(r.data.spriteSource))}if(l){const n=e.getLayerById(l);n&&s.add(n.uid)}});const a=this._vectorTileContainer.children;if(t.size>0){const r=Array.from(t);this._vectorTileContainer.deleteStyleLayers(r);for(const l of a)l.deleteLayerData(r)}if(this._resumeQueues(),s.size>0){const r=Array.from(s),l=[];for(const n of a){const o=this._updatingHandles.addPromise(this._fetchQueue.push(n.key).then(h=>this._parseQueue.push({key:n.key,data:h,styleLayerUIDs:r})).then(h=>n.setData(h)).finally(()=>n.featureIndex=null));l.push(o)}await Promise.all(l)}this._styleChanges=[],this._isTileHandlerReady=!0,this.requestUpdate()}async _loadStyle(){const{style:i}=this.layer.currentStyleInfo,e=we(i);this._isTileHandlerReady=!1,this._pauseQueues(),this._clearQueues(),this._styleRepository=new te(e),this._vectorTileContainer.destroy(),this._tileManager.clear(),this._tileHandlerAbortController.abort(),this._tileHandlerAbortController=new AbortController;const{signal:t}=this._tileHandlerAbortController;try{this._tileHandlerPromise=this._tileHandler.setStyle(this._styleRepository,e,this.layer.tileInfo.lods.length-1),await this._tileHandlerPromise}catch(r){if(!O(r))throw r}if(t.aborted)return this._resumeQueues(),this._isTileHandlerReady=!0,this._styeChanged=!1,this._spriteSourceChanged=!1,void this.requestUpdate();const s=await this._tileHandler.spriteMosaic,a=this._vectorTileContainer;this._tileInfoView=new ce(this.layer.tileInfo,this.layer.fullExtent),a.setStyleResources(s,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this._tileManager=new le({acquireTile:r=>this.acquireTile(r),releaseTile:r=>this.releaseTile(r),tileInfoView:this._tileInfoView},this._vectorTileContainer),this._resumeQueues(),this._isTileHandlerReady=!0,this.requestUpdate(),this._styeChanged=!1,this._spriteSourceChanged=!1}_createVectorTile(i){const e=this._tileInfoView.getTileBounds(k(),i),t=this._tileInfoView.getTileResolution(i.level);return new ze(i,t,e[0],e[3],512,512,this._styleRepository)}async _queryTile(i,e,t,s,a,r){if(a.layerData.size===0)return;const l=this._ensureTileIndex(a),n=this._tileInfoView.getTileBounds(k(),a.key,!0),o=ue*de*((e.x-n[0])/(n[2]-n[0])),h=ue*de*(1-(e.y-n[1])/(n[3]-n[1])),c=await l.queryAttributes(o,h,t,s,r);for(const u of c)u.graphic.geometry=this._tileToMapPoint(u.tilePoint,a.transforms.tileUnitsToPixels),i.push({type:"graphic",layer:this.layer,graphic:u.graphic,mapPoint:e.clone()});i.sort((u,d)=>(ie(d.graphic.origin)?d.graphic.origin.layerIndex:0)-(ie(u.graphic.origin)?u.graphic.origin.layerIndex:0))}_tileToMapPoint(i,e){if(!i)return null;const t=i[0]*e[0]+i[1]*e[3]+e[6],s=i[0]*e[1]+i[1]*e[4]+e[7],a=this.view.state,r=[0,0];return a.toMap(r,[t,s]),new be({x:r[0],y:r[1],spatialReference:a.spatialReference})}_ensureTileIndex(i){let e=i.featureIndex;return e||(e=E.create(i.key,i.layerData,this._styleRepository,this._tileHandler,this.layer),i.featureIndex=e),e}_pauseQueues(){this._fetchQueue.pause(),this._parseQueue.pause()}_resumeQueues(){this._fetchQueue.resume(),this._parseQueue.resume()}_clearQueues(){this._fetchQueue.clear(),this._parseQueue.clear()}};function ht(i){if(i==null)return 0;switch(i.type){case"partial":return Object.keys(i.diff).length;case"complete":return Math.max(Object.keys(i.oldValue).length,Object.keys(i.newValue).length);case"collection":return Object.keys(i.added).length+Object.keys(i.changed).length+Object.keys(i.removed).length}}X([De()],F.prototype,"_isTileHandlerReady",void 0),F=X([Re("esri.views.2d.layers.VectorTileLayerView2D")],F);const _i=F;export{_i as default};
