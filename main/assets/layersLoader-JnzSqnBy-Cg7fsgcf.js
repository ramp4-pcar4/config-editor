import{c as y,an as S,W as T}from"./index-Bq7Udiuc.js";import{o as v,L as F}from"./fetchService-Bp_4TwIU-DdEVR-7J.js";import{u as m,f as M,L as $,h as g,l as w,d as P,b as G,g as x,m as I}from"./loadUtils-qPQbuxA4-Drd1yKJu.js";import{a as b}from"./jsonContext-D_JQG_uA-CgjDDzfP.js";import{o as D}from"./portalItemUtils-DsrxEt4W-AFhOD2Cb.js";import{g as O}from"./styleUtils-DbPBpaXg-AOdS0uD0.js";import"./associatedFeatureServiceUtils-DCapzd9d-Doehwxc_.js";import"./PortalItem-CJetnHeq-DU1PthkB.js";import"./projection-m8vi7Cxv-dX7rRAaA.js";async function ee(t,o){const a=t.instance.portalItem;if(a!=null&&a.id)return await a.load(o),k(t),t.validateItem&&t.validateItem(a),A(t,o)}function k(t){const o=t.instance.portalItem;if(!(o!=null&&o.type)||!t.supportedTypes.includes(o.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:o==null?void 0:o.type,expectedType:t.supportedTypes.join(", ")})}async function A(t,o){const a=t.instance,e=a.portalItem;if(!e)return;const{url:l,title:r}=e,n=b(e,"portal-item");if(a.type==="group")return C(a,n,t);l&&a.type!=="media"&&a.read({url:l},n);const u=new I,s=await L(t,u,o);return s&&a.read(s,n),a.resourceReferences={portalItem:e,paths:n.readResourcePaths??[]},a.type!=="subtype-group"&&a.read({title:r},n),O(a,n)}async function C(t,o,a){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:l,type:r}=e;if(r==="Group Layer"){if(!D(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return E(t,a)}return t.read({title:l},o),R(t,a)}async function E(t,o){const a=t.portalItem,e=await a.fetchData("json");if(!e)return;if(!o.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const l=b(a,"web-map");t.read(e,l),await o.populateGroupLayer(t,e,{context:l}),t.resourceReferences={portalItem:a,paths:l.readResourcePaths??[]}}async function R(t,o){var c;let a;const{portalItem:e}=t;if(!e)return;const l=e.type,r=o.layerModuleTypeMap;if(!r)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(l){case"Feature Service":case"Feature Collection":a=r.FeatureLayer;break;case"Stream Service":a=r.StreamLayer;break;case"Scene Service":a=r.SceneLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${l}' is not supported as a 'IGroupLayer'`)}const n=new I;let[u,s]=await Promise.all([a(),L(o,n)]),i=()=>u;if(l==="Feature Service"){const p=(c=m(s))==null?void 0:c.customParameters;s=e.url?await M(s,e.url,n):{},i=await W(s,r)||i;const d=await B(e.url,{customParameters:p,loadContext:n});return await f(t,i,i,s,r,d)}return l==="Scene Service"&&e.url&&(s=await $(e,s,n)),g(s)>0?await f(t,i,null,s,r):await j(t,i,r)}async function j(t,o,a){var r,n;const{portalItem:e}=t;if(!(e!=null&&e.url))return;const l=await v(e.url);l&&f(t,o,null,{layers:(r=l.layers)==null?void 0:r.map(w),tables:(n=l.tables)==null?void 0:n.map(w)},a)}async function f(t,o,a,e,l,r){var s;let n=e.layers||[];const u=e.tables||[];if(((s=t.portalItem)==null?void 0:s.type)==="Feature Collection"?(n.forEach((i,c)=>{var p;i.id=c,((p=i==null?void 0:i.layerDefinition)==null?void 0:p.type)==="Table"&&u.push(i)}),n=n.filter(i=>{var c;return((c=i==null?void 0:i.layerDefinition)==null?void 0:c.type)!=="Table"})):(n.reverse(),u.reverse()),n.forEach(i=>{const c=r==null?void 0:r(i);if(c||!r){const p=h(t,o(i),e,i,c);t.add(p)}}),u.length){const i=a?null:await l.FeatureLayer();u.forEach(c=>{const p=r==null?void 0:r(c);if(p||!r){const d=h(t,a?a(c):i,e,c,p);t.tables.add(d)}})}}function h(t,o,a,e,l){const r=t.portalItem,n={portalItem:r.clone(),layerId:e.id};e.url!=null&&(n.url=e.url);const u=new o(n);if("sourceJSON"in u&&(u.sourceJSON=l),u.type!=="subtype-group"&&u.type!=="catalog"&&(u.sublayerTitleMode="service-name"),r.type==="Feature Collection"){const s={origin:"portal-item",portal:r.portal||S.getDefault()};u.read(e,s);const i=a.showLegend;i!=null&&u.read({showLegend:i},s)}return u}async function L(t,o,a){if(t.supportsData===!1)return;const e=t.instance,l=e.portalItem;if(!l)return;let r=null;try{r=await l.fetchData("json",a)}catch{}if(q(e)){let n=null;const u=await J(l,r,o);if((r!=null&&r.layers||r!=null&&r.tables)&&u>0){if(e.layerId==null){const s=P(e.type),i=s!=null&&s.length?G(r,s)[0]:m(r);i&&(e.layerId=i.id)}n=N(r,e),(n==null?void 0:n.layerType)==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),n&&r.showLegend!=null&&(n.showLegend=r.showLegend)}return u>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),n}return r}async function J(t,o,a){var r,n,u,s,i;if(o!=null&&o.layers&&(o!=null&&o.tables))return g(o);const e=T(t.url);if(!e)return 1;const l=await a.fetchServiceMetadata(e.url.path,{customParameters:(r=m(o))==null?void 0:r.customParameters}).catch(()=>null);return(((n=o==null?void 0:o.layers)==null?void 0:n.length)??((u=l==null?void 0:l.layers)==null?void 0:u.length)??0)+(((s=o==null?void 0:o.tables)==null?void 0:s.length)??((i=l==null?void 0:l.tables)==null?void 0:i.length)??0)}function N(t,o){var l,r;const{layerId:a}=o,e=((l=t.layers)==null?void 0:l.find(n=>n.id===a))||((r=t.tables)==null?void 0:r.find(n=>n.id===a));return e&&z(e,o)?e:null}function q(t){return t.type!=="stream"&&"layerId"in t}function z(t,o){const a="layerType"in t&&t.layerType,{type:e}=o;return!(e==="feature"&&a&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!a||e==="oriented-imagery"&&!a||e==="subtype-group"&&!a)}async function B(t,o){const{layersJSON:a}=await F(t,o);if(!a)return null;const e=[...a.layers,...a.tables];return l=>e.find(r=>r.id===l.id)}async function W(t,o){const{layers:a,tables:e}=t,l=[...a??[],...e??[]];if(!l.length)return;const r=new Set,n=[];for(const{layerType:i}of l){const c=i??"ArcGISFeatureLayer";if(r.has(c))continue;r.add(c);const p=o[x(c)];n.push(p())}const u=await Promise.all(n),s=new Map;return Array.from(r).forEach((i,c)=>{s.set(i,u[c])}),({layerType:i})=>{const c=i??"ArcGISFeatureLayer";return s.get(c)}}export{ee as load};
