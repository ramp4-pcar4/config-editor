import{im as Y,cT as _,E as j,c7 as Q,am as Z,T as J,a8 as K,fr as W,c as O}from"./index-DiOGazkl.js";import{h as $}from"./TimeExtent-gZaEUVeW-4Edd9Fvb.js";import{N as H}from"./quantizationUtils-Cndke4AR-BnNTm1fP.js";import{A as X,M as ee}from"./heatmapUtils--OU2Fakh-Df7qUV2s.js";import{F as ne}from"./utils-BG7WTOnW-CIpqHntZ.js";import{p as le}from"./ClassBreaksDefinition-B_vYk3bu-Bx65scyX.js";const te=()=>K.getLogger("esri.rest.support.generateRendererUtils");function N(e,n){return Number(e.toFixed(n))}function Je(e){const n=P(e),l=[],a=n.uniqueValues.length;for(let t=0;t<a;t++){const c=n.uniqueValues[t],o=n.valueFrequency[t],i=c.toString();l.push({value:c,count:o,label:i})}return{uniqueValues:l}}function ae(e,n){const{normalizationTotal:l}=e;return{classBreaks:ie(e,n),normalizationTotal:l}}function ie(e,n){const l=e.definition,{classificationMethod:a,normalizationType:t,definedInterval:c}=l,o=l.breakCount??1,i=[];let r=e.values;if(r.length===0)return[];r=r.sort((f,s)=>f-s);const[p,d]=n??[r.at(0),r.at(-1)];if(a==="equal-interval")if(r.length>=o){const f=(d-p)/o;let s=p;for(let u=1;u<o;u++){const m=N(p+u*f,6);i.push({minValue:s,maxValue:m,label:v(s,m,t)}),s=m}i.push({minValue:s,maxValue:d,label:v(s,d,t)})}else r.forEach(f=>{i.push({minValue:f,maxValue:f,label:v(f,f,t)})});else if(a==="natural-breaks"){const f=P(r),s=e.valueFrequency||f.valueFrequency,u=oe(f.uniqueValues,s,o);let m=p;for(let h=1;h<o;h++)if(f.uniqueValues.length>h){const V=N(f.uniqueValues[u[h]],6);i.push({minValue:m,maxValue:V,label:v(m,V,t)}),m=V}i.push({minValue:m,maxValue:d,label:v(m,d,t)})}else if(a==="quantile")if(r.length>=o&&p!==d){let f=p,s=Math.ceil(r.length/o),u=0;for(let m=1;m<o;m++){let h=s+u-1;h>r.length&&(h=r.length-1),h<0&&(h=0),i.push({minValue:f,maxValue:r[h],label:v(f,r[h],t)}),f=r[h],u+=s,s=Math.ceil((r.length-u)/(o-m))}i.push({minValue:f,maxValue:d,label:v(f,d,t)})}else{let f=-1;for(let s=0;s<r.length;s++){const u=r[s];u!==f&&(f=u,i.push({minValue:f,maxValue:u,label:v(f,u,t)}),f=u)}}else if(a==="standard-deviation"){const f=re(r),s=ce(r,f);if(s===0)i.push({minValue:r[0],maxValue:r[0],label:v(r[0],r[0],t)});else{const u=ue(p,d,o,f,s)*s;let m=0,h=p;for(let g=o;g>=1;g--){const b=N(f-(g-.5)*u,6);i.push({minValue:h,maxValue:b,label:v(h,b,t)}),h=b,m++}let V=N(f+.5*u,6);i.push({minValue:h,maxValue:V,label:v(h,V,t)}),h=V,m++;for(let g=1;g<=o;g++)V=m===2*o?d:N(f+(g+.5)*u,6),i.push({minValue:h,maxValue:V,label:v(h,V,t)}),h=V,m++}}else if(a==="defined-interval"){if(!c)return i;const[f,s]=n??[r.at(0),r.at(-1)],u=Math.ceil((s-f)/c);let m=f;for(let h=1;h<u;h++){const V=N(f+h*c,6);i.push({minValue:m,maxValue:V,label:v(m,V,t)}),m=V}i.push({minValue:m,maxValue:s,label:v(m,s,t)})}return i}function v(e,n,l){let a=null;return a=e===n?l&&l==="percent-of-total"?e+"%":e.toString():l&&l==="percent-of-total"?e+"% - "+n+"%":e+" - "+n,a}function P(e){const n=[],l=[];let a=Number.MIN_VALUE,t=1,c=-1;for(let o=0;o<e.length;o++){const i=e[o];i===a?(t++,l[c]=t):i!==null&&(n.push(i),a=i,t=1,l.push(t),c++)}return{uniqueValues:n,valueFrequency:l}}function oe(e,n,l){const a=e.length,t=[];l>a&&(l=a);for(let o=0;o<l;o++)t.push(Math.round(o*a/l-1));t.push(a-1);let c=U(t,e,n,l);return se(c.mean,c.sdcm,t,e,n,l)&&(c=U(t,e,n,l)),t}function U(e,n,l,a){let t=[],c=[],o=[],i=0;const r=[],p=[];for(let u=0;u<a;u++){const m=z(u,e,n,l);r.push(m.sbMean),p.push(m.sbSdcm),i+=p[u]}let d,f=i,s=!0;for(;s||i<f;){s=!1,t=[];for(let u=0;u<a;u++)t.push(e[u]);for(let u=0;u<a;u++)for(let m=e[u]+1;m<=e[u+1];m++)if(d=n[m],u>0&&m!==e[u+1]&&Math.abs(d-r[u])>Math.abs(d-r[u-1]))e[u]=m;else if(u<a-1&&e[u]!==m-1&&Math.abs(d-r[u])>Math.abs(d-r[u+1])){e[u+1]=m-1;break}f=i,i=0,c=[],o=[];for(let u=0;u<a;u++){c.push(r[u]),o.push(p[u]);const m=z(u,e,n,l);r[u]=m.sbMean,p[u]=m.sbSdcm,i+=p[u]}}if(i>f){for(let u=0;u<a;u++)e[u]=t[u],r[u]=c[u],p[u]=o[u];i=f}return{mean:r,sdcm:p}}function se(e,n,l,a,t,c){let o=0,i=0,r=0,p=0,d=!0;for(let f=0;f<2&&d;f++){f===0&&(d=!1);for(let s=0;s<c-1;s++)for(;l[s+1]+1!==l[s+2];){l[s+1]=l[s+1]+1;const u=z(s,l,a,t);r=u.sbMean,o=u.sbSdcm;const m=z(s+1,l,a,t);if(p=m.sbMean,i=m.sbSdcm,!(o+i<n[s]+n[s+1])){l[s+1]=l[s+1]-1;break}n[s]=o,n[s+1]=i,e[s]=r,e[s+1]=p,d=!0}for(let s=c-1;s>0;s--)for(;l[s]!==l[s-1]+1;){l[s]=l[s]-1;const u=z(s-1,l,a,t);r=u.sbMean,o=u.sbSdcm;const m=z(s,l,a,t);if(p=m.sbMean,i=m.sbSdcm,!(o+i<n[s-1]+n[s])){l[s]=l[s]+1;break}n[s-1]=o,n[s]=i,e[s-1]=r,e[s]=p,d=!0}}return d}function ue(e,n,l,a,t){let c=Math.max(a-e,n-a)/t/l;return c=c>=1?1:c>=.5?.5:.25,c}function re(e){let n=0;for(let l=0;l<e.length;l++)n+=e[l];return n/=e.length,n}function ce(e,n){let l=0;for(let a=0;a<e.length;a++){const t=e[a];l+=(t-n)*(t-n)}return l/=e.length,Math.sqrt(l)}function z(e,n,l,a){let t=0,c=0;for(let r=n[e]+1;r<=n[e+1];r++){const p=a[r];t+=l[r]*p,c+=p}c<=0&&te().warn("Exception in Natural Breaks calculation");const o=t/c;let i=0;for(let r=n[e]+1;r<=n[e+1];r++)i+=a[r]*(l[r]-o)**2;return{sbMean:o,sbSdcm:i}}const fe="<Null>",me="equal-interval",de=1,pe=5,he=10,ge=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,be=new Set(["esriFieldTypeDate","esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeLong","esriFieldTypeOID","esriFieldTypeBigInteger"]),Ve=new Set(["esriFieldTypeTimeOnly","esriFieldTypeDateOnly"]),xe=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function I(e){return e==null||typeof e=="string"&&!e?fe:e}function ve(e){const n=e.normalizationField!=null||e.normalizationType!=null,l=e.minValue!=null||e.maxValue!=null,a=!!e.sqlExpression&&e.supportsSQLExpression;return!n&&!l&&!a}function Ke(e){var o,i;const{outStatisticTypes:n}=e,l=e.returnDistinct?[...new Set(e.values)]:e.values,a=l.filter(r=>r!=null).sort(),t=a.length,c={count:t,min:a[0],max:a[t-1]};return e.supportsNullCount&&(c.nullcount=l.length-t),!e.percentileParams||(o=n==null?void 0:n.include)!=null&&o.length&&!n.include.includes("median")||(i=n==null?void 0:n.exclude)!=null&&i.length&&n.exclude.includes("median")||(c.median=B(l,e.percentileParams)),c}function ye(e){var h,V;const{values:n,useSampleStdDev:l,supportsNullCount:a,outStatisticTypes:t}=e;let c=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=null,r=null,p=null,d=null,f=0;const s=e.minValue==null?-1/0:e.minValue,u=e.maxValue==null?1/0:e.maxValue;for(const g of n)Number.isFinite(g)?g>=s&&g<=u&&(i=i===null?g:i+g,c=Math.min(c,g),o=Math.max(o,g),f++):typeof g=="string"&&f++;if(f&&i!=null){r=i/f;let g=0;for(const b of n)Number.isFinite(b)&&b>=s&&b<=u&&(g+=(b-r)**2);d=l?f>1?g/(f-1):0:f>0?g/f:0,p=Math.sqrt(d)}else c=null,o=null;const m={avg:r,count:f,max:o,min:c,stddev:p,sum:i,variance:d};return a&&(m.nullcount=n.length-f),!e.percentileParams||(h=t==null?void 0:t.include)!=null&&h.length&&!t.include.includes("median")||(V=t==null?void 0:t.exclude)!=null&&V.length&&t.exclude.includes("median")||(m.median=B(n,e.percentileParams)),m}function B(e,n){const{fieldType:l,value:a,orderBy:t,isDiscrete:c}=n,o=Te(l,t==="desc");if((e=[...e].filter(u=>u!=null).sort((u,m)=>o(u,m))).length===0)return null;if(a<=0)return e[0];if(a>=1)return e[e.length-1];const i=(e.length-1)*a,r=Math.floor(i),p=r+1,d=i%1,f=e[r],s=e[p];return p>=e.length||c||typeof f=="string"||typeof s=="string"?f:f*(1-d)+s*d}function Te(e,n){if(e){if(be.has(e))return A(n);if(Ve.has(e))return E(n,!1);if(e==="esriFieldTypeTimestampOffset")return Me(n);const o=E(n,!0);if(e==="esriFieldTypeString")return o;if(e==="esriFieldTypeGUID"||e==="esriFieldTypeGlobalID")return(i,r)=>o(L(i),L(r))}const l=n?1:-1,a=A(n),t=E(n,!0),c=G(n);return(o,i)=>typeof o=="number"&&typeof i=="number"?a(o,i):typeof o=="string"&&typeof i=="string"?t(o,i):c(o,i)??l}const w=(e,n)=>e==null?n==null?0:1:n==null?-1:null,k=(e,n)=>e==null?n==null?0:-1:n==null?1:null;function G(e){return e?w:k}const Fe=(e,n)=>k(e,n)??(e===n?0:new Date(e).getTime()-new Date(n).getTime()),Ie=(e,n)=>w(e,n)??(e===n?0:new Date(n).getTime()-new Date(e).getTime());function Me(e){return e?Ie:Fe}const Ne=(e,n)=>k(e,n)??(e===n?0:e<n?-1:1),ze=(e,n)=>w(e,n)??(e===n?0:e<n?1:-1);function E(e,n){if(!n)return e?ze:Ne;const l=G(e);return e?(a,t)=>l(a,t)??((a=a.toUpperCase())>(t=t.toUpperCase())?-1:a<t?1:0):(a,t)=>l(a,t)??((a=a.toUpperCase())<(t=t.toUpperCase())?-1:a>t?1:0)}const Se=(e,n)=>w(e,n)??n-e,De=(e,n)=>k(e,n)??e-n;function A(e){return e?Se:De}function L(e){return e.slice(24,36)+e.slice(19,23)+e.slice(16,18)+e.slice(14,16)+e.slice(11,13)+e.slice(9,11)+e.slice(6,8)+e.slice(4,6)+e.slice(2,4)+e.slice(0,2)}function We(e,n,l){var t,c;let a;for(a in e)(t=n==null?void 0:n.include)!=null&&t.length&&!n.include.includes(a)||(c=n==null?void 0:n.exclude)!=null&&c.length&&n.exclude.includes(a)?delete e[a]:xe.includes(a)&&(Number.isFinite(e[a])||(e[a]=null));return l&&["avg","stddev","variance"].forEach(o=>{e[o]!=null&&(e[o]=Math.ceil(e[o]??0))}),e}function He(e){const n={};for(let l of e)(l==null||typeof l=="string"&&l.trim()==="")&&(l=null),n[l]==null?n[l]={count:1,data:l}:n[l].count++;return{count:n}}function C(e){return(e==null?void 0:e.type)!=="coded-value"?[]:e.codedValues.map(n=>n.code)}function Xe(e,n,l,a){const t=e.count,c=[];if(l&&n){const o=[],i=C(n[0]);for(const r of i)if(n[1]){const p=C(n[1]);for(const d of p)if(n[2]){const f=C(n[2]);for(const s of f)o.push(`${I(r)}${a}${I(d)}${a}${I(s)}`)}else o.push(`${I(r)}${a}${I(d)}`)}else o.push(r);for(const r of o)t.hasOwnProperty(r)||(t[r]={data:r,count:0})}for(const o in t){const i=t[o];c.push({value:i.data,count:i.count,label:i.label})}return{uniqueValueInfos:c}}function we(e,n,l,a){let t=null;switch(n){case"log":e!==0&&(t=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(a)&&a!==0&&(t=e/a*100);break;case"field":Number.isFinite(l)&&l!==0&&(t=e/l);break;case"natural-log":e>0&&(t=Math.log(e));break;case"square-root":e>0&&(t=e**.5)}return t}function ke(e,n,l){const a=$e({field:n.field,normalizationType:n.normalizationType,normalizationField:n.normalizationField,classificationMethod:n.classificationMethod,standardDeviationInterval:n.standardDeviationInterval,definedInterval:n.definedInterval,breakCount:n.numClasses||pe});return e=qe(e,n.minValue,n.maxValue),ae({definition:a,values:e,normalizationTotal:n.normalizationTotal},l)}function qe(e,n,l){const a=n??-1/0,t=l??1/0;return e.filter(c=>Number.isFinite(c)&&c>=a&&c<=t)}function $e(e){const{breakCount:n,field:l,normalizationField:a,normalizationType:t}=e,c=e.classificationMethod||me,o=c==="standard-deviation"?e.standardDeviationInterval||de:void 0,i=c==="defined-interval"?e.definedInterval:void 0;return new le({breakCount:n,classificationField:l,classificationMethod:c,normalizationField:t==="field"?a:void 0,normalizationType:t,standardDeviationInterval:o,definedInterval:i})}function en(e,n){var r,p;let l=e.classBreaks;const a=l.length,t=(r=l[0])==null?void 0:r.minValue,c=(p=l[a-1])==null?void 0:p.maxValue,o=n==="standard-deviation",i=ge;return l=l.map(d=>{const f=d.label,s={minValue:d.minValue,maxValue:d.maxValue,label:f};if(o&&f){const u=f.match(i),m=(u==null?void 0:u.map(h=>+h.trim()))??[];m.length===2?(s.minStdDev=m[0],s.maxStdDev=m[1],m[0]<0&&m[1]>0&&(s.hasAvg=!0)):m.length===1&&(f.includes("<")?(s.minStdDev=null,s.maxStdDev=m[0]):f.includes(">")&&(s.minStdDev=m[0],s.maxStdDev=null))}return s}),{minValue:t,maxValue:c,classBreakInfos:l,normalizationTotal:e.normalizationTotal}}function nn(e,n){const l=Ee(e,n);if(l.min==null&&l.max==null)return{bins:[],minValue:l.min,maxValue:l.max,normalizationTotal:n.normalizationTotal};const a=l.intervals,t=l.min??0,c=l.max??0,o=a.map((i,r)=>({minValue:a[r][0],maxValue:a[r][1],count:0}));for(const i of e)if(i!=null&&i>=t&&i<=c){const r=Ce(a,i);r>-1&&o[r].count++}return{bins:o,minValue:t,maxValue:c,normalizationTotal:n.normalizationTotal}}function Ee(e,n,l=!1){var V,g;const{field:a,classificationMethod:t,standardDeviationInterval:c,definedInterval:o,normalizationType:i,normalizationField:r,normalizationTotal:p,minValue:d,maxValue:f}=n,s=n.numBins||he;let u=null,m=null,h=null;if((!t||t==="equal-interval")&&!i){if(d!=null&&f!=null)u=d,m=f;else{const b=ye({values:e,minValue:d,maxValue:f,useSampleStdDev:!i,supportsNullCount:ve({normalizationType:i,normalizationField:r,minValue:d,maxValue:f})});u=b.min??null,m=b.max??null}h=Oe(u??0,m??0,s)}else{const{classBreaks:b}=ke(e,{field:a,normalizationType:i,normalizationField:r,normalizationTotal:p,classificationMethod:t,standardDeviationInterval:c,definedInterval:o,minValue:d,maxValue:f,numClasses:s},d!=null&&f!=null?[d,f]:void 0);u=(V=b[0])==null?void 0:V.minValue,m=(g=b[b.length-1])==null?void 0:g.maxValue,h=b.map(y=>[y.minValue,y.maxValue])}if(l){const b=h.at(-1)[1];h.push([b,b])}return{min:u,max:m,intervals:h}}function Ce(e,n){let l=-1;for(let a=e.length-1;a>=0;a--)if(n>=e[a][0]){l=a;break}return l}function Oe(e,n,l){const a=(n-e)/l,t=[];let c,o=e;for(let i=1;i<=l;i++)c=o+a,c=Number(c.toFixed(16)),t.push([o,i===l?n:c]),o=c;return t}let F=null;const Ue=/^(?<hh>([0-1][0-9])|([2][0-3])):(?<mm>[0-5][0-9])(:(?<ss>[0-5][0-9]))?([.](?<ms>\d+))?$/;function Ae(e,n,l){return e.x<0?e.x+=n:e.x>l&&(e.x-=n),e}function ln(e,n,l,a){const t=Y(l)?_(l):null,c=t?Math.round((t.valid[1]-t.valid[0])/n.scale[0]):null;return e.map(o=>{const i=new j(o.geometry);return H(n,i,i),o.geometry=t?Ae(i,c??0,a[0]):i,o})}function tn(e,n=18,l,a,t){const c=new Float64Array(a*t);n=Math.round(W(n));let o=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;const r=ee(l);for(const{geometry:p,attributes:d}of e){const{x:f,y:s}=p,u=Math.max(0,f-n),m=Math.max(0,s-n),h=Math.min(t,s+n),V=Math.min(a,f+n),g=+r(d);for(let b=m;b<h;b++)for(let y=u;y<V;y++){const S=b*a+y,D=X(y-f,b-s,n)*g,T=c[S]+=D;o=Math.min(o,T),i=Math.max(i,T)}}return{min:o,max:i}}function Le(e){const n=Ue.exec(e);if(!n)return null;const{hh:l,mm:a,ss:t,ms:c}=n.groups;return Number(l)*$.hours+Number(a)*$.minutes+Number(t)*$.seconds+Number(c||0)}async function an(e,n,l=!0){if(!n)return[];const{field:a,field2:t,field3:c,fieldDelimiter:o,fieldInfos:i,timeZone:r}=e,p=a&&(i==null?void 0:i.find(T=>T.name.toLowerCase()===a.toLowerCase())),d=!!p&&Q(p),f=!!p&&ne(p),s=e.valueExpression,u=e.normalizationType,m=e.normalizationField,h=e.normalizationTotal,V=[],g=e.viewInfoParams;let b=null,y=null;if(s){if(!F){const{arcadeUtils:T}=await Z();F=T}F.hasGeometryOperations(s)&&await F.enableGeometryOperations(),b=F.createFunction(s),y=g?F.getViewInfo({viewingMode:g.viewingMode,scale:g.scale,spatialReference:new J(g.spatialReference)}):null}const S=e.fieldInfos,D=!(n[0]&&"declaredClass"in n[0]&&n[0].declaredClass==="esri.Graphic")&&S?{fields:S}:null;return n.forEach(T=>{const M=T.attributes;let x;if(s){const q=D?{...T,layer:D}:T,R=F.createExecContext(q,y,r);x=F.executeFunction(b,R)}else M&&(x=M[a],t?(x=`${I(x)}${o}${I(M[t])}`,c&&(x=`${x}${o}${I(M[c])}`)):typeof x=="string"&&l&&(f?x=x?new Date(x).getTime():null:d&&(x=x?Le(x):null)));if(u&&typeof x=="number"&&isFinite(x)){const q=M&&parseFloat(M[m]);x=we(x,u,q,h)}V.push(x)}),V}function on(e){const n=e.field,l=e.normalizationType,a=e.normalizationField;let t;return l==="field"?t="(NOT "+a+" = 0)":l!=="log"&&l!=="natural-log"&&l!=="square-root"||(t=`(${n} > 0)`),t}function sn(e,n,l){const a=n!=null?e+" >= "+n:"",t=l!=null?e+" <= "+l:"";let c="";return c=a&&t?Pe(a,t):a||t,c?"("+c+")":""}function Pe(e,n){let l=e??"";return n!=null&&n&&(l=l?"("+l+") AND ("+n+")":n),l}function un(e,n){if(e&&e.spatialRelationship!=="intersects")return new O(n,"Only 'intersects' spatialRelationship is supported for featureFilter")}function rn(e,n,l){const a=Be({layer:e,fields:n});if(a.length)return new O(l,"Unknown fields: "+a.join(", ")+". You can only use fields defined in the layer schema");const t=Ge({layer:e,fields:n});return t.length?new O(l,"Unsupported fields: "+t.join(", ")+". You can only use fields that can be fetched i.e. AdapterFieldUsageInfo.supportsStatistics must be true"):void 0}function Be(e){const n=e.layer;return e.fields.filter(l=>!n.getField(l))}function Ge(e){const n=e.layer;return e.fields.filter(l=>{const a=n.getFieldUsageInfo(l);return!a||!a.supportsStatistics})}export{ve as A,ae as B,B as E,Oe as H,ln as J,ke as K,We as L,He as P,nn as R,I as T,an as W,Ee as X,ye as Y,Ce as Z,Xe as a,tn as b,Te as c,we as d,Le as e,sn as f,$e as g,Je as h,rn as i,en as j,Ke as k,un as l,on as m,xe as n,Pe as t};
