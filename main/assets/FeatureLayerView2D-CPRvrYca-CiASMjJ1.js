import{V as De,c as he,bh as re,l as T,eV as St,cL as It,d8 as _t,bw as ye,a7 as wt,aB as Ft,av as Ne,ah as I,F as Vt,as as fe,ar as xe,P as C,kT as Le,bD as Ge,nb as xt,m as h,E as y,n as H,aj as ot,ak as Et,q as ce,cb as ge,cj as U,be as Rt,N as Ee,al as Ot,n2 as Ct,a4 as kt,bc as we,at as zt,fU as Be,ma as lt,g7 as Tt,mE as qt,nc as Mt,nd as Qe,ne as Pt,nf as je,ng as At,nh as Ut,fw as A,ni as Dt,nj as Nt,fy as se,fW as ut,g4 as $e,kL as ct,aM as Lt,fK as Gt,cE as Bt,gj as Y,am as Qt,fY as dt,fG as jt,fX as $t,R as Jt}from"./index-BeTPrQ6f.js";import{i as pt}from"./UpdatingHandles-XotKWqvb-CyHJIoZx.js";import{$ as Ht}from"./densifyCurvedGeometry-C7Lb_tRx-Bjv2vU9s.js";import{f as Je}from"./EffectView-kLXORhA_-D7bXwfxF.js";import{L as He}from"./featureConversionUtils-CZmIxyv5-DHwRSztU.js";import $ from"./FeatureFilter-D0iZ4sKI-BBZH0Xo9.js";import{d as Wt,U as Kt,a as Zt}from"./labelingInfo-jIy5P_vY-D8rEl7NY.js";import{c as Xt}from"./timeSupport-CH70S3w_-DdC7tV9M.js";import{c as Re}from"./FeatureSet-BIUKCqNW-D9YRl-VE.js";import{r as Yt}from"./AttributeBinsFeatureSet-DnObQnDw-BXW4BoEx.js";import ei from"./AttributeBinsQuery-DAANgUPd-DDdVeBeY.js";import{b as me,p as ti}from"./Query-DKLDaFaA-I4zhlfzt.js";import{F as ii}from"./LayerView2D-D_-BpxcP-BHff6Xwh.js";import{j as ri,N as We,C as Ke}from"./TechniqueInstance-DewtzAj1-Bk3vEzF0.js";import{t as si,F as be,V as B,K as V,q as ke,C as k,h as ai,E as ni,O as ve,Z as de,L as J,Q as ue,j as ze}from"./FeatureCommandQueue-BbPzhYCk-D7LazOd5.js";import{i as ht}from"./CircularArray-DaQg3PQl-BXS52LZy.js";import"./Tile-BNoJIjzH-DZ-xZWMb.js";import{s as Oe}from"./TileKey-BZu7Ia24-BiyRHU0x.js";import{q as oi}from"./WGLContainer-CV7lovie-XGZSmlU_.js";import{q as Ze,h as li}from"./MapView-CrB-5KSL-IexKdUKM.js";import{T as ui}from"./workers-CixlqDQM-CMoJ1YZN.js";import{o as ci}from"./ReactiveMap-cp6PWICM-990o5_5b.js";import{c as F}from"./featureReductionUtils-CT3zJdMo-COEl9dk_.js";import{m as di}from"./lengthUtils-CopeXEyE-DjCEitlq.js";import{N as pi,z as hi}from"./query-DALknG0A-COo-2vjI.js";import{P as yi,c as fi}from"./FeatureIdInfo-9kzkNbmy-C9uD4nJf.js";import{t as mi}from"./FeatureMetadata-BbCAi0tA-_ZTatr4-.js";import{e as gi}from"./OrderByInfo-D0eImi6z-Dv2CatL0.js";import{M as bi}from"./heatmapUtils-Bf2yRyEN-BAQJ1IRB.js";import{B as ee,c as vi,k as Si}from"./CIMSymbolHelper-C-M9oL19-BYnF76mM.js";import{V as Ii}from"./SDFHelper-y0wAsOD_-D5veGcjF.js";import"./Utils-CYY0kXyb-BZKnUtTY.js";import{t as pe}from"./definitions-DVO21zOC-BwakNu1s.js";import{E as yt}from"./constants-DVYXs0Da-SxxbBSOD.js";import{x as _i}from"./parquetUtils-efARFe0s-tuTN4jBU.js";import{s as wi}from"./capabilities-BaKzUyhi-B84We26i.js";import{T as Fi}from"./displayFilterUtils-BCW-UeaE-CnjPWjFU.js";import{l as Vi}from"./FeatureEffect-xxDa5IRG-DfQBGcCi.js";import{i as Xe}from"./floorFilterUtils-4r-vVdzs-u-jw2p7F.js";import{s as xi,h as Ei}from"./popupUtils-0qrvMVFA-DW3AaJvU.js";import{t as Ri}from"./LayerView-DBq501tj-9r8g88Ff.js";import{n as Oi}from"./RefreshableLayerView-BoQ2vcWz-CCPPBuQI.js";import{t as Ci}from"./highlightOptionsUtils-D6RCaXjG-zpB2TL72.js";import"./parser-CXoJuqeV-C7irlk5U.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-R0VY9B_E-DoEP887i.js";import"./OptimizedFeature-C33SioFK-sn7DeAq-.js";import"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import"./OptimizedGeometry-BYxlP_oK-DvAqrgO1.js";import"./OptimizedFeatureSet-Dz5hF8Qm-CgsRgxJh.js";import"./Field-Dn1Bgq7n-CJCGLoNR.js";import"./fieldType-DvW5hpfa-DYUbIy_X.js";import"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import"./uuid-CFz2qBzH-cIdlpVG-.js";import"./SimpleRenderer-DSyBXxyY-CGNZcXII.js";import"./commonProperties-CYpRbAZr-PcmW9U_y.js";import"./colorRamps-C5pnMn-A-BSSJ2zvJ.js";import"./ColorStop-CBXZUZ6o-_LZdJKea.js";import"./visualVariableUtils-DzY4BXXy-D_1S-x1B.js";import"./UniqueValueRenderer-4zUMozui-C0Y5GPGV.js";import"./diffUtils-D3O4EfgX-CznKxD4n.js";import"./RendererLegendOptions-_ue7FeM0-ROeRce-g.js";import"./styleUtils-DoTsJ8ze-DHY40A2q.js";import"./RelationshipQuery-Cf-_aN1Z-mThKQ0J2.js";import"./NormalizationBinParametersMixin-DuEmpnQx-abBJwXnQ.js";import"./labelUtils-BLNYRrPe-Cv1ZZjAO.js";import"./utils-DqlCEhl6-DBO0-7VG.js";import"./Queue-CK6TduSr-C-T211SM.js";import"./signal-DHxLvooI-Bin-tnuW.js";import"./Version-DSJSGSLA-Cg87msWM.js";import"./queryUtils-BwthgOFW-CkUF_Za8.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import"./Cyclical-Bzwh_QaL-CXh-hbnA.js";import"./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js";import"./utils-CRANtbnc-C6zyufvL.js";import"./utils-t279O251-BBk6rV0U.js";import"./FixedIntervalBinParameters-Bn9Pye3B-_d3f8Yp4.js";import"./timeZoneUtils-CdK7eU4Y-fyhJ3EFx.js";import"./utils-C0LvbFCo-RMQaTNpt.js";import"./Container-CO1X8bpa-BR9OVw9m.js";import"./layerViewUtils-BBTk5dU--BemaIlLi.js";import"./UpdateTracking2D-CIKx7GWt-CEE8vGb9.js";import"./FramebufferObject-CjoCv_5U-BOVEwWIe.js";import"./BufferObject-RHe5uojV-C-IINTcZ.js";import"./Texture-DLw7oaIg-fTsxdRzn.js";import"./enums-DDJfd4_p-D3z9tmVA.js";import"./TileContainer-BIM43zRp-7nWripvu.js";import"./defaultCIMValues-BWu-APou-XI-Li77m.js";import"./GraphShaderModule-2-Wwh4Ie-CB1gcQ9C.js";import"./ProgramTemplate-BqCbl7jA-D5ymqDWS.js";import"./ShaderBuilder-ufvKEDd5-DMnPqr6U.js";import"./utils-CVxMaYM5-vm0ifvbR.js";import"./constants-CWFGCPkc-B_3x8_48.js";import"./VertexArrayObject-BAcBN849-N8lUr7x7.js";import"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import"./VertexElementDescriptor-DLvjNrmQ-Cuvx5w94.js";import"./rasterizingUtils-Cf1zdzIw-BfJyHaiy.js";import"./streamLayerUtils-CcwO9-27-DFlbJ4P1.js";import"./QueueProcessor-Bne-Dlbg-BSQ_6P13.js";import"./arcadeUtils-BkvNBhzm-KzAaTYHA.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./mat2df32-fg3OHsAI-BF2V2zqo.js";import"./mat2d-Cf4xHr3Z-u09Kv-lR.js";import"./vec32-CI1xtKog-DFVYRcgb.js";import"./vec3f32-GX_cKsFD-UJPpzdNc.js";import"./vec2f32-hTAvipMV-C0AQcwEv.js";import"./config-C6w0VpIP-CfPhyZfw.js";import"./earcut-C6NeZYSh-P2HUZ781.js";import"./vec2f64-CkowXrDb-3zFQ3LNH.js";import"./CollectionFlattener-DfZaIx8a-ADmwanro.js";import"./GraphicsCollection-CT-y6p3H-4XYPvC_j.js";import"./TileInfo-BmHJ3kZT-BCenfvrA.js";import"./TileKey-1TQKLvpf-ByD6Ad6n.js";import"./jsxFactory-DN-m49_5-CUFCpKPo.js";import"./intl-DRhjUnwt-Dihhq8dq.js";import"./messages-DQ10DjvF-6kk0dzjG.js";import"./sanitizerUtils-CrdmaILo-DztC6Qnx.js";import"./Map-BgzFtTfu-BMsKSgj7.js";import"./Basemap-Dv-hYkd3-V8XC6wCN.js";import"./loadAll-B16dgL0--5EDWWWLE.js";import"./PortalItem-BrQqKoE_-zs2bKsCH.js";import"./isBasemap-CJN7v_Jq-Dgi2bMj-.js";import"./writeUtils-DKeM2R6Z-BUUAIn2U.js";import"./persistable-vgejqKb5-CBqfEqX1.js";import"./MD5-CXHDUqXT-CMrYdOi6.js";import"./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js";import"./resourceExtension-Boq2U56c-rXLaGMsr.js";import"./PolygonCollection-BEPfGuUm-Bu1vpYsn.js";import"./editableLayers-BTZOOiKD-ByJ-Oydo.js";import"./TablesMixin-Cv7gcoNw-OtczYJk-.js";import"./HeightModelInfo-Cjals-AI-DMpn5Tsh.js";import"./projectionUtils-BXtVkW1R-Dp6FsH61.js";import"./mat2df64-VxtldH1S-CqyKAV7h.js";import"./Scheduler-D_tOhFWn-SFGb1GBz.js";import"./debugFlags-vZXEBr68-Bc51Oe-E.js";import"./a11yUtils-tU3tY6-a-CmHbThdR.js";import"./unitBezier-DhyPAQO8-B9kUb8N6.js";import"./imageUtils-DITyjHV4-jEv5aA2D.js";import"./modeUtils-V6BDu_YT-Dq8o_RJK.js";import"./ColorBackground-C0DZs7p1-CENExjrO.js";import"./pbfQueryUtils-DYXcN4x1-BpgjQRlR.js";import"./pbf-42TrGguk-Dw0lh_Mv.js";import"./queryZScale-B66ZWsfS-D7Zc2_Zh.js";import"./FieldsIndex-Ds4D9xP7-BiTuE5Z3.js";import"./UnknownTimeZone-DzO8gKMe-d6rtFXqm.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./BidiEngine-DXDmu_WZ-DxL95DSc.js";import"./labelPoint-DTWBMY-Z-DoXEvKTt.js";import"./GeometryUtils-C8-DjR3I-DcNL1Jc6.js";import"./utils-CIm5uQvO-CtKf129F.js";import"./fontUtils-bOFLFKCC-gLU2ItK2.js";import"./Rect-DD6XS68q-D_hsV3ag.js";import"./BoundingBox-DlCd_wcU-DBB4UfPl.js";import"./locationUtils-sOTPEtiz-Bwo0TKFc.js";import"./parquet-BKuoy8EM-tvadAp3d.js";import"./jsonUtils-Bl9MVnOR-Be8hf0yA.js";async function ki(e,t,i,r){var g,v,S;const s=new Array(t.length),a=new Map,n=new Map,o=lt(e.fieldsIndex,i.outFields),u=((v=(g=e.capabilities)==null?void 0:g.operations)==null?void 0:v.supportsQuery)===!0&&e.queryFeatures!=null,l=(r==null?void 0:r.hasRequiredFields)??ut;for(let p=0;p<t.length;p++){const b=t[p];if(u&&!b.isAggregate){if(i.returnGeometry||!l(b,o)){const _=b.getObjectId();if(_!=null){a.set(_,{graphic:b,index:p});continue}const x=b.getGlobalId();if(x!=null){n.set(x,{graphic:b,index:p});continue}}s[p]=b}else s[p]=b}if(!u||!e.queryFeatures||a.size===0&&n.size===0)return s.filter(Boolean);const c=[],d=(p,b)=>{b&&(p.outFields??(p.outFields=[]),p.outFields.includes(b)||p.outFields.push(b))};if(a.size>0){const p=i.clone();d(p,e.objectIdField),"uniqueIdFields"in e&&((S=e.uniqueIdFields)!=null&&S.length)&&(p.outFields??(p.outFields=[]),p.outFields.push(...e.uniqueIdFields)),p.objectIds=Array.from(a.keys()),c.push({type:"object-id",query:p,map:a})}const m="globalIdField"in e?e.globalIdField:null;if(m!=null&&n.size>0){const p=i.clone();d(p,m);const b=Array.from(n.keys());p.where=U(i.where,`${m} IN (${b.map(_=>`'${_}'`).join(",")})`),c.push({type:"global-id",query:p,map:n})}const f=(r==null?void 0:r.updateSourceAttributes)??!1;for(const{type:p,query:b,map:_}of c)try{const x=await e.queryFeatures(b,r);for(const E of x.features){const te=p==="object-id"?E.getObjectId():E.getGlobalId();if(te==null)continue;const P=_.get(te);if(!P)continue;const{graphic:ie,index:gt}=P;if(f&&E.attributes){ie.attributes??(ie.attributes={});for(const _e of o)_e in E.attributes&&(ie.attributes[_e]=E.attributes[_e])}const{geometry:bt,origin:vt}=ie;E.geometry||(E.geometry=bt),E.origin=vt,s[gt]=E}}catch{}return s.filter(Boolean)}async function zi(e){var t;if((t=e.expressionInfos)!=null&&t.length||Array.isArray(e.content)&&e.content.some(i=>i.type==="expression"))return Bt()}let ne=class extends ye{constructor(){super(...arguments),this.isAggregate=!0,this.origin=null}getObjectId(){return this.attributes.aggregateId}};h([y({type:Boolean})],ne.prototype,"isAggregate",void 0),h([y({clonable:"reference"})],ne.prototype,"origin",void 0),ne=h([H("esri.AggregateGraphic")],ne);const Te=ne;let oe=class extends ye{constructor(){super(...arguments),this.isAggregate=!0,this.origin=null}getObjectId(){return this.attributes.aggregateId}};h([y({type:Boolean})],oe.prototype,"isAggregate",void 0),h([y({clonable:"reference"})],oe.prototype,"origin",void 0),oe=h([H("esri.TrackGraphic")],oe);const Ti=oe;let O=class extends ot{constructor(e){super(e),this._filter=null,this.duration=I("mapview-transitions-duration"),this._excludedEffectView=new Je(e),this._includedEffectView=new Je(e)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(e){this._get("featureEffect")!==e&&this._transitionTo(e)}get filter(){var e;return this._filter||((e=this.featureEffect)==null?void 0:e.filter)||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(e){this._set("scale",e),this._excludedEffectView.scale=e,this._includedEffectView.scale=e}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}get transitioningToEmpty(){return!this._excludedEffectView.final&&!this._includedEffectView.final}transitionStep(e,t){this._set("scale",t),this.transitioning?(this._includedEffectView.transitionStep(e,t),this._excludedEffectView.transitionStep(e,t),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=t,this._includedEffectView.scale=t)}endTransition(){this._includedEffectView.endTransition(),this._excludedEffectView.endTransition(),this._filter=null}_transitionTo(e){const t=this._get("featureEffect"),i=e,r=i==null?void 0:i.includedEffect,s=i==null?void 0:i.excludedEffect,a=this._includedEffectView.canTransitionTo(r)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=r,this._excludedEffectView.effect=s,this._set("featureEffect",i),this._filter=(i==null?void 0:i.filter)||(t==null?void 0:t.filter)||null,a||this.endTransition()}};h([y()],O.prototype,"_filter",void 0),h([y()],O.prototype,"_excludedEffectView",void 0),h([y()],O.prototype,"_includedEffectView",void 0),h([y()],O.prototype,"duration",void 0),h([y()],O.prototype,"excludedEffects",null),h([y()],O.prototype,"featureEffect",null),h([y()],O.prototype,"filter",null),h([y()],O.prototype,"hasEffects",null),h([y()],O.prototype,"includedEffects",null),h([y({value:0})],O.prototype,"scale",null),h([y()],O.prototype,"transitioning",null),h([y()],O.prototype,"transitioningToEmpty",null),O=h([H("esri.layers.effects.FeatureEffectView")],O);let le=class extends Re{constructor(){super(...arguments),this.features=[]}readFeatures(e,t){var s;const i=Rt.fromJSON(t.spatialReference),r=[];for(let a=0;a<e.length;a++){const n=e[a],o=Te.fromJSON(n),u=(s=n.geometry)==null?void 0:s.spatialReference;o.geometry==null||u||(o.geometry.spatialReference=i);const l=n.aggregateGeometries,c=o.aggregateGeometries;if(l&&c!=null)for(const d in c){const m=c[d],f=l[d],g=f==null?void 0:f.spatialReference;m==null||g||(m.spatialReference=i)}r.push(o)}return r}};h([y({type:[Te],json:{write:!0}})],le.prototype,"features",void 0),h([Jt("features")],le.prototype,"readFeatures",null),le=h([H("esri.rest.support.AggregateFeatureSet")],le);let qi=class{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}find(e){for(const t of this.values())if(t.techniqueRef.type===e)return t;return null}updateStart(e){e&&(this._instanceByIdNext=new Map,this._shaderCountByMesh=new Map,this._shaderIndices=new Map)}updateEnd(e){if(e){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const t of this._instanceById.keys())this._instanceByIdNext.has(t)||this._instanceById.delete(t);for(const[t,i]of this._instanceByIdNext.entries()){const r=this._instanceById.get(t);r?r.setInput(i.getInput()):this._instanceById.set(t,i)}this._instanceByIdNext=null,this._shaderCountByMesh=null,this._shaderIndices=null}}values(){return this._instanceById.values()}ensureInstance(e,t){let i;if(typeof t=="object"&&"optionalAttributes"in t&&"uniforms"in t){const s=`${e.type}.${JSON.stringify(t.optionalAttributes)}`,a=s+`.${JSON.stringify(t.uniforms)}`;let n=0;this._instanceByIdNext!=null&&(this._shaderIndices.has(a)?n=this._shaderIndices.get(a):(n=this._shaderCountByMesh.get(s)??0,this._shaderCountByMesh.set(s,n+1),this._shaderIndices.set(a,n))),i=s+`.${n}`}else i=`${e.type}.${JSON.stringify(t)}`;const r=ct(i);if(this._instanceByIdNext){const s=new We(Ke(r),e,t);return this._instanceByIdNext.set(r,s),s}if(!this._instanceById.has(r)){const s=new We(Ke(r),e,t);this._instanceById.set(r,s)}return this._instanceById.get(r)}getInstance(e){const t=this._instanceById.get(e);if(t==null)throw new Error(`InternalError: Unable to get instance for ${e}`);return t}};const Mi=1e3;let Pi=class{constructor(e,t,i,r,s,a){this.getStage=e,this.getSubscriptionVersion=t,this.version=i,this._fader=r,this._container=s,this._tileInfoView=a,this._pendingUpdates=new ht(Mi),this._locked=!1,this._tiles=new Map}destroy(){for(const e of this.tiles())this._fader.unregisterFeatureTile(e),e.destroy();this._pendingUpdates.clear(),this._tiles.clear(),this._container=null,this._fader=null}tiles(){return this._tiles.values()}size(){return this._tiles.size}get usedMemory(){let e=0;for(const t of this._tiles.values())e+=t.usedMemory;for(const t of this._pendingUpdates.entries)t&&(e+=Ai(t.inner));return e}getTile(e){return this._tiles.get(e)}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(t==null||t.inner.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){const t=this._tiles.get(e);I("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t&&(this._fader.unregisterFeatureTile(t),t.destroy()),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady&&t.decluttered}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();e!=null&&this._updateTile(e)}for(const e of this._tiles.values())e.upload()}_updateTile(e){var o;const{inner:t,objectIdMap:i}=e,r=this.getSubscriptionVersion(t.id);if(r!==t.subscriptionVesrion){if(I("esri-2d-update-debug")){const u=`${t.subscriptionVesrion} != ${r}`;console.debug(`Version[${u}] Tile[${t.id}] FeatureContainer - Dropping message, outdated version]`,t)}return}if(I("esri-2d-update-debug")){const u=((o=t.debugInfo)==null?void 0:o.chunkId)??"<EnsureEnd>";console.debug(`Version[${t.version}] Tile[${t.id}] Chunk[${u}] RenderState.updateTile [${t.type}]`,t)}const s=this._ensureTile(t.id);if(t.type==="update"){const[u,...l]=t.modify;s.onMessage({type:"update",modify:u,remove:t.remove,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const c of l){const d=this._tiles.get(c.tileId);d&&d.onMessage({type:"update",modify:c,remove:t.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}return}if(t.append==null)return void s.onMessage({type:"append",clear:t.clear,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});const[a,...n]=t.append;s.onMessage({type:"append",clear:t.clear,append:a,debugInfo:t.debugInfo,end:t.end,attributeEpoch:t.attributeEpoch,objectIdMap:i});for(const u of n){const l=this._tiles.get(u.tileId);l&&l.onMessage({type:"update",modify:u,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null,objectIdMap:i})}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){var u;I("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new Oe(e),i=this._tileInfoView.getTileBounds(Lt(),t),r=i[0],s=i[3],a=this._tileInfoView.getTileResolution(t.level),n=(u=this._container.instanceStore.find(18))==null?void 0:u.instanceId,o=new oi(t,a,r,s,this._fader,n,!0);if(this._fader.registerFeatureTile(o),o.stage=this.getStage(),!o.stage){const l=new T("featurelayerview:webgl","Cannot create tile with empty stage");C.getLogger("esri.views.2d.layers.features.RenderState").error(l)}return o}_copyPixelBufferedEntitiesInto(e){let t=7;const i=this._tileInfoView.getLODInfoAt(e.key);for(let r=-1;r<=1;r++)for(let s=-1;s<=1;s++){if(r===0&&s===0)continue;const a=e.key.getNormalizedNeighbor(s,r,i).id,n=this._tiles.get(a);if(n!=null){const o=1<<t;e.copyPixelBufferedEntitesFrom(n,o,s,r)}t--}}};function Ai(e){switch(e.type){case"update":return e.modify.reduce((t,i)=>t+Ye(i),0);case"append":return e.append?e.append.reduce((t,i)=>t+Ye(i),0):0}}function Ye(e){return e.entities.byteLength+e.data.reduce((t,i)=>t+Ui(i),0)}function Ui(e){var t;return e.indices.byteLength+e.vertices.byteLength+(((t=e.metrics)==null?void 0:t.byteLength)??0)}let Di=class{constructor(e,t){this.id=e,this.version=t,this._resolver=he(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}},Ni=class extends ri{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new pt,this._hitTestsRequests=[],this._store=new qi,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._shouldUnlockAttributeView=!1,this._layerView=e,this.addTransitionable(this._layerView.featureEffectView)}destroy(){this.updatingHandles.destroy(),super.destroy(),this._renderState=xe(this._renderState),this._renderStateNext=xe(this._renderStateNext)}renderChildren(e){var i,r;if(this._updateAttributeView(),(i=this._renderState)==null||i.update(this.attributeView.currentEpoch),this._layerView.requestUpdate(),this._renderState){const s=Array.from(this._renderState.tiles()).filter(a=>a.needsUpload);s.length&&(s[Math.floor(Math.random()*s.length)].upload(),s.length>=2&&this.requestRender());for(const a of this._renderState.tiles())a.tryReady(this.attributeView.currentEpoch)&&((r=this._subscriptions.get(a.key.id))==null||r.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter(),this.requestRender())}const t=this._layerView.subscriptionManager.updateVisibility();this.setVisibleTiles(t);for(const s of this.children)s.setTransform(e.state);switch(super.renderChildren(e),e.drawPhase){case 1:return this._renderMapPhase(e);case 16:return this._renderHighlightPhase(e);case 2:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}get usedMemory(){let e=0;return this._renderState&&(e+=this._renderState.usedMemory),this._renderStateNext&&(e+=this._renderStateNext.usedMemory),e+=this.attributeView.usedMemory,e}get instanceStore(){return this._store}get layerView(){return this._layerView}get tiles(){var e;return(e=this._renderState)==null?void 0:e.tiles()}get _instanceStore(){return this._store}get _layer(){return this._layerView.layer}_getHeatmapInstance(e){if(this._instanceStore==null||!(e.drawPhase&V.heatmap.drawPhase))return null;for(const t of this._instanceStore.values())if(Li(t))return t;return null}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&(this._layerView.view.labelManager.requestUpdate(),this._layerView.view.labelManager.symbolFader.restartDeclutter())}updateSubscriptions(e){var t;for(const{tileId:i,version:r}of e.subscribe){if(!this._subscriptions.has(i)){const s=new Di(i,r);this._subscriptions.set(i,s),this.updatingHandles.addPromise(s.promise);continue}this._subscriptions.get(i).version=r}for(const i of e.unsubscribe)(t=this._subscriptions.get(i))==null||t.destroy(),this._subscriptions.delete(i),this.removeTile(i)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}async updateRenderState(e){I("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),this._renderStateNext=new Pi(()=>this._stage,t=>{var i;return(i=this._subscriptions.get(t))==null?void 0:i.version},e,this.layerView.view.labelManager.symbolFader,this,this.tileInfoView)}getDisplayStatistics(e,t){const i=this._statisticsByLevel.get(e);return i?i.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let i=this._statisticsByLevel.get(e);i||(i=new Map,this._statisticsByLevel.set(e,i));for(const r of t)i.set(r.fieldName,{minValue:r.minValue,maxValue:r.maxValue})}lockForOverrides(){var e;(e=this._renderState)==null||e.lockUploads(),this._lockStatisticUpdates=!0,this.attributeView.locked||(this.attributeView.lockTextureUploads(),this._shouldUnlockAttributeView=!0)}unlockForOverrides(){var e,t;(e=this._renderState)==null||e.unlockUploads(),this._shouldUnlockAttributeView&&(this.attributeView.unlockTextureUploads(),this._shouldUnlockAttributeView=!1),this._lockStatisticUpdates=!1;for(const i of this._updateStatisticsRequests)this.updateStatistics(i.level,i.statistics);this._updateStatisticsRequests=[],(t=this._renderState)==null||t.flush(),this.requestRender()}trySwapRenderState(){var e,t;if(this._renderStateNext){I("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`);const i=new Map;for(const r of((e=this._renderState)==null?void 0:e.tiles())||[])i.set(r.id,r.metricsVisibility);(t=this._renderState)==null||t.destroy(),this._renderState=this._renderStateNext,this._renderState.flush();for(const r of this._renderState.tiles())r.copyMetricsVisibility(i.get(r.id)||new Set);this._renderStateNext=null}this.requestRender()}setVisibleTiles(e){this._visibleTiles=e;for(const t of this.tiles??[])t.rendering=e.has(t.key.id)}async onMessage(e,t){Ee(t);const i=e.inner;if(!this._subscriptions.has(i.id))return;const r=this._subscriptions.get(i.id);if(r.version!==i.subscriptionVesrion){if(I("esri-2d-update-debug")){const a=`${i.subscriptionVesrion} != ${r.version}`;console.debug(`Version[${a}] Tile[${i.id}] FeatureContainer - Dropping message, outdated version]`,i)}return}const s=this._renderStateNext??this._renderState;if(!s)throw new Error("InternalError: No renderState defined");s.version!==i.version&&console.error(`InternalError: Version mismatch. [renderState: ${s.version}, message: ${i.version}]`),s.enqueueUpdate(e),this.requestRender(),this._layerView.view.labelManager.requestUpdate(),this._layerView.requestUpdate()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find(({x:r,y:s})=>r===e.x&&s===e.y);const i=he();return t?t.resolvers.push(i):(t={x:e.x,y:e.y,resolvers:[i]},this._hitTestsRequests.push(t)),this.requestRender(),i.promise}getSortKeys(e){const t=new Set(e),i=new Map;for(const r of this.children)if(r.getSortKeys(t).forEach((s,a)=>i.set(a,s)),i.size===t.size)break;return i}get hasAnimation(){return this.hasLabels}doRender(e){const{minScale:t,maxScale:i}=this._layer.effectiveScaleRange,r=e.state.scale;r<=(t||1/0)&&r>=i&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){if(this._getHeatmapInstance(e)==null)super.setStencilReference(e);else for(const t of this.children)t.stencilRef=V.heatmap.getStencilReference(t)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,0),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&li(e,!1,t=>{this._renderFeatures(t,1)})}_renderLabelPhase(e){this._renderFeatures(e,0)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,2),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,3),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,i=e.painter.effects.hittest,r=t.getBoundFramebufferObject(),s=t.getViewport(),a=e.passOptions,n=e.drawPhase;i.bind(e),e.passOptions=i.createOptions(e,this._hitTestsRequests),e.drawPhase=8;const{distance:o,smallSymbolDistance:u}=e.passOptions,l=Math.max(o,u);for(const c of this.children)c.visible&&c.containsScreenPoint(e.state,e.passOptions.position,2*l)&&this._renderTile(c,e,0);i.draw(e),i.unbind(),t.bindFramebuffer(r),t.restoreViewport(s),e.passOptions=a,e.drawPhase=n}_renderFeatures(e,t){const i=this._getHeatmapInstance(e);i!=null?this._renderHeatmapFeatures(e,t,i):this._renderGeometryFeatures(e,t)}_renderGeometryFeatures(e,t){for(const i of this.children)i.visible&&this._renderTile(i,e,t)}_renderHeatmapFeatures(e,t,i){for(const r of this.children)r.visible&&this._renderTile(r,e,t,17);i.techniqueRef.renderResolvePass(e,i)}_renderTile(e,t,i,r){const s=I("featurelayer-strict-draw-order")?1:I("featurelayer-force-marker-text-draw-order")?2:0,a=e.getDisplayList(this._instanceStore,s);t.selection=i,a==null||a.render(t,r)}};function Li(e){return e.techniqueRef.type===17}async function Gi(e){const t=await ui("FeaturePipelineWorker",{client:e,strategy:"dedicated"});return new Bi(t)}let Bi=class{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}};const Qi=10;let z=class extends ot{constructor(){super(...arguments),this.events=new Et,this._updatingStrategy=!0,this._tileToEvent=new ci,this._fetchStatus={outstanding:0,done:0},this._pipelineStatistics={type:"performance",usedMemory:0}}get hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}get pipelineStatistics(){return this._pipelineStatistics}get willQueryAllFeatures(){var e;return((e=this._strategyInfo)==null?void 0:e.willQueryAllFeatures)??!1}get willQueryFullResolutionGeometry(){var e;return((e=this._strategyInfo)==null?void 0:e.willQueryAllFeatures)??!1}onEvent(e){switch(e.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(e);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=e.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",e);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),e.done&&(this._fetchStatus={done:0,outstanding:0});break;case"performance":this._pipelineStatistics=e}}_hasAllTileData(){var e;for(const t of this._tileToEvent.values())if(((e=t.peekLast())==null?void 0:e.type)!=="loaded")return!1;return!0}_handleTileEvent(e){switch(e.type){case"subscribe":{const t=new ht(Qi);t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"unsubscribe":this._tileToEvent.delete(e.tile);break;case"loaded":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t);break}case"error":{const t=this._tileToEvent.get(e.tile);if(!t)return;t.enqueue(e),this._tileToEvent.set(e.tile,t),this.events.emit("error",e),C.getLogger(this).error(`Failed to load tile ${e.tile}.`,{error:e.error});break}}}};h([y({readOnly:!0})],z.prototype,"hasAllData",null),h([y()],z.prototype,"pipelineStatistics",null),h([y()],z.prototype,"willQueryAllFeatures",null),h([y()],z.prototype,"willQueryFullResolutionGeometry",null),h([y()],z.prototype,"_updatingStrategy",void 0),h([y()],z.prototype,"_strategyInfo",void 0),h([y()],z.prototype,"_tileToEvent",void 0),h([y()],z.prototype,"_pipelineStatistics",void 0),z=h([H("esri.views.2d.layers.features.FeatureSourceEventLog")],z);function M(e){switch(e.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"mesh":case"polygon":return"esriGeometryPolygon";case"multipatch":return"esriGeometryMultiPatch";case"multipoint":return"esriGeometryMultipoint";default:return null}}const ji=Math.PI;function ft(e,t){switch(t.transformationType){case"additive":return $i(e,t);case"constant":return Ji(t,e);case"clamped-linear":return Hi(e,t);case"proportional":return Wi(e,t);case"stops":return Ki(e,t);case"real-world-size":return Zi(e,t);case"identity":return e;case"unknown":return null}}function D(e,t){return typeof e=="number"?e:ft(t,e)}function $i(e,t){return e+(D(t.minSize,e)||t.minDataValue)}function Ji(e,t){const i=e.stops;let r=(i==null?void 0:i.length)&&i[0].size;return r==null&&(r=e.minSize),D(r,t)}function Hi(e,t){const i=t.minDataValue,r=t.maxDataValue,s=(e-i)/(r-i),a=D(t.minSize,e),n=D(t.maxSize,e);return e<=i?a:e>=r?n:a+s*(n-a)}function Wi(e,t){const i=e/t.minDataValue,r=D(t.minSize,e),s=D(t.maxSize,e);let a=null;return a=i*r,Qt(a,r,s)}function Ki(e,t){const[i,r,s]=Xi(e,t.cache.ipData);if(i===r)return D(t.stops[i].size,e);{const a=D(t.stops[i].size,e);return a+(D(t.stops[r].size,e)-a)*s}}function Zi(e,t){const i=di[t.valueUnit],{valueRepresentation:r}=t;let s=null;return s=r==="area"?2*Math.sqrt(e/ji)/i:r==="radius"||r==="distance"?2*e/i:e/i,s}function Xi(e,t){if(!t)return;let i=0,r=t.length-1;return t.some((s,a)=>e<s?(r=a,!0):(i=a,!1)),[i,r,(e-t[i])/(t[r]-t[i])]}function N(e){var t;return(e.labelsVisible&&((t=e.labelingInfo)==null?void 0:t.every(i=>i.deconflictionStrategy!=="none")))??!1}function W(e,t){var r;const i=F(e,t);if(i!=null&&i.labelsVisible&&((r=i.labelingInfo)!=null&&r.length))return i.labelingInfo.every(s=>s.deconflictionStrategy!=="none")}function Yi(e){return t=>Y(ft(t,e))}function Q(e){const t=e!=null&&"visualVariables"in e&&e.visualVariables;if(!t)return null;for(const i of t)if(i.type==="size")return Yi(i);return null}let K=class{constructor(){this._cache=new Map}async executeExceedsLimitQuery(e,t,i){const r=mi.createFeature(e.metadata),s=fi.create(e,t,r).createQuery();s.inner.orderByFields=[],s.inner.returnGeometry=!1,s.inner.cacheHint=!0;const a=e.metadata.geometryType!=="esriGeometryPoint",n=JSON.stringify({source:e.source,query:s.inner.toJSON(),customParameters:s.customParameters,snapshotInfo:i,isPoints:a});let o=this._cache.get(n);return o==null&&(o=await er(e.source,a,s,i),this._cache.set(n,o)),o}};async function er(e,t,i,r){var s;if(!r.supportsExceedsLimit)return et(e,t,i,r);try{const a=i.inner.clone(),n=new ti;return n.statisticType="exceedslimit",n.maxPointCount=r.maxFeatureCount,n.maxRecordCount=r.maxFeatureCount,n.outStatisticFieldName="exceedslimit",r.maxVertexCount&&(n.maxVertexCount=r.maxVertexCount),a.outStatistics=[n],((s=(await pi(e,a,void 0,{query:i.customParameters})).data.features[0])==null?void 0:s.attributes.exceedslimit)!==0}catch{return et(e,t,i,r)}}async function et(e,t,i,r){if(t)return!0;const s=i.inner.clone();try{return(await hi(e,s,{query:i.customParameters})).data.count>r.maxFeatureCount}catch{return!0}}async function Z(e,t,i){return{type:"feature",service:e,strategy:await tr(e,i,t,i.cache)}}async function tr(e,t,i,r){var l,c,d;const s=t.customParameters??{};t.apiKey&&(s.apiKey=t.apiKey);const a=t.displayFilterEnabled?(l=t.displayFilterInfo)==null?void 0:l.toJSON():null,n=(c=t.historicMoment)==null?void 0:c.getTime(),o=(d=t.timeExtent)==null?void 0:d.toJSON(),u={...t,displayFilterInfo:a,customParameters:s,historicMoment:n,timeExtent:o};return e.type==="feature-service"&&i!=null&&!await r.executeExceedsLimitQuery(e,u,i)?{type:"snapshot",snapshotInfo:i,partial:{availableFields:t.availableFields},full:{displayFilterInfo:null,queryScaleRanges:null,sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:n,timeExtent:o}}:e.type==="feature-service"&&e.isSourceHosted||e.type==="memory"||e.type==="ogc"?{type:"paged-tile",partial:{availableFields:t.availableFields},full:{sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:n,queryScaleRanges:t.queryScaleRanges,timeExtent:o,displayFilterInfo:a}}:{type:"drill-down",partial:{availableFields:t.availableFields},full:{sourceRefreshVersion:t.sourceRefreshVersion,definitionExpression:t.definitionExpression,customParameters:t.customParameters,gdbVersion:t.gdbVersion,historicMoment:n,queryScaleRanges:t.queryScaleRanges,timeExtent:o,displayFilterInfo:a}}}function qe(e,t,i,r,s,a){const n=ar(r);if(!(I("featurelayer-snapshot-enabled")&&(i!=null&&i.query.supportsPagination)&&!(i!=null&&i.operations.supportsEditing)&&!t))return null;const o=sr(s,a),{min:u,max:l}=n,c=o?l:u,d=rr(r);let m=I("featurelayer-snapshot-initial-tolerance");return r!=="esriGeometryPoint"&&r!=="esriGeometryMultipoint"||(m=null),{supportsExceedsLimit:ir(e,i),initialTolerance:m,maxFeatureCount:c,maxVertexCount:d}}function ir(e,t){return!(!e&&!I("featurelayer-snapshot-non-hosted-exceedslimit-enabled"))&&(t==null?void 0:t.operations.supportsExceedsLimitStatistics)}function rr(e){switch(e){case"esriGeometryPoint":case"esriGeometryPolyline":case"esriGeometryPolygon":case"esriGeometryMultiPatch":case"esriGeometryMultipoint":return I("featurelayer-snapshot-max-vertex-count")}}function sr(e,t){const i=t==null?void 0:t.clone().intersection(e),r=i!=null?i.width*i.height:0,s=t?t.width*t.height:0,a=s===0?0:r/s,n=I("featurelayer-snapshot-coverage");return!isNaN(a)&&a>=n}function ar(e){switch(e){case"esriGeometryMultipoint":return{min:I("featurelayer-snapshot-multipoint-min-threshold"),max:I("featurelayer-snapshot-multipoint-max-threshold")};case"esriGeometryPoint":return{min:I("featurelayer-snapshot-point-min-threshold"),max:I("featurelayer-snapshot-point-max-threshold")};case"esriGeometryMultiPatch":case"esriGeometryPolygon":return{min:I("featurelayer-snapshot-polygon-min-threshold"),max:I("featurelayer-snapshot-polygon-max-threshold")};case"esriGeometryPolyline":return{min:I("featurelayer-snapshot-polyline-min-threshold"),max:I("featurelayer-snapshot-polyline-max-threshold")}}}function nr(e,t,i=0){if(t==null)return e[i]=0,e[i+1]=0,e[i+2]=0,void(e[i+3]=0);const{r,g:s,b:a,a:n}=t;e[i]=r*n/255,e[i+1]=s*n/255,e[i+2]=a*n/255,e[i+3]=n}async function q(e,t){if(!e)return[];switch(e.type){case"simple-fill":return Ce(e,t);case"picture-fill":return mr(e,t);case"simple-marker":return tt(e,t);case"picture-marker":return cr(e,t);case"simple-line":return X(e,t,!1);case"text":return pr(e,t);case"label":return hr(e,t);case"cim":return be(e.data,t);case"web-style":return q(await e.fetchSymbol({acceptedFormats:["cim","web"]}),t);case"line-3d":return C.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-line`),X(new $t,t,!1);case"point-3d":return C.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-marker`),tt(new jt,t);case"polygon-3d":return C.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Defaulting to simple-fill`),Ce(new dt,t);case"mesh-3d":case"label-3d":return C.getLogger("esri.views.layers.FeatureLayerView").warn("unsupported-symbol",`Symbol of type "${e.type}" unsupported in MapView. Ignoring`),[];case"CIMSymbolReference":throw new Error("InternalError: CIMSymbolReference should already be resolved")}}async function or(e,t){const{schemaOptions:i}=t,{store:r}=i,s=new Array(pe),a=new Array(pe/4);for(let d=0;d<pe;d++){const m=d<e.attributes.length?e.attributes[d].color:null;s[d]=[0,0,0,0],nr(s[d],m)}for(let d=0;d<pe/4;d++)a[d]=[0,0,0,0],a[d][0]=4*d<e.attributes.length?1:0,a[d][1]=4*d+1<e.attributes.length?1:0,a[d][2]=4*d+2<e.attributes.length?1:0,a[d][3]=4*d+3<e.attributes.length?1:0;const n={uniforms:{isActive:a,colors:s,dotValue:e.dotValue,dotScale:e.referenceScale,blending:e.dotBlendingEnabled,dotSize:e.dotSize,seed:e.seed},optionalAttributes:{}},o=r.ensureInstance(V.dotDensity,n).createMeshInfo({effects:null}),u=[],l=new dt({color:e.backgroundColor??[0,0,0,0],outline:null}),c=await q(l,t);if(u.push(...c),u.push(o),e.outline){const d=X(e.outline,t,!0);u.push(...d)}return u}async function lr(e,t){const{store:i}=t,{radius:r,minDensity:s,maxDensity:a,referenceScale:n,field:o,valueExpression:u,colorStops:l}=e,c=bi(l);return[i.ensureInstance(V.heatmap,{uniforms:{radius:Y(r),minDensity:s,maxDensity:a,referenceScale:n,isFieldActive:!(!o&&!u),gradient:c,gradientHash:c.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]}async function ur(e,t){var n,o,u,l;const{store:i}=t,r=((n=e.outline)==null?void 0:n.width)||0,s=k(e),a=i.ensureInstance(V.pieChart,{uniforms:{shader:{outlineWidth:Math.round(Y(r)),defaultColor:de(e.defaultColor),outlineColor:de((o=e.outline)==null?void 0:o.color),othersColor:de((u=e.othersCategory)==null?void 0:u.color),donutRatio:e.holePercentage,sectorThreshold:((l=e.othersCategory)==null?void 0:l.threshold)||0,colors:e.attributes.map(c=>de(c.color)),visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,hittestUniforms:null,highlightUniforms:null},numberOfFields:e.attributes.length},optionalAttributes:{}}).createMeshInfo({size:e.size,outlineWidth:r,effects:null,scaleInfo:null,minPixelBuffer:J(s)});return[...e.backgroundFillSymbol?await Ce(e.backgroundFillSymbol,{schemaOptions:t,uniforms:ve}):[],a]}function mt(e){if(e.style==="path"){if(e.path==null)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:e.path,asFill:!0}}}const t=ee.fromSimpleMarker(e);if("outline"in e&&e.outline&&e.outline.style!=="none"&&e.outline.style!=="solid"){if(!t||!t.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:t.symbolLayers[0],overrides:[]}}return{type:"sprite-rasterization-param",resource:Ii(t),overrides:[]}}async function tt(e,t){var m,f,g,v,S;const{uniforms:i,schemaOptions:r}=t,{store:s}=r;if(e.style==="path"||e.outline&&e.outline.style!=="solid"&&e.outline.style!=="none"){const p=ee.fromSimpleMarker(e);if(!p||!p.symbolLayers)throw new Error("Error handling marker! ");if(i.visualVariableRotation&&(p.angleAlignment="Map"),e.style!=="path"){const b=p.symbolLayers[0];if(ue(t.uniforms)){const _=J(t.uniforms,0,1);if(_>b.size){const x=_/b.size;b.size=_;const E=(m=b.markerGraphics)==null?void 0:m[0].symbol;(E.symbolLayers&&E.symbolLayers[0]).width*=x}}}return be({type:"CIMSymbolReference",symbol:p},t)}const a=s.ensureInstance(V.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=mt(e);let o=((f=e.color)==null?void 0:f.toArray())??[0,0,0,0];n.resource.type==="CIMVectorMarker"&&(o=[255,255,255,255]);const u=e.style==="triangle"?124/116:1,l=e.size,c=l*u,d=i.visualVariableColor!=null&&(e.style==="cross"||e.style==="x");return[a.createMeshInfo({type:"simple",color:o,height:l,width:c,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:ze(i)?1:0,outlineColor:((v=(g=e.outline)==null?void 0:g.color)==null?void 0:v.toArray())??[0,0,0,0],outlineSize:((S=e.outline)==null?void 0:S.width)??1,referenceSize:l,sprite:n,overrideOutlineColor:d,hasSizeVV:ue(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:J(i)})]}function cr(e,t){const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=s.ensureInstance(V.marker,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),n=ee.createPictureMarkerRasterizationParam(e);return n?[a.createMeshInfo({type:"picture",color:[255,255,255,255],height:e.height,width:e.width,offsetX:e.xoffset,offsetY:e.yoffset,angle:e.angle,alignment:ze(i)?1:0,outlineColor:null,outlineSize:0,referenceSize:e.height,sprite:n,overrideOutlineColor:!1,hasSizeVV:ue(i),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:J(i)})]:[]}function dr(e,t,i){var v,S;const{uniforms:r,schemaOptions:s}=i,{store:a}=s,n=a.ensureInstance(V.marker,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue,visualVariableRotation:r.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),o=mt(e),u=6,l=u*t.width,c=l,d=((v=e.color)==null?void 0:v.toArray())??((S=t.color)==null?void 0:S.toArray())??[0,0,0,0],m=e.style==="cross"||e.style==="x";let f;switch(e.placement){case"begin-end":f="Both";break;case"begin":f="JustBegin";break;case"end":f="JustEnd";break;default:f="None"}const g={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:f,offsetAlongLine:0},overrides:[]};return[n.createMeshInfo({type:"simple",color:d,height:c,width:l,offsetX:0,offsetY:0,angle:0,alignment:ze(r)?1:0,outlineColor:d,outlineSize:m?t.width:0,referenceSize:c/u,sprite:o,overrideOutlineColor:m&&r.visualVariableColor!=null,hasSizeVV:ue(r),placement:g,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:J(r)})]}function pr(e,t){var a,n,o,u;const{uniforms:i,schemaOptions:r}=t,{store:s}=r;return[s.ensureInstance(V.text,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1,visibility:!1}}).createMeshInfo({boxBackgroundColor:(a=e.backgroundColor)==null?void 0:a.toArray(),boxBorderLineColor:(n=e.borderLineColor)==null?void 0:n.toArray(),boxBorderLineSize:e.borderLineSize??0,color:((o=e.color)==null?void 0:o.toArray())??[0,0,0,0],offsetX:e.xoffset,offsetY:e.yoffset,postAngle:e.angle,fontSize:e.font.size,decoration:e.font.decoration,haloColor:((u=e.haloColor)==null?void 0:u.toArray())??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:[0,0,0,0],outlineSize:0,lineWidth:e.lineWidth,lineHeightRatio:e.lineHeight,horizontalAlignment:e.horizontalAlignment,verticalAlignment:e.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:e.font.toJSON(),textString:e.text,symbol:ee.createCIMTextSymbolfromTextSymbol(e)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:J(i),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,layerId:null,labelClassId:null})]}function hr(e,t){var g,v,S,p,b,_;const{schemaOptions:i,uniforms:r}=t,{store:s}=i,a=e.symbol,{allowOverrun:n,repeatLabel:o,repeatLabelDistance:u}=e,l={maxScale:e.maxScale??0,minScale:e.minScale??0},c=s.ensureInstance(V.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:r.visualVariableRotation,visualVariableSizeMinMaxValue:r.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:r.visualVariableSizeScaleStops,visualVariableSizeStops:r.visualVariableSizeStops,visualVariableSizeUnitValue:r.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0,visibility:!0}}),d=e.labelPlacement,[m,f]=Si(d);return[c.createMeshInfo({boxBackgroundColor:(g=a.backgroundColor)==null?void 0:g.toArray(),boxBorderLineColor:(v=a.borderLineColor)==null?void 0:v.toArray(),boxBorderLineSize:a.borderLineSize??0,color:((S=a.color)==null?void 0:S.toArray())??[0,0,0,0],offsetX:a.xoffset,offsetY:a.yoffset,postAngle:a.angle,fontSize:a.font.size,decoration:a.font.decoration,outlineColor:[0,0,0,0],outlineSize:0,haloColor:((p=a.haloColor)==null?void 0:p.toArray())??[0,0,0,0],haloSize:a.haloSize??0,lineWidth:a.lineWidth,lineHeightRatio:a.lineHeight,horizontalAlignment:m,verticalAlignment:f,repeatLabel:o,repeatLabelDistance:Y(u),allowOverrun:n,labelPosition:e.labelPosition,scaleInfo:l,minPixelBuffer:J(r),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:a.font.toJSON(),textString:a.text,symbol:ee.createCIMTextSymbolfromTextSymbol(a),primitiveName:"label-override"},useLegacyLabelEvaluationRules:((b=e.labelExpressionInfo)==null?void 0:b.expression)==null,overrides:[{valueExpressionInfo:{type:"CIMExpressionInfo",expression:((_=e.labelExpressionInfo)==null?void 0:_.expression)??e.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,layerId:t.layerId,labelClassId:t.labelClassId})]}function Me(e,t){var r;const i=e.width;return{outlineColor:((r=e.color)==null?void 0:r.toArray())||[0,0,0,1],width:i,referenceWidth:i,capType:e.cap??"round",joinType:e.join??"round",miterLimit:e.miterLimit,hasSizeVV:t,outlineUsesColorVV:!1}}function yr(e,t){var l,c,d;const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=((l=e.color)==null?void 0:l.toArray())??[0,0,0,0],n={type:"sprite-rasterization-param",resource:{type:"fill-style",style:e.style},overrides:[]};if(((c=e.outline)==null?void 0:c.style)==="solid")return[s.ensureInstance(V.patternOutlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Me(e.outline,!!i.visualVariableSizeOutlineScaleStops),sprite:n,scaleInfo:null,effects:null})];const o=[],u=s.ensureInstance(V.patternFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:((d=e.color)==null?void 0:d.toArray())??[0,0,0,0],sprite:n,scaleInfo:null,effects:null});return o.push(u),e.outline&&o.push(...X(e.outline,t,!0)),o}function fr(e,t){var o,u;const{uniforms:i,schemaOptions:r}=t,{store:s}=r,a=((o=e.color)==null?void 0:o.toArray())??[0,0,0,0];if(e.style!=="none"&&((u=e.outline)==null?void 0:u.style)==="solid")return[s.ensureInstance(V.outlineFill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,...Me(e.outline,!!i.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})];const n=[];if(e.style!=="none"){const l=s.ensureInstance(V.fill,{uniforms:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:a,scaleInfo:null,effects:null});n.push(l)}return e.outline&&n.push(...X(e.outline,t,!0)),n}async function Ce(e,t){if(e.type==="cim")return be(e.data,t);const{style:i}=e;return i&&i!=="none"&&i!=="solid"?yr(e,t):fr(e,t)}function mr(e,t){const{outline:i}=e,{uniforms:r,schemaOptions:s}=t,{store:a}=s,n=[],o=ee.createPictureFillRasterizationParam(e);if(!o)return[];const{width:u,height:l,xoffset:c,yoffset:d,xscale:m,yscale:f}=e,g={color:[255,255,255,255],sprite:o,height:l,aspectRatio:u/l,offsetX:c,offsetY:d,scaleX:m,scaleY:f,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if((i==null?void 0:i.style)==="solid")return[a.ensureInstance(V.complexOutlineFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity,visualVariableSizeScaleStops:r.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...g,...Me(i,!!r.visualVariableSizeOutlineScaleStops)})];const v=a.ensureInstance(V.complexFill,{uniforms:{visualVariableColor:r.visualVariableColor,visualVariableOpacity:r.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return n.push(v.createMeshInfo(g)),i&&n.push(...X(i,t,!0)),n}function X(e,t,i){const{color:r,style:s,width:a,cap:n,join:o}=e,{schemaOptions:u}=t,{store:l}=u,c=[],d=i?{...ve,visualVariableSizeScaleStops:t.uniforms.visualVariableSizeOutlineScaleStops}:t.uniforms,m={uniforms:{visualVariableColor:d.visualVariableColor,visualVariableOpacity:d.visualVariableOpacity,visualVariableSizeMinMaxValue:d.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:d.visualVariableSizeScaleStops,visualVariableSizeStops:d.visualVariableSizeStops,visualVariableSizeUnitValue:d.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},f={color:(r==null?void 0:r.toArray())??[0,0,0,0],width:a,referenceWidth:a,capType:n,joinType:o,miterLimit:e.miterLimit,hasSizeVV:ue(d),effects:null,scaleInfo:null};if(s==null||s==="solid"){const g=l.ensureInstance(V.line,m).createMeshInfo(f);c.push(g)}else if(s!=="none"){const g=l.ensureInstance(V.texturedLine,m).createMeshInfo({...f,offsetAlongLine:0,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:vi(s,n)},overrides:[]}});c.push(g)}return e.marker!=null&&c.push(...dr(e.marker,e,t)),c}async function L(e,t,i){const r=t.labelsVisible&&t.labelingInfo||[],s=M(t),a=Zt(r,s);return{type:"label",classes:await Promise.all(a.map((n,o)=>gr(e,n,t.labelsVisible,t.labelingInfoSource,o,s,i)))}}async function gr(e,t,i,r,s,a,n){var c;const o=ct(`${r} ${s}`),u=r,l=await q(t,{schemaOptions:e,uniforms:n,layerId:u,labelClassId:o});return{maxScale:t.maxScale,minScale:t.minScale,deconflictionEnabled:t.deconflictionStrategy!=="none"&&i,expression:((c=t.labelExpressionInfo)==null?void 0:c.expression)??t.labelExpression,where:t.where,meshes:l,layerId:u,labelClassId:o,geometryType:a}}async function G(e,t){if(!t)return{type:"simple",meshes:[]};switch(t.type){case"simple":return br(e,t);case"dot-density":return vr(e,t);case"class-breaks":return Sr(e,t);case"unique-value":return Ir(e,t);case"dictionary":return _r(t);case"heatmap":return wr(e,t);case"pie-chart":return Fr(e,t)}}async function br(e,t){const i=t.symbols,r=i.length?i[0]:null,s=k(t);return{type:"simple",meshes:await q(r,{schemaOptions:e,uniforms:s})}}async function vr(e,t){const i=k(t);return{type:"dot-density",meshes:await or(t,{schemaOptions:e,uniforms:i})}}async function Sr(e,t){const i=k(t),r=t.backgroundFillSymbol,s=t.normalizationType,a=s==="log"?"esriNormalizeByLog":s==="percent-of-total"?"esriNormalizeByPercentOfTotal":s==="field"?"esriNormalizeByField":null,n=t.classBreakInfos.map(async c=>({meshes:await q(c.symbol,{path:`renderer-stop-${c.minValue}-${c.maxValue}`,schemaOptions:e,uniforms:i}),min:c.minValue,max:c.maxValue})),o=(await Promise.all(n)).sort((c,d)=>c.min-d.min),u=await q(r,{schemaOptions:e,uniforms:{...ve,visualVariableSizeOutlineScaleStops:i.visualVariableSizeOutlineScaleStops}}),l=await q(t.defaultSymbol,{schemaOptions:e,uniforms:i});return{type:"interval",field:t.field,expression:t.valueExpression,backgroundFill:u,defaultSymbol:l,intervals:o,normalizationField:t.normalizationField,normalizationTotal:t.normalizationTotal,normalizationType:a,isMaxInclusive:t.isMaxInclusive}}async function Ir(e,t){const i=[],r=k(t),s=await q(t.backgroundFillSymbol,{schemaOptions:e,uniforms:{...ve,visualVariableSizeOutlineScaleStops:r.visualVariableSizeOutlineScaleStops}}),a=await q(t.defaultSymbol,{schemaOptions:e,uniforms:r});for(const n of t.uniqueValueInfos??[]){const o=await q(n.symbol,{path:`renderer-unique-value-${n.value}`,schemaOptions:e,uniforms:r});i.push({value:""+n.value,symbol:o})}return{type:"map",field:t.field,expression:t.valueExpression,field2:t.field2,field3:t.field3,fieldDelimiter:t.fieldDelimiter,backgroundFill:s,defaultSymbol:a,map:i}}async function _r(e){const t=k(e),i=await e.getDictionaryInfo(),r=e.scaleExpression,s=r!=null&&r!=="1"?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:e.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0;return{type:"dictionary",dictionaryInfo:i,userConfig:e.config??{},fieldMap:e.fieldMap??{},scaleExpression:s,visualVariableUniforms:t}}async function wr(e,t){return{type:"heatmap",meshes:await lr(t,e)}}async function Fr(e,t){return{type:"pie-chart",meshes:await ur(t,e)}}async function Vr(e,t){const i=t.renderer,r=k(i);return{symbology:await G(e,i),labels:await L(e,t,r)}}async function j(e,t,i,r){var l,c;const s=i.featureReduction;if(s)switch(s.type){case"binning":return Er(s,e,t,i,r);case"cluster":return Rr(s,e,t,i,r)}if((l=i.trackInfo)!=null&&l.enabled)return Or(i.trackInfo,e,t,i,r);const a=Cr(i.orderBy,i.renderer,i.objectIdField),n=ke(i.renderer,t.filters),o=await Vr(e,i),u=Se(o.symbology);return{storage:n,mesh:{properties:{sortKey:a,timeZone:t.timeZone,returnMeshObjectId:u,displayRefreshVersion:r,currentUser:t.currentUser},strategy:{type:"feature"},factory:o},expressionProperties:{timeExtent:(c=t.timeExtent)==null?void 0:c.toJSON()}}}function Pe(e,t){return e.fields.map(i=>({...i.toJSON(),type:xr(i,t)}))}function xr(e,t){const{onStatisticExpression:i,onStatisticField:r,statisticType:s}=e;switch(s){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(i){const{returnType:n}=i;return n?n==="string"?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const a=t.find(n=>n.name===r);return a?a.type:"esriFieldTypeString"}}}async function Er(e,t,i,r,s){var f;const a=Pe(e,r.fields),n=e.renderer,o=await G(t,n),u=ke(n,[null,null]),l=k(n),c=await L(t,{geometryType:"polygon",labelingInfoSource:r.labelingInfoSource+"-binning",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},l),d=Se(o),m=e.binType==="geohash"?{type:"geohash",fixBinLevel:e.fixedBinLevel??3}:{type:"grid",size:Y(e.size),fixedBinLevel:e.fixedBinLevel};return{storage:u,mesh:{properties:{sortKey:null,timeZone:i.timeZone,returnMeshObjectId:d,displayRefreshVersion:s,currentUser:i.currentUser},strategy:{type:"binning",fields:a,index:m,featureFilter:i.filters[0]},factory:{labels:c,symbology:o}},expressionProperties:{timeExtent:(f=i.timeExtent)==null?void 0:f.toJSON()}}}async function Rr(e,t,i,r,s){var d;const a=Pe(e,r.fields),n={type:"cluster",feature:await G(t,e.effectiveFeatureRenderer),cluster:await G(t,e.effectiveClusterRenderer)},o=k(e.effectiveFeatureRenderer),u={type:"cluster",feature:await L(t,r,o),cluster:await L(t,{geometryType:"point",labelingInfoSource:r.labelingInfoSource+"-clusters",labelingInfo:e.labelingInfo,labelsVisible:e.labelsVisible},o)},l=ke(e.effectiveFeatureRenderer,[null,null]),c=Se(n);return{storage:l,mesh:{properties:{sortKey:null,timeZone:i.timeZone,displayRefreshVersion:s,returnMeshObjectId:c,currentUser:i.currentUser},strategy:{type:"cluster",fields:a,featureFilter:i.filters[0],clusterRadius:Y(e.clusterRadius/2)},factory:{labels:u,symbology:n}},expressionProperties:{timeExtent:(d=i.timeExtent)==null?void 0:d.toJSON()}}}async function Or(e,t,i,r,s){var c,d;const a=Pe(e,r.fields),n={type:"track",previousObservation:await G(t,e.previousObservations.renderer),latestObservation:await G(t,e.latestObservations.renderer),trackLine:await G(t,e.trackLines.renderer)},o={type:"track",previousObservation:await L(t,{geometryType:r.geometryType,labelingInfoSource:r.labelingInfoSource+"-track-prev",labelingInfo:e.previousObservations.labelingInfo,labelsVisible:e.previousObservations.labelsVisible},k(e.previousObservations.renderer)),latestObservation:await L(t,{geometryType:r.geometryType,labelingInfoSource:r.labelingInfoSource+"-track-latest",labelingInfo:e.latestObservations.labelingInfo,labelsVisible:e.latestObservations.labelsVisible},k(e.latestObservations.renderer)),trackLine:await L(t,{geometryType:"polyline",labelingInfoSource:r.labelingInfoSource+"-track-line",labelingInfo:e.trackLines.labelingInfo,labelsVisible:e.trackLines.labelsVisible},k(e.trackLines.renderer))},u=ai(e,[null,null]),l=Se(n);return{storage:u,mesh:{properties:{sortKey:null,timeZone:i.timeZone,returnMeshObjectId:l,displayRefreshVersion:s,currentUser:i.currentUser},strategy:{type:"track",featureFilter:i.filters[0],fields:a,maxDisplayDuration:((c=e.maxDisplayDuration)==null?void 0:c.toMilliseconds())??0,maxDisplayObservationsPerTrack:e.maxDisplayObservationsPerTrack,showLatestObservation:e.latestObservations.visible,showPreviousObservations:e.previousObservations.visible,showTrackLine:e.trackLines.visible,timeField:e.timeField},factory:{labels:o,symbology:n}},expressionProperties:{timeExtent:(d=i.timeExtent)==null?void 0:d.toJSON()}}}function Cr(e,t,i){const r=t!=null&&t.type==="unique-value"&&t.orderByClassesEnabled;if(e!=="default"||r||(e=[new gi({field:i,order:"descending"})]),e!=="default"&&(e==null?void 0:e.length)){e.length;const s=e[0],a=s.order==="ascending"?"asc":"desc";return s.field?{field:s.field,order:a}:s.valueExpression?{expression:s.valueExpression,order:a}:null}return r?{byRenderer:!0,order:"asc"}:null}function ae(e){return e.techniqueType===2}function Se(e){return!!(e.type==="simple"&&e.meshes.some(ae)||e.type==="interval"&&(e.intervals.some(t=>t.meshes.some(ae))||e.backgroundFill.some(ae))||e.type==="map"&&(e.map.some(t=>t.symbol.some(ae))||e.backgroundFill.some(ae)))}let kr=class{constructor(e){this.layer=e,this._cache=new K}getLabelingDeconflictionInfo(e){const t=this.layer,i=N(t);return[{vvEvaluators:{0:Q(t.renderer)},deconflictionEnabled:i}]}async createSourceSchema(e,t){const i=this._createServiceInfo(e);return Z(i,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,i){const{fields:r,geometryType:s,orderBy:a,objectIdField:n,renderer:o,labelingInfo:u,labelsVisible:l}=this.layer,c={featureReduction:null,labelingInfoSource:this.layer.id,fields:r.map(d=>d.toJSON()),geometryType:s,labelingInfo:u,labelsVisible:l,objectIdField:n,orderBy:a??"default",renderer:o==null?void 0:o.clone()};return j(e,t,c,i)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>this.layer.outFields,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}_createServiceInfo(e){var b,_;const t=this.layer,{capabilities:i,editingInfo:r,objectIdField:s,globalIdField:a,datesInUnknownTimezone:n,dateFieldsTimeZone:o,orderBy:u,parsedUrl:l}=t,c=t.fieldsIndex.toJSON(),d=M(t),m=(b=t.timeInfo)==null?void 0:b.toJSON(),f=t.spatialReference.toJSON(),g=ce(l);let v=s;if(u!=null&&u.length){const x=!u[0].valueExpression&&u[0].field;x&&(v=x)}const S=ge(g.path),p=e.spatialReference.toJSON();return{type:"feature-service",source:g,isSourceHosted:S,orderByFields:v,outSpatialReference:p,metadata:{timeReferenceUnknownClient:n,dateFieldsTimeZone:o,globalIdField:a,fieldsIndex:c,geometryType:d,featureIdInfo:{type:"object-id",fieldName:s},timeInfo:m,spatialReference:f,outSpatialReference:p,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:i.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:i.query.supportsDegeneratedQuantizedGeometry,lastEditDate:(_=r==null?void 0:r.lastEditDate)==null?void 0:_.getTime()}}}};function Ie(e){const{objectIdField:t,uniqueIdFields:i}=e;return i!=null&&i.length?i.length>=2?{type:"unique-id-composite",fieldNames:i}:{type:"unique-id-simple",fieldName:i[0]}:{type:"object-id",fieldName:t}}function Ae(e,t){return e.floorInfo!=null&&(e.floorInfo.viewAllLevelIds.length>0||t.floors.length>0)}function Ue(e,t,i){const r=zr(e,t==null?void 0:t.where,i);return r&&(t??(t=new $),t.where=r),t}function zr(e,t,i){var u;if(e.floorInfo==null||!((u=i.floors)!=null&&u.length))return t;let r=i.floors;const{floorField:s,viewAllLevelIds:a}=e.floorInfo;a.length&&(r=a);const n=r.filter(l=>l!=="").map(l=>"'"+l+"'");if(n.push("''"),t==null?void 0:t.includes(s)){let l=new RegExp("AND \\("+s+".*NULL\\)","g");t=t.replace(l,""),l=new RegExp("\\("+s+".*NULL\\)","g"),t=(t=t.replace(l,"")).replaceAll(/\s+/g," ").trim()}let o="("+s+" IN ({ids}) OR "+s+" IS NULL)";return o=o.replace("{ids}",n.join(", ")),U(t,o)}let Tr=class{constructor(e){this.layer=e,this._cache=new K}getLabelingDeconflictionInfo(e){const t=this.layer,i=W(t,e)??N(t),r=F(t,e),s=[...t.labelingInfo||[],...(r==null?void 0:r.labelingInfo)||[]];return[{vvEvaluators:{0:Q(t.renderer)},deconflictionEnabled:i,labelingInfo:s}]}async createSourceSchema(e,t){var l;const i=this._createServiceInfo(e),r=((l=this.layer.editingInfo)==null?void 0:l.lastEditDate)!=null,s=this.layer.refreshInterval>0,a=!r&&s,n=qe(i.isSourceHosted,a,this.layer.capabilities,i.metadata.geometryType,e.extent,this.layer.fullExtent),o=this.layer.subtypeCode!=null?`${this.layer.subtypeField} = ${this.layer.subtypeCode}`:null,u=U(this.layer.definitionExpression,o);return Z(i,n,{definitionExpression:u,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:this.layer.gdbVersion,historicMoment:this.layer.historicMoment,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:u,objectIdField:l,trackInfo:c}=this.layer,d={fields:r.map(m=>m.toJSON()),renderer:s==null?void 0:s.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:l,orderBy:u??"default",trackInfo:c};return j(e,t,d,i)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}addFilters(e,t){return Ue(this.layer,e,t)}getUpdateHashProperties(e){return this.layer.destroyed?[]:[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>F(this.layer,e),()=>Ae(this.layer,e)?e.floors:null,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy,()=>this.layer.outFields,()=>this.layer.renderer,()=>this.layer.subtypeCode,()=>this.layer.trackInfo]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){var _,x,E,te;const t=this.layer,{capabilities:i,editingInfo:r,typeIdField:s,globalIdField:a,datesInUnknownTimezone:n,dateFieldsTimeZone:o,orderBy:u,subtypeField:l}=t,c=t.fieldsIndex.toJSON(),d=M(t),m=(_=t.timeInfo)==null?void 0:_.toJSON(),f=t.spatialReference.toJSON(),g=(x=t.types)==null?void 0:x.map(P=>P.toJSON()),v=ce(this.layer.parsedUrl);this.layer.dynamicDataSource&&(v.query={layer:JSON.stringify({source:this.layer.dynamicDataSource})});let S=this.layer.objectIdField;if(u!=null&&u.length){const P=!u[0].valueExpression&&u[0].field;P&&(S=P)}const p=ge(v.path),b=e.spatialReference.toJSON();return{type:"feature-service",source:v,isSourceHosted:p,orderByFields:S,outSpatialReference:b,metadata:{typeIdField:s??void 0,types:g,timeReferenceUnknownClient:n,dateFieldsTimeZone:o,subtypeField:l,globalIdField:a,fieldsIndex:c,geometryType:d,featureIdInfo:Ie(t),timeInfo:m,spatialReference:f,outSpatialReference:b,subtypes:(E=this.layer.subtypes)==null?void 0:E.map(P=>P.toJSON())},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:i.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:i.query.supportsDegeneratedQuantizedGeometry,lastEditDate:(te=r==null?void 0:r.lastEditDate)==null?void 0:te.getTime()}}}};function it(e){if(!("openPorts"in e))throw new T("featurelayer:source-not-supported","source is not supported")}class rt{constructor(t){this.layer=t,this._cache=new K}openMessagePorts(){return it(this.layer.source),this.layer.source.openPorts()}getLabelingDeconflictionInfo(t){const i=this.layer,r=W(i,t)??N(i),s=F(i,t),a=[...i.labelingInfo||[],...(s==null?void 0:s.labelingInfo)||[]];return[{vvEvaluators:{0:Q(i.renderer)},deconflictionEnabled:r,labelingInfo:a}]}async createSourceSchema(t,i){const r=this._createServiceInfo(t);return Z(r,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:t.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:null,sourceRefreshVersion:i,availableFields:t.availableFields,cache:this._cache})}createProcessorSchema(t,i,r){const{fields:s,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:u,orderBy:l,objectIdField:c}=this.layer,d="trackInfo"in this.layer?this.layer.trackInfo:null,m={fields:s.map(f=>f.toJSON()),renderer:a==null?void 0:a.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:u,objectIdField:c,orderBy:l??"default",trackInfo:d};return j(t,i,m,r)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(t){return[()=>this.layer.definitionExpression,()=>this.layer.displayFilterInfo,()=>this.layer.orderBy,()=>"outFields"in this.layer?this.layer.outFields:null,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>F(this.layer,t),()=>"trackInfo"in this.layer?this.layer.trackInfo:null]}setGraphicOrigin(t){t.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(t){t.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(t){t.origin=this.layer.trackGraphicOrigin}_createServiceInfo(t){var d;const i=this.layer,{capabilities:r,objectIdField:s}=i,a=i.fieldsIndex.toJSON(),n=M(i),o=(d=i.timeInfo)==null?void 0:d.toJSON(),u=i.spatialReference.toJSON();it(i.source);const l=s,c=t.spatialReference.toJSON();return{type:"memory",orderByFields:l,outSpatialReference:c,metadata:{fieldsIndex:a,geometryType:n,featureIdInfo:{type:"object-id",fieldName:i.objectIdField},timeInfo:o,spatialReference:u,outSpatialReference:c,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:"datesInUnknownTimezone"in i?i.datesInUnknownTimezone:null,dateFieldsTimeZone:"dateFieldsTimeZone"in i?i.dateFieldsTimeZone:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:r.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:r.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}}let qr=class{constructor(e){this.layer=e,this._cache=new K}getLabelingDeconflictionInfo(e){const t=this.layer,i=W(t,e)??N(t);return[{vvEvaluators:{0:Q(t.renderer)},deconflictionEnabled:i}]}async createSourceSchema(e,t){const i=this._createServiceInfo(e);return Z(i,null,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:null,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:null,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u}=this.layer,l={fields:r.map(c=>c.toJSON()),renderer:s==null?void 0:s.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:"default"};return j(e,t,l,i)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>F(this.layer,e),()=>Fe(this.layer)]}hasFilters(e){return Fe(this.layer)}addFilters(e,t){if(Fe(this.layer)){const i=U(e==null?void 0:e.where,`${yt}=1`);if(!i)return e;e??(e=new $),e.where=i}return e}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}openMessagePorts(){return this.layer.source.openPorts()}_createServiceInfo(e){var l;const t=this.layer,{capabilities:i,objectIdField:r}=t,s=t.fieldsIndex.toJSON(),a=M(t),n=t.spatialReference.toJSON(),o=r,u=e.spatialReference.toJSON();return{type:"memory",orderByFields:o,outSpatialReference:u,metadata:{fieldsIndex:s,geometryType:a,featureIdInfo:{type:"object-id",fieldName:t.objectIdField},spatialReference:n,outSpatialReference:u,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:(l=t.timeInfo)==null?void 0:l.toJSON(),timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:i.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:i.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}};function Fe(e){var t,i;return e.parentCompositeLayer.type==="link-chart"&&((i=(t=e.parentCompositeLayer.linkChart)==null?void 0:t.linkChartProperties.nonspatialDataDisplay)==null?void 0:i.mode)==="hidden"}let Mr=class{constructor(e){this.layer=e,this._cache=new K}getLabelingDeconflictionInfo(e){const t=this.layer,i=W(t,e)??N(t);return[{vvEvaluators:{0:Q(t.renderer)},deconflictionEnabled:i,labelingInfo:t.labelingInfo}]}async createSourceSchema(e,t){const i=this._createServiceInfo(e);return Z(i,null,{definitionExpression:null,queryScaleRanges:[],displayFilterEnabled:e.displayFilterEnabled,displayFilterInfo:null,customParameters:this.layer.customParameters,gdbVersion:null,historicMoment:null,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:t,availableFields:e.availableFields,cache:this._cache})}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,orderBy:u,objectIdField:l}=this.layer,c={fields:r.map(d=>d.toJSON()),renderer:s==null?void 0:s.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:l,orderBy:u??"default"};return j(e,t,c,i)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>F(this.layer,e),()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>this.layer.orderBy,()=>this.layer.renderer]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){var d;const t=this.layer,{capabilities:i}=t,r=t.fieldsIndex.toJSON(),s=M(t),a=(d=t.timeInfo)==null?void 0:d.toJSON(),n=t.spatialReference.toJSON(),o=t.source.getSource(),u=this.layer.objectIdField,l=ce(i);l.query.maxRecordCount=o.maxRecordCount;const c=e.spatialReference.toJSON();return{type:"ogc",source:o,orderByFields:u,outSpatialReference:c,metadata:{fieldsIndex:r,geometryType:s,featureIdInfo:{type:"object-id",fieldName:t.objectIdField},timeInfo:a,spatialReference:n,outSpatialReference:c,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:l.query.maxRecordCount,supportsCompactGeometry:l.query.supportsCompactGeometry,supportsDefaultSpatialReference:l.query.supportsDefaultSpatialReference,supportsFormatPBF:l.query.supportsFormatPBF,supportsMaxRecordCountFactor:l.query.supportsMaxRecordCountFactor,supportsQuantization:l.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:l.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:l.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}};class Pr{constructor(t){this.layer=t,this._cache=new K}getLabelingDeconflictionInfo(t){const i=this.layer,r=W(i,t)??N(i);return[{vvEvaluators:{0:Q(i.renderer)},deconflictionEnabled:r}]}async createSourceSchema(t,i){var u;const r=this._createServiceInfo(t),s=((u=this.layer.editingInfo)==null?void 0:u.lastEditDate)!=null,a=this.layer.refreshInterval>0,n=!s&&a,o=qe(r.isSourceHosted,n,this.layer.capabilities,r.metadata.geometryType,t.extent,this.layer.fullExtent);return Z(r,o,{definitionExpression:this.layer.definitionExpression,queryScaleRanges:[],displayFilterEnabled:t.displayFilterEnabled,displayFilterInfo:this.layer.displayFilterInfo,customParameters:this.layer.customParameters,gdbVersion:this.layer.gdbVersion,historicMoment:this.layer.historicMoment,timeExtent:this.layer.timeExtent,apiKey:this.layer.apiKey,sourceRefreshVersion:i,availableFields:t.availableFields,cache:this._cache})}createProcessorSchema(t,i,r){const{fields:s,renderer:a,geometryType:n,labelingInfo:o,labelsVisible:u,orderBy:l,objectIdField:c}=this.layer,d={fields:s.map(m=>m.toJSON()),renderer:a==null?void 0:a.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,i),geometryType:n,labelingInfo:o,labelsVisible:u,objectIdField:c,orderBy:l??"default"};return j(t,i,d,r)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}addFilters(t,i){return Ue(this.layer,t,i)}getUpdateHashProperties(t){return[()=>this.layer.outFields,()=>this.layer.orderBy,()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>F(this.layer,t),()=>this.layer.customParameters,()=>Ae(this.layer,t)?t.floors:null]}setGraphicOrigin(t){t.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(t){t.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(t){t.origin=this.layer.trackGraphicOrigin}_createServiceInfo(t){var g;const i=this.layer,{capabilities:r,globalIdField:s,orderBy:a}=i,n=i.fieldsIndex.toJSON(),o=M(i),u=(g=i.timeInfo)==null?void 0:g.toJSON(),l=i.spatialReference.toJSON(),c=ce(this.layer.parsedUrl);let d=this.layer.objectIdField;if(a!=null&&a.length){const v=!a[0].valueExpression&&a[0].field;v&&(d=v)}const m=ge(c.path),f=t.spatialReference.toJSON();return{type:"feature-service",source:c,isSourceHosted:m,orderByFields:d,outSpatialReference:f,metadata:{globalIdField:s,fieldsIndex:n,geometryType:o,featureIdInfo:{type:"object-id",fieldName:i.objectIdField},timeInfo:u,spatialReference:l,outSpatialReference:f,timeReferenceUnknownClient:i.datesInUnknownTimezone,dateFieldsTimeZone:i.dateFieldsTimeZone,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:r.query.maxRecordCount,supportsCompactGeometry:r.query.supportsCompactGeometry,supportsDefaultSpatialReference:r.query.supportsDefaultSpatialReference,supportsFormatPBF:r.query.supportsFormatPBF,supportsMaxRecordCountFactor:r.query.supportsMaxRecordCountFactor,supportsQuantization:r.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:r.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:r.query.supportsDegeneratedQuantizedGeometry,lastEditDate:null}}}}class Ar{constructor(t){this.layer=t}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return null}getLabelingDeconflictionInfo(t){const i=this.layer,r=W(i,t)??N(i),s=F(i,t),a=[...i.labelingInfo||[],...(s==null?void 0:s.labelingInfo)||[]];return[{vvEvaluators:{0:Q(i.renderer)},deconflictionEnabled:r,labelingInfo:a}]}getUpdateHashProperties(t){return[()=>this.layer.urls.join(","),()=>this.layer.outFields,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>F(this.layer,t),()=>this.layer.customParameters,()=>this.layer.orderBy,()=>this.layer.renderer,()=>this.layer.popupTemplate]}async createSourceSchema(t,i){const r=this._createServiceInfo(t),s=t.availableFields.includes("*")?this.layer.fields.map(n=>n.name):t.availableFields,a={partial:{urls:[...this.layer.urls.items],availableFields:s},full:{definitionExpression:null,sourceRefreshVersion:i,customParameters:this.layer.customParameters??null}};return{type:"parquet",service:r,strategy:this._createStrategy(r,a)}}_createStrategy(t,i){return t.geometryInfo.displayOptimization?{type:"xz",...i}:{type:"snapshot",...i}}createProcessorSchema(t,i,r){var a;const s={fields:this.layer.fields.map(n=>n.toJSON()),renderer:(a=this.layer.renderer)==null?void 0:a.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,i),geometryType:this.layer.geometryType,labelingInfo:this.layer.labelingInfo,labelsVisible:this.layer.labelsVisible,objectIdField:this.layer.objectIdField,orderBy:this.layer.orderBy};return j(t,i,s,r)}setGraphicOrigin(t){t.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(t){t.origin=this.layer.aggregateGraphicOrigin}_createServiceInfo(t){const i=M(this.layer),r=t.spatialReference.toJSON(),s=this.layer.encoding;if(s==null)throw new T("parquet-layer:unsupported","creating a parquet layer view requires an encoding",{layer:this.layer});return{type:"parquet",outSpatialReference:r,geometryInfo:{geometryType:_i(this.layer.geometryType),spatialReference:this.layer.spatialReference.toJSON(),encoding:s.toJSON(),displayOptimization:this.layer.displayOptimization},metadata:{spatialReference:this.layer.spatialReference.toJSON(),outSpatialReference:r,fieldsIndex:this.layer.fieldsIndex.toJSON(),featureIdInfo:{type:"object-id",fieldName:this.layer.objectIdField},geometryType:i,types:null,subtypes:null,timeInfo:null,typeIdField:null,subtypeField:null,globalIdField:null,timeReferenceUnknownClient:null,dateFieldsTimeZone:null}}}}let Ur=class{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,i=W(t,e)??N(t),r=F(t,e),s=[...t.labelingInfo||[],...(r==null?void 0:r.labelingInfo)||[]];return[{vvEvaluators:{0:Q(t.renderer)},deconflictionEnabled:i,labelingInfo:s}]}async createSourceSchema(e,t){var i;return{type:"stream",service:this._createServiceInfo(e),strategy:{type:"stream",partial:{sourceRefreshVersion:t},full:{availableFields:e.availableFields,geometryDefinition:(i=this.layer.geometryDefinition)==null?void 0:i.toJSON(),definitionExpression:this.layer.definitionExpression,customParameters:this.layer.customParameters,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,t,i){const{fields:r,renderer:s,geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,trackInfo:l}=this.layer,c={fields:r.map(d=>d.toJSON()),renderer:s==null?void 0:s.clone(),labelingInfoSource:this.layer.id,featureReduction:F(this.layer,t),geometryType:a,labelingInfo:n,labelsVisible:o,objectIdField:u,orderBy:"default",trackInfo:l};return j(e,t,c,i)}get hasRequiredSupport(){return B(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){return[()=>this.layer.definitionExpression,()=>this.layer.renderer,()=>this.layer.labelsVisible?this.layer.labelingInfo:null,()=>F(this.layer,e),()=>this.layer.customParameters,()=>this.layer.geometryDefinition,()=>this.layer.definitionExpression,()=>this.layer.trackInfo]}setGraphicOrigin(e){e.origin=this.layer.graphicOrigin}setAggregateGraphicOrigin(e){e.origin=this.layer.aggregateGraphicOrigin}setTrackGraphicOrigin(e){e.origin=this.layer.trackGraphicOrigin}_createServiceInfo(e){var a;const t=M(this.layer),i=((a=this.layer.timeInfo)==null?void 0:a.toJSON())||null,r=this.layer.spatialReference?this.layer.spatialReference.toJSON():null,s=e.spatialReference.toJSON();return{type:"stream",source:this.layer.parsedUrl,outSpatialReference:s,metadata:{fieldsIndex:this.layer.fieldsIndex.toJSON(),geometryType:t,featureIdInfo:{type:"object-id",fieldName:this.layer.objectIdField},timeInfo:i,timeReferenceUnknownClient:null,dateFieldsTimeZone:null,spatialReference:r,outSpatialReference:s,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}}};async function Dr(e,{subtypeField:t,sublayers:i}){const r=await Promise.all(i.map(({renderer:s})=>G(e,s)));return{type:"subtype",subtypeField:t,renderers:i.reduce((s,{subtypeCode:a},n)=>({...s,[a]:r[n]}),{})}}function Nr(e,t){const i=wi();return{type:"multi",filters:e.filters,capabilities:{maxTextureSize:i.maxTextureSize},keyField:t.subtypeField,target:"feature",bindings:t.sublayers.reduce((r,{renderer:s,subtypeCode:a})=>{const n=ni(s);return{...r,[a]:n}},{})}}async function Lr(e,{subtypeField:t,sublayers:i,labelingInfoSource:r}){const s=await Promise.all(i.map(a=>{const n=k(a.renderer),o={...a,geometryType:a.geometryType??null,labelingInfoSource:r};return L(e,o,n)}));return{type:"subtype",subtypeField:t,renderers:i.reduce((a,{subtypeCode:n},o)=>({...a,[n]:s[o]}),{})}}async function Gr(e,t,i,r){var s;return{storage:Nr(t,i),mesh:{properties:{timeZone:t.timeZone,displayRefreshVersion:r,returnMeshObjectId:!1,sortKey:null,currentUser:t.currentUser},strategy:{type:"feature"},factory:{symbology:await Dr(e,i),labels:await Lr(e,i)}},expressionProperties:{timeExtent:(s=t.timeExtent)==null?void 0:s.toJSON()}}}class Br{constructor(t){this.layer=t,this._cache=new K}getLabelingDeconflictionInfo(t){const i=this.layer;return[{vvEvaluators:{},deconflictionEnabled:i.sublayers.some(r=>N(r)),labelingInfo:i.sublayers.toArray().filter(r=>!!r.labelingInfo).flatMap(r=>r.labelingInfo)}]}async createSourceSchema(t,i){var v;const{definitionExpression:r,customParameters:s,gdbVersion:a,historicMoment:n,timeExtent:o,apiKey:u,displayFilterInfo:l}=this.layer,c=this._createServiceInfo(t),d=((v=this.layer.editingInfo)==null?void 0:v.lastEditDate)!=null,m=this.layer.refreshInterval>0,f=!d&&m,g=qe(c.isSourceHosted,f,this.layer.capabilities,c.metadata.geometryType,t.extent,this.layer.fullExtent);return Z(c,g,{definitionExpression:r,queryScaleRanges:this.layer.sublayers.items.map(S=>({subtypeCode:S.subtypeCode,minScale:S.minScale,maxScale:S.maxScale})),displayFilterEnabled:t.displayFilterEnabled,displayFilterInfo:l,customParameters:s,gdbVersion:a,historicMoment:n,timeExtent:o,apiKey:u,sourceRefreshVersion:i,availableFields:t.availableFields,cache:this._cache})}createProcessorSchema(t,i,r){const s={labelingInfoSource:this.layer.id,subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,(a,n)=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfoSource:this.layer.id+`-${n}`,labelingInfo:a.labelingInfo,labelsVisible:a.labelsVisible,renderer:a.renderer,subtypeCode:a.subtypeCode,orderBy:null}))};return Gr(t,i,s,r)}addFilters(t,i){t=Ue(this.layer,t,i);const r=this.layer.sublayers.filter(a=>!Qr(a,i)).map(a=>a.subtypeCode);if(!r.length)return t;t??(t=new $);const s=`NOT ${this.layer.subtypeField} IN (${r.join(",")})`;return t.where=U(t.where,s),t}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(t){return[()=>this.layer.apiKey,()=>this.layer.customParameters,()=>this.layer.definitionExpression,()=>Ae(this.layer,t)?t.floors:null,()=>this.layer.outFields,()=>this.layer.gdbVersion,()=>this.layer.historicMoment,()=>this.layer.sublayers.map(({renderer:i,labelsVisible:r,labelingInfo:s,visible:a,minScale:n,maxScale:o})=>({renderer:i,labelsVisible:r,labelingInfo:s,visible:a,minScale:n,maxScale:o}))]}setGraphicOrigin(t){const i=this.layer.findSublayerForFeature(t);t.layer=t.sourceLayer=i,t.origin=i==null?void 0:i.graphicOrigin}_createServiceInfo(t){var p,b,_;const{capabilities:i,datesInUnknownTimezone:r,dateFieldsTimeZone:s,editingInfo:a,globalIdField:n,objectIdField:o,subtypeField:u}=this.layer,l=this.layer.fieldsIndex.toJSON(),c=M(this.layer),d=(p=this.layer.timeInfo)==null?void 0:p.toJSON(),m=this.layer.spatialReference.toJSON(),f=ce(this.layer.parsedUrl),g=o,v=ge(f.path),S=t.spatialReference.toJSON();return{type:"feature-service",source:f,isSourceHosted:v,orderByFields:g,outSpatialReference:S,metadata:{timeReferenceUnknownClient:r,dateFieldsTimeZone:s,subtypeField:u,globalIdField:n,fieldsIndex:l,geometryType:c,featureIdInfo:Ie(this.layer),timeInfo:d,spatialReference:m,outSpatialReference:S,subtypes:(b=this.layer.subtypes)==null?void 0:b.map(x=>x.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:i.query.maxRecordCount,supportsCompactGeometry:i.query.supportsCompactGeometry,supportsDefaultSpatialReference:i.query.supportsDefaultSpatialReference,supportsFormatPBF:i.query.supportsFormatPBF,supportsMaxRecordCountFactor:i.query.supportsMaxRecordCountFactor,supportsQuantization:i.query.supportsQuantization,supportsCentroidOnDegeneratedQuantizedGeometry:i.query.supportsCentroidOnDegeneratedQuantizedGeometry,supportsDegeneratedQuantizedGeometry:i.query.supportsDegeneratedQuantizedGeometry,lastEditDate:(_=a==null?void 0:a.lastEditDate)==null?void 0:_.getTime()}}}}function Qr(e,t){return e.visible&&(e.minScale===0||$e(t.scale,e.minScale)||t.scale<e.minScale)&&(e.maxScale===0||$e(t.scale,e.maxScale)||t.scale>e.maxScale)}let st=class{constructor(){this._commands=new Map,this._historicMoment=null}add(e){switch(e.type){case"override":return this._addOverride(e);case"override-by-id":return this._addOverrideById(e)}}toMessage(){const e={historicMoment:this._historicMoment,commands:{updateByIdWeak:[],updateWeak:[],removeWeak:[],update:[],remove:[],release:[]}};for(const[t,i]of this._commands.entries())switch(i.type){case"override-update-by-id":e.commands.updateByIdWeak.push(t);break;case"override-update":i.isWeak?e.commands.updateWeak.push(i.feature):e.commands.update.push(i.feature);break;case"override-remove":i.isWeak?e.commands.removeWeak.push(t):e.commands.remove.push(t);break;case"override-release":e.commands.release.push(t)}return e}_addOverrideById(e){this._historicMoment=e.historicMoment;for(const t of e.updates)this._commands.set(t,{type:"override-update-by-id",isWeak:e.isWeak});for(const t of e.removed)this._commands.set(t,{type:"override-remove",isWeak:e.isWeak})}_addOverride(e){this._historicMoment=e.historicMoment;for(const t of e.updates)this._commands.set(t.objectId,{type:"override-update",feature:t,isWeak:e.isWeak});for(const t of e.removed)this._commands.set(t,{type:"override-remove",isWeak:e.isWeak});for(const t of e.release)this._commands.set(t,{type:"override-release"})}};async function w(e,t){try{return await e}catch(i){if(i.name!=="no-queryEngine")throw i;return t}}function Ve(e,t){const i=new Set;for(const r of e instanceof Set?e.values():e.keys())t.has(r)||i.add(r);return i}class jr{constructor(t,i,r){this.target=new Map,this.previous=new Map;const s=r?t.getTileCoverage(r,0,!0,"closest"):null,a=t.getTileCoverage(i,0,!0,"closest");if(this.target.clear(),this.previous.clear(),s)for(const n of s.keys())this.previous.set(n.id,n);if(a)for(const n of a.keys())this.target.set(n.id,n)}*values(){yield*this.target.values(),yield*this.previous.values()}*keys(){yield*this.target.keys(),yield*this.previous.keys()}}class $r{constructor(t){this.version=t}}class Jr{constructor(t){this._subscriptions=new Map,this._visible=new Set,this._version=0,this._strategy="eager",this._config=t}destroy(){}get coverage(){return this._coverage}get subscriptions(){return new Set(this._subscriptions.keys())}setVisibilityStrategy(t){this._strategy=t}suspend(){this._suspendedCoverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){this._coverage==null&&(this._coverage=this._suspendedCoverage,this._suspendedCoverage=null,this._updateSubscriptions())}update(t,i){return this._version=(this._version+1)%Number.MAX_SAFE_INTEGER,this._coverage=new jr(this._config.tileInfoView,t,i),this._updateSubscriptions(),new Set(this._visible)}updateVisibility(){const t=this._updateVisibility();return this._visible=t,this._visible}_updateSubscriptions(){if(!this._coverage)return;const t=this._updateVisibility(),i=new Set(this._coverage.keys()),r=Ve(this._subscriptions,t),s=Ve(i,this._subscriptions),a=Ve(r,i);this._visible=t;for(const n of s.values())this._subscriptions.set(n,new $r(this._version));for(const n of a.values())this._subscriptions.delete(n);(s.size||a.size)&&this._sendUpdateSubscriptions(s,a)}_sendUpdateSubscriptions(t,i){const r=Array.from(t.values()).map(s=>({tileId:s,version:this._subscriptions.get(s).version}));this._config.updateSubscriptions({subscribe:r,unsubscribe:Array.from(i.values())})}_updateVisibility(){if(!this._coverage)return new Set;switch(this._strategy){case"eager":return this._updateVisibilityEager(this._coverage);case"target-defer":return this._updateVisibilityTargetDefer(this._coverage)}}_updateVisibilityEager(t){const i=new Set;for(const r of t.values()){if(this._config.isDone(r)){i.add(r.id);continue}this._addVisibleParent(i,r)||this._addVisibleChildren(i,r)||i.add(r.id)}return i}_updateVisibilityTargetDefer(t){const i=new Set,r=Array.from(t.target.values());if(!r.some(s=>!this._config.isDone(s))){for(const s of r)i.add(s.id);return i}for(const s of t.values())this._addVisibleParent(i,s)||this._addVisibleChildren(i,s)||i.add(s.id);return i}_addVisibleParent(t,i){let r=!1;for(const s of this._visible.values())new Oe(s).containsChild(i)&&(t.add(s),r=!0);return r}_addVisibleChildren(t,i){let r=!1;for(const s of this._visible.values()){const a=new Oe(s);i.containsChild(a)&&(t.add(s),r=!0)}return r}}function Hr(e,t){if(t.type!=="feature"&&t.type!=="subtype-group")return[];if(!t.url)return[];const i="utilityNetworks"in e.map?e.map.utilityNetworks??[]:[];for(const r of i)if(r.isUtilityLayer(t)){const s=t.fieldsIndex.get("assetgroup"),a=t.fieldsIndex.get("assettype");return[s==null?void 0:s.name,a==null?void 0:a.name].filter(n=>n!=null)}return[]}class Wr{constructor(t){this._fieldsIndex=t,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(t=>t.currentUserRequired)}}visitClientWhereClause(t){t&&this._clauses.push(Gt(t,this._fieldsIndex))}visitFeatureReduction(t){if(t)switch(t.type){case"binning":case"cluster":this.visitLabelingInfo(t.labelsVisible,t.labelingInfo)}}visitLabelingInfo(t,i){if(t&&i!=null)for(const r of i)this.visitClientWhereClause(r.where)}visitDisplayFilter(t,i){if(t)for(const r of(i==null?void 0:i.filters)??[])this.visitClientWhereClause(r.where)}visitFilter(t){this.visitClientWhereClause(t==null?void 0:t.where)}visitTrackInfo(t){t!=null&&(this.visitLabelingInfo(t==null?void 0:t.latestObservations.labelsVisible,t==null?void 0:t.latestObservations.labelingInfo),this.visitLabelingInfo(t==null?void 0:t.previousObservations.labelsVisible,t==null?void 0:t.previousObservations.labelingInfo),this.visitLabelingInfo(t==null?void 0:t.trackLines.labelsVisible,t==null?void 0:t.trackLines.labelingInfo))}}const Kr=e=>{const t=e;let i=class extends t{constructor(...r){super(...r),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([fe(()=>{var a,n,o,u,l;const r=this.layer,s=this.view;return[r&&"elevationInfo"in r?(a=r.elevationInfo)==null?void 0:a.featureExpressionInfo:null,r&&"displayField"in r?r.displayField:null,r&&"timeInfo"in r&&r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,((n=s==null?void 0:s.requiredFieldsOptions)==null?void 0:n.featureTitleFields)&&r&&"featureTitleFields"in r&&r.featureTitleFields,((o=s==null?void 0:s.requiredFieldsOptions)==null?void 0:o.utilityNetworkFields)&&Hr(s,r),r.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,(r==null?void 0:r.type)==="knowledge-graph-sublayer"&&r.parentCompositeLayer.type==="link-chart"&&((l=(u=r.parentCompositeLayer.linkChart)==null?void 0:u.linkChartProperties.nonspatialDataDisplay)==null?void 0:l.mode)]},()=>this._handleChange(),zt),we(()=>{var r;return(r=this.view)==null?void 0:r.floors},"change",()=>this._handleChange()),we(()=>{var r;return(r=this.layer.displayFilterInfo)==null?void 0:r.filters},"change",()=>this._handleChange()),we(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:r,layer:{fieldsIndex:s},requiredFields:a}=this;return"outFields"in r&&r.outFields?Be(s,[...lt(s,r.outFields),...a]):Be(s,a)}get displayFilterEnabled(){var r,s;return(((r=this.view)==null?void 0:r.displayFilterEnabled)??!0)&&(!("displayFilterEnabled"in this.layer)||(((s=this.layer)==null?void 0:s.displayFilterEnabled)??!0))}get effectiveDisplayFilter(){const r=this.layer;return this.displayFilterEnabled&&r.displayFilterInfo?Fi(r.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){var s;const r=((s=this.effectiveDisplayFilter)==null?void 0:s.where)??null;return r&&this.hasHighlight?Tt(r,qt(this.layer.objectIdField,this.highlightIds)):r}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){this._override("featureEffect",r)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){C.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){var r;return(r=this.layer)!=null&&r.url?Kt(this.layer.url):Promise.resolve(null)}highlight(r,s){throw new Error("missing implementation")}createQuery(){var a;const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=this.filter!=null?this.filter.createQuery(r):new me(r);return"floorInfo"in this.layer&&this.layer.floorInfo&&(s.where=U(s.where,Xe(this))),this.displayFilterEnabled&&(s.where=U(s.where,(a=this.effectiveDisplayFilter)==null?void 0:a.where)),this.timeExtent!=null&&(s.timeExtent=s.timeExtent!=null?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new me(r)}queryFeatures(r,s){throw new Error("missing implementation")}queryObjectIds(r,s){throw new Error("missing implementation")}queryFeatureCount(r,s){throw new Error("missing implementation")}queryExtent(r,s){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(r,s){const a=[],n=new Set;for(const u of r){const l=Mt(u.origin),c=xi(l,{...s,checkPopupEnabled:!0});c&&(a.push(u),n.add(c))}if(a.length===0||n.size===0)return[];const o=await this._createPopupQuery(n,s);return await ki(this.layer,a,o,{hasRequiredFields:(u,l)=>this._popupFeatureHasRequiredFields(u,l),...s})}_handleChange(){const r=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",r),r.then(()=>{this._updatingRequiredPromise===r&&this._set("_updatingRequiredPromise",null)}),r}async _updateClientWhereClauseRequirements(){var a;if(!this.layer||!this.view)return;const{layer:r}=this,s=new Wr(r.fieldsIndex);if(s.visitFilter(this.filter),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction),"labelingInfo"in r&&s.visitLabelingInfo(r.labelsVisible,r.labelingInfo),"trackInfo"in r&&s.visitTrackInfo(r.trackInfo),this.view.type==="2d"&&(s.visitFilter((a=this.featureEffect)==null?void 0:a.filter),s.visitDisplayFilter(this.displayFilterEnabled,r.displayFilterInfo),"featureReduction"in r&&s.visitFeatureReduction(r.featureReduction)),r.type==="subtype-group")for(const n of r.sublayers)s.visitLabelingInfo(n.labelsVisible,n.labelingInfo);try{const n=await s.finish();this._set("requiresCurrentUser",n.requiresCurrentUser)}catch(n){C.getLogger(this).error(n)}}async _updateRequiredFields(){var f,g,v,S;if(!this.layer||!this.view)return;const r=this.view.type==="3d",{layer:s,layer:{fieldsIndex:a}}=this,n="renderer"in s&&s.renderer,o="orderBy"in s&&s.orderBy,u="featureReduction"in s?s.featureReduction:null,l=new Set,c=[n?n.collectRequiredFields(l,a):null,Qe(l,s),r&&"elevationInfo"in s?Pt(l,s):null,this.filter!=null?je(l,s,this.filter):null,r||this.featureEffect==null?null:je(l,s,this.featureEffect.filter),!r&&u?At(l,s,u):null,!r&&o?Ut(l,s,o):null];if("timeInfo"in s&&s.timeInfo&&this.timeExtent&&A(l,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"timeInfo"in s&&s.timeInfo&&"trackInfo"in s&&s.trackInfo){const{trackInfo:p}=s;A(l,s.fieldsIndex,[s.timeInfo.trackIdField]),s.type!=="feature"&&p.timeField!=="startTimeField"||A(l,s.fieldsIndex,[s.timeInfo.startField]),p.timeField==="endTimeField"&&A(l,s.fieldsIndex,[s.timeInfo.endField]),await Dt(l,s)}if("floorInfo"in s&&s.floorInfo&&A(l,s.fieldsIndex,[s.floorInfo.floorField]),"featureTitleFields"in s&&((g=(f=this.view)==null?void 0:f.requiredFieldsOptions)!=null&&g.featureTitleFields)&&s.featureTitleFields&&A(l,s.fieldsIndex,s.featureTitleFields),s.type==="feature"&&s.globalIdField&&((S=(v=this.view)==null?void 0:v.requiredFieldsOptions)!=null&&S.globalIdField)&&A(l,s.fieldsIndex,[s.globalIdField]),this.displayFilterEnabled&&c.push(Nt(l,s,s.displayFilterInfo)),s.type==="feature"&&r&&s.infoFor3D!=null&&(s.globalIdField==null&&C.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),A(l,s.fieldsIndex,[s.globalIdField])),s.type==="subtype-group"){se(l,a,s.subtypeField);const p=s.sublayers.map(b=>{var _;return Promise.all([(_=b.renderer)==null?void 0:_.collectRequiredFields(l,a),Qe(l,b)])});c.push(Promise.all(p))}if(s.type==="catalog-footprint"&&s.parent){const p=s.parent;A(l,a,[p.itemNameField,p.itemSourceField,p.itemTypeField,p.maxScaleField,p.minScaleField])}s.type==="knowledge-graph-sublayer"&&s.parentCompositeLayer.type==="link-chart"&&se(l,a,yt);const d=await Promise.allSettled(c);if(r)se(l,a,s.objectIdField);else for(const p of yi(Ie(s)))se(l,a,p);r&&"displayField"in s&&s.displayField&&se(l,a,s.displayField);for(const p of d)p.status==="rejected"&&C.getLogger(this).error(p.reason);const m=Array.from(l).sort();this._set("requiredFields",m)}_popupFeatureHasRequiredFields(r,s){return ut(r,s)}async _createPopupQuery(r,s){const a=this.layer.createQuery(),n=new Set;let o=this.layer.geometryType==="point";for(const u of r){if(!o){const c=await zi(u);Ee(s),o=(c&&c.arcadeUtils.hasGeometryOperations(u))??!1}const l=await Ei(this.layer,u);Ee(s);for(const c of l)n.add(c)}return a.returnGeometry=o,a.returnZ=o,a.returnM=o,a.outFields=Array.from(n),a.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(a.where=U(a.where,Xe(this))),a}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return h([y()],i.prototype,"_updatingRequiredPromise",void 0),h([y({readOnly:!0})],i.prototype,"availableFields",null),h([y({readOnly:!0})],i.prototype,"displayFilterEnabled",null),h([y({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),h([y({readOnly:!0})],i.prototype,"effectiveDisplayFilterClause",null),h([y({type:Vi})],i.prototype,"featureEffect",null),h([y({type:$})],i.prototype,"filter",void 0),h([y()],i.prototype,"layer",void 0),h([y({type:Number})],i.prototype,"maximumNumberOfFeatures",null),h([y({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),h([y()],i.prototype,"requiresCurrentUser",void 0),h([y({readOnly:!0})],i.prototype,"requiredFields",void 0),h([y({readOnly:!0})],i.prototype,"signedInUser",null),h([y()],i.prototype,"suspended",void 0),h([y()],i.prototype,"view",void 0),i=h([H("esri.views.layers.FeatureLayerView")],i),i};function Zr(e,t){const i=new Set;return e&&e.forEach(r=>i.add(r)),t&&t.forEach(r=>i.add(r)),i.has("*")?["*"]:Array.from(i)}const at=4294967294;function Xr(e,t){return Ot(e.map(i=>fe(()=>{const r=i();return r&&typeof r=="object"?"getTime"in r&&typeof r.getTime=="function"?r.getTime():JSON.stringify(r):r},t)))}function nt(e){if(!e.geometry||!Ct(e.geometry))return e;const t=.001/kt(e.geometry.spatialReference);return{geometry:Ht(e.geometry,{maxSegmentsPerCurve:12e3,maxSegmentLength:100*t,maxDeviation:0}),attributes:e.attributes}}let R=class extends Kr(Oi(ii(Ri))){constructor(){super(...arguments),this._commandsQueue=new si({process:e=>{switch(e.type){case"override-batch":return this._doOverride(e);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._lastAvailableFields=[],this._lastTargetState=null,this.eventLog=new z,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._editUpdatingHandles=new pt,this._fields=null,this._sourceUpdating=!1,this.featureEffectView=new O,this._lastUpdate=0}destroy(){var e;this._editUpdatingHandles.destroy(),(e=this._workerProxy)==null||e.destroy(),this._workerAttached.reject(De()),this._commandsQueue.destroy()}initialize(){this._workerAttached=he(),re(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransition()}async _initProxy(){var i;const e=this.layer;if("isTable"in e&&e.isTable)throw new T("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if((e.type==="feature"||e.type==="subtype-group")&&((i=St(e))==null?void 0:i.operations.supportsQuery)===!1)throw new T("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});this._workerProxy&&this._workerProxy.destroy();const t=this._createClientOptions();this._workerProxy=await Gi(t)}async _attachProxy(){var t,i,r;const e={tileInfoJSON:(r=(i=(t=this.view)==null?void 0:t.featuresTilingScheme)==null?void 0:i.tileInfo)==null?void 0:r.toJSON()};try{await this._workerProxy.pipeline.onAttach(e),this._workerAttached.resolve()}catch(s){this._workerAttached.reject(De()),It(s)}}async _detachProxy(){return this._workerProxy.pipeline.onDetach()}async getWorker(){return await this._workerAttached.promise,this._workerProxy}get dataUpdating(){return this._sourceUpdating||this._editUpdatingHandles.updating}get hasAllFeatures(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&this.eventLog.willQueryAllFeatures}get hasAllFeaturesInView(){var i;const e=((i=this.effectiveDisplayFilter)==null?void 0:i.where)||null,t=!this.eventLog.willQueryAllFeatures&&e!=null&&e!=="1=1";return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&!t}get hasFullGeometries(){return this.layer.visible&&!this.suspended&&this.eventLog.hasAllData&&this.eventLog.willQueryFullResolutionGeometry}get labelingCollisionInfos(){const e=this.layerAdapter.getLabelingDeconflictionInfo(this.view),t=this.layer.geometryType,i=!this.suspended;return e.map(({vvEvaluators:r,deconflictionEnabled:s,labelingInfo:a})=>({labelingInfo:a,container:this.featureContainer,vvEvaluators:r,deconflictionEnabled:s,geometryType:t,visible:i}))}get layerAdapter(){switch(this.layer.type){case"feature":return this.layer.source.type==="memory"?new rt(this.layer):new Tr(this.layer);case"geojson":case"csv":case"wfs":return new rt(this.layer);case"parquet":return new Ar(this.layer);case"subtype-group":return new Br(this.layer);case"ogc-feature":return new Mr(this.layer);case"stream":return new Ur(this.layer);case"oriented-imagery":return new Pr(this.layer);case"knowledge-graph-sublayer":return new qr(this.layer);case"catalog-footprint":return new kr(this.layer);default:_t(this.layer)}return null}get timeExtent(){var e;return Xt(this.layerAdapter.timeOptions,(e=this.view)==null?void 0:e.timeExtent,this._get("timeExtent"))}get usedMemory(){return this.container.usedMemory+this.eventLog.pipelineStatistics.usedMemory}getDisplayStatistics(e,t){var i;return(i=this.featureContainer)==null?void 0:i.getDisplayStatistics(e,t)}async queryHeatmapStatistics(e){return(await this.getWorker()).pipeline.queryHeatmapStatistics(e)}highlight(e,t){let i;e instanceof ye?i=[e.getObjectId()]:typeof e=="number"||typeof e=="string"?i=[e]:wt.isCollection(e)&&e.length>0?i=e.map(a=>a==null?void 0:a.getObjectId()).toArray():Array.isArray(e)&&e.length>0&&(i=typeof e[0]=="number"||typeof e[0]=="string"?e:e.map(a=>a==null?void 0:a.getObjectId()));const r=i==null?void 0:i.filter(Ft);if(!(r!=null&&r.length))return Ne();const s=Ci(t);return this._addHighlights(r,s),Ne(()=>!this.destroyed&&this._removeHighlights(r,s))}async hitTest(e,t){const i=await this.featureContainer.hitTest(t);if(i.length===0)return null;const r=await this.getWorker(),{features:s,aggregates:a,tracks:n}=await r.pipeline.getDisplayFeatures(i),o=this.featureContainer.getSortKeys(i),u=({displayId:c},{displayId:d})=>o.has(c)&&o.has(d)?o.get(c)-o.get(d):c-d;s.sort(u).reverse(),a.sort(u).reverse();const l=I("parquetlayer-hittest-max-feature-count")??1;return this.layer.type==="parquet"&&s.length>l&&(s.length=l),[...a.map(c=>this._createAggregateGraphicHit(e,Te.fromJSON(c))),...n.map(c=>this._createTrackGraphicHit(e,Ti.fromJSON(c))),...s.map(c=>this._createFeatureGraphicHit(e,ye.fromJSON(c)))]}async queryStatistics(){const e=await this.getWorker();return w(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})}async querySummaryStatistics(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForSummaryStatistics(this._cleanUpQuery(e),s,i);return w(a,{})}async queryAggregateSummaryStatistics(e,t,i){const r={...t,scale:this.view.scale},s=(await this.getWorker()).aggregates.executeQueryForSummaryStatistics(this._cleanUpAggregateQuery(e),r,i);return w(s,{})}async queryUniqueValues(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForUniqueValues(this._cleanUpQuery(e),s,i);return w(a,{uniqueValueInfos:[]})}async queryAggregateUniqueValues(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForUniqueValues(this._cleanUpAggregateQuery(e),s,i);return w(a,{uniqueValueInfos:[]})}async queryClassBreaks(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForClassBreaks(this._cleanUpQuery(e),s,i);return w(a,{classBreakInfos:[]})}async queryAggregateClassBreaks(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForClassBreaks(this._cleanUpAggregateQuery(e),s,i);return w(a,{classBreakInfos:[]})}async queryHistogram(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.features.executeQueryForHistogram(this._cleanUpQuery(e),s,i);return w(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}async queryAggregateHistogram(e,t,i){const r=await this.getWorker(),s={...t,scale:this.view.scale},a=r.aggregates.executeQueryForHistogram(this._cleanUpAggregateQuery(e),s,i);return w(a,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})}queryFeatures(e,t){return this.queryFeaturesJSON(e,t).then(i=>{const r=Re.fromJSON(i);return r.features.forEach(s=>this._setOriginForFeature(s)),r})}async queryVisibleFeatures(e,t){const i=(await this.getWorker()).pipeline.queryVisibleFeatures(this._cleanUpQuery(e),t),r=await w(i,{features:[]}),s=Re.fromJSON(r);return s.features.forEach(a=>this._setOriginForFeature(a)),s}async queryAggregates(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t),r=await w(i,{features:[]}),s=le.fromJSON(r);return s.features.forEach(a=>{var n,o;return(o=(n=this.layerAdapter).setAggregateGraphicOrigin)==null?void 0:o.call(n,a)}),s}async queryAggregateIds(e,t){const i=(await this.getWorker()).aggregates.executeQueryForIds(this._cleanUpAggregateQuery(e),t);return w(i,[])}async queryAggregateCount(e,t){const i=(await this.getWorker()).aggregates.executeQueryForCount(this._cleanUpAggregateQuery(e),t);return w(i,0)}async queryAggregateJSON(e,t){const i=(await this.getWorker()).aggregates.executeQuery(this._cleanUpAggregateQuery(e),t);return w(i,{features:[]})}async queryFeaturesJSON(e,t){const i=(await this.getWorker()).features.executeQuery(this._cleanUpQuery(e),t);return w(i,{features:[]})}async queryObjectIds(e,t){const i=(await this.getWorker()).features.executeQueryForIds(this._cleanUpQuery(e),t);return w(i,[])}async queryFeatureCount(e,t){const i=(await this.getWorker()).features.executeQueryForCount(this._cleanUpQuery(e),t);return w(i,0)}async queryExtent(e,t){const i=(await this.getWorker()).features.executeQueryForExtent(this._cleanUpQuery(e),t),r=await w(i,{count:0,extent:null});return{count:r.count,extent:Vt.fromJSON(r.extent)}}async queryAttributeBins(e,t){const i=(await this.getWorker()).features.executeAttributeBinsQuery(this._cleanUpAttributeBinsQuery(e),t),r=await w(i,{features:[]});return Yt.fromJSON(r)}async getSampleFeatures(e){return(await this.getWorker()).pipeline.getSampleFeatures(e)}setVisibility(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}update(e){var s;const t=performance.now();if(t-this._lastUpdate<200||(this._lastUpdate=t,!this.subscriptionManager))return;this.view.animation&&!this._lastTargetState&&(this._lastTargetState=e.state.clone()),!this.view.animation&&this._lastTargetState&&(this._lastTargetState=null);const i=this.subscriptionManager.update(e.targetState,this._lastTargetState),r=new Set((s=this.subscriptionManager.coverage)==null?void 0:s.target.keys());for(const a of this.featureContainer.tiles||[])a.isCoverage=r.has(a.id);this.featureContainer.setVisibleTiles(i)}attach(){I("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),re(this._updatingHandles.addPromise(this._workerAttached.promise)),re(this._attachProxy()),this.featureContainer=new Ni(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this.subscriptionManager=new Jr({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:e=>{this.featureContainer.updateSubscriptions(e),re(this._updatingHandles.addPromise(this.getWorker().then(t=>t.pipeline.updateSubscriptions(e))))},isDone:e=>this.featureContainer.isDone(e)}),this.requestUpdate(),this.addAttachHandles([Xr([()=>this._displayRefreshVersion,()=>this.layer.displayFilterInfo,()=>this.timeExtent,()=>this.clips,()=>this.filter,()=>this.effectiveDisplayFilterClause,()=>this.featureEffect,()=>this._sourceRefreshVersion,()=>this.view.timeZone,()=>this.view.timeExtent,...this.layerAdapter.getUpdateHashProperties(this.view)],()=>this._update()),fe(()=>this.updateSuspended,e=>{e||(this.subscriptionManager.resume(),this.view.labelManager.requestUpdate())}),fe(()=>this.visible,e=>{this.view.labelManager.symbolFader.restartDeclutter(),this.view.labelManager.requestUpdate()})]),this._update(),this.layer.type!=="stream"&&this.layer.type!=="parquet"&&this.layer.type!=="catalog-footprint"&&this.addAttachHandles(this.layer.on("edits",e=>this._editUpdatingHandles.addPromise(this._edit(e))))}detach(){I("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.view.labelManager.removeContainer(this.featureContainer),this.featureContainer.destroy(),this.featureContainer=null,this._commandsQueue.clear(),this.container.removeAllChildren(),this.subscriptionManager=xe(this.subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=he(),re(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}addOverrides(e){return this._commandsQueue.push({type:"override",options:{...e,release:[]}})}removeOverrides(e){for(const i of e)if(i==null)throw new T("featurelayerview:bad-override","Tried to remove an override for an invalid objectId",{objectId:i});const t={added:[],updated:[],removed:[],release:e,isWeak:!1,historicMoment:null};return this._commandsQueue.push({type:"override",options:t})}isUpdating(){const e="renderer"in this.layer&&this.layer.renderer!=null,t=this._commandsQueue.updateTracking.updating,i=this._updatingRequiredPromise!=null,r=this.featureContainer.updatingHandles.updating,s=this.updateRequested||e&&(t||i)||r||this._pipelineUpdating||this.dataUpdating;if(I("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${s}
  -> updateRequested ${this.updateRequested}
  -> hasRenderer ${e}
  -> updatingRequiredFields ${i}
  -> hasPendingCommand ${t}
  -> dataUpdating ${this.dataUpdating}
  -> processing ${this._pipelineUpdating}
  -> updatingContainer ${r}
`);for(const a of this.featureContainer.subscriptions())console.log(`    -> Tile[${a.id}] Done: ${a.done}`)}return s}_createClientOptions(){const e=this;return{openMemoryPorts:async()=>{var t;if((t=this.layerAdapter)!=null&&t.openMessagePorts){const i=await this.layerAdapter.openMessagePorts();return{result:i,transferList:i}}throw new Error("InternalError: Layer adapter does not support opening message ports")},get container(){return e.featureContainer},setUpdating:t=>{this._set("_pipelineUpdating",t.pipeline),this._set("_sourceUpdating",t.source)},emitEvent:t=>{this.emit(t.name,t.event)},get eventLog(){return e.eventLog},fetch:async t=>{if(I("esri-2d-stabilize-glyphs")){const i=[];for(const r of t)i.push(await e.view.stage.painter.textureManager.rasterizeItem(r));return i}return Promise.all(t.map(i=>e.view.stage.painter.textureManager.rasterizeItem(i)))},fetchDictionary:t=>Promise.all(t.map(i=>this._fetchDictionaryRequest(i)))}}async _fetchDictionaryRequest(e){try{if(this.layer.type==="subtype-group")throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=this.layer.renderer;if(!t||t.type!=="dictionary")throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const i=this._lastSchema.processor.mesh.factory.symbology;if(i.type!=="dictionary")throw new Error("InternalError: Expected schema to be of type 'dictionary'");const r={cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,store:this.featureContainer.instanceStore,scaleExpression:i.scaleExpression};this._fields||(this._fields=this.layer.fields.map(o=>o.toJSON()));const s=i.visualVariableUniforms,a=Ze(this.layer.geometryType),n=await t.getSymbolForControlString(e.controlString,a,!1);return!n||!n.data?{type:"dictionary-response",meshes:[]}:{type:"dictionary-response",meshes:await be({...n.data,hasTextStringTemplates:!0},{uniforms:s,path:"renderer",schemaOptions:r})}}catch{return{type:"dictionary-response",meshes:[]}}}_cleanUpQuery(e){const t=me.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAttributeBinsQuery(e){const t=ei.from(e);return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t.toJSON()}_cleanUpAggregateQuery(e){const t=me.from(e)||this.createAggregateQuery();t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference);const i=t.objectIds??[];for(const r of t.aggregateIds??[])i.push(r);return t.objectIds=i,t.aggregateIds=[],t.toJSON()}async _update(){return this._commandsQueue.push({type:"update"})}_edit(e){return this._commandsQueue.push({type:"edit",event:e})}async doRefresh(e){this.attached&&(this.updateSuspended&&e||(e?this.incrementSourceRefreshVersion():this.incrementDisplayRefreshVersion()))}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%at+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%at+1}async _resolveIdenifiers(e){const t=[],i=[];for(const a of e)a.objectId==null||a.objectId===-1?a.globalId==null?C.getLogger(this).warn("mapview-apply-edits","A feature identifier must contain either a GlobalId or ObjectId. Ignoring",{identifier:a}):i.push(a.globalId):t.push(a.objectId);const r="globalIdField"in this.layer&&this.layer.globalIdField,s=r&&this.availableFields.includes(r);if(i.length&&!s)return C.getLogger(this).error(new T("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${r} to be included the layer's outFields for updates to be reflected on the map`)),t;if(i.length){const a=await this._workerProxy.pipeline.getObjectIdsFromGlobalIds(i);for(const n of a)t.push(n)}return t}_resolveOverrides(e){const t=Ze(this.layer.geometryType),i=Ie(this.layer),r=[];for(const s of e.added){const a=He(nt(s),t,!1,!1,i);if(a.objectId==null)throw new T("featurelayerview:bad-override","Feature does not have an objectId",{feature:s});r.push(a)}for(const s of e.updated){const a=He(nt(s),t,!1,!1,i);if(a.objectId==null)throw new T("featurelayerview:bad-override","Feature does not have an objectId",{feature:s});r.push(a)}for(const s of e.removed)if(s==null)throw new T("featurelayerview:bad-override","Tried to remove an invalid objectId",{objectId:s});return{type:"override",updates:r,removed:e.removed,release:e.release,isWeak:e.isWeak??!1,historicMoment:e.historicMoment??null}}async _resolveEdit(e){var o,u;const t=this.layer,i=((o=e.historicMoment)==null?void 0:o.getTime())??null,r="layerId"in t&&((u=e.editedFeatures)==null?void 0:u.find(l=>l.layerId===t.layerId));if(r&&this._canEditByFeature(r)){const{adds:l,deletes:c,updates:d}=r.editedFeatures,m=this.layer.objectIdField,f=d.map(S=>S.current),g=c.map(S=>"attributes"in S?{objectId:m?S.attributes[m]:null}:S),v=await this._resolveIdenifiers(g);return this._resolveOverrides({added:l,updated:f,removed:v,historicMoment:i,isWeak:!0,release:[]})}const[s,a,n]=await Promise.all([this._resolveIdenifiers(e.addedFeatures),this._resolveIdenifiers(e.updatedFeatures),this._resolveIdenifiers(e.deletedFeatures)]);return{type:"override-by-id",updates:[...s,...a],removed:n,historicMoment:i,isWeak:!0}}_canEditByFeature(e){const{adds:t,updates:i}=e.editedFeatures;return t.every(r=>{var s;return this.view.spatialReference.equals((s=r.geometry)==null?void 0:s.spatialReference)})&&i.every(r=>{var s;return this.view.spatialReference.equals((s=r.current.geometry)==null?void 0:s.spatialReference)})}async _doUpdate(){var e,t,i,r,s,a,n;"featureReduction"in this.layer&&this.layer.featureReduction&&this.layer.featureReduction!==this._lastFeatureReduction&&(this.layer.featureReduction=(e=this.layer.featureReduction)==null?void 0:e.clone(),this._lastFeatureReduction=this.layer.featureReduction);try{if(await Promise.allSettled([this._handleChange(),Wt(this.layer)]),this.destroyed||!((t=this.layerAdapter)!=null&&t.hasRequiredSupport)||!this.subscriptionManager)return;const o=this.featureContainer.instanceStore;this.featureContainer.attributeView.lockTextureUploads();const u=(r=(i=this._lastSchema)==null?void 0:i.processor.mesh.factory.symbology)==null?void 0:r.type;let l=!0;this.layer.type!=="subtype-group"&&((s=this.layer.renderer)==null?void 0:s.type)==="dictionary"&&u==="dictionary"&&(l=!1),o.updateStart(l);const c=this.featureEffect,d={store:o,cimAnalyzer:this.view.stage.cimAnalyzer,cimResourceManager:this.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},m=await this._createViewSchemaConfig(),f={source:await this.layerAdapter.createSourceSchema(m,this._sourceRefreshVersion),processor:await this.layerAdapter.createProcessorSchema(d,m,this._displayRefreshVersion)},g=f.processor.mesh.factory.labels;g&&this.view.labelManager.setLabelSchemaStyles(g,this.featureContainer);const v=Le((a=this._lastSchema)==null?void 0:a.source.strategy,f.source.strategy)||Le((n=this._lastSchema)==null?void 0:n.processor,f.processor);if(!v)return this.featureContainer.requestRender(),this.featureContainer.attributeView.unlockTextureUploads(),o.updateEnd(l),void(this.featureEffectView.featureEffect=c);this._lastSchema=f,this._fields=null;const S=Math.round(performance.now());I("esri-2d-update-debug")&&console.debug(`Id[${this.layer.uid}] Version[${S}] FeatureLayerView2D._doUpdate`,{changes:v}),await(await this.getWorker()).pipeline.updateSchema(f,S),o.updateEnd(l),this.featureEffectView.featureEffect=c,this.featureEffectView.endTransition(),this.featureContainer.restartAllAnimations(),this.featureContainer.attributeView.unlockTextureUploads(),this.featureContainer.trySwapRenderState(),this.featureContainer.requestRender();const p=f.processor.mesh.strategy,b=p.type==="cluster"||p.type==="binning",_=f.processor.mesh.factory.symbology.type==="heatmap",x=b||_?"target-defer":"eager";this.subscriptionManager.setVisibilityStrategy(x),I("esri-2d-update-debug")&&console.debug(`Version[${S}] FeatureLayerView2D.updateEnd`),this.requestUpdate()}catch(o){I("esri-2d-update-debug")&&console.error("Encountered an error during update",o)}}async _doOverride(e){const t=await this.getWorker();try{for(const i of e.messages)switch(i.type){case"edit":{const r=new st;r.add(await this._resolveEdit(i.event)),await t.pipeline.onOverride(r.toMessage());break}case"override":{const r=new st;r.add(this._resolveOverrides(i.options)),await t.pipeline.onOverride(r.toMessage());break}}}catch(i){Ge(i)}}_getEffectiveAvailableFields(e){const t=Zr(this._lastAvailableFields,e);return this._lastAvailableFields=t,xt(this.layer.fieldsIndex,t)}async _createViewSchemaConfig(){var i,r;const e=this.requiresCurrentUser?await this.signedInUser:null,t=[Yr(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter,this.effectiveDisplayFilterClause),((r=(i=this.featureEffect)==null?void 0:i.filter)==null?void 0:r.toJSON())??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),displayFilterEnabled:this.displayFilterEnabled,filters:t,scale:this.view.scale,timeZone:this.view.timeZone,timeExtent:this.view.timeExtent,currentUser:e,spatialReference:this.view.spatialReference,extent:this.view.extent}}_processHighlight(){this._commandsQueue.push({type:"highlight"})}async _updateHighlights(){const e=this._getHighlights(),t=await this.getWorker();if(this.destroyed)return;const i=t.pipeline.updateHighlight({highlights:e}).catch(r=>{Ge(r)||C.getLogger(this).error(r)});this._updatingHandles.addPromise(i)}_setOriginForFeature(e){e.layer=e.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin(e)}_createFeatureGraphicHit(e,t){return this._setOriginForFeature(t),this._createGraphicHit(e,t)}_createTrackGraphicHit(e,t){var i,r;return t.layer=t.sourceLayer=this.layer,(r=(i=this.layerAdapter).setTrackGraphicOrigin)==null||r.call(i,t),this._createGraphicHit(e,t)}_createAggregateGraphicHit(e,t){var i,r;return t.layer=t.sourceLayer=this.layer,(r=(i=this.layerAdapter).setAggregateGraphicOrigin)==null||r.call(i,t),this._createGraphicHit(e,t)}_createGraphicHit(e,t){return t.geometry!=null&&(t.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:t,layer:this.layer,mapPoint:e}}};function Yr(e,t,i,r,s,a){var l;s&&(s=s.clone());const n=s!=null?s.timeExtent:null,o=i!=null&&n!=null?i.intersection(n):i||n;o&&(s??(s=new $),s.timeExtent=o),s=((l=t.addFilters)==null?void 0:l.call(t,s,e))??s,a&&(s??(s=new $),s.where=U(s.where,a));let u=(s==null?void 0:s.toJSON())??null;return r.size&&(u??(u=new $().toJSON()),u.hiddenIds=Array.from(r)),u}h([y()],R.prototype,"_commandsQueue",void 0),h([y()],R.prototype,"_sourceRefreshVersion",void 0),h([y()],R.prototype,"_displayRefreshVersion",void 0),h([y({readOnly:!0})],R.prototype,"_pipelineUpdating",void 0),h([y()],R.prototype,"_sourceUpdating",void 0),h([y({readOnly:!0})],R.prototype,"dataUpdating",null),h([y({readOnly:!0})],R.prototype,"hasAllFeatures",null),h([y({readOnly:!0})],R.prototype,"hasAllFeaturesInView",null),h([y({readOnly:!0})],R.prototype,"hasFullGeometries",null),h([y()],R.prototype,"featureEffectView",void 0),h([y()],R.prototype,"labelingCollisionInfos",null),h([y()],R.prototype,"layerAdapter",null),h([y({readOnly:!0})],R.prototype,"timeExtent",null),R=h([H("esri.views.2d.layers.FeatureLayerView2D")],R);const eo=Object.freeze(Object.defineProperty({__proto__:null,get default(){return R}},Symbol.toStringTag,{value:"Module"}));export{eo as F,R as d,w as n};
