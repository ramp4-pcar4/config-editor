import{a_ as k}from"./index-DiOGazkl.js";import{a}from"./fabric-xyK63NW0-DZ11azGs.js";const _=30,C=20,T=16,P=12,F=8,f=32,S=32,G=350,w=20,g="Montserrat, BlinkMacSystemFont, Segoe UI, Helvetica, Arial, sans-serif";class v extends k{get config(){var i;return(i=this.$iApi.fixture.get("export").config)==null?void 0:i.legend}async make(i){const n=this.$iApi.geo.layer.allLayersOnMap().filter(o=>!o.isCosmetic);if(n.length===0)return new a.fabric.Group([],{originX:"left"});const t=Math.min(n.length,Math.floor(i.width/(G+w))||1),e=(i.width-(t-1)*w)/t;let r=0;const s=(await Promise.all(this._makeSegments(n,e))).map(({title:o,items:m},c)=>{c>0&&(r+=_),o.top=r,r+=o.height+C;const b=m.map(({title:h,items:u},x)=>{const y=[];return h&&!(m.length===1&&h.text===o.text)&&(x>0&&(r+=T),h.top=r,r+=h.height+P,y.push(h)),u.forEach(p=>{p.top=r,r+=p.height+F}),[...y,...u].filter(p=>p)});return new a.fabric.Group([o,...b.flat()])}).flat(),l=this._makeColumns(s,e,t);return Promise.resolve(l)}_makeColumns(i,n,t){let e=0,r=0,s=0;const l=i[i.length-1].aCoords.bl.y/t;return i.forEach((o,m)=>{const c=m!==i.length-1?i[m+1].top-o.top:o.height,b=s>l*(e+1),h=r!==0&&c>l,u=t-e>i.length-m;(b||h||u)&&e<t&&(++e,r=0),o.left=e*(n+w),o.top=r,r+=c,s+=c}),new a.fabric.Group(i,{originX:"left"})}_makeSegments(i,n){return i.map(async t=>{const e=new a.fabric.Textbox(t.name,{fontSize:24,fontFamily:g,width:n}),r=this._getLayerTreeIds(t);let s=[];return s=t.supportsSublayers?await Promise.all(this._makeSegmentChunks(r,t,n)):await Promise.all(this._makeSegmentChunks([-1],t,n)),{title:e,items:s}})}_makeSegmentChunks(i,n,t){const e=n;return i.map(async r=>{const s=r===-1?e:e.getSublayer(r);if(!s)return{title:new a.fabric.Textbox("ERROR",{fontSize:20,fontFamily:g,width:t}),items:[]};await Promise.all(s.legend.map(c=>c.drawPromise));const l=s.legend,o=new a.fabric.Textbox(s.name,{fontSize:20,fontFamily:g,width:t}),m=await Promise.all(this._makeChunkItems(l,t));return{title:o,items:m}})}_makeChunkItems(i,n){return i.map(async t=>{const e=(await I(a.fabric.loadSVGFromString)(t.svgcode))[0];if(t.esriStandard){e.originY="center",e.top=f/2;const r=new a.fabric.Textbox(t.label,{fontSize:12,fontFamily:g,originY:"center",left:S+20,top:f/2,width:n-S-20});return new a.fabric.Group([e,r],{height:f})}else{const r=new a.fabric.Textbox(t.label,{fontSize:12,fontFamily:g,originY:"center",left:0,top:f/2,width:n}),s=Number(t.imgWidth),l=Number(t.imgHeight),o=Math.min(1,n/s);return e&&(e.originY="center",e.top=l*o/2+f,e.scaleToHeight(l*o),e.scaleToWidth(s*o)),new a.fabric.Group([r,e].filter(Boolean),{height:l*o+f})}})}_getLayerTreeIds(i){const n=[],t=[...i.sublayers];for(;t.length>0;){const e=t.shift();e&&(e.visibility&&n.push(e.layerIdx),t.push(...e.sublayers))}return n}}const I=d=>i=>new Promise(n=>{d(i,t=>{n(t)})});export{v as default};
