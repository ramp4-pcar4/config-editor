const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./deleteForwardEdits-Ctk4U6vM-CITR7Cep.js","./index-Bq7Udiuc.js","./index-CpSsk29H.css","./utils-DuaeuwP5-BCZke6dZ.js","./DeleteForwardEditsParameters-BxDTVu5E-DWh8Af6u.js"])))=>i.map(i=>d[i]);
import{a as x,v as V,I as L,t as T,y as k,z as p,b as D,_ as A}from"./index-Bq7Udiuc.js";import{c as P}from"./uuid-Dj9mdEVg-BaKSCiyT.js";const W=P(),H=new Map,S=new Map;async function O(e,r,d){if(!e||!d)return!1;if(!r)return!0;const s=new URL(e).host;let t=H.get(s);if(!t){const i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");t=(await D(i,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return t===r}async function K(e,r,d=!1){var i,o,a;if(!e||!r)return!0;const s=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),t=(i=S.get(s))==null?void 0:i.entries();if(t){for(const[m,l]of t)if(l.name===r){const u=!((o=l.stack)!=null&&o.hasForwardEdits());if(!u&&d){const[{deleteForwardEdits:h},{default:g}]=await Promise.all([A(()=>import("./deleteForwardEdits-Ctk4U6vM-CITR7Cep.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),A(()=>import("./DeleteForwardEditsParameters-BxDTVu5E-DWh8Af6u.js"),__vite__mapDeps([4,1,2]),import.meta.url)]),F=await h(s,m,new g({sessionId:W,moment:l.moment}));return F.success&&((a=l.stack)==null||a.clearForwardEdits()),F.success}return u}}return!0}function $(e,r){var t;if(!e)return!1;const d=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=(t=S.get(d))==null?void 0:t.entries();if(s){for(const[i,o]of s)if(o.name===r)return o.lockType==="edit"}return!1}const M=new x.EventEmitter;function q(e){return M.on("apply-edits",new WeakRef(e))}function z(e){return M.on("update-moment",new WeakRef(e))}function C(e,r,d=null,s=!1){const t=k();return s=r==null||s,M.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:d,mayReceiveServiceEdits:s,result:t.promise}),t}const U=Symbol();function G(e){return e!=null&&typeof e=="object"&&U in e}function f(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function y(e,r,d){const s=new URL(e).host,t=H.get(s),i=o=>!o||o===t;return i(r)&&i(d)||r===d}const J=e=>{var r;let d=class extends e{constructor(...s){super(...s),this[r]=!0,this._applyEditsHandler=t=>{const{serviceUrl:i,layerId:o,gdbVersion:a,mayReceiveServiceEdits:m,result:l}=t,u=i===this.url,h=o!=null&&this.layerId!=null&&o===this.layerId,g=f(this),F=f(this)&&y(i,a,this.gdbVersion);if(!u||g&&!F||!h&&!m)return;const R=l.then(n=>{var _;if(this.lastEditsEventDate=new Date,h&&(n.addedFeatures.length||n.updatedFeatures.length||n.deletedFeatures.length||n.addedAttachments.length||n.updatedAttachments.length||n.deletedAttachments.length))return this.emit("edits",p(n)),n;const v=(_=n.editedFeatures)==null?void 0:_.find(({layerId:b})=>b===this.layerId);if(v){const{adds:b,updates:E,deletes:w}=v.editedFeatures,j={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],deletedFeatures:w?w.map(({attributes:c})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:c}})=>({objectId:this.objectIdField&&c[this.objectIdField],globalId:this.globalIdField&&c[this.globalIdField]})):[],editedFeatures:p(n.editedFeatures),exceededTransferLimit:!1,historicMoment:p(n.historicMoment)};return this.emit("edits",j),j}const I={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:p(n.editedFeatures),exceededTransferLimit:!1,historicMoment:p(n.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(i,a,I.historicMoment)&&this.emit("edits",I),I}).then(n=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(i,a,n.historicMoment)&&(this.historicMoment=n.historicMoment),n));this.emit("apply-edits",{result:R})},this._updateMomentHandler=t=>{const{serviceUrl:i,gdbVersion:o,moment:a}=t,m=i===this.url,l=f(this),u=f(this)&&y(i,o,this.gdbVersion),h=f(this)&&!y(i,this.gdbVersion,null);m&&l&&u&&h&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then(()=>{this.addHandles(q(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(z(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(s,t,i){return"historicMoment"in this&&this.historicMoment!==i&&$(s,t)}};return r=U,V([L()],d.prototype,"lastEditsEventDate",void 0),d=V([T("esri.layers.mixins.EditBusLayer")],d),d};export{K as B,$ as H,C as P,O as W,W as j,G as q,J as z};
