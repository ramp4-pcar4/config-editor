const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./imageryUtils-DHYzIRVX-Btgvq6pU.js","./utils-DyDDSDvN-h2Ot499z.js","./index-DRDU_nTl.js","./index-6GCfk1Ih.css","./originUtils-BLsWtgV9-CGkwp8uO.js","./multiOriginJSONSupportUtils-DGETddQl-BrWaY9_8.js","./PortalItem-BP-IQXnZ-BpV17zma.js","./jsonContext-C9WBVzLb-u9q_vVYS.js","./portalItemUtils-BfWDJg-S-B_p9oXKP.js","./projectionUtils-B-CplN3q-B7QPK1Xx.js","./saveUtils-W0sSii7v-3Bw9btmg.js","./datasetUtils-DYlC2Qty-B8i6NR3s.js","./Field-BIQ-quF4-D9klJRUl.js","./fieldType-PhcL4ff8-mKwAUt_F.js"])))=>i.map(i=>d[i]);
import{v as D,S as L,n as ye,x as Le,bv as $e,t as Ae,h as _,a1 as Re,bw as Pe,o as j,a6 as oe,_ as Ee,N as ae,aM as be,Z as Me}from"./index-DRDU_nTl.js";import{w as Oe}from"./MultiOriginJSONSupport-BqiFJbbt-DHUs1Le_.js";import{e as Ne}from"./Layer-DvVVmz9x-KWeeum0v.js";import{u as Ve}from"./BlendLayer-DjW_5k0v-B-iv8FvS.js";import{i as ke}from"./CustomParametersMixin-CSMgHDaw-80nrUS7Q.js";import{P as Fe,w as _e,U as P,l as b,a as x,D as S,T as M,J as R,M as we}from"./xmlUtilities-Cc4C-gHm-BhFSDhsA.js";import{u as Ge,a as We,r as Be}from"./OperationalLayer-CbXUnTH0-DDbWRrTr.js";import{x as je}from"./PortalLayer-B34ZUA2x-BPfkadbV.js";import{s as Ue}from"./RasterJobHandlerMixin-DESVihMQ-45C1Dwxr.js";import{T as qe}from"./RefreshableLayer-Qpvyi8qY-CQVsy74Q.js";import{S as He}from"./ScaleRangeLayer-x42fwED3-_jUPFtou.js";import{x as ze}from"./TemporalLayer-lQRje9wB-B-ock43g.js";import{m as he}from"./Field-BIQ-quF4-D9klJRUl.js";import{K as Ye,i as Ze,b as Ke,w as le,d as Je}from"./datasetUtils-DYlC2Qty-B8i6NR3s.js";import{n as xe}from"./crsUtils-BLe27KvG-VS_BXVdj.js";import{e as Xe,Z as ce}from"./RasterSymbolizer-BN6RVtx9-CgjgAV0A.js";import{x as Qe}from"./dataUtils-CfR0oe2x-zUFVQwWy.js";import{y as et}from"./popupUtils-B99PyAFi-CM0VOQKA.js";import{E as te}from"./interfaces-Cwm0pihk-Ptzy6gTd.js";import"./TimeExtent-Cf2Pienb-B-fbcJgZ.js";import"./layerContainerType-ChWdCT09-G5sdAsSy.js";import"./jsonUtils-BwLwuQj7-Bs5cxcDn.js";import"./parser-CWccHtwJ-8TX6iggd.js";import"./mat4f32-BdRMyjXW-CWt6U0BP.js";import"./mat4-OOmHNWi7-DudBwkox.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./TileInfo-U28GysF5-Csxj8poM.js";import"./TileKey-B_6qmYK--BtZdR-Xy.js";import"./QueueProcessor-BSpvDXZs-DWzXstPV.js";import"./Queue-DV3gpSdl-BBj5GUvp.js";import"./ReactiveMap-iPeM8evD-D_plRwrp.js";import"./RawBlockCache-B-F6OWAv-D259vsXd.js";import"./rasterProjectionHelper-DGqzGF1m-BmJoAw_B.js";import"./projectionUtils-B-CplN3q-B7QPK1Xx.js";import"./pixelRangeUtils-DcEknavd-CueOHV1N.js";import"./clipUtils-fw7VCGXU-DKWGgG54.js";import"./FeatureSet-BVGGhhH9-BrSwvD-j.js";import"./rasterFunctionHelper-ABMN-R6n-D2NnbLVV.js";import"./colorUtils-Eg6lOlXm-CIpqqE7k.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./colorRamps-trM-CPFS-HGlbOVMC.js";import"./ElevationInfo-DE5to86a-BmmpBl1B.js";import"./lengthUtils-C61nRlXw-ttxBda7R.js";import"./asyncUtils-BPUlNCrX-B0y5b9rY.js";import"./PortalItem-BP-IQXnZ-BpV17zma.js";import"./portalItemUtils-BfWDJg-S-B_p9oXKP.js";import"./ClassBreaksRenderer-Bq2XGpfI-XPZkvr3K.js";import"./commonProperties-CJLeiNuA-CShbG08T.js";import"./ColorStop-CL7v3R-A-BUT3nBNw.js";import"./visualVariableUtils-BTS148WR-LL3NWewP.js";import"./RendererLegendOptions-Bil_IDab-DmYL58TV.js";import"./UniqueValueRenderer-CLXHFtg9-DeGd1Q65.js";import"./diffUtils-BxG8DCnW-CCukhNys.js";import"./styleUtils-DBPDLVBX-AaWiwUYu.js";import"./workers-CeRXsnNJ-CHie0kLD.js";import"./intl-BAA1onnp-DGsLCBho.js";import"./normalizeUtils-u00NGW3M-BaTNjyav.js";import"./normalizeUtilsCommon-ClagynAA-CL_yyNFN.js";import"./utils-BO8hgPs3-CHxondnJ.js";import"./utils-DpLVEUvg-DfFfnFbm.js";import"./utils-Cb2uXNfG-CLg825jd.js";import"./cimSymbolUtils-DCedSSCN-Le1pFYKH.js";import"./utils-BfXZnjCE-SvVDBGfQ.js";import"./defaultCIMValues-BcSaJjm--58G-soMN.js";import"./enums-a_LDTPYU-CBIcy3mM.js";import"./LRUCache-DPWdPNTF-BhV6gJVw.js";import"./MemCache-qDGoejB7-Bz_y0gIH.js";import"./ClassBreaksDefinition-BZ4FJdWb-BY8hfwqB.js";import"./TimeInfo-COHxjenm-NVfF3eKq.js";import"./timeZoneUtils-d5p0Jda1-BUF1-4-D.js";import"./fieldType-PhcL4ff8-mKwAUt_F.js";import"./_commonjsHelpers-BITg13Vk-KnjfkSck.js";function X(e){return e.endsWith("?")?e.slice(0,-1):e}function pe(e){return e.filter(({coverageSubType:t})=>t==null||t===""||/^rectified(grid|dataset)/i.test(t))}function tt(e){var r,c,h;const t=b(e,"Service/name"),n=x(e,"Capability"),s=((r=x(n,"GetCapabilities/Get/OnlineResource"))==null?void 0:r.getAttribute("xlink:href"))??"",i=((c=x(n,"DescribeCoverage/Get/OnlineResource"))==null?void 0:c.getAttribute("xlink:href"))??"",a=((h=x(n,"GetCoverage/Get/OnlineResource"))==null?void 0:h.getAttribute("xlink:href"))??"",o={getCapabilities:X(s),describeCoverage:X(i),getCoverage:X(a)},p=P(e,"CoverageOfferingBrief"),l=[];for(let d=0;d<p.length;d++){const f=p[d],g=b(f,"name"),m=P(f,"pos"),u=S(m[0]),v=S(m[1]),y=new j({xmin:u[0],ymin:u[1],xmax:v[0],ymax:v[1],spatialReference:{wkid:4326}});l.push({id:g,lonLatEnvelope:y})}return{name:t,onlineResources:o,coverages:l,gridCoverages:pe(l),supportedVersions:["1.0.0"],version:"1.0.0"}}function Ce(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(s.nodeType!==1)continue;const i=we(s).toLowerCase();switch(i){case"title":case"abstract":t[i]=b(s);break;case"identifier":t.id=b(s);break;case"wgs84boundingbox":{const a=S(s,"LowerCorner"),o=S(s,"UpperCorner");t.lonLatEnvelope=new j({xmin:a[0],ymin:a[1],xmax:o[0],ymax:o[1],spatialReference:{wkid:4326}})}break;case"coveragesummary":t.coverageSummaries=t.coverageSummaries||[],t.coverageSummaries.push(Ce(s))}}return t}function Ie(e,t){if(e.coverageSummaries)for(let n=0;n<e.coverageSummaries.length;n++)e.coverageSummaries[n].abstract=e.coverageSummaries[n].abstract||e.abstract,e.coverageSummaries[n].lonLatEnvelope=e.coverageSummaries[n].lonLatEnvelope||e.lonLatEnvelope,e.coverageSummaries[n].title=e.coverageSummaries[n].title||e.title,Ie(e.coverageSummaries[n],t);e.id!=null&&t.push(e)}function Se(e){var i,a,o;const t=((i=x(e.querySelector("Operation[name=GetCapabilities]"),"Get"))==null?void 0:i.getAttribute("xlink:href"))||"",n=((a=x(e.querySelector("Operation[name=DescribeCoverage]"),"Get"))==null?void 0:a.getAttribute("xlink:href"))||"",s=((o=x(e.querySelector("Operation[name=GetCoverage]"),"Get"))==null?void 0:o.getAttribute("xlink:href"))||"";return{getCapabilities:X(t),describeCoverage:X(n),getCoverage:X(s)}}function nt(e){const t=b(e,"ServiceIdentification/Title"),n=M(e,"ServiceIdentification/ServiceTypeVersion"),s=Se(x(e,"OperationsMetadata")),i=[],a=x(e,"Contents");for(let p=0;p<a.childNodes.length;p++){const l=a.childNodes[p];l.nodeType===1&&R(l,"CoverageSummary")&&Ie(Ce(l),i)}const o=M(a,"SupportedFormat");return{name:t,onlineResources:s,coverages:i,gridCoverages:pe(i),supportedVersions:n,supportedFormats:o,version:"1.1.0"}}function it(e){const t=x(e,"ServiceIdentification"),n=b(t,"Title"),s=M(t,"ServiceTypeVersion"),i=M(t,"Profile"),a=Se(x(e,"OperationsMetadata")),o=P(e,"Contents/CoverageSummary"),p=[];for(let r=0;r<o.length;r++){const c=o[r],h=b(c,"CoverageId"),d=x(c,"WGS84BoundingBox");let f;if(d){const m=S(d,"LowerCorner"),u=S(d,"UpperCorner");f=new j({xmin:m[0],ymin:m[1],xmax:u[0],ymax:u[1],spatialReference:{wkid:4326}})}const g=b(c,"CoverageSubtype")||"RectifiedGridCoverage";p.push({id:h,lonLatEnvelope:f,coverageSubType:g})}const l=x(e,"ServiceMetadata");return{name:n,supportedVersions:s,supportedFormats:M(l,"formatSupported"),supportedInterpolations:M(l,"interpolationSupported").concat(M(l,"InterpolationSupported")),onlineResources:a,profiles:i,coverages:p,gridCoverages:pe(p),version:"2.0.1"}}function st(e){let t=null;typeof e=="string"?t=new DOMParser().parseFromString(e,"text/xml"):t=e;const n=t.documentElement.getAttribute("version"),s=n==null?void 0:n.slice(0,3);return s!=null&&s<"2.1"}function ot(e,t=null){let n=null;typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e;let s=n.documentElement.getAttribute("version");s==="1.0"?s="1.0.0":s==="1.1"&&(s="1.1.0");const i=s||t||"1.0.0",a=i.slice(0,3);let o;if(a==="2.0")o=it(n);else if(a==="1.1")o=nt(n);else{if(a!=="1.0")throw new _("wcsraster:parsecapabilities","the capabilities version is not supported");o=tt(n)}return o.version=i,o}function ue(e){e.variables.forEach(t=>t.dimensions.forEach(n=>n.values??(n.values=Je(n))))}function rt(e){return{requestResponseCRSs:M(e,"requestResponseCRSs").map(t=>t.split(":")[1]),nativeCRSs:M(e,"nativeCRSs").map(t=>t.split(":")[1])}}function De(e,t){const n=M(e,t==="1.0.0"?"interpolationMethod":"InterpolationMethod"),s=t==="1.0.0"?e.getAttribute("default"):b(e,"InterpolationMethods/Default");return s!=null?[s].concat(n.filter(i=>i.toLowerCase()!==s.toLowerCase())):n}function me(e){return e==null?["nearest"]:e.map(t=>{const n=t.toLowerCase();return n.includes("nearest")?"nearest":n.includes("linear")?"bilinear":n.includes("cubic")?"cubic":null}).filter(t=>!!t)}function at(e){const t=P(e,"pos"),n=S(t[0]),s=S(t[1]);return new j({xmin:n[0],ymin:n[1],xmax:s[0],ymax:s[1],spatialReference:{wkid:4326}})}function de(e,t){const n=M(e,t);return n!=null&&n.length&&n[0]!==""&&!isNaN(Number(n[0]))?n.map(s=>Number(s)):null}function lt(e){const t=S(e,"MinimumValue"),n=S(e,"MaximumValue");return t.length&&n.length?t.map((s,i)=>({min:s,max:n[i],avg:-1,stddev:-1})):null}function fe(e){return e==null?null:e.every(t=>t===e[0])?e[0]:e}function ct(e){const t=[],n=P(e,"RangeSet");let s=[];for(let i=0;i<n.length;i++){const a=b(n[i],"name"),o=b(n[i],"label"),p=[],l=de(n[i],"nullValues/singleValue"),r=P(n[i],"AxisDescription");for(let c=0;c<r.length;c++){const h=b(r[c],"name"),d=b(r[c],"label"),f=M(r[c],"singleValue");if(f.length===0){const g=b(r[c],"min"),m=b(r[c],"max"),u=Number(b(r[c],"res"))||1;if(g!==null&&m!==null)for(let v=parseInt(g,10);v<=parseInt(m,10);v+=u)f.push(v.toString())}h.toLowerCase()==="band"&&(s=f),p.push({name:h,label:d,values:f})}t.push({name:a,label:o,nullValues:l,axis:p})}return{rangeSet:t,bandNames:s}}function pt(e=null){if(!e)return{resolution:null,units:null};let t=e.toUpperCase();const n=["Y","M","D"],s=["H","M","S"],i=["Years","Months","Days","Hours","Minutes","Seconds"];let a,o,p;return t.includes("PT")?(t=t.slice(2),p=s.findIndex(l=>t.includes(l)),a=i[3+p],o=parseFloat(t.slice(0,-1))):(t=t.slice(1),p=n.findIndex(l=>t.includes(l)),p>-1&&(a=i[p]),o=parseFloat(t.slice(0,-1))),{resolution:o,units:a}}function se(e){const t=P(e,"timeposition");if(t.length>0){const s=[];for(let i=0;i<t.length;i++)s.push(new Date(b(t[i])));return{begin:s[0],end:s[s.length-1],values:s}}const n=x(e,"timePeriod")||x(e,"TimePeriod");return n?{begin:new Date(b(n,"beginPosition")||b(n,"BeginPosition")),end:new Date(b(n,"endPosition")||b(n,"EndPosition")),...pt(b(n,"timeResolution")||b(n,"TimeResolution"))}:null}function ut(e){const t=x(e,"spatialDomain"),n=x(t,"Envelope")||x(t,"EnvelopeWithTimePeriod"),s=n.getAttribute("srsName").split(":"),i=s[s.length-1],a=P(n,"pos"),o=S(a[0]),p=S(a[1]),l=parseInt(i,10),r=isNaN(l)?null:{wkid:l},c=new j({xmin:o[0],ymin:o[1],xmax:p[0],ymax:p[1],spatialReference:r}),h=x(t,"RectifiedGrid"),d=b(h,"low").split(" "),f=b(h,"high").split(" "),g=parseInt(f[0],10)-parseInt(d[0],10)+1,m=parseInt(f[1],10)-parseInt(d[1],10)+1,u=S(t,"origin/pos"),v=P(t,"offsetVector"),y={envelope:c,columns:g,rows:m,offset:{x:parseFloat(b(v[0]).split(" ")[0]),y:parseFloat(b(v[1]).split(" ")[1])},origin:{x:u[0],y:u[1]}},w=x(e,"temporalDomain")||x(e,"TemporalDomain");return{spatialDomain:y,temporalDomain:w?se(w):null}}function mt(e){const t={version:"1.0"};let n,s=[];for(let g=0;g<e.childNodes.length;g++){const m=e.childNodes[g];if(m.nodeType===1)if(R(m,"description"))t.description=b(m);else if(R(m,"name"))t.name=b(m);else if(R(m,"label"))t.label=b(m);else if(R(m,"supportedFormats"))t.supportedFormats=M(m,"formats");else if(R(m,"supportedCRSs"))t.supportedCRSs=rt(m);else if(R(m,"supportedInterpolations"))t.supportedInterpolations=De(m,"1.0.0");else if(R(m,"lonLatEnvelope"))t.lonLatEnvelope=at(m);else if(R(m,"rangeSet")){const u=ct(m);t.rangeSet=u.rangeSet,s=u.bandNames;const v=u.rangeSet[0].nullValues;v!=null&&v.length&&(n=fe(v))}else R(m,"domainSet")&&(t.domainSet=ut(m))}const i=me(t.supportedInterpolations),{name:a,description:o,label:p,lonLatEnvelope:l,supportedFormats:r}=t,{spatialDomain:c}=t.domainSet,h={x:Math.abs(c.offset.x),y:Math.abs(c.offset.y)},d=dt(t.domainSet),f=new ce({width:c.columns,height:c.rows,pixelSize:h,pixelType:"unknown",extent:c.envelope,spatialReference:c.envelope.spatialReference,bandCount:s.length||1,noDataValue:n,multidimensionalInfo:d});return{id:a,title:t.name,description:o||p,lonLatEnvelope:l,rasterInfo:f,bandNames:s,supportedFormats:r,supportedInterpolations:i,coverageDescription:t,version:"1.0.0",useEPSGAxis:!1}}function dt(e){if(!e.temporalDomain)return null;const{begin:t,end:n,values:s,units:i,resolution:a}=e.temporalDomain,o={variables:[{name:"default",description:"",dimensions:[{name:"StdTime",description:"",unit:"ISO8601",values:s==null?void 0:s.map(p=>p.getTime()),hasRegularIntervals:!s,interval:a,intervalUnit:i,extent:[t.getTime(),n.getTime()]}]}]};return ue(o),o}function ft(e,t){const n=[],s=P(e,"Field");let i,a=[];for(let o=0;o<s.length;o++){const p=b(s[o],"Identifier"),l=b(s[o],"Description"),r=b(s[o],"Definition"),c=b(s[o],"Abstract"),h=b(s[o],"Title"),d=de(s[o],"NullValue"),f=x(s[o],"AllowedValues"),g=f?lt(f):null,m=De(s[o],"1.1.0"),u=[],v=P(s[o],"Axis");for(let y=0;y<v.length;y++){const w=v[y].getAttribute("identifier"),$=b(v[y],"UOM"),C=b(v[y],"DataType"),E=M(v[y],"Key");t&&!w.toLowerCase().includes("band")||(a=E,i=d),u.push({identifier:w,uom:$,dataType:C,values:E,bandNoDataValues:i})}n.push({identifier:p,description:l,definition:r,abstract:c,title:h,supportedInterpolations:m,axis:u,nullValues:d,statistics:g})}return{rangeSet:n,bandNames:a,bandNoDataValues:i,statistics:n[0].statistics}}function ht(e,t){if(!t.temporalDomain)return null;const n=e.filter(i=>!i.identifier.toLowerCase().includes("field_1")&&!i.axis.some(a=>a.identifier.includes("band"))),s=[];if(n.length&&n.forEach(i=>{var o;const a=i.axis.map(p=>{const l=p.values.map(c=>p.uom==="ISO8601"?(c=c.trim()).toLowerCase().includes("z")?new Date(c).getTime():new Date(c+"Z").getTime():parseFloat(c.trim())),r=[Math.min.apply(null,l),Math.max.apply(null,l)];return{name:p.identifier.trim(),description:"",field:p.identifier.trim(),unit:p.uom?p.uom.trim():"",hasRegularIntervals:!1,values:l,extent:r}});s.push({name:i.identifier.trim(),description:((o=i.description)==null?void 0:o.trim())??"",unit:"",dimensions:a,statistics:i.statistics})}),t.temporalDomain){const{begin:i,end:a,values:o,units:p,resolution:l}=t.temporalDomain;s.some(r=>r.dimensions.some(c=>c.name.toLowerCase()==="stdtime"))||s.forEach(r=>{r.dimensions.push({name:"StdTime",description:"",unit:"ISO8601",values:o==null?void 0:o.map(c=>c.getTime()),hasRegularIntervals:!o,interval:l,intervalUnit:p,extent:[i.getTime(),a.getTime()]})})}if(s.length){const i={variables:s};return ue(i),i}return null}function gt(e){var v;const t=x(e,"SpatialDomain"),n=x(t,"GridCRS"),s=b(n,"GridBaseCRS"),i=b(n,"GridOrigin"),a=(i==null?void 0:i.split(" ").map(y=>parseFloat(y)))??[0,0],o=S(n,"GridOffsets"),p=P(t,"BoundingBox");let l,r,c,h;for(let y=0;y<p.length;y++){const w=(v=p[y].getAttribute("crs"))==null?void 0:v.toLowerCase();if(w!=null){if(w.includes("imagecrs")){const $=S(p[y],"LowerCorner"),C=S(p[y],"UpperCorner");l=C[0]-$[0]+1,r=C[1]-$[1]+1}else if(w.indexOf("epsg")>0){const $=w.split(":");c=parseInt($[$.length-1],10);const C=S(p[y],"LowerCorner"),E=S(p[y],"UpperCorner");h=new j({xmin:C[0],ymin:C[1],xmax:E[0],ymax:E[1],spatialReference:{wkid:c}})}}}const d=l>r,f=h.xmax-h.xmin>h.ymax-h.ymin;let g=!1;xe(c)&&(d===f?g=!1:(g=!0,h=new j({xmin:h.ymin,ymin:h.xmin,xmax:h.ymax,ymax:h.xmax,spatialReference:{wkid:c}})));const m={columns:l,rows:r,origin:{x:a[0],y:a[1]},offset:{x:o[0],y:o[o.length-1]},gridBaseCRS:s,envelope:h,useEPSGAxis:g},u=x(e,"temporalDomain")||x(e,"TemporalDomain");return{spatialDomain:m,temporalDomain:u?se(u):null}}function vt(e,t){var v;const n=[],s=[],i={supportedFormats:n,supportedCRSs:s,version:"1.1"};let a,o,p=[];for(let y=0;y<e.childNodes.length;y++){const w=e.childNodes[y];if(w.nodeType!==1)continue;const $=we(w).toLowerCase();switch($){case"title":case"abstract":case"identifier":i[$]=b(w);break;case"supportedformat":{const C=b(w);n.includes(C)||n.push(C)}break;case"supportedcrs":{const C=b(w);s.includes(C)||s.push(C)}break;case"range":{const C=ft(w,!!((v=i.domain)!=null&&v.temporalDomain));i.range=C.rangeSet,p=C.bandNames;const{bandNoDataValues:E}=C;E!=null&&E.length&&(a=fe(E)),o=C.statistics}break;case"domain":i.domain=gt(w)}}const l=me(i.range[0].supportedInterpolations),{identifier:r,abstract:c,title:h,domain:d,range:f}=i,g={x:Math.abs(d.spatialDomain.offset.x),y:Math.abs(d.spatialDomain.offset.y)},m=ht(f,d);m&&(a=f[0].nullValues,(a==null?void 0:a.length)===1&&(a=a[0]));const u=new ce({width:d.spatialDomain.columns,height:d.spatialDomain.rows,pixelSize:g,pixelType:"unknown",extent:d.spatialDomain.envelope,spatialReference:d.spatialDomain.envelope.spatialReference,bandCount:p.length||1,noDataValue:a,statistics:o,multidimensionalInfo:m});return{id:r,title:i.title,description:c||h,bandNames:p,rasterInfo:u,supportedFormats:n,supportedInterpolations:l,coverageDescription:i,version:t,useEPSGAxis:d.spatialDomain.useEPSGAxis}}function yt(e){const t=x(e,"Envelope")||x(e,"EnvelopeWithTimePeriod"),n=t.getAttribute("srsName"),s=n.slice(n.lastIndexOf("/")+1),i=t.getAttribute("axisLabels").split(" ").map(m=>m.trim()).filter(m=>m.trim()!==""),a=S(t,"lowerCorner"),o=S(t,"upperCorner"),p=!["y","lat","latitude","north","nor","n","b"].includes(i[0].toLowerCase());let l;const r=parseInt(s,10),c=isNaN(r)?null:{wkid:r};l=new j(p?{xmin:a[0],ymin:a[1],xmax:o[0],ymax:o[1],spatialReference:c}:{xmin:a[1],ymin:a[0],xmax:o[1],ymax:o[0],spatialReference:c});const h={mins:a,maxs:o},d=t.getAttribute("uomLabels").trim().split(" ");let f,g;if(R(t,"EnvelopeWithTimePeriod")){f=new Date(b(e,"beginPosition")||b(e,"BeginPosition")),g=new Date(b(e,"endPosition")||b(e,"EndPosition"));const m=d==null?void 0:d.findIndex(u=>(u==null?void 0:u.toLowerCase())==="oledatetime");m>-1&&(d[m]="ISO8601")}return{envelope:l,axisLabels:i,uomLabels:d.length?d:null,envelopeAllDims:h,beginPosition:f,endPosition:g,isEastFirst:p}}function bt(e,t){var p,l;const n=[],s=P(e,"DataRecord"),i=[];let a,o=[];for(let r=0;r<s.length;r++){const c=P(s[r],"field"),h=[];for(let d=0;d<c.length;d++){const f=c[d].getAttribute("name"),g=b(c[d],"description")||"",m=((p=x(c[d],"uom"))==null?void 0:p.getAttribute("code"))||"",u=S(c[d],"interval"),v=(l=de(c[d],"nilValue"))==null?void 0:l[0];t&&!f.toLowerCase().includes("band")||(i.push(f),u!=null&&u.length&&(a=a||[],a.push({min:u[0],max:u[1],avg:-1,stddev:-1})),o.push(v)),h.push({name:f,description:g,uom:m,allowedValues:u,nilValue:v})}n.push(h)}return o.some(r=>r!=null)||(o=null),{rangeType:n,bandNames:i,bandStats:a,bandNoDataValues:o}}function wt(e){let t=1,n="";const s=.01;return Math.abs(e-1/24)<1/24*s?n="Hours":Math.abs(e-1)<1*s?n="Days":e<1?(t=Math.round(24*e),n="Hours"):e>28-s&&e<31+s||Math.round(e/30)<12?n="Months":e>365-s&&e<366+s&&(n="Years"),{interval:t,intervalUnit:n}}function xt(e,t,n){var a,o;if(n.axisLabels.length<=2)return null;const s=[];for(let p=0;p<e.length;p++){const l=e[p];for(let r=0;r<l.length;r++)l[r].name.toLowerCase().includes("band")||s.push(l[r])}const i=[];if(s.length){const p=[];for(let l=2;l<n.axisLabels.length;l++){const r=((o=(a=t.uomLabels)==null?void 0:a[l])==null?void 0:o.trim())??"",c=n.axisLabels[l].toLowerCase().includes("time")||r.toLowerCase()==="iso8601"||r.toLowerCase()==="oledatetime";let h,d;if(c){const g=wt(n.offset[l]);h=g.interval,d=g.intervalUnit}else h=n.offset[l],d=r;const f=[];c?(f.push(le(t.envelopeAllDims.mins[l])),f.push(le(t.envelopeAllDims.maxs[l]))):(f.push(t.envelopeAllDims.mins[l]),f.push(t.envelopeAllDims.maxs[l])),p.push({name:n.axisLabels[l].trim(),description:n.axisLabels[l].trim(),unit:c?"ISO8601":r,hasRegularIntervals:!0,extent:f,interval:h,intervalUnit:d})}if(s.forEach(l=>{var h;const{allowedValues:r}=l,c=(r==null?void 0:r.length)===2?[{min:r[0],max:r[1],avg:-1,stddev:-1}]:null;i.push({name:l.name.trim(),description:((h=l.description)==null?void 0:h.trim())??"",unit:l.uom.trim(),statistics:c,dimensions:[...p]})}),i.length){const l={variables:i};return ue(l),l}}return null}function Ct(e,t){const n=x(e,"RectifiedGrid"),s=S(n,"low"),i=S(n,"high"),a=[];for(let u=0;u<s.length;u++)a.push(i[u]-s[u]+1);const o=b(n,"axisLabels").split(" "),p=S(n,"origin/pos"),l=P(n,"offsetVector"),r=[];for(let u=0;u<l.length;u++){const v=S(l[u]),y=v.findIndex(w=>w!==0);r[y]=v[y]}const c=["y","lat","latitude","north","nor","n","b"];let h=!1;t!=null&&t.length&&(o!=null&&o.length)&&(h=[...t].sort((u,v)=>u<v?-1:1).join(",")===[...o].sort((u,v)=>u<v?-1:1).join(","));const d=h?o:t;let f,g,m;return c.includes(d[0].toLowerCase())?(f=a[1],g=a[0],m={y:Math.abs(r[0]),x:Math.abs(r[1])}):(f=a[0],g=a[1],m={x:Math.abs(r[0]),y:Math.abs(r[1])}),{columns:f,rows:g,origin:p,offset:r,resolution:m,gridSamples:a,axisLabels:o,hasSameAxisLabelsAsBoundedBy:h}}function It(e){const t=x(e,"EarthObservation");if(!t)return null;const n=x(t,"phenomenonTime"),s=n?se(n):null,i=x(t,"phenomenonTime"),a=i?se(i):null,o=b(t,"featureOfInterest/Footprint/multiExtentOf/MultiSurface/surfaceMembers/Polygon/exterior/LinearRing/posList");let p=null;if(o){const l=o.split(" ").map(r=>r.trim()).filter(r=>r!=null&&r!=="").map(Number);if(l.length){const r=[];for(let c=0;c<l.length/2;c+=2)r.push(l[c],l[c+1]);p=new Me({rings:[[r]]})}}return{observation:{phenomenonTime:s,resultTime:a,footprint:p,identifier:b(e,"metaDataProperty/EarthObservationMetaData/identifier"),acquisitionType:b(e,"metaDataProperty/EarthObservationMetaData/acquisitionType"),status:b(e,"metaDataProperty/EarthObservationMetaData/status")}}}function St(e){var h,d,f;const t={version:"2.0"};let n,s,i=[];for(let g=0;g<e.childNodes.length;g++){const m=e.childNodes[g];if(m.nodeType===1){if(R(m,"coverageId"))t.coverageId=b(m);else if(R(m,"ServiceParameters"))t.serviceParameters={supportedFormats:M(m,"nativeFormat")};else if(R(m,"boundedBy"))t.boundedBy=yt(m);else if(R(m,"rangeType")){const u=bt(m,((h=t.boundedBy)==null?void 0:h.axisLabels.length)>2||((d=t.domainSet)==null?void 0:d.axisLabels.length)>2);t.rangeType=u.rangeType,i=u.bandNames,n=u.bandStats;const{bandNoDataValues:v}=u;v!=null&&v.length&&(s=fe(v))}else if(R(m,"domainSet"))t.domainSet=Ct(m,(f=t.boundedBy)==null?void 0:f.axisLabels);else if(R(m,"metadata")){const u=x(m,"EOMetadata");t.eoMetadata=u?It(u):null}}}const{coverageId:a,boundedBy:o,domainSet:p,rangeType:l,serviceParameters:r}=t,c=xt(l,o,p);return!n&&c&&(n=c==null?void 0:c.variables[0].statistics),c!=null&&(s=l[0][0].nilValue),{id:a,title:a,description:a,bandNames:i,rasterInfo:new ce({width:p.columns,height:p.rows,pixelSize:p.resolution,pixelType:"unknown",extent:o.envelope,spatialReference:o.envelope.spatialReference,bandCount:i.length||1,statistics:n,noDataValue:s,multidimensionalInfo:c}),supportedFormats:r.supportedFormats,coverageDescription:t,version:"2.0.1",useEPSGAxis:!1}}function Dt(e,t){let n=null;if(typeof e=="string"?n=new DOMParser().parseFromString(e,"text/xml"):n=e,t==="1.0.0")return P(n,"CoverageOffering").map(i=>mt(i));const s=P(n,"CoverageDescription");return t==="1.1.0"||t==="1.1.1"||t==="1.1.2"?s.map(i=>vt(i,t)):s.map(i=>St(i))}async function Tt(e,t){const{version:n,customParameters:s,signal:i}=t??{},a=n!=null&&n.startsWith("1.0")?"version":"acceptVersions",o={service:"WCS",request:"GetCapabilities",[a]:n,...s};try{let{data:p}=await ae(e,{query:o,responseType:"xml",signal:i});return t!=null&&t.version||st(p)||(o[a]="2.0.1",{data:p}=await ae(e,{query:o,responseType:"xml",signal:i})),ot(p)}catch(p){throw be(p)?p:new _("wcslayer:open","wcs capabilities is not valid or supported")}}async function re(e,t){const{coverageIds:n,version:s,customParameters:i,signal:a}=t,o=s.slice(0,3),p=o==="1.0"?"coverage":o==="1.1"?"identifiers":"coverageId",l={service:"WCS",request:"DescribeCoverage",version:s,[p]:n.join(","),...i};try{const{data:r}=await ae(e,{query:l,responseType:"xml",signal:a});return Dt(r,s)}catch(r){throw be(r)?r:new _("wcslayer:open","wcs coverage description is not valid or supported")}}function Lt(e){const t=At(e);return t?{isMultipart:!0,data:t.boundary?$t(e.data,t,0):null}:{isMultipart:!1,data:null}}function $t(e,t,n=0){const s="--"+t.boundary,i=[];for(let u=0;u<s.length;u++)i.push(s.charCodeAt(u));const a=[],o=`
--`+t.boundary+"--";for(let u=0;u<o.length;u++)a.push(o.charCodeAt(u));const p=[10],l=[13,10],r=[],c=i.length,h=new Uint8Array(e,n),d=h.length-c;let f=0,g=0;for(let u=0;u<d;u++){for(g=0;g<c&&h[u+g]===i[g];g++);if(g!==c)continue;let v=!1;if(f){const y=ge(h.subarray(f,u),t);r.push(y),v=!!y.isValidImage}if(u+=c-1,h[u+1]===p[0]?u+=1:h[u+1]===l[0]&&h[u+2]===l[1]&&(u+=2),f=u+1,v)break}const m=a.length;for(let u=h.length-m-10;u<h.length-m;u++){for(g=0;g<m&&h[u+g]===a[g];g++);if(g===m){r.push(ge(h.subarray(f,u),t));break}}return r}function At(e){var s,i;const t=(i=(s=e.getHeader)==null?void 0:s.call(e,"Content-Type"))==null?void 0:i.split(";");if(!t||!(t[0].trim()??"").startsWith("multipart/"))return null;const n={boundary:"",start:"",type:""};for(let a=1;a<t.length;a++){const o=t[a].indexOf("=");if(o>0){const p=t[a].slice(0,o).trim(),l=t[a].slice(o+1).trim();n[p]=l.startsWith('"')?l.slice(1,-1):l}}return n}function ge(e,t){var o;const n=String.fromCharCode.apply(null,e.subarray(0,Math.min(300,e.length))).split(`
`),s=Math.min(n.length,7),i={contentDisposition:"inline"};let a=0;for(let p=0;p<s;p++)if(n[p].length<4)a=a+n[p].length+1;else if(n[p].slice(0,7).toLowerCase()==="content"){a=a+n[p].length+1;const l=n[p].indexOf(":");if(l===-1)continue;const r=n[p].slice(0,l).trim(),c=n[p].slice(l+1).trim();switch(r.toLowerCase()){case"content-type":i.contentType=c;break;case"content-description":i.contentDescription=c;break;case"content-transfer-encoding":i.contentTransferEncoding=c;break;case"content-id":i.contentID=c;break;case"content-disposition":i.contentDisposition=c;break;case"content-location":i.contentLocation=c}}else{if(i.contentDisposition.toLowerCase().includes("inline")&&n[p].length>=4&&((o=i.contentType)==null?void 0:o.toLowerCase().indexOf("image"))>-1){let l=!0,r=e.subarray(a,e.length);if(i.contentType.toLowerCase().indexOf("tif")>0){if(i.contentTransferEncoding==="base64"){let c="";const h=r;for(let f=0;f<h.length;f+=65535){const g=h.subarray(f,f+65535>h.length-1?h.length-1:f+65535);c+=String.fromCharCode.apply(null,g)}const d=atob(c);r=new Uint8Array(d.length);for(let f=0;f<r.length;f++)r[f]=d.charCodeAt(f)}l=r[0]===73&&r[1]===73||r[0]===77&&r[1]===77}if(l){let c=r.buffer;i.contentTransferEncoding!=="base64"&&(c=new ArrayBuffer(e.length-a),r=new Uint8Array(c),r.set(e.subarray(a,e.length))),i.contentData=c,i.isValidImage=!0}break}if((t.start===""||i.contentID===t.start)&&i.contentType){if(i.contentType.includes("text")||i.contentType.includes("xml")){i.contentData=String.fromCharCode.apply(null,e.subarray(a,e.length));break}i.contentData=e.subarray(a,e.length)}}return i}const Rt=["nearest neighbor","bilinear","bicubic"],Pt=["nearest","linear","cubic"],ve="response is not a supported multipart/related mediaType with inline tiff,  switching to compatibility mode",Et="response is not a supported multipart mediaType with inline tiff",Mt="response is base64 encoded which may impact layer display performance",Ot="server returns an exception",ne=new Set(["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"]);let H=class extends _e{constructor(){super(...arguments),this.datasetFormat="WCSServer",this.tileType="Raster"}get rasterId(){return`${this.url}-${this.coverageId}-${this.version}`}async fetchRawTile(e,t,n,s={}){var z,J;if(this.isBlockOutside(e,t,n))return null;const{nativePixelSize:i,spatialReference:a}=this.rasterInfo,o=2**e,p=i.x*o,l=i.y*o,{blockWidth:r,blockHeight:c}=this.getBlockWidthHeight(e),{origin:h}=this.rasterInfo.storageInfo.tileInfo,d=this.getTileExtent({x:p,y:l},t,n,h,a,[r,c]),f=this.rasterInfo.extent,g=d.xmax>f.xmax,m=d.ymin<f.ymin,u=g||m;let v=d,y=r,w=c;if(u&&(v=d.clone().intersection(f),v!=null&&(g&&(y=Math.floor((v.xmax-v.xmin)/p),v.xmax=v.xmin+p*y),m&&(w=Math.floor((v.ymax-v.ymin)/l),v.ymin=v.ymax-l*w))),v==null||y<=1||w<=1)return null;const $=await this._getCoverage(v,y,w,o,s);if(!$)return null;const{coverageDescription:C}=this.coverageInfo,{noDataValue:E,multidimensionalInfo:O}=this.rasterInfo,{multidimensionalDefinition:U}=s;let W;if(O!=null&&U!=null&&U.length){const G=U[0].variableName;C.version==="2.0"?W=(z=C.rangeType[0].find(I=>I.name===G))==null?void 0:z.nilValue:C.version==="1.1"&&(W=(J=C.range.find(I=>I.identifier===G))==null?void 0:J.nullValues)}const q=W??E,V=await this.decodePixelBlock($,{width:y,height:w,planes:null,pixelType:null,tiffNoDataValue:Array.isArray(q)?q[0]:q,matchAllNoData:!0});if(V==null)return null;if(V&&(V.width!==y||V.height!==w))throw new _("wcsraster-fetch",`the response has unexpected dimension width: ${V.width}, height: {pixelBlock.height}`);return u?Qe(V,{x:0,y:0},{width:c,height:c}):V}async _open(e){const{customFetchParameters:t}=this.ioConfig,n=e==null?void 0:e.signal,s=await Tt(this.url,{version:(t==null?void 0:t.version)??this.version,customParameters:t,signal:n});if(this.capabilities=s,!this.version){let d=s.version.slice(0,3);d==="2.0"||d==="1.1"||d==="1.0"?this.version=s.version:(d=s.supportedVersions.find(f=>f==="2.0.1")||s.supportedVersions.find(f=>f.slice(0,3)==="2.0")||s.supportedVersions.find(f=>f.slice(0,3)==="1.1")||s.supportedVersions.find(f=>f.slice(0,3)==="1.0")||"1.0.0",this.version=d)}const{version:i}=this;if(!ne.has(i))throw new _("wcsraster-open",`unsupported WCS version ${i}`);const{gridCoverages:a}=s;if(!a.length)throw new _("wcsraster-open","cannot find rectified grid coverages");this.coverageId??(this.coverageId=a[0].id);const{coverageId:o}=this,p=a.find(d=>d.id===o);if(p==null)throw new _("wcsraster-open",`the coverageId ${o} does not exist in capabilities`);const l=await re(this.url,{coverageIds:[o],version:i,customParameters:t,signal:n});if(this.coverageInfo=l[0],i.slice(0,3)==="2.0"){const{coverageInfo:d}=this;d.lonLatEnvelope=p.lonLatEnvelope,d.supportedInterpolations=me(s.supportedInterpolations),this._patchDimensionValues201(o,n)}this.datasetName=this.coverageInfo.title;const{rasterInfo:r}=this.coverageInfo;if(this.createRemoteDatasetStorageInfo(r,512,512),this._set("rasterInfo",r),r.spatialReference==null)throw new _("wcsraster-open",`coverage without spatial reference is not supported: ${o}`);const{pixelType:c,bandCount:h}=await this._getPixelTypeAndBandCount(n);r.pixelType=c,r.bandCount===1&&h>1&&(r.bandCount=h),this.updateTileInfo()}async _patchDimensionValues201(e,t){var o,p,l,r,c;const{coverageInfo:n}=this,s=(o=n.rasterInfo.multidimensionalInfo)==null?void 0:o.variables,i=ne.has("1.1.2")?"1.1.2":ne.has("1.1.1")?"1.1.1":ne.has("1.1.0")?"1.1.0":null,{customFetchParameters:a}=this.ioConfig;if(s&&i)try{const h=this.url.includes("/ImageServer/"),d=e.length>8&&e.startsWith("Coverage")&&h?e.slice(8):e,f=await re(this.url,{coverageIds:[d??e],version:i,customParameters:a,signal:t}).catch(()=>{if(d)return re(this.url,{coverageIds:[e],version:i,customParameters:a,signal:t})}),g=(p=f==null?void 0:f[0].rasterInfo.multidimensionalInfo)==null?void 0:p.variables;if(g)for(const m of s){const u=g.find(({name:v})=>v===m.name);if((l=u==null?void 0:u.dimensions)!=null&&l.length)for(let v=m.dimensions.length-1;v>=0;v--){const y=m.dimensions[v],w=u.dimensions.find(({name:$})=>$===y.name);w?w.values&&((r=w.extent)==null?void 0:r.join(","))===((c=y.extent)==null?void 0:c.join(","))&&(m.dimensions[v]={...y,values:w.values}):h&&m.dimensions.splice(v,1)}}}catch{}}async _getPixelTypeAndBandCount(e){var g;const{pixelSize:t,extent:n,multidimensionalInfo:s}=this.rasterInfo,i=n.center,a=new j({xmin:i.x-t.x,xmax:i.x+t.x,ymin:i.y-t.y,ymax:i.y+t.y,spatialReference:n.spatialReference});let o=[];if(s!=null){const m=s.variables[0];o=[],m.dimensions.forEach(u=>{var v,y;o.push(new Ke({variableName:m.name,dimensionName:u.name,values:u.hasRegularIntervals?(v=u.extent)==null?void 0:v[0]:(y=u.values)==null?void 0:y[0],isSlice:!0}))})}const{coverageDescription:p}=this.coverageInfo,l={interpolation:"nearest",multidimensionalDefinition:o,signal:e},{version:r}=p,{ioConfig:c}=this,h=r==="2.0"&&c.allowAnyMediaType==null||r==="1.1"&&c.use2GridOffsets==null;let d;try{d=await this._getCoverage(a,2,2,1,l,!0)}catch(m){if(!h)throw m;if(r==="1.1"){if(!((g=m.details)!=null&&g.isResolutionMismatch))throw m;c.use2GridOffsets=!0}}if(!d&&h&&(r==="2.0"&&(c.allowAnyMediaType=!0),d=await this._getCoverage(a,2,2,1,l),d&&oe.getLogger(this).warn("wcsraster:getcoverage",ve)),!d)throw new _("wcsraster-open","unable to determine pixel type");const f=await this.decodePixelBlock(d,{width:2,height:2,planes:null,pixelType:null});if(f==null)throw new _("wcsraster-open","unable to determine pixel type");return{pixelType:f.pixelType,bandCount:f.getPlaneCount()??0}}async _getCoverage(e,t,n,s,i,a=!1){const{coverageDescription:o}=this.coverageInfo,{version:p}=o,l=p==="2.0"?this._getCoverage201Parameters(e,t,n,s,i,o):p==="1.1"?this._getCoverage110Parameters(e,t,n,i,o):this._getCoverage100Parameters(e,t,n,i),r=p==="2.0"?await this.request(this._constructWCS201Url(l),{signal:i.signal,responseType:"array-buffer"}):await this.request(this.url,{query:l,signal:i.signal,responseType:"array-buffer"});if(p==="1.0")return r.data;if(p==="2.0"&&this.ioConfig.allowAnyMediaType!==!1&&Xe(r.data)==="tiff")return a&&(this.ioConfig.allowAnyMediaType=!0,oe.getLogger(this).warn("wcsraster:getcoverage",ve)),r.data;const c=Lt(r);if(c.isMultipart&&c.data){const g=c.data.find(m=>m.isValidImage);return a&&(g==null?void 0:g.contentTransferEncoding)==="base64"&&oe.getLogger(this).warn("wcsraster:getcoverage",Mt),g==null?void 0:g.contentData}const h=new Uint8Array(r.data,0,Math.min(r.data.byteLength,2e3)),d=String.fromCharCode.apply(null,h).toLowerCase().includes("exception"),f=d&&String.fromCharCode.apply(null,h).includes("A non-zero RESX/RESY or WIDTH/HEIGHT is required but neither was provided");throw d?new _("wcsraster:getcoverage",Ot,{isResolutionMismatch:f}):new _("wcsraster:getcoverage",Et)}_getInterpolationIndex(e){var t;return e&&((t=this.coverageInfo.supportedInterpolations)!=null&&t.includes(e))?e==="nearest"?0:e==="bilinear"?1:e==="cubic"?2:0:0}_getCoverage100Parameters(e,t,n,s){var g;const i=`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`,a=e.spatialReference.wkid,o=(this.coverageInfo.supportedFormats||[]).find(m=>m.toLowerCase().includes("tiff"))||"GEOTIFF",{bandIds:p,interpolation:l}=s,r=this._getInterpolationIndex(l),c=p?p.map(m=>this.coverageInfo.bandNames[m]):null,h=Rt[r],{multidimensionalDefinition:d}=s;let f;if(d!=null&&this.rasterInfo.multidimensionalInfo!=null){let m=(g=d.find(u=>u.dimensionName==="StdTime"))==null?void 0:g.values;m&&m.length>0&&(Array.isArray(m[0])&&(m=m[0]),f=m.map(u=>ie(u)).join(","))}return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:o,crs:`EPSG:${a}`,bbox:i,width:t,height:n,time:f,interpolation:h,band:c==null?void 0:c.join(",")}}_getCoverage110Parameters(e,t,n,s,i){var F,B,Q;const{multidimensionalDefinition:a,bandIds:o,interpolation:p}=s,l=e.spatialReference.wkid,r=`urn:ogc:def:crs:EPSG::${l}`,c=(this.coverageInfo.supportedFormats||[]).find(T=>T.toLowerCase().includes("tiff"))||"image/tiff",h=this._getInterpolationIndex(p),d=Pt[h],f=p==null||((F=this.coverageInfo.supportedInterpolations)==null?void 0:F.indexOf(p))===0,g=i.domain.spatialDomain,m=g.origin.x<=g.envelope.xmin&&g.origin.y<=g.envelope.ymin,u=e.width/t,v=e.height/n*(m?1:-1),y=m?[e.xmin,e.ymin]:[e.xmin,e.ymax],w=g.useEPSGAxis&&xe(l),$=w?`${y[1]},${y[0]}`:`${y[0]},${y[1]}`,C=this.ioConfig.use2GridOffsets,E=w?C?`${v},${u}`:`${v},0,0,${u}`:C?`${u},${v}`:`${u},0,0,${v}`,O=u/2,U=e.xmin+O,W=e.xmax-O,q=Math.abs(v)/2,V=e.ymin+q,z=e.ymax-q,J=w?`${V},${U},${z},${W},${r}`:`${U},${V},${W},${z},${r}`,G=i.range.find(T=>T.axis.some(N=>N.identifier.toLowerCase().includes("band")));let I,k=G&&d&&o?f?`${G.identifier}[${G.axis[0].identifier}[${o.join(",")}]]`:`${G.identifier}:${d}[${G.axis[0].identifier}[${o.join(",")}]]`:null;if(a!=null&&a.length)for(let T=0;T<a.length;T++){let N=a[T].values;const Y=(B=a[T].dimensionName)==null?void 0:B.toLowerCase(),ee=(Q=a[T].variableName)==null?void 0:Q.toLowerCase(),Z=i.range.find(K=>K.identifier.toLowerCase()===ee);if(N.length>0){if(Array.isArray(N[0])&&(N=N[0]),Y==="stdtime")I=N.map(K=>ie(K)).join(",");else if(Z){const K=Z.axis.find(Te=>Te.identifier.toLowerCase()===Y);K&&(k=f?Z.identifier+"["+K.identifier+"["+N.join(",")+"]]":Z.identifier+":"+d+"["+K.identifier+"["+N.join(",")+"]]")}}T===a.length-1&&Z&&!k&&(k=f?Z.identifier:Z.identifier+":"+d)}return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:c,crs:`EPSG:${l}`,boundingbox:J,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:$,gridOffsets:E,gridBaseCRS:r,timeSequence:I,rangeSubset:k}}_getCoverage201Parameters(e,t,n,s,i,a){var G;const{multidimensionalDefinition:o,interpolation:p}=i,l=this._getInterpolationIndex(p);let r=null;const{supportedInterpolations:c}=this.capabilities;if(c!=null&&c.length)switch(l){case 0:r=c.find(I=>I.toLowerCase().includes("nearest"));break;case 1:r=c.find(I=>I.toLowerCase().includes("linear"));break;case 2:r=c.find(I=>I.toLowerCase().includes("cubic")||I.toLowerCase().includes("quadratic"))}const h=(this.coverageInfo.supportedFormats||[]).find(I=>I.toLowerCase().includes("tiff"))||"image/tiff",{bandNames:d}=this.coverageInfo,{boundedBy:f,domainSet:g,rangeType:m}=a,u=f.isEastFirst?0:1,v=1-u,{axisLabels:y}=f,w=y[u],$=y[v],C=`http://www.opengis.net/def/crs/EPSG/0/${e.spatialReference.wkid}`,E=C,O=[];O.push(`${w}(${e.xmin},${e.xmax})`),O.push(`${$}(${e.ymin},${e.ymax})`);const U=[];if(y.length>2)for(let I=2;I<y.length;I++){const k=g.origin[I];if(y[I].toLowerCase().includes("time")){let F=k.toString();(G=f.uomLabels)!=null&&G[I].toLowerCase().includes("ole")&&(U.push(y[I]),F=ie(k,!0)),O.push(y[I]+",http://www.opengis.net("+F+")")}else O.push(y[I]+",http://www.opengis.net("+k+")")}let W=null;if(o!=null&&o.length){const I=[];m.forEach(F=>F.forEach(B=>I.push(B.name)));const k=[];for(let F=0;F<o.length;F++){const B=y.find(T=>T===o[F].dimensionName),Q=I.find(T=>T===o[F].variableName);if(k.includes(Q)||k.push(Q),B){let T=o[F].values;if(T.length>0){Array.isArray(T[0])&&(T=T[0]);let N="";N=B.toLowerCase().includes("time")?T.map(ee=>ie(ee)).join(","):T.join(",");const Y=O.findIndex(ee=>ee.indexOf(B+",http://www.opengis.net")===0);Y===-1&&O.push(B+",http://www.opengis.net("+N+")"),Y===-1||O[Y].includes("("+N+")")||O.splice(Y,1,B+",http://www.opengis.net("+N+")")}}}k.length&&(W=k.join(","))}else(d==null?void 0:d.length)>=2&&(W=(i.bandIds?i.bandIds.map(I=>d[I]):d).join(","));const q=O.join("&subset="),V=!a.domainSet.hasSameAxisLabelsAsBoundedBy&&this.ioConfig.allowScaleFactor!==!1,z=V?null:`${w}(${t}),${$}(${n})`,J=V?1/s:null;return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:W,interpolation:r,scaleSize:z,scaleFactor:J,subset:q,format:h,mediaType:this.ioConfig.allowAnyMediaType?null:"multipart/related",outputcrs:C,subsettingcrs:E}}_constructWCS201Url(e){const t={...this.ioConfig.customFetchParameters,...e},n=[];return Object.keys(t).forEach(s=>{const i=t[s];i!=null&&(s==="subset"?typeof i=="string"&&i.split("&subset=").forEach(a=>{a&&n.push(`subset=${encodeURIComponent(a)}`)}):n.push(`${s}=${encodeURIComponent(i)}`))}),`${encodeURI(this.url)}?${n.join("&")}`}};function ie(e,t=!1){return(t?new Date(le(e)):new Date(e)).toISOString()}D([L({type:String,json:{write:!0}})],H.prototype,"datasetFormat",void 0),D([L({readOnly:!0})],H.prototype,"tileType",void 0),D([L({type:String,json:{write:!0}})],H.prototype,"version",void 0),D([L({type:String,json:{write:!0}})],H.prototype,"coverageId",void 0),D([L({readOnly:!0})],H.prototype,"rasterId",null),H=D([ye("esri.layers.support.rasterDatasets.WCSRaster")],H);const Nt=new Set(["milliseconds","seconds","minutes","hours","days","weeks","months","years","decades","centuries"]);let A=class extends Ve(He(Ge(je(ke(Fe(Ue(ze(qe(Oe(Le.ClonableMixin(Ne))))))))))){constructor(...e){super(...e),this.coverageId=null,this.version=null,this.isReference=null,this.legendEnabled=!0,this.noData=0,this.operationalLayerType="WCS",this.type="wcs",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null,this._debouncedSaveOperations=$e(async(t,n,s)=>{const{save:i,saveAs:a}=await Ee(()=>import("./imageryUtils-DHYzIRVX-Btgvq6pU.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]),import.meta.url);switch(t){case te.SAVE:return i(this,n);case te.SAVE_AS:return a(this,s,n)}})}normalizeCtorArgs(e,t){return typeof e=="string"?{url:e,...t}:e}load(e){const t=e!=null?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WCS"]},e).catch(Ae).then(()=>this._openRaster(t))),Promise.resolve(this)}get coverageInfo(){return this.raster.coverageInfo}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){var s;const e=[Ye("Pixel Value")],t=((s=this.raster)==null?void 0:s.rasterInfo)??this.serviceRasterInfo,n=t==null?void 0:t.multidimensionalInfo;if(n){const i=Ze(n);e.push(...i)}return e}createPopupTemplate(e){return et({fields:this.rasterFields,title:this.title},e)}async save(e){return this._debouncedSaveOperations(te.SAVE,e)}async saveAs(e,t){return this._debouncedSaveOperations(te.SAVE_AS,t,e)}async _openRaster(e){var i,a,o,p;const t=new H({url:this.url,version:this.version,coverageId:this.coverageId,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters}});if(await t.open({signal:e}),!t.rasterInfo)throw t.destroy(),new _("wcs-layer:load","cannot load resources on "+this.url);const{rasterInfo:n}=t;n.noDataValue==null&&(n.noDataValue=this.noData),this._set("serviceRasterInfo",n),this._set("spatialReference",n.spatialReference),this.title==null&&this.setAtOrigin("title",t.datasetName,"service"),this.coverageId==null&&this.setAtOrigin("coverageId",t.coverageInfo.id,"service"),this.version==null&&t.version&&this.setAtOrigin("version",t.version,"service"),this.setAtOrigin("tileInfo",t.rasterInfo.storageInfo.tileInfo,"service");const{multidimensionalInfo:s}=n;if(s!=null){const l=s.variables[0].dimensions.find(({name:r})=>r==="StdTime");if(l){let r=((i=l.extent)==null?void 0:i[0])??l.values[0];Array.isArray(r)&&(r=r[0]);let c=((a=l.extent)==null?void 0:a[1])??l.values[l.values.length-1];Array.isArray(c)&&(c=c[1]);const h=Nt.has((o=l.intervalUnit)==null?void 0:o.toLowerCase())?(p=l.intervalUnit)==null?void 0:p.toLowerCase():null;this.set("timeInfo",{startField:"StdTime",fullTimeExtent:{start:r,end:c},timeZone:null,interval:h?{value:l.interval,unit:h}:null})}}this.raster=t,this._configDefaultSettings(),this.addHandles(Re(()=>this.customParameters,l=>this.raster.ioConfig.customFetchParameters=l))}};D([L({type:String,nonNullable:!0,json:{name:"wcsInfo.coverageId",write:{isRequired:!0,ignoreOrigin:!0}}})],A.prototype,"coverageId",void 0),D([L()],A.prototype,"coverageInfo",null),D([L({type:["1.0.0","1.1.0","1.1.1","1.1.2","2.0.1"],nonNullable:!0,json:{name:"wcsInfo.version",write:{isRequired:!0,ignoreOrigin:!0}}})],A.prototype,"version",void 0),D([L({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],A.prototype,"isReference",void 0),D([L({json:{read:!0,write:!0}})],A.prototype,"blendMode",void 0),D([L(We)],A.prototype,"legendEnabled",void 0),D([L({type:["show","hide"]})],A.prototype,"listMode",void 0),D([L()],A.prototype,"noData",void 0),D([L({type:["WCS"]})],A.prototype,"operationalLayerType",void 0),D([L()],A.prototype,"raster",void 0),D([L({readOnly:!0})],A.prototype,"type",void 0),D([L(Be)],A.prototype,"popupEnabled",void 0),D([L({type:Pe,json:{name:"popupInfo",write:!0}})],A.prototype,"popupTemplate",void 0),D([L({readOnly:!0})],A.prototype,"defaultPopupTemplate",null),D([L({readOnly:!0,type:[he]})],A.prototype,"fields",void 0),D([L({readOnly:!0,type:[he]})],A.prototype,"rasterFields",null),A=D([ye("esri.layers.WCSLayer")],A);const ni=A;export{ni as default};
