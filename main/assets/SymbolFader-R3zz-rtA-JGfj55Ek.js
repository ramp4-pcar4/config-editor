import{c5 as W,ki as M}from"./index-CQ8-0QQp.js";import{b as H,e as R}from"./MapView-DVZSZHRJ-BWPsYTmX.js";import{o as $,t as C,a as N}from"./config-CmYJx2vm-DFBdNYhW.js";import{R as O,I as g}from"./constants-BgwgMQXd-By4voKYl.js";import{Q as Y}from"./GeometryUtils-B8e3Iwyx-BftZgfY6.js";import{a as j,i as Z,t as G}from"./StyleDefinition-BOKVAZI1-DGWlgUVE.js";import{R as K,D as Q,G as X,H as ee}from"./mat3-DOnW3DjW-C3hbW9XY.js";import{c as V}from"./memoryEstimations-DeWfxwaV-D8kkh29b.js";import"./enums-CQnCd4Rx-DgRIovtR.js";import{s as te}from"./TileKey-_zikB14n-C-4kO8eC.js";import{u as b,F as T}from"./VertexArrayObject-CieliEx4-D3vFIhaw.js";import{f as S}from"./enums-wEDHPbCF-Cf76M5_x.js";import{q as se}from"./WGLContainer-qQmF3DRB-DZ4wYbOe.js";import{f as ie,D as oe}from"./definitions-MCCItX4r-o3EUznKY.js";class re{constructor(e,s){this.sourceTile=s,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.uniqueSymbol=null,this._colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}colliders(){return this._colliders}}let ne=class{constructor(o){this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1,this.lastShow=!1,this.tileSymbols=[o],this.id=o.id}};function le(o,e,s,t){return k(o,e,s.level,s.col,t.key.level,t.key.col)}function ae(o,e,s,t){return k(o,e,s.level,s.row,t.level,t.row)}function k(o,e,s,t,i,r){const n=s-i;if(n>=0)return(e>>n)+(t-(r<<n))*(o>>n);const a=-n;return e-(r-(t<<a))*(o>>a)<<a}class q{constructor(e,s,t){this._rows=Math.ceil(s/t),this._columns=Math.ceil(e/t),this._cellSize=t,this.cells=new Array(this._rows);for(let i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(let r=0;r<this._columns;r++)this.cells[i][r]=[]}}getCell(e,s){const t=Math.min(Math.max(Math.floor(s/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[t]&&this.cells[t][i]||null}getCellSpan(e,s,t,i){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function he(o,e,s,t,i,r,n){const a=e[t++];for(let y=0;y<a;y++){const l=new re(r,n);l.xTile=e[t++],l.yTile=e[t++],l.hash=e[t++],l.priority=e[t++],l.featureIndex=e[t++];const c=e[t++],u=l.colliders();for(let f=0;f<c;f++){const m=e[t++],d=e[t++],p=e[t++],w=e[t++],x=!!e[t++],I=e[t++],P=s[t++],B=s[t++],J=e[t++],E=e[t++];u.push({xTile:m,yTile:d,dxPixels:p,dyPixels:w,hard:x,partIndex:I,width:J,height:E,minLod:P,maxLod:B})}const h=o[t++];for(let f=0;f<h;f++)l.textVertexRanges.push([o[t++],o[t++]]);const _=o[t++];for(let f=0;f<_;f++)l.iconVertexRanges.push([o[t++],o[t++]]);i.push(l)}return t}function Je(o,e,s){for(const[t,i]of o.symbols)ce(o,e,s,i,t)}function ce(o,e,s,t,i){const r=o.layerData.get(i);if(r.type===g.SYMBOL){for(const n of t){const a=n.uniqueSymbol;let y;if(n.selectedForRendering){const l=a.parts[0],c=l.startOpacity,u=l.targetOpacity;o.allSymbolsFadingOut=o.allSymbolsFadingOut&&u===0;const h=Math.floor(127*c)|u<<7;y=h<<24|h<<16|h<<8|h}else y=0;for(const[l,c]of n.iconVertexRanges)for(let u=l;u<l+c;u+=4)r.iconOpacity[u/4]=y;if(n.selectedForRendering){const l=a.parts[1],c=l.startOpacity,u=l.targetOpacity;o.allSymbolsFadingOut=o.allSymbolsFadingOut&&u===0;const h=Math.floor(127*c)|u<<7;y=h<<24|h<<16|h<<8|h}else y=0;for(const[l,c]of n.textVertexRanges)for(let u=l;u<l+c;u+=4)r.textOpacity[u/4]=y}r.lastOpacityUpdate=e,r.opacityChanged=!0}}function ye(o,e,s,t){var l;const i=o.colliders();let r,n,a,y;for(const c of i)if((l=o.uniqueSymbol)!=null&&l.show&&o.uniqueSymbol.parts[c.partIndex].show&&(r=c.xScreen-t[0]+c.dxScreen,n=c.yScreen-t[1]+c.dyScreen,a=r+c.width,y=n+c.height,Y(s,e.x,e.y,r,n,a,y)))return!0;return!1}let ue=class{constructor(o,e,s,t,i,r){this._symbols=o,this._styleRepository=t,this._zoom=i,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new q(e,s,N),this._si=Math.sin(Math.PI*r/180),this._co=Math.cos(Math.PI*r/180),t.cachedStyles&&(this._styleProps=t.cachedStyles);for(const n of o)for(const a of n.symbols)this._allNeededMatrices.has(a.tile)||this._allNeededMatrices.set(a.tile,H(a.tile.transforms.tileUnitsToPixels))}work(o){var s,t;const e=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const i=this._symbols[this._currentLayerCursor],r=this._getProperties(i.styleLayerUID),n=(s=this._styleRepository.layerContexts)==null?void 0:s.get(i.styleLayerUID);for(;this._currentSymbolCursor<i.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-e>o)return!1;const a=i.symbols[this._currentSymbolCursor];if(!((t=a.uniqueSymbol)!=null&&t.show))continue;const y=this._computeCoordinates(a,r,n),l=a.uniqueSymbol;if(!l.show)continue;const{iconAllowOverlap:c,textAllowOverlap:u}=r;for(const h of y){if(!h.enabled)continue;const _=l.parts[h.partIndex];_.show&&!(h.partIndex?u:c)&&this._doesCollide(h)&&(h.hard?l.show=!1:_.show=!1)}l.show&&this._insertColliders(l.parts,y,r)}}return!0}_insertColliders(o,e,s){const{iconIgnorePlacement:t,textIgnorePlacement:i}=s;for(const r of e){if(!r.enabled||(r.partIndex?i:t)||!o[r.partIndex].show)continue;const n=r.xScreen+r.dxScreen,a=r.yScreen+r.dyScreen,y=n+r.width,l=a+r.height,[c,u,h,_]=this._gridIndex.getCellSpan(n,a,y,l);for(let f=u;f<=_;f++)for(let m=c;m<=h;m++)this._gridIndex.cells[f][m].push(r)}}_computeCoordinates(o,e,s){const{iconRotationAlignment:t,textRotationAlignment:i,iconTranslate:r,iconTranslateAnchor:n,textTranslate:a,textTranslateAnchor:y}=e,l=this._si,c=this._co,u=this._zoom,h=this._allNeededMatrices.get(o.tile),_=o.uniqueSymbol,f=o.colliders(s);let m=0;for(const d of f){const[p,w]=d.partIndex===0?r:a,x=d.partIndex===0?n:y,I=d.minLod<=u&&u<=d.maxLod;m+=I?0:1,d.enabled=I,d.xScreen=d.xTile*h[0]+d.yTile*h[3]+h[6],d.yScreen=d.xTile*h[1]+d.yTile*h[4]+h[7],x===j.MAP?(d.xScreen+=c*p-l*w,d.yScreen+=l*p+c*w):(d.xScreen+=p,d.yScreen+=w),Z.VIEWPORT===(d.partIndex===0?t:i)?(d.dxScreen=d.dxPixels,d.dyScreen=d.dyPixels):(d.dxScreen=c*(d.dxPixels+d.width/2)-l*(d.dyPixels+d.height/2)-d.width/2,d.dyScreen=l*(d.dxPixels+d.width/2)+c*(d.dyPixels+d.height/2)-d.height/2)}return f.length>0&&m===f.length&&_&&(_.show=!1),f}_getProperties(o){var t,i;const e=this._styleProps.get(o);if(e)return e;const s=(i=(t=this._styleRepository).getLayerStyleProperties)==null?void 0:i.call(t,o,this._zoom);return this._styleProps.set(o,s),s}_doesCollide(o){const e=o.xScreen+o.dxScreen,s=o.yScreen+o.dyScreen,t=e+o.width,i=s+o.height,[r,n,a,y]=this._gridIndex.getCellSpan(e,s,t,i);for(let l=n;l<=y;l++)for(let c=r;c<=a;c++){const u=this._gridIndex.cells[l][c];for(const h of u){if(h.labelId!=null&&o.labelId!=null&&h.labelId===o.labelId)continue;const _=h.xScreen+h.dxScreen,f=h.yScreen+h.dyScreen,m=_+h.width,d=f+h.height;if(!(t<_||e>m||i<f||s>d))return!0}}return!1}},v=class{constructor(o,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=o;let s=1;const t=new Uint32Array(o);this.layerUIDs=[];const i=t[s++];for(let r=0;r<i;r++)this.layerUIDs[r]=t[s++];this.bufferDataOffset=s,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(o){this._data!=null&&(this.doPrepareForRendering(o,this._data,this.bufferDataOffset),this._data=null)}},de=class extends v{constructor(o,e){super(o,e),this.type=g.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const s=new Uint32Array(o);let t=this.bufferDataOffset;this.lineIndexStart=s[t++],this.lineIndexCount=s[t++];const i=s[t++];if(i>0){this.patternMap=new Map;for(let r=0;r<i;r++){const n=s[t++],a=s[t++],y=s[t++];this.patternMap.set(n,[a,y])}}this.bufferDataOffset=t}get usedMemory(){var o,e;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.vao)==null?void 0:e.cachedMemory)??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(o,e,s){const t=new Uint32Array(e),i=new Int32Array(t.buffer),r=t[s++],n=b.createVertex(o,S.STATIC_DRAW,new Int32Array(i.buffer,4*s,r));s+=r;const a=t[s++],y=b.createIndex(o,S.STATIC_DRAW,new Uint32Array(t.buffer,4*s,a));s+=a;const l=this.layer.lineMaterial;this.vao=new T(o,l.getAttributeLocations(),l.getLayoutInfo(),new Map([["geometry",n]]),y)}};class fe extends v{constructor(e,s){super(e,s),this.type=g.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const t=new Uint32Array(e);let i=this.bufferDataOffset;this.fillIndexStart=t[i++],this.fillIndexCount=t[i++],this.outlineIndexStart=t[i++],this.outlineIndexCount=t[i++];const r=t[i++];if(r>0){this.patternMap=new Map;for(let n=0;n<r;n++){const a=t[i++],y=t[i++],l=t[i++];this.patternMap.set(a,[y,l])}}this.bufferDataOffset=i}get usedMemory(){var e,s,t;return(((e=this.data)==null?void 0:e.byteLength)??0)+(((s=this.fillVAO)==null?void 0:s.cachedMemory)??0)+(((t=this.outlineVAO)==null?void 0:t.cachedMemory)??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=M(this.fillVAO),this.outlineVAO=M(this.outlineVAO)}doPrepareForRendering(e,s,t){const i=new Uint32Array(s),r=new Int32Array(i.buffer),n=i[t++],a=b.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,n));t+=n;const y=i[t++],l=b.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,y));t+=y;const c=i[t++],u=b.createVertex(e,S.STATIC_DRAW,new Int32Array(r.buffer,4*t,c));t+=c;const h=i[t++],_=b.createIndex(e,S.STATIC_DRAW,new Uint32Array(i.buffer,4*t,h));t+=h;const f=this.layer,m=f.fillMaterial,d=f.outlineMaterial;this.fillVAO=new T(e,m.getAttributeLocations(),m.getLayoutInfo(),new Map([["geometry",a]]),l),this.outlineVAO=new T(e,d.getAttributeLocations(),d.getLayoutInfo(),new Map([["geometry",u]]),_)}}let me=class extends v{constructor(o,e,s){super(o,e),this.type=g.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const t=new Uint32Array(o),i=new Int32Array(o),r=new Float32Array(o);let n=this.bufferDataOffset;this.isIconSDF=!!t[n++];const a=t[n++],y=t[n++],l=t[n++],c=new te(a,y,l,0),u=t[n++];for(let m=0;m<u;m++){const d=t[n++],p=t[n++],w=t[n++];this.iconPerPageElementsMap.set(d,[p,w])}const h=t[n++];for(let m=0;m<h;m++){const d=t[n++],p=t[n++],w=t[n++];this.glyphPerPageElementsMap.set(d,[p,w])}const _=t[n++],f=t[n++];this.iconOpacity=new Int32Array(_),this.textOpacity=new Int32Array(f),n=he(t,i,r,n,this.symbols,s,c),this.bufferDataOffset=n}get usedMemory(){var o,e,s;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.iconVAO)==null?void 0:e.cachedMemory)??0)+(((s=this.textVAO)==null?void 0:s.cachedMemory)??0)+V(this.iconOpacity)+V(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let o=0;for(const e of this.iconPerPageElementsMap.values())o+=e[1];for(const e of this.glyphPerPageElementsMap.values())o+=e[1];return o/3}doDestroy(){this.iconVAO=M(this.iconVAO),this.textVAO=M(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const o=this.iconOpacity,e=this.iconVAO.vertexBuffers.get("opacity");o.length>0&&o.byteLength===e.usedMemory&&e.setSubData(o,0,0,o.length);const s=this.textOpacity,t=this.textVAO.vertexBuffers.get("opacity");s.length>0&&s.byteLength===t.usedMemory&&t.setSubData(s,0,0,s.length)}doPrepareForRendering(o,e,s){const t=new Uint32Array(e),i=new Int32Array(t.buffer),r=t[s++],n=b.createVertex(o,S.STATIC_DRAW,new Int32Array(i.buffer,4*s,r));s+=r;const a=t[s++],y=b.createIndex(o,S.STATIC_DRAW,new Uint32Array(t.buffer,4*s,a));s+=a;const l=t[s++],c=b.createVertex(o,S.STATIC_DRAW,new Int32Array(i.buffer,4*s,l));s+=l;const u=t[s++],h=b.createIndex(o,S.STATIC_DRAW,new Uint32Array(t.buffer,4*s,u));s+=u;const _=b.createVertex(o,S.STATIC_DRAW,this.iconOpacity.buffer),f=b.createVertex(o,S.STATIC_DRAW,this.textOpacity.buffer),m=this.layer,d=m.iconMaterial,p=m.textMaterial;this.iconVAO=new T(o,d.getAttributeLocations(),d.getLayoutInfo(),new Map([["geometry",n],["opacity",_]]),y),this.textVAO=new T(o,p.getAttributeLocations(),p.getLayoutInfo(),new Map([["geometry",c],["opacity",f]]),h)}},_e=class extends v{constructor(o,e){super(o,e),this.type=g.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const s=new Uint32Array(o);let t=this.bufferDataOffset;this.circleIndexStart=s[t++],this.circleIndexCount=s[t++],this.bufferDataOffset=t}get usedMemory(){var o,e;return(((o=this.data)==null?void 0:o.byteLength)??0)+(((e=this.vao)==null?void 0:e.cachedMemory)??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=M(this.vao)}doPrepareForRendering(o,e,s){const t=new Uint32Array(e),i=new Int32Array(t.buffer),r=t[s++],n=b.createVertex(o,S.STATIC_DRAW,new Int32Array(i.buffer,4*s,r));s+=r;const a=t[s++],y=b.createIndex(o,S.STATIC_DRAW,new Uint32Array(t.buffer,4*s,a));s+=a;const l=this.layer.circleMaterial;this.vao=new T(o,l.getAttributeLocations(),l.getLayoutInfo(),new Map([["geometry",n]]),y)}};class L extends se{constructor(e,s,t,i,r,n,a,y=null){super(e,s,t,i,r,n,O,O),this.styleRepository=a,this._memCache=y,this.type="vector-tile",this._referenced=1,this._hasSymbolBuckets=!1,this._usedMemory=256,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this.id=e.id}get styleLayerUIDs(){return Array.from(this.layerData.keys())}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<C}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<C)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(e){var t,i;let s=!1;for(const r of e){const n=this.layerData.get(r);n&&(this._usedMemory-=n.usedMemory,n.type===g.SYMBOL&&this.symbols.delete(r)&&(s=!0),n.destroy(),this.layerData.delete(r))}(t=this._memCache)==null||t.updateSize(this.key.id,this),s&&((i=this.featureIndex)==null||i.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}hasFeatures(){const e=this.layerData.values();for(const s of e)if(s.hasData())return!0;return!1}dispose(){this.status!=="unloaded"&&(L._destroyRenderBuckets(this.layerData),this.layerData.clear(),this.featureIndex=null,this._usedMemory=0,this.destroy(),this.status="unloaded")}release(){--this._referenced===0&&(this.dispose(),this.stage=null)}retain(){++this._referenced}get cachedMemory(){return this._usedMemory}get usedMemory(){return this._usedMemory}get usedMemoryPerReference(){return this._usedMemory/(this._referenced||1)}changeDataImpl(e){var t,i;(t=this.featureIndex)==null||t.clear();let s=!1;if(e){const{bucketsWithData:r,emptyBuckets:n}=e,a=this._createRenderBuckets(r);if(n&&n.byteLength>0){const y=new Uint32Array(n);for(const l of y)this._deleteLayerData(l)}for(const[y,l]of a)this._deleteLayerData(y),l.type===g.SYMBOL&&(this.symbols.set(y,l.symbols),s=!0),this._usedMemory+=l.usedMemory,this.layerData.set(y,l);(i=this._memCache)==null||i.updateSize(this.key.id,this)}this._hasSymbolBuckets=!1;for(const r of this.layerData.values())r.type===g.SYMBOL&&(this._hasSymbolBuckets=!0);s&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(s){s.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const s=this.resolution/(e.resolution*e.pixelRatio),t=this.width/this.rangeX*s,i=this.height/this.rangeY*s,r=[0,0];e.toScreen(r,[this.x,this.y]);const n=this.transforms.tileUnitsToPixels;K(n),Q(n,n,r),X(n,n,Math.PI*e.rotation/180),ee(n,n,[t,i,1])}_createTransforms(){return{displayViewScreenMat3:R(),tileMat3:R(),tileUnitsToPixels:R()}}static _destroyRenderBuckets(e){if(!e)return;const s=new Set;for(const t of e.values())s.has(t)||(t.destroy(),s.add(t));e.clear()}_createRenderBuckets(e){const s=new Map,t=new Map;for(const i of e){const r=this._deserializeBucket(i,t);for(const n of r.layerUIDs)s.set(n,r)}return s}_deserializeBucket(e,s){let t=s.get(e);if(t)return t;switch(new Uint32Array(e)[0]){case g.FILL:t=new fe(e,this.styleRepository);break;case g.LINE:t=new de(e,this.styleRepository);break;case g.SYMBOL:t=new me(e,this.styleRepository,this);break;case g.CIRCLE:t=new _e(e,this.styleRepository)}return s.set(e,t),t}_deleteLayerData(e){if(!this.layerData.has(e))return;const s=this.layerData.get(e);this._usedMemory-=s.usedMemory,s.destroy(),this.layerData.delete(e)}}function D(o){var e,s;return(((e=o.uniqueSymbol)==null?void 0:e.show)&&((s=o.uniqueSymbol)==null?void 0:s.lastShow))??!1}function pe(o,e){if(o.priority-e.priority)return o.priority-e.priority;if(D(o)&&!D(e))return-1;if(D(e)&&!D(o))return 1;const s=o.tile.key,t=e.tile.key;return s.world-t.world?s.world-t.world:s.level-t.level?s.level-t.level:s.row-t.row?s.row-t.row:s.col-t.col?s.col-t.col:o.xTile-e.xTile?o.xTile-e.xTile:o.yTile-e.yTile}let be=class{get running(){return this._running}constructor(o,e,s,t,i,r,n,a){this.selectionMode=o,this._visibleTiles=e,this._symbolRepository=s,this._styleRepository=t,this._createCollisionJob=i,this._assignTileSymbolsOpacity=r,this._symbolLayerSorter=n,this._isLayerVisible=a,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(o,e){this._screenWidth===o&&this._screenHeight===e||this.restart(),this._screenWidth=o,this._screenHeight=e}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(o){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const e=performance.now();if(!this._selectionJob.work(o)||(this._selectionJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const e=performance.now();if(!this._collisionJob.work(o)||(this._collisionJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const e=performance.now();if(!this._opacityJob.work(o)||(this._opacityJobCompleted=!0,(o=Math.max(0,o-(performance.now()-e)))===0))return!1}return this._running=!1,!0}_isFeatureFiltered(o,e,s){const t=e.getFilterFlags(o),i=t&oe,r=s.featureEffect==null||s.featureEffect.excludedLabelsVisible||t&ie;return!(i&&r)}_getFilteredByLayer(){var e,s;let o;if((e=this._styleRepository)!=null&&e.layerContexts)for(const t of this._symbolRepository.uniqueSymbols){const i=(s=this._styleRepository.layerContexts)==null?void 0:s.get(t.styleLayerUID);if(i!=null&&i.attributeView)for(const r of t.uniqueSymbols){o??(o=new Map),o.get(t.styleLayerUID)||o.set(t.styleLayerUID,new Set);const n=o.get(t.styleLayerUID),a=i.attributeView,y=i.layerView;this._isFeatureFiltered(r.id,a,y)&&n.add(r.id)}}return o}_resetSelection(){for(let o=0;o<this._symbolRepository.uniqueSymbols.length;o++){const e=this._symbolRepository.uniqueSymbols[o];for(let s=0;s<e.uniqueSymbols.length;s++){const t=e.uniqueSymbols[s];for(const i of t.tileSymbols)i.selectedForRendering=!1}}}_createSelectionJob(){var c;const o=this.selectionMode==="feature-tile"?ge:we,e=this._symbolRepository.uniqueSymbols;this._resetSelection();const s=[];let t=0,i=0;const r=this._isLayerVisible,n=this._getFilteredByLayer(),a=(c=this._styleRepository)==null?void 0:c.layerContexts;function y(u){let h;const _=performance.now();for(;i<e.length;i++,t=0){const f=e[i],m=f.styleLayerUID,d=n==null?void 0:n.get(m);let p=0;if(a){const x=a.get(m).layerView;p=x.view.allLayerViews.items.indexOf(x)}if(!r(m)){s[i]||(s[i]={styleLayerUID:m,layerOrder:p,symbols:[]});continue}s[i]||(s[i]={styleLayerUID:m,symbols:[],layerOrder:p});const w=s[i];for(;t<f.uniqueSymbols.length;t++){if(h=f.uniqueSymbols[t],t%100==99&&performance.now()-_>u)return!1;if(h.lastShow=h.show,h.id&&(d==null?void 0:d.has(h.id))){h.show=!1,h.parts[0].show=!1,h.parts[1].show=!1;continue}const x=o(h);if(x){x.selectedForRendering=!0,w.symbols.push(x),h.show=!0;for(const I of h.parts)I.show=!0}else h.show=!1}}for(const f of s)f.symbols.sort(pe);return s.sort((f,m)=>m.layerOrder-f.layerOrder),!0}const l=this._symbolLayerSorter;return{work:y,get sortedSymbols(){return s.sort(l)}}}_createOpacityJob(){const o=this._assignTileSymbolsOpacity,e=this._visibleTiles;let s=0;function t(i,r){for(const n of i.symbols.values())Se(n,r);o(i,r);for(const n of i.childrenTiles)t(n,r)}return{work(i){const r=performance.now();for(;s<e.length;s++){if(performance.now()-r>i)return!1;const n=e[s];if(n.parentTile!=null)continue;const a=performance.now();n instanceof L?t(n,a):o(n,a)}return!0}}}};function Se(o,e){for(const s of o){const t=s.uniqueSymbol;for(const i of t.parts){const r=i.targetOpacity>.5?1:-1;i.startOpacity+=r*((e-i.startTime)/C),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=e,i.targetOpacity=t.show&&i.show?1:0}}}function ge(o){let e=null,s=null,t=null;for(const i of o.tileSymbols){const r=i.tile;r.isReady&&r.isCoverage?e=i:r.isReady?s=i:r.rendering&&(t=i)}return e??s??t}function we(o){let e=null,s=!1,t=!1;for(const i of o.tileSymbols)if(!t||!s){const r=i.tile;(!e||r.isCoverage||r.neededForCoverage&&!s)&&(e=i,(r.neededForCoverage||r.isCoverage)&&(t=!0),r.isCoverage&&(s=!0))}return t?e:null}class A{static fromSymbols(e,s){let t=e.length;if(t>=xe){let i=s;do i/=2,t/=4;while(t>Ie&&i>Me);const r=new q(s,s,i);for(const n of e)r.getCell(n.xTile,n.yTile).push(n);return new A(s,e,r)}return new A(s,e,null)}constructor(e,s,t){this.tileCoordRange=e,this._symbols=s,this._index=t}addSymbols(e){for(const s of e)this._symbols.push(s);if(this._index)for(const s of e)this._index.getCell(s.xTile,s.yTile).push(s)}removeSymbols(e){const s=new Set(e);if(this._symbols=this._symbols.filter(t=>!s.has(t)),this._index)for(const t of this._index.cells)for(let i=0;i<t.length;i++)t[i]=t[i].filter(r=>!s.has(r))}getSymbols(){return this._symbols}getCandidate(e,s,t,i){if(!this._index){for(const c of this._symbols)if(t===c.hash&&Math.abs(e-c.xTile)<=i&&Math.abs(s-c.yTile)<=i)return c;return null}const r=this._index.getCellSpan(e-i,s-i,e+i,s+i),[n,a,y,l]=r;for(let c=a;c<=l;c++)for(let u=n;u<=y;u++){const h=this._index.cells[c][u];for(const _ of h)if(t===_.hash&&Math.abs(e-_.xTile)<=i&&Math.abs(s-_.yTile)<=i)return _}return null}}const xe=32,Ie=8,Me=64,F=20;class Te{constructor(e,s){this.tileCoordRange=e,this._visibleTiles=s,this._indexMapByTile=new Map,this._uniqueSymbolsByStyleLayerId=new Map}get uniqueSymbols(){return this._uniqueSymbolLayerArray==null&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}registerVectorTile(e,s){const t=this._ensureIndexMap(e),i=(s==null?void 0:s.values())??t.keys();for(const r of i){const n=t.get(r);n&&(this._removeSymbols(r,n.getSymbols()),t.delete(r))}this._addSymbols(e.key,t,e.symbols),this._invalidate()}unregisterVectorTile(e){this._removeTile(e),this._invalidate()}registerFeatureTile(e){this._ensureIndexMap(e),this._invalidate()}unregisterFeatureTile(e){this._removeTile(e),this._invalidate()}insertFeatureTileMetrics(e,s){const t=this._indexMapByTile.get(e);if(!t)throw new Error(`tile ${e.id} not registered!`);this._addSymbols(e.key,t,z(s)),this._invalidate()}removeFeatureTileMetrics(e,s){const t=this._indexMapByTile.get(e);if(!t)return;const i=z(s);for(const[r,n]of t.entries()){const a=i.get(r);a&&(n.removeSymbols(a),this._removeSymbols(r,a))}this._invalidate()}deleteStyleLayers(e){for(const s of this._indexMapByTile.values())for(const t of e){const i=s.get(t);i&&(this._removeSymbols(t,i.getSymbols()),s.delete(t))}this._invalidate()}querySymbols(e,s,t,i){const r=[];for(const[n,a]of this._uniqueSymbolsByStyleLayerId.entries())for(const y of a){const l=y.tileSymbols.find(c=>c.selectedForRendering);l&&ye(l,e,s*(window.devicePixelRatio||1),t)&&r.push({vtlSymbol:l,styleLayerUID:n,tileKey:l.tile.key})}return r}_ensureIndexMap(e){let s=this._indexMapByTile.get(e);return s||(s=new Map,this._indexMapByTile.set(e,s)),s}_invalidate(){this._uniqueSymbolLayerArray=null}_addSymbols(e,s,t){for(const[i,r]of t){let n=s.get(i);n?n.addSymbols(r):(n=A.fromSymbols(r,this.tileCoordRange),s.set(i,n))}this._updateUniqueSymbols(e,t)}_removeTile(e){const s=this._indexMapByTile.get(e);if(s){for(const[t,i]of s.entries())this._removeSymbols(t,i.getSymbols());this._indexMapByTile.delete(e),this._invalidate()}}_removeSymbols(e,s){for(const t of s){const i=t.uniqueSymbol;if(i){if(i.tileSymbols=i.tileSymbols.filter(r=>r!==t),i.tileSymbols.length===0){const r=this._uniqueSymbolsByStyleLayerId.get(e);r.delete(i),r.size===0&&this._uniqueSymbolsByStyleLayerId.delete(e)}t.uniqueSymbol=null}}}_updateUniqueSymbols(e,s){if(s.size!==0){for(const t of this._visibleTiles)t.parentTile||t.key.world!==e.world||t.key.level===e.level&&!t.key.equals(e)||this._matchSymbols(t,e,s);for(const[t,i]of s)for(const r of i)if(!r.uniqueSymbol){r.uniqueSymbol=new ne(r);let n=this._uniqueSymbolsByStyleLayerId.get(t);n||(n=new Set,this._uniqueSymbolsByStyleLayerId.set(t,n)),n.add(r.uniqueSymbol)}}}_matchSymbols(e,s,t){if(e.key.level>s.level){const r=e.key.level-s.level;if(e.key.row>>r!==s.row||e.key.col>>r!==s.col)return}if(s.level>e.key.level){const r=s.level-e.key.level;if(s.row>>r!==e.key.row||s.col>>r!==e.key.col)return}const i=new Map;for(const[r,n]of t){const a=[],y=(e.key.level<s.level?1:1<<e.key.level-s.level)+F,l=this._indexMapByTile.get(e),c=l==null?void 0:l.get(r);if(c)for(const u of n){if(u.uniqueSymbol)continue;const h=le(this.tileCoordRange,u.xTile,s,e.key),_=ae(this.tileCoordRange,u.yTile,s,e.key),f=-20,m=this.tileCoordRange+F;if(!(h>=f&&h<m&&_>=f&&_<m)){a.push(u);continue}const d=c.getCandidate(h,_,u.hash,y),p=d==null?void 0:d.uniqueSymbol;p?(u.uniqueSymbol=p,p.tileSymbols.push(u)):a.push(u)}a.length>0&&i.set(r,a)}for(const r of e.childrenTiles||[])this._matchSymbols(r,s,i)}_createUniqueSymbolLayerArray(){const e=this._uniqueSymbolsByStyleLayerId,s=new Array(e.size);let t,i=0;for(const[r,n]of e){const a=new Array(n.size);t=0;for(const y of n)a[t++]=y;s[i]={styleLayerUID:r,uniqueSymbols:a},i++}return s}}function z(o){const e=new Map;for(const s of o){const t=s.labelClassId;let i=e.get(t);i||(i=[],e.set(t,i)),i.push(s)}return e}const De=.5,U=1e-6;class Ee{constructor(e,s,t,i,r,n=$){this.styleRepository=s,this._declutterBudget=n,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=W(!1);const a=(c,u,h)=>this._createCollisionJob(c,u,h),y=c=>{var h,_,f;const u=(_=(h=this.styleRepository).getStyleLayerByUID)==null?void 0:_.call(h,c);if(u){if(this._zoom+U<u.minzoom||this._zoom-U>=u.maxzoom)return!1;const m=(f=u.getLayoutProperty)==null?void 0:f.call(u,"visibility");if(m&&m.getValue()===G.NONE)return!1}return!0},l=(c,u)=>{var h,_,f,m,d,p;return(((f=(_=(h=this.styleRepository).getStyleLayerByUID)==null?void 0:_.call(h,c.styleLayerUID))==null?void 0:f.z)??0)-(((p=(d=(m=this.styleRepository).getStyleLayerByUID)==null?void 0:d.call(m,u.styleLayerUID))==null?void 0:p.z)??0)};this._symbolRepository=new Te(r,i),this._symbolDeclutterer=new be(e,i,this._symbolRepository,this.styleRepository,a,t,l,y)}get symbolRepository(){return this._symbolRepository}_createCollisionJob(e,s,t){return this.updateDecluttererViewState(),new ue(e,s,t,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}registerFeatureTile(e){this.symbolRepository?(this.symbolRepository.registerFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}unregisterFeatureTile(e){this.symbolRepository?(this._symbolRepository.unregisterFeatureTile(e),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}insertFeatureTileMetrics(e,s){this.symbolRepository?(this.symbolRepository.insertFeatureTileMetrics(e,s),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}removeFeatureTileMetrics(e,s){this.symbolRepository?(this.symbolRepository.removeFeatureTileMetrics(e,s),this.restartDeclutter()):console.error("InternalError: Symbol repository not yet initialized")}addTile(e){e.decluttered=!1,this._tileToHandle.set(e,e.on("symbols-changed",()=>{this._symbolRepository.registerVectorTile(e),this.restartDeclutter()})),this._symbolRepository.registerVectorTile(e),this.restartDeclutter()}removeTile(e){const s=this._tileToHandle.get(e);s&&(this._symbolRepository.unregisterVectorTile(e),this.restartDeclutter(),s.remove(),this._tileToHandle.delete(e))}update(e,s){this._zoom=e,this._viewState={scale:s.scale,rotation:s.rotation,center:[s.center[0],s.center[1]],size:[s.size[0],s.size[1]]};const t=[0,0];s.toScreen(t,s.center);const i=[0,0];return s.toScreen(i,this._declutterViewState.center),this._offsetFromScreenCenter[0]=t[0]-i[0],this._offsetFromScreenCenter[1]=t[1]-i[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(e=>e.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(e){this._symbolRepository.deleteStyleLayers(e)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(this._declutterBudget),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){this._stableNotificationHandle!=null&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},(1+De)*C)}_notifyUnstable(){this._stableNotificationHandle!=null&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}export{Ee as A,Je as c,L as v};
