const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./loader-DBZkumMs-DVPW5nve.js","./index-BeTPrQ6f.js","./index-BlWAJbpo.css","./Version-DSJSGSLA-Cg87msWM.js","./mat4-R0VY9B_E-DoEP887i.js","./quat-B6H0knG8-DtO1-hlf.js","./quatf64-C16JxGFv-BKWK1F8U.js","./vec32-CI1xtKog-DFVYRcgb.js","./vec42-DHp-FUwt-Br7hmYJs.js","./BufferView-B6RYETl3-CMoUTBv6.js","./vec2f64-CkowXrDb-3zFQ3LNH.js","./vec4f64-DD-nkcCV-CSNWKRqG.js","./resourceUtils-DV37Keuk-D9tOd5yM.js","./enums-DDJfd4_p-D3z9tmVA.js"])))=>i.map(i=>d[i]);
import{lk as G,ir as ee,b0 as N,_ as fe,lw as W,is as pe,eq as Q,kQ as te,mm as V,v as de,M as re,P as he,kG as xe,oL as z,kA as ge,kE as H,kF as ye,l as be}from"./index-BeTPrQ6f.js";import{m as Te}from"./devEnvironmentUtils-CxrVv3RG-ktR0Kqgv.js";import{Z as we}from"./mat4-R0VY9B_E-DoEP887i.js";import{_ as ve}from"./vec2f64-CkowXrDb-3zFQ3LNH.js";import{X as K,q as Re,x as X,b as Me,l as Ae,S as Be}from"./vec32-CI1xtKog-DFVYRcgb.js";import{L as oe,K as U}from"./OutputColorHighlightOID.glsl-fUhBGshN-Ctm9N97M.js";import{T as se,c as ne,O as Se,_ as Pe,S as $e,v as Ie}from"./BufferView-B6RYETl3-CMoUTBv6.js";import{b as Ee,z as Oe,T as Z,R as J}from"./vec3-DXB2oTmo-oxnUpQ4G.js";import{R as _e,q as Y}from"./vec4-Dua3dSaz-Cy3KWGYf.js";import{T as ke,N as Fe,l as Ce}from"./indexUtils-BOzySSm0-n6TMq205.js";import{l as L}from"./resourceUtils-DV37Keuk-D9tOd5yM.js";import{f as Ue,l as Le}from"./vec2f32-hTAvipMV-C0AQcwEv.js";import{k as ae}from"./asyncUtils-Cu__bxqs-ecCTUaGV.js";import{i as Ve}from"./memoryEstimations-C_GUL8g_-JniNFd5l.js";import{s as qe}from"./NestedMap-BCg8I1M1-D2deq-hj.js";import{m as ie}from"./Version-DSJSGSLA-Cg87msWM.js";import{w as je}from"./Indices-CAn-HCVv-hWNN5onC.js";import{r as De}from"./requestImageUtils-CrIBaPUj-khjAqpU7.js";import{g as _}from"./orientedBoundingBox-DAJ-bKlA-DbqXagWB.js";import{n as le}from"./Texture-Daa63Q6u-Bl4xeC_t.js";import{o as q,a as Ge,b as Qe,w as ze,c as Ne}from"./DefaultMaterial-BRCr1DHi-kRRyJwPx.js";import"./enums-DDJfd4_p-D3z9tmVA.js";import"./Texture-DLw7oaIg-fTsxdRzn.js";import"./Cyclical-Bzwh_QaL-CXh-hbnA.js";import"./triangle-DA_o7I-u-CHbj6sRJ.js";import"./sphere-CIGsF4vz-C3zVQu9y.js";import"./vec4f64-DD-nkcCV-CSNWKRqG.js";import"./vectorStacks-B2ngxq6F-myhPBoPk.js";import"./quatf64-C16JxGFv-BKWK1F8U.js";import"./lineSegment-D8lwRkdT-CnWWOaLb.js";import"./renderState-CsafAKLy-B8R8ns_l.js";import"./glsl-CfY1Aoj6-DPHSeNd9.js";import"./vec42-DHp-FUwt-Br7hmYJs.js";import"./lengthUtils-CopeXEyE-DjCEitlq.js";import"./projectBuffer-CMNsPBq1-CMpE7Jo3.js";import"./projectionUtils-CsX1UTBu-DsZaU4xz.js";import"./zscale-PLuFqpaL-BIEnWBsg.js";import"./projectVectorToVector-OCoJKalB-CQIDHzSm.js";import"./projectPointToVector-BHS0gJJf-DOVZH8Fn.js";import"./frustum-D1Y7pP8E-DUyP3Dvr.js";import"./plane-wUwHaY3K-ZwGBF7HQ.js";import"./normalizeUtils-DK5542Ty-DtqBcgc2.js";import"./normalizeUtilsCommon-5DjefBp7-CQyUDMQp.js";import"./utils-CRANtbnc-C6zyufvL.js";import"./utils-t279O251-BBk6rV0U.js";import"./VertexAttributeLocations-DBgVVQz--D3wovAvC.js";import"./VertexElementDescriptor-DLvjNrmQ-Cuvx5w94.js";import"./quat-B6H0knG8-DtO1-hlf.js";import"./spatialReferenceEllipsoidUtils-Ty3j4VoE-BUAsRqCF.js";import"./computeTranslationToOriginAndRotation-CsOb5S2S-CE5ZgVBy.js";import"./videoUtils-ZWM8l9ln-fGQ142sg.js";import"./InterleavedLayout-CuMGnz6O-DkraWivs.js";import"./types-l27bT09Q-DE0QfIFp.js";import"./VertexBuffer-7GCTDD7e-CbRHEILO.js";import"./BufferObject-RHe5uojV-C-IINTcZ.js";import"./ShaderBuilder-ufvKEDd5-DMnPqr6U.js";function F(r){if(r==null)return null;const e=r.offset!=null?r.offset:Ue,s=r.rotation!=null?r.rotation:0,o=r.scale!=null?r.scale:Le,u=G(1,0,0,0,1,0,e[0],e[1],1),i=G(Math.cos(s),-Math.sin(s),0,Math.sin(s),Math.cos(s),0,0,0,1),n=G(o[0],0,0,0,o[1],0,0,0,1),a=ee();return N(a,i,n),N(a,u,a),a}class We{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class He{constructor(e,s,o){this.name=e,this.lodThreshold=s,this.pivotOffset=o,this.stageResources=new We,this.numberOfVertices=0}}const P=()=>he.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class Ke{constructor(e,s,o){this.resource=e,this.textures=s,this.usedMemory=o}}async function Xe(r,e){const s=await Ze(r,e),o=await rt(s.textureDefinitions??{},e);let u=0;for(const i in o)if(o.hasOwnProperty(i)){const n=o[i];u+=n!=null&&n.image?n.image.width*n.image.height*4:0}return new Ke(s,o,u+Ve(s))}async function Ze(r,e){const s=e==null?void 0:e.streamDataRequester;if(s)return Je(r,s,e);const o=await ae(de(r,e));if(o.ok===!0)return o.value.data;re(o.error),ue(o.error)}async function Je(r,e,s){const o=await ae(e.request(r,0,s));if(o.ok===!0)return o.value;re(o.error),ue(o.error.details.url)}function ue(r){throw new be("",`Request for object resource failed: ${r}`)}function Ye(r){const e=r.params,s=e.topology;let o=!0;switch(e.vertexAttributes||(P().warn("Geometry must specify vertex attributes"),o=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=e.faces;if(i){if(e.vertexAttributes)for(const n in e.vertexAttributes){const a=i[n];a!=null&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(P().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),o=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(P().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),o=!1)):(P().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),o=!1)}}else P().warn("Indexed geometries must specify faces"),o=!1;break}default:P().warn(`Unsupported topology '${s}'`),o=!1}r.params.material||(P().warn("Geometry requires material"),o=!1);const u=r.params.vertexAttributes;for(const i in u)u[i].values||(P().warn("Geometries with externally defined attributes are not yet supported"),o=!1);return o}function et(r,e){var g,f;const s=new Array,o=new Array,u=new Array,i=new qe,n=r.resource,a=ie.parse(n.version||"1.0","wosr");st.validate(a);const m=n.model.name,t=n.model.geometries,l=n.materialDefinitions??{},c=r.textures;let p=0;const d=new Map;for(let b=0;b<t.length;b++){const y=t[b];if(!Ye(y))continue;const R=ot(y),w=y.params.vertexAttributes,M=[],A=h=>{if(y.params.topology==="PerAttributeArray")return null;const T=y.params.faces;for(const x in T)if(x===h)return T[x].values;return null},$=w.position,C=$.values.length/$.valuesPerElement;for(const h in w){const T=w[h],x=T.values,D=A(h)??je(C);M.push([h,new _(x,D,T.valuesPerElement,!0)])}const v=R.texture,B=c&&c[v];if(B&&!d.has(v)){const{image:h,parameters:T}=B,x=new le(h,T);o.push(x),d.set(v,x)}const k=d.get(v),I=k?k.id:void 0,E=R.material;let S=i.get(E,v);if(S==null){const h=l[E.slice(E.lastIndexOf("/")+1)].params;h.transparency===1&&(h.transparency=0);const T=B?ce(B.alphaChannelUsage):void 0,x={ambient:W(h.diffuse),diffuse:W(h.diffuse),opacity:1-(h.transparency||0),textureAlphaMode:T,textureAlphaCutoff:.33,textureId:I,doubleSided:!0,cullFace:0,colorMixMode:h.externalColorMixMode||"tint",textureAlphaPremultiplied:(B==null?void 0:B.parameters.preMultiplyAlpha)??!1};e!=null&&e.materialParameters&&Object.assign(x,e.materialParameters),S=new q(x,e),i.set(E,v,S)}u.push(S);const j=new oe(S,M);p+=((f=(g=M.find(h=>h[0]==="position"))==null?void 0:g[1])==null?void 0:f.indices.length)??0,s.push(j)}return{engineResources:[{name:m,stageResources:{textures:o,materials:u,geometries:s},pivotOffset:n.model.pivotOffset,numberOfVertices:p,lodThreshold:null}],referenceBoundingBox:tt(s)}}function tt(r){const e=te();return r.forEach(s=>{const o=s.boundingInfo;o!=null&&(V(e,o.bbMin),V(e,o.bbMax))}),e}async function rt(r,e){const s=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){P().warn("Externally referenced texture data is not yet supported");continue}const m=n.encoding+";base64,"+a,t="/textureDefinitions/"+i,l=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:ce(l)!==1},p=e!=null&&e.disableTextures?Promise.resolve(null):De(m,e);s.push(p.then(d=>({refId:t,image:d,parameters:c,alphaChannelUsage:l})))}const o=await Promise.all(s),u={};for(const i of o)u[i.refId]=i;return u}function ce(r){switch(r){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function ot(r){const e=r.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const st=new ie(1,2,"wosr");async function nt(r,e){var c;const s=me(Te(r));if(s.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(s.url,e):Xe(s.url,e)),{engineResources:d,referenceBoundingBox:g}=et(p,e);return{lods:d,referenceBoundingBox:g,isEsriSymbolResource:!1,isWosr:!0}}let o;if(e.cache)o=await e.cache.loadGLTF(s.url,e,!!e.usePBR);else{const{loadGLTF:p}=await fe(()=>import("./loader-DBZkumMs-DVPW5nve.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]),import.meta.url);o=await p(new ke(e.streamDataRequester),s.url,e,e.usePBR)}const u=(c=o.model.meta)==null?void 0:c.ESRI_proxyEllipsoid,i=o.meta.isEsriSymbolResource&&u!=null&&o.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!o.customMeta.esriTreeRendering&&(o.customMeta.esriTreeRendering=!0,ct(o,u));const n=!!e.usePBR,a=o.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:ze}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:Ne},m={...e.materialParameters,treeRendering:i},{engineResources:t,referenceBoundingBox:l}=at(o,a,m,e,s.specifiedLodIndex,i);return{lods:t,referenceBoundingBox:l,isEsriSymbolResource:o.meta.isEsriSymbolResource,isWosr:!1}}function me(r){const e=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function at(r,e,s,o,u,i){const n=r.model,a=new Array,m=new Map,t=new Map,l=n.lods.length,c=te();return n.lods.forEach((p,d)=>{const g=o.skipHighLods===!0&&(l>1&&d===0||l>3&&d===1)||o.skipHighLods===!1&&u!=null&&d!==u;if(g&&d!==0)return;const f=new He(p.name,p.lodThreshold,[0,0,0]);p.parts.forEach(b=>{const y=g?new q({},o):it(n,b,f,e,s,m,t,o,i),{geometry:R,vertexCount:w}=lt(b,y??new q({},o)),M=R.boundingInfo;M!=null&&d===0&&(V(c,M.bbMin),V(c,M.bbMax)),y!=null&&(f.stageResources.geometries.push(R),f.numberOfVertices+=w)}),g||a.push(f)}),{engineResources:a,referenceBoundingBox:c}}function it(r,e,s,o,u,i,n,a,m){var w,M;const t=r.materials.get(e.material);if(t==null)return null;const{normal:l,color:c,texCoord0:p,tangent:d}=e.attributes,g=e.material+(l?"_normal":"")+(c?"_color":"")+(p?"_texCoord0":"")+(d?"_tangent":""),f=e.attributes.texCoord0!=null,b=e.attributes.normal!=null,y=ut(t.alphaMode);if(!i.has(g)){if(f){const I=(S,j=!1,h=!1)=>{if(S!=null&&!n.has(S)){const T=r.textures.get(S);if(T){const x=T.data,D=j&&!L(x)?a.compressionOptions:void 0;n.set(S,new le(L(x)?x.data:x,{...T.parameters,preMultiplyAlpha:!L(x)&&h,encoding:L(x)?x.encoding:void 0,compressionOptions:D}))}}},E=y!==1&&!m;I(t.colorTexture,E,y!==1),I(t.normalTexture),I(t.occlusionTexture,!0),I(t.emissiveTexture),I(t.metallicRoughnessTexture,!0)}const A=z(t.color[0]),$=z(t.color[1]),C=z(t.color[2]),v=t.colorTexture!=null&&f?n.get(t.colorTexture):null,B=Ge(t),k=((w=t.normalTextureTransform)==null?void 0:w.scale)!=null?(M=t.normalTextureTransform)==null?void 0:M.scale:ve;i.set(g,new q({...o,customDepthTest:1,textureAlphaMode:y,textureAlphaCutoff:t.alphaCutoff,diffuse:[A,$,C],ambient:[A,$,C],opacity:t.alphaMode==="OPAQUE"?1:t.opacity,doubleSided:t.doubleSided,doubleSidedType:"winding-order",cullFace:t.doubleSided?0:2,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:b?0:2,castShadows:!0,receiveShadows:t.receiveShadows,receiveAmbientOcclusion:t.receiveAmbientOcclusion,textureId:v==null?void 0:v.id,colorMixMode:t.colorMixMode,normalTextureId:t.normalTexture!=null&&f?n.get(t.normalTexture).id:void 0,textureAlphaPremultiplied:v!=null&&!!v.parameters.preMultiplyAlpha,occlusionTextureId:t.occlusionTexture!=null&&f?n.get(t.occlusionTexture).id:void 0,emissiveTextureId:t.emissiveTexture!=null&&f?n.get(t.emissiveTexture).id:void 0,metallicRoughnessTextureId:t.metallicRoughnessTexture!=null&&f?n.get(t.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],mrrFactors:B?Qe:[t.metallicFactor,t.roughnessFactor,o.mrrFactors[2]],isSchematic:B,colorTextureTransformMatrix:F(t.colorTextureTransform),normalTextureTransformMatrix:F(t.normalTextureTransform),scale:[k[0],k[1]],occlusionTextureTransformMatrix:F(t.occlusionTextureTransform),emissiveTextureTransformMatrix:F(t.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:F(t.metallicRoughnessTextureTransform),...u},a))}const R=i.get(g);if(s.stageResources.materials.push(R),f){const A=$=>{$!=null&&s.stageResources.textures.push(n.get($))};A(t.colorTexture),A(t.normalTexture),A(t.occlusionTexture),A(t.emissiveTexture),A(t.metallicRoughnessTexture)}return R}function lt(r,e){const s=r.attributes.position.count,o=Fe(r.indices||s,r.primitiveType),u=U(3*s),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;Ee(u,i,r.transform,3,n);const a=[["position",new _(u,o,3,!0)]];if(r.attributes.normal!=null){const t=U(3*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.normal;ge(O,r.transform),Oe(t,l,O,3,c),H(O)&&Z(t,t),a.push(["normal",new _(t,o,3,!0)])}if(r.attributes.tangent!=null){const t=U(4*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.tangent;ye(O,r.transform),_e(t,l,O,4,c),H(O)&&Z(t,t,4),a.push(["tangent",new _(t,o,4,!0)])}if(r.attributes.texCoord0!=null){const t=U(2*s),{typedBuffer:l,typedBufferStride:c}=r.attributes.texCoord0;Ce(t,l,2,c),a.push(["uv0",new _(t,o,2,!0)])}const m=r.attributes.color;if(m!=null){const t=new Uint8Array(4*s);m.elementCount===4?m instanceof ne?Y(t,m,1,255):(m instanceof Se||m instanceof Pe)&&Y(t,m,1/255,255):(t.fill(255),m instanceof se?J(t,m.typedBuffer,1,255,4,m.typedBufferStride):(r.attributes.color instanceof $e||r.attributes.color instanceof Ie)&&J(t,m.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push(["color",new _(t,o,4,!0)])}return{geometry:new oe(e,a),vertexCount:s}}const O=ee();function ut(r){switch(r){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function ct(r,e){for(let s=0;s<r.model.lods.length;++s){const o=r.model.lods[s];for(const u of o.parts){const i=u.attributes.normal;if(i==null)return;const n=u.attributes.position,a=n.count,m=Q(),t=Q(),l=Q(),c=new Float32Array(4*a),p=new Float32Array(3*a),d=we(pe(),u.transform);let g=0,f=0;for(let b=0;b<a;b++){n.getVec(b,t),i.getVec(b,m),K(t,t,u.transform),Re(l,t,e.center),X(l,l,e.radius);const y=l[2],R=Me(l),w=Math.min(.45+.55*R*R,1)**xe;X(l,l,e.radius),d!==null&&K(l,l,d),Ae(l,l),s+1!==r.model.lods.length&&r.model.lods.length>1&&Be(l,l,m,y>-1?.2:Math.min(-4*y-3.8,1)),p[g]=l[0],p[g+1]=l[1],p[g+2]=l[2],g+=3,c[f]=w,c[f+1]=w,c[f+2]=w,c[f+3]=1,f+=4}u.attributes.normal=new se(p.buffer),u.attributes.color=new ne(c.buffer)}}}const pr=Object.freeze(Object.defineProperty({__proto__:null,fetch:nt,parseUrl:me},Symbol.toStringTag,{value:"Module"}));export{pr as o,F as s,nt as z};
