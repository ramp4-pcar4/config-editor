import{c as b,iu as M,c3 as S,c4 as A,eh as I,fS as Q,bU as $}from"./index-V75RkAZg.js";import{B as O,E as Z,z as C}from"./featureConversionUtils-DRaHTjrY-COshiQK_.js";import{K as B,W as P}from"./executeQueryForSnapping-BaQkcS1W-COnFE5Fs.js";import{p as _,h as E}from"./queryUtils-OXllLZed-ufe36LNp.js";import{Y as k}from"./QueryEngine-DEm6IK5j-5EFKS-e2.js";import{A as z,d as G,f as W}from"./clientSideDefaults-B-KLKMEC-BkWUWwAR.js";import{b as K,a as g,A as T,w as x,C as w,q as L}from"./sourceUtils-4Pkpu1X1-B7OWc_1e.js";import{o as D}from"./FieldsIndex-Y7EBAYp0-CPXIdD5_.js";import{i as Y}from"./fieldType-VTpxE-EM-Eu6FRLce.js";import"./OptimizedFeatureSet-D6mgsKNr-HQQUKWvo.js";import"./memoryEstimations-iHVpvWPf-B1nJmmow.js";import"./OptimizedGeometry-1qDYm3YK-DNcX879h.js";import"./PooledRBush-J5-OtqBl-CXbBUrRT.js";import"./quickselect-DHTstthl-Ds_Aj0x5.js";import"./timeSupport-_0FhDj9z-DfuFn4Gw.js";import"./optimizedFeatureQueryEngineAdapter-Bx4OOJmK-C-i_YxU1.js";import"./normalizeUtils-b-vZURob-AxvZJOZv.js";import"./utils-DuaeuwP5-D_EqUpgO.js";import"./utils-Jw-4AGsF-BLOvp60n.js";import"./projection-m8vi7Cxv-MPQBAE9_.js";import"./json-BI97KiBB-Ce5cWfI2.js";import"./WhereClauseCache-CAR59H4Y-BuHDdM-n.js";import"./LRUCache-BLmkvs7b-BsSTmLq7.js";import"./MemCache-BCippCv6-GgFWDHQN.js";import"./WhereClause-nZnXFKnG-CCdCYvbW.js";import"./TimeOnly-C3SOkmg2-Ck4_Apck.js";import"./QueryEngineCapabilities-C8pazosU-DZTubngj.js";import"./TimeExtent-gZaEUVeW-B3MjAsHp.js";import"./quantizationUtils-Cndke4AR-B7aOmONM.js";import"./utils-BrRx2KpZ-hCib0bAM.js";import"./heatmapUtils--OU2Fakh-BFO2HP0h.js";import"./vec42-D8CJyqHG-DnfLTeQH.js";import"./common-CYWrYyJl-E8-sukrT.js";import"./vec4f64-CjUMzAyX-DPYbdAom.js";import"./utils-BG7WTOnW-BZ9C4ba9.js";import"./mat4f32-CiZjBg9k-CUm34GoR.js";import"./mat4-BFStKTjU-DR_gzsZK.js";import"./intl-DLmy-Li5-CbupOHia.js";import"./timeZoneUtils-z3WjfjXQ-FDRCpCci.js";import"./ClassBreaksDefinition-B_vYk3bu-DFEwYKQE.js";import"./SnappingCandidate-DJDyIbpo-CuetCfU1.js";import"./FixedIntervalBinParameters-aoOPIkh7-DzimjlAn.js";import"./NormalizationBinParametersMixin-ZkplD1Sk-CHjWYcPb.js";import"./Scheduler-Br-2v2ys-DRVzYeHz.js";import"./signal-DxzURL18-0RAxY8TY.js";import"./date-Cqvy-TgA-4Z7B9PBN.js";const N=1;function U(y,e){var n;let t=0;for(const s of e){const o=(n=s.attributes)==null?void 0:n[y];typeof o=="number"&&isFinite(o)&&(t=Math.max(t,o))}return t}const H=Q,V={xmin:-180,ymin:-90,xmax:180,ymax:90,spatialReference:Q},J={hasAttachments:!1,capabilities:"query, editing, create, delete, update",useStandardizedQueries:!0,supportsCoordinatesQuantization:!0,supportsReturningQueryGeometry:!0,advancedQueryCapabilities:{supportsQueryAttachments:!1,supportsQueryAttachmentOrderByFields:!1,supportsQueryBins:!0,supportsStatistics:!0,supportsPercentileStatistics:!0,supportsReturningGeometryCentroid:!0,supportsQueryWithDistance:!0,supportsDistinct:!0,supportsReturningQueryExtent:!0,supportsReturningGeometryProperties:!1,supportsHavingClause:!0,supportsOrderBy:!0,supportsPagination:!0,supportsQueryWithResultType:!0,supportsSqlExpression:!0,supportsDisjointSpatialRel:!0,supportsQueryWithCacheHint:!0},queryBinsCapabilities:L};function X(y){return $(y)?y.z!=null:!!y.hasZ}function ee(y){return $(y)?y.m!=null:!!y.hasM}class te{constructor(){this._queryEngine=null,this._nextObjectId=null}destroy(){var e;(e=this._queryEngine)==null||e.destroy(),this._queryEngine=this._createDefaultAttributes=null}async load(e){const t=[],{features:n}=e,s=this._inferLayerProperties(n,e.fields),o=e.fields||[],d=e.hasM!=null?e.hasM:!!s.hasM,f=e.hasZ!=null?e.hasZ:!!s.hasZ,p=!e.spatialReference&&!s.spatialReference,u=p?H:e.spatialReference||s.spatialReference,h=p?V:null,m=e.geometryType||s.geometryType,l=!m;let i=e.objectIdField||s.objectIdField,a=e.timeInfo;const c=new D(o);if(!l&&(p&&t.push({name:"feature-layer:spatial-reference-not-found",message:"Spatial reference not provided or found in features. Defaults to WGS84"}),!m))throw new b("feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");if(!i)throw new b("feature-layer:missing-property","objectIdField not set and couldn't be found in the provided fields");if(s.objectIdField&&i!==s.objectIdField&&(t.push({name:"feature-layer:duplicated-oid-field",message:`Provided objectIdField "${i}" doesn't match the field name "${s.objectIdField}", found in the provided fields`}),i=s.objectIdField),i&&!s.objectIdField){const r=c.get(i);r?(i=r.name,r.type="esriFieldTypeOID",r.editable=!1,r.nullable=!1):o.unshift({alias:i,name:i,type:"esriFieldTypeOID",editable:!1,nullable:!1})}for(const r of o){if(r.name==null&&(r.name=r.alias),r.alias==null&&(r.alias=r.name),!r.name)throw new b("feature-layer:invalid-field-name","field name is missing",{field:r});if(r.name===i&&(r.type="esriFieldTypeOID"),!Y.jsonValues.includes(r.type))throw new b("feature-layer:invalid-field-type",`invalid type for field "${r.name}"`,{field:r});r.length==null&&(r.length=M(r))}const F={};for(const r of o)if(r.type!=="esriFieldTypeOID"&&r.type!=="esriFieldTypeGlobalID"){const q=S(r);q!==void 0&&(F[r.name]=q)}if(a){if(a.startTimeField){const r=c.get(a.startTimeField);r?(a.startTimeField=r.name,r.type="esriFieldTypeDate"):a.startTimeField=null}if(a.endTimeField){const r=c.get(a.endTimeField);r?(a.endTimeField=r.name,r.type="esriFieldTypeDate"):a.endTimeField=null}if(a.trackIdField){const r=c.get(a.trackIdField);r?a.trackIdField=r.name:(a.trackIdField=null,t.push({name:"feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:a}}))}a.startTimeField||a.endTimeField||(t.push({name:"feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing or invalid",details:{timeInfo:a}}),a=null)}const j=c.dateFields.length?{timeZoneIANA:e.dateFieldsTimeZone??A}:null;this._createDefaultAttributes=z(F,i);const R={warnings:t,featureErrors:[],layerDefinition:{...J,drawingInfo:G(m),templates:W(F),extent:h,geometryType:m,objectIdField:i,fields:o,hasZ:f,hasM:d,timeInfo:a,dateFieldsTimeReference:j},assignedObjectIds:{}};if(this._queryEngine=new k({fieldsIndex:D.fromLayerJSON({fields:o,timeInfo:a,dateFieldsTimeReference:j}),geometryType:m,hasM:d,hasZ:f,objectIdField:i,spatialReference:u,featureStore:new B({geometryType:m,hasM:d,hasZ:f}),timeInfo:a}),!(n!=null&&n.length))return this._nextObjectId=N,R;const v=U(i,n);return this._nextObjectId=v+1,await _(n,u),this._loadInitialFeatures(R,n)}async applyEdits(e){const{spatialReference:t,geometryType:n}=this._queryEngine;return await Promise.all([K(t,n),_(e.adds,t),_(e.updates,t)]),this._applyEdits(e)}queryFeatures(e,t={}){return this._queryEngine.executeQuery(e,t.signal)}queryFeatureCount(e,t={}){return this._queryEngine.executeQueryForCount(e,t.signal)}queryObjectIds(e,t={}){return this._queryEngine.executeQueryForIds(e,t.signal)}queryExtent(e,t={}){return this._queryEngine.executeQueryForExtent(e,t.signal)}querySnapping(e,t={}){return P(this._queryEngine,e,t.signal)}queryAttributeBins(e,t={}){return this._queryEngine.executeAttributeBinsQuery(e,t.signal)}_inferLayerProperties(e,t){let n,s,o=null,d=null,f=null;for(const p of e){const u=p.geometry;if(u!=null&&(o||(o=I(u)),d||(d=u.spatialReference),n==null&&(n=X(u)),s==null&&(s=ee(u)),o&&d&&n!=null&&s!=null))break}if(t&&t.length){let p=null;t.some(u=>{const h=u.type==="esriFieldTypeOID",m=!u.type&&u.name&&u.name.toLowerCase()==="objectid";return p=u,h||m})&&(f=p.name)}return{geometryType:o,spatialReference:d,objectIdField:f,hasM:s,hasZ:n}}async _loadInitialFeatures(e,t){const{geometryType:n,hasM:s,hasZ:o,objectIdField:d,spatialReference:f,featureStore:p,fieldsIndex:u}=this._queryEngine,h=[];for(const i of t){if(i.uid!=null&&(e.assignedObjectIds[i.uid]=-1),i.geometry&&n!==I(i.geometry)){e.featureErrors.push(g("Incorrect geometry type."));continue}const a=this._createDefaultAttributes(),c=T(u,a,i.attributes,!0);c?e.featureErrors.push(c):(this._assignObjectId(a,i.attributes,!0),i.attributes=a,i.uid!=null&&(e.assignedObjectIds[i.uid]=i.attributes[d]),i.geometry!=null&&(i.geometry=E(i.geometry,i.geometry.spatialReference,f)),h.push(i))}p.addMany(O([],h,n,o,s,d));const{fullExtent:m,timeExtent:l}=await this._queryEngine.fetchRecomputedExtents();if(e.layerDefinition.extent=m,l){const{start:i,end:a}=l;e.layerDefinition.timeInfo.timeExtent=[i,a]}return e}async _applyEdits(e){const{adds:t,updates:n,deletes:s}=e,o={addResults:[],deleteResults:[],updateResults:[],uidToObjectId:{}};if(t!=null&&t.length&&this._applyAddEdits(o,t),n!=null&&n.length&&this._applyUpdateEdits(o,n),s==null?void 0:s.length){for(const p of s)o.deleteResults.push(x(p));this._queryEngine.featureStore.removeManyById(s)}const{fullExtent:d,timeExtent:f}=await this._queryEngine.fetchRecomputedExtents();return{extent:d,timeExtent:f,featureEditResults:o}}_applyAddEdits(e,t){const{addResults:n}=e,{geometryType:s,hasM:o,hasZ:d,objectIdField:f,spatialReference:p,featureStore:u,fieldsIndex:h}=this._queryEngine,m=[];for(const l of t){if(l.geometry&&s!==I(l.geometry)){n.push(g("Incorrect geometry type."));continue}const i=this._createDefaultAttributes(),a=T(h,i,l.attributes);if(a)n.push(a);else{if(this._assignObjectId(i,l.attributes),l.attributes=i,l.uid!=null){const c=l.attributes[f];e.uidToObjectId[l.uid]=c}if(l.geometry!=null){const c=l.geometry.spatialReference??p;l.geometry=E(w(l.geometry,c),c,p)}m.push(l),n.push(x(l.attributes[f]))}}u.addMany(O([],m,s,d,o,f))}_applyUpdateEdits({updateResults:e},t){const{geometryType:n,hasM:s,hasZ:o,objectIdField:d,spatialReference:f,featureStore:p,fieldsIndex:u}=this._queryEngine;for(const h of t){const{attributes:m,geometry:l}=h,i=m==null?void 0:m[d];if(i==null){e.push(g(`Identifier field ${d} missing`));continue}if(!p.has(i)){e.push(g(`Feature with object id ${i} missing`));continue}const a=Z(p.getFeature(i),n,o,s);if(l!=null){if(n!==I(l)){e.push(g("Incorrect geometry type."));continue}const c=l.spatialReference??f;a.geometry=E(w(l,c),c,f)}if(m){const c=T(u,a.attributes,m);if(c){e.push(c);continue}}p.add(C(a,n,o,s,d)),e.push(x(i))}}_assignObjectId(e,t,n=!1){const s=this._queryEngine.objectIdField;n&&t&&isFinite(t[s])?e[s]=t[s]:e[s]=this._nextObjectId++}}const Ne=Object.freeze(Object.defineProperty({__proto__:null,default:te},Symbol.toStringTag,{value:"Module"}));export{Ne as M,U as n};
