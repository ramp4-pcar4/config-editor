import{v as mt}from"./deduplicate-DZCyc4JG-CRK39qw4.js";import{a as X}from"./InterleavedLayout-DcHoXu73-Bq_Dycff.js";import{T as c}from"./VertexAttribute-DFC3a3eR-BhmQtMsu.js";import{p as Y}from"./glUtil-n1JOrdV3-BO0hK77I.js";import{bD as tt,gN as It,df as T,d5 as ut,fC as Ot}from"./index-CBMEoBe1.js";import{g as St,A as K,_ as st,y as J,k as At,X as pt,r as rt,l as dt,P as Et}from"./vec32-BuqRmYBM-CtdUGvNP.js";import{u as j}from"./Normals-BP6u0Eou-BI1kRB-6.js";const Tt=X().vec3f(c.POSITION).u16(c.COMPONENTINDEX).freeze(),wt=X().vec2u8(c.SIDENESS).freeze();Y(wt);const q=X().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze(),Q=X().vec3f(c.POSITION0).vec3f(c.POSITION1).vec2i16(c.NORMALCOMPRESSED).vec2i16(c.NORMAL2COMPRESSED).u16(c.COMPONENTINDEX).u8(c.VARIANTOFFSET,{glNormalized:!0}).u8(c.VARIANTSTROKE).u8(c.VARIANTEXTENSION,{glNormalized:!0}).freeze();c.POSITION0,c.POSITION1,c.COMPONENTINDEX,c.VARIANTOFFSET,c.VARIANTSTROKE,c.VARIANTEXTENSION,c.NORMALCOMPRESSED,c.NORMAL2COMPRESSED,c.SIDENESS;class vt{constructor(){this.position0=T(),this.position1=T(),this.faceNormal0=T(),this.faceNormal1=T(),this.componentIndex=0,this.cosAngle=0}}const W=-1;function yt(t,n,o){const r=t.vertices.position,a=t.vertices.componentIndex,f=N.position0,h=N.position1,I=N.faceNormal0,S=N.faceNormal1,{edges:i,normals:p}=Vt(t),m=i.length/4,A=n.allocate(m);let V=0;const _=m,w=o==null?void 0:o.allocate(_);let b=0,e=0,s=0;$.length=0;for(let d=0;d<m;++d){const y=4*d;r.getVec(i.data[y],f),r.getVec(i.data[y+1],h);const D=$.pushNew();D.index=4*d,D.length=St(f,h)}$.sort((d,y)=>y.length-d.length);const u=new Array,l=new Array;$.forAll(({length:d,index:y})=>{const D=i.data[y],Nt=i.data[y+1],et=i.data[y+2],nt=i.data[y+3],ot=nt===W;if(r.getVec(D,f),r.getVec(Nt,h),ot){const E=3*et;K(I,p.data[E],p.data[E+1],p.data[E+2]),st(S,I),N.componentIndex=a.get(D),N.cosAngle=J(I,S)}else{let E=3*et;if(K(I,p.data[E],p.data[E+1],p.data[E+2]),E=3*nt,K(S,p.data[E],p.data[E+1],p.data[E+2]),N.componentIndex=a.get(D),N.cosAngle=J(I,S),Mt(N,Lt))return;N.cosAngle<-.9999&&st(S,I)}e+=d,s++,ot||Pt(N,Ft)?(n.write(A,V++,N),u.push(d)):Rt(N,ht)&&(w&&o&&o.write(w,b++,N),l.push(d))});const O=new Float32Array(u.reverse()),v=new Float32Array(l.reverse()),P=w&&o?{instancesData:w.slice(0,b),lodInfo:{lengths:v}}:void 0;return{regular:{instancesData:A.slice(0,V),lodInfo:{lengths:O}},silhouette:P,averageEdgeLength:e/s}}function Pt(t,n){return t.cosAngle<n}function Mt(t,n){return t.cosAngle>n}function Rt(t,n){const o=It(t.cosAngle);return At(it,t.position1,t.position0),o*(J(pt(Dt,t.faceNormal0,t.faceNormal1),it)>0?-1:1)>n}function Vt(t){const n=t.faces.length/3,o=t.faces,r=t.neighbors,a=t.vertices.position;g.length=k.length=0;for(let f=0;f<n;f++){const h=3*f,I=r[h],S=r[h+1],i=r[h+2],p=o[h],m=o[h+1],A=o[h+2];a.getVec(p,C),a.getVec(m,z),a.getVec(A,B),rt(z,z,C),rt(B,B,C),pt(C,z,B),dt(C,C),k.pushArray(C),(I===W||p<m)&&(g.push(p),g.push(m),g.push(f),g.push(I)),(S===W||m<A)&&(g.push(m),g.push(A),g.push(f),g.push(S)),(i===W||A<p)&&(g.push(A),g.push(p),g.push(f),g.push(i))}return{edges:g,normals:k}}class Ct{constructor(){this.index=0,this.length=0}}const $=new tt({allocator:t=>t||new Ct,deallocator:null}),g=new tt({deallocator:null}),k=new tt({deallocator:null}),N=new vt,Dt=T(),it=T(),C=T(),z=T(),B=T(),ht=ut(4),Lt=Math.cos(ht),xt=ut(35),Ft=Math.cos(xt);function at(t,n,o){const r=n/3,a=new Uint32Array(o+1),f=new Uint32Array(o+1),h=(e,s)=>{e<s?a[e+1]++:f[s+1]++};for(let e=0;e<r;e++){const s=t[3*e],u=t[3*e+1],l=t[3*e+2];h(s,u),h(u,l),h(l,s)}let I=0,S=0;for(let e=0;e<o;e++){const s=a[e+1],u=f[e+1];a[e+1]=I,f[e+1]=S,I+=s,S+=u}const i=new Uint32Array(6*r),p=a[o],m=(e,s,u)=>{if(e<s){const l=a[e+1]++;i[2*l]=s,i[2*l+1]=u}else{const l=f[s+1]++;i[2*p+2*l]=e,i[2*p+2*l+1]=u}};for(let e=0;e<r;e++){const s=t[3*e],u=t[3*e+1],l=t[3*e+2];m(s,u,e),m(u,l,e),m(l,s,e)}const A=(e,s)=>{const u=2*e,l=s-e;for(let O=1;O<l;O++){const v=i[u+2*O],P=i[u+2*O+1];let d=O-1;for(;d>=0&&i[u+2*d]>v;d--)i[u+2*d+2]=i[u+2*d],i[u+2*d+3]=i[u+2*d+1];i[u+2*d+2]=v,i[u+2*d+3]=P}};for(let e=0;e<o;e++)A(a[e],a[e+1]),A(p+f[e],p+f[e+1]);const V=new Int32Array(3*r),_=(e,s)=>e===t[3*s]?0:e===t[3*s+1]?1:e===t[3*s+2]?2:-1,w=(e,s)=>{const u=_(e,s);V[3*s+u]=-1},b=(e,s,u,l)=>{const O=_(e,s);V[3*s+O]=l;const v=_(u,l);V[3*l+v]=s};for(let e=0;e<o;e++){let s=a[e];const u=a[e+1];let l=f[e];const O=f[e+1];for(;s<u&&l<O;){const v=i[2*s],P=i[2*p+2*l];v===P?(b(e,i[2*s+1],P,i[2*p+2*l+1]),s++,l++):v<P?(w(e,i[2*s+1]),s++):(w(P,i[2*p+2*l+1]),l++)}for(;s<u;)w(e,i[2*s+1]),s++;for(;l<O;)w(i[2*p+2*l],i[2*p+2*l+1]),l++}return V}const H=.7;let gt=class{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?_t:Xt}write(t,n,o){U.seed=this._edgeHashFunction(o);const r=U.getIntRange(0,255),a=U.getIntRange(0,this.settings.variants-1),f=U.getFloat(),h=255*(.5*bt(-(1-Math.min(f/H,1))+Math.max(0,f-H)/(1-H),1.2)+.5);t.position0.setVec(n,o.position0),t.position1.setVec(n,o.position1),t.componentIndex.set(n,o.componentIndex),t.variantOffset.set(n,r),t.variantStroke.set(n,a),t.variantExtension.set(n,h)}};const M=new Float32Array(6),R=new Uint32Array(M.buffer),F=new Uint32Array(1);function Xt(t){return M[0]=t.position0[0],M[1]=t.position0[1],M[2]=t.position0[2],M[3]=t.position1[0],M[4]=t.position1[1],M[5]=t.position1[2],F[0]=31*(31*(31*(31*(31*(166811+R[0])+R[1])+R[2])+R[3])+R[4])+R[5],F[0]}function _t(t){const n=M;n[0]=L(t.position0[0]),n[1]=L(t.position0[1]),n[2]=L(t.position0[2]),n[3]=L(t.position1[0]),n[4]=L(t.position1[1]),n[5]=L(t.position1[2]),F[0]=5381;for(let o=0;o<R.length;o++)F[0]=31*F[0]+R[o];return F[0]}const ct=1e4;function L(t){return Math.round(t*ct)/ct}function bt(t,n){return Math.abs(t)**n*Math.sign(t)}class Z{constructor(){this._commonWriter=new gt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return q.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r),Et(x,r.faceNormal0,r.faceNormal1),dt(x,x);const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;j(a,o,x[0],x[1],x[2],f)}}Z.Layout=q,Z.glLayout=Y(q,1);class G{constructor(){this._commonWriter=new gt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return Q.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r);{const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;j(a,o,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],f)}{const{typedBuffer:a,typedBufferStride:f}=n.normal2Compressed;j(a,o,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],f)}}}G.Layout=Q,G.glLayout=Y(Q,1);const x=T(),U=new Ot;function jt(t){const n=$t(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),ft.updateSettings(t.writerSettings),yt(n,lt,ft)}function $t(t,n,o,r){if(n){const h=at(o,r,t.count);return new zt(o,r,h,t)}const a=mt(t.buffer,t.stride/4,{originalIndices:o,originalIndicesLength:r}),f=at(a.indices,r,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:f,vertices:Tt.createView(a.buffer)}}class zt{constructor(n,o,r,a){this.faces=n,this.facesLength=o,this.neighbors=r,this.vertices=a}}const lt=new Z,ft=new G,qt=X().vec3f(c.POSITION0).vec3f(c.POSITION1),Qt=X().vec3f(c.POSITION0).vec3f(c.POSITION1).u16(c.COMPONENTINDEX);export{Qt as K,$t as N,qt as U,jt as X,yt as f,Tt as l};
